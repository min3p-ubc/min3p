!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/dens.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c module dens
!c Density related parameters and variables
!c 
!c
!c written by:      
!c
!c last modified:   
!c                  Danyang Su - Dec. 04, 2019
!c ----------------------------------------------------------------------

      module dens

      use parm
      
      implicit none
!c ----------------------------------------------------------------------
!c density dependent flow
!c picard iteration
!c immobile napl phase
!c ----------------------------------------------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           courant_max        = maximum courant number for
!c                                flow solution
!c           courant_target     = target courant number
!c           del_p(ncon-1)      = difference in total                      
!c                                pressure potential
!c           del_z(ncon-1)      = difference in                       
!c                                elevation potential
!c           delt_courant       = estimated time step length                 
!c                                based on courant target
!c           drho_dc            = constant d(density)/d(total dissolved
!c                                solids) derivative
!c
!c           drho_dt            = constant d(density)/d(temperature) 
!c                                derivative
!c
!c           delt_sia           = estimated time step length based
!c                                on number of Picard iterations
!c           delt_tds           = lagged time step for tds storage 
!c                                derivative
!c           density(nn)        = fluid density
!c           densold(nn)        = fluid density from previous 
!c                                iteration/time step
!c           dcoef(ncon-1)      = coefficient including density,
!c                                viscosity, and relative 
!c                                permeability
!c           dvolcoef           = volume flux coefficient including       
!c                                viscosity and relative permeability
!c           pressure(nn)       = fluid pressure
!c           freshcol           = length of freshwater column for
!c                                hydrostatic initial condition
!c           gacc               = magnitude of gravitational
!c                                acceleration
!c           gfwd(nc)           = component gram formula weights
!c           hydro_top          = top of dense water column for
!c                                hydrostatic initial condition
!c           massfrac           = component mass fraction
!c           ref_dens           = reference density to convert 
!c                                freshwater heads to pressures
!c           rho_av             = average density between ivol
!c                                and jvol
!c           sia_dens(iter_sia) = maximum change in density from
!c                                Picard iteration
!c           sia_maxvol         = maximum fluid density change
!c                                between Picard iterations
!c           sia_maxvol(maxit_sia) = volume with maximum density update
!c                                from Picard iteration (output)
!c           sia_nexvol(maxit_sia) = number of volumes exceeding Picard 
!c                                update tolerance (output)
!c           saold(nn)          = aqueous saturations time level N-1
!c           ssdens(nn)         = density of point source fluid
!c           tds_ic             = component concentration [g/L]
!c           tds_new(nn)        = total dissolved solids [g/L]      
!c                                at current time step N+1
!c           tds_old(nn)        = total dissolved solids [g/L]       
!c                                at previous time step N
!c           tds_old2(nn)       = total dissolved solids [g/L]       
!c                                at previous time step N-1
!c           tol_sia            = Picard iteration convergence tolerance
!c           tot_tds            = total dissolved solids [g/L]
!c           viscosity(nn)      = fluid viscosity
!c
!c           integer*4:
!c           ----------
!c           ianpl(nnpl)        = pointer for napl components
!c           iter_sia           = iteration counter - Picard iteration
!c           iter_target        = target number of Picard iterations
!c           inpl               = counter for napl components
!c           l_namenpl(nnpl)    = length of napl name
!c           maxit_sia          = maximum number of Picard iterations
!c           msia               = total number of sequential iterations
!c                                between flow and transport equations
!c           ndd                = number of components used for 
!c                                fluid density calculation
!c           nnpl               = total number of napl components
!c           ts_sia             = picard iterations per given time step
!c            
!c
!c           logical:
!c           --------
!c           density_dependence = .true.  -> simulate density 
!c                                           dependent flow
!c           fluid_pressure     = .true.  -> initial and boundary
!c                                           conditions in terms 
!c                                           of fluid pressure 
!c           flow_verification  = .true.  -> verify pressure formulation
!c                                           for constant density 
!c                                           test problem
!c           fresh_head         = .true.  -> initial and boundary
!c                                           conditions in terms 
!c                                           of freshwater head 
!c           hydrostatic_condition = .true.  calculate initial
!c                                           hydrostatic profile 
!c           init_perm          = .true.  -> initial media properties
!c                                           in permeability units
!c           init_cond          = .true.  -> initial media properties
!c                                           in hydraulic conductivity
!c                                           units
!c           napl_match         = .true.  -> mineral component is a napl
!c           napl_permeability  = .true.  -> immobile napl phase present
!c           not_converged_sia  = .true.  -> continue Picard iteration
!c                                           between flow and transport/
!c                                           reaction equations
!c           specify_dd_comp    = .true.  -> specify components used to
!c                                           calculate fluid density
!c           update_viscosity   = .true.  -> calculate fluid viscosities
!c
!c           av_dens_z       = .true.  -> average density for pressure
!c                                           difference calculation
!c
!c           new_stor_deri      = .true.  -> new formula for storage term 
!c                                           derivative
!c           coupled_porpress   = .true.  -> coupled porosity/pressure change
!c                                           (e.g., porosity is modified and 
!c                                            pressure is modified accordingly)
!c
!c           coupled_drhodt     = .true.  -> coupled density/temperature change
!c                                           in storage calculation 
!c                                           (e.g., density is modified and 
!c                                            temperature is modified accordingly)
!c
!c           character:
!c           ----------
!c           ts_min             = factor limiting time step length
!c                                  'varsat'   -> variably-saturated flow
!c                                  'reactive' -> reactive transport
!c                                  'courant'  -> courant criteria
!c                                  'picard'   -> picard iterations
!c           namedd(ndd)        = component names for fluid density
!c                                calculation
!c           namenpl(nnpl)      = napl component names
!c           napl_kfunction     = function for aqueous relative
!c                                permeability
!c                                  -> 'van genuchten'
!c                                  -> 'corey'
!c        -->                                                         <--
!c ----------------------------------------------------------------------
    real (type_r8), allocatable :: density(:)
    real (type_r8), allocatable :: densold(:)
    !real (type_r8), allocatable :: densold1(:)
    real (type_r8), allocatable :: densold2(:)
    real (type_r8), allocatable :: viscosity(:)
    real (type_r8), allocatable :: viscoold(:)
    real (type_r8), allocatable :: tds_new(:)
    real (type_r8), allocatable :: tds_old(:)
    real (type_r8), allocatable :: tds_old2(:)
    real (type_r8), allocatable :: del_p(:)
    real (type_r8), allocatable :: del_z(:)
    real (type_r8), allocatable :: dcoef(:)
    real (type_r8), allocatable :: ssdens(:)
    real (type_r8), allocatable :: sia_dens(:)
    real (type_r8), allocatable :: gfwdd(:)

    integer (type_i4), allocatable :: sia_maxvol(:)
    integer (type_i4), allocatable :: sia_nexvol(:)
    integer (type_i4), allocatable :: l_namenpl(:)
    integer (type_i4), allocatable :: ianpl(:)

    real (type_r8) :: drho_dc
    real (type_r8) :: drho_dt
    real (type_r8) :: ref_dens
    real (type_r8) :: ref_visco
    real (type_r8) :: delt_tds
    real (type_r8) :: rho_av
    real (type_r8) :: dvolcoef
    real (type_r8) :: tol_sia
    real (type_r8) :: sia_max
    real (type_r8) :: delt_courant
    real (type_r8) :: delt_sia
    real (type_r8) :: courant_max
    real (type_r8) :: courant_target
    real (type_r8) :: massfrac
    real (type_r8) :: freshcol
    real (type_r8) :: hydro_top
    real (type_r8) :: tot_tds
    real (type_r8) :: tds_ic
    real (type_r8) :: sia_ts_mult
    real (type_r8) :: napl_tol

    integer (type_i4) :: iter_sia
    integer (type_i4) :: iter_target
    integer (type_i4) :: maxit_sia
    integer (type_i4) :: ts_sia
    integer (type_i4) :: msia
    integer (type_i4) :: ndd
    integer (type_i4) :: nnpl
    integer (type_i4) :: courant_num
!cprovi-------------------------------------
!cprovi For density driven flow 
!cprovi-------------------------------------
    logical :: density_dependence
    logical :: fluid_pressure
    logical :: fresh_head
    logical :: init_perm
    logical :: init_cond
    logical :: flow_verification
    logical :: update_viscosity
    logical :: not_converged_sia
    logical :: specify_dd_comp
    logical :: hydrostatic_condition
    logical :: napl_match
    logical :: napl_permeability                  
    logical :: aq_conc_field
    logical :: cec_field
    logical :: mineral_vol_field
    logical :: mineral_surf_field
    logical :: mineral_vnuc_field
    logical :: mineral_anuc_field
    logical :: av_dens_z
    logical :: new_stor_deri
    logical :: coupled_porpress
    logical :: coupled_drhodt
    logical :: allow_sia_max_t1
!cprovi-------------------------------------
!cprovi For the density calculations 
!cprovi based on Pitzer equations 
!cprovi-------------------------------------
    logical :: ispitzerdens
!cprovi-------------------------------------
!cprovi Split desnity changes in mixing and 
!cprovi reaction components
!cprovi-------------------------------------             
    logical :: issplitdens
    integer :: idens
!cprovi-------------------------------------
!cprovi Upstream factor for flow 
!cprovi-------------------------------------       
    real (type_r8) :: ups_flow
!cprovi-------------------------------------
!cprovi-------------------------------------
!cprovi-------------------------------------          
    character*8 ::  ts_min
    character*14 :: napl_kfunction
    character*72, allocatable :: namedd(:)
    character*72, allocatable :: namenpl(:)
    
    logical, allocatable      :: modify_por(:)

    end module dens
