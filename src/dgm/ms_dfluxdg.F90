!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/dgm/ms_dfluxdg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine ms_dfluxdg
!c ---------------------
!c
!c compute derivative of total diffusive flux of gases using the maxwell stefan eqs
!c LU decomposition of system matrix perfomed previously to calculate fluxes 
!c is used here to solve system
!c
!c amat dfmat/dy  = dbmat/dy - damat/dy fmat
!c
!c amat (i,i) = - SUM (Xj/Dij) - 1/Di^k
!c amat (i,j) =   Xi/Dij
!c dbmat (i)  =   d/dy [ nabla(Ci) + dens * gacc / R / T * Xi * nabla(z) ]
!c dfmat (i)  =   dNi^D/dy  (derivative of molar diffusive flux of species i)
!c
!c equations i=1,ng-1
!c
!c written by:      Sergi Molins - May 2, 2006
!c
!c last modified:   Sergi Molins - May 24,2006
!c                  press+temp dependence of diff coeff
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c_i(ng)            = gaseous species concentrations      + -
!c                                at control volume i
!c           c_j(ng)            = gaseous species concentrations      + -
!c                                at control volume j
!c           dc_i(ng)           = derivative of gas concentrations    + -
!c                                at control volume i
!c           dmolfrac_i(ng)     = derivative of gas molar fraction    + -
!c                                at control volume i
!c           zgi                = elevation at control volume i       + -
!c           zgj                = elevation at control volume j       + -
!c           dens               = gas density at interface i-j        + -
!c           gpij               = gas pressure at interface i-j       + - 
!c           tempkel            = temperature at interface i-j [K]    + -
!c           tauijx             = gas tortuosity at interface i-j     + - 
!c           gporx              = porosity at interface i-j           + -
!c           delta_ijx          = distance between nodes i - j [m]    + -
!c           small              = constant                            + -
!c           factor             = weighting factor to compute         + -
!c                                derivative term at interface i-j
!c                                (see wgpropd.f subroutine)   
!c           ludecomp(ng-1,ng-1)= LU decomposition of amat            + -
!c                                (see dgm_fluxdg.f subroutine)
!c           fmatx(ng)          = molar diffusive fluxes for          + -
!c                                gas species [moles m^-2 d^-1]
!c           ms_gflux(nc)       = total molar diffusive fluxes for    + -
!c                                gas components [moles m^-2 d^-1]
!c           ms_dgflux(nc)      = derivatives of                      * +
!c                                total molar diffusive fluxes for
!c                                gas components [moles m^-2 d^-1]
!c           integer*4:
!c           ----------
!c           ipvt(ng)           = pivot indeces
!c                                (see dgefam.f,dgeslm.f subroutines) + -
!c
!c           logical:
!c           --------
!c           equimolar          = .true. -> equimolar diffusion w/S-M + -
!c
!c gen.f:    real*8:
!c           -------
!c           gacc               = gravity m s^-2                      + -
!c
!c           logical:
!c           -------
!c           gas_gravity        = enable gas gravity in advection     + -
!c
!c chem.f    real*8:
!c           -------
!c           rgasjoule          = ideal gas constant
!c                                [J/(deg K mol)]
!c           gfwg(ng)           = gram formula weight gas species     + -
!c           xnug(ng*nc)        = stoichiometric coefficient matrix 
!c                                for formation of gases from
!c                                components
!c           pa_atm             = pascal to atmosphere                + -
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gas species               + -
!c           nr                 = number of redox couples             + -
!c           iaga(ng+1)         = row pointer array to                + -
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           jaga(ng*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           logical:
!c           -------
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c phys.f:   real*8:
!c           -------
!c           diff_bin_g(ng,ng)  = binary diffusion coefficients       + -
!c           theta_diff         = exponent for temp correction        + -
!c
!c           logical:
!c           --------
!c           diff_press         = correction for pressure dependence  + -
!c           diff_temp          = correction for temp dependence      + -
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           r0               = constant
!c           r1               = constant
!c           dbmat(ng-1)      = vector
!c           damat(ng-1,ng-1) = matrix
!c           fmat(ng-1)       = vector
!c           ymat(ng)         = vector
!c           beta(ng)         = vector
!c           alpha_diff       = factor that modifies the diffusion coeff
!c                              as a function pressure and temperature
!c
!c           integer*4:
!c           ----------
!c           i                = index
!c           ic               = index
!c           jc               = index
!c           istart           = index 
!c           iend             = index
!c
!c external: dgeslm.f         = linear system solver
!c           comptotc.f       = total gaseous component diff flux vectors
!c ----------------------------------------------------------------------
 
      subroutine ms_dfluxdg (c_i        ,c_j        ,                  &
                             dc_i       ,dmolfrac_i ,                  &
                             zgi        ,zgj        ,                  &
                             dens       ,gpij       ,                  &
                             tempkel    ,tauijx     ,                  &
                             gporx      ,delta_ijx  ,                  &
                             small      ,factor     ,                  &
                             ipvt       ,equimolar  ,                  &
                             ludecomp   ,fmatx      ,                  &
                             ms_gflux   ,ms_dgflux )
 
        use gen, only  : gas_gravity, gacc
        use chem, only : gfwg, iaga, jaga, nc, ng, nr, pa_atm,         &
                         rgasjoule, redox_equil, xnug
        use phys, only : diff_bin_g, diff_press, diff_temp, theta_diff
    
        implicit none

!c------------------------------------------------
!c     constants
        real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0,                   &
                             rverysmall = 1.0d-30

!c     passed
        real*8 ::    c_i(ng)       ,c_j(ng)       ,                    &
                     dc_i(ng)      ,                                   &
                     dmolfrac_i(ng),                                   &
                     zgi           ,zgj           ,                    &
                     dens          ,gpij          ,                    &
                     tempkel       ,tauijx        ,                    &
                     gporx         ,delta_ijx     ,                    &
                     small         ,factor        ,                    &
                     ludecomp(ng-1,ng-1)          ,                    &
                     fmatx(ng)                    ,                    &
                     ms_gflux(nc)                 ,                    &
                     ms_dgflux(nc)

      integer :: ipvt(ng)
        
      logical :: equimolar

      external :: dgeslm, comptotc
      
!c    internal
      integer :: i, j, ic, ig, jc, istart, iend        

      real*8 ::  dbmat(ng-1)  ,damat(ng-1,ng-1),                      &
                 fmat(ng-1)   ,ymat(ng)        ,                      &
                 beta(ng)     ,alpha_diff

!c---------------------------------------------------------------------------
!c     initialize variables
        do ic=1,ng-1
          fmat(ic)  = fmatx(ic)
          ymat(ic)  = r0
          damat(ic,ic)= r0
        enddo      

!c     pressure & temperature dependence
        alpha_diff = r1

        if (diff_press) then    
          alpha_diff = alpha_diff / gpij / pa_atm       
        endif

        if (diff_temp) then
          alpha_diff = alpha_diff * tempkel**theta_diff
        endif

!c---------------------------------------------------------------------------
!c     check if there is gas phase
        if (gporx.lt.small) then
!c         no gas phase: do not calculate fluxes        
        else
!c---------------------------------------------------------------------------
!c        initialize weight coefficients
          if (equimolar) then
          
            do jc=1,ng
              beta(jc) = 1.d0
            enddo
      
          else if (.not.equimolar) then
            do jc=1,ng 
              beta(jc) = dsqrt(gfwg(jc))
            enddo
          endif

!c       set up Maxwell Stefan system
          if (.not.gas_gravity) then ! do not include gravity
      
            do ic=1,ng-1
              damat(ic,ic)= r0
              do jc =1,ng-1
                if (ic.ne.jc) then
                
!c                 --diagonal terms
                  damat(ic,ic) = damat(ic,ic)                                &
                               - dmolfrac_i(jc)                              &
                               / diff_bin_g(ic,jc) / gporx / tauijx * factor &
                               / alpha_diff 
                
!c                 --off-diagonal terms
                  damat(ic,jc) = 0.d0                                        &       
                               + dmolfrac_i(ic)                              &
                               / diff_bin_g(ic,jc) / gporx / tauijx * factor &
                               / alpha_diff                                  &
                               - beta(jc) / beta(ng) * dmolfrac_i(ic)        &
                               / diff_bin_g(ic,ng) / gporx / tauijx * factor & !ng-th
                               / alpha_diff 
                
                endif !ic.ne.jc
            
              enddo ! jc
            
              damat(ic,ic) = damat(ic,ic)                                    &
                             - dmolfrac_i(ng)                                &
                             / diff_bin_g(ic,ng) / gporx / tauijx * factor   &
                             / alpha_diff                                    &
                             - beta(ic) / beta(ng) * dmolfrac_i(ic)            &
                              / diff_bin_g(ic,ng) / gporx / tauijx *factor   & ! ng-th
                              / alpha_diff 
            
              dbmat(ic) = - dc_i(ic) / delta_ijx
            
              do jc=1,ng-1
                dbmat(ic) = dbmat(ic) - damat(ic,jc) * fmat(jc)
              enddo
            
            enddo !ic

          else ! include gravity

            do ic=1,ng-1
        
              damat(ic,ic)= r0
              do jc =1,ng-1
                if (ic.ne.jc) then
!c             --diagonal terms
                  damat(ic,ic) = damat(ic,ic)                                &
                               - dmolfrac_i(jc)                              &
                               / diff_bin_g(ic,jc) / gporx / tauijx * factor &
                               / alpha_diff  

!c             --off-diagonal terms
                  damat(ic,jc) = 0.d0                                        &
                               + dmolfrac_i(ic)                              &
                               / diff_bin_g(ic,jc) / gporx / tauijx * factor &
                               / alpha_diff                                  &
                               - beta(jc) / beta(ng) * dmolfrac_i(ic)        &
                               / diff_bin_g(ic,ng) / gporx / tauijx *factor  & !ng-th
                               / alpha_diff 

                  endif !ic.ne.jc
                enddo ! jc

                damat(ic,ic) = damat(ic,ic)                                  &
                           - dmolfrac_i(ng)                                  &
                           / diff_bin_g(ic,ng) / gporx / tauijx * factor     &
                           / alpha_diff                                      &
                             - beta(ic) / beta(ng) * dmolfrac_i(ic)            &
                           / diff_bin_g(ic,ng) / gporx / tauijx * factor     & !ng-th
                           / alpha_diff 
              
                dbmat(ic) = - dc_i(ic) / delta_ijx                           &
                        + dens * gacc * dmolfrac_i(ic) * (zgj - zgi)         &
                            / delta_ijx /  rgasjoule / tempkel / 1.d3            &
                        / alpha_diff 
              do jc=1,ng-1
                dbmat(ic) = dbmat(ic) - damat(ic,jc) * fmat(jc)
              enddo

            enddo !ic

          endif

!c---------------------------------------------------------------------------
!c       solve for derivative of fluxes using LU decomposition performed prev.
!c       back substitution
          call dgeslm (ludecomp,ng-1,ng-1,ipvt,dbmat)
!c---------------------------------------------------------------------------

        endif ! calculation of fluxes
!c---------------------------------------------------------------------------

!c     calculate derivative of flux of ng-th gas species

!cdsu  stupid intel compiler 2018.2 & 2018.3 on Niagara/Graham cluster report
!cdsu  "catastrophic error: **Internal compiler error: internal abort**"
!cdsu  if use ymat and /beta(ng) in a different location, move ymat and /beta(ng) out of loop

        ymat(ng) = r0
        ymat(1:ng-1) = dbmat(1:ng-1)

        do ig=1,ng-1
          !ymat(ig) = dbmat(ig)
          !ymat(ng) = ymat(ng) - beta(ig)/beta(ng) * dbmat(ig)
          ymat(ng) = ymat(ng) - beta(ig)*dbmat(ig)
        end do
        ymat(ng) = ymat(ng) / beta(ng)

!c     pass results to external variables

!c     initialize dgm_gflux
        do ic=1,nc 
          ms_dgflux(ic) = r0
        enddo

        do ig=1,ng

          istart = iaga(ig)
          iend = iaga(ig+1)-1
          
          do i = istart,iend
            ic = jaga(i)
            ms_dgflux(ic) = ms_dgflux(ic) + ymat(ig) * xnug(i)
          end do
        
        enddo

!c  compress total gaseous component diffusive flux vectors
!c  in case of redox equilibrium reactions

        if (redox_equil.and.nr.gt.0) then
          call comptotc(ms_dgflux)
        end if

!c---------------------------------------------------------------------------
        
      return
      end
