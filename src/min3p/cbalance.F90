!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 221 $
!> $Author: dsu $
!> $Date: 2014-08-05 14:29:49 -0700 (Tue, 05 Aug 2014) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/cbalance.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine cbalance
!c -------------------
!c compute charge balance 
!c
!c written by:      Uli Mayer - April 21, 96
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                [moles/l water]
!c           cx(nx)             = concentration of secondary          + -
!c                                aqueous species
!c           zbal               = charge balance in %                 * +
!c           zpos               = sum of positive charge              * +
!c           zneg               = sum of negative charge              * +
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           chargec(nc)        = charge of free species              + -
!c           chargex(nx)        = charge of secondary aqueous         + -
!c                                species
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o
!c           nx                 = number of secondary aqueous species
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r100               = constant
!c           tiny               = small increment
!c   
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: -  
!c ----------------------------------------------------------------------
  
      subroutine cbalance(c,cx,zbal,zpos,zneg)

      use parm
      use chem
 
      implicit none
      
      real*8 :: c,cx,zbal,zpos,zneg
 
      dimension c(*),cx(nx)

      real*8, parameter :: r0 = 0.0d0, r100 = 1.0d2, tiny = 1.d-100
      
      integer :: ic, ix
      
      real*8 :: sumz
 
      zpos = 0.0d0
      zneg = 0.0d0
      zbal = 0.0d0
 
!c  free species
 
      do ic=1,nc
        if (chargec(ic).gt.r0) then
          zpos = zpos + chargec(ic) * c(ic)
        elseif (chargec(ic).lt.r0) then
          zneg = zneg - chargec(ic) * c(ic)
        end if
      end do
 
!c  sum up aqueous complexes
 
      do ix=1,nx
        if (chargex(ix).gt.r0) then
          zpos = zpos + chargex(ix) * cx(ix)
        elseif (chargex(ix).lt.r0) then
          zneg = zneg - chargex(ix) * cx(ix)
        end if
      end do
 
!c  charge balance in %
 
      sumz = zpos + zneg
      if (dabs(sumz).gt.tiny) then
        zbal = dabs((zpos - zneg)/sumz) * r100
      end if
 
      return
      end
