!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/rategasd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine rategasd
!c -------------------
!c
!c compute degassing rates
!c
!c density dependent flow modification
!c
!c written by:      Uli Mayer - March 1, 00
!c
!c last modified:   Tom Henderson - October 22, 2002
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c common:
!c passed:   real*8:
!c           -------
!c           tkel               = nodal temperatures in Kelvin        + - 
!c           g(ng)              = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c           phead              = pressure head                      + -
!c
!c chem.f:   real*8:
!c           -------
!c           degas_rate         = rate constant for degassing         + -
!c                                [mol L-1 h2o s-1]
!c           pa_atm             = conversion factor [Pa atm ^-1]      + -
!c           pres_atm           = atmospheric pressure [atm]          + -
!c           rateg(ng,nthreads) = degassing rates                     * +
!c           rgasatm            = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           rho_w              = desnity of water [kg m^-3]          + -
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gases                     + -
!c
!c local:    real*8:
!c           -------
!c           pres_tot           = total gas pressure [atm]
!c           pres_conf          = confining pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           rate               = reaction rate [mol L^-1 h2o s^-1]
!c
!c           integer*4:
!c           ----------
!c           ig                 = counter (gases)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine rategasd(g,tkel,phead,sg_loc,tid)
 
      use parm
      use chem
      use bbls
      use mip_bubble, only : mip_mt_enable
      use gen, only : rank, b_enable_output

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      real*8 :: g, tkel, phead, sg_loc

      integer :: tid
      
      real*8 :: pres_tot, pres_conf, rate
      
      integer :: ig, info_debug
      
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0

      dimension g(*)
      
!c  initialize array for degassing rates

      do ig = 1,ng
        rateg(ig,tid) = r0
      end do
      
!c  compute total gas pressure

      pres_tot = r0
      do ig = 1,ng
        pres_tot = pres_tot + rgasatm*tkel*g(ig)
      end do

!c  compute confining pressure
!c  assumes constant density for now
!c  DSU 2020-05-21, fixed bug here, phead is already has unit of Pa
      !pres_conf = pres_atm + (rho_w * gacc * phead)/pa_atm
      pres_conf = pres_atm + phead/pa_atm

!c  compute total rate of degassing, if sum of partial pressures 
!c  exceeds confining pressure
!c_bub_degas
      if (.not.gas_bubbles .and. .not.mip_mt_enable) then
        if (pres_tot.gt.pres_conf) then

          rate = -degas_rate * (r1-pres_tot/pres_conf)

!c  compute rates for specific gases depending on mole fraction in 
!c  escaping gas mixture

          do ig = 1,ng
            rateg(ig,tid) = (rgasatm*tkel*g(ig))/pres_tot * rate
          end do

        end if
      else
        if (sg_loc.gt.max_sg_degas) then        
          rate = -degas_rate * (r1-sg_loc/max_sg_degas)        
          do ig = 1,ng
            rateg(ig,tid) = (rgasatm*tkel*g(ig))/pres_tot * rate
          end do        
        end if
      end if

!cdbg ---- activate this section for purposes of debugging -----
#ifdef DEBUG
      info_debug = 0

      if (info_debug.gt.0) then
        if (rank == 0 .and. b_enable_output.and.pres_tot.gt.pres_conf) then
          write(*,'(a)') 'returning from rategas ...'
          write(*,*) pres_tot/pres_conf
          write(*,*) 'rate  ', rate
            do ig = 1,ng
              write(*,"(a,1x,1pe15.6e3)") trim(nameg(ig)), rateg(ig,tid)
            end do
          write(*,*) '----------------------------------------------'
        end if
      end if

      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
#endif
      return
      end
