!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readmin_new.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readmin_new
!c ----------------------
!c
!c read database for minerals and assign to permanent storage
!c
!c written by:      Uli Mayer - February 8, 96
!c
!c last modified:   Uli Mayer - March 6, 96
!c                  full set of backward reactions included
!c                  Uli Mayer - April 24, 97
!c                  zero order reactions included
!c                  Uli Mayer - July 21, 97
!c                  new rate law for surface controlled
!c                  reactions included
!c                  Uli Mayer - May 21, 99
!c                  added hyperbolic terms
!c                  Uli Mayer - Nov 10, 01
!c                  started conversion to new database format
!c                  Uli Mayer - Feb 3, 02
!c                  added hyperbolic and inhibition terms due
!c                  to minerals
!c                  Uli Mayer - August 8, 02
!c                  completed conversion to new database format
!c                  
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           imdbs              = unit number - databse for minerals  + -
!c           ilog               = unit number - log book              + -
!c           idbg               = unit number - debugging file        + -
!c           icnv               = unit number - data conversion       + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           densm(nm)          = densities of minerals               * +
!c           dgcm(nm)           = activation energy for               * +
!c                                dissolution-precipitation
!c                                reaction
!c           dhcm(nm)           = enthalpy change of dissolution-     * +
!c                                precipitation reaction
!c           dwcm(nm)           = activation enthalpy for             * +
!c                                diffusion coefficient of transport
!c                                transport reaction
!c           diffm(ndr*nm,nthreads)
!c                              = diffusion coefficient of primary    * +
!c                                reactant through surface coating
!c           eqms(nm)           = equilibrium constants for minerals  * +
!c                                at standard temperatures
!c           fmdi(nrc*nm)       = inhibition constants - T^a          * +
!c           fmdm(nrc*nm)       = half saturation constants - T^a     * +
!c           fmic(nrc*nm)       = inhibition constants - C^c          * +
!c           fmhc(nrc*nm)       = half saturation constants - C^c     * +
!c           fmdpi(nrc*nm)      = inhibition constants - phi^m        * +
!c           fmdpm(nrc*nm)      = half saturation constants - phi^m   * +
!c           gfwm(nm)           = gram formula weight of minerals     * +
!c           orddc(nrc*nm)      = order of free species in            * +
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          * +
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    * +
!c                                concentration in dissolution
!c                                reaction
!c           ordm(ndr*nm)       = exponent m for reaction rate law    * +
!c           ordmdi(nrc*nm)     = order of inhibition terms for       * +
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmdm(nrc*nm)     = order of hyperbolic terms for       * +
!c                                dissolution-precipitation reactions
!c                                - T^a
!c           ordmic(nrc*nm)     = order of inhibition terms for       * +
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmhc(nrc*nm)     = order of hyperbolic terms for       * +
!c                                dissolution-precipitation reactions
!c                                - C^c
!c           ordmdpi(nrc*nm)    = order of inhibition terms for       * +
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordmdpm(nrc*nm)    = order of hyperbolic terms for       * +
!c                                dissolution-precipitation reactions
!c                                - phi^m
!c           ordn(ndr*nm)       = exponent n for reaction rate law    * +
!c           rateds(ndr*nm)     = rate constants for dissolution      * +
!c                                reactions at standard temperature
!c           xnud(ndr*nm)       = stoichiometric coefficients of      * +
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of free * +
!c                                species in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           iamd(nm+1)         = pointer array to dissolution        * +
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       * +
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  * +
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      * +
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      * +
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           iamic(ndr*nm+1)    = row pointer array to reactants      * +
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           iamhc(ndr*nm+1)    = row pointer array to reactants      * +
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           iamdpi(ndr*nm+1)   = row pointer array to reactants      * +
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - 
!c                                phi^m)
!c           iamdpm(ndr*nm+1)   = row pointer array to reactants      * +
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - 
!c                                phi^m)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      * +
!c                                component concentrations involved
!c                                in dissolution/precipitation
!c                                reactions
!c           jam(nm*nc)         = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamd(nrc*nm)       = pointer array to parallel reactions + -
!c                                involved in dissolution reactions
!c           jamdc(nrc*nm)      = pointer array to free species       * +
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  * +
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   * +
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - T^a)
!c           jamdm(nrc*nm)      = column pointer array to reactants   * +
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - T^a)
!c           jamic(nrc*nm)      = column pointer array to reactants   * +
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - C^c)
!c           jamhc(nrc*nm)      = column pointer array to reactants   * +
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - C^c)
!c           jamdpi(nrc*nm)     = column pointer array to reactants   * +
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms - 
!c                                phi^m)
!c           jamdpm(nrc*nm)     = column pointer array to reactants   * +
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms - 
!c                                phi^m)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      * +
!c                                component concentrations involved
!c                                in dissolution/precipitation
!c                                reactions
!c           l_namem(nm)        = length of mineral names             + -
!c           l_namemp(nm)       = length of names of parallel         * +
!c                                dissolution-precipitation reactions
!c           nc                 = number of components                + -
!c           nm                 = number of minerals                  + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     * +
!c           temp_corr          = .true.  -> specify constant         + -
!c                                           temperature
!c                                .false. -> use standard
!c                                           temperature
!c
!crevaff           
!c           reverse_affinity_term(nm) = .true. -> reverse affinity   - + 
!c                                                 term if IAP/K > 1                   
!crevaff
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namem(nm)          = mineral names                       + -
!c           namemp(ndr*nm)     = names for parallel                  * +
!c                                dissolution-precipitation reactions
!c           namex(nx)          = names of secondary aqueous species  + -
!c           namet(:)           = species names (temporary)           * *
!c           rate_control(nm)   = rate controlling process for        * +
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = 'reversible'                        * +
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'hyperbolic'
!c                                'raoult'
!c
!c local:    real*8:
!c           -------
!c           ordt(100)          = array for temporary storage of
!c                                reaction orders
!c           r0                 = constant
!c           r1                 = constant
!c           r10                = constant
!c           r86400             = constant
!c           value(100)         = array for temporary storage
!c           value2(100)        = array for temporary storage
!c           xnumt(100)         = array for temporary storage of
!c                                stoichiometric coefficients of
!c                                component in mineral
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           icount             = counter (check number of species)
!c           icur               = counter (position in compressed
!c                                         array)
!c           idc                = counter
!c           idcx               = counter
!c           ireac              = counter
!c           ireac2             = counter
!c           idt                = counter
!c           iend               = pointer
!c           im                 = counter (minerals)
!c           im2                = counter (minerals)
!c           imdi               = counter (inhibition terms - T^a)
!c           imdm               = counter (hyperbolic terms - T^a)
!c           imic               = counter (inhibition terms - C^c)
!c           imhc               = counter (hyperbolic terms - C^c)
!c           imdpi              = counter (inhibition terms - phi^m)
!c           imdpm              = counter (hyperbolic terms - phi^m)
!c           istart             = pointer
!c           iv                 = counter (temporarily stored values)
!c           ix                 = counter (complexed species)
!c           l_string           = length of text string
!c           l_sufx             = length of suffix
!c           ndc                = number of component species
!c                                involved in dissolution reaction
!c           ndcx               = number of complexed species
!c                                involved in dissolution reaction
!c           ndt                = number of components in form of
!c                                total aqueous component
!c                                concentrations
!c                                involved in dissolution reaction
!c           nmdi               = number of inhibition terms - T^a
!c           nmdm               = number of hyperbolic terms - T^a
!c           nmic               = number of inhibition terms - C^c
!c           nmhc               = number of hyperbolic terms - C^c
!c           nmdpi              = number of inhibition terms - phi^m
!c           nmdpm              = number of hyperbolic terms - phi^m
!c           nreac              = number of parallel dissolution
!c                                reactions for one mineral
!c           npc                = number of component species
!c                                involved in precipitation reaction
!c           npcx               = number of complexed species
!c                                involved in precipitation reaction
!c           nprec              = number of parallel precipitation
!c                                reactions for one mineral
!c           nv                 = number of temporarily stored
!c                                values
!c
!c           logical:
!c           --------
!c           comment_line       = .true.  -> read comment line
!c           done               = .true.  -> exit search
!c           found              = .true.  -> exit search
!c           found_keyword      = .true.  -> keyword found
!c           next_entry         = .true.  -> database entry for
!c                                           next mineral
!c           searching          = .true.  -> continue search
!c
!c           character:
!c           ----------
!c           keyword            = character string
!c           reaction_type_new  = reaction type, new definitions
!c           string             = character string
!c           suffix             = file suffix name
!c           name               = name of mineral currently
!c                                processed
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readmin_new(imdbs,ilog,idbg,igen,icnv)

      use parm
      use chem
      use gen, only : rank, b_enable_output, idbs_bk, use_dbs_bk
      use file_utility, only : makelowercase, replacecharacter,        &
                               readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
      integer :: imdbs,ilog,idbg,igen,icnv
      
      integer :: i, i1, i2, ic, icount, icur, idc, idcx, idt, im, im1, &
                 im2, imdm, imdpi, imdpm, imdi, imhc, imic, iv, ipath, &
                 ireac, ireac2, istart, iend, istart2, iend2, istop2,  &
                 ix, info_debug, l_string, l_sufx,  ndc, ndt, ndcx,    &
                 nmhc, nmic, nmdpi, nmdpm, nmdi, nmdm, nv, nreac,      &
                 ii, iinc, icur2, idpm, idscx, idsta, idsta2, idiff,   &
                 itemp, icount2, iiso, iiso2, istop, ndpm, ndscx,      &
                 idcm, ndcm, ndsta,nifr, ntsct, nprsc, nprs, idummy
      
      real*8 :: dummy
      real*8 :: xnumt(100),ordt(100),value(100),value2(100),           &
                alphat(100,100)
      integer :: ntsct2(100), iinum(100)

      character*1 string, suffix
      character*72 name, namet3, keyword, reaction_type_new
      character*256 :: strbuffer      
      character*72 :: namepair(100)
      logical comment_line,done,found,next_entry,searching,            &
              found_keyword
                                                               
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r10 = 10.0d0,       &
                           r86400 = 86400.0d0

!c  control parameter for debugging output

      info_debug = 0
      
!c initialize variable
      dgcm = r0
      dhcm = r0
      dwcm = r0
      eqms = r0

!c initialize pointer arrays for compressed storage

      iam(1) = 1
      iamd(1) = 1
      iamdc(1) = 1
      iamdcx(1) = 1
      iamdpm(1) = 1
      iamdscx(1) = 1
      iamdsta(1) = 1
      iamdsta2(1) = 1
      iamdiso(1) = 1
      iamdiso2(1) = 1
      iamdt(1) = 1
      iamdm(1) = 1
      iamdi(1) = 1
      iamdcm(1) = 1
      iamdphm(1) = 1
      iamdpi(1) = 1
      iamhc(1) = 1
      iamic(1) = 1
      
!c_bubbles initialize minimum delta G for reations

      dg_lim =  r1
      pressure_approximation = .false.
      isofrac = .false.
      isofracm = .false.
      satcorr_flag = .false.

!c  loop over minerals specified for simulation

      do im = 1,nm

!c  loop over minerals in database,
!c  search for match
!c  read all mineral data and store in compressed format
!c  exit when done or if mineral not found

      if (info_debug.gt.1) then
        write(*,*) "search for mineral index ", im
        write(*,*) trim(namem(im))
        write(*,*) ('-', i=1,72)
      end if

        done = .false.

        do while (.not.done)

!c  skip over comment lines in database

          comment_line = .true.
          do while (comment_line)
            read (imdbs,'(a1)',err=999) string
            if (string.ne.'!') comment_line = .false.
          end do

!c  backspace to start of database entry for current mineral

          backspace(imdbs)

!c  read mineral name

          read(imdbs,*,err=999,end=998) name

!c  look for match, as long end of data file is not reached or
!c  match is found

!c  mineral is found --> read data

          if (name.eq.namem(im)) then

            done = .true.

!c  -------------------------------------------------------------------
!c  read rate control for dissolution-precipitation reaction,

            read(imdbs,*,err=999,end=998) rate_control(im)

!c  -------------------------------------------------------------------
!c  read gram formula weight and density

            read(imdbs,*,err=999,end=998) gfwm(im), densm(im)

!c  -------------------------------------------------------------------
!c  read number and names of components and stoichiometric coefficients 
!c  of components in mineral reaction

            read(imdbs,*,err=999,end=998) nv,(namet(iv),              &
     &                                    xnumt(iv),iv=1,nv)

!c  -------------------------------------------------------------------
!c  read raction type

            read(imdbs,*,err=999,end=998) reaction_type(im)

          if (reaction_type(im).eq.'irreversible dissolution') then
            reaction_type(im) = 'dissolution_far_from_equilibrium'
          elseif (reaction_type(im).eq.                             &
     &              'irreversible dissolution - log K control') then   
              reaction_type(im) = 'dissolution_to_equilibrium'
          elseif (reaction_type(im).eq.                             &
     &              'irreversible precipitation') then                 
              reaction_type(im) =  'precipitation_far_from_equilibrium'
          elseif (reaction_type(im).eq.                             &
     &              'irreversible precipitation - log K control') then
            reaction_type(im) = 'precipitation_to_equilibrium'
          end if

!c  check if type of reaction requires equilibrium constant
!c  exit program if error in database

            if (reaction_type(im).eq.'reversible' .or.                &
     &          reaction_type(im).eq.'dissolution_to_equilibrium' .or.&
     &          reaction_type(im).eq.                                 &
     &          'precipitation_to_equilibrium'.or.                    &
     &          reaction_type(im).eq.'raoult') then

              far_from_equil(im) = .false.

!c  backspace and read log_10 of equilibrium constant and enthalpy 
!c  change

            backspace(imdbs)
            read(imdbs,*,err=999,end=998) reaction_type_new,        &
     &                                      eqms(im), dhcm(im)

!c  convert equilibrium constant to linear scale and adjust for 
!c  internal calculations

              eqms(im) = r10 ** (-eqms(im))

!cdhr - corrected April 06 
              if (dhc_reverse) then
                dhcm(im) = dhcm(im)
              else
                dhcm(im) = -dhcm(im)
              end if       

            elseif (reaction_type(im).eq.                             &
     &              'dissolution_far_from_equilibrium' .or.           &
     &              reaction_type(im).eq.                             &
     &              'precipitation_far_from_equilibrium') then
                                                                       
              far_from_equil(im) = .true.
                                                                       
            else
              if (rank == 0) then                                                         
                write(ilog,*) 'SIMULATION TERMINATED'                    
                write(ilog,*) 'error reading database "mineral.dbs"'     
                l_string = index(reaction_type(im),' ')-1                
                if (l_string.eq.-1.or.l_string.gt.72) then               
                  l_string = 72                                          
                end if                                                   
                write(ilog,*) 'reaction type ',reaction_type(im)       &
     &                        (:l_string),' not defined'
                close(ilog)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop

            end if

!c  rewind file and return to start of data input for mineral reaction

            call findname(namem(im),imdbs,found_keyword) 

!c  define number of parallel reaction pathways
            
          found = .false.
          searching = .true.
                        
          do while (searching.and..not.found)
                  
            read(imdbs,*,err=999,end=998) keyword            
            backspace(imdbs)
            read (imdbs,'(a1)',err=999) string

            if (keyword.eq.'parallel reaction pathways') then
                  
              found = .true.
              backspace(imdbs)
              read(imdbs,*,err=999,end=998) keyword,nreac
              
!c  exit, if end of mineral reaction input is reached, set number of
!c  parallel reaction pathways to 1 

            elseif (string.eq.'!') then
            
              searching = .false.
              nreac = 1
            
            end if

          end do

          if (info_debug.gt.1) then
             write(*,*) 'number of parallel reaction pathways', nreac
          end if

!c  rewind file and return to start of data input for mineral reaction

          call findname(namem(im),imdbs,found_keyword)

!c  pointer array to row in stoichiometric reaction matrix for
!c  next mineral

            iam(im+1) = iam(im)+nv

!c  check if all components for mineral are specified in general
!c  input file
!c  set up pointer array to column in stoichiometric matrix

      
            icount = 0
            ic = 0
            do while ((icount.lt.nv).and.(ic.lt.nc))
              ic = ic+1
              iv = 0
              found = .false.
              do while ((iv.lt.nv).and.(.not.found))
                iv = iv+1
                if (namet(iv).eq.namec(ic)) then
                  found = .true.
                  icount = icount+1
                  icur = iam(im)+iv-1
                  jam(icur) = ic
                end if
              end do
            end do

!c  if component is missing, exit

            if (icount.ne.nv) then
              if (rank == 0) then  
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(a,a12,a)')'component species for ',       &
     &                               name,' is missing'
                 write(ilog,*) namet(1:nv), namec(1:nc)
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop

!c  all components available --> read data and assign to arrays

            elseif (icount.eq.nv) then

!c  assign stoichiometric coefficients

              istart = iam(im)
              iend = iam(im+1)-1
              iv = 0
              do i = istart,iend
                iv = iv+1
                xnum(i) = xnumt(iv)
              end do

!c  assign position for next mineral im+1

              iamd(im+1) = iamd(im) + nreac

!c  loop over number of parallel dissolution/precipitation reactions
!c  for mineral im

              istart = iamd(im)
              iend = iamd(im+1)-1

              ireac2 = 0

              do ireac = istart,iend

!c  set defaults for reaction pathway

                ordm(ireac) = r1 
                ordn(ireac) = r1           !currently not used
                ndt = 0
                ndc = 0
                ndcx = 0
                ndpm = 0
                ndcm = 0
!c_uranium
                ndscx = 0
!c_isotopes
                ndsta = 0
                nmdm = 0
                nmdi = 0
                nmhc = 0
                nmic = 0
                nmdpm = 0
                nmdpi = 0
                rateds(ireac) = r86400
                diffm(ireac,:) = r0
                diffms(ireac) = r0
                xnud(ireac) = r0

!c  assign names for parallel reactions

                ireac2 = ireac2+1
                !Deprecated, use internal convert instead. DSU
                !rewind(icnv)
                !write(icnv,'(i1)') ireac2
                !rewind(icnv)
                !read(icnv,'(a1)') suffix
                write(suffix,'(i1)') ireac2
                l_sufx = 1

                namemp(ireac) = namem(im)(:l_namem(im))//'_'//        &
     &                          suffix(:l_sufx)

!c  define length of namemp(ireac)

                l_namemp(ireac) = index(namemp(ireac),' ')-1
                if (l_namemp(ireac).eq.-1.or.l_namemp(ireac).gt.14) then
                  l_namemp(ireac) = 14
                end if
                
                
!c  assign the parallel reaction (ireact) related mineral
!c  first check whether the number of the total reactions is
!c    over the maximum allocated memory for jamd(maxnrc*nm)
                if (ireac .gt. (maxnrc*nm)) then
                    write(ilog,*) 'error in reading database file mineral.dbs. '
                    write(ilog,'(2a/)') 'The mineral is:   ', namemp(ireac)
                    write(ilog,'(a,i10/)')  &
                     'Maximum number of parallel reactions for one mineral is limited to: ',maxnrc 
                    write(ilog,*) 'contact the MIN3P-THCm for assistance! '
                    write(ilog,*) 'Bye now!'
#ifdef PETSC
                    call petsc_mpi_finalize
#endif                    
                    stop
                else
                    jamd(ireac) = im
                end if

!c  ---------------------------------------------------------------------
!c  log rate constant

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for log rate constant:'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'log rate constant') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,rateds(ireac)
                  if (info_debug.gt.1) then
                    write(*,*) keyword, rateds(ireac)
                  end if

!c  convert log rate constant to rate constant and convert time units
!c  from seconds to days
!c
                  rateds(ireac) = r10**(rateds(ireac))*r86400

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.  &
     &                    string.eq.'!') then
                  searching = .false.
                end if

              end do
              
!c_bubbles  ---------------------------------------------------------------------
!c  partial pressure approximation
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*)'searching for partial pressure term:'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                           
                if (keyword.eq.'partial pressure') then                
                  found = .true.
                  pressure_approximation(im) = .true.
                  if (rank==0.and.b_enable_output.and.                  &
                      info_debug.gt.1) then
                    write(*,*) 'found partial pressure term for ',     &
                          namem(im)                                     
                    write(*,*) 'pressure approximation = ',            &
                          pressure_approximation(im)
                  end if
                  
!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c_bubbles  ---------------------------------------------------------------------
!c  threshold energy
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for threshold energy:'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                           
                if (keyword.eq.'threshold energy') then
                
                  found = .true.
                  backspace(imdbs)
                  
                  read(imdbs,*,err=999,end=998) keyword,dg_lim(im)
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                    write(*,*) keyword, dg_lim(im)
                  end if

!c  convert threshold term to required value
!c
                  dg_lim(im) = exp(dg_lim(im)/tempks/(rgasjoule/1000))
                  
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                    write(*,*) keyword, dg_lim(im)
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  ---------------------------------------------------------------------
!c  activation energy

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for activation energy:'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'activation energy') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,dgcm(im)
                  if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                    write(*,*) keyword, dgcm(im)
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do
              
!c  ---------------------------------------------------------------------
!c  activation enthalpy
!c  add search for key word 'activation enthalpy' dwilson, November 24, 2015

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                write(*,*) 'searching for activation enthalpy:'
              end if

              found = .false.
              searching = .true.

              do while (searching.and..not.found)

                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                if (keyword.eq.'activation enthalpy') then

                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,dwcm(im)
                  if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                    write(*,*) keyword, dwcm(im)
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do
!c  ---------------------------------------------------------------------
!c  reaction heat
!c  add search for key word 'activation enthalpy' dwilson, November 24, 2015

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                write(*,*) 'searching for reaction heat:'
              end if

              found = .false.
              searching = .true.

              do while (searching.and..not.found)

                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                if (keyword.eq.'reaction heat') then

                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,dscm(im)

                  if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                    write(*,*) keyword, dscm(im)
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do
              
!c  ---------------------------------------------------------------------
!c reaction rate correction over saturation change

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                write(*,*) 'searching for rate correction over saturation change:'
              end if

              found = .false.
              searching = .true.

              do while (searching.and..not.found)

                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                if (keyword .eq. 'rate correction over saturation' .or.    &
                    keyword .eq. 'no freezing rate update') then
                  !cdsu kyeword 'no freezing rate update' is deprecated as it is misleading

                  found = .true. 
                  satcorr_flag(im) = .true.
                  if (rank==0 .and. b_enable_output.and. info_debug.gt.1) then
                    write(*,*) 'found rate update over saturation for ', trim(namem(im))
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do              

!crevaff  ---------------------------------------------------------------------
!c  control for reversing affinity term for reversibel dissolution-
!c  precipitation reactions
!
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for affinity term control keyword:'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'reverse affinity term') then
                  
                  found = .true.
                  reverse_affinity_term(im) = .true.
                  
                  if (info_debug.gt.1) then
                    write(*,*) keyword
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.    &
     &                    string.eq.'!') then
                  searching = .false.
                end if

                end do
!crevaff

!c  ---------------------------------------------------------------------
!c  exponent m for affinity term (1-(IAP/K)^m)^n

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for exponent m:'
              end if

              found = .false.
            searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'exponent m') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ordm(ireac)

                  if (info_debug.gt.1) then
                    write(*,*) 'exponent m = ',ordm(ireac)
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.    &
     &                    string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  ---------------------------------------------------------------------
!c  exponent n for affinity term (1-(IAP/K)^m)^n

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for exponent n:'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'exponent n') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ordn(ireac)
                  if(ordn(ireac) /= 1.0d0 .and. b_ratelaw_exponent_n .eqv. .false.) then
                    if (rank == 0 .and. b_enable_output) then
                      write(*,'(a,1x,a)') 'warning: exponent n is reset to 1 for',trim(namem(im))
                      write(ilog,'(a,1x,a)') 'warning: exponent n is reset to 1 for',trim(namem(im))
                    end if
                  end if

                  if (info_debug.gt.1) then
                    write(*,*) 'exponent n = ',ordn(ireac)
                    end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.    &
     &                    string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  ---------------------------------------------------------------------
!c  shrinking core parameters (diffusion coefficient and stiochiometric
!c  coefficient of primary reactant

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for shrinking core ',         &
     &                       'parameters:'
              end if

              found = .false.
            searching = .true.
                              
              do while (searching.and..not.found)                    
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)                                     
                read (imdbs,'(a1)',err=999,end=998) string

                                                                     
                if (keyword.eq.'shrinking core parameters') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,            &
     &                            diffms(ireac),xnud(ireac)

                  if (info_debug.gt.1) then
                    write(*,*) 'shrinking core parameters = ',      &
     &                            diffms(ireac),xnud(ireac)
                    end if

!c  convert diffusion coefficient to internal time units

                    diffms(ireac) = diffms(ireac)*r86400

!cdsu  save this coefficient for later use, diffusion coefficient at standard temperature, by dwilson November 24, 2015
                    diffm(ireac,:) = diffms(ireac)

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.                &
     &                    string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  ---------------------------------------------------------------------
!c  fractional order terms - total aqueous component concentrations

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for fractional order terms: T^a'
              end if
 
              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'fractional T^a') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ndt
                  do idt = 1,ndt
                    read(imdbs,*,err=999,end=998) namet(idt),ordt(idt)
                  end do

                  if (info_debug.gt.1) then
                    write(*,*) keyword,ndt
                    do idt = 1,ndt
                        write(*,*) trim(namet(idt))," ",ordt(idt)
                    end do
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage

                iamdt(ireac+1) = iamdt(ireac) + ndt 

                if (ndt.gt.0) then

                  icount = 0
                  ic = 0
                  do while ((icount.lt.ndt).and.(ic.lt.nc))
                    found = .false.
                    idt = 0
                    ic = ic+1
                    do while ((idt.lt.ndt).and.(.not.found))
                      idt = idt+1
                      if (namet(idt).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdt(ireac)+idt-1
                        jamdt(icur) = ic
                        orddt(icur) = ordt(idt)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.ndt) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(2a,a12,a)') 'component promoting ', &
     &                           'dissolution of ',name,' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if
              end if              !(ndt.gt.0)

!c  ---------------------------------------------------------------------
!c  fractional order terms - concentrations of component as species in
!c  solution

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (info_debug.gt.1) then
                write(*,*) 'searching for fractional order terms: C^c'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'fractional C^c') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ndc
                  do idc = 1,ndc
                    read(imdbs,*,err=999,end=998) namet(idc),ordt(idc)
                  end do               

                  if (info_debug.gt.1) then
                    write(*,*) keyword,ndc
                    do idc = 1,ndc
                      write(*,*) trim(namet(idc))," ",ordt(idc)
                    end do                  
                  
                  end if 

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage

                iamdc(ireac+1) = iamdc(ireac) + ndc
 
                if (ndc.gt.0) then
                  icount = 0
                  ic = 0
                  do while ((icount.lt.ndc).and.(ic.lt.nc))
                    found = .false.
                    idc = 0
                    ic = ic+1
                    do while ((idc.lt.ndc).and.(.not.found))
                      idc = idc+1                      
                      if (namet(idc).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdc(ireac)+idc-1
                        jamdc(icur) = ic
                        orddc(icur) = ordt(idc)
                      end if
                    end do
                  end do

!c  if component as species in solution is missing --> exit

                  if (icount.ne.ndc) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(2a,a12,a)') 'species promoting ',   &
     &                           'dissolution of ',name,' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if
              end if         !(ndc.gt.0)

!c  ---------------------------------------------------------------------
!c  fractional order terms - concentrations of aqueous complexes

!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (info_debug.gt.1) then
                write(*,*) 'searching for fractional order terms: C_x'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'fractional C^x') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ndcx
                  do idcx = 1,ndcx
                    read(imdbs,*,err=999,end=998) namet(idcx),ordt(idcx)
                  end do

                  if (info_debug.gt.1) then
                    write(*,*) keyword,ndcx
                    do idcx = 1,ndcx                                 
                        write(*,*) trim(namet(idcx))," ",ordt(idcx)
                    end do
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
 
              iamdcx(ireac+1) = iamdcx(ireac) + ndcx
 
              if (ndcx.gt.0) then
                icount = 0
                ix = 0
                do while ((icount.lt.ndcx).and.(ix.lt.nx))
                  found = .false.
                  idcx = 0
                  ix = ix+1
                  do while ((idcx.lt.ndcx).and.(.not.found))
                    idcx = idcx+1
                    if (namet(idcx).eq.namex(ix)) then
                      found = .true.
                      icount = icount+1
                      icur = iamdcx(ireac)+idcx-1
                      jamdcx(icur) = ix
                      orddcx(icur) = ordt(idcx)
                    end if
                  end do
                end do

!c  if aqueous complex is missing --> exit

                if (icount.ne.ndcx) then
                  if (rank == 0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(2a,a12,a)') 'aqueous complex ',     &
     &                         'promoting dissolution of ',name,     &
     &                         ' is missing'
                    write(ilog,'(72a)') ('-',i=1,72)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if

              end if        !(ndcx.gt.0)

!c  ---------------------------------------------------------------------
!c  fractional order terms - mineral concentration in mol/L bulk (kg/m^3 bulk)
!c  find current mineral and pathway, if applicable


              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for fractional order terms:',    &
                             ' C^m'
              end if

              found = .false.
              searching = .true.
                             
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                if (keyword.eq.'fractional C^m') then
                 
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ndcm
                  do idcm = 1,ndcm
                    read(imdbs,*,err=999,end=998) namet(idcm),ordt(idcm)
                  end do
                                                                       
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then                             
                    write(*,*) keyword,ndcm                             
                    do idcm = 1,ndcm                                    
                      write(*,*) namet(idcm),ordt(idcm)
                    end do
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction
              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
 
              iamdcm(ireac+1) = iamdcm(ireac) + ndcm
 
              if (ndcm.gt.0) then

                icount = 0
                idcm = 0
                do while (idcm.lt.ndcm)
                  idcm = idcm+1
                  im2 = 0
                  found = .false.
                  do while ((icount.lt.ndcm).and.(im2.lt.nm)           &
                             .and.(.not.found))
                    im2 = im2+1
                    if (namet(idcm).eq.namem(im2)) then
                      found = .true.
                      icount = icount+1
                      icur = iamdcm(ireac)+idcm-1
                      jamdcm(icur) = im2
                      ordmdcm(icur) = ordt(idcm)
                    end if
                  end do
                end do

!c  if mineral is missing --> exit

                if (icount.ne.ndcm) then
                  if(rank == 0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(5a)')                                 &
                          'mineral for dissolution-precipitation ',    &
                          'reaction ',namem(im)(:l_namem(im)),         &
                          ' is missing'
                    write(ilog,'(a)') 'fractional - mineral concentration'
                    write(ilog,'(72a)') ('-',i=1,72)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if

              end if      !nmdpm.gt.0
                
!c  ---------------------------------------------------------------------
!c  fractional order terms - mineral volumne fraction
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for fractional order terms:',    &
                             ' phi^m'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'fractional phi^m') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ndpm
                  do idpm = 1,ndpm
                    read(imdbs,*,err=999,end=998) namet(idpm),ordt(idpm)
                  end do
                                                                        
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then                             
                    write(*,*) keyword,ndpm                             
                    do idpm = 1,ndpm                                    
                      write(*,*) namet(idpm),ordt(idpm)
                    end do
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction
              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
 
              iamdphm(ireac+1) = iamdphm(ireac) + ndpm
 
              if (ndpm.gt.0) then

                icount = 0
                idpm = 0
                do while (idpm.lt.ndpm)
                  idpm = idpm+1
                  im2 = 0
                  found = .false.
                  do while ((icount.lt.ndpm).and.(im2.lt.nm)           &
                             .and.(.not.found))
                    im2 = im2+1
                    if (namet(idpm).eq.namem(im2)) then
                      found = .true.
                      icount = icount+1
                      icur = iamdphm(ireac)+idpm-1
                      jamdphm(icur) = im2
                      ordmdphm(icur) = ordt(idpm)
                    end if
                  end do
                end do

!c  if mineral is missing --> exit

                if (icount.ne.ndpm) then
                  if(rank == 0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(5a)')                                 &
                          'mineral for dissolution-precipitation ',    &
                          'reaction ',namem(im)(:l_namem(im)),         &
                          ' is missing'
                    write(ilog,'(a)') 'fractional - minerals'
                    write(ilog,'(72a)') ('-',i=1,72)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if

              end if      !nmdpm.gt.0

!c  ---------------------------------------------------------------------
!c_uranium
!c  fractional order terms - sum of concentrations of aqueous complexes
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for fractional order terms:',    &
                           ' sum C_x'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'fractional sum C^x') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,ndscx,         &
                                                orddsumx(im) 
                  do idscx = 1,ndscx
                    read(imdbs,*,err=999,end=998) namet(idscx),        &
                                                  ordt(idscx)
                  end do

                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                    write(*,*) keyword,ndscx
                    do idscx = 1,ndscx
                      write(*,*) namet(idscx),ordt(idscx)
                    end do
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
 
              iamdscx(ireac+1) = iamdscx(ireac) + ndscx
 
              if (ndscx.gt.0) then
                icount = 0
                ix = 0
                do while ((icount.lt.ndscx).and.(ix.lt.nx))
                  found = .false.
                  idscx = 0
                  ix = ix+1
                  do while ((idscx.lt.ndscx).and.(.not.found))
                    idscx = idscx+1
                    if (namet(idscx).eq.namex(ix)) then
                      found = .true.
                      icount = icount+1
                      icur = iamdscx(ireac)+idscx-1
                      jamdscx(icur) = ix
                      orddscx(icur) = ordt(idscx)
                    end if
                  end do
                end do

!c  if aqueous complex is missing --> exit

                if (icount.ne.ndscx) then
                  if(rank == 0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(2a,a12,a)') 'aqueous complex ',       &
                               'promoting dissolution of ',name,       &
                               ' is missing'
                    write(ilog,'(72a)') ('-',i=1,72)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if

              end if        !(ndscx.gt.0)         

!c  ---------------------------------------------------------------------
!c  hyperbolic terms - total concentrations

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
                
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for hyperbolic terms: T^a'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'hyperbolic T^a') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,nmdm
                  do i = 1,nmdm
                    read (imdbs,'(a1)',err=999,end=998) string
                    backspace(imdbs)
                    if(string .ne. "'") then
                      read(imdbs,*,err=999,end=998) value(i),value2(i),&
                                                    namet(i)
                    else
                      read(imdbs,*,err=999,end=998) namet(i),value(i), &
                                                    value2(i)
                    end if
                  end do
                  
                  if (info_debug.gt.1) then
                    write(*,*) keyword,nmdm
                    do i = 1,nmdm                                    
                        write(*,*) trim(namet(i)), " ", value(i), value2(i)
                    end do
                  end if 

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage

              iamdm(ireac+1) = iamdm(ireac) + nmdm

              if (nmdm.gt.0) then

                icount = 0
                imdm = 0
                do while (imdm.lt.nmdm)
                  imdm = imdm+1
                  ic = 0
                  found = .false.
                  do while ((icount.lt.nmdm).and.(ic.lt.nc)         &
     &                       .and.(.not.found))
                    ic = ic+1
                    if (namet(imdm).eq.namec(ic)) then
                      found = .true.
                      icount = icount+1
                      icur = iamdm(ireac)+imdm-1
                      jamdm(icur) = ic
                      fmdm(icur) = value(imdm)
                      ordmdm(icur) = value2(imdm)
                    end if
                  end do
                end do

!c  if component is missing --> exit

                if (icount.ne.nmdm) then
                  if (rank == 0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(5a)')                               &
     &                    'component for dissolution-precipitation ',&
     &                    'reaction ',namem(im)(:l_namem(im)),       &
     &                    ' is missing'
                    write(ilog,'(72a)') ('-',i=1,72)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if

              end if      !nmdm.gt.0
                
!c  ---------------------------------------------------------------------
!c_isotope
!c  hyperbolic terms - sum of total aqueous component concentrations
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for hyperbolic terms: sum T^a'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'hyperbolic sum T^a') then
                  
                  found = .true.
                  backspace(imdbs)
                  read(imdbs,*,err=999,end=998) keyword,ndsta
                  itemp = 1
                  do idsta = 1,ndsta
                    read(imdbs,*,err=999,end=998) ntsct
                    ntsct2(idsta) = ntsct
                    backspace(imdbs) 
                    read(imdbs,*,err=999,end=998) dummy,               &
                        (namet(i),i= itemp,itemp+ntsct2(idsta)-1),     &
                        value2(idsta), ordt(idsta)
                    itemp = itemp+ntsct2(idsta)                         
                  end do                                                
                                                                        
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then                             
                    write(*,*) keyword,ndsta                            
                    itemp = 1                                           
                    do idsta = 1,ndsta                                  
                        write(*,*)  idsta,                             &
                       (namet(i),i= itemp,itemp+ntsct2(idsta)-1),      &
                              value2(idsta), ordt(idsta)
                      itemp = itemp+ntsct2(idsta)
                    end do
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
               
              iinc = 0
              do idsta = 1,ndsta
                iinc = iinc+ntsct2(idsta)
              end do 

              iamdsta(ireac+1) = iamdsta(ireac) + iinc
              iamdsta2(ireac+1) = iamdsta2(ireac) + ndsta

              if (ndsta.gt.0) then

                icount = 0
                idsta = 0
                idsta2 = 0
                itemp = 0
                do while (idsta.lt.ndsta)
                  idsta = idsta+1
                  itemp = itemp+ntsct2(idsta)
                  do while (idsta2.lt.itemp)
                    idsta2 = idsta2+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.iinc).and.(ic.lt.nc)          &
                               .and.(.not.found))
                      ic = ic+1
                      if (namet(idsta2).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdsta(ireac)+idsta2-1
                        jamdsta(icur) = ic
                      end if
                    end do
                  end do
                  icur2 = iamdsta2(ireac)+idsta-1
                  fmdsta(icur2) = value2(idsta)
                  orddsta(icur2) = ordt(idsta)
                  ntsc(icur2) = ntsct2(idsta)
                end do

!c  if component is missing --> exit

                if (icount.ne.iinc) then
                  if(rank==0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(2a,a12,a)') 'b component ',           &
                               'promoting dissolution of ',name,       &
                               ' is missing'
                    write(ilog,'(72a)') ('-',i=1,72)
                  end if
                  stop
                end if

              end if        !(ndsta.gt.0)

!c----------------------------------------------------------------------------
!c_isotope
!c  isotopic fractionation_master reaction
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for isotopic fractionation master reaction'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'isotopic fractionation_master') then
                  
                  isofrac(im) = .true.
                  isofracm(im) = .true.
                  found = .true.
                  backspace(imdbs)
                  read(imdbs,*,err=999,end=998) keyword, nifr

                  
                  do i = 1,nifr
                    read(imdbs,*,err=999,end=998) iinum(i),           &
                        (namet2(i,ii),ii=1,iinum(i))
                      
                    alphat(i,1) = 1          
                      
                    read(imdbs,*,err=999,end=998)                     &
                        (alphat(i,ii),ii=2,iinum(i))
                 
                  end do
      
                    if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                      write(*,*) keyword
                      do i = 1,nifr
                        do ii = 1, iinum(i)
                          write(*,*)  namet2(i,ii), alphat(i,ii)
                        end do
                      end do
                    end if

                    !calculate the number of associated reactions
                    nprsc = iinum(1) 
                    do i=2,nifr
                        nprsc=nprsc*iinum(i)
                    end do
                    
                    if ((reaction_type(im).eq.'reversible').or.          &  
                        (reaction_type(im).eq.                           &
                        'dissolution_to_equilibrium')) then               
                      read(imdbs,*,err=999,end=998) nprs,                &
                                              (namepair(i),i=1,nprs)
                      !check to see if number of listed reaction is correct
                                                                          
                      if (rank==0.and.b_enable_output.and.info_debug.gt.1) then                           
                        write(*,*)  (namepair(i),i=1,nprs)                
                      end if                                              
                      if ((nprsc-1).ne.nprs) then                         
                         write(ilog,'(72a)') ('-',i=1,72)                 
                         write(ilog,'(2a,a12,a)') 'Number of ',          &
                               'corresponding isotope fractionation ',   &
                               'reactions for', name, 'is wrong'
                         write(ilog,'(72a)') ('-',i=1,72)
#ifdef PETSC
                         call petsc_mpi_finalize
#endif
                         stop
                      end if
                    end if !reversible
                    

!c  exit, if end of input section is reached

                  elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                    searching = .false.
                  end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
                
              if (isofracm(im)) then
                iamdiso(im+1) = iamdiso(im) + nprsc
                iamdiso2(im+1) = iamdiso2(im) + nifr
              else
                iamdiso(im+1) = iamdiso(im)
                iamdiso2(im+1) = iamdiso2(im)
              end if

              if (isofracm(im)) then
                
                icount = 0
                icount2 = 0
                nifrm(im) = nifr
              
                do iiso = 1,nifr
                  do iiso2 = 1,iinum(iiso)
                    ic = 0
                    im1 = 0
                    found = .false.
                    do while ((ic.lt.nc).and.(.not.found)) 
                      ic = ic+1
                      if (namet2(iiso,iiso2).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdiso(im)+icount-1
                        jamdiso(icur) = ic
                        jamdalpha(icur) = alphat(iiso,iiso2)
                      end if
                    end do
              
                      
                  end do !iiso2
                  icount2 = icount2+1
                  icur = iamdiso2(im)+icount2-1
                  jamdiso2(icur) = iinum(iiso)
                end do !iiso

!c  if component is missing --> exit

                if (icount.ne.(nprsc)) then
                  if (rank == 0) then  
                    write(ilog,'(72a)') ('-',i=1,72)
                    write(ilog,'(2a,a12,a)') 'c component ',           &
                               'promoting dissolution of ',name,       &
                               ' is missing'
                    write(ilog,'(72a)') ('-',i=1,72)
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if
                 
!c check that all corresponding isotope minerals are present for reversible (equilibrium controlled) reactions
                 
                if ((reaction_type(im).eq.'reversible').or.            &
                        (reaction_type(im).eq.                         &
                        'dissolution_to_equilibrium')) then
                    icount = 1
                    icur = iamdiso(im)+icount-1
                    jamdpair(icur)=im
                    do i=1,nprs
                        im1 = 0
                        found = .false.
                        do while ((im1.lt.nm).and.(.not.found)) 
                            im1 = im1+1
                            if (namepair(i).eq.namem(im1)) then
                                found = .true.
                                icount = icount+1
                                icur = iamdiso(im)+icount-1
                                jamdpair(icur)=im1
                            end if
                        end do 
                    end do
                    if (icount.ne.nprsc) then
                      if (rank == 0) then
                        write(ilog,'(72a)') ('-',i1=1,72)
                        write(ilog,'(2a,a12,a)') 'Corresponding ',     &
                              'mineral for isotope fractionation of ', &
                              namem(im), ' is missing'
                        write(ilog,'(72a)') ('-',i1=1,72)
                        close(ilog)
                      end if
#ifdef PETSC
                      call petsc_mpi_finalize
#endif
                      stop
                    end if
                end if !reversible

              end if        !(isofracm)

               
!c----------------------------------------------------------------------------
!c_isotope
!c  isotopic fractionation
!c  find current mineral and pathway, if applicable

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
              
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for isotopic fractionation'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'isotopic fractionation') then
                  
                  isofrac(im) = .true.
                  found = .true.
                  backspace(imdbs)
                  read(imdbs,*,err=999,end=998) keyword, namet3
                  
                  im1 = 0
                  found = .false.
                  do while ((im1.lt.nm).and.(.not.found)) 
                      im1 = im1+1
                      
                      if (namet3.eq.namem(im1)) then
                          found = .true.
                          nifrm(im)=nifrm(im1)
                          icount = 0
                          idiff = iamdiso(im1+1) - iamdiso(im1)
                          iamdiso(im+1) = iamdiso(im) + idiff
                          iamdiso2(im+1) = iamdiso2(im) + nifrm(im)
                          istart = iamdiso(im1)
                          istop = iamdiso(im1+1)-1

                          do i1 = istart, istop
                              icount = icount + 1
                              icur = iamdiso(im)+icount-1
                              jamdiso(icur) = jamdiso(i1)
                              jamdalpha(icur) = jamdalpha(i1)

                              if ((reaction_type(im).eq.'reversible')  &
                                  .or.(reaction_type(im).eq.           &
                                  'dissolution_to_equilibrium')) then
                                  jamdpair(icur)=jamdpair(i1)
                              end if
                          end do

                          icount = 0
                          do iiso = 1,nifrm(im1)
                              icount = icount + 1
                              icur = iamdiso2(im)+icount-1
                              icur2 = iamdiso2(im1)+icount-1
                              jamdiso2(icur) = jamdiso2(icur2)
                          end do
                          
                      end if
                  end do
                    
                  !write paprameters to output
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                      istart = iamdiso(im)
                      istop = iamdiso(im+1)-1
                      write(*,*) keyword
                      do i=istart,istop
                          write(*,*) namec(jamdiso(i)), jamdalpha(i)
                      end do
                      if ((reaction_type(im).eq.'reversible')          &
                                  .or.(reaction_type(im).eq.           &
                                  'dissolution_to_equilibrium')) then   
                        write(*,*) (namem(jamdpair(i)),i=istart,istop)  
                      end if                                            
                  end if                                                
                                                                        
                  if (.not.found) then
                    if(rank == 0) then
                      write(ilog,'(72a)') ('-',i1=1,72)                 
                      write(ilog,'(2a,a12,a)') 'Corresponding master', &
                            ' mineral for isotope fractionatio of ',   &
                            namem(im), ' is missing'                   
                      write(ilog,'(72a)') ('-',i1=1,72)  
                      close(ilog)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop                                              
                  end if                                                
                                                                        
                elseif (keyword.eq.'end pathway'.or.                   &
                          string.eq.'!') then
                  searching = .false.
                end if
                if(.not.isofrac(im)) then
                  iamdiso(im+1) = iamdiso(im)
                  iamdiso2(im+1) = iamdiso2(im)
                end if
              end do
              

!c  ---------------------------------------------------------------------
!c  inhibition terms - total concentrations

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for inhibition terms: T^a'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string
                                
                if (keyword.eq.'inhibition T^a') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,nmdi
                  do i = 1,nmdi
                    read (imdbs,'(a1)',err=999,end=998) string
                    backspace(imdbs)
                    if(string .ne. "'") then
                      read(imdbs,*,err=999,end=998) value(i),value2(i),&
                                                    namet(i)
                    else
                      read(imdbs,*,err=999,end=998) namet(i),value(i),&
                                                    value2(i)
                    end if
                  end do                                             
                    if (info_debug.gt.1) then
                    write(*,*) keyword,nmdi
                    do i = 1,nmdi                                    
                        write(*,*) trim(namet(i))," ",value(i), value2(i)
                    end do 
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.                &
                          string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage

                iamdi(ireac+1) = iamdi(ireac) + nmdi

                if (nmdi.gt.0) then

                  icount = 0
                  ic = 0
                  do while ((icount.lt.nmdi).and.(ic.lt.nc))
                    found = .false.
                    imdi = 0
                    ic = ic+1
                    do while ((imdi.lt.nmdi).and.(.not.found))
                      imdi = imdi+1
                      if (namet(imdi).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdi(ireac)+imdi-1
                        jamdi(icur) = ic
                        fmdi(icur) = value(imdi)
                      ordmdi(icur) = value2(imdi)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.nmdi) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
                            'component for dissolution-precipitation ',&
                            'reaction ',namem(im)(:l_namem(im)),       &
                            ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if      !nmdi.gt.0

!c  ---------------------------------------------------------------------
!c  hyperbolic terms - components as species in solution

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if
                
              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for hyperbolic terms: C^c'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'hyperbolic C^c') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,nmhc
                  do i = 1,nmhc
                    read (imdbs,'(a1)',err=999,end=998) string
                    backspace(imdbs)
                    if(string .ne. "'") then
                      read(imdbs,*,err=999,end=998) value(i),value2(i),&
                                                    namet(i)
                    else
                      read(imdbs,*,err=999,end=998) namet(i),value(i),&
                                                    value2(i)
                    end if
                  end do
                  
                  if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                    write(*,*) keyword,nmhc
                    do i = 1,nmhc                                    
                        write(*,*) trim(namet(i))," ",value(i), value2(i)
                    end do
                  end if 

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.                &
                          string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage

                iamhc(ireac+1) = iamhc(ireac) + nmhc

                if (nmhc.gt.0) then

                  icount = 0
                  imhc = 0
                  do while (imhc.lt.nmhc)
                    imhc = imhc+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.nmhc).and.(ic.lt.nc)         &
                               .and.(.not.found))
                      ic = ic+1
                      if (namet(imhc).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamhc(ireac)+imhc-1
                        jamhc(icur) = ic
                        fmhc(icur) = value(imhc)
                        ordmhc(icur) = value2(imhc)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.nmhc) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
                            'component for dissolution-precipitation ',&
                            'reaction ',namem(im)(:l_namem(im)),       &
                            ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                      close(ilog)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if      !nmhc.gt.0

!c  ---------------------------------------------------------------------
!c  inhibition terms - components as species in solution

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for inhibition terms: C^c'
              end if

              found = .false.
              searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'inhibition C^c') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,nmic
                  do i = 1,nmic
                    read (imdbs,'(a1)',err=999,end=998) string
                    backspace(imdbs)
                    if(string .ne. "'") then
                      read(imdbs,*,err=999,end=998) value(i),value2(i),&
                                                    namet(i)
                    else
                      read(imdbs,*,err=999,end=998) namet(i),value(i),&
                                                    value2(i)
                    end if
                  end do                                             
                  if (info_debug.gt.1) then
                    write(*,*) keyword,nmic
                    do i = 1,nmic                                    
                      write(*,*) trim(namet(i))," ",value(i),value2(i)
                    end do 
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.                &
                          string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage

                iamic(ireac+1) = iamic(ireac) + nmic

                if (nmic.gt.0) then

                  icount = 0
                  ic = 0
                  do while ((icount.lt.nmic).and.(ic.lt.nc))
                    found = .false.
                    imic = 0
                    ic = ic+1
                    do while ((imic.lt.nmic).and.(.not.found))
                      imic = imic+1
                      if (namet(imic).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamic(ireac)+imic-1
                        jamic(icur) = ic
                        fmic(icur) = value(imic)
                      ordmic(icur) = value2(imic)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.nmic) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
                            'component for dissolution-precipitation ',&
                            'reaction ',namem(im)(:l_namem(im)),       &
                            ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if      !nmic.gt.0

!c  ---------------------------------------------------------------------
!c  hyperbolic terms - mineral volume fractions

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for hyperbolic terms: phi^m'
              end if

              found = .false.
            searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'hyperbolic phi^m') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,nmdpm
                  do i = 1,nmdpm
                    read (imdbs,'(a1)',err=999,end=998) string
                    backspace(imdbs)
                    if(string .ne. "'") then
                      read(imdbs,*,err=999,end=998) value(i),value2(i),&
                                                    namet(i)
                    else
                      read(imdbs,*,err=999,end=998) namet(i),value(i), &
                                                    value2(i)
                    end if
                  end do 

                  if (info_debug.gt.1) then
                  write(*,*) keyword,nmdpm
                  do i = 1,nmdpm
                    write(*,*) value(i),value2(i),                  &
                                 namet(i)
                  end do 
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.                &
                          string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all minerals involved in reaction are specified
!c  in input file and allocate pointers to minerals and reaction 
!c  orders to permanent storage

                iamdpm(ireac+1) = iamdpm(ireac) + nmdpm

                if (nmdpm.gt.0) then

                  icount = 0
                  imdpm = 0
                  do while (imdpm.lt.nmdpm)
                    imdpm = imdpm+1
                    im2 = 0
                    found = .false.
                    do while ((icount.lt.nmdpm).and.(im2.lt.nm)       &
                               .and.(.not.found))
                      im2 = im2+1
                      if (namet(imdpm).eq.namem(im2)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdpm(ireac)+imdpm-1
                        jamdpm(icur) = im2
                        fmdpm(icur) = value(imdpm)
                        ordmdpm(icur) = value2(imdpm)
                      end if
                    end do
                  end do

!c  if mineral is missing --> exit

                  if (icount.ne.nmdpm) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
                            'mineral for dissolution-precipitation ',  &
                            'reaction ',namem(im)(:l_namem(im)),       &
                            ' is missing'
                      write(ilog,'(a)') 'hyperbolic - minerals'
                      write(ilog,'(72a)') ('-',i=1,72)
                      close(ilog)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if      !nmdpm.gt.0

!c  ---------------------------------------------------------------------
!c  inhibition terms - minerals

              call findname(namem(im),imdbs,found_keyword)
              if (nreac.gt.1) then
                ipath = ireac-iamd(im)+1
                call findpath(ipath,im)
              end if

              if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                write(*,*) 'searching for inhibition terms: phi^m'
              end if

              found = .false.
            searching = .true.
                              
              do while (searching.and..not.found)
                  
                read(imdbs,*,err=999,end=998) keyword
                backspace(imdbs)
                read (imdbs,'(a1)',err=999,end=998) string

                                
                if (keyword.eq.'inhibition phi^m') then
                  
                  found = .true.
                  backspace(imdbs)

                  read(imdbs,*,err=999,end=998) keyword,nmdpi
                  
                  do i = 1,nmdpi
                    read (imdbs,'(a1)',err=999,end=998) string
                    backspace(imdbs)
                    if(string .ne. "'") then
                      read(imdbs,*,err=999,end=998) value(i),          &
                                           value2(i),namet(i)
                    else
                      read(imdbs,*,err=999,end=998) namet(i),          &
                                           value(i),value2(i) 
                    end if
                  end do
                  

                  if (info_debug.gt.1) then
                    write(*,*) keyword,nmdpi
                    do i = 1,nmdpi
                      write(*,*) value(i),value2(i),                &
                                   namet(i)
                    end do                     
                  end if

!c  exit, if end of input section is reached

                elseif (keyword.eq.'end pathway'.or.                &
                          string.eq.'!') then
                  searching = .false.
                end if

              end do

!c  rewind file and return to start of data input for mineral reaction

              call findname(namem(im),imdbs,found_keyword)

!c  check if all minerals involved in reaction are specified
!c  in input file and allocate pointers to minerals and inhibition 
!c  constants to permanent storage

                iamdpi(ireac+1) = iamdpi(ireac) + nmdpi

                if (nmdpi.gt.0) then

                  icount = 0
                  im2 = 0
                  do while ((icount.lt.nmdpi).and.(im2.lt.nm))
                    found = .false.
                    imdpi = 0
                    im2 = im2+1
                    do while ((imdpi.lt.nmdpi).and.(.not.found))
                      imdpi = imdpi+1
                      if (namet(imdpi).eq.namem(im2)) then
                      if (info_debug.gt.1) then
                        write(*,*) trim(namem(im2))
                      end if
                        found = .true.
                        icount = icount+1
                        icur = iamdpi(ireac)+imdpi-1
                        jamdpi(icur) = im2
                        fmdpi(icur) = value(imdpi)
                        ordmdpi(icur) = value2(imdpi)
                      end if
                    end do
                  end do

!c  if mineral is missing --> exit

                  if (icount.ne.nmdpi) then
                    if (rank == 0) then
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
                            'mineral for dissolution-precipitation ',  &
                            'reaction ',namem(im)(:l_namem(im)),       &
                            ' is missing'
                      write(ilog,'(a)') 'inhibition - minerals'
                      write(ilog,'(72a)') ('-',i=1,72)
                      close(ilog)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if      !nmdpi.gt.0

              end do        !number of parallel reactions

!c  rewind mineral database to search for next mineral, doing this
!c  allows the specification of minerals in an arbitray order

              rewind(imdbs)

            end if          !(icount.eq.nv)

!c  go to next mineral, if no match was found

          elseif ((name.ne.namem(im)).and.        &
                  (name.ne.'end')) then

            next_entry = .false.
            do while (.not.next_entry)
              read (imdbs,'(a1)',err=999) string
              if (string.eq.'!' .or. trim(string).eq.'') then
                next_entry = .true.
              end if
            end do

            backspace(imdbs)

!c  exit if end of file is reached and mineral specified was not found

          elseif (name.eq.'end') then
            if (rank == 0) then
              write(ilog,'(72a)') ('-',i=1,72)
              write(ilog,'(4a)') 'mineral ',trim(namem(im)),           &
                             ' not in database ', '- check input file'
              write(ilog,'(72a)') ('-',i=1,72)
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

        end do                 !end - loop over minerals database
      end do                   !end - loop over specified minerals

!cdsu write warning information for sign switch in the value of enthaply change
      if (nm > 0 .and. dhc_reverse) then
        if (rank == 0 .and. b_enable_output) then
          write(ilog,'(72a)') ('-',i=1,72)
          write(ilog,'(2a)') 'warning: nthalpy change for',            &
                             ' mineral is reversed'
          write(ilog,'(72a)') ('-',i=1,72)

          write(igen,'(72a)') ('-',i=1,72)
          write(igen,'(2a)') 'warning: enthalpy change for',           &
                             ' mineral is reversed'
          write(igen,'(72a)') ('-',i=1,72)
        end if
      end if

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(*,'(1x,a)') 'start of database backup: mineral.dbs'
          write(idbs_bk, '(a)') '<------ mineral.dbs: start of minerals ------>'      
          do im = 1,nm
            rewind(imdbs)
            do while(.true.)
              if (readnextline(imdbs,strbuffer,lowercase=.false.,          &
                  original=.true.)) then
                if (index(adjustl(strbuffer),trim(namem(im))) == 2) then            !note, mineral name has quotes
                  write(idbs_bk,'(a)') trim(strbuffer)
                  do while(readnextline(imdbs,strbuffer,lowercase=.false., &
                           withcomment=.true.,original=.true.))
                    if (index(adjustl(strbuffer), '!') == 1 .or.           &
                        trim(adjustl(strbuffer)).eq."'end'") then
                      write(idbs_bk,'(a)') trim(strbuffer)
                      exit
                    else
                      write(idbs_bk,'(a)') trim(strbuffer)
                    end if
                  end do
                  exit
                end if
              end if
            end do
          end do
          rewind(imdbs)
          !write(idbs_bk, '(a)') "'end'"
          write(idbs_bk, '(a/)') '<------ mineral.dbs: end of minerals ------>'
          write(*,'(1x,a)') 'end of database backup: mineral.dbs'
        end if
      end if

      goto 1000

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'reached end of database "mineral.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'reached end of database "mineral.dbs"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(imdbs)
      read(imdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in mineral database (readmin_new.F90): ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in mineral database (readmin_new.F90): ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

!cdbg ---- activate this section for purposes of debugging -----

!c  echo check - thermodynamic data and control variables
 
1000  continue
     
#ifdef DEBUG
      if (info_debug.gt.0) then
        write(idbg,'(a)') 'returning from readmin_new ...'
        do im=1,nm
          write(idbg,'(a72,1x,a12)') namem(im),rate_control(im)
          write(idbg,'(a,a72)') reaction_type(im)
          if (far_from_equil(im)) then
            write(idbg,'(a)') 'reaction far from equilibrium'
          end if
          if (.not.far_from_equil(im)) then
            write(idbg,'(a,1pe15.6e3)') 'eqms  ',-dlog10(eqms(im))
          end if
          write(idbg,'(a,1pe15.6e3)') 'gfwm  ',gfwm(im)
          write(idbg,'(a,1pe15.6e3)') 'densm ',densm(im)
          write(idbg,'(a,1pe15.6e3)') 'dhcm  ',dhcm(im)
          write(idbg,'(a,1pe15.6e3)') 'dgcm  ',dgcm(im)
          write(idbg,'(a,i10)') 'iam    ',iam(im)

!c  echo check for stoichiometric coefficients

          istart = iam(im)
          iend = iam(im+1)-1
          do i = istart, iend
            icur = jam(i)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i,namec(icur),  &
     &                 ' jam ',jam(i),' xnum ',xnum(i)
          end do

!c  echo check rate constant and affinity term

          write(idbg,'(a,i10)') 'iamd   ',iamd(im)
          istart = iamd(im)
          iend = iamd(im+1)-1
          do i = istart, iend
            write(idbg,'(i5,4(a,1pe15.6e3))') i,' ordm ',ordm(i),     &
                  ' ordn ',ordn(i), ' rateds', dlog10(rateds(i)/r86400)
                                                                      
!c  echo check - product terms
                                                                       
            write(idbg,'(7(a,1x,i10,1x))') 'iamdt   ',iamdt(i),       &
     &                                     'iamdc   ',iamdc(i),       &
     &                                     'iamdcx  ',iamdcx(i),      &
     &                                     'iamdm   ',iamdm(i),       &
     &                                     'iamdi   ',iamdi(i),       &
     &                                     'iamhc   ',iamhc(i),       &
     &                                     'iamic   ',iamic(i) 
                                                                      
!c  echo check - fractional order terms - total concentrations
                                                                       
            istart2 = iamdt(i)                                         
            iend2 = iamdt(i+1)-1                                       
            do i2 = istart2,iend2                                      
              icur = jamdt(i2)                                         
              write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namec(icur), &
                    ' jamdt ',jamdt(i2), ' orddt ',orddt(i2)
            end do

!c  echo check - fractional order terms - components as species 
!c  in solution

            istart2 = iamdc(i)
            iend2 = iamdc(i+1)-1
            do i2 = istart2,iend2
              icur = jamdc(i2)
              write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namec(icur), &
                    ' jamdc ',jamdc(i2), ' orddc ',orddc(i2)
            end do
                                                                      
!c  echo check - fractional order terms - aqueous complexes
                                                                       
            istart2 = iamdcx(i)                                        
            iend2 = iamdcx(i+1)-1                                      
            do i2 = istart2,iend2                                      
              icur = jamdcx(i2)                                        
              write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namex(icur), &
                    ' jamdcx ',jamdcx(i2), ' orddcx ',orddcx(i2)
            end do
                                                                      
!c  echo check - hyperbolic terms - T^a
                                                                       
            istart2 = iamdm(i)                                         
            istop2 = iamdm(i+1)-1                                      
            do i2 = istart2,istop2                                     
              icur = jamdm(i2)                                         
              write(idbg,'(i5,2x,a12,a,i5,2(a,1pe15.6e3))')            &
                    i2, namec(icur), ' jamdm ',jamdm(i2),              &
                    ' fmdm ',fmdm(i2), ' ordmdm ',ordmdm(i2)
            end do
                                                                      
!c  echo check - inhibition terms - T^a
                                                                       
           istart2 = iamdi(i)                                          
            istop2 = iamdi(i+1)-1                                      
            do i2 = istart2,istop2                                     
              icur = jamdi(i2)                                         
              write(idbg,'(i5,2x,a12,a,i5,2(a,1pe15.6e3))')            &
                    i2, namec(icur), ' jamdi ',jamdi(i2),              &
                    ' fmdi ',fmdi(i2), ' ordmdi ',ordmdi(i2)
            end do

!c  echo check - hyperbolic terms - C^c

            istart2 = iamhc(i)
            istop2 = iamhc(i+1)-1
            do i2 = istart2,istop2
              icur = jamhc(i2)
              write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')            &
                    i2,namec(icur), ' jamhc ',jamhc(i2),               &
                    ' fmhc ',fmhc(i2), ' ordmhc ',ordmhc(i2)
            end do
                                                                        
!c  echo check - inhibition terms - C^c
                                                                         
            istart2 = iamic(i)                                           
            istop2 = iamic(i+1)-1                                        
            do i2 = istart2,istop2                                       
              icur = jamic(i2)                                           
              write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')            &
                    i2,namec(icur), ' jamic ',jamic(i2),               &
                    ' fmic ',fmic(i2), ' ordmic ',ordmic(i2)
            end do

!c  echo check - hyperbolic terms - phi^m

            istart2 = iamdpm(i)
            istop2 = iamdpm(i+1)-1
            do i2 = istart2,istop2
              icur = jamdpm(i2)
              write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')            &
                    i2,namec(icur), ' jamdpm ',jamdpm(i2),             &
                    ' fmdpm ',fmdpm(i2), ' ordmdpm ',ordmdpm(i2)
            end do
                                                                       
!c  echo check - inhibition terms - phi^m
                                                                        
            istart2 = iamdpi(i)                                         
            istop2 = iamdpi(i+1)-1                                      
            do i2 = istart2,istop2                                      
              icur = jamdpi(i2)                                         
              write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')            &
                    i2,namec(icur), ' jamdpi ',jamdpi(i2),             &
                    ' fmdpi ',fmdpi(i2), ' ordmdpi ',ordmdpi(i2)
            end do

          end do           !parallel reaction pathways

          write(idbg,*) '----------------------------------------------'
        
      end do             !loop over minerals 

      end if               !(info_debug.gt.0)

      if (info_debug.gt.1) then
        !pause
      elseif (info_debug.gt.2) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif 
        stop
      end if
#endif
!cdbg

      return
      end
