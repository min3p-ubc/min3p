!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/guess.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine guess
!c ----------------
!c guess for concentrations of free species
!c
!c written by:      Uli Mayer - October 18, 95
!c
!c last modified:   Uli Mayer - November 19, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           cnew(nc)           = concentrations of free species      * +    
!c                                - new time level [moles/l water]  
!c           cold(nc)           = concentrations of free species      * +    
!c                                - old time level [moles/l water]  
!c           tempkel            = temperature [K]                     + -
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number - logbook               + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           actv(nc)           = activity of free species            - +
!c                                - new time level
!c           totco(n,nthreads)  = total aqueous component             + -
!c                                concentrations
!c                                - old time level [moles/l water]
!c           ph_fixed           = value for fixed pH                  * +
!c           phguess            = guess for pH                        + -
!c
!c           integer*4
!c           ---------
!c           nc                 = number of components including h2o  + -
!c
!c           character:
!c           ----------
!c           ctype(nc-1)        = 'charge' = correct total aqueous    + +
!c                                           component concentration
!c                                           for specified component 
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on 
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c
!c           logical:
!c           --------
!c           specified_ph       = ph-value specified                  * *
!c
!c local:    real*8:
!c           -------
!c           r_100              = constant
!c           r10                = constant
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)               
!c
!c external: phcorr    = calculate fixed free species activities 
!c                       and concentrations which require 
!c                       specified pH
!c ----------------------------------------------------------------------
  
      subroutine guess(cnew,cold,tempkel,ilog,tid)
 
      use parm
      use chem
      use dgml, only : dgm
      use gen, only : rank, b_enable_output

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      real*8 :: cnew, cold, tempkel
      
      integer :: ilog
      
      integer :: tid, ic
      
      real*8, external :: vhoff

      external phcorr

      dimension cnew(*),cold(*)

      real*8, parameter :: r_100 = 1.d-2, r10 = 10.0d0
      
 
      specified_ph = .false.

      do ic=1,nc-1

!c  assign guess for free species concentrations

!c  for component h+ --> take initial guess from input file
 
        if (namec(ic).eq.'h+1') then
          cold(ic) = r10**(-phguess)
          cnew(ic) = cold(ic)
        else

!c  for all other components --> take 1% of initial concentration
 
          cold(ic) = r_100*totco(ic,tid) 
          cnew(ic) = cold(ic)
        end if

!c  assign fixed free species activities and concentrations

        if (ctype(ic).eq.'fixed') then
          actv(ic) = totco(ic,tid)
          cold(ic) = totco(ic,tid)
          cnew(ic) = totco(ic,tid)
        elseif (ctype(ic).eq.'ph'.and.namec(ic).eq.'h+1') then
          ph_fixed = totco(ic,tid)
          specified_ph = .true.
          actv(ic) = r10**(-totco(ic,tid))
          cold(ic) = r10**(-totco(ic,tid))
          cnew(ic) = cold(ic)
          ctype(ic) = 'fixed'
        elseif (ctype(ic).eq.'po2'.and.namec(ic).eq.'o2(aq)') then
          
          if (.not. dgm) then
            !MIN3P standard version
            actv(ic) = vhoff(-2.7945d0,1.2647d-3,tempkel,tempks,rgascal)
            actv(ic) = actv(ic)*totco(ic,tid)
          else
            !From min3p dgm version, but no reference is available, 2015-03-25
            actv(ic) = r10**(-2.8980d0)*totco(ic,tid)
          end if

          cnew(ic) = actv(ic)
          cold(ic) = actv(ic)
          ctype(ic) = 'fixed'          
        elseif (ctype(ic).eq.'pch4'.and.namec(ic).eq.'ch4(aq)') then
          actv(ic) = r10**(-2.8894d0)*totco(ic,tid)
          cnew(ic) = actv(ic)
          cold(ic) = actv(ic)
          ctype(ic) = 'fixed'
        elseif (ctype(ic).eq.'ph2'.and.namec(ic).eq.'h2(aq)') then
          actv(ic) = r10**(-3.10237d0)*totco(ic,tid)
          cnew(ic) = actv(ic)
          cold(ic) = actv(ic)
          ctype(ic) = 'fixed' 
        elseif (ctype(ic).eq.'pco2x'.and.namec(ic).eq.'co2x(aq)') then
          actv(ic) = r10**(-1.4736d0)*totco(ic,tid)  !1.4736
          cnew(ic) = actv(ic)
          cold(ic) = actv(ic)
          ctype(ic) = 'fixed'
        elseif (ctype(ic).eq.'par'.and.namec(ic).eq.'ar(aq)') then
          actv(ic) = r10**(-2.9000d0)*totco(ic,tid)
          cnew(ic) = actv(ic)
          cold(ic) = actv(ic)
          ctype(ic) = 'fixed'
        elseif (ctype(ic).eq.'pn2'.and.namec(ic).eq.'n2(aq)') then
          actv(ic) = r10**(-3.1798d0)*totco(ic,tid)
          cnew(ic) = actv(ic)
          cold(ic) = actv(ic)
          ctype(ic) = 'fixed'
        elseif (ctype(ic).eq.'ph'.and.namec(ic).ne.'h+1') then
          if (rank == 0) then
            write(*,*) 'error in input file'
            write(*,*) 'pH was specified for component different ',    &
                        'than h+'
            write(ilog,*) 'error in input file'
            write(ilog,*) 'pH was specified for component different ', &
                          'than h+'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        elseif (ctype(ic).eq.'po2'.and.namec(ic).ne.'o2(aq)') then
          if (rank == 0) then  
            write(*,*) 'error in input file'
            write(*,*) 'po2 was specified for component different ',   &
                       'than o2(aq)'
            write(ilog,*) 'error in input file'
            write(ilog,*) 'po2 was specified for component different ',&
                      'than o2(aq)'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        elseif (ctype(ic).eq.'pn2'.and.namec(ic).ne.'n2(aq)') then
          if (rank == 0) then  
            write(*,*) 'error in input file'
            write(*,*) 'pn2 was specified for component different ',   &
                       'than n2(aq)'
            write(ilog,*) 'error in input file'
            write(ilog,*) 'pn2 was specified for component different ',&
                          'than n2(aq)'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
          
        elseif (ctype(ic).eq.'pch4'.and.namec(ic).ne.'ch4(aq)') then
          if (rank == 0) then  
            write(ilog,*) 'error in input file'
            write(ilog,*) 'pch4 was specified for component different',&
                          ' than ch4(aq)' 
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        elseif (ctype(ic).eq.'ph2'.and.namec(ic).ne.'h2(aq)') then
          if (rank == 0) then  
            write(ilog,*) 'error in input file'
            write(ilog,*) 'ph2 was specified for component different',&
                          ' than h2(aq)' 
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
                                                                         
        elseif (ctype(ic).eq.'pco2x'.and.namec(ic).ne.'co2x(aq)') then  
          if (rank == 0) then  
            write(ilog,*) 'error in input file'                            
            write(ilog,*) 'pco2x was specified for component  ',       &
                          'different than co2(aq)' 
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
                                                                         
        elseif (ctype(ic).eq.'par'.and.namec(ic).ne.'ar(aq)') then
          if (rank == 0) then   
            write(ilog,*) 'error in input file'                            
            write(ilog,*) 'pn2 was specified for component different ',&
                          'than ar(aq)'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if

      end do

!c  calculate fixed free species activities and concentrations
!c  which require specified pH

      call phcorr(cnew,cold,tempkel,ilog,tid) 

      return
      end
