!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 873 $
!> $Author: dsu $
!> $Date: 2023-12-12 11:14:04 -0800 (Tue, 12 Dec 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/noble_gas/nobleGasIngrowth.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c module nobleGasIngrowth
!c -----------------
!c
!c noble gas ingrowth related variables and functions.
!c
!c written by:      Danyang Su - Sept 30, 2023
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    integer:
!c           --------
!c           ilog               = unit number, logbook file           + -
!c
!c chem.f:   real*8:
!c           -------
!c
!c external: checkerr  = check for error during memory allocation
!c ----------------------------------------------------------------------

    module nobleGasIngrowth

      use chem
      use gen
	  
	    implicit none
	  
!cdsu---------------------------------------------------------------
!cdsu      Noble gas ingrowth related variables
!cdsu---------------------------------------------------------------
      logical :: b_use_ngi                                   !flag to apply noble gas ingrowth module
      logical :: b_combine_238u_235u                         !flag to indicate if 238u+235u are combined from 238u and 235u

      integer :: ingdbs                                      !unit number of noble gas ingrowth related database

!c  noble gas ingrowth related variables

      integer :: ngre_i                                      !number of radioelements specified in the input file
      integer :: nge_i                                       !number of elements specified in the input file
      integer :: ngnce_i                                     !number of neutron capture elements specified in the input file

      integer :: ngi                                         !number of noble gas ingrowth specified in the input file
      integer :: ngre                                        !number of noble gas radioelements specified in the database
      integer :: ngtre                                       !number of noble gas total radioelements specified in the database, including those from
                                                             !first order decay, spontaneous fission and nucleogenic generation
      integer :: nge                                         !number of noble gas elements specified in the database
      integer :: ngnce                                       !number of noble gas neutron capture elements specified in the database
      integer :: ngnpre                                      !number of noble gas neutron production radioelements specified in the database

      integer :: index_uiso(3)                               !index of radioelement uranium isotope: 235u, 238u and 238u+235u

      integer, allocatable :: idx_ngre_i2d(:)                !index of radioelement list from input file to database
      integer, allocatable :: idx_ngnpre_i2d(:)              !index of neutron production radioelement list from input file to database
      integer, allocatable :: idx_nge_i2d(:)                 !index of element list from input file to database
      integer, allocatable :: idx_ngnce_i2d(:)               !index of neutron capture element list from input file to database

      integer, allocatable :: idx_ngre_d2i(:)                !index of radioelement list from database to input file
      integer, allocatable :: idx_ngnpre_d2i(:)              !index of neutron capture radioelement list from database to input file
      integer, allocatable :: idx_nge_d2i(:)                 !index of element list from database to input file
      integer, allocatable :: idx_ngnce_d2i(:)               !index of neutron capture element list from database to input file
      
      character*72, allocatable :: name_ngre_i(:)            !name of radioelements from input file
      character*72, allocatable :: name_nge_i(:)             !name of elements from input file
      character*72, allocatable :: name_ngnce_i(:)           !name of neutron capture elements from input file    

      character*72, allocatable :: name_ngi(:)               !name of noble gas ingrowth
      character*72, allocatable :: name_nge(:)               !name of elements in database
      character*72, allocatable :: name_ngnce(:)             !name of neutron capture elements in database
      
      logical, allocatable :: conc_ngre_const(:)             !flag to use constant radioelement concentration
      real*8, allocatable :: conc_ngre(:,:)                  !concentration of radioelements, input in units of mg RE kg-1 solid or ppm
      real*8, allocatable :: conc_ngre_loc(:)                !concentration of radioelements for transient output, input in units of mg RE kg-1 solid or ppm
      
      real*8, allocatable :: wtfrac_nge(:,:)                 !weight fraction of elements, input in units of kg E kg-1 solid or weight fraction
      real*8, allocatable :: ncp_ngnce(:,:)                  !neutron capture probability, unitless
      real*8, allocatable :: density_rock_ngi(:)             !zone dependent, density of rock. Is it better to move to physical parameter group?
      real*8, allocatable :: conc_ngre_ini(:,:)              !initial concentration of radioelements, input in units of mg RE kg-1 solid or ppm

      logical, allocatable :: conc_ngre_const_lzn(:)         !flag to use constant radioelement concentration
      real*8, allocatable :: conc_ngre_lzn(:,:)              !zone dependent, concentration of radioelements, input in units of mg RE kg-1 solid or ppm
      real*8, allocatable :: wtfrac_nge_lzn(:,:)             !zone dependent, weight fraction of elements, input in units of kg E kg-1 solid or weight fraction
      real*8, allocatable :: ncp_ngnce_lzn(:,:)              !zone dependent, neutron capture probability, unitless
      real*8, allocatable :: density_rock_ngi_lzn(:)         !zone dependent, density of rock. Is it better to move to physical parameter group?

      real*8, allocatable :: totRateNeutron(:)               !rate of neutron production at current timestep, unit [mol dm^-3 solid s^-1] 
      real*8, allocatable :: totRateNobleGas(:,:)            !rate of noble gas ingrowth at current timestep, unit [mol dm^-3 solid s^-1]

      real*8 :: frac_neutron_th                              !fraction of neutrons reaching thermal energy level

!c  mass balance related
      real*8, allocatable :: ngidiff(:)                      !global source-sink to aqueous component concentrationsterm due to noble gas introwth
      real*8, allocatable :: totngidiff(:)                   !total source-sink to aqueous component concentrationsterm due to noble gas introwth

!c  data type of radioelement
      type :: typeOfRadioelement
        character(72) :: name                                !name of radioelement
        real*8 :: lamda_sf                                   !spontaneous fission
        real*8 :: lamda_alpha                                !first order decay, unit s^-1
        real*8 :: molar_mass                                 !molar mass
      end type typeOfRadioelement

!c  data type of neutron production radioelement
      type :: typeOfNeutronProduct
        character(72) :: name                                !name of radioelement
        logical :: is_sf                                     !flag to indicate if spontaneous fission is applicable
        real*8 :: yield_sf                                   !spontaneous fission yield factor for neutron production
        integer :: num_path                                  !number of pathways, assuming this value is no larger than 10
        real*8 :: yield_alpha(10)                            !first order decay empirical yield factor for neutron production
        character(72) :: yield_element(10)                   !element of first order decay empirical yield factor for neutron production
        integer :: idx_e2nge(10)                             !index of element use for neutron production 
      end type typeOfNeutronProduct

!c  data type of noble gas ingrowth
      type :: typeOfIngrowth
        character(72) :: namec                               !name of corresponding component
        integer :: idx_namec                                 !index of corresponding component in components list

        integer :: num                                       !number of rate expressions
        character(72), allocatable :: typeRateExpression(:)  !type of rate expression 'neutron capture', 'spontaneous fission'
                                                             !'first order decay', 'nucleogenic'
        character(72), allocatable :: name_nu_nce(:)         !name of neutron capture elements, maximum size(num)
        character(72), allocatable :: name_nu_re(:)          !name of radiolements, maximum size(num)
        integer, allocatable :: idx_e2ngnce(:)               !index of neutron capture elements in name_ngnce
        integer, allocatable :: idx_re2ngre(:)               !index of radioelements in list noble_gas_re
        real*8, allocatable :: yield_factor(:)               !yield factor for the specified rate expression, maximum size(num)
        
        integer :: num_nu_e                                  !number of nucleogenic elements contributing to ingrowth (assuming maximum one nucleogenic for each noble gas ingrowth)
        character(72), allocatable :: name_nu_e(:)           !name of elements, size(num_nu_e)
        real*8, allocatable :: a_nu_e(:)                     !empirical constant a_nu, size(num_nu_e)
        integer, allocatable :: idx_e2nge(:)                 !index of element used in nucleogenic

        character(72), allocatable :: name_nu_pre(:,:)       !name of radioelements contributing to neutron production, maximum size(2,num_nu_e)
        real*8, allocatable :: b_nu_pre(:,:)                 !empirical constant b_nu, maximum size(2,num_nu_e)
        integer, allocatable :: idx_pre2npre(:,:)            !index of radioelement used in nucleogenic

      end type typeOfIngrowth

!c  noble gas ingrowth related data
      type(typeOfRadioelement), allocatable :: noble_gas_re(:)
      type(typeOfRadioelement), allocatable :: noble_gas_re_i(:)
      type(typeOfNeutronProduct), allocatable :: noble_gas_npre(:)
      type(typeOfIngrowth), allocatable :: noble_gas_ingrowth(:)

	    contains  

    !>
	  !> allocate memory for noble gas ingrowth related variables
	  !>
      subroutine mem_ngi
      
      implicit none
      
      integer :: ierr
 
      external checkerr

!c  main variables - noble gas ingrowth     

      if (ngi > 0) then
        allocate (name_ngi(ngi), stat = ierr)
        name_ngi = '' 
        call checkerr(ierr,'name_ngi',ilog)
        call memory_monitor(sizeof(name_ngi),'name_ngi',.true.)

        allocate (noble_gas_ingrowth(ngi), stat = ierr)
        call checkerr(ierr,'noble_gas_ingrowth',ilog)
        call memory_monitor(sizeof(noble_gas_ingrowth),'noble_gas_ingrowth',.true.)
      end if

      return
	  
      end subroutine mem_ngi

    !>
	  !> allocate memory for noble gas ingrowth related variables, elements, radio elements
	  !>
      subroutine mem_ngi_inirt
      
      implicit none
      
      integer :: ierr
 
      external checkerr

!c  main variables - noble gas ingrowth   

      if (ngre_i > 0) then
        allocate (conc_ngre(ngre_i,nngl), stat = ierr)
        conc_ngre = 0.0d0
        call checkerr(ierr,'conc_ngre',ilog)
        call memory_monitor(sizeof(conc_ngre),'conc_ngre',.true.)

        allocate (conc_ngre_lzn(ngre_i,nthreads), stat = ierr)
        conc_ngre_lzn = 0.0d0 
        call checkerr(ierr,'conc_ngre_lzn',ilog)
        call memory_monitor(sizeof(conc_ngre_lzn),'conc_ngre_lzn',.true.) 

        allocate (conc_ngre_ini(ngre_i,nngl), stat = ierr)
        conc_ngre_ini = 0.0d0
        call checkerr(ierr,'conc_ngre_ini',ilog)
        call memory_monitor(sizeof(conc_ngre_ini),'conc_ngre_ini',.true.)

        allocate (conc_ngre_const(nngl), stat = ierr)
        conc_ngre_const = .false.
        call checkerr(ierr,'conc_ngre_const',ilog)
        call memory_monitor(sizeof(conc_ngre_const),'conc_ngre_const',.true.)

        allocate (conc_ngre_const_lzn(nthreads), stat = ierr)
        conc_ngre_const_lzn = .false.
        call checkerr(ierr,'conc_ngre_const_lzn',ilog)
        call memory_monitor(sizeof(conc_ngre_const_lzn),'conc_ngre_const_lzn',.true.)
      end if

      if (nge_i > 0) then
        allocate (wtfrac_nge(nge_i,nngl), stat = ierr)
        wtfrac_nge = 0.0d0 
        call checkerr(ierr,'wtfrac_nge',ilog)
        call memory_monitor(sizeof(wtfrac_nge),'wtfrac_nge',.true.)

        allocate (wtfrac_nge_lzn(nge_i,nthreads), stat = ierr)
        wtfrac_nge_lzn = 0.0d0 
        call checkerr(ierr,'wtfrac_nge_lzn',ilog)
        call memory_monitor(sizeof(wtfrac_nge_lzn),'wtfrac_nge_lzn',.true.)
      end if

      if (ngnce_i > 0) then
        allocate (ncp_ngnce(ngnce_i,nngl), stat = ierr)
        ncp_ngnce = 0.0d0 
        call checkerr(ierr,'ncp_ngnce',ilog)
        call memory_monitor(sizeof(ncp_ngnce),'ncp_ngnce',.true.)

        allocate (ncp_ngnce_lzn(ngnce_i,nthreads), stat = ierr)
        ncp_ngnce_lzn = 0.0d0 
        call checkerr(ierr,'ncp_ngnce_lzn',ilog)
        call memory_monitor(sizeof(ncp_ngnce_lzn),'ncp_ngnce_lzn',.true.)
      end if

      allocate (totRateNeutron(nngl), stat = ierr)
      totRateNeutron = 0.0d0
      call checkerr(ierr,'totRateNeutron',ilog)
      call memory_monitor(sizeof(totRateNeutron),'totRateNeutron',.true.)

      allocate (totRateNobleGas(ngi,nngl), stat = ierr)
      totRateNobleGas = 0.0d0
      call checkerr(ierr,'totRateNobleGas',ilog)
      call memory_monitor(sizeof(totRateNobleGas),'totRateNobleGas',.true.)

      !c density of rock, is it better to move this to physical parameters section?
      allocate (density_rock_ngi_lzn(nthreads), stat = ierr)
      density_rock_ngi_lzn = 2.65d0
      call checkerr(ierr,'density_rock_ngi_lzn',ilog)
      call memory_monitor(sizeof(density_rock_ngi_lzn),'density_rock_ngi_lzn',.true.)

      allocate (density_rock_ngi(nngl), stat = ierr)
      density_rock_ngi = 2.65d0
      call checkerr(ierr,'density_rock_ngi',ilog)
      call memory_monitor(sizeof(density_rock_ngi),'density_rock_ngi',.true.)

      return
	  
      end subroutine mem_ngi_inirt

!>
!> allocate memory for noble gas ingrowth related variables
!>
      subroutine mem_ngi_pre  
      
      implicit none
      
      integer :: i, ierr

      real*8, parameter :: r0 = 0.0d0
 
      external checkerr

!c  main variables - noble gas ingrowth

        ngre = 0
        ngnpre = 0        
        nge = 0
        ngnce = 0

!c  list of noble gas ingrowth related element
        allocate (name_nge(100), stat = ierr)
        name_nge = '' 
        call checkerr(ierr,'name_nge',ilog)
        call memory_monitor(sizeof(name_nge),'name_nge',.true.)

!c  list of neutron capture elements
        allocate (name_ngnce(100), stat = ierr)
        name_ngnce = '' 
        call checkerr(ierr,'name_ngnce',ilog)
        call memory_monitor(sizeof(name_ngnce),'name_ngnce',.true.)

!c  list of radioelements
        allocate (noble_gas_re(100), stat = ierr)
        do i = 1, 100
          noble_gas_re(i)%name = '' 
          noble_gas_re(i)%lamda_sf = r0 
          noble_gas_re(i)%lamda_alpha = r0
          noble_gas_re(i)%molar_mass = r0
        end do
        call checkerr(ierr,'noble_gas_re',ilog)
        call memory_monitor(sizeof(noble_gas_re),'noble_gas_re',.true.)

!c  list of neutron production radioelements
        allocate (noble_gas_npre(100), stat = ierr)
        do i = 1, 100
          noble_gas_npre(i)%name = '' 
          noble_gas_npre(i)%is_sf = .false. 
          noble_gas_npre(i)%yield_sf = r0
          noble_gas_npre(i)%num_path = 0
          noble_gas_npre(i)%yield_alpha(:) = r0
          noble_gas_npre(i)%yield_element(:) = ''
          noble_gas_npre(i)%idx_e2nge(:) = 0
        end do
        call checkerr(ierr,'noble_gas_npre',ilog)
        call memory_monitor(sizeof(noble_gas_npre),'noble_gas_npre',.true.)

      end subroutine mem_ngi_pre

!>
!> allocate memory for noble gas ingrowth related variables
!>
      subroutine mem_ngi_final
      
      implicit none

      character*72, allocatable :: name_temp(:)
      
      integer :: n, ierr

      type(typeOfRadioelement), allocatable :: re_temp(:)
      type(typeOfNeutronProduct), allocatable :: npre_temp(:)

       external checkerr

!c  main variables - noble gas ingrowth
        allocate (name_temp(100), stat = ierr)
        name_temp = '' 
        call checkerr(ierr,'name_temp',ilog)
        call memory_monitor(sizeof(name_temp),'name_temp',.true.)

!c  resize name_nge
        name_temp(1:nge) = name_nge(1:nge)

        deallocate (name_nge, stat = ierr)
        call memory_monitor(-sizeof(name_nge),'name_nge',.true.)
        allocate (name_nge(nge), stat = ierr)        
        call checkerr(ierr,'name_nge',ilog)
        call memory_monitor(sizeof(name_nge),'name_nge',.true.)

        name_nge(1:nge) = name_temp(1:nge)

!c  resize name_ngnce
        name_temp(1:ngnce) = name_ngnce(1:ngnce)

        deallocate (name_ngnce, stat = ierr)
        call memory_monitor(-sizeof(name_ngnce),'name_ngnce',.true.)
        allocate (name_ngnce(ngnce), stat = ierr)        
        call checkerr(ierr,'name_ngnce',ilog)
        call memory_monitor(sizeof(name_ngnce),'name_ngnce',.true.)

        name_ngnce(1:ngnce) = name_temp(1:ngnce)

!c  release memory space
        deallocate (name_temp, stat = ierr)
        call memory_monitor(-sizeof(name_temp),'name_temp',.true.)      

!c  list of radioelements
        allocate (re_temp(100), stat = ierr)
        call checkerr(ierr,'re_temp',ilog)
        call memory_monitor(sizeof(re_temp),'re_temp',.true.)

        re_temp = noble_gas_re
        deallocate (noble_gas_re, stat = ierr)
        call memory_monitor(-sizeof(noble_gas_re),'noble_gas_re',.true.)
        allocate (noble_gas_re(ngre), stat = ierr)        
        call checkerr(ierr,'noble_gas_re',ilog)
        call memory_monitor(sizeof(noble_gas_re),'noble_gas_re',.true.)

        noble_gas_re(1:ngre) = re_temp(1:ngre)   
        deallocate (re_temp, stat = ierr)
        call memory_monitor(-sizeof(re_temp),'re_temp',.true.)             
        
!c  list of neutron production radioelements
        allocate (npre_temp(100), stat = ierr)
        call checkerr(ierr,'npre_temp',ilog)
        call memory_monitor(sizeof(npre_temp),'npre_temp',.true.)

        npre_temp = noble_gas_npre
        deallocate (noble_gas_npre, stat = ierr)
        call memory_monitor(-sizeof(noble_gas_npre),'noble_gas_npre',.true.)
        allocate (noble_gas_npre(ngnpre), stat = ierr)        
        call checkerr(ierr,'noble_gas_npre',ilog)
        call memory_monitor(sizeof(noble_gas_npre),'noble_gas_npre',.true.)

        noble_gas_npre(1:ngnpre) = npre_temp(1:ngnpre)   
        deallocate (npre_temp, stat = ierr)
        call memory_monitor(-sizeof(npre_temp),'npre_temp',.true.)

      end subroutine mem_ngi_final

!>
!> allocate memory for index array of noble gas ingrowth related variables
!>
      subroutine mem_ngi_idx

        implicit none

        integer :: ierr
 
        external checkerr

!c  noble gas ingrowth related variables, index of name list from database to input file

        allocate (idx_ngre_d2i(ngre), stat = ierr)
        idx_ngre_d2i = 0 
        call checkerr(ierr,'idx_ngre_d2i',ilog)
        call memory_monitor(sizeof(idx_ngre_d2i),'idx_ngre_d2i',.true.)

        allocate (idx_nge_d2i(nge), stat = ierr)
        idx_nge_d2i = 0 
        call checkerr(ierr,'idx_nge_d2i',ilog)
        call memory_monitor(sizeof(idx_nge_d2i),'idx_nge_d2i',.true.)

        allocate (idx_ngnce_d2i(ngnce), stat = ierr)
        idx_ngnce_d2i = 0 
        call checkerr(ierr,'idx_ngnce_d2i',ilog)
        call memory_monitor(sizeof(idx_ngnce_d2i),'idx_ngnce_d2i',.true.)

        allocate (idx_ngnpre_d2i(ngnpre), stat = ierr)
        idx_ngnpre_d2i = 0 
        call checkerr(ierr,'idx_ngnpre_d2i',ilog)
        call memory_monitor(sizeof(idx_ngnpre_d2i),'idx_ngnpre_d2i',.true.)

!c  noble gas ingrowth related variables, index of name list from input file to database
        allocate (idx_ngre_i2d(ngre_i), stat = ierr)
        idx_ngre_i2d = 0 
        call checkerr(ierr,'idx_ngre_i2d',ilog)
        call memory_monitor(sizeof(idx_ngre_i2d),'idx_ngre_i2d',.true.)

        allocate (idx_nge_i2d(nge_i), stat = ierr)
        idx_nge_i2d = 0 
        call checkerr(ierr,'idx_nge_i2d',ilog)
        call memory_monitor(sizeof(idx_nge_i2d),'idx_nge_i2d',.true.)

        allocate (idx_ngnce_i2d(ngnce_i), stat = ierr)
        idx_ngnce_i2d = 0 
        call checkerr(ierr,'idx_ngnce_i2d',ilog)
        call memory_monitor(sizeof(idx_ngnce_i2d),'idx_ngnce_i2d',.true.)

        allocate (idx_ngnpre_i2d(ngre_i), stat = ierr)
        idx_ngnpre_i2d = 0 
        call checkerr(ierr,'idx_ngnpre_i2d',ilog)
        call memory_monitor(sizeof(idx_ngnpre_i2d),'idx_ngnpre_i2d',.true.) 

        allocate (name_ngre_i(ngre_i), stat = ierr)
        name_ngre_i = '' 
        call checkerr(ierr,'name_ngre_i',ilog)
        call memory_monitor(sizeof(name_ngre_i),'name_ngre_i',.true.)

        allocate (name_nge_i(nge_i), stat = ierr)
        name_nge_i = '' 
        call checkerr(ierr,'name_nge_i',ilog)
        call memory_monitor(sizeof(name_nge_i),'name_nge_i',.true.)

        allocate (name_ngnce_i(ngnce_i), stat = ierr)
        name_ngnce_i = '' 
        call checkerr(ierr,'name_ngnce_i',ilog)
        call memory_monitor(sizeof(name_ngnce_i),'name_ngnce_i',.true.)

      end subroutine mem_ngi_idx

      !>
      !> read noble gas ingrowth database
      !>
      subroutine readnoblegases

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
!c  local variables
      integer :: i, i2, istart, iend, inge, ingre, ingnpre, ingi,       &
                 iloc, value_i, num, num2, nsize, ierr
      logical :: done, find_zone, find_element, found_subsection

      character*72 :: keyword, keyword_start, keyword_end, value_str,  &
                      subsection
      character*72 :: name_ncnpre(3)
      character*72, allocatable :: tempString(:)
      character*256 :: strbuffer
      real*8 :: value_r

      external readzone_end_with_dbsbk

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(*,'(1x,a)') 'start of database backup: noblegases.dbs'
          write(idbs_bk, '(a)') '<------ noblegases.dbs: start of noble gas ingrowth ------>'      
        end if
      end if

!c  read noble gas ingrowth section

      allocate (tempString(100), stat = ierr)
      tempString = '' 
      call checkerr(ierr,'tempString',ilog)
      call memory_monitor(sizeof(tempString),'tempString',.true.)

      if (ngi > 0) then
        keyword_start = 'noble gas ingrowth'
        keyword_end = 'end of noble gas ingrowth'

        call readzone_end_with_dbsbk(ingdbs,icnv,idbs_bk,ilog,         &
                      keyword_start,keyword_end,find_zone)
       
        if (find_zone) then

!c  prepare memory space
          call mem_ngi_pre

          do ingi = 1, ngi

            rewind(icnv)
            done = .false.
            do while(.not.done)
              read(icnv,'(a)',end=998,err=999) strbuffer
              strbuffer = adjustl(strbuffer)
             
              if (index(strbuffer,trim(name_ngi(ingi))).eq.2) then

                iloc = index(name_ngi(ingi),' ')
                if (iloc < 1) then
                  if (rank == 0) then
                    write(*,*) 'Error: name of noble gas ingrowth "'//  &
                          trim(name_ngi(ingi))//'" is not correct'
                    write(ilog,*) 'Error: name of noble gas ingrowth "'//&
                          trim(name_ngi(ingi))//'" is not correct'
                  end if
                  goto 999
                else
                  noble_gas_ingrowth(ingi)%namec = name_ngi(ingi)(:iloc-1)//'(aq)'
                end if

                iloc = findloc_str_first(namec,noble_gas_ingrowth(ingi)%namec)
                if (iloc < 1) then
                  if (rank == 0) then
                    write(*,*) 'Error: corresponding component '//     &
                          trim(noble_gas_ingrowth(ingi)%namec)//       &
                          ' is not found in components list'
                    write(ilog,*) 'Error: corresponding component '//  &
                          trim(noble_gas_ingrowth(ingi)%namec)//       &
                          ' is not found in components list'
                  end if
                  goto 999
                else
                  noble_gas_ingrowth(ingi)%idx_namec = iloc
                end if

                read(icnv,*,end=998,err=999) num

                noble_gas_ingrowth(ingi)%num = num

                allocate (noble_gas_ingrowth(ingi)%typeRateExpression(num), stat = ierr)
                call checkerr(ierr,'noble_gas_ingrowth(ingi)%typeRateExpression',ilog)
                noble_gas_ingrowth(ingi)%typeRateExpression = ''
                call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%typeRateExpression),&
                                    'noble_gas_ingrowth(ingi)%typeRateExpression',.true.)

                allocate (noble_gas_ingrowth(ingi)%yield_factor(num), stat = ierr)
                call checkerr(ierr,'noble_gas_ingrowth(ingi)%yield_factor',ilog)
                noble_gas_ingrowth(ingi)%yield_factor = 1.0d0
                call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%yield_factor),&
                                    'noble_gas_ingrowth(ingi)%yield_factor',.true.)

                allocate (noble_gas_ingrowth(ingi)%name_nu_nce(num), stat = ierr)
                call checkerr(ierr,'noble_gas_ingrowth(ingi)%name_nu_nce',ilog)
                noble_gas_ingrowth(ingi)%name_nu_nce = ''
                call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%name_nu_nce),&
                                    'noble_gas_ingrowth(ingi)%name_nu_nce',.true.)

                allocate (noble_gas_ingrowth(ingi)%name_nu_re(num), stat = ierr)
                call checkerr(ierr,'noble_gas_ingrowth(ingi)%name_nu_re',ilog)
                noble_gas_ingrowth(ingi)%name_nu_re = ''
                call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%name_nu_re),&
                                    'noble_gas_ingrowth(ingi)%name_nu_re',.true.)

                allocate (noble_gas_ingrowth(ingi)%idx_e2ngnce(num), stat = ierr)
                call checkerr(ierr,'noble_gas_ingrowth(ingi)%idx_e2ngnce',ilog)
                noble_gas_ingrowth(ingi)%idx_e2ngnce = 0
                call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%idx_e2ngnce),&
                                    'noble_gas_ingrowth(ingi)%idx_e2ngnce',.true.)

                allocate (noble_gas_ingrowth(ingi)%idx_re2ngre(num), stat = ierr)
                call checkerr(ierr,'noble_gas_ingrowth(ingi)%idx_re2ngre',ilog)
                noble_gas_ingrowth(ingi)%idx_re2ngre = 0
                call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%idx_re2ngre),&
                                    'noble_gas_ingrowth(ingi)%idx_re2ngre',.true.)

                do i = 1, num
                  read(icnv,'(a)',end=998,err=999) strbuffer
                  if (index(strbuffer,'neutron capture').eq.2 .or. &
                      index(strbuffer,'first order decay').eq.2 .or. &
                      index(strbuffer,'spontaneous fission').eq.2 .or. &
                      index(strbuffer,'nucleogenic').eq.2) then
                    read(strbuffer,*,end=998,err=999) noble_gas_ingrowth(ingi)%typeRateExpression(i)

                    if (index(strbuffer,'neutron capture').eq.2) then
                      read(icnv,*,end=998,err=999) noble_gas_ingrowth(ingi)%name_nu_nce(i)
                    else if (index(strbuffer,'first order decay').eq.2 .or. &
                             index(strbuffer,'spontaneous fission').eq.2) then 
                      read(icnv,*,end=998,err=999) noble_gas_ingrowth(ingi)%name_nu_re(i)
                    end if

                    read(icnv,'(a)',end=998,err=999) strbuffer

                    if (index(strbuffer,'yield factor').eq.2 .or. &
                        index(strbuffer,'empirical yield factor').eq.2) then
                      read(strbuffer,*) keyword, noble_gas_ingrowth(ingi)%yield_factor(i)
                    end if
                    
                    if (trim(noble_gas_ingrowth(ingi)%typeRateExpression(i)).eq.'nucleogenic') then
                      read(icnv,'(a)',end=998,err=999) strbuffer
                      if (index(strbuffer,'elements').eq.2) then
                        read(strbuffer,*,end=998,err=999) keyword,num2
                        noble_gas_ingrowth(ingi)%num_nu_e = num2
                        
                        allocate (noble_gas_ingrowth(ingi)%name_nu_e(num2), stat = ierr)
                        call checkerr(ierr,'noble_gas_ingrowth(ingi)%name_nu_e',ilog)
                        noble_gas_ingrowth(ingi)%name_nu_e = ''
                        call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%name_nu_e),&
                                            'noble_gas_ingrowth(ingi)%name_nu_e',.true.)

                        allocate (noble_gas_ingrowth(ingi)%a_nu_e(num2), stat = ierr)
                        call checkerr(ierr,'noble_gas_ingrowth(ingi)%a_nu_e',ilog)
                        noble_gas_ingrowth(ingi)%a_nu_e = 0.0d0
                        call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%a_nu_e),&
                                            'noble_gas_ingrowth(ingi)%a_nu_e',.true.)

                        allocate (noble_gas_ingrowth(ingi)%idx_e2nge(num2), stat = ierr)
                        call checkerr(ierr,'noble_gas_ingrowth(ingi)%idx_e2nge',ilog)
                        noble_gas_ingrowth(ingi)%idx_e2nge = 0
                        call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%idx_e2nge),&
                                            'noble_gas_ingrowth(ingi)%idx_e2nge',.true.)

                        allocate (noble_gas_ingrowth(ingi)%name_nu_pre(2,num2), stat = ierr)
                        call checkerr(ierr,'noble_gas_ingrowth(ingi)%name_nu_pre',ilog)
                        noble_gas_ingrowth(ingi)%name_nu_pre = ''
                        call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%name_nu_pre),&
                                            'noble_gas_ingrowth(ingi)%name_nu_pre',.true.)

                        allocate (noble_gas_ingrowth(ingi)%b_nu_pre(2,num2), stat = ierr)
                        call checkerr(ierr,'noble_gas_ingrowth(ingi)%b_nu_pre',ilog)
                        noble_gas_ingrowth(ingi)%b_nu_pre = 0.0d0
                        call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%b_nu_pre),&
                                            'noble_gas_ingrowth(ingi)%b_nu_pre',.true.)

                        allocate (noble_gas_ingrowth(ingi)%idx_pre2npre(2,num2), stat = ierr)
                        call checkerr(ierr,'noble_gas_ingrowth(ingi)%idx_pre2npre',ilog)
                        noble_gas_ingrowth(ingi)%idx_pre2npre = 0
                        call memory_monitor(sizeof(noble_gas_ingrowth(ingi)%idx_pre2npre),&
                                            'noble_gas_ingrowth(ingi)%idx_pre2npre',.true.)

                        do i2 = 1, num2
                          read(icnv,*,end=998,err=999) noble_gas_ingrowth(ingi)%name_nu_e(i2),  &
                                                       noble_gas_ingrowth(ingi)%a_nu_e(i2)
                        end do

                        do i2 = 1, num2
                          read(icnv,'(a)',end=998,err=999) strbuffer
                          read(strbuffer,*,end=998,err=999) keyword, value_str
                          if (trim(keyword).eq.'radioelement' .and. trim(value_str).eq.  &
                              trim(noble_gas_ingrowth(ingi)%name_nu_e(i2))) then
                            read(icnv,*,end=998,err=999) noble_gas_ingrowth(ingi)%name_nu_pre(1,i2), &
                                                         noble_gas_ingrowth(ingi)%b_nu_pre(1,i2)
                            read(icnv,*,end=998,err=999) noble_gas_ingrowth(ingi)%name_nu_pre(2,i2), &
                                                         noble_gas_ingrowth(ingi)%b_nu_pre(2,i2)
                          else
                            if (rank == 0) then
                              write(*,*) 'Error in line: '//trim(strbuffer)
                              write(ilog,*) 'Error in line: '//trim(strbuffer)
                            end if
                            goto 999
                          end if
                        end do

                      end if
                    end if
                  else
                    done = .true.
                    exit
                  end if
                end do

                done = .true.
              end if

            end do
            
            !c add required elements, radioelements, neutron capture elements and neutron production elements to the system
            do i = 1, noble_gas_ingrowth(ingi)%num
              if (trim(noble_gas_ingrowth(ingi)%typeRateExpression(i)).eq.'neutron capture') then
                !c add neutron capture elements
                iloc = findloc_str_first(name_ngnce(1:max(1,ngnce)),noble_gas_ingrowth(ingi)%name_nu_nce(i))
                if (iloc < 1) then
                  ngnce = ngnce + 1
                  name_ngnce(ngnce) = noble_gas_ingrowth(ingi)%name_nu_nce(i)
                  noble_gas_ingrowth(ingi)%idx_e2ngnce(i) = ngnce
                else
                  noble_gas_ingrowth(ingi)%idx_e2ngnce(i) = iloc
                end if

              else if (trim(noble_gas_ingrowth(ingi)%typeRateExpression(i)).eq.'first order decay' .or. &
                       trim(noble_gas_ingrowth(ingi)%typeRateExpression(i)).eq.'spontaneous fission') then
                !c add neutron radioelements
                nsize = max(1,ngre)
                tempString(1:nsize) = noble_gas_re(1:nsize)%name
                iloc = findloc_str_first(tempString(1:nsize),noble_gas_ingrowth(ingi)%name_nu_re(i))

                if (iloc < 1) then
                  ngre = ngre + 1
                  noble_gas_re(ngre)%name = noble_gas_ingrowth(ingi)%name_nu_re(i)
                  noble_gas_ingrowth(ingi)%idx_re2ngre(i) = ngre
                else
                  noble_gas_ingrowth(ingi)%idx_re2ngre(i) = iloc
                end if                
              else if (trim(noble_gas_ingrowth(ingi)%typeRateExpression(i)).eq.'nucleogenic') then
                !c add elements, radioelements and neutron production elements
                do i2 = 1, noble_gas_ingrowth(ingi)%num_nu_e
                  iloc = findloc_str_first(name_nge(1:max(1,nge)),noble_gas_ingrowth(ingi)%name_nu_e(i2))
                  if (iloc < 1) then
                    nge = nge + 1
                    name_nge(nge) = noble_gas_ingrowth(ingi)%name_nu_e(i2)
                    noble_gas_ingrowth(ingi)%idx_e2nge(i2) = nge
                  else
                    noble_gas_ingrowth(ingi)%idx_e2nge(i2) = iloc
                  end if
                end do

                do i2 = 1, noble_gas_ingrowth(ingi)%num_nu_e
                  nsize = max(1,ngnpre)
                  tempString(1:nsize) = noble_gas_npre(1:nsize)%name
                  iloc = findloc_str_first(tempString(1:nsize),noble_gas_ingrowth(ingi)%name_nu_pre(1,i2))
                  if (iloc < 1) then
                    ngnpre = ngnpre + 1
                    noble_gas_npre(ngnpre)%name = noble_gas_ingrowth(ingi)%name_nu_pre(1,i2)
                    noble_gas_ingrowth(ingi)%idx_pre2npre(1,i2) = ngnpre
                  else
                    noble_gas_ingrowth(ingi)%idx_pre2npre(1,i2) = iloc
                  end if

                  nsize = max(1,ngnpre)
                  tempString(1:nsize) = noble_gas_npre(1:nsize)%name
                  iloc = findloc_str_first(tempString(1:nsize),noble_gas_ingrowth(ingi)%name_nu_pre(2,i2))
                  if (iloc < 1) then
                    ngnpre = ngnpre + 1
                    noble_gas_npre(ngnpre)%name = noble_gas_ingrowth(ingi)%name_nu_pre(2,i2)
                    noble_gas_ingrowth(ingi)%idx_pre2npre(2,i2) = ngnpre
                  else
                    noble_gas_ingrowth(ingi)%idx_pre2npre(2,i2) = iloc
                  end if
                end do

              end if
            end do

            !!c check results
            !write(*,*) 'number of rate expressions: ',noble_gas_ingrowth(ingi)%num
            !do i = 1, noble_gas_ingrowth(ingi)%num
            !  write(*,*) 'type of rate expression: ',trim(noble_gas_ingrowth(ingi)%typeRateExpression(i))
            !  write(*,*) 'yield factor: ',noble_gas_ingrowth(ingi)%yield_factor(i)
            !
            !  if (trim(noble_gas_ingrowth(ingi)%typeRateExpression(i)).eq.'nucleogenic') then
            !    write(*,*) 'elements: ',noble_gas_ingrowth(ingi)%num_nu_e
            !    do i2 = 1, noble_gas_ingrowth(ingi)%num_nu_e
            !      write(*,*) trim(noble_gas_ingrowth(ingi)%name_nu_e(i2)),' ',&
            !                noble_gas_ingrowth(ingi)%a_nu_e(i2)
            !    end do
            !    do i2 = 1, noble_gas_ingrowth(ingi)%num_nu_e
            !      write(*,*) 'radioelement ',trim(noble_gas_ingrowth(ingi)%name_nu_e(i2))
            !      write(*,*) trim(noble_gas_ingrowth(ingi)%name_nu_pre(1,i2)),' ',&
            !                 noble_gas_ingrowth(ingi)%b_nu_pre(1,i2)
            !      write(*,*) trim(noble_gas_ingrowth(ingi)%name_nu_pre(2,i2)),' ',&
            !                 noble_gas_ingrowth(ingi)%b_nu_pre(2,i2)
            !    end do
            !  end if
            !end do

          end do

          !c Add all required neutron capture radioelement, 
          !c including 238u, 238u+235u and 232th for noble gas neutron production radioelement,
          !c and 238u, 235u and 232th for noble gas radioelement.
          !c Please note this part is hardwired in the code. Alternatively, this part can be 
          !c moved into input file and user is required to specify these elements.
          if (ngnce > 0) then
            name_ncnpre(1) = '238u'
            name_ncnpre(2) = '238u+235u'
            name_ncnpre(3) = '232th'
            do i = 1, size(name_ncnpre)
              nsize = max(1,ngnpre)
              tempString(1:nsize) = noble_gas_npre(1:nsize)%name              
              iloc = findloc_str_first(tempString(1:nsize),name_ncnpre(i))
              if (iloc < 1) then
                ngnpre = ngnpre + 1
                noble_gas_npre(ngnpre)%name = name_ncnpre(i)
              end if
            end do

            name_ncnpre(1) = '238u'
            name_ncnpre(2) = '235u'
            name_ncnpre(3) = '232th'
            do i = 1, size(name_ncnpre)
              nsize = max(1,ngre)
              tempString(1:nsize) = noble_gas_re(1:nsize)%name             
              iloc = findloc_str_first(tempString(1:nsize),name_ncnpre(i))
              if (iloc < 1) then
                ngre = ngre + 1
                noble_gas_re(ngre)%name = name_ncnpre(i)
              end if
            end do
          end if

          if (rank == 0 .and. b_enable_output) then
            write(*,*) 'end of reading noble gas ingrowth'
          end if

        else
          if (rank == 0) then
            write(*,*) 'Error: radioelements section is missing in the noble gas database'
            write(ilog,*) 'Error: radioelements section is missing in the noble gas database'
          end if
          goto 997
        end if

      end if 

   
!c  read radioelements section
      if (ngre > 0) then
        keyword_start = 'radioelements'
        keyword_end = 'end of radioelements'

        if (rank == 0 .and. b_enable_output) then
          write(*,*) 'start of reading radioelements'
        end if

        call readzone_end_with_dbsbk(ingdbs,icnv,idbs_bk,ilog,         &
                      keyword_start,keyword_end,find_zone)
        
        if (find_zone) then

          do ingre = 1, ngre 

            rewind(icnv)           
            done = .false.
            do while(.not.done)
              read(icnv,'(a)',end=998,err=999) strbuffer
              strbuffer = adjustl(strbuffer)
              
              if (index(strbuffer,trim(noble_gas_re(ingre)%name)).eq.2) then
                do while(.not.done)
                  read(icnv,'(a)',end=998,err=999) strbuffer
                  if(index(strbuffer,'spontaneous fission').eq.2) then
                    read(strbuffer,*,end=998,err=999) keyword,noble_gas_re(ingre)%lamda_sf
                  else if(index(strbuffer,'first order decay').eq.2) then
                    read(strbuffer,*,end=998,err=999) keyword,noble_gas_re(ingre)%lamda_alpha
                  else if(index(strbuffer,'molar mass').eq.2) then
                    read(strbuffer,*,end=998,err=999) keyword,noble_gas_re(ingre)%molar_mass
                  else
                    done = .true.
                    exit
                  end if
                end do
              end if
            end do

          end do
        else
          if (rank == 0) then
            write(*,*) 'Error: radioelements section is missing in the noble gas database'
            write(ilog,*) 'Error: radioelements section is missing in the noble gas database'
          end if
          goto 997
        end if

        if (rank == 0 .and. b_enable_output) then
          write(*,*) 'end of reading radioelements'
        end if

      end if

!c  read neutron production section
      if (ngnpre > 0) then
        keyword_start = 'neutron production'
        keyword_end = 'end of neutron production'

        if (rank == 0 .and. b_enable_output) then
          write(*,*) 'start of reading neutron production elements'
        end if

        call readzone_end_with_dbsbk(ingdbs,icnv,idbs_bk,ilog,         &
                      keyword_start,keyword_end,find_zone)
        
        if (find_zone) then

          subsection = 'fraction of neutrons reaching thermal energy level'
          call findstrg(subsection,icnv,found_subsection)
          if (found_subsection) then
            read(icnv,*,end=998,err=999) frac_neutron_th
          else
            frac_neutron_th = 1.0d0
          end if

          do ingnpre = 1, ngnpre

            rewind(icnv)           
            done = .false.
            do while(.not.done)
              read(icnv,'(a)',end=998,err=999) strbuffer
              strbuffer = adjustl(strbuffer)
              
              if (index(strbuffer,trim(noble_gas_npre(ingnpre)%name)).eq.2) then
                do while(.not.done)
                  read(icnv,'(a)',end=998,err=999) strbuffer
                  if(index(strbuffer,'spontaneous fission').eq.2) then
                    noble_gas_npre(ingnpre)%is_sf = .true.
                    read(icnv,*,end=998,err=999) keyword,value_r
                    if (trim(keyword).eq.'yield factor') then
                      noble_gas_npre(ingnpre)%yield_sf = value_r
                    end if
                  else if(index(strbuffer,'first order decay').eq.2) then
                    read(icnv,*,end=998,err=999) value_i
                    noble_gas_npre(ingnpre)%num_path = value_i
                    do i = 1, value_i
                      read(icnv,*,end=998,err=999) noble_gas_npre(ingnpre)%yield_element(i),&
                                                   keyword,noble_gas_npre(ingnpre)%yield_alpha(i)

                      iloc = findloc_str_first(name_nge(1:max(1,nge)),noble_gas_npre(ingnpre)%yield_element(i))
                      if (iloc < 1) then
                        nge = nge + 1
                        name_nge(nge) = noble_gas_npre(ingnpre)%yield_element(i)
                        noble_gas_npre(ingnpre)%idx_e2nge(i) = nge
                      else
                        noble_gas_npre(ingnpre)%idx_e2nge(i) = iloc
                      end if
                    end do
                  else
                    done = .true.
                    exit
                  end if
                end do
              end if

            end do

          end do
        else
          if (rank == 0) then
            write(*,*) 'Error: radioelements section is missing in the noble gas database'
            write(ilog,*) 'Error: radioelements section is missing in the noble gas database'
          end if
          goto 997
        end if

        if (rank == 0 .and. b_enable_output) then
          write(*,*) 'end of reading neutron production elements'
        end if

      end if

      !c  release memory space
      deallocate (tempString, stat = ierr)
      call memory_monitor(-sizeof(tempString),'tempString',.true.)

      call mem_ngi_final

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(idbs_bk, '(a/)') '<------ noblegases.dbs: end of noble gas ingrowth ------>'
          write(*,'(1x,a)') 'end of database backup: noblegases.dbs'
        end if
      end if

      return

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'A required keyword is not found in "noblegases.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'A required keyword is not found in "noblegases.dbs"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'reached end of database "noblegases.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'reached end of database "noblegases.dbs"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(imdbs)
      read(imdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in noble gas database (readnoblegases.F90): ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in noble gas database (readnoblegases.F90): ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end subroutine readnoblegases

!>
!> read parameters for all radioelements specified in the input file
!> this part is required to calculate radioelements concentration that are not used in noble gas ingrowth
!>
      subroutine readnoblegases_re_i

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
!c  local variables
      integer :: ingre, ierr
      logical :: done, find_zone

      character*72 :: keyword, keyword_start, keyword_end
      character*256 :: strbuffer
      
      real*8, parameter :: r0 = 0.0d0

      external readzone_end_with_dbsbk

   
!c  read radioelements section
      if (ngre_i > 0) then
        keyword_start = 'radioelements'
        keyword_end = 'end of radioelements'

        call readzone_end_with_dbsbk(ingdbs,icnv,0,ilog,               &
                      keyword_start,keyword_end,find_zone)
        
        if (find_zone) then

          allocate (noble_gas_re_i(ngre_i), stat = ierr)
          do ingre = 1, ngre_i 
            noble_gas_re_i(ingre)%name = name_ngre_i(ingre) 
            noble_gas_re_i(ingre)%lamda_sf = r0 
            noble_gas_re_i(ingre)%lamda_alpha = r0
            noble_gas_re_i(ingre)%molar_mass = r0
          end do
          call checkerr(ierr,'noble_gas_re_i',ilog)
          call memory_monitor(sizeof(noble_gas_re_i),'noble_gas_re_i',.true.)

          do ingre = 1, ngre_i 

            if (b_combine_238u_235u .and. trim(name_ngre_i(ingre)).eq.'238u+235u') then
              cycle
            end if

            rewind(icnv)           
            done = .false.
            do while(.not.done)
              read(icnv,'(a)',end=998,err=999) strbuffer
              strbuffer = adjustl(strbuffer)
              
              if (index(strbuffer,trim(noble_gas_re_i(ingre)%name)).eq.2) then
                do while(.not.done)
                  read(icnv,'(a)',end=998,err=999) strbuffer
                  if(index(strbuffer,'spontaneous fission').eq.2) then
                    read(strbuffer,*,end=998,err=999) keyword,noble_gas_re_i(ingre)%lamda_sf
                  else if(index(strbuffer,'first order decay').eq.2) then
                    read(strbuffer,*,end=998,err=999) keyword,noble_gas_re_i(ingre)%lamda_alpha
                  else if(index(strbuffer,'molar mass').eq.2) then
                    read(strbuffer,*,end=998,err=999) keyword,noble_gas_re_i(ingre)%molar_mass
                  else
                    done = .true.
                    exit
                  end if
                end do
              end if
            end do

          end do
        else
          if (rank == 0) then
            write(*,*) 'Error: radioelements section is missing in the noble gas database'
            write(ilog,*) 'Error: radioelements section is missing in the noble gas database'
          end if
          goto 997
        end if

      end if

      return

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'A required keyword is not found in "noblegases.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'A required keyword is not found in "noblegases.dbs"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'reached end of database "noblegases.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'reached end of database "noblegases.dbs"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(imdbs)
      read(imdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in noble gas database (readnoblegases.F90): ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in noble gas database (readnoblegases.F90): ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end subroutine readnoblegases_re_i

!>
!>  check if all the required elements, radioelements and neutron capture elements 
!>  are specified in the input file
!>
      subroutine check_ngi_variables

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

        implicit none

        integer :: ingre, inge, ingnce, ingnpre, ingre_i, inge_i, ignce_i, &
                   i, iloc, nlist

        logical :: flag_error

        character*72 :: name_list(100)

        character(256) :: strbuffer

        flag_error = .false.

!c  output noble gas ingrowth related section to gen file
        if (b_enable_output .and. rank == 0) then
          write(igen,'(/72a)')('-',i=1,72)
          write(igen,'(a)') 'required noble gas ingrowth section in input file'
          write(igen,'(72a/)')('-',i=1,72)
        end if  

!c  check noble gas ingrowth related variable: error information of radioelements
        name_list = ''
        nlist = 0

        do ingre = 1, ngre

          iloc = findloc_str_first(name_list,noble_gas_re(ingre)%name)
          if (iloc < 1) then
            nlist = nlist + 1
            name_list(nlist) = noble_gas_re(ingre)%name
          end if

          if (idx_ngre_d2i(ingre) < 1) then
            flag_error = .true.
            if (rank == 0) then
              strbuffer = "Error: element "//trim(noble_gas_re(ingre)%name)//&
                          " is not specified in 'noble gas ingrowth - radioelements'"
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do

!c  check noble gas ingrowth related variable: error information of neutron production related radioelements 
        do ingnpre = 1, ngnpre

          iloc = findloc_str_first(name_list,noble_gas_npre(ingnpre)%name)
          if (iloc < 1) then
            nlist = nlist + 1
            name_list(nlist) = noble_gas_npre(ingnpre)%name
          end if

          if (idx_ngnpre_d2i(ingnpre) < 1) then
            flag_error = .true.
            if (rank == 0) then
              strbuffer = "Error: element "//trim(noble_gas_npre(ingnpre)%name)//&
                          " is not specified in 'noble gas ingrowth - radioelements'"
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do

!c  output 'noble gas ingrowth - radioelements' section to gen file
        if (b_enable_output .and. rank == 0) then
          write(igen,'(/a)') "'noble gas ingrowth - radioelements'"
          write(igen,'(a)') "!note: '238u+235u' is not required when '238u' and '235u' are specified"
          write(igen,'(i0)') nlist
          do iloc = 1, nlist
            write(igen,'(a)') "'"//trim(name_list(iloc))//"'"
          end do
        end if

!c  check noble gas ingrowth related variable: error information of elements
        name_list(1:nlist) = ''
        nlist = nge
        name_list(1:nlist) = name_nge(1:nge)

        do inge = 1, nge
          if (idx_nge_d2i(inge) < 1) then
            flag_error = .true.
            if (rank == 0) then
              strbuffer = "Error: element "//trim(name_nge(inge))//&
                          " is not specified in 'noble gas ingrowth - elements'"
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do

!c  output 'noble gas ingrowth - elements' section to gen file
        if (b_enable_output .and. rank == 0) then
          write(igen,'(/a)') "'noble gas ingrowth - elements'"
          write(igen,'(i0)') nlist
          do iloc = 1, nlist
            write(igen,'(a)') "'"//trim(name_list(iloc))//"'"
          end do
        end if
      
!c  check noble gas ingrowth related variable: error information of neutron capture elements 
        name_list(1:nlist) = ''
        nlist = ngnce
        name_list(1:nlist) = name_ngnce(1:ngnce)

        do ingnce = 1, ngnce
          if (idx_ngnce_d2i(ingnce) < 1) then
            flag_error = .true.
            if (rank == 0) then
              strbuffer = "Error: element "//trim(name_ngnce(ingnce))//&
                          " is not specified in 'noble gas ingrowth - neutron capture elements'"
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do

!c  output 'noble gas ingrowth - elements' section to gen file
        if (b_enable_output .and. rank == 0) then
          write(igen,'(/a)') "'noble gas ingrowth - neutron capture elements'"
          write(igen,'(i0)') nlist
          do iloc = 1, nlist
            write(igen,'(a)') "'"//trim(name_list(iloc))//"'"
          end do
        end if


!c  check noble gas ingrowth related variable: warning information of radioelements 
        do ingre_i = 1, ngre_i        
          if (idx_ngre_i2d(ingre_i) < 1 .and. idx_ngnpre_i2d(ingre_i) < 1) then
            if (rank == 0) then
              strbuffer = 'Warning: element '//trim(name_ngre_i(ingre_i))//&
                          ' is not used in noble gas ingrowth'
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do

!c  check noble gas ingrowth related variable: warning information of elements
        do inge_i = 1, nge_i
          if (idx_nge_i2d(inge_i) < 1) then
            if (rank == 0) then
              strbuffer = 'Warning: element '//trim(name_nge_i(inge_i))//&
                          ' is not used in noble gas ingrowth'
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do
       
!c  check noble gas ingrowth related variable: warning information of neutron capture elements    
        do ignce_i = 1, ngnce_i
          if (idx_ngnce_i2d(ignce_i) < 1) then
            if (rank == 0) then
              strbuffer = 'Warning: element '//trim(name_ngnce_i(ignce_i))//&
                          ' is not used in noble gas ingrowth'
              write(*,*) trim(strbuffer)
              write(ilog,*) trim(strbuffer)
            end if
          end if
        end do


        if (.not.flag_error) then
          return
        end if

999     continue
        if (rank == 0) then
          write(*,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'SIMULATION TERMINATED'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
        
      end subroutine check_ngi_variables



!> ********************************************************************
!>               Noble gas ingrowth related rate function
!> ********************************************************************

!>
!>  calculate the rate of neutron production due to spontaneous fission of i^th radioelement 
!>  unit: rock [mol dm^-3 solid s^-1]
!>
      function rate_neutron_product_sf(ith,ivol) result(rate)

        implicit none

        integer, intent(in) :: ith                         !index of i^th radioelement from input file
        integer, intent(in) :: ivol                        !index of control volume
        real*8 :: rate

        integer :: ingnpre                                 !index of neutron production radioelement in the database
        integer :: ingre                                   !index of radioelement in the database
        real*8 :: yield_sf, lamda_sf, RE_s, rho, molar_mass
        real*8, parameter :: r0 = 0.0d0

        ingnpre = idx_ngnpre_i2d(ith)
        ingre = idx_ngre_i2d(ith)

        rate = r0

        if (ingnpre < 1 .or. ingre < 1) then
          return
        end if

        RE_s = conc_ngre(ith,ivol)
        rho = density_rock_ngi(ivol)

        yield_sf = noble_gas_npre(ingnpre)%yield_sf
        lamda_sf = noble_gas_re(ingre)%lamda_sf
        molar_mass = noble_gas_re(ingre)%molar_mass

        rate = 1.0d-3*yield_sf*lamda_sf*RE_s*rho/molar_mass

      end function rate_neutron_product_sf

!>
!>  calculate the rate of neutron production due to -n reaction of i^th radioelement 
!>  return unit: rock [mol dm^-3 solid s^-1]
!>
      function rate_neutron_product_alpha(ith,ivol) result(rate)

        implicit none

        integer, intent(in) :: ith                         !index of i^th radioelement from input file
        integer, intent(in) :: ivol                        !index of control volume
        real*8 :: rate

        !c local variables
        integer :: ingnpre                                 !index of neutron production radioelement in the database
        integer :: ingre                                   !index of radioelement in the database
        integer :: i, idx_i

        real*8 :: yield_alpha, E_s, RE_s, rho
        real*8, parameter :: r0 = 0.0d0

        ingnpre = idx_ngnpre_i2d(ith)

        rate = r0

        if (ingnpre < 1) then
          return
        end if

        RE_s = conc_ngre(ith,ivol)
        rho = density_rock_ngi(ivol)

        do i = 1, noble_gas_npre(ingnpre)%num_path
          yield_alpha = noble_gas_npre(ingnpre)%yield_alpha(i)
          idx_i = idx_nge_d2i(noble_gas_npre(ingnpre)%idx_e2nge(i))
          E_s = wtfrac_nge(idx_i,ivol)
          rate = rate + yield_alpha*E_s
        end do

        rate = rate*RE_s*rho

      end function rate_neutron_product_alpha

!>
!>  calculate neutron production rate due to spontaneous fission and alpha-n reactions 
!>  unit: rock [mol dm^-3 solid s^-1]
!>
      function rate_neutron_product(ivol) result(rate)

        implicit none

        integer, intent(in) :: ivol
        real*8 :: rate

        !c local variables
        integer :: ith
        real*8, parameter :: r0 = 0.0d0

        rate = r0

        do ith = 1, ngre_i
          rate = rate + rate_neutron_product_sf(ith,ivol) +            &
                        rate_neutron_product_alpha(ith,ivol)
        end do

      end function rate_neutron_product

!>
!>  calculate/update rate of neutron production
!>
      subroutine update_rate_neutron_product()

        implicit none

        integer :: ivol

        do ivol = 1, nngl
          totRateNeutron(ivol) = rate_neutron_product(ivol)
        end do

      end subroutine update_rate_neutron_product

!>  *******************************************************************
!>       rate of noble gas ingrowth for different reaction types
!>  *******************************************************************

!>
!>  calculate rate of ith noble gas ingrowth for control volume ivol
!>  unit: rock [mol dm^-3 solid day^-1]
!>
      function rate_noble_gas(ith, ivol) result(totRate)

        implicit none

        integer, intent(in) :: ith, ivol
        real*8 :: totRate

        !c local variables
        integer :: i, idx, idx_i, ipath, j
        character(72) :: typeRate
        real*8 :: rate, sum_b_re
        real*8, parameter :: r0 = 0.0d0, r86400 = 86400.0

        totRate = r0

        do ipath = 1, noble_gas_ingrowth(ith)%num
          typeRate = noble_gas_ingrowth(ith)%typeRateExpression(ipath)
          if (typeRate .eq. 'neutron capture') then
            idx = noble_gas_ingrowth(ith)%idx_e2ngnce(ipath)
            idx_i = idx_ngnce_d2i(idx)
            rate = noble_gas_ingrowth(ith)%yield_factor(ipath)*        &
                   totRateNeutron(ivol)*ncp_ngnce(idx_i,ivol)*        &
                   frac_neutron_th

          else if (typeRate .eq. 'spontaneous fission') then
            idx = noble_gas_ingrowth(ith)%idx_re2ngre(ipath)
            idx_i = idx_ngre_d2i(idx) 
            rate = 1.0d-3*noble_gas_ingrowth(ith)%yield_factor(ipath)* &
                   noble_gas_re(idx)%lamda_sf*conc_ngre(idx_i,ivol)*   &
                   density_rock_ngi(ivol)/noble_gas_re(idx)%molar_mass

          else if (typeRate .eq. 'first order decay') then
            idx = noble_gas_ingrowth(ith)%idx_re2ngre(ipath)
            idx_i = idx_ngre_d2i(idx) 
            rate = 1.0d-3*noble_gas_ingrowth(ith)%yield_factor(ipath)* &
                   noble_gas_re(idx)%lamda_alpha*conc_ngre(idx_i,ivol)*&
                   density_rock_ngi(ivol)/noble_gas_re(idx)%molar_mass

          else if (typeRate .eq. 'nucleogenic') then
            rate = r0
            do i = 1, noble_gas_ingrowth(ith)%num_nu_e
              sum_b_re = r0
              do j = 1, 2
                idx = noble_gas_ingrowth(ith)%idx_pre2npre(j,i)
                idx_i = idx_ngnpre_d2i(idx)

                sum_b_re = sum_b_re + conc_ngre(idx_i,ivol)*           &
                           noble_gas_ingrowth(ith)%b_nu_pre(j,i)

              end do
              idx = noble_gas_ingrowth(ith)%idx_e2nge(i)
              idx_i = idx_nge_d2i(idx)
              rate = rate + noble_gas_ingrowth(ith)%a_nu_e(i)*         &
                     wtfrac_nge(idx_i,ivol)*sum_b_re
            end do
            rate = rate*noble_gas_ingrowth(ith)%yield_factor(ipath)*   &
                   density_rock_ngi(ivol)
          end if
          totRate = totRate + rate
        end do

        totRate = totRate * r86400

      end function rate_noble_gas

!>
!>  calculate/update rate of noble gas ingrowth
!>  unit: rock [mol dm^-3 solid day^-1]
!>
      subroutine update_rate_noble_gas()

#ifdef OPENMP
        use omp_lib 
#endif
        implicit none

        integer :: ingi, ivol

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_global)                         &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol,ingi)
    !$omp do schedule(static)
#endif
        do ivol = 1, nngl
          do ingi = 1, ngi
            totRateNobleGas(ingi,ivol) = rate_noble_gas(ingi,ivol)
          end do
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      end subroutine update_rate_noble_gas

!>
!>  update concentration of noble gas ingrowth related variables,
!>  specifically the concentration of radioelement
!>  note: only the radioelements that has been used in noble gas ingrowth are updated here
!>
      subroutine update_ngi_conc()

#ifdef OPENMP
        use omp_lib 
#endif
        implicit none

        integer :: i, ire, ingre, ivol
        real*8 :: enat = 2.71828182845904509d0, r86400 = 86400.0

        real*8 :: enat_kt(ngre)

        do ingre = 1, ngre
          enat_kt(ingre) = enat**(-noble_gas_re(ingre)%lamda_alpha*    &
                                 r86400*(time-time_start))
        end do

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_global)                         &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ire,ingre,ivol)
    !$omp do schedule(static)
#endif
        do ivol = 1, nngl
          if (.not.conc_ngre_const(ivol)) then
            do ingre = 1, ngre
              ire = idx_ngre_d2i(ingre)
              conc_ngre(ire,ivol) = conc_ngre_ini(ire,ivol)*enat_kt(ingre)
            end do

            if (b_combine_238u_235u) then
              conc_ngre(index_uiso(3),ivol) = conc_ngre(index_uiso(1),ivol) +  &
                                              conc_ngre(index_uiso(2),ivol)
            end if
          end if
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      end subroutine update_ngi_conc

!>
!>  update concentration of noble gas ingrowth related variables,
!>  specifically the concentration of radioelement
!>  note: the concentration of all the radioelements are updated
!>
      subroutine update_ngi_conc_all()

#ifdef OPENMP
        use omp_lib 
#endif
        implicit none

        integer :: i, ire, ingre, ivol
        real*8 :: enat = 2.71828182845904509d0, r86400 = 86400.0

        real*8 :: enat_kt(ngre_i)

        do ingre = 1, ngre_i
          if (b_combine_238u_235u .and. ingre .eq. index_uiso(3)) then
            cycle
          end if

          enat_kt(ingre) = enat**(-noble_gas_re_i(ingre)%lamda_alpha*  &
                                 r86400*(time-time_start))
        end do

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_global)                         &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ire,ingre,ivol)
    !$omp do schedule(static)
#endif
        do ivol = 1, nngl
          if (.not.conc_ngre_const(ivol)) then
            do ingre = 1, ngre_i
              if (b_combine_238u_235u .and. ingre .eq. index_uiso(3)) then
                cycle
              end if
              conc_ngre(ingre,ivol) = conc_ngre_ini(ingre,ivol)*enat_kt(ingre)
            end do

            if (b_combine_238u_235u) then
              conc_ngre(index_uiso(3),ivol) = conc_ngre(index_uiso(1),ivol) +  &
                                              conc_ngre(index_uiso(2),ivol)
            end if
          end if
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      end subroutine update_ngi_conc_all


!>
!>  find the first location of specified string in a string array
!>  
      function findloc_str_first(strarray, str) result(idx)

        implicit none

        character(len=*), intent(in) :: strarray(:)
        character(len=*), intent(in) :: str
        integer :: idx

        !c local variables
        integer :: i

        idx = 0

        do i = 1, size(strarray)
          if (trim(strarray(i)) .eq. trim(str)) then
            idx = i
            return
          end if
        end do

      end function findloc_str_first
	  
	end module nobleGasIngrowth
