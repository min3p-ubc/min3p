!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 609 $
!> $Author: dsu $
!> $Date: 2018-09-14 11:47:55 -0700 (Fri, 14 Sep 2018) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/dratemin.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine dratemin
!c -------------------
!c
!c compute derivative of absolute dissolution-precipitation rate 
!c of mineral
!c
!c sign convention: dissolution -
!c                  precipitation +
!c
!c written by:      Uli Mayer - December 21, 96
!c
!c last modified:   Uli Mayer - July 25, 97
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream              = reactivity term                     + -
!c           c(nc)              = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx)             = concentrations of secondary         + -
!c                                aqueous species
!c           gammac(nc)         = activity coefficients of free       + -
!c                                species
!c           gammax(nx)         = activity coefficient of             + -
!c                                secondary aqueous species
!c           drtinc             = increment for numerical             + -
!c                                differentiation
!c           phim               = volume fraction of mineral          + -
!c           phimold            = volume fraction of mineral          + -
!c                                - old time level
!c           ratem              = derivative of absolute dissolution- * +
!c                                precipitation rate of mineral
!c                                [moles/(l bulk*day)
!c           totc(n)            = total aqueous component             + -
!c                                concentrations - new time level
!c                                [moles/(l bulk)]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cinc(nc,nthreads)  = incremented free species            + -
!c                                concentrations
!c                                [moles/l h2o]
!c           cxinc(nx,nthreads) = secondary aqueous species           + -
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l h2o]
!c           diffm(ndr*nm,nthreads)
!c                              = free diffusion coefficient of       + -
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           fmdi(nrc*nm)       = inhibition factors                  + -
!c           fmdm(nrc*nm)       = monod factors                       + -
!c           orddc(nrc*nm)      = order of free species in            + -
!c                                dissolution reaction
!c           orddcx(nrc*nm)     = order of secondary aqueous          + -
!c                                species in dissolution reaction
!c           orddt(nrc*nm)      = order of total aqueous component    + -
!c                                concentration in dissolution
!c                                reaction
!c           ordm(ndr*nm)       = exponent m for reaction rate law    + -
!c           ordmdm(nrc*nm)     = order of monod terms for            + -
!c                                dissolution-precipitation reactions
!c           ordn(ndr*nm)       = exponent n for reaction rate law    + -
!c           rated(ndr*nm,nthreads)
!c                              = rate constants for dissolution      + -
!c                                reactions
!c           satm(nm,nthreads)  = saturation indices                  * +
!c           totcinc(n,nthreads)= total aqueous component             + -
!c                                concentrations - new time level, 
!c                                incremented [moles/l water]
!c           xnud(ndr*nm)       = stoichiometric coefficients of      + -
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution        + -
!c                                reactions
!c           iamdc(ndr*nm+1)    = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants      + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamdc(nrc*nm)      = pointer array to free species       + -
!c                                involved in dissolution reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous  + -
!c                                species involved in dissolution
!c                                reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms)
!c           jamdm(nrc*nm)      = column pointer array to reactants   + -
!c                                in dissolution-precipitation
!c                                reactions (monod terms)
!c           jamdt(nrc*nm)      = pointer array to total aqueous      + -
!c                                component concentrations involved
!c                                in dissolution reactions
!c           nm                 = number of minerals specified        + -
!c           nc                 = number of components                + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c
!c           logical:
!c           --------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c
!c local:    real*8:
!c           -------
!c           prodrc             = activity product of species
!c                                involved in reaction
!c           prodrcinc          = activity product of species
!c                                involved in reaction (incremented)
!c           r0                 = constant
!c           r1                 = constant
!c           ratetrans          = differential of transport controlled
!c                                reaction rate 
!c                                (incremented - not incremnented)
!c           satminc            = saturation index with respect
!c                                to current mineral (incremented)
!c
!c           integer*4:
!c           ----------
!c           ireac              = counter 
!c           istart             = pointer (start of reaction set) 
!c           iend               = pointer (end of reaction set)
!c           istart2            = pointer (start of species involved) 
!c           istop2             = pointer (end of species involved)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueosu species)
!c           i1                 = counter
!c
!c external: draoult  = compute derivative of dissolution rate 
!c                      of organic compound from organic mixture based 
!c                      on raoult's law
!c ----------------------------------------------------------------------
  
      subroutine dratemin(totc,c,cx,gammac,gammax,ratem,phim,        &
                         phimold,aream,drtinc,im,ivol,tid)
 
      use parm
      use chem 
      
      implicit none
      
      integer :: im, ivol, tid
      
      real*8 :: totc, c, cx, gammac, gammax, ratem, phim, phimold,     &
                aream, drtinc
      
      integer :: i1, ic, iend, ireac, istart, istop, istart2,          &
                 istop2, ix
            
      real*8 :: r1_iap_k, prodrc, prodrcinc, satminc

      dimension totc(*),c(*),cx(*),gammac(*),gammax(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0

      external draoult
      
      r1_iap_k = 0.0d0
      satminc = 0.0d0      
          
      if (reaction_type(im).eq.'raoult') then

        call draoult(c,gammac,ratem,phim,phimold,aream,drtinc,im,tid)
        return

      end if

!c  initialize total reaction rate

      ratem = r0

!c  calculate saturation index for current mineral 
!c  (not incremented - incremented) except for far from
!c  equilibrium dissolution-precipitation reactions

      if (.not.far_from_equil(im)) then

        satm(im,tid) = eqm(im,tid)**(-r1)
        satminc = eqm(im,tid)**(-r1)

        istart = iam(im)
        istop = iam(im+1)-1
        do i1 = istart,istop
          ic = jam(i1)
          satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
          satminc = satminc * (gammac(ic)*cinc(ic,tid))**xnum(i1)
        end do

      end if

!c  compute difference of total dissolution/precipitation rate 
!c  for surface controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      if (rate_control(im).eq.'surface') then

!c  compute rates only for specified reaction direction

        if (reaction_type(im).eq.'reversible' .or.                     &
           reaction_type(im).eq.'dissolution_far_from_equilibrium' .or.&
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm(im,tid).gt.r0) .or.                                &
           reaction_type(im).eq.                                       &
           'precipitation_far_from_equilibrium' .or.                   &
           (reaction_type(im).eq.'precipitation_to_equilibrium'.and.   &
            r1-satm(im,tid).lt.r0).or.                                 &
            reaction_type(im).eq.'monod') then

!c  loop over parallel dissolution/precipitation reactions

          istart = iamd(im)
          istop = iamd(im+1)-1

          do ireac = istart,istop

!c  scale reaction rate depending on equilibrium condition except for
!c  far from equilibrium reactions
!c  (not incremented - incremented)

            if (reaction_type(im).eq.                                 &
               'dissolution_far_from_equilibrium'.or.                 &
                reaction_type(im).eq.'monod') then

              prodrc = rated(ireac,tid)
              prodrcinc = rated(ireac,tid)

            elseif (reaction_type(im).eq.                             &
                  'precipitation_far_from_equilibrium') then

              prodrc = -rated(ireac,tid)
              prodrcinc = -rated(ireac,tid)

            else

!c  commented out to avoid NaN problems
              !prodrc = rated(ireac)                                     &
              !       * (r1 - satm(im)**ordm(ireac))**ordn(ireac)
              !prodrcinc = rated(ireac)                                  &
              !          * (r1 - satminc**ordm(ireac))**ordn(ireac)
              !
              !if(isnan(prodrc)) then
              !    write(*,*) "prodrc is nan1: ", r1 - satm(im)**ordm(ireac),  ordn(ireac)
              !end if
              !
              !if(isnan(prodrcinc)) then
              !    write(*,*) "prodrcinc is nan1: ", r1 - satminc**ordm(ireac),  ordn(ireac)
              !end if
              
              !Lasaga et al. (1994) equation. dsu, 2012-12-20
              
              if(b_ratelaw_exponent_n) then
                  r1_iap_k = r1 - satm(im,tid)**ordm(ireac)
                  if (r1_iap_k > 0) then
                      if (reaction_type(im) ==                        &
                          'precipitation_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = rated(ireac,tid) * r1_iap_k**ordn(ireac)
                      end if
                  else
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrc = 0.0d0
                      else
                          prodrc = -rated(ireac,tid) *                &
                                   (abs(r1_iap_k))**ordn(ireac)
                      end if    
                  end if
                  
                  r1_iap_k = r1 - satminc**ordm(ireac)
                  if (r1_iap_k > 0) then
                      if (reaction_type(im) == 'precipitation_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = rated(ireac,tid) * r1_iap_k**   &
                                      ordn(ireac)
                      end if
                  else
                      if (reaction_type(im) == 'dissolution_to_equilibrium') then
                          prodrcinc = 0.0d0
                      else
                          prodrcinc = -rated(ireac,tid) *             &
                                      (abs(r1_iap_k))**ordn(ireac)
                      end if    
                  end if                    
              else
                  prodrc = rated(ireac,tid) * (r1 - (satm(im,tid)**   &
                           ordm(ireac)))
                  prodrcinc = rated(ireac,tid) * (r1 - (satminc**     &
                           ordm(ireac)))
              end if
              
              !--old--
              !prodrc = rated(ireac)                                   &
              !      * (r1 - (satm(im)**ordm(ireac)))
              !prodrcinc = rated(ireac)                                &
              !         * (r1 - (satminc**ordm(ireac)))


            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdt(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then

                prodrc = prodrc * (totc(ic)/(totc(ic)+ordm(ireac)))** &
                         ordn(ireac)
                prodrcinc = prodrcinc * (totcinc(ic,tid)/             &
                            (totcinc(ic,tid)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc(ic,tid)**orddt(i1)

            end do

!c  form product of reacting components as species in solution
!c  (not incremented - incremented)

            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1

            do i1 = istart2,istop2

              ic = jamdc(i1)

!c  scale reaction for far from equilibrium reactions

              if (far_from_equil(im)) then

                prodrc = prodrc * (gammac(ic)*c(ic) /                 &
                   (gammac(ic)*c(ic)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc * (gammac(ic)*cinc(ic,tid) /    &
                   (gammac(ic)*cinc(ic,tid)+ordm(ireac)))**ordn(ireac)

              end if

              prodrc = prodrc * (gammac(ic)*c(ic))**orddc(i1)
              prodrcinc = prodrcinc *                                 &
                   (gammac(ic)*cinc(ic,tid))**orddc(i1)

            end do

!c  form product of reacting complexed species
!c  (not incremented - incremented)

            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1

            do i1 = istart2,istop2

              ix = jamdcx(i1)

!c  scale reaction for far from equilibrium reactions


              if (far_from_equil(im)) then

                prodrc = prodrc * (gammax(ix)*cx(ix) /                &
                        (gammax(ix)*cx(ix)+ordm(ireac)))**ordn(ireac)
                prodrcinc = prodrcinc * (gammax(ix)*cxinc(ix,tid) /   &
                            (gammax(ix)*cxinc(ix,tid)+ordm(ireac)))** &
                            ordn(ireac)

              end if

              prodrc = prodrc * (gammax(ix)*cx(ix))**orddcx(i1)
              prodrcinc = prodrcinc *                                 &
                          (gammax(ix)*cxinc(ix,tid))**orddcx(i1)

            end do


!c  compute total rate for surface controlled reactions
!c  [moles/(L bulk*day)] = [m^2 mineral/L bulk]
!c                          -----------         
!c                       * [moles/(m^2 mineral * day)]
!c                                 -----------
!c  and sum up parallel reaction rates for surface controlled
!c  dissolution/precipitation reactions (incremented - not incremented)

            ratem = ratem - aream * (prodrcinc - prodrc)

          end do       !loop over parallel diss/prec reactions

!c  add monod and inhibition terms

          if (reaction_type(im).eq.'monod') then

!c  monod terms

            istart2 = iamdm(im)
            istop2 = iamdm(im+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdm(i1)

                ratem = ratem * ((totcinc(ic,tid)/                    &
                        (fmdm(i1) + totcinc(ic,tid)))**ordmdm(i1)     &
                        -(totc(ic)/(fmdm(i1) + totc(ic)))**ordmdm(i1))

              end do

            end if

!c  inhibition terms

            istart2 = iamdi(im)
            istop2 = iamdi(im+1)-1

            if (istop2.ge.istart2) then

              do i1 = istart2,istop2

                ic = jamdi(i1)

                ratem = ratem * (fmdi(i1)/(fmdi(i1)+totcinc(ic,tid))  &
                             -  fmdi(i1)/(fmdi(i1)+totc(ic)))

              end do

            end if

          end if       !(reaction_type(im).eq.'monod')

        end if         !reaction_type(im)

!c  compute difference of total dissolution/precipitation rate 
!c  for transport controlled dissolution/precipitation reactions
!c  (incremented - not incremented)

      elseif (rate_control(im).eq.'transport') then

        if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
           reaction_type(im).eq.'reversible'.or.                       &
           (reaction_type(im).eq.'dissolution_to_equilibrium'.and.     &
            r1-satm(im,tid).gt.r0)) then

!c  compute difference of total dissolution rate 
!c  (incremented - not incremented)
 
          istart = iamd(im)
          iend = iamd(im+1)-1

          do ireac = istart,iend
 
!c  scale reaction rate, if dissolution reaction is limited by
!c  equilibrium conditions

            if (far_from_equil(im)) then
              prodrc = r1
              prodrcinc = r1
            else
              prodrc = r1-satm(im,tid)
              prodrcinc = r1-satminc
            end if

!c  form product of reacting components in terms of total
!c  aqueous component concentrations (not incremented - incremented)

            istart2 = iamdt(ireac)
            istop2 = iamdt(ireac+1)-1

            do i1 = istart2,istop2
              ic = jamdt(i1)
              prodrc = prodrc * totc(ic)**orddt(i1)
              prodrcinc = prodrcinc * totcinc(ic,tid)**orddt(i1)
            end do
 
!c  form product of reacting free species for current dissolution
!c  reaction, activity coefficients are here not considered explicitely,
!c  but are by definition included in the effective diffusion coefficient
!c  (free species and incremented free species)
 
            istart2 = iamdc(ireac)
            istop2 = iamdc(ireac+1)-1
            do i1 = istart2,istop2
              ic = jamdc(i1)
              prodrc = prodrc * c(ic)**orddc(i1)
              prodrcinc = prodrcinc * cinc(ic,tid)**orddc(i1)
            end do
 
!c  include complexed species in product of reacting species for current
!c  dissolution reaction
!c  (complexed species and incremented complexed species)
 
            istart2 = iamdcx(ireac)
            istop2 = iamdcx(ireac+1)-1
            do i1 = istart2,istop2
              ix = jamdcx(i1)
              prodrc = prodrc * cx(ix)**orddcx(i1)
              prodrcinc = prodrcinc * cxinc(ix,tid)**orddcx(i1)
            end do
 
!c  compute difference of total rate 
!c  [moles/(l bulk*day)] = [m mineral / m^3 bulk]
!c                          ---------   --- 
!c                       * [m^3 h2o/m^3 mineral * m^2 mineral/day]
!c                          --- --- -----------   ----------- 
!c                       * [moles/l h2o]
!c                                  ---
!c  and sum up difference of total dissolution rate 
!c  [moles/(l h2o)] (incremented - not incremented)

            ratem = ratem - aream * diffm(ireac,tid)/xnud(ireac)*      &
                            (prodrcinc - prodrc)

          end do  

!c  do not allow precipitation 

        else            !reaction_type(im)

          ratem = r0
 
        end if          !reaction_type(im)

      end if            !rate_control(im)

!c  divide by increment of numerical differentiation
!c  and obtain derivative of total rate

      ratem = ratem/drtinc
 
      return
      end
