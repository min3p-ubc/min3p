!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/outputdd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputdd
!c -------------------
!c
!c write contour data for variably saturated flow simulation to output
!c file
!c
!c toggle logical variable ioutdebug = 0,1 for standard output or 
!c density dependent output including pressure and density
!c
!c modified from Uli Mayer template
!c
!c written by:      Tom Henderson - August 22, 2002
!c
!c last modified:   Tom Henderson - February 9, 2004
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c            Celine Blitz Frayret (CBF) for Frederic Gerard, December 14, 2018 
!c            Removed local calculation of qroot (it is now
!c            a common variable computed in jacvs)
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cinfvs(njavs)      = influence coefficients              + -
!c                                (variably saturated flow)
!c           cvol(nn)           = nodal volumes                       + -
!c           dimcv(3,nn)        = dimension of control volumes        + -
!c           elevmax            = max. elevation of solution domain   + -
!c           sgnew(nn)          = gaseous phase saturation            + - 
!c                                - new time level
!c           sanew(nn)          = aqueous phase saturation            + - 
!c                                - new time level
!c           relperm(nn)        = relative permeability               + -
!c           time_io            = current solution time (I/O units)   + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + -
!c           ifls               = unit number, file information       + -
!c           ilog               = unit number, log book               + -
!c           igsp               = unit number, flow variables         + -
!c           igstime            = pointer to next output time for     + -
!c                                contour data
!c           icnv               = unit number, data conversion        + -
!c           ivel               = unit number, average interfacial    + -
!c                                             velocities
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           iavs(nn+1)         = row pointer array for 1d-scalar     + -
!c                                matrix
!c           javs(njavs)        = connectivity list for 1d-scalar     + -
!c                                matrix
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = current time step                   + -
!c           njavs              = number of global connections        + -
!c           nn                 = number of control volumes           + -
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           depth_output       = .true.  -> output in terms of       + -
!c                                           depth instead of
!c                                           elevation
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c           half_cells         = .true.  -> half cells on boundary   + -
!c           initial_condition  = .true.  -> output of initial        + -
!c                                           contour data
!c                                .false. -> output contour data
!c                                           for steady state or
!c                                           transient solutions
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           steady_flow        = .true.  -> steady state flow        + -
!c           upstream           = .true.  -> upstream weighting       + -
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient conditions for    
!c                                           variably saturated flow 
!c                                           simulation
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           problem_title      = problem title                       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c
!c dens.f:   real*8:
!c           -------
!c           pressure(nn)       = fluid pressure                      + -
!c           density(nn)        = fluid density                       + -
!c           ref_dens           = reference density to convert        + -
!c                                from freshwater heads to pressures   
!c
!c biol.F90: real*8:
!c           -------           
!c           qroot(nn)          = root water uptake for current ! CBF
!c                                control volume
!c
!c local:    real*8:
!c           ------- 
!c           fhead              = freshwater head 
!c           qroot              = root water uptake for current
!c                                control volume
!c           theta_a            = aqueous phase content         
!c           theta_g            = gas phase content
!c           r0                 = constant         
!c           r1                 = constant
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           l_sufx             = length of file suffix
!c           ioutdebug          = output toggle
!c
!c           character:
!c           ---------- 
!c           suffix             = file suffix
!c
!c external: velocity  = average interfacial velocities
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c --------------------------------------------------------------------------

      subroutine outputdd

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use phys
      use dens
      use chem
      use writeversion
      use file_unit, only : lun_get, lun_free

      use biol

#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: i, i1, ic, itemp, im, ivol, ivol_l, ioutdebug, iprint,&
                 istart, istop, izn, l_sufx, ierrcode, ierr
      real*8 :: dvi, ddens, ddens_c, ddens_dt, ddens_temp,             &
                ddensreact_dt, ddensmix_dt, volnew, volold, stq,       &
                tempk1, tempk2, zout, phead, fhead,           &
                theta_a, theta_g, theta_n, actw, s_ice, s_water

      real*8 :: qroot, transp, soilevapo
      
      real*8, external :: evapo, zoutput, rootwat

      external velocity, checkerr

      real*8, external :: pressure_melt_k

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, eps=1.0d-300,       &
              r1000=1.0d3, rkelvin=273.15d0, zero=1.0d-5                        
                                                                       
      real*8, allocatable  :: ddens_dvi(:)
      real*8, allocatable  :: totc(:)

      character*5 :: suffix
      character*128 :: msg
      character*2048 :: strbuffer
      character*72, allocatable :: tec_variables(:)
      integer :: nvars
      
      logical :: iserror
      
      
#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) :: offset_igsp, offset_igsp_temp,  &
                                   offset_ivel, offset_ivel_temp,      &
                                   offset_ivelvap, offset_ivelvap_temp,&
                                   offset_idens, offset_idens_temp
#else
      integer*8 :: offset_igsp, offset_igsp_temp,                      &
                   offset_ivel, offset_ivel_temp,                      &
                   offset_ivelvap, offset_ivelvap_temp,                &
                   offset_idens, offset_idens_temp
#endif
      
      if (b_output_binary) then
        allocate(tec_variables(18+nm), stat = ierr)
        call checkerr(ierr,'outputdd-tec_variables',ilog)
        tec_variables = ''
        call memory_monitor(sizeof(tec_variables),'tec_variables',.true.)
      end if

!c     write(*,'(/a)') 'enter routine outputvs ...'
   
!c  assign file suffix for initial condition or current time step
!c  works for up to 999 output times

      rewind(icnv)

!c  logical variable for output format
!c  0 = identical format to non-density dependent flow
!c  1 = complete output

      ioutdebug = 1

!c flow verification output
      if (flow_verification) then
        ioutdebug = 0
      end if

      l_sufx = 0

      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then
          !Deprecated, use internal convert instead. DSU
          !write(icnv,'(i1)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix        
          write(suffix,'(i1)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:1)
            l_sufx = 3
          else
            l_sufx = 1
          end if

        elseif (igstime.ge.10.and.igstime.lt.100) then

          !write(icnv,'(i2)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i2)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:2)
            l_sufx = 4
          else
            l_sufx = 2
          end if

        elseif (igstime.ge.100.and.igstime.lt.1000) then

          !write(icnv,'(i3)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i3)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:3)
            l_sufx = 5
          else
            l_sufx = 3
          end if

        elseif (igstime.gt.1000) then

          if (rank == 0) then  
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
#ifdef DEBUG
            write(idbg,'(/a)') 'error in input file'
            write(idbg,'(a)') 'max. number of output times exceeded'
            write(idbg,'(a)') 'abnormal exit in routine outputrt'
            close(idbg)
#endif
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if
      end if
      
!cprovi------------------------------------------------------------------
!cprovi Compute and write the density components 
!cprovi------------------------------------------------------------------
      if (issplitdens.and.time_io/=r0) then
          
        if (b_output_binary) then
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.dens'
          else
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//        &
                        trim(adjustl(str_rank))//'.dens'
          end if
            
          call binary_file_open(Petsc_Comm_World, idens,       &
                       trim(strbuffer),b_output_mpiio_single)
 
        else 
          open(idens,file=prefix(:l_prfx)//'_'//                       &
     &           suffix(:l_sufx)//trim(adjustl(str_rank))//'.dens',    &
     &           status='unknown',form='formatted')
        end if
         
!c   version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(idens, "#")
        end if
        
!c   title and variables
        if (b_output_binary) then
          strbuffer = 'dataset '//prefix(:l_prfx)//''
          !write tecplot title and header  
          offset_idens = 0
          call tecplot_binary_write_header(Petsc_Comm_World, idens,    &
                       "#!TDV102", trim(strbuffer), offset_idens,      &
                       b_output_mpiio_single,.false.) 

          tec_variables(1:6) = [character(len=72) :: "x", "y", "z",    &
                               "ddens_dt","ddensmix_dt","ddensreact_dt"]
          do im = 1, nm
            tec_variables(6+im) = namem(im)(:l_namem(im)) 
          end do
          
          call tecplot_binary_write_variable(Petsc_Comm_World,idens,   &
                       6+nm, tec_variables(1:6+nm), offset_igsp,       &
                       b_output_mpiio_single,.false.)   

        else
           write(idens,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'   
           write(idens,'(1000a)') 'variables = "x", "y", "z"',         &
                                     ' "ddens_dt",',                   &
                                     ' "ddensmix_dt",',                &
                                     ' "ddensreact_dt",',              &
                                    (',"',namem(im)(:l_namem(im)),     &
                                     '"',im=1,nm)
        end if
!c   zone information
        if (b_output_binary) then
          write(strbuffer,'(a,1pe15.6e3,1x,a)')                        &
                'density components, T = ', time_io,                   &
                time_unit(:l_time_unit)
          offset_idens_temp = offset_idens
          
          if (b_output_multizone) then
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,idens, &
                         trim(strbuffer),offset_idens,                 &
                         itec,jtec,ktec,                               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            offset_idens = offset_idens_temp +                         &
                          (11+len_trim(strbuffer))*4*nprcs+4
          else
            call tecplot_binary_write_zoneinfo(Petsc_Comm_World,idens, &
                         trim(strbuffer),offset_idens,                 &
                         itec_gbl,jtec_gbl,ktec_gbl,                   &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            offset_idens = offset_idens_temp +                         &
                          (12+len_trim(strbuffer))*4
          end if
        else
          write(idens,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                  &
                'zone t = "density components, T = ',                  &
                time_io,time_unit(:l_time_unit),                       &
                '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
        end if 
         
        if (b_output_binary) then
          offset_idens_temp = offset_idens
          call tecplot_binary_write_section(Petsc_Comm_World,          &
                       idens,6+nm,nn_offset,offset_idens,              &
                       b_output_mpiio_single,.false.,b_output_multizone)
          
          allocate(realbuffer(nn*(6+nm)), stat = ierr)
          call checkerr(ierr,'outputdd-realbuffer',ilog)
          realbuffer = 0.0d0
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if
         
         allocate (ddens_dvi(nm), stat = ierr)
         call checkerr(ierr,'outputdd-ddens_dvi',ilog)
         ddens_dvi = 0.0d0
         call memory_monitor(sizeof(ddens_dvi),'ddens_dvi',.true.)
         
         ivol_l = 0 
         
         do ivol=1,nngl 
             
!c  skip ghost nodes
#ifdef PETSC
             if (node_idx_lg2l(ivol) < 0) then
                 cycle
             end if 
#endif
             ivol_l = ivol_l + 1
             
             ddens_dt = (density(ivol)-densold(ivol))/delt 
             ddensreact_dt=r0
             do im=1,nm   
               istart = iam(im)
               istop = iam(im+1)-1
               if (phi(im,ivol)>zero) then
                 volnew = phi(im,ivol)/pornew(ivol)
               else
                 volnew = zero
               end if
               if (phiold(im,ivol)>zero) then
                 volold = phiold(im,ivol)/pornew(ivol)
               else
                 volold = zero
               end if
!cprovi--------------------------------------------------------
!cprovi Compute the changes in mol/lw
!cprovi--------------------------------------------------------               
               dvi = r1000*(volnew-volold)*densm(im)/gfwm(im)
!cprovi--------------------------------------------------------
!cprovi Store the concentration vector for aqueous species               
!cprovi--------------------------------------------------------
               cpz_loc(1:nc)=r0 ! cnew(1:nc,ivol)
               cpz_loc(nc+1:nc+nx)= r0 ! cx(1:nx,ivol)
!cprovi--------------------------------------------------------
!cprovi Compute the increment for dissolution/precipitation 
!cprovi--------------------------------------------------------               
               do i1 = istart,istop
                 ic = jam(i1)
                 stq = xnum(i1)
                 cpz_loc(ic) = cpz_loc(ic) - stq * dvi
             end do  
!cprovi--------------------------------------------------------               
!cprovi Compute density 
!cprovi--------------------------------------------------------               
         
             if (ispitzerdens) then   
                 msg=' '
                 call compute_density_ (phase,r0,r0,cpz_loc,ddens,      & 
     &                                    .false.,iserror)        
                 if (iserror) then 
                 msg='Error when call compute_density_ in the phase object'
                 write (ilog,*) msg
#ifdef PETSC
                 call petsc_mpi_finalize
#endif
                 stop 
                 end if 
             else
                 allocate(totc(nc), stat = ierr)
                 call checkerr(ierr,'outputdd-totc',ilog)
                 totc=r0
                 call memory_monitor(sizeof(totc),'totc',.true.)

                 call totconc(cpz_loc(1:nc),cpz_loc(nc+1:nc+nx),totc)
                 totc=totcold(1:nc-1,ivol)+totc(1:nc-1)
                 tot_tds = r0
                   do ic=1,nc-1
                   itemp = ncorder(ic) 
                   if ((namec(itemp) .ne. 'h+').and.                &
     &                    (namec(itemp) .ne. 'h+1').and.               &
     &                   (namec(itemp) .ne. 'o2(aq)').and.            &
     &                 (namec(itemp) .ne. 'h2(aq)').and.              &
     &                   (namec(itemp) .ne. 'n2(aq)').and.            &
     &                 (namec(itemp) .ne. 'ch4(aq)')) then
                                                                       
                       if (specify_dd_comp) then
                           tds_ic = totc(itemp) * gfwdd(itemp) 
                     else
                           tds_ic = totc(itemp) * gfwc(itemp)
                     end if
                                                                       
                       tot_tds = tot_tds + tds_ic
                   end if
                 end do
                                                                     
                   ddens_c = drho_dc * (tot_tds - ref_tds)
                 if ((heat_transport .or. temp_field) .and. nonlindens_heat) then        
                     tempk1=tempref_dens+rkelvin                       
                     tempk2=tempnew(ivol)+rkelvin                      
                     ddens_temp = cdens1+r1000*tempk1*(cdens2+tempk1* &
     &                          (cdens3-tempk1*cdens4))                
                     ddens_temp = cdens1+r1000*tempk2*(cdens2+tempk2* &
     &                          (cdens3-tempk2*cdens4)) - ddens_temp  
                   else                                 
                     ddens_temp = drho_dt*(tempnew(ivol) - tempref_dens)
                   end if
                   call memory_monitor(-sizeof(totc),'totc',.true.)
                   deallocate(totc)
                 ddens = ref_dens + ddens_temp + ddens_c 
              end if 
             
             
             if (dvi/=r0) then
               ddens = ddens - densold(ivol)             
             else
               ddens = r0
             end if
             
             ddensreact_dt = ddensreact_dt + ddens
             ddens_dvi(im) = ddens / delt
             
          end do
            
            ddensreact_dt = ddensreact_dt / delt
            ddensmix_dt = ddens_dt - ddensreact_dt
            
            zout = zoutput(depth_output,zg(ivol),elevmax)
            
            if (b_output_binary) then
              realbuffer((ivol_l-1)*(6+nm)+1:ivol_l*(6+nm)-nm) = (/    &
                         xg(ivol),yg(ivol),zout,ddens_dt,ddensmix_dt,  &
                         ddensreact_dt/) 
              do im = 1, nm
                realbuffer(ivol_l*(6+nm)-nm+im) = ddens_dvi(im)  
              end do
            else
              write(idens,ascii_fmt) xg(ivol),yg(ivol),zout,           &
                    ddens_dt,ddensmix_dt,ddensreact_dt,                &
                    (ddens_dvi(im),im=1,nm)
            end if
         
         end do
         
         if (b_output_binary) then
           if (b_output_multizone .or. .not.b_output_mpiio_single) then
             call binary_write_data(idens, size(realbuffer,1),         &
                          realbuffer,offset_idens,b_output_mpiio_single)
           else
            call binary_subarray_initialize(nm+6,b_mpiarray_idens_init,&
                        .false.,mpiarray_filetype_idens,               &
                        mpiarray_sizes_gbl_idens,                      &
                        mpiarray_sizes_sub_idens,                      &
                        mpiarray_starts_sub_idens)
            call binary_write_data(idens, size(realbuffer,1),          &
                        realbuffer,offset_idens,mpiarray_filetype_idens)
           end if
           call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
           deallocate(realbuffer) 
         end if        
         
         call memory_monitor(-sizeof(ddens_dvi),'ddens_dvi',.true.)
         deallocate(ddens_dvi)
          
         
      end if  
      
!cprovi------------------------------------------------------------------
!cprovi Compute and write the density components 
!cprovi------------------------------------------------------------------
!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
      if (b_output_binary) then
        
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsp'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsp'
        end if
          
        call binary_file_open(Petsc_Comm_World, igsp,          &
                     trim(strbuffer),b_output_mpiio_single)

        
      else
        open(igsp,file=prefix(:l_prfx)//'_'//                          &
     &            suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsp',    &
     &            status='unknown',form='formatted')
      end if
      
      if (rank == 0 .and. b_enable_output) then

        if (initial_condition) then
        
          write(ifls,'(/2a/72a)')'Flow variables, initial ',           &
     &                           'condition',('-',i=1,72)
                                                                        
        elseif (steady_flow) then
                                                                        
          write(ifls,'(/2a/72a)')'Flow variables, steady ',            &
     &                           'state solution',('-',i=1,72)
                                                                        
        else
                                                                        
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
     &          'Flow variables, T = ',time_io,time_unit,('-',i=1,72)
                                                                        
        end if
                                                                        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
     &                      suffix(:l_sufx)//'.gsp'
                                                                        
        write(ifls,'(2a)')                                             &
     &        'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
     &        '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
     &        '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
     &        '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
     &        '4        freshwater head                 ','m'           
        write(ifls,'(2a)')                                             &
     &        '5        fluid pressure                  ','Pa'          
        write(ifls,'(2a)')                                             &
     &        '6        pressure head                   ','m'           
        write(ifls,'(2a)')                                             &
     &        '7        density                         ','kg/m^3'      
        write(ifls,'(2a)')                                             &
     &        '8        water saturation                ','-'           
        write(ifls,'(2a)')                                             &
     &        '9        water content                   ','-'           
        if (variably_saturated) then                                    
          write(ifls,'(2a)')                                           &
     &          '10        air saturation                 ','-'         
          write(ifls,'(2a)')                                           &
     &          '11        air content                    ','-'         
          write(ifls,'(2a)')                                           &
     &          '12       root uptake rate                ','m^3/d'
        end if
      
      end if

!c  ---------------------------------------------------------------------
!c  open file for interfacial velocities
!c  --------------------------------------------------------------------- 
      
      if (.not.initial_condition) then

        if (b_output_binary) then
          
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.vel'
          else
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//        &
                        trim(adjustl(str_rank))//'.vel'
          end if
          call binary_file_open(Petsc_Comm_World, ivel,        &
                       trim(strbuffer),b_output_mpiio_single)
        else
        
          open(ivel,file=prefix(:l_prfx)//'_'//                        &
                    suffix(:l_sufx)//trim(adjustl(str_rank))//'.vel',  &
                    status='unknown',form='formatted')
            
        end if                  
                                                                       
        if (evaporation) then
            
          if (b_output_binary) then
            
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          '.velvap'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.velvap'
            end if
            call binary_file_open(Petsc_Comm_World, ivelvap,   &
                         trim(strbuffer),b_output_mpiio_single)
          else
          
            open(ivelvap,file=prefix(:l_prfx)//'_'//                   &
     &           suffix(:l_sufx)//trim(adjustl(str_rank))//'.velvap',  &
     &           status='unknown',form='formatted')
              
          end if
                 
        end if  
        
        if (rank == 0 .and. b_enable_output) then
                                                                       
          if (steady_flow) then
                                                                         
            write(ifls,'(/2a/72a)')'Average interfacial ',             &
     &                           'velocities - steady state solution', &
     &                           ('-',i=1,72)
                                                                         
          else
                                                                         
            write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                     &
     &            'Average interfacial velocities, T = ',              &
     &             time_io,time_unit,('-',i=1,72)
                                                                        
          end if
                                                                        
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
     &                        suffix(:l_sufx)//'.vel'
                                                                        
          write(ifls,'(2a)')                                           &
     &          'column   entry                           ','unit'       
          write(ifls,'(2a)')                                           &
     &          '1        x                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '2        y                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '3        z                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '4        v_x                             ','m/d'       
          write(ifls,'(2a)')                                           &
     &          '5        v_y                             ','m/d'       
          write(ifls,'(2a)')                                           &
     &          '6        v_z                             ','m/d'
        
        end if

      end if               ! (.not.initial_condition)
   
!c  ---------------------------------------------------------------------
!c  file header
!c  ---------------------------------------------------------------------

!c debugging output for comparison to standard test files

!c  use same output fomat as non-density dependent flow simulations
!c  to compare results

      if (ioutdebug .eq. 0) then  !outputvs format - no fluid pressures

!c  define number of variables        
        if (fully_saturated) then
          if (heat_transport .or. temp_field) then
            nvars = 11  
          else
            nvars = 7
          end if
        else if (variably_saturated) then
          nvars = 12
        end if

!c  title and variables

        if (tec_header) then
            
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsp, "#")
          end if

!c  title and variables
          if (b_output_binary) then
          
            strbuffer = 'dataset '//prefix(:l_prfx)//''
            !write tecplot title and header  
            offset_igsp = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igsp,   &
                         "#!TDV102", trim(strbuffer), offset_igsp,     &
                         b_output_mpiio_single,.false.)
          else
            write(igsp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          end if

          if (fully_saturated) then
            if (heat_transport .or. temp_field) then
              if (b_output_binary) then
                tec_variables(1:nvars) = [character(len=72) ::         &
                    "x","y","z","h_w","ph_w","s_a","theta_a","temp_n", &
                    "visco_n","s_ice","s_water"] 
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                            igsp,nvars,tec_variables(1:nvars),         &
                            offset_igsp,b_output_mpiio_single,.false.)   

              else  
                write(igsp,'(20a)') 'variables = "x", "y", "z",',      &
                                    ' "h_w",',                         &
                                    ' "ph_w",',                        &
                                    ' "s_a",',                         &
                                    ' "theta_a",',                     &
                                    ' "temp_n",',                      &
                                    ' "visco_n",',                     &
                                    ' "s_ice",',                       &
                                    ' "s_water"' 
              end if
            else  
              if (b_output_binary) then
                tec_variables(1:nvars) = [character(len=72) ::         &
                    "x","y","z","h_w", "ph_w", "s_a", "theta_a"] 
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                            igsp,nvars,tec_variables(1:nvars),         &
                            offset_igsp,b_output_mpiio_single,.false.)   
              else  
                write(igsp,'(20a)') 'variables = "x", "y", "z",',      &
     &                              ' "h_w",',                         &
     &                              ' "ph_w",',                        &
     &                              ' "s_a",',                         &
     &                              ' "theta_a"' 
              end if
                                                                       
            end if
                                                                       
          elseif (variably_saturated) then
            if (b_output_binary) then
              tec_variables(1:nvars) = [character(len=72) ::           &
                  "x","y","z","h_w","ph_w","s_a","theta_a",            &
                  "s_g","theta_g","q_root","rootwat", "evapo"] 
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                      igsp,nvars,tec_variables(1:nvars),offset_igsp,   &
                      b_output_mpiio_single,.false.)   
            else
              write(igsp,'(20a)') 'variables = "x", "y", "z",',       &
                                ' "h_w",',                            &
                                ' "ph_w",',                           &
                                ' "s_a",',                            &
                                ' "theta_a",',                        &
                                ' "s_g",',                            &
                                ' "theta_g",',                        &
                                ' "q_root",',                         &
                                ' "rootwat",',                        &
                                ' "evapo"'
            end if
                                                                       
          end if
                                                                       
          if (.not.initial_condition) then 
              
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
                call writeversion2file(ivel, "#")
            end if
              
            if (b_output_binary) then
                
              strbuffer = 'dataset '//prefix(:l_prfx)//''
              offset_ivel = 0
              call tecplot_binary_write_header(Petsc_Comm_World, ivel, &
                           "#!TDV102", trim(strbuffer), offset_ivel,   &
                           b_output_mpiio_single,.false.)
            
              tec_variables(1:9) = [character(len=72) ::"x", "y", "z", &
                                    "qx", "qy", "qz", "vx", "vy","vz"] 
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           ivel, 9, tec_variables(1:9), offset_ivel,   &
                           b_output_mpiio_single,.false.)            
            else
              write(ivel,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(ivel,'(2a)') 'variables = "x", "y", "z", ',    &
                                 '"qx", "qy", "qz","vx", "vy", "vz"' 
            end if
                     
            if (evaporation) then  
!c  version information
              if (b_writeversion_tecplot .and. .not. b_output_binary) then
                  call writeversion2file(ivelvap, "#")
              end if
              
              if (b_output_binary) then
                  
                strbuffer = 'dataset '//prefix(:l_prfx)//''
                offset_ivelvap = 0
                call tecplot_binary_write_header(Petsc_Comm_World,     &
                             ivelvap, "#!TDV102",trim(strbuffer),      &
                             offset_ivelvap,b_output_mpiio_single,     &
                             .false.)
              
                tec_variables(1:9) = [character(len=72) ::"x","y","z", &
                                      "qx", "qy", "qz", "vx", "vy","vz"] 
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                             ivelvap, 9, tec_variables(1:9),           &
                             offset_ivelvap,b_output_mpiio_single,     &
                             .false.)              
              else
                write(ivelvap,'(3a)') 'title = "dataset ',             &
                prefix(:l_prfx),'"'                                      
                write(ivelvap,'(2a)') 'variables = "x", "y", "z", ',   &
                                     '"qx", "qy", "qz","vx", "vy", "vz"'
              end if

            end if
     
     
          end if

        else
!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(igsp, "#")
          end if
        
          write(igsp,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'

          if (fully_saturated) then

            write(igsp,'(20a)') '# variables = "x", "y", "z",',       & 
                                ' "h_w",',                            &
                                ' "ph_w",',                           &
                                ' "s_a",',                            &
                                ' "theta_a"'
                                                                       
          elseif (variably_saturated) then
                                                                       
            write(igsp,'(20a)') '# variables = "x", "y", "z",',       &
                                ' "h_w",',                            &
                                ' "ph_w",',                           &
                                ' "s_a",',                            &
                                ' "theta_a",',                        &
                                ' "s_g",',                            &
                                ' "theta_g",',                        &
                                ' "q_root",',                         &
                                ' "rootwat",',                        &
                                ' "evapo"'
          end if

          if (.not.initial_condition) then
!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(ivel, "#")
            end if
        
            write(ivel,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(ivel,'(2a)') '# variables = "x", "y", "z", ',       &
     &                         '"qx", "qy", "qz", "vx", "vy", "vz"'                      
            if (evaporation) then 
!c  version information
              if (b_writeversion_tecplot ) then
                  call writeversion2file(ivelvap, "#")
              end if
              
              write(ivelvap,'(3a)') '# title = "dataset ',            &
     &                               prefix(:l_prfx),'"'               
              write(ivelvap,'(2a)') '# variables = "x", "y", "z", ',  &
     &                         '"qx", "qy", "qz","vx", "vy", "vz"'
            end if
          end if

        end if                    !(tec_header)

!c  zone record for initial condition
 
        if (initial_condition) then

          if (tec_header) then
              
            if(b_output_binary) then  
                
              strbuffer = 'Flow variables, initial condition'
              offset_igsp_temp = offset_igsp  
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)            
                offset_igsp = offset_igsp_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)            
                offset_igsp = offset_igsp_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsp,'(3(a,i5),a)')                                &
                    'zone t = "Flow variables, initial condition" i =',&
                    itec,', j =',jtec,', k =',ktec,',  f=point'
            end if  
                                                                       
          else
                                                                       
            write(igsp,'(3(a,i5),a)')                                 &
     &          '# zone t = "Flow variables, initial condition" i =', &
     &          itec,', j =',jtec,', k =',ktec,',  f=point'

          end if                   !(tec_header)

!c  zone record for current time step or steady state solution
!c  for fully saturated or variably saturated  conditions

        elseif (.not.initial_condition) then

          if (tec_header) then

            if (steady_flow) then
                
              if (b_output_binary) then
                  
                strbuffer = 'Flow variables, steady state'
                offset_igsp_temp = offset_igsp
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp,trim(strbuffer),offset_igsp,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsp = offset_igsp_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp,trim(strbuffer),offset_igsp,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsp = offset_igsp_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
                
                strbuffer = 'velocities, steady state'
                offset_ivel_temp = offset_ivel
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer),offset_ivel,       &
                               itec_vel,jtec_vel,ktec_vel,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)              
                  offset_ivel = offset_ivel_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer),offset_ivel,       &
                               itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl, &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)              
                  offset_ivel = offset_ivel_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
              else
              
                write(igsp,'(a,3(a,i5),a)')                            &
                      'zone t = "Flow variables, steady state" ',      &
                      'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
                
                write(ivel,'(a,3(a,i5),a)')                            &
                      'zone t = "velocities, steady state" ',          &
                      ', i =',itec_vel,                                &
                      ', j =',jtec_vel,                                &
                      ', k =',ktec_vel,',  f=point'  
              end if
                                                                         
              if (evaporation) then 
                  
               if (b_output_binary) then
                 strbuffer = 'velocities, steady state'
                 offset_ivelvap_temp = offset_ivelvap
                 
                 if (b_output_multizone) then
                   call tecplot_binary_write_zoneinfo(Petsc_Comm_World,&
                                ivelvap,trim(strbuffer),offset_ivelvap,&
                                itec_vel,jtec_vel,ktec_vel,            &
                                b_output_mpiio_single,.false.,         &
                                b_output_multizone)               
                   offset_ivelvap = offset_ivelvap_temp +              &
                                 (11+len_trim(strbuffer))*4*nprcs+4
                 else
                   call tecplot_binary_write_zoneinfo(Petsc_Comm_World,&
                                ivelvap,trim(strbuffer),offset_ivelvap,&
                                itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl,&
                                b_output_mpiio_single,.false.,         &
                                b_output_multizone)               
                   offset_ivelvap = offset_ivelvap_temp +              &
                                 (12+len_trim(strbuffer))*4
                 end if
               else                 
                 write(ivelvap,'(a,3(a,i5),a)')                        &
                       'zone t = "velocities, steady state" ',         &
                       ', i =',itec_vel,                               &
                       ', j =',jtec_vel,                               &
                       ', k =',ktec_vel,',  f=point' 
               end if
              end if 
                                                                         
            elseif (transient_flow) then
                                                                         
              if (b_output_binary) then
                  
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'Flow variables, solution time = ',              &
                      time_io,time_unit
                offset_igsp_temp = offset_igsp
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp,trim(strbuffer),offset_igsp,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)              
                  offset_igsp = offset_igsp_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp,trim(strbuffer),offset_igsp,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)              
                  offset_igsp = offset_igsp_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if                
                
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'velocities, solution time = ', time_io,time_unit
                offset_ivel_temp = offset_ivel
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer), offset_ivel,      &
                               itec_vel,jtec_vel,ktec_vel,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)             
                  offset_ivel = offset_ivel_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer), offset_ivel,      &
                               itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl, &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)             
                  offset_ivel = offset_ivel_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
              else                                                                       
                write(igsp,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                    'zone t = "Flow variables, solution time = ',      &
                    time_io, time_unit,'" i =',itec,', j =',jtec,      &
                    ', k =',ktec, ',  f=point'
                
                write(ivel,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                      'zone t = "velocities, solution time = ',        &
                      time_io, time_unit,                              &
                      '" i =',itec_vel,                                &
                      ', j =',jtec_vel,                                &
                      ', k =',ktec_vel,',  f=point'
                
              end if                   
                                                                         
              if (evaporation) then 
                  
               if (b_output_binary) then
                   
                 write(strbuffer,'(a,1pe15.6e3,1x,a)')                 &
                       'velocities, solution time = ',                 &
                       time_io,time_unit
                 offset_ivelvap_temp = offset_ivelvap
                 
                 if (b_output_multizone) then
                   call tecplot_binary_write_zoneinfo(Petsc_Comm_World,&
                                ivelvap,trim(strbuffer),offset_ivelvap,&
                                itec_vel,jtec_vel,ktec_vel,            &
                                b_output_mpiio_single,                 &
                                .false.,b_output_multizone)               
                   offset_ivelvap = offset_ivelvap_temp +              &
                                 (11+len_trim(strbuffer))*4*nprcs+4
                 else                     
                   call tecplot_binary_write_zoneinfo(Petsc_Comm_World,&
                                ivelvap,trim(strbuffer),offset_ivelvap,&
                                itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl,&
                                b_output_mpiio_single,.false.,         &
                                b_output_multizone)               
                   offset_ivelvap = offset_ivelvap_temp +              &
                                 (12+len_trim(strbuffer))*4
                 end if  
               else
                  
                 write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')         &
                      'zone t = "velocities, solution time = ',        &
                      time_io, time_unit,                              &
                      '" i =',itec_vel,                                &
                      ', j =',jtec_vel,                                &
                      ', k =',ktec_vel,',  f=point' 
               end if
               
              end if
                                                                         
            end if
                                                                         
          else
                                                                         
            if (steady_flow) then
                                                                         
              write(igsp,'(a,3(a,i5),a)')                               &
     &            '# zone t = "Flow variables, steady state solution" ',&
     &            'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
                                                                         
              write(ivel,'(a,3(a,i5),a)')                               &
     &              '# zone t = "velocities, steady state" ',           &
     &              ', i =',itec_vel,                                   &
     &              ', j =',jtec_vel,                                   &
     &              ', k =',ktec_vel,',  f=point'
                                                                         
              if (evaporation) then                                      
               write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')            &
     &              'zone t = "velocities, steady state" ',             &
     &              time_io, time_unit,                                 &
     &              '" i =',itec_vel,                                   &
     &              ', j =',jtec_vel,                                   &
     &              ', k =',ktec_vel,',  f=point'                   
              end if
                                                                         
            elseif (transient_flow) then
                                                                         
              write(igsp,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
     &           '# zone t = "Flow variables, solution time = ',time_io,&
     &            time_unit,'" i =',itec,', j =',jtec,', k =',ktec,     &
     &           ',  f=point'
                                                                         
              write(ivel,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
     &            '# zone t = "velocities, solution time = ',          &
     &            time_io, time_unit,                                  &
     &            '" i =',itec_vel,                                    &
     &            ', j =',jtec_vel,                                    &
     &            ', k =',ktec_vel,',  f=point'
                                                                         
              if (evaporation) then                                      
               write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')           &
     &              'zone t = "velocities, solution time = ',          &
     &              time_io, time_unit,                                &
     &              '" i =',itec_vel,                                  &
     &              ', j =',jtec_vel,                                  &
     &              ', k =',ktec_vel,',  f=point'   
              end if 

            end if         

          end if                  !(tec_header)
        end if                    !(initial_condition)

!c  ---------------------------------------------------------------------
!c  output outputvs format - no fluid pressures
!c  ---------------------------------------------------------------------

        if (b_output_binary) then
            
          offset_igsp_temp = offset_igsp
          if (fully_saturated) then
            if (heat_transport .or. temp_field) then
              call tecplot_binary_write_section(Petsc_Comm_World,      &
                           igsp,nvars,nn_offset,offset_igsp,           &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone) 
            else
              call tecplot_binary_write_section(Petsc_Comm_World,      &
                           igsp,nvars,nn_offset,offset_igsp,           &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
            end if
          else if (variably_saturated) then
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igsp,nvars,nn_offset,offset_igsp,             &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
          end if
          
          if (.not.initial_condition) then
            offset_ivel_temp = offset_ivel
            call tecplot_binary_write_section(Petsc_Comm_World, ivel,9,&
                         nn_interfacial_offset,offset_ivel,            &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            
            if (evaporation) then
              offset_ivelvap_temp = offset_ivelvap
              call tecplot_binary_write_section(Petsc_Comm_World,      &
                           ivelvap,9,nn_interfacial_offset,            &
                           offset_ivelvap,b_output_mpiio_single,       &
                           .false.,b_output_multizone)
            end if
          end if
           
        end if

!C----------Zone Data. Each variable is in data format asspecified above.   
        if(b_output_binary) then
          allocate(realbuffer(nn*nvars), stat = ierr)
          call checkerr(ierr,'outputdd-realbuffer',ilog)
          realbuffer = 0.0d0
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if

        ivol_l = 0

!c  loop over control volumes

        do ivol = 1,nngl
            
!c  skip ghost nodes
#ifdef PETSC
          if (node_idx_lg2l(ivol) < 0) then
              cycle
          end if 
#endif
          ivol_l = ivol_l + 1
!c  calculate freshwater heads

          phead = uvsnew(ivol)/(density(ivol) * gacc)

          fhead = phead + zg(ivol)

!c        phead = uvsnew(ivol)/(ref_dens * gacc)
!c        fhead = phead + zg(ivol)


!c  assign depth coordinate in terms of depth or elevation

          zout = zoutput(depth_output,zg(ivol),elevmax)

          theta_a = pornew(ivol) * sanew(ivol)

!c  calculate ice and water saturation when freezing/thawing are considered
          if ((heat_transport .or. temp_field) .and. b_water_freezing) then
            if (tempnew(ivol)+tconv > pressure_melt_k(ivol,r0)) then
              s_ice = r0
              s_water = sanew(ivol)
            else
              s_ice = sanew(ivol)
              s_water = r0              
            end if
          else
            s_ice = r0
            s_water = sanew(ivol)
          end if 

          if (fully_saturated) then
            if (b_output_binary) then
              if(heat_transport .or. temp_field) then
                realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/       &
                          xg(ivol),yg(ivol),zout,fhead,phead,          &
                          sanew(ivol),theta_a,tempnew(ivol),           &
                          viscosity(ivol),s_ice,s_water/)
              else
                realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/       &
                          xg(ivol),yg(ivol),zout,fhead,phead,          &
                          sanew(ivol),theta_a/)  
              end if
            else
              if(heat_transport .or. temp_field) then
                write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                      fhead, phead, sanew(ivol),theta_a,               &
                      tempnew(ivol),viscosity(ivol),s_ice,s_water
              else
                write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                      fhead, phead, sanew(ivol),theta_a
              end if
            end if                                                           
          elseif (variably_saturated) then
                                                                       
            sgnew(ivol) = r1 - sanew(ivol)                             
            theta_g = pornew(ivol)*sgnew(ivol)

!c  compute root water uptake for current control volume
            if (root_uptake) then
              transp = cvol(ivol)*rootwat(sanew,ivol,rsum_vprop)
            else
              transp = r0
            end if

            soilevapo = r0
            if (root_uptake .or. pure_evap) then
              if (soilhydrfunc_field) then
                if (h1dry_vol(ivol).gt.r0) then
                  soilevapo = cvol(ivol)*evapo(sanew,ivol)
                end if
              else
                izn = mpropvs(ivol)
                if (h1dry(izn).gt.r0) then
                  soilevapo = cvol(ivol)*evapo(sanew,ivol)
                end if
              end if
            end if
          
            qroot = transp + soilevapo
            
            if (b_output_binary) then
              realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars)=(/xg(ivol),  &
                         yg(ivol),zout,fhead,phead,                    &
                         sanew(ivol),theta_a,sgnew(ivol),theta_g,      &
                         qroot,transp,soilevapo/)
            else
              write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                    fhead, phead,sanew(ivol),theta_a,                  &
                    sgnew(ivol),theta_g,qroot,transp,soilevapo
            end if
                                  
          end if ! fully saturated
          
        end do  !ivol = 1,nngl
        
        if(b_output_binary) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(igsp, size(realbuffer,1),           &
                         realbuffer, offset_igsp,b_output_mpiio_single)
          else
            call binary_subarray_initialize(nvars,b_mpiarray_igsp_init,&
                        .false.,mpiarray_filetype_igsp,                &
                        mpiarray_sizes_gbl_igsp,                       &
                        mpiarray_sizes_sub_igsp,mpiarray_starts_sub_igsp)
            call binary_write_data(igsp, size(realbuffer,1),           &
                         realbuffer, offset_igsp,mpiarray_filetype_igsp) 
          end if
          call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
          deallocate(realbuffer) 
        end if

      end if !ioutputdebug = 0

!c  This output includes pressure, density, and NAPL saturation
!c  doesn't provide identical files for easy comparison
!c   with non-density dependent test cases

      if (ioutdebug .eq. 1) then

!c  define number of variables
        if (fully_saturated) then
          if (heat_transport .or. temp_field) then 
            nvars = 15  
          else
            nvars = 11  
          end if
        else if (variably_saturated) then
          if (heat_transport .or. temp_field) then 
            if (evaporation) then
              nvars = 22  
            else
              nvars = 20  
            end if 
          else
            nvars = 16  
          end if
        end if

!c  title and variables

        if (tec_header) then
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsp, "#")
          end if
          
          if (b_output_binary) then
          
            strbuffer = 'dataset '//prefix(:l_prfx)//''
            !write tecplot title and header  
            offset_igsp = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igsp,   &
                         "#!TDV102", trim(strbuffer), offset_igsp,     &
                         b_output_mpiio_single,.false.)
          
          else
            write(igsp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          end if

          if (fully_saturated) then
            if (heat_transport .or. temp_field) then
              if (b_output_binary) then
                tec_variables(1:nvars) = [character(len=72) ::         &
                    "x", "y", "z", "fh_w", "p_w", "ph_w", "rho_w",     &
                    "s_a", "theta_a", "s_n", "theta_n", "temp_n",      &
                    "visco_n", "s_ice", "s_water"]
                
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                        igsp, nvars, tec_variables(1:nvars),           &
                        offset_igsp, b_output_mpiio_single,.false.)                   
              else 
                write(igsp,'(20a)') 'variables = "x", "y", "z",',      &
                                    ' "fh_w",',                        &
                                    ' "p_w",',                         &
                                    ' "ph_w",',                        &
                                    ' "rho_w",',                       &
                                    ' "s_a",',                         &
                                    ' "theta_a",',                     &
                                    ' "s_n",',                         &
                                    ' "theta_n",',                     &
                                    ' "temp_n",',                      &
                                    ' "visco_n",',                     &
                                    ' "s_ice",',                       &
                                    ' "s_water"'
              end if
            else 
              if (b_output_binary) then
                tec_variables(1:nvars) = [character(len=72) ::         &
                    "x", "y", "z", "fh_w", "p_w", "ph_w", "rho_w",     &
                    "s_a", "theta_a", "s_n", "theta_n"]
                
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                        igsp, nvars, tec_variables(1:nvars),           &
                        offset_igsp, b_output_mpiio_single,.false.) 
              else
                write(igsp,'(20a)') 'variables = "x", "y", "z",',        &
                                  ' "fh_w",',                            &
                                  ' "p_w",',                             &
                                  ' "ph_w",',                            &
                                  ' "rho_w",',                           &
                                  ' "s_a",',                             &
                                  ' "theta_a",',                         &
                                  ' "s_n",',                             &
                                  ' "theta_n"'
              end if          
            end if

          elseif (variably_saturated) then
           if (heat_transport .or. temp_field) then
              if (evaporation) then 
                if (b_output_binary) then  
                  tec_variables(1:22) = [character(len=72) ::          &
                                          "x", "y", "z", "fh_w", "p_w",&
                                          "ph_w", "rho_w", "s_a",      &
                                          "theta_a", "s_g", "theta_g", &
                                          "s_n", "theta_n", "q_root",  &
                                          "rootwat", "evapo",          &
                                          "temp_n", "visco_n", "rho_v",&
                                          "actw", "s_ice", "s_water"]
                  
                  call tecplot_binary_write_variable(Petsc_Comm_World, &
                               igsp, 22, tec_variables(1:22),          &
                               offset_igsp,b_output_mpiio_single,      &
                               .false.) 
                else
                  write(igsp,'(20a)') 'variables = "x", "y", "z",',    &
                                      ' "fh_w",',                      &
                                      ' "p_w",',                       &
                                      ' "ph_w",',                      &
                                      ' "rho_w",',                     &
                                      ' "s_a",',                       &
                                      ' "theta_a",',                   &
                                      ' "s_g",',                       &
                                      ' "theta_g",',                   &
                                      ' "s_n",',                       &
                                      ' "theta_n",',                   &
                                      ' "q_root",',                    &
                                      ' "rootwat",',                   &
                                      ' "evapo",',                     &
                                      ' "temp_n",',                    &
                                      ' "visco_n",',                   &
                                      ' "rho_v",',                     &
                                      ' "actw",',                      &
                                      ' "s_ice",',                     &
                                      ' "s_water"'
                end if
              else   
                if(b_output_binary) then
                  tec_variables(1:nvars) = [character(len=72) ::       &
                                          "x", "y", "z", "fh_w", "p_w",&
                                          "ph_w", "rho_w", "s_a",      &
                                          "theta_a", "s_g", "theta_g", &
                                          "s_n", "theta_n", "q_root",  &
                                          "rootwat", "evapo",          &
                                          "temp_n", "visco_n",         &
                                          "s_ice", "s_water"]
                  
                  call tecplot_binary_write_variable(Petsc_Comm_World, &
                               igsp, nvars, tec_variables(1:nvars),    &
                               offset_igsp,b_output_mpiio_single,      &
                               .false.) 
                else
                  write(igsp,'(20a)') 'variables = "x", "y", "z",',    &
                                ' "fh_w",',                            &
                                ' "p_w",',                             &
                                ' "ph_w",',                            &
                                ' "rho_w",',                           &
                                ' "s_a",',                             &
                                ' "theta_a",',                         &
                                ' "s_g",',                             &
                                ' "theta_g",',                         &
                                ' "s_n",',                             &
                                ' "theta_n",',                         &
                                ' "q_root",',                          &
                                ' "rootwat",',                         &
                                ' "evapo",',                           &
                                ' "temp_n",',                          &
                                ' "visco_n",',                         &
                                ' "s_ice",',                           &
                                ' "s_water"'
                end if
              end if
          else
            if (b_output_binary) then
              tec_variables(1:16) = [character(len=72) ::              &
                                      "x", "y", "z", "fh_w", "p_w",    &
                                      "ph_w", "rho_w", "s_a",          &
                                      "theta_a", "s_g", "theta_g",     &
                                      "s_n", "theta_n", "q_root",      &
                                      "rootwat", "evapo"]     
                                                                       
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsp, 16, tec_variables(1:16),offset_igsp,  &
                           b_output_mpiio_single,.false.) 
            else
              write(igsp,'(20a)') 'variables = "x", "y", "z",',        & 
                                ' "fh_w",',                            &
                                ' "p_w",',                             &
                                ' "ph_w",',                            &
                                ' "rho_w",',                           &
                                ' "s_a",',                             &
                                ' "theta_a",',                         &
                                ' "s_g",',                             &
                                ' "theta_g",',                         &
                                ' "s_n",',                             &
                                ' "theta_n",',                         &
                                ' "q_root",',                          &
                                ' "rootwat",',                         &
                                ' "evapo"'
            end if
          end if 
                                                                       
          end if
                                                                       
          if (.not.initial_condition) then
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
                call writeversion2file(ivel, "#")
            end if
        
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//''
              offset_ivel = 0
              call tecplot_binary_write_header(Petsc_Comm_World, ivel, &
                           "#!TDV102", trim(strbuffer), offset_ivel,   &
                           b_output_mpiio_single,.false.) 
              
              tec_variables(1:9) = [character(len=72) ::"x", "y", "z", &
                                    "qx", "qy", "qz", "vx", "vy","vz"] 
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           ivel, 9, tec_variables(1:9), offset_ivel,   &
                           b_output_mpiio_single,.false.)
            else
              write(ivel,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"' 
              write(ivel,'(2a)') 'variables = "x", "y", "z", ',        &
                               '"qx", "qy", "qz","vx", "vy", "vz"' 
            end if
            
            if (evaporation) then
!c  version information
              if (b_writeversion_tecplot .and. .not. b_output_binary) then
                  call writeversion2file(ivelvap, "#")
              end if
              
              if (b_output_binary) then                  
                strbuffer = 'dataset '//prefix(:l_prfx)//''
                offset_ivelvap = 0
                call tecplot_binary_write_header(Petsc_Comm_World,     &
                             ivelvap, "#!TDV102", trim(strbuffer),     &
                             offset_ivelvap,b_output_mpiio_single,     &
                             .false.) 
                
                tec_variables(1:9) = [character(len=72) ::"x","y","z", &
                                      "qx", "qy", "qz","vx", "vy","vz"] 
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                             ivelvap, 9, tec_variables(1:9),           &
                             offset_ivelvap,b_output_mpiio_single,     &
                             .false.)
              else
                write(ivelvap,'(3a)') 'title = "dataset ',             &
                      prefix(:l_prfx),'"'                               
                write(ivelvap,'(2a)') 'variables = "x", "y", "z", ',   &
                                 '"qx", "qy", "qz","vx", "vy", "vz"' 
              end if
            end if
          end if

        else
!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(igsp, "#")
          end if 

          write(igsp,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'

          if (fully_saturated) then

            write(igsp,'(20a)') '# variables = "x", "y", "z",',       &
                                ' "fh_w",',                           &
                                ' "p_w",',                            &
                                ' "ph_w",',                           &
                                ' "rho_w",',                          &
                                ' "s_a",',                            &
                                ' "theta_a"',                         &
                                ' "s_n",',                            &
                                ' "theta_n",'
                                                                       
          elseif (variably_saturated) then
                                                                       
            write(igsp,'(20a)') '# variables = "x", "y", "z",',       &
                                ' "h_w",',                            &
                                ' "p_w",',                            &
                                ' "ph_w",',                           &
                                ' "rho_w",',                          &
                                ' "s_a",',                            &
                                ' "theta_a",',                        &
                                ' "s_g",',                            &
                                ' "theta_g",',                        &
                                ' "s_n",',                            &
                                ' "theta_n",',                        &
                                ' "q_root",',                         &
                                ' "rootwat",',                        &
                                ' "evapo"'    
          end if

          if (.not.initial_condition) then
!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(ivel, "#")
            end if
        
            write(ivel,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(ivel,'(3a)') '# variables = "x", "y", "z", ',       &
                               '"qx", "qy", "qz","vx", "vy", "vz"'                      
            if (evaporation) then
!c  version information
              if (b_writeversion_tecplot ) then
                  call writeversion2file(ivelvap, "#")
              end if
            
              write(ivelvap,'(3a)') 'title = "dataset ',              &
     &              prefix(:l_prfx),'"'                                
              write(ivelvap,'(2a)') 'variables = "x", "y", "z", ',    &
     &                         '"qx", "qy", "qz","vx", "vy", "vz"' 
            end if 
          end if

        end if                    !(tec_header)

!c  zone record for initial condition
 
        if (initial_condition) then

          if (tec_header) then
              
            if (b_output_binary) then  
              strbuffer = 'Flow variables, initial condition'
              offset_igsp_temp = offset_igsp  
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsp = offset_igsp_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsp = offset_igsp_temp +                       &
                              (12+len_trim(strbuffer))*4  
              end if
            else    
              write(igsp,'(3(a,i5),a)')                                &
                    'zone t = "Flow variables, initial condition" i =',&
                    itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
                                                                       
          else
                                                                       
            write(igsp,'(3(a,i5),a)')                                 &
     &           '# zone t = "Flow variables, initial condition" i =',&
     &           itec,', j =',jtec,', k =',ktec,',  f=point'

          end if                   !(tec_header)

!c  zone record for current time step or steady state solution
!c  for fully saturated or variably saturated  conditions

        elseif (.not.initial_condition) then

          if (tec_header) then

            if (steady_flow) then
                
              if (b_output_binary) then
                strbuffer = 'Flow variables, steady state'
                offset_igsp_temp = offset_igsp
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp,trim(strbuffer),offset_igsp,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsp = offset_igsp_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp,trim(strbuffer),offset_igsp,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsp = offset_igsp_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
                
                strbuffer = 'velocities, steady state'
                offset_ivel_temp = offset_ivel
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer),offset_ivel,       &
                               itec_vel,jtec_vel,ktec_vel,             &
                               b_output_mpiio_single,                  &
                               .false.,b_output_multizone)              
                  offset_ivel = offset_ivel_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer),offset_ivel,       &
                               itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl, &
                               b_output_mpiio_single,                  &
                               .false.,b_output_multizone)              
                  offset_ivel = offset_ivel_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
                if (evaporation) then
                  strbuffer = 'velocities, steady state'
                  offset_ivelvap_temp = offset_ivelvap
                  
                  if (b_output_multizone) then
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,ivelvap,             &
                                 trim(strbuffer),offset_ivelvap,       &
                                 itec_vel,jtec_vel,ktec_vel,           &
                                 b_output_mpiio_single,                &
                                 .false.,b_output_multizone)                  
                    offset_ivelvap = offset_ivelvap_temp +             &
                                  (11+len_trim(strbuffer))*4*nprcs+4
                  else
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,ivelvap,             &
                                 trim(strbuffer),offset_ivelvap,       &
                                 itec_vel_gbl,jtec_vel_gbl,            &
                                 ktec_vel_gbl,                         &
                                 b_output_mpiio_single,                &
                                 .false.,b_output_multizone)                  
                    offset_ivelvap = offset_ivelvap_temp +             &
                                  (12+len_trim(strbuffer))*4
                  end if
                end if    
              else
                write(igsp,'(a,3(a,i5),a)')                            &
                      'zone t = "Flow variables, steady state" ',      &
                      'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
                                                                        
                write(ivel,'(a,3(a,i5),a)')                            &
                      'zone t = "velocities, steady state" ',          &
                      ', i =',itec_vel,                                &
                      ', j =',jtec_vel,                                &
                      ', k =',ktec_vel,',  f=point'
                                                                        
                if (evaporation) then                                    
                  write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')        &
                       'zone t = "velocities, steady state" ',         &
                       time_io, time_unit,                             &
                       '" i =',itec_vel,                               &
                       ', j =',jtec_vel,                               &
                       ', k =',ktec_vel,',  f=point'   
                end if
                
              end if

            elseif (transient_flow) then
                
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'Flow variables, solution time = ',              &
                    time_io,time_unit
                offset_igsp_temp = offset_igsp
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp, trim(strbuffer), offset_igsp,     &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsp = offset_igsp_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsp, trim(strbuffer), offset_igsp,     &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsp = offset_igsp_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
                
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'velocities, solution time = ', time_io,time_unit
                offset_ivel_temp = offset_ivel
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer),offset_ivel,       &
                               itec_vel,jtec_vel,ktec_vel,             &
                               b_output_mpiio_single,                  &
                               .false.,b_output_multizone)              
                  offset_ivel = offset_ivel_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs+4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               ivel,trim(strbuffer),offset_ivel,       &
                               itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl, &
                               b_output_mpiio_single,                  &
                               .false.,b_output_multizone)              
                  offset_ivel = offset_ivel_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
                
                if (evaporation) then
                  write(strbuffer,'(a,1pe15.6e3,1x,a)')                &
                        'velocities, solution time = ', time_io,       &
                        time_unit
                  offset_ivelvap_temp = offset_ivelvap
                  
                  if (b_output_multizone) then
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,ivelvap,             &
                                 trim(strbuffer),offset_ivelvap,       &
                                 itec_vel,jtec_vel,ktec_vel,           &
                                 b_output_mpiio_single,                &
                                 .false.,b_output_multizone)                  
                    offset_ivelvap = offset_ivelvap_temp +             &
                                  (11+len_trim(strbuffer))*4*nprcs+4
                  else
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,ivelvap,             &
                                 trim(strbuffer),offset_ivelvap,       &
                                 itec_vel_gbl,jtec_vel_gbl,            &
                                 ktec_vel_gbl,b_output_mpiio_single,   &
                                 .false.,b_output_multizone)                  
                    offset_ivelvap = offset_ivelvap_temp +             &
                                  (12+len_trim(strbuffer))*4
                  end if
                end if
              else
                write(igsp,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                  'zone t = "Flow variables, solution time = ',time_io,&
                  time_unit,'" i =',itec,', j =',jtec,', k =',ktec,    &
                  ',  f=point'
                                                                        
                write(ivel,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                      'zone t = "velocities, solution time = ',        &
                      time_io, time_unit,                              &
                      '" i =',itec_vel,                                &
                      ', j =',jtec_vel,                                &
                      ', k =',ktec_vel,',  f=point'
                                                                         
                if (evaporation) then                                    
                 write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')         &
                      'zone t = "velocities, solution time = ',        &
                      time_io, time_unit,                              &
                      '" i =',itec_vel,                                &
                      ', j =',jtec_vel,                                &
                      ', k =',ktec_vel,',  f=point'   
                end if
              end if

            end if

          else

            if (steady_flow) then

              write(igsp,'(a,3(a,i5),a)')                               &
     &            '# zone t = "Flow variables, steady state solution" ',&
     &            'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
                                                                         
              write(ivel,'(a,3(a,i5),a)')                              &
     &            '# zone t = "velocities, steady state" ',            &
     &            ', i =',itec_vel,                                    &
     &            ', j =',jtec_vel,                                    &
     &            ', k =',ktec_vel,',  f=point'
                                                                         
              if (evaporation) then                                      
               write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')           &
     &             '# zone t = "velocities, steady state" ',           &
     &              time_io, time_unit,                                &
     &              '" i =',itec_vel,                                  &
     &              ', j =',jtec_vel,                                  &
     &              ', k =',ktec_vel,',  f=point'                   
              end if
                                                                         
            elseif (transient_flow) then
                                                                         
              write(igsp,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
     &           '# zone t = "Flow variables, solution time = ',time_io,&
     &            time_unit,'" i =',itec,', j =',jtec,', k =',ktec,     &
     &           ',  f=point'
                                                                         
              write(ivel,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
     &              '# zone t = "velocities, solution time = ',        &
     &              time_io, time_unit,                                &
     &              '" i =',itec_vel,                                  &
     &              ', j =',jtec_vel,                                  &
     &              ', k =',ktec_vel,',  f=point'
                                                                         
              if (evaporation) then                                      
               write(ivelvap,'(a,1pe15.6e3,1x,a,3(a,i5),a)')           &
     &             '# zone t = "velocities, solution time = ',         &
     &              time_io, time_unit,                                &
     &              '" i =',itec_vel,                                  &
     &              ', j =',jtec_vel,                                  &
     &              ', k =',ktec_vel,',  f=point'   
              end if

            end if         

          end if                  !(tec_header)
        end if                    !(initial_condition)

!c  ---------------------------------------------------------------------
!c  output outputdd format - fluid pressures, densities, and 
!c  NAPL saturatons reported
!c  ---------------------------------------------------------------------
        if (b_output_binary) then
            
          offset_igsp_temp = offset_igsp          
         
          call tecplot_binary_write_section(Petsc_Comm_World,        &
                       igsp,nvars,nn_offset,offset_igsp,             &
                       b_output_mpiio_single,.false.,                &
                       b_output_multizone)
          
          allocate(realbuffer(nvars*nn), stat = ierr)
          call checkerr(ierr,'outputdd-realbuffer',ilog)
          realbuffer = 0.0d0
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
          
          if (.not.initial_condition) then
            offset_ivel_temp = offset_ivel
            call tecplot_binary_write_section(Petsc_Comm_World,ivel,9, &
                         nn_interfacial_offset,offset_ivel,            &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            if (evaporation) then
              offset_ivelvap_temp = offset_ivelvap
              call tecplot_binary_write_section(Petsc_Comm_World,      &
                           ivelvap,9,nn_interfacial_offset,            &
                           offset_ivelvap,b_output_mpiio_single,       &
                           .false.,b_output_multizone)
            end if
          end if
           
        end if
        
!c  loop over control volumes
        ivol_l = 0
        
        do ivol = 1,nngl
            
!c  skip ghost nodes
#ifdef PETSC
          if (node_idx_lg2l(ivol) < 0) then
              cycle
          end if 
#endif
          ivol_l = ivol_l + 1
          
!c  calculate pressure and freshwater heads
          phead = uvsnew(ivol)/(density(ivol) * gacc)
          fhead = phead * density(ivol)/ref_dens + zg(ivol)


!c  assign depth coordinate in terms of depth or elevation

          zout = zoutput(depth_output,zg(ivol),elevmax)

          theta_a = pornew(ivol) * sanew(ivol)
          theta_n = pornew(ivol) * snnew(ivol)

!c  calculate ice and water saturation when freezing/thawing are considered
          if ((heat_transport .or. temp_field) .and. b_water_freezing) then
            if (tempnew(ivol)+tconv > pressure_melt_k(ivol,r0)) then
              s_ice = r0
              s_water = sanew(ivol)
            else
              s_ice = sanew(ivol)
              s_water = r0              
            end if
          else
            s_ice = r0
            s_water = sanew(ivol)
          end if          

          if (fully_saturated) then
            if (heat_transport .or. temp_field) then 
              if (b_output_binary) then
                realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/       &
                                    xg(ivol),yg(ivol),zout,fhead,      &
                                    uvsnew(ivol), phead,               &
                                    density(ivol),sanew(ivol),theta_a, &
                                    snnew(ivol),theta_n ,tempnew(ivol),&
                                    viscosity(ivol),s_ice,s_water/)
              else
                write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                      fhead, uvsnew(ivol), phead, density(ivol),       &
                      sanew(ivol),theta_a, snnew(ivol),theta_n ,       &
                      tempnew(ivol),viscosity(ivol),s_ice,s_water
              end if
            else
              if (b_output_binary) then
                realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/       &
                                    xg(ivol),yg(ivol),zout,fhead,      &
                                    uvsnew(ivol), phead,               &
                                    density(ivol),sanew(ivol),theta_a, &
                                    snnew(ivol), theta_n/)  
              else  
                write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                      fhead, uvsnew(ivol), phead, density(ivol),       &
                      sanew(ivol), theta_a, snnew(ivol), theta_n
              end if
            end if                                                        
          elseif (variably_saturated) then
                                                                         
            sgnew(ivol) = r1 - sanew(ivol)                               
            theta_g = pornew(ivol)*sgnew(ivol) 

!c  compute root water uptake for current control volume
            if (root_uptake) then
              transp = cvol(ivol)*rootwat(sanew,ivol,rsum_vprop)
            else
              transp = r0
            end if

            soilevapo = r0
            if (root_uptake .or. pure_evap) then
              if (soilhydrfunc_field) then
                if (h1dry_vol(ivol).gt.r0) then
                  soilevapo = cvol(ivol)*evapo(sanew,ivol)
                end if
              else
                izn = mpropvs(ivol)
                if (h1dry(izn).gt.r0) then
                  soilevapo = cvol(ivol)*evapo(sanew,ivol)
                end if
              end if
            end if
          
            qroot = transp + soilevapo

            if (reactive_transport) then                                 
              actw = gamma(nc,ivol)                                      
            else                                                         
              actw = r1                                                  
            end if

            if (heat_transport .or. temp_field) then                                     
              if (evaporation) then  
                if (b_output_binary) then
                  realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/     &
                                  xg(ivol),yg(ivol),zout,fhead,        &
                                  uvsnew(ivol), phead,                 &
                                  density(ivol), sanew(ivol),          &
                                  theta_a,sgnew(ivol),theta_g,         &
                                  snnew(ivol),theta_n,                 &
                                  qroot,transp,soilevapo,              &
                                  tempnew(ivol),viscosity(ivol),       &
                                  densvnew(ivol),actw,s_ice,s_water/)
                else
                  write(igsp,ascii_fmt)                                &
                                  xg(ivol),yg(ivol),zout,fhead,        &
                                  uvsnew(ivol), phead,                 &
                                  density(ivol), sanew(ivol),          &
                                  theta_a,sgnew(ivol),theta_g,         &
                                  snnew(ivol),theta_n,                 &
                                  qroot,transp,soilevapo,              &
                                  tempnew(ivol),viscosity(ivol),       &
                                  densvnew(ivol),actw,s_ice,s_water
                end if
              else
                if (b_output_binary) then
                  realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/           &
                                  xg(ivol),yg(ivol),zout,fhead,        &
                                  uvsnew(ivol), phead,                 &
                                  density(ivol), sanew(ivol),          &
                                  theta_a,sgnew(ivol),theta_g,         &
                                  snnew(ivol),theta_n,                 &
                                  qroot,transp,soilevapo,              &
                                  tempnew(ivol),viscosity(ivol),       &
                                  s_ice,s_water/)
                else
                  write(igsp,ascii_fmt)                                &
                                  xg(ivol),yg(ivol),zout,fhead,        &
                                  uvsnew(ivol), phead,                 &
                                  density(ivol), sanew(ivol),          &
                                  theta_a,sgnew(ivol),theta_g,         &
                                  snnew(ivol),theta_n,                 &
                                  qroot,transp,soilevapo,              &
                                  tempnew(ivol),viscosity(ivol),       &
                                  s_ice,s_water
                end if                                                                         
              end if                                                     
            else
              if (b_output_binary) then
                realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars) = (/       &
                                    xg(ivol),yg(ivol),zout,fhead,      &
                                    uvsnew(ivol), phead,               &
                                    density(ivol), sanew(ivol),theta_a,&
                                    sgnew(ivol),theta_g,               &
                                    snnew(ivol),theta_n,               &
                                    qroot,transp,soilevapo/)
              else
                write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                      fhead, uvsnew(ivol), phead, density(ivol),       &
                      sanew(ivol), theta_a, sgnew(ivol), theta_g,      &
                      snnew(ivol),theta_n,qroot,transp,soilevapo
              end if
            end if                                                       
          end if !fully_saturated
                                                                        
        end do ! ivol = 1,nngl
        
        if(b_output_binary) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(igsp, size(realbuffer,1),           &
                         realbuffer, offset_igsp,b_output_mpiio_single) 
          else
            call binary_subarray_initialize(nvars,b_mpiarray_igsp_init,&
                        .false.,mpiarray_filetype_igsp,                &
                        mpiarray_sizes_gbl_igsp,                       &
                        mpiarray_sizes_sub_igsp,                       &
                        mpiarray_starts_sub_igsp)
            call binary_write_data(igsp, size(realbuffer,1),           &
                        realbuffer, offset_igsp, mpiarray_filetype_igsp)
          end if
          call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
          deallocate(realbuffer) 
        end if
                                                                         
      end if !ioutputdebug = 1
                                                                         
      if (.not.initial_condition) then

        iprint = 1
                                                                         
        call velodd (nvxgl, nvygl, nvzgl, iavs, javs, cinfvs_a, dimcv, &
                     xg, yg, zg, uvsnew, density, viscosity,           &
                     relperm, idbg, ilog,ivel, fully_saturated,        &
                     njavs, nngl, nn, half_cells, pornew, sanew, delt, &
                     courant_max, courant_num, iprint, time_io,        &
                     cinfrad,radial_coord,offset_ivel)
                                                                         
        if (evaporation) then                                             
          call velovapour(ivelvap,nvxgl,nvygl,nvzgl,iavs,javs,         &
                           cinfevap_pa,                                &
                          cinfevap_t,dimcv,xg,yg, zg,uvsnew,tempnew,   &
                          densvnew,density,idbg,ilog,ivel,njavs,nngl,  &
                          nn,half_cells,pornew,sgnew,cinfrad,          &
                          radial_coord,ups_heat,split_divdensv,        &
                          offset_ivelvap) 
        end if  

      end if     

!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
      if(b_output_binary) then
        call binary_file_close(igsp,b_output_mpiio_single) 
        if (.not.initial_condition) then
          call binary_file_close(ivel,b_output_mpiio_single) 
        end if
      else
        close(igsp)
        if (.not.initial_condition) then
          close(ivel)
        end if
      end if
      
      !Keep the file unit, this will be used later
      !call lun_free(igsp)
      !call lun_free(ivel)
      
      if ((.not.initial_condition) .and. evaporation) then
          if(b_output_binary) then
             call binary_file_close(ivelvap,b_output_mpiio_single) 
          else
            close(ivelvap)
          end if
          !Keep the file unit, this will be used later
          !call lun_free(ivelvap)
      end if
      
      if (issplitdens) then
        if(b_output_binary) then
          call binary_file_close(idens,b_output_mpiio_single)  
        else
          close(idens)
        end if
        !Keep the file unit, this will be used later
        !call lun_free(idens)
      end if
       
      if (b_output_binary) then
        call memory_monitor(-sizeof(tec_variables),'tec_variables',.true.)
        deallocate(tec_variables)
      end if

      return
      end
