!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 880 $
!> $Author: dsu $
!> $Date: 2024-02-19 14:19:39 -0800 (Mon, 19 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/solvsg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine solvsg
!c -----------------
!c
!c solve gas bubble equation (sum gas pressures - hydrodynamic pressure = zero) using 
!c newtons method
!c
!c written by:      Rich Amos - February 16, 2004
!c
!c last modified:   - Rich Amos - February 16, 2004
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:       real*8
!c             -------
!c             tot_press                = hydrodynamic pressure (atm)    + *
!c            ivol                    = counter (nodes)                - *
!c
!c common:
!c gen.f       real*8:
!c             -------
!c             sgnew(nn)          = gaseous phase saturation            - +         
!c                                  (new time level)
!c
!c bbls.f        real*8
!c             -------
!c            tot_gas(ig,ivol)    = total concentration of gas in        - -
!c                                  the aqueous and gas phases
!c            k_henry(ig,ivol)    = henry's law constant for gas(i)->gas pair(i)    - -
!c
!c                                
!c
!c chem.f:   integer
!c          -------
!c           ng                 = number of gases                        - - 
!c           rgasatm            = ideal gas constant                    - - 
!c                                [liter atm/(deg K mole)]
!c           tkel(ivol)         = nodal temperatures in Kelvin            - - 
!c
!c local      real*8
!c           ------
!c          sg_old                = value of sg at beginning of newton loop    - *
!c          gas_pressure            = gas pressure for each gas assuming all
!c                                  gas is in aqueous phase                    - *
!c          d_gas_pressure        = derivative of gas_pressure                - *
!c          sum_gas_pressure        = sum of the gas pressure, equal to the total 
!c                                  gas pressure                                - *
!c          sum_d_gas_pressure    = total of the derivative of the gas pressure
!c                                  for newton calculation                    - *
!c          gas_tol                = tolerance for newton iterations            - -
!c          res_tol                = residual tolerance for newton iteration   - - 
!c
!c          initeger
!c          --------
!c          ig                 = counter (gases)                                
!c
!c          logical
!c          -------
!c          converged             = true - newton convergence criteria met
!c 
!c--------------------------------------------------------------------
    subroutine solvsg (ivol,tot_press,sgsolve_failed)

    use parm
    use gen
    use bbls
    use chem
#ifdef PETSC
    use petsc_mpi_common, only : petsc_mpi_finalize
#endif
    
    implicit none
    
    integer :: ivol
    real*8 :: tot_press
    
    logical :: converged,sgsolve_failed
    
    integer :: ig, sg_count
    real (type_r8) :: sg_old
    real (type_r8) :: sg_new
    real (type_r8) :: sg_update
    real (type_r8) :: gas_pressure
    real (type_r8) :: d_gas_pressure
    real (type_r8) :: sum_gas_pressure        
    real (type_r8) :: sum_d_gas_pressure
    
    real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r100=100d0
    
    converged = .false.
    sgsolve_failed = .false.
    
    sg_count=0
    
!c initial guess at sgnew

    do while ((.not.converged).and.(.not.sgsolve_failed))

      sg_old = (r1-sanew(ivol))

      sum_d_gas_pressure = r0
      sum_gas_pressure = -tot_press

      do ig=1,ng

!c calculate gas pressure

        gas_pressure = tot_gas(ig,ivol)/((1-sg_old)*k_henry(ig,ivol) + &
                       sg_old/rgasatm/tkel(ivol))
                 
!c calculate derivative of gas pressure 
!cdsu checked on 2024-02-18, reference symbolic derivative available at
!cdsu https://www.codesansar.com/online-calculator/derivative.htm
        d_gas_pressure = -tot_gas(ig,ivol)/(((1-sg_old)*               &
              k_henry(ig,ivol)+sg_old/rgasatm/tkel(ivol))**2)*         &
              (-k_henry(ig,ivol)+1/rgasatm/tkel(ivol))

!c sum gas pressure and derivative

        sum_gas_pressure = sum_gas_pressure + gas_pressure
        sum_d_gas_pressure = sum_d_gas_pressure + d_gas_pressure

      end do 
!c
!c calculate new value for Sg
        
      sanew(ivol)=r1-(sg_old - sum_gas_pressure/sum_d_gas_pressure)
      
!cdsu add control to avoid unphysical value
      if (sanew(ivol) > r1) then
        sanew(ivol) = r1
      else if (sanew(ivol) < r0) then
        sanew(ivol) = r0
      end if

      sg_new = r1-sanew(ivol)
      sg_update = sg_new - sg_old

      if ((dabs(sg_update).lt.gas_tol).and.                            &
          (dabs(sum_gas_pressure).lt.res_tol)) then
        converged = .true.
      end if

      sg_count=sg_count+1

      if (sg_count.gt.sg_count_max .and. .not.converged) then
        sgsolve_failed = .true. 
        if (rank == 0) then  
          write (ilog,'(2(a,1x,i0,1x),a,1x,l1)')                       &
                'bubble solution not convergent, iter',sg_count,       &
                'max_iter',sg_count_max,'converged',converged
          write (ilog,'(a,i6,4(1x,a,1x,e13.6))') 'volume', ivol,       &
                'sg_update',sg_update,'tolerance',gas_tol,             &
                'sum_gas_pressure',sum_gas_pressure,'tolerance',res_tol
          write (ilog,'(a)') 'reduce timestep'
      
          write (*,'(2(a,1x,i0,1x),a,1x,l1)')                          &
                'bubble solution not convergent, iter',sg_count,       &
                'max_iter',sg_count_max,'converged',converged
          write (*,'(a,i6,4(1x,a,1x,e13.6))') 'volume', ivol,          &
                'sg_update',sg_update,'tolerance',gas_tol,             &
                'sum_gas_pressure',sum_gas_pressure,'tolerance',res_tol
          write (*,*) 'reduce timestep'
        end if
        !pause
      end if

    end do

    end
