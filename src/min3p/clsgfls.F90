!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/clsgfls.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine clsgfls
!c ------------------------
!c
!c close I/O files (global system)
!c
!c written by:      Uli Mayer - May 8, 96
!c
!c last modified:   Uli Mayer - November 14, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           ifls               = unit number, file information       + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, log file               + -
!c           idbg               = unit number, debugging file         + -
!c           idelt              = unit mumber, magnitude of current   + -
!c                                             time step
!c           itmp               = unit number, temporary storage      + -
!c           icnv               = unit number, data conversion        + -
!c           icdbs              = unit number, database for           + -
!c                                             components
!c           igdbs              = unit number, database gases         + -
!c           imdbs              = unit number, database for minerals  + -
!c           irdbs              = unit number, database for redox     + -
!c                                             couples
!c           ixdbs              = unit number, database for           + -
!c                                             secondary species in
!c                                             water phase
!c           imrt               = unit number, mass balance -         + -
!c                                             reactive transport
!c           imrt_first         = pointer - first unit number for     + -
!c                                mass balance - reactive transport
!c           imrt_last          = pointer - last unit number for      + -
!c                                mass balance - reactive transport
!c           imvs               = unit number, mass balance -         + -
!c                                             variably saturated
!c                                             flow
!c           imvs_first         = pointer - first unit number for     + -
!c                                mass balance - variably saturated
!c                                               flow
!c           imvs_last          = pointer - last unit number for      + -
!c                                mass balance - variably saturated
!c                                               flow
!c           igbt               = unit number, total aqueous          + -
!c                                             component
!c                                             concentrations
!c                                             - transient data
!c                                               global system
!c           igbre              = unit number, total concentration    + -
!c                                             of radioelement
!c                                             - transient data
!c                                               global system
!c           igbb               = unit number, concentrations of      + -
!c                                             sorbed species
!c                                             - transient data
!c                                               global system
!c           igbc               = unit number, free species and       + -
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - transient data
!c                                               global system
!c           igbd               = unit number, dissolution-           + -
!c                                             precipitation
!c                                             rates
!c                                             - transient data
!c                                               global system
!c           igbg               = unit number, gas concentrations     + -
!c                                             - transient data
!c                                               global system
!c           igbgr              = unit number, degassing rates        + -
!c                                             - transient data
!c                                               global system
!c           igbm               = unit number, master variables       + -
!c                                             - transient data
!c                                               global system
!c           igbi               = unit number, rates of intra-aqueous + -
!c                                             kinetic reactions
!c                                             - transient data
!c                                               global system
!c           igbs               = unit number, saturation indices     + -
!c                                             - transient data
!c                                               global system
!c           igbv               = unit number, mineral volume         + -
!c                                             fractions
!c                                             - transient data
!c                                               global system
!c           igbx               = unit number, saturation indices     + -
!c                                             excluded minerals
!c                                             - transient data
!c                                               global system
!c           logical:
!c           --------
!c           extended_output_gs = .true.  -> extended output of       + -
!c                                           contour data for
!c                                           reaction-transport
!c                                           simulation
!c                                .false. -> basic output of
!c                                           contour data for
!c                                           for reaction-transport
!c                                           simulation
!c           geo_chemistry      = .true.  -> local or background and  + -
!c                                           source chemistry
!c           gb_output          = .true.  -> output of transient data + -
!c           gs_output          = .true.  -> output of contour data   + -
!c           log_file           = .true.  -> write log file           + -
!c           mass_balance_rt    = .true.  -> compute mass balance     + -
!c                                           (reactive tramsport
!c           mass_balance_vs    = .true.  -> compute mass balance     + -
!c                                           (variably saturated
!c                                            flow)
!c           reactive_transport = .true.  -> perform reactive         + -
!c                                           transport simulation
!c           
!c chem.f:   integer*4:
!c           ----------
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           logical:
!c           --------
!c           noncompetitive_sorption = logical array for activation   + -   
!c                                     of noncompetitive sorption
!c                                     reactions
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c local:    - 
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine clsgfls

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use chem
      use file_unit, only : lun_free
      use module_binary_mpiio, only : binary_file_close
      use mip_bubble, only : mip_mt_enable
      use nobleGasIngrowth, only : b_use_ngi, ngre_i, ingdbs
      use biol

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif


      integer :: igb

!c  close files
   
!c  run specific input file
 
      close(idat)
      call lun_free(idat)
 
!c  file information
      if (rank == 0 .and. b_enable_output) then
        close(ifls)
        call lun_free(ifls)
      end if
 
!c  generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        close(igen)
        call lun_free(igen)
      end if
 
!c  debugging file
#ifdef DEBUG 
      if (b_enable_output) then
        close(idbg)
        call lun_free(idbg)
      end if
#endif

!c  log file

      if (log_file .and. rank == 0) then
        close(ilog)
        call lun_free(ilog)
      end if
      
!c  root uptake related
      if (root_uptake) then
        close(isoi)
      endif

!c  magnitude of current time step
      if(rank == 0 .and. b_enable_output) then
        if (idetail_vs.gt.0 .and. transient_flow .or.                  &
            idetail_rt.gt.0) then
          close(idelt)
          call lun_free(idelt)
        end if
      end if
 
!c  close and delete scratch file 
 
      close(icnv,status='delete')
      close(itmp,status='delete')
      call lun_free(icnv)
      call lun_free(itmp)
 
!c  database files for geochemistry
 
      if (geo_chemistry) then
        close(icdbs)
        close(ixdbs)
        close(imdbs)
        close(irdbs)
        close(igdbs)      
        if (b_use_ngi) then
          close(ingdbs)
        end if  
        call lun_free(icdbs)
        call lun_free(ixdbs)
        call lun_free(imdbs)
        call lun_free(irdbs)
        call lun_free(igdbs)
        if (issit) then 
          close(isitdbs)
          call lun_free(isitdbs)
        end if
        call lun_free(ingdbs)
      end if
 
!c  mass balance files

      if(rank == 0 .and. b_enable_output) then            !By rank 0
 
        if (mass_balance_vs) then
          do imvs = imvs_first,imvs_last
            close(imvs)
            call lun_free(imvs)
          end do
        end if

        if (mass_balance_rt) then
          if (root_uptake) then
            close(iresp)
            call lun_free(iresp)

            close(irup)
            call lun_free(irup)
          end if


          if (b_dilution_index) then
            close(idix)
            call lun_free(idix)
          end if

          if (b_spatial_moment) then
            close(ispm)
            call lun_free(ispm)
          end if

          if (nrcm_tz > 0) then
            close(irupcm)
            call lun_free(irupcm)
          end if

          do imrt = imrt_first,imrt_last
            close(imrt)
            call lun_free(imrt)
          end do
        end if
      
        if (flux_out) then
          do imcd = imcd_first,imcd_last
            close(imcd)
            call lun_free(imcd)
          end do
        end if
      
        if (energy_balance) then
          do imheat = imheat_first,imheat_last
            close(imheat)
            call lun_free(imheat)
          end do
        end if
      
      end if                    !By rank 0
 
!c  transient data (global system)

      if (evaporation.and.write_evap_info) then  
        if(rank == 0 .and. b_enable_output) then 
          if (b_output_trans_binary) then
#ifdef PETSC
            call binary_file_close(ievap,.true.)
#endif    
          else
            close(ievap)
            call lun_free(ievap)
          end if
        end if
      end if 

 
      if (reactive_transport) then
        if (gb_output .and. b_enable_output) then
          if (b_output_trans_binary) then
#ifdef PETSC 
            do igb = 1,ngb
              if (ngb_vol(igb) < 0) then
                cycle
              end if
                
              if (transient_flow) then              
                call binary_file_close(igbp_mpi(igb),.true.)
              end if
              
              call binary_file_close(igbt_mpi(igb),.true.)
              call binary_file_close(igbc_mpi(igb),.true.)
              call binary_file_close(igbm_mpi(igb),.true.)

              if (ng.gt.0) then
                call binary_file_close(igbg_mpi(igb),.true.)
                if (gas_removal) then
                  call binary_file_close(igbgr_mpi(igb),.true.)
                end if
              end if
              
              if ((naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) .or. &
                  naq.gt.0) then
                call binary_file_close(igbi_mpi(igb),.true.)
              end if

              if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.                    &
                      noncompetitive_sorption) then
                call binary_file_close(igbb_mpi(igb),.true.)
              end if
              if (nm.gt.0) then
                call binary_file_close(igbd_mpi(igb),.true.)
                call binary_file_close(igbs_mpi(igb),.true.)
                call binary_file_close(igbv_mpi(igb),.true.)
              end if
              if (nmx.gt.0) then
                call binary_file_close(igbx_mpi(igb),.true.)
              end if
              
              if (iso_output) then
                call binary_file_close(igbis_mpi(igb),.true.)
              end if
                
              if (b_output_activity) then
                call binary_file_close(igbac_mpi(igb),.true.) 
              end if

              if (mip_mt_enable) then
                call binary_file_close(igbmip_mpi(igb),.true.)  
              end if

              if (root_uptake) then
                call binary_file_close(igbroot_mpi(igb),.true.)
              end if

!cdsu concentration of radioelement related to noble gas ingrowth
              if (b_use_ngi .and. ngre_i > 0) then
                call binary_file_close(igbre_mpi(igb),.true.)
              end if
            
            end do
#endif
          else  
            do igb = 1,ngb 
              if (ngb_vol(igb) < 0) then
                cycle
              end if
                
              call tranunit(igb)
              
              if (transient_flow) then              
                  close(igbp)
                  call lun_free(igbp)
              end if
              
              close(igbt)
              call lun_free(igbt)

              close(igbc)
              call lun_free(igbc)
              
              if (b_output_activity) then
                close(igbac)
                call lun_free(igbac)
              end if

              if (ph_output .or. pe_output) then
                close(igbm)
                call lun_free(igbm)
              end if

              if (ng.gt.0) then
                close(igbg)
                call lun_free(igbg)
                if (gas_removal) then
                  close(igbgr)
                  call lun_free(igbgr)
                end if
              end if
              if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then
                close(igbi)
                call lun_free(igbi)
              end if
              if (naq.gt.0) then
                close(igbi)
                call lun_free(igbi)
              end if
              if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.                    &
                      noncompetitive_sorption) then
                close(igbb)
                call lun_free(igbb)
              end if
              if (nm.gt.0) then
                close(igbd)
                close(igbs)
                close(igbv)
                call lun_free(igbd)
                call lun_free(igbs)
                call lun_free(igbv)
              end if
              if (nmx.gt.0) then
                close(igbx)
                call lun_free(igbx)
              end if
              
              if (iso_output) then
                close (igbis)
                call lun_free(igbis)
              end if

              if (mip_mt_enable) then
                close (igbmip)
                call lun_free(igbmip)
              end if

              if (root_uptake) then
                close (igbroot)
                call lun_free(igbroot)
              end if

!cdsu concentration of radioelement related to noble gas ingrowth
              if (b_use_ngi .and. ngre_i > 0) then
                close(igbre)
                call lun_free(igbre)
              end if
            
            end do          
          end if
        end if
      end if
 
      return
      end
