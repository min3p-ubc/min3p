!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/updtsvmp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updtsvmp
!c -------------------
!c
!c update secondary variables in mineral phase
!c
!c written by:      Uli Mayer - March 12, 96
!c
!c last modified:   Tom Henderson - June 1, 2006
!c                  Change phiinit(nm) to phi_init(nm,nn)
!c                  pass ivol to this subroutine
!c                  gcreact passes ivol = 0
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           aream(nm)          = specific reactive surface area of   + +
!c                                mineral im
!c                                [m^2 mineral/L bulk]      
!c                                (surface controlled reactions)
!c                                reactivity term 
!c                                [m mineral/m^3 bulk]
!c                                (transport controlled reactions)
!c           area_init(nm,nvol) = initial reactive surface area       + -
!c           cmnewm(nm)         = concentration of minerals           + +
!c                                - new time level [moles/l bulk]
!c           cmoldm(nm)         = concentration of minerals           + -
!c                                - old time level [moles/l bulk]
!c           deltsv             =  current time step                  + -
!c           phim(nm)           = volume fraction of minerals         + + 
!c           ratem(nm)          = absolute dissolution precipitation  + -
!c                                rates of minerals 
!c                                [moles/(m^3 bulk * day)]
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           cmcmin(nm,nthreads)= min. concentration of minerals      + -
!c                                [moles/l bulk]
!c           expphi(nm)         = exponent for reactive surface area  + -
!c                                update
!c           phi_init(nm,nvol)  = initial volume fraction of minerals + -
!c           phinuc(nm)         = volume fractions of mineral for     * +
!c                                nucleation threshold
!c           phinucthrd(nm,nvol)=volume fractions of mineral for      * -
!c                                nucleation threshold
!c           areanucthrd(nm,nn) = reference area for the the specified nucleation threshold
!c                                (global system)!
!c           scalfac(nm)        = scaling factor                      + -
!c           radi(nm)           = initial radius of mineral grain     + -
!c           rads(nm,nthreads)  = radius of unreacted core of mineral * +
!c                                grain
!c           totratem(nm,nthreads)
!c                              = combined dissolution-precipitation  * *
!c                                rate
!c
!c           integer*4:
!c           ----------
!c           iamp(nm+1)         = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c           jamp(nm)           = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c           nm                 = number of minerals                  + -
!c
!c           character:
!c           ----------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           update_type(im)    = type of surface area update         + -
!c                                'constant'  = constant reactive
!c                                              surface area
!c                                'geometric' = geometric reactive
!c                                              surface area update
!c
!c local:    real*8: 
!c           -------
!c           ratio              = ratio between new and old mineral 
!c                                concentrations
!c           r0                 = constant
!c           r1                 = constant
!c           r2                 = constant
!c           r3                 = constant
!c           r1000              = constant [L/m^3]
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           im                 = counter
!c           im2                = counter
!c           istart             = pointer
!c           istop              = pointer
!c          
!c
!c external: distmp   = distribute mineralogical parameters
!c ----------------------------------------------------------------------
 
      subroutine updtsvmp(cmnewm,cmoldm,phim,aream,ratem,satindex,deltsv,ivol,tid)
 
      use parm
      use chem
      use gen

      implicit none
      
      real*8 :: cmnewm, cmoldm, phim, aream, ratem, satindex, deltsv
      integer :: ivol, tid
      
      integer :: i1, im, im2, info_dbg, istart, istop
      real*8 :: ratio, rtemp, tpvf, ratio_por
       
      dimension cmnewm(*),cmoldm(*),phim(*),aream(*),ratem(*), satindex(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0,         &
                 r3 = 3.0d0, r1000 = 1.0d3, rzero = 1.0d-11      
     
      real*8 :: phimfrac_min, phimfrac_max, phimfrac, area_min, area_max
      integer :: phimfrac_min_im, phimfrac_max_im, area_min_im, area_max_im
      
      external distmp
      
      phimfrac_min = 1.0E30
      phimfrac_max = -1.0E30      
      area_min = 1.0E30
      area_max = -1.0E30
      ratio = 0.0d0
       
      info_dbg = 0
            
      do im = 1,nm
 
!c  exclude dependent minerals

       if (iamp(im+1)-iamp(im).gt.0) then

!c  recompute radius of unreacted core from old time level 
!c  for update of geometric surface area

          if (update_type(im).eq.'geometric') then

            if (rate_control(im).eq.'surface') then

              rads(im,tid) = scalfac(im) * r3 * phim(im)/aream(im)/   &
                             r1000

            elseif (rate_control(im).eq.'transport') then

              if (ivol .gt. 0) then
                rads(im,tid) = aream(im) * radi(im)**r3               &
     &                 / (r3 * scalfac(im) * phi_init(im,ivol)        &
     &                 +  aream(im) * radi(im)**r2)
              end if
            end if                  !reaction(type(im)

          end if                    !update_type(im)

!c  combine reaction rates to update mineralogical parameters
          istart = iamp(im)
          istop = iamp(im+1)-1
          totratem(im,tid) = r0
          do i1 = istart,istop
            im2 = jamp(i1)
            totratem(im,tid) = totratem(im,tid) + ratem(im2)
          end do

!c  update mineral concentrations in [moles/l bulk]
 
          cmnewm(im) = dmax1(cmoldm(im)+totratem(im,tid)*deltsv,      &
                       cmcmin(im,tid))

!c  compute ratio of new and old mineral concentration
 
          ratio = cmnewm(im)/cmoldm(im)
 
!c  update volume fractions of minerals
 
          if (.not. pore_clogging) then
              
            phim(im) = ratio*phim(im)
          else
!c            cm_init(im,ivol) = 1000.d0 * phi_init(im,ivol) *       &
!c                               densm(im) / gfwm(im)
            phim(im) = cmnewm(im) * gfwm(im)/(densm(im)*1000.0d0)
          end if
       

        end if            !exclusion of dependent minerals

      end do              !loop over minerals

!c  distribute mineralogical parameters
   
      call distmp(cmnewm,phim,aream,tid)
      
!c sung-wook's (Dec. 8/2003)
!c  calculate total carbonate volume fraction

      tpvf = 0

      do im = 1,nm
        if(sur_prec(im))then
          tpvf = tpvf+alph_prec(im)*phim(im)
        end if
      end do

!c  update reactive surface areas/effective reaction rates

      do im = 1,nm

         if (update_type(im).eq.'geometric') then

          rads(im,tid) = (ratio*(rads(im,tid)**r3))**(r1/r3)
 
          if (rate_control(im).eq.'surface') then

!c  surface controlled reactions
!c
!c  update reactive surface area for next time level
!c  aream(im) is in units [m^2 mineral/L bulk]

            aream(im) = r3 * scalfac(im) * phim(im)/rads(im,tid)/r1000

!c  transport controlled reactions
!c
!c  update reactivity term for next time level
!c  aream(im) is in units [m mineral/m^3 bulk] 

          elseif (rate_control(im).eq.'transport') then

            aream(im) = r3 * scalfac(im) * phim(im) / rads(im,tid)    &
     &                  * radi(im) / ((radi(im)-rads(im,tid)) *       &
     &                  rads(im,tid))

          end if           !rate_control(im)

        elseif (update_type(im).eq.'twothird') then

!c  update reactive surface area for two-thirds power relationship
          if (ivol .gt. 0) then
            aream(im) = area_init(im,ivol)*(phim(im)/phi_init(im,ivol))**(r2/r3)
          end if
          
        elseif (update_type(im).eq.'twothird-mix') then

!c  old deprecated code
!c  update reactive surface area for two-thirds-mix power relationship
!c  when phi_o < the threshold value, use the initialize area
!c          if (ivol .gt. 0) then
!c            if(phi_init(im,ivol) > phinucthrd(im, ivol)) then
!c                aream(im) = area_init(im,ivol)*(phim(im)/phi_init(im,ivol))**(r2/r3)
!c            else
!c                aream(im) = area_init(im,ivol)
!c            end if
!c          end if

!c  new code, update type same as Crunchflow twothird power relation.
!c  Update reactive surface area for two-thirds-mix power relationship
!c  different from twothird-mix, this type consider reaction direction.
!c  For primary mineral (those initially with a volume fraction > phinucthrd(im)), it
!c  uses twothird power relation for dissolution, but initialize area for precipitation.
!c  Formula of dissolution reaction: Area = Area_init*(phim(im)/phim_init(im))^(r2/r3)
!c  Formula of precipitation reaction: Area = Area_init
!c  For secondary mineral (those initially with a volume fraction <= phinucthrd(im)), it
!c  uses twothird power relation for dissolution, but initialize area for precipitation.
!c  Formula of dissolution reaction: Area = Area_init*(phim(im))^(r2/r3)
!c  Formula of precipitation reaction: Area = Area_init

!c  When porosity update is used, an additional term (pornew/porinit)^(r2/r3) is applied
          if (ivol .gt. 0) then

            !c save twothird porosity change ratio
            if (update_porosity .and. im == 1) then
              ratio_por = (pornew(ivol)/por_init(ivol))**(r2/r3)
            end if

            !c primary minerals
            if(phi_init(im,ivol) > phinucthrd(im, ivol)) then
              !c dissolution reaction, here satindex = IAP/Ksp, not log10(IAP/Ksp)
              if (satindex(im) < r1) then
                aream(im) = area_init(im,ivol)*(phim(im)/phi_init(im,ivol))**(r2/r3)
              !c precipitation reaction
              else
                aream(im) = area_init(im,ivol)
              end if
            !c secondary minerals
            else
              !c dissolution reaction, here satindex = IAP/Ksp, not log10(IAP/Ksp)
              if (satindex(im) < r1) then
                aream(im) = area_init(im,ivol)*(phim(im))**(r2/r3)
              !c precipitation reaction
              else
                aream(im) = area_init(im,ivol)
              end if
            end if

            if (update_porosity) then
              aream(im) = aream(im)*ratio_por
            end if
          end if
!c sung-wook's (Dec. 8/2003)
        elseif (update_type(im).eq.'reactivity') then
          if (ivol .gt. 0) then
!c  update reactive surface area for reactivity decrease (jeen et al 2007)
            aream(im) = areainit(im) * (exp(-tpvf))
          end if
          
        elseif (update_type(im).eq.'exponent') then
                                                                      
!c  update reactive surface area for user-specified power relationship 
          if (ivol .gt. 0) then                                        
            aream(im) = area_init(im,ivol)*(phim(im)/phi_init(im,ivol))**expphi(im)
          end if
                                                                       
        elseif (update_type(im).eq.'exponent2') then
                                                                      
!c  THH May 2006 - Uli Mayer formulation
                                                                       
          if (ivol .gt. 0) then
                                                                       
             rtemp = -expphi(im) * (phi_init(im,ivol)-phim(im))/phi_init(im,ivol)
#ifdef DEBUG
           if (info_dbg .gt. 0) then
             write(idbg,'(es12.4,2i6,5es12.4)') deltsv,ivol,im,rtemp, &
     &           expphi(im),phi_init(im,ivol),phim(im) 
           end if
#endif                                                       
            aream(im) = area_init(im,ivol)*exp(rtemp)

          end if
          
        elseif (update_type(im).eq.'linear') then
!c  Update reactive surface area for linear relationship with mass
!c  This part is initially for the simulation of concrete-clay benchmarking.
!c  In PHREEQC, they use R = S*m*k to update the rate, here we use R = S’ * phi/phi_o,
!c  where phi_o is the volume fraction. This won’t work if phi_0 = 0, or if phi becomes 0.
!c  We define a mineral mass nucleation threshold and calculate a reference surface area S’ 
!c  for this nucleation threshold.This is different from current formulation. 
!c  The current formulation defines the reference surface area based on the initial mineral mass. 
!c  Below the nucleation threshold, we can use this reference surface area to define a constant S’, 
!c  above the surface area is larger, linearly scaled with phi/phi_nuc: 
!c  How to use: set update type to 'linear' and define the value of nucleation threshold, e.g., 1.0E-7
!c    'mineral input'   
!c    0.20      .false. 'linear'  ;phim, minequil, update_type  - calcite               
!c    1.d-10    100.0    0.00d0    1.0d-7    ;phimin, areanuc, supsatm, phinuc          !reference area = 100 * 1.0d-7 / 0.20   
!c    1.0d-10  .false. 'linear'  ;phim, minequil, update_type  - dolomite
!c    1.d-10    200.0    0.00d0    1.0d-7    ;phimin, areanuc, supsatm, phinuc          !reference area, use the next with volume fraction > 0 instead
!c    ....                                                                              !  /
!c    0.15  .false. 'linear'  ;phim, minequil, update_type  - dolomite                  !/
!c    1.d-10    200.0    0.00d0    1.0d-7    ;phimin, areanuc, supsatm, phinuc          !reference area = 200 * 1.0d-7 / 0.15
!c  Note 
!c  DSU, 2013-2-16
          if (ivol .gt. 0) then

            if (phim(im) < phinucthrd(im, ivol)) then
                aream(im) = areanucthrd(im,ivol)                                     ! S' = area * phinuc / phi_init, area = initial area to the specified phi_init (>0)
            else
                aream(im) = areanucthrd(im,ivol) * phim(im) / phinucthrd(im, ivol)   ! S" = S' * phim / phinuc
            end if
            
            !if (aream(im) / area_init(im,ivol) > 10 .and. aream(im) > 1) then
            !    write(ilog, "(2(a, i4),10(a, 1pe15.6e3))") "ivol:", ivol, " im:", im,  &
            !    " phim:", phim(im), " phi_init:", phi_init(im, ivol), &
            !    " aream:", aream(im), " aream/area_init:",  (aream(im) / area_init(im,ivol))
            !end if

          end if 

        end if             !update_type(im)

      end do               !loop over minerals
     
      return
      end
