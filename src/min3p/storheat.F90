!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/storheat.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c real*8 function storheat
!c ------------------------
!c ----------------------------------------------------------------------
 
      real*8 function storheat(delt1,delt2,tempnew,tempold,satwnew,satwold,densnew,  &
                                densold,densnewc,densoldc,tdsnew,tdsold,drhodtds,drhodt, &
                                denssolid,pornew,porold,cw,cs,ispitzerdens,isnonlindens, &
                                cdens1,cdens2,cdens3,cdens4)            
      
      
      implicit none 
      
      real*8, intent(in)    ::  delt1
      
      real*8, intent(in)    ::  delt2
      
      real*8, intent(in)    ::  tempnew
      
      real*8, intent(in)    ::  tempold
      
      real*8, intent(in)    ::  satwnew
      
      real*8, intent(in)    ::  satwold
      
      real*8, intent(in)    ::  densnew
      
      real*8, intent(in)    ::  densold
      
      real*8, intent(in)    ::  densoldc
      
      real*8, intent(in)    ::  densnewc
      
      real*8, intent(in)    ::  tdsnew
      
      real*8, intent(in)    ::  tdsold
      
      real*8, intent(in)    ::  drhodtds
      
      real*8, intent(in)    ::  drhodt
      
      real*8, intent(in)    ::  pornew
      
      real*8, intent(in)    ::  porold
      
      real*8, intent(in)    ::  cw
      
      real*8, intent(in)    ::  cs
      
      logical, intent(in)   ::  ispitzerdens
      
      logical, intent(in)   ::  isnonlindens
   
      real*8, intent(in)    ::  denssolid
      
      real*8, intent(in)    ::  cdens1
      
      real*8, intent(in)    ::  cdens2
      
      real*8, intent(in)    ::  cdens3
      
      real*8, intent(in)    ::  cdens4
            
      real*8, parameter      :: r1=1.0d0, &
                                rkelvin=273.15d0, &
                                r1000=1.0d3
      
      real*8                 :: term1, &
                                term2, &
                                term3, &
                                term4, &
                                term5, &
                                temp1, &
                                temp2, &
                                drho_c, &
                                drho_t 
   
 term1=(cw*satwnew*densnew-cs*denssolid)*(pornew-porold)/delt1
        
 if (ispitzerdens) then  
    drho_c = (densnewc-densoldc)/delt2
 else
    drho_c = drhodtds*(tdsnew-tdsold)/delt2
 end if
                
 if (isnonlindens) then
    temp1 = tempold + rkelvin
    temp2 = tempnew + rkelvin
    drho_t = cdens1+r1000*temp1*(cdens2+temp1*(cdens3-temp1*cdens4))          
    drho_t = (cdens1+r1000*temp2*(cdens2+temp2*(cdens3-temp2*cdens4))-drho_t)/delt1
 else        
    drho_t = drhodt*(tempnew-tempold)/delt1 
 end if
               
 term2 = cw*pornew*satwnew*(drho_c+drho_t)
        
 term5 = cw*pornew*densnew*(satwnew-satwold)/delt1
 
 term3=(term1+term2+term5)*tempnew
 
 term4=(cw*densnew*pornew*satwnew+(r1-pornew)*cs*denssolid)*(tempnew-tempold)/delt1
 
 storheat = term3 + term4
      
 return
 end
