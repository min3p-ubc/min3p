!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/dratemin_salinity.F90 $
!---------------------------------------------------------------------
!********************************************************************!

    subroutine dratemin_salinity(totc,c, sar, sarinc, im, ivol, tid)

      use chem
      use gen, only : idbg, rank, b_enable_output, ilog
     
      implicit none
      
      integer :: im, ivol, tid
      integer :: i, ic
      integer :: info_debug
      
      real*8 :: totc, c, ratem      
      real*8 :: prodrc, prodrcinc
      real*8 :: salinity, sar
      real*8 :: salinityinc, sarinc
      real*8 :: a, b

      dimension c(*),totc(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      real, parameter  :: pi = 3.141592653589793d0
      
      !This is not needed when interface is declared
      !external raoult     
    
!c Calculate the salinity dependent mineral reaction rate coefficient f_s
!c  modify the ratem

      if (salinity_dependent(im)) then
        salinity = 0.0
        salinityinc = 0.0
        do ic = 1, nc-1
          if (namec(ic) .ne. 'o2(aq)') then
            salinity = salinity + gfwc(ic)*totc(ic)
            salinityinc = salinityinc + gfwc(ic)*totcinc(ic,tid)
          end if
        end do
          
        if (sdtype(im) .eq. 'equation') then
          sar = 0.0d0
          sarinc = 0.0d0
            
          if ((salinity .le. min_salinity(im)) .or. &
              (salinityinc .le. min_salinity(im))) then
            sar = min_sar(im)
            sarinc = min_sar(im)
          else if (salinity .ge. max_salinity(im) .or. & 
                   salinityinc .ge. max_salinity(im)) then
            sar = max_sar(im)
            sarinc = max_sar(im)
          else
            do i = 1, nfac(im)
              sar = sar + sfac_sdmin(im,i)*(salinity**(i-1))
              sarinc = sarinc + sfac_sdmin(im,i)*(salinityinc**(i-1))
            end do
          end if 
             
!c The strong inhibition of salinity on the sulfur water formation can be expresssed as cosine function
!c When the level of salinity is high enough, the reaction rate is completely blocked.
!c The consine function f=f(totc(ic)) is normalized to provide a coefficient sar or sarinc between 0 and 1.0.
!c the function f=(cos(a*x+b)+1)/2
!c a and b is determined by providing the x values when f=0 and 1 from the input file.


        else if (sdtype(im) .eq. 'strong inhibition by one component') then
          sar = 0.0d0
          sarinc = 0.0d0

          !c min_salinity and max_salinity below actually represent concentration bounds.
          !c It is better to rename to avoid confusing with salinity.
          if ((totc(inamec_inhib(im)) .le.  min_salinity(im)) .or.  &
              (totcinc(inamec_inhib(im),tid) .le.  min_salinity(im))) then
            sar = 1.0d0
            sarinc = 1.0d0
          else if ((totc(inamec_inhib(im)) .ge. max_salinity(im)) .or.  &
                   (totcinc(inamec_inhib(im),tid) .ge. max_salinity(im))) then
            sar = 0.0d0
            sarinc = 0.0d0
          else
            a=0.0d0
            b=0.0d0
            a = 180/(max_salinity(im) - min_salinity(im))
            b = - min_salinity(im) * a
            sar = (cos(pi/180*(a*totc(inamec_inhib(im))+b))+1.0d0)/2.0d0
            sarinc = (cos(pi/180*(a*totcinc(inamec_inhib(im),tid)+b))+1.0d0)/2.0d0              
          end if 

        end if
          
        if ((sar .lt. 0.0 .or. sar .gt. 1.0) .or.  &
            (sarinc .lt. 0.0 .or. sarinc .gt. 1.0)) then
            
          if (rank == 0 .and. b_enable_output) then
            write(ilog,'(4a)') 'In file dratemin_salinity: ',      &
                  'error calculating salinity dependent ',         &
                  'factor of mineral  ',namem(im)
            write(ilog,'(a,1pe15.6e3)') 'The salinity = ',salinity
            write(ilog,'(a,1pe15.6e3)') 'The salinityinc = ',salinityinc
            write(ilog,'(a,1pe15.6e3)') 'The coefficient sar = ',sar
            write(ilog,'(a,1pe15.6e3)') 'The coefficient sarinc = ',sarinc
            write(ilog,*) 'It should be between 0.0 to less or equal 1.0.'
            do ic = 1, nc-1
              write(ilog,'(3a,1pe15.6e3)') 'The totc(', namec(ic),') = ',totc(ic)
              write(ilog,'(3a,1pe15.6e3)') 'The totcinc(', namec(ic),') = ',totcinc(ic,tid)
            end do
          end if

          stop

        end if

      end if 
      
#ifdef DEBUG
      info_debug = 0
      if (rank == 0 .and. b_enable_output .and. info_debug.gt.0 .and. (ivol .eq. 2 &
            .or. ivol .eq. 4 .or. ivol .eq. 8) .and. im .eq. 1 .and. sar .gt. 0.0) then
        write(ilog,'(a,i6)') 'ivol = ',ivol
        write(ilog,'(a,i6)') 'im = ',im
        write(ilog,'(2a)') 'The component is ',namec(inamec_inhib(im))
        write(ilog,'(a,1pe15.6e3)') 'The salinity = ',salinity
        write(ilog,'(a,1pe15.6e3)') 'The Cl- concentration = ',totc(inamec_inhib(im))
        write(ilog,'(a,1pe15.6e3)') 'The coefficient sar = ',sar
        write(ilog,'(a,1pe15.6e3)') 'The coefficient ratem = ',ratem
      end if
      if (info_debug.eq.1) then
        !pause
      end if
#endif
      return
    
end subroutine

    
