!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readsorb.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readsorb
!c -------------------
!c
!c read database for sorbed species and assign to permanent storage
!c
!c written by:      Uli Mayer - July, 5, 98
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           isdbs              = unit number, database for           + -
!c                                             sorbed species
!c           ipsp               = unit number, list of possible       + -
!c                                             secondary aqueous 
!c                                             species, gases,
!c                                             minerals and sorbed 
!c                                             species
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number debugging file          + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           chargesb(nsb)      = charge of sorbed species            * +
!c           chargesb_ion(nsb_ion)   = charge of sorbed species       * +
!c                                     (ion-exchange)
!c           chargesb_surf(nsb_surf) = charge of sorbed species       * +
!c                                     (surface-complex)
!c           dhcsb(nsb)         = enthalpy change for sorbed species  * +
!c           dhcsb_ion(nsb_ion) = enthalpy change for sorbed species  * +
!c                                of ion-exchange
!c           dhcsb_surf(nsb_surf)= enthalpy change for sorbed species * +
!c                                 of surface-complex
!c           eqsbs(nsb)         = equilibrium constants for           * +
!c                                formation of sorbed species
!c                                from primary species
!c                                at standard temperature
!c           eqsbs_ion(nsb_ion) = equilibrium constants for           * +
!c                                formation of sorbed species
!c                                from primary species
!c                                at standard temperature 
!c                                (ion-exchange)
!c           eqsbs_surf(nsb_surf)= equilibrium constants for          * +
!c                                formation of sorbed species
!c                                from primary species
!c                                at standard temperature 
!c                                (surface-complex)
!c           gfwsb(nsb)         = gram formula weight of sorbed       * +
!c                                species
!c           gfwsb_ion(nsb_ion)  = gram formula weight for sorbed     * +
!c                                   species
!c           gfwsb_surf(nsb_surf)= gram formula weight for sorbed     * +
!c                                   species
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   * +
!c                                for formation of sorbed species
!c                                from primary species
!c
!c           integer*4:
!c           ----------
!c           iasb(nsb+1)        = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              * +
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (surface-complex)
!c           jasb(nsb*nc)       = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            * +
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          * +
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (surface-complex)
!c           nc                 = number of components including h2o + -
!c           nsb                = number of sorbed species           + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c 
!c           logical:
!c           --------
!c           search_database    = .true.  -> search database for      + -
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c           namet(30)          = species names of (temporary)        * *
!c
!c local:    real*8:
!c           -------
!c           charge             = charge (temporary)
!c           dhc                = enthalpy change (temporary)
!c           eqt                = log equilibrium constant 
!c                                (temporary)
!c           gfw                = gram formula weight (temporary)
!c           xnusbt(iv)         = stoichiometric coefficient of 
!c                                component in sorbed species
!c                                (temporary)
!c
!c           integer*4:
!c           ----------
!c           nv                 = number of components with 
!c                                non-zero stoichiometric 
!c                                coefficient in sorbed species
!c                                (temporary)
!c           ic                 = counter (components)
!c           isb                = counter (sorbed species)
!c           icount             = counter (check number of species)
!c           iv                 = counter (number of components
!c                                with non-zero stoichiometric
!c                                coefficient in sorbed species
!c           icur               = counter (position in single
!c                                subscripted array)
!c           istart             = pointer
!c           iend               = pointer
!c           i                  = counter
!c           info_debug         = flag controlling debugging output
!c           l_name             = length of name
!c
!c           logical:
!c           --------          
!c           done               = logical variable to stop search
!c           found              = logical variable to stop search
!c
!c           character:
!c           ----------
!c           name               = name of current sorbed species
!c                                (temporary)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readsorb(isdbs,ipsp,ilog,idbg,igen)
 
      use parm
      use chem
      use gen, only : rank, b_enable_output, idbs_bk, use_dbs_bk
      use file_utility, only : makelowercase, replacecharacter,        &
                               readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      integer :: isdbs,ipsp,ilog,idbg,igen
      
      integer :: i, ic, icount, icur, isb, istart, iend, iv, isites,   &
                 info_debug, l_name, nv
      
      real*8 :: dhc, eqt, charge, gfw, xnusbt

      character*72 name
      character*1024 :: strbuffer
      character*1, parameter :: strspace = ' '
      dimension xnusbt(100)
      logical done,found

!c  search database for possible sorbed species

      if (search_database) then

        if (rank == 0 .and. b_enable_output) then  
          write(ipsp,'(/a)') 'sorbed species'
          write(ipsp,'(a/)') '--------------'
        end if
        
        do i = 1,10000
          if (space_delimiter_dbs) then
            read(isdbs,'(a)',end=996,err=999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)

            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 999
            end if
            name = strbuffer(1:iend-1)

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=996,err=999) dhc

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=996,err=999) eqt

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=996,err=999) charge

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=996,err=999) gfw

            !c next line
            read(isdbs,'(a)',end=996,err=999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 996
            end if

            read(strbuffer,*,end=996,err=999) nv

            do iv = 1, nv
              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              namet(iv) = strbuffer(1:iend-1)

              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=996,err=999) xnusbt(iv)
            end do
          else
            read(isdbs,*,end=996,err=999) name,dhc,eqt,charge,gfw
            read(isdbs,*,end=996,err=999) nv,(namet(iv),xnusbt(iv),iv=1,nv)
          end if

!c  check if all components with non-stoichiometric coefficients in
!c  sorbed species are specified in general input file

          icount = 0
          ic = 0
          do while ((icount.lt.nv).and.(ic.lt.nc))
            ic = ic+1
            iv = 0
            found = .false.
            do while ((iv.lt.nv).and.(.not.found))
              iv = iv+1
              if (namet(iv).eq.namec(ic)) then
                found = .true.
                icount = icount+1
              end if
            end do
          end do

!c  report all possible sorbed species
     
          if (icount.eq.nv) then
             l_name = index(name,' ')-1
             if (l_name.gt.72.or.l_name.eq.-1) then
               l_name = 72
             end if
             if (rank == 0 .and. b_enable_output) then
               write(ipsp,'(3a)') "'",name(:l_name),"'"
             end if
          end if

        end do             !loop over species in database

996     continue

!c  rewind database file

        rewind(isdbs)

      end if               !search_database
      
!c  sorbed species of ion-exchange

      if (nsb_ion > 0) then

!c  initialize row pointer array for sparse matrix structure

      iasb_ion(1) = 1
 
!c  loop over sorbed species specified for simulation
 
      do isb = 1,nsb_ion
 
!c  loop over sorbed species in database,
!c  search for match and assign data to permanent storage
!c  exit when done or when end of file is reached
 
        done = .false.
 
        do while (.not.done)
 
!c  read name of sorbed species and species specific data 

          if (space_delimiter_dbs) then
            read(isdbs,'(a)',end=997,err=999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 997
            end if
            name = strbuffer(1:iend-1)

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=997,err=999) dhc

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=997,err=999) eqt

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=997,err=999) charge

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=997,err=999) gfw

            !c next line
            read(isdbs,'(a)',end=997,err=999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 997
            end if

            read(strbuffer,*,end=997,err=999) nv

            do iv = 1, nv
              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              namet(iv) = strbuffer(1:iend-1)

              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=997,err=999) xnusbt(iv)
            end do
          else
            read(isdbs,*,end=997,err=999) name,dhc,eqt,charge,gfw
            read(isdbs,*,end=997,err=999) nv,(namet(iv),xnusbt(iv),iv=1,nv)
          end if

!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  sorbed species is found --> assign to permanent storage
 
          if (name.eq.namesb_ion(isb)) then
 
            done = .true.
 
!c  pointer array to row in stoichiometric reaction matrix for
!c  next sorbed species
 
            iasb_ion(isb+1) = iasb_ion(isb)+nv
 
!c  check if all components with non-stoichiometric coefficients in
!c  sorbed species are specified in general input file
!c  set up pointer array to column in stoichiometric matrix
 
            icount = 0
            ic = 0
            do while ((icount.lt.nv).and.(ic.lt.nc))
              ic = ic+1
              iv = 0
              found = .false.
              do while ((iv.lt.nv).and.(.not.found))
                iv = iv+1
                if (namet(iv).eq.namec(ic)) then
                  found = .true.
                  icount = icount+1
                  icur = iasb_ion(isb)+iv-1
                  jasb_ion(icur) = ic

                  do isites = 1,nsites
                    if (ic == iaic(isites)) then
                      ion2isite(isb) = isites
                      exit
                    end if
                  end do

                end if
              end do
            end do
 
!c  exit, if component is missing
 
            if (icount.ne.nv) then
              if (rank == 0) then  
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(a,a12,a)')'component for ',               &
     &                               name,' is missing'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
!c  all components available --> assign data to permanent storage
 
            elseif (icount.eq.nv) then

!cdhr - corrected April 06
              if (dhc_reverse) then
                dhcsb_ion(isb) = dhc
              else
                dhcsb_ion(isb) = -dhc
              end if
              eqsbs_ion(isb) = 10.0d0**(-eqt)
              chargesb_ion(isb) = charge
              gfwsb_ion(isb) = gfw
              
 
!c  stoichiometric coefficients
 
              istart = iasb_ion(isb)
              iend = iasb_ion(isb+1)-1
              iv = 0
              do i = istart,iend
                iv = iv+1
                xnusb_ion(i) = xnusbt(iv)
              end do
            end if
 
          end if               !(name.eq.namesb(isb))

        end do                 !end - loop over database
 
!c  rewind database for sorbed species to search for next 
!c  species, doing this allows the specification of species in an 
!c  arbitray order
 
        rewind(isdbs)
 
      end do                   !end - loop over species
      
      end if                   !end, sorbed species of ion-exchange
      
!c  sorbed species of surface-complex

      if (nsb_surf > 0) then

!c  initialize row pointer array for sparse matrix structure

      iasb_surf(1) = 1
 
!c  loop over sorbed species specified for simulation
 
      do isb = 1,nsb_surf
 
!c  loop over sorbed species in database,
!c  search for match and assign data to permanent storage
!c  exit when done or when end of file is reached
 
        done = .false.
 
        do while (.not.done)
 
!c  read name of sorbed species and species specific data 
          if (space_delimiter_dbs) then
            read(isdbs,'(a)',end=998,err=999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 999
            end if
            name = strbuffer(1:iend-1)

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=998,err=999) dhc

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=998,err=999) eqt

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=998,err=999) charge

            strbuffer = trim(adjustl(strbuffer(iend:)))
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=998,err=999) gfw

            !c next line
            read(isdbs,'(a)',end=997,err=999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 997
            end if

            read(strbuffer,*,end=998,err=999) nv

            do iv = 1, nv
              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              namet(iv) = strbuffer(1:iend-1)

              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=998,err=999) xnusbt(iv)
            end do
          else
            read(isdbs,*,end=998,err=999) name,dhc,eqt,charge,gfw
            read(isdbs,*,end=998,err=999) nv,(namet(iv),xnusbt(iv),iv=1,nv)
          end if

!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  sorbed species is found --> assign to permanent storage
 
          if (name.eq.namesb_surf(isb)) then
 
            done = .true.
 
!c  pointer array to row in stoichiometric reaction matrix for
!c  next sorbed species
 
            iasb_surf(isb+1) = iasb_surf(isb)+nv
 
!c  check if all components with non-stoichiometric coefficients in
!c  sorbed species are specified in general input file
!c  set up pointer array to column in stoichiometric matrix
 
            icount = 0
            ic = 0
            do while ((icount.lt.nv).and.(ic.lt.nc))
              ic = ic+1
              iv = 0
              found = .false.
              do while ((iv.lt.nv).and.(.not.found))
                iv = iv+1
                if (namet(iv).eq.namec(ic)) then
                  found = .true.
                  icount = icount+1
                  icur = iasb_surf(isb)+iv-1
                  jasb_surf(icur) = ic

                  do isites = 1,nsites
                    if (ic == iaic(isites)) then
                      isurf2isite(isb) = isites
                      exit
                    end if
                  end do

                end if
              end do
            end do
 
!c  exit, if component is missing
 
            if (icount.ne.nv) then
              if (rank == 0) then  
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(a,a12,a)')'component for ',               &
     &                               name,' is missing'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
!c  all components available --> assign data to permanent storage
 
            elseif (icount.eq.nv) then

!cdhr - corrected April 06
              if (dhc_reverse) then
                dhcsb_surf(isb) = dhc
              else
                dhcsb_surf(isb) = -dhc
              end if

              eqsbs_surf(isb) = 10.0d0**(-eqt)
              chargesb_surf(isb) = charge
              gfwsb_surf(isb) = gfw
              
 
!c  stoichiometric coefficients
 
              istart = iasb_surf(isb)
              iend = iasb_surf(isb+1)-1
              iv = 0
              do i = istart,iend
                iv = iv+1
                xnusb_surf(i) = xnusbt(iv)
              end do
            end if
 
          end if               !(name.eq.namesb(isb))

        end do                 !end - loop over database
 
!c  rewind database for sorbed species to search for next 
!c  species, doing this allows the specification of species in an 
!c  arbitray order
 
        rewind(isdbs)
 
      end do                   !end - loop over species
      
      end if                   !end, sorbed species of surface-complex

!cdsu write warning information for sign switch in the value of enthaply change
      if ((nsb_ion > 0 .or. nsb_surf > 0) .and. dhc_reverse) then
        if (rank == 0 .and. b_enable_output) then
          write(ilog,'(72a)') ('-',i=1,72)
          write(ilog,'(2a)') 'warning: enthalpy change for',           &
                             ' sorbed species is reversed'
          write(ilog,'(72a)') ('-',i=1,72)

          write(igen,'(72a)') ('-',i=1,72)
          write(igen,'(2a)') 'warning: enthalpy change for',           &
                             ' sorbed species is reversed'
          write(igen,'(72a)') ('-',i=1,72)
        end if
      end if

 
!cdbg ---- activate this section for purposes of debugging -----
#ifdef DEBUG
      info_debug = 0
      if (info_debug.gt.0) then

        !c ion-exchange
        do isb=1,nsb_ion
          write(idbg,'(a,i3,2x,a72)') 'isb    = ',isb,namesb_ion(isb)
          write(idbg,'(a,f10.4)') 'dhcsb_ion(isb)     = ',dhcsb_ion(isb)
          write(idbg,'(a,f10.4)') 'eqsbs_ion(isb)     = ',dlog10(eqsbs_ion(isb))
          write(idbg,'(a,f10.4)') 'chargesb_ion(isb)  = ',chargesb_ion(isb)
          write(idbg,'(a,f10.4)') 'gfwsb_ion(isb)     = ',gfwsb_ion(isb)
          write(idbg,'(a,i10)') 'iasb_ion    ',iasb_ion(isb)
 
!c   echo check for stoichiometric coefficients
 
          istart = iasb_ion(isb)
          iend = iasb_ion(isb+1)-1
          do i = istart, iend
            icur = jasb_ion(i)
            write(idbg,'(i5,2x,a72,a,i5,a,f10.3)') i,namec(icur),         &
                       ' jasb_ion ',jasb_ion(i),' xnusb_ion ',xnusb_ion(i)
          end do
          write(idbg,*)
          write(idbg,*) '----------------------------------------------'
          write(idbg,*)
        end do
        
        !c surface-complex
        do isb=1,nsb_surf
          write(idbg,'(a,i3,2x,a72)') 'isb    = ',isb,namesb_surf(isb)
          write(idbg,'(a,f10.4)') 'dhcsb_surf(isb)     = ',dhcsb_surf(isb)
          write(idbg,'(a,f10.4)') 'eqsbs_surf(isb)     = ',dlog10(eqsbs_surf(isb))
          write(idbg,'(a,f10.4)') 'chargesb_surf(isb)  = ',chargesb_surf(isb)
          write(idbg,'(a,f10.4)') 'gfwsb_surf(isb)     = ',gfwsb_surf(isb)
          write(idbg,'(a,i10)') 'iasb_surf    ',iasb_surf(isb)
 
!c   echo check for stoichiometric coefficients
 
          istart = iasb_surf(isb)
          iend = iasb_surf(isb+1)-1
          do i = istart, iend
            icur = jasb_surf(i)
            write(idbg,'(i5,2x,a72,a,i5,a,f10.3)') i,namec(icur),         &
                       ' jasb_surf ',jasb_surf(i),' xnusb_surf ',xnusb_surf(i)
          end do
          write(idbg,*)
          write(idbg,*) '----------------------------------------------'
          write(idbg,*)
        end do
        
        if (info_debug.gt.1) then
#ifdef PETSC
          call petsc_mpi_finalize
#endif 
          stop
        end if

      end if
#endif

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(*,'(1x,a)') 'start of database backup: sorption.dbs'
          write(idbs_bk, '(a)') '<------ sorption.dbs: start of sorbed species ------>'      
          do isb = 1,nsb_ion
            rewind(isdbs)
            do while(.true.)
              if (readnextline(isdbs, strbuffer, lowercase=.false.,        &
                  original=.true.)) then
                if (index(adjustl(strbuffer),trim(namesb_ion(isb))) == 2) then
                  write(idbs_bk,'(a)') trim(strbuffer)
                  if (readnextline(isdbs, strbuffer, lowercase=.false.,    &
                      original=.true.)) then
                    write(idbs_bk,'(a)') trim(strbuffer)
                  end if
                  exit
                end if
              end if
            end do
          end do

          do isb = 1,nsb_surf
            rewind(isdbs)
            do while(.true.)
              if (readnextline(isdbs, strbuffer, lowercase=.false.,        &
                  original=.true.)) then
                if (index(adjustl(strbuffer),trim(namesb_surf(isb))) == 2) then
                  write(idbs_bk,'(a)') trim(strbuffer)
                  if (readnextline(isdbs, strbuffer, lowercase=.false.,    &
                      original=.true.)) then
                    write(idbs_bk,'(a)') trim(strbuffer)
                  end if
                  exit
                end if
              end if
            end do
          end do
          rewind(isdbs)
          !write(idbs_bk, '(a)') "'end'"
          write(idbs_bk, '(a/)') '<------ sorption.dbs: end of sorbed species ------>'
          write(*,'(1x,a)') 'end of database backup: sorption.dbs'
        end if
      end if
 
      goto 1000

!c  end of file is reached --> exit 
 
997   continue
      if (rank == 0) then
        write(ilog,'(72a)') ('-',i=1,72)
        write(ilog,'(a,a12,a)')                                        &
     &        'sorbed species ',namesb_ion(isb),' not in database'
        write(ilog,'(72a)') ('-',i=1,72)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop
      
998   continue
      if (rank == 0) then
        write(ilog,'(72a)') ('-',i=1,72)
        write(ilog,'(a,a12,a)')                                        &
     &        'sorbed species ',namesb_surf(isb),' not in database'
        write(ilog,'(72a)') ('-',i=1,72)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(isdbs)
      read(isdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in sorbed species database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in sorbed species database: ',trim(strbuffer)
        close(ilog)
      end if

#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
  
