!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/icbcrt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine icbcrt
!c -----------------
!c
!c assign initial or boundary condition to global system 
!c (reactive transport)
!c
!c written by:      Uli Mayer - May 14, 96
!c
!c last modified:   Tom Henderson - June 1, 2006
!c                  No overwrite of phi_init matrix for initial nodal
!c                  mineral volume fractions
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           ivol               = pointer (control volume)            + -
!c           imin               = 0 -> initial condition              + -
!c                                     assign all species               
!c                                1 -> boundary condition 
!c                                     assign only aqueous and
!c                                     gaseous species
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           area(nm,nn)        = specific reactive surface area of   * +
!c                                mineral (global system)
!c           c(nc,nn)           = concentrations of free species      * +
!c                                - old time level [moles/l water]
!c           cnew(nc,nn)        = concentrations of free species      * +
!c                                - new time level [moles/l water]  
!c           cec_g(nn)          = cation exchange capacity [meq/100g] * +
!c                                - global system
!c           cec_fraction_g(nsites_ion,nn)                            * +
!c                              = cec fractions of multisite ion 
!c                                exchange [-] - global system
!c           distcoff_rt(nc,nn) = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk]
!c                                - reactive transport
!c           gold(ng,nn)        = gas concentrations                  * +
!c                                - old time level [moles / l air]
!c           gnew(ng,nn)        = gas concentrations                  * +
!c                                - new time level [moles / l air]
!c           cmold(nm,nn)       = mineral concentrations
!c                                - old time level [moles/l bulk]]    * +
!c           cmnew(nm,nn)       = mineral concentrations
!c                                - new time level [moles/l bulk]     * +
!c           cx(nx,nn)          = concentrations of secondary aqueous * +
!c                                species [moles/l water]
!c           gamma(nc+nx,nn)    = activity coefficients of aqueous    * +
!c                                species (global)
!c           phi(nm,nn)         = volume fractions of minerals        * +
!c           phiold(nm,nn)      = volume fractions of minerals        * +
!c                                (old time level)
!c           phi_init(nm,nn)    = volume fractions of minerals        * +
!c                                (initial condition)
!c           sionnew(nn)        = ionic strength of solution          * +
!c           sionnew(nn)        = ionic strength of solution          * +
!c                                - new time level
!c           sionold(nn)        = ionic strength of solution          * +
!c                                - old time level
!c           totaold(n,nn)      = total sorbed component              * + 
!c                                concentrations
!c                                non-competitive sorption 
!c                                - old time level [moles/l bulk]     * +
!c           totanew(n,nn)      = total aqueous component
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk]
!c           totcold(n,nn)      = total aqueous component             * +
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totcnew(n,nn)      = total aqueous component             * +
!c                                concentrations
!c                                - new time level [moles/l water]
!c           totgold(nc,nn)      = total gaseous component             * +
!c                                concentrations
!c                                - old time level [moles/l air]]
!c           totgnew(nc,nn)      = total gaseous component             * +
!c                                concentrations
!c                                - new time level [moles/l air]
!c           totsold(n,nn)      = total sorbed component              * +
!c                                concentrations
!c                                - old time level [moles/l bulk]
!c          totsold_ion(n,nn)   = total sorbed component              * +
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (ion-exchange)
!c          totsold_surf(n,nn)  = total sorbed component              * +
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (surface-complex)
!c           totsnew(n,nn)      = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c           totsnew_ion(n,nn)  = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsnew_surf(n,nn) = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c
!c           integer*4:
!c           ----------
!c           nn                 = total number of control volumes     + -
!c           n                  = number of primary unknowns          + -
!c
!c chem.f:   real*8:
!c           -------
!c           areac(nm)          = reactivity term                     + -
!c           ccnew(nc)          = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           chargesb(nsb)      = charge of sorbed species            + -
!c           chargesb_ion(nsb_ion)   = charge of sorbed species       + -
!c                                     (ion-exchange)
!c           chargesb_surf(nsb_surf) = charge of sorbed species       + -
!c                                     (surface-complex)
!c           cgc(ng)            = gas concentrations                  + -
!c                                - new time level [moles/l air]
!c           cmcnew(nm,nthreads)= concentration of minerals           + -
!c                                - new time level [moles/l bulk]
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level
!c           cec(nthreads)      = cation exchange capacity [meq/100g] + -
!c           cec_fraction(nsites_ion)                                * +
!c                              = cec fraction of multisite ion-
!c                                exchange sites 
!c           cxc(nx)            = concentrations of secondary         + -
!c           distcoff_lc(nc)    = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk] 
!c                                - local chemistry
!c           gamma_l(nc+nx)     = activity coefficients of aqueous    + -
!c                                species
!c           phic(nm,nthreads)  = volume fractions of minerals        + -
!c           rhobulk            = dry bulk density [g/cm^3]           + -
!c           sion1(nthreads)    = ionic strength (local chemistry)    + -
!c           totan(nc,nthreads) = total sorbed component              + +
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           totcn(nc-1,nthreads)
!c                              = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l water]
!c           totgn(nc-1,nthreads)
!c                              = total gaseous component             + -
!c                                concentrations
!c                                - new time level [moles/l air]
!c           totcsn(nc-1)       = total sorbed component              + -
!c                                concentrations
!c           totcsn_ion(nc-1,nthreads)
!c                              = total sorbed component              + -
!c                                concentrations
!c                                (ion-exchange)
!c           totcsn_surf(nc-1,nthreads)  
!c                              = total sorbed component              + -
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)=stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c
!c           integer*4:
!c           ----------
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nx                 = number of aqueous complexes         + -
!c           nsites_ion         = number of ion exchange sites        + -
!c
!c           logical:
!c           --------
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c           redox_equil_rt     = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c                                           (reactive transport)
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c
!c local:    integer*4:
!c           ----------
!c           ic                 = counter (components)    
!c           ig                 = counter (gases)    
!c           im                 = counter (minerals)
!c           ix                 = counter (secondary aqueous species)
!c
!c external: comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions
!c           totconc   = compute total aqueous component
!c                       concentrations based on concentrations
!c                       of free species and secondary aqueous
!c                       species
!c           totconcg  = compute total gaseous component
!c                       concentrations based on concentrations
!c                       of gases
!c           totsorb   = compute total sorbed component 
!c                       concentrations or derivatives of total
!c                       sorbed component concentrations
!c ----------------------------------------------------------------------
 
      subroutine icbcrt (ivol,imin,tid,flag_set_aq)
 
      use parm
      use gen
      use chem
      use dens

      implicit none
     
      integer :: ivol, imin, tid 

      !Set aqueous and corresponding gas concentration.
      !This flag is added to support reading intial
      !concentration of reactive transport from multiple zones.
      logical :: flag_set_aq
      
      integer :: iaq, ic, ig, im, isb, ix, izn, itid

      real*8 :: rcvt

      external comptotc, totconc, totconcg, totsorb

!c  assign initial or boundary condition to solution domain

      if (flag_set_aq) then
!c  ionic strength
 
        sionold(ivol) = sion1(tid)   
        sionnew(ivol) = sion1(tid)   
 
!c  concentrations and activity coefficients of free species
 
        do ic=1,nc
          c(ic,ivol) = ccnew(ic)
          cnew(ic,ivol) = ccnew(ic)
          gamma(ic,ivol) = gamma_l(ic)
          if (hmulti_diff) then
            gammaold(ic,ivol) = gamma_l(ic)
          end if
        end do
 
!c  concentrations and activity coefficients of aqueous complexes
 
        do ix=1,nx
          cx(ix,ivol) = cxc(ix)
          gamma(nc+ix,ivol) = gamma_l(nc+ix)
        
          if (hmulti_diff) then
            cxold(ix,ivol) = cxc(ix)            !MX May2014
            gammaold(nc+ix,ivol) = gamma_l(nc+ix)
          end if
        
        end do
      

!c  temperature corrections for debye-huckel, equilibrium and
!c  rate constants  MXIE

        if (temp_corr.or.heat_transport) then
          do itid = 1, nthreads
            call tcorr(tkel(ivol),ivol,itid)
          end do
        end if
 
!c  calculate total aqueous component concentrations

        call totconc(ccnew,cxc,totcn(:,tid))
      
!c Calculate the secondary species concentrations cxold - old time level
        if (hmulti_diff) then
          izn = mpropvs(ivol)
                
!c  compute total concentrations of aqueous primary and secondary
!c  species times the correction factors
                
          call totconcfac(cnew(1,ivol),cx(1,ivol),totcnewf(1,ivol),izn)
          call totconcfac(c(1,ivol),cxold(1,ivol),totcoldf(1,ivol),izn)

        end if

!c  compress total aqueous component concentration vector in case 
!c  of equilibrium reactions

        if (redox_equil_rt.and.nr.gt.0) then
          call comptotc(totcn(:,tid))
        end if

!c  total aqueous component concentrations

        do ic=1,nc-1
          totcold(ic,ivol) = totcn(ic,tid)
          totcnew(ic,ivol) = totcn(ic,tid)
        end do

!c  gas concentrations

        if (ng.ne.0) then

          do ig=1,ng
            gnew(ig,ivol) = cgc(ig)
            gold(ig,ivol) = cgc(ig)
          end do

!c  calculate total gaseous component concentrations

          call totconcg(cgc,totgn(:,tid))

!c  compress total gaseous component concentration vector in case 
!c  of equilibrium reactions

          if (redox_equil_rt.and.nr.gt.0) then
            call comptotc(totgn(:,tid))
          end if

!c  total gaseous component concentrations

          do ic=1,nc-1
            totgold(ic,ivol) = totgn(ic,tid)
            totgnew(ic,ivol) = totgn(ic,tid)
          end do

        end if

!c  total sorbed component concentrations and sorption parameters
!c  for non-competitive sorption reactions

        if (noncompetitive_sorption) then

!c  compress total component concentration vector for sorbed species 
!c  (non-competitive sorption) in case of equilibrium redox reactions

          if (redox_equil_rt.and.nr.gt.0) then
            call comptotc(totan(:,tid))
          end if

          do ic = 1,nc-1
            totaold(ic,ivol) = totan(ic,tid)
            totanew(ic,ivol) = totan(ic,tid)
            distcoff_rt(ic,ivol) = distcoff_lc(ic)
          end do

        end if

!c  total sorbed component concentrations

        if (nsb_ion.gt.0 .or. nsb_surf.gt.0) then

          call totsorb(csb_ion(:,tid),csb_surf(:,tid),chargesb_ion,    &
               rhobulk,totcsn_ion(:,tid),totcsn_surf(:,tid),           &
               xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,                &
               jasb_ion,jasb_surf,nc,nsb_ion,                          &
               nsb_surf,namec)

!c  compress total component concentration vector for sorbed species 
!c  in case of equilibrium redox reactions
          if(nsb_ion.gt.0) then
              if (redox_equil_rt.and.nr.gt.0) then
                call comptotc(totcsn_ion(:,tid))
              end if

              do ic = 1,nc-1
                totsold_ion(ic,ivol) = totcsn_ion(ic,tid)
                totsnew_ion(ic,ivol) = totcsn_ion(ic,tid)
              end do
          end if
        
          if(nsb_surf.gt.0) then
              if (redox_equil_rt.and.nr.gt.0) then
                call comptotc(totcsn_surf(:,tid))
              end if

              do ic = 1,nc-1
                totsold_surf(ic,ivol) = totcsn_surf(ic,tid)
                totsnew_surf(ic,ivol) = totcsn_surf(ic,tid)
              end do
          end if
        end if
      end if

!cprovi-------------------------------------------------------------------
!cprovi-------------------------------------------------------------------     
      if (nsb_ion.gt.0 .or. nsb_surf.gt.0) then
!cprovi-------------------------------------------------------------------
!cprovi assign cation exchange capacity for global system
!cprovi Only if cec field is not assigned
!cprovi-------------------------------------------------------------------
        if (.not.cec_field) then
          cec_g(ivol) = cec(tid)
          rhobulk_g(ivol) = rhobulk
        end if
!cprovi-------------------------------------------------------------------
!cmx assign cec fraction of multisite ion excahnge sites for global system
!cmx----------------------------------------------------------------------
        if (.not.cec_field .and. nsites_ion > 1) then
            do isb=1, nsites_ion
                cec_fraction_g(isb,ivol) = cec_fraction(isb)
            end do
        end if
      end if

!c  mineral concentrations and geometrical parameters
!c preserve nodal values for mineral volumes and areas  
      if (imin.eq.0.and.nm.gt.0) then
        do im=1,nm
          if (.not. mineral_surf_field) then               
            area(im,ivol) = areac(im)
            area_init(im,ivol) = areac(im)
          end if
          
          if (.not. mineral_vol_field) then
            cmnew(im,ivol) = cmcnew(im,tid)
            cmold(im,ivol) = cmcnew(im,tid)
            phi(im,ivol) = phic(im,tid)
            phiold(im,ivol) = phic(im,tid) 
 !MX           phi_init(im,ivol) = phic(im)
            phi_init(im,ivol) = phiinit(im,tid)            !MX fixed on Oct. 2, 2012 for benchmark pyrox
          end if
          
          if(.not. mineral_vnuc_field) then
            phinucthrd(im,ivol) = phinuc(im)
          end if
          
          if(.not. mineral_anuc_field) then
            areanucthrd(im, ivol) = areac(im)
          end if
          
        end do

        !c mineral volume fraction convert if mineral input init is 'volume fraction of solid phase'
        if (phiUnitSolid) then
          rcvt = 1.0d0-pornew(ivol)
          phi(:,ivol) = phi(:,ivol) * rcvt
          phiold(:,ivol) = phiold(:,ivol) * rcvt
          phi_init(:,ivol) = phi_init(:,ivol) * rcvt
        end if
      end if
      
!c_bubbles spatial dependent intra-aqueous scaling factors

      if (imin.eq.0.and.naq.gt.0) then
        do iaq=1,naq
          scalfac_aq_ivol(iaq,ivol)=scalfac_aq(iaq)
        end do
      end if
 
      return
      end
