!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 726 $
!> $Author: dsu $
!> $Date: 2019-08-07 11:30:33 -0700 (Wed, 07 Aug 2019) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/weed.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine weed
!c ---------------
!c
!c determine secondary aquoeus species, which are obsolete for 
!c simulation
!c
!c written by:      Uli Mayer - April 26, 98
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           igen               = unit number, generic output file    + -
!c
!c chem.f:   real*8:
!c           -------
!c           cxmax(nx)          = maximum concentration of secondary  * +
!c                                aqueous species in solution domain
!c           totcmin(n)         = minimum total aqueous component     * +
!c                                concentration in solution domain
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of secondary aqueous
!c                                species from components
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in secondary aqueous
!c                                species
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in secondary aqueous
!c                                species
!c           nx                 = number of secondary aqueous species + -
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namex(nx)          = names of secondary aqueous species  + - 
!c           
!c local:    real*8:
!c           -------
!c           diff_cx            = relative difference of secondary
!c                                aqueous species concentrations 
!c                                with total aqueous component 
!c                                concentration weighted by 
!c                                stoichiometric coefficient 
!c           diff_cxmax         = max. relative difference of
!c                                secondary aqueous species 
!c                                concentrations with total 
!c                                aqueous component concentrations 
!c           drop_cx            = tolerance for consideration of 
!c                                secondary aqueous species
!c           r0                 = constant
!c
!c           integer*4:
!c           ----------
!c           i                  = counter
!c           ic                 = counter (components)
!c           istart             = pointer
!c           istop              = pointer
!c           ix                 = counter secondary aqueous species)
!c
!c           
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine weed
 
      use parm
      use chem
      use gen

      implicit none

      real*8, parameter :: drop_cx = 1.d-3, r0 = 0.0d0
      integer :: i, ic, icount, ix, istart, istop
      real*8 :: diff_cxmax, diff_cx

      icount = 0

!c  determine if secondary aqueous species can be dropped

      if (b_enable_output .and. b_enable_output_gen) then 
        write(igen,'(/a)')  'secondary aqueous species to be excluded'
        write(igen,'(a/)')  '----------------------------------------'
        write(igen,'(a)')   '   # species name   diff_cxmax'
      end if
        
      do ix = 1,nx

        diff_cxmax = r0
        istart = iax(ix)
        istop = iax(ix+1)-1

        do i = istart,istop
          ic = jax(i)

!c  skip h2o, since not a primary unknown

          if (namec(ic).ne.'h2o') then
            diff_cx = cxmax(ix)*xnux(i)/totcmin(ic)
            diff_cxmax = dmax1(diff_cxmax, diff_cx)
          end if
        end do

        if (diff_cxmax.lt.drop_cx.and.namex(ix).ne.'oh-') then
          icount = icount+1
          
          if(b_enable_output .and. b_enable_output_gen) then  
            write(igen,'(i4,1x,a12,1x,1pe15.6e3)') icount,namex(ix),   &
                                               diff_cxmax
          end if
        end if

      end do                !ix = 1,nx

      return
      end

