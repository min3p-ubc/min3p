!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/darcy_energybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!


real*8 function darcy_energybal(dp1,dp2,dens_ivol,dens_jvol,visco_ivol,visco_jvol, &
                                relperm_ivol,relperm_jvol,cinf,ups_fac, &
                                isboussinesq)
 

 
implicit none

real*8, intent(in)     :: dp1          ! delta without newton increment
real*8, intent(in)     :: dp2          ! delta with newton increment
real*8, intent(in)     :: dens_ivol    ! density ivol
real*8, intent(in)     :: dens_jvol    ! density jvol
real*8, intent(in)     :: visco_ivol   ! viscosity ivol
real*8, intent(in)     :: visco_jvol   ! density jvol
real*8, intent(in)     :: relperm_ivol ! density ivol
real*8, intent(in)     :: relperm_jvol ! density jvol
real*8, intent(in)     :: ups_fac      ! density ivol
real*8, intent(in)     :: cinf         ! influence coefficient
logical, intent(in)    :: isboussinesq ! density jvol

real*8                 :: relperm_av,visco_av,rho_av,coeff,fluxdd

real*8, parameter      :: r0=0.0d0, r1=1.0d0



if (isboussinesq) then
  if (dp1 > r0) then               
       relperm_av = ups_fac*relperm_jvol+(r1-ups_fac)*relperm_ivol
       visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol                                       
  else                   
       relperm_av = ups_fac*relperm_ivol+(r1-ups_fac)*relperm_jvol
       visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol                 
  end if
  coeff = relperm_av/visco_av  
else 
  if (dp1 > r0) then               
      relperm_av = ups_fac*relperm_jvol+(r1-ups_fac)*relperm_ivol
      visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
      rho_av = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol                     
  else                   
      relperm_av = ups_fac*relperm_ivol+(r1-ups_fac)*relperm_jvol
      visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
      rho_av = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol                 
  end if
  coeff  = relperm_av * rho_av / visco_av
end if
darcy_energybal = - fluxdd(dp2,cinf,coeff)

return
end function  