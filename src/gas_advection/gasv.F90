!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/gas_advection/gasv.F90 $
!---------------------------------------------------------------------
!********************************************************************!
!c ----------------------------------------------------------------------
!c real*8 function gasv
!c --------------------
!c
!c compute gas viscosity using Wilke expression or leave it as constant
!c
!c input units for molar density are in [moles/l air]
!c ouptut density is in [Kg/m^3 air] = [g/l air]
!c
!c written by:     Sergi Molins - May 2, 2006 
!c
!c last modified:  Sergi Molins - May 24, 2006
!c                 added linear viscosity option
!c
!c   modified by:  Danyang Su - March 26, 2014
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           moldens            = molar density                       + - 
!c                                in control volume i
!c           gasd_m             = gas pressure in control vol i       * +
!c
!c           integer*4:
!c           ----------
!c           ivol               = control volume index                + - 
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           ng                 = number of gases                     + - 
!c           
!c chem.f:   real*8:
!c           -------
!c           gfwg(ng)           = gram formula weight (gases)         + -
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r1                 = constant
!c           r2                 = constant
!c           r8                 = constant
!c           rhalf              = constant
!c           rquarter           = constant
!c           theta              = variable
!c           bb                 = variable
!c           
!c           integer*4:
!c           ----------
!c           i, j               = index
!c
!c external: -  
!c ----------------------------------------------------------------------
 
      real*8 function gasv(molfrac)

      use chem, only : ng, gfwg
      use phys, only : variable_visc_g, visc_gcnst, visc_comp_g
 
      implicit none

!c  passed
      real*8 molfrac(ng)
    
!c  internal
      real*8 :: r0, r1, r2, r8, rhalf, rquarter, rsmall
      real*8 bb, theta
      integer :: i, j

!c  constants
      parameter (r1 = 1.0d0  , r2 = 2.0d0, r8 = 8.0d0,                &
                 rhalf = .5d0, rquarter = .25d0, r0 =0.d0,            &
                 rsmall = 1.0d-300)

      gasv = r0
    
      if (variable_visc_g.eq.'constant') then ! constant viscosity, no update

        gasv = visc_gcnst

      else if (variable_visc_g.eq.'wilke') then  ! wilke 
        
        gasv = r0
              
        do i=1,ng
        
          bb = r0
          
          do j=1,ng
         
            theta = (r1 + ((visc_comp_g(i)/visc_comp_g(j))**rhalf)*     & 
                     ((gfwg(j)/gfwg (i))**rquarter) )** r2
        
            theta = theta / ((r8 * (1 + gfwg(i) / gfwg (j)) ) ** rhalf)
            
            bb = bb + molfrac(j) * theta
        
          enddo
        
          if (bb > rsmall) then      !For initial condition, molfrac(j) = 0
            gasv = gasv + molfrac(i) * visc_comp_g(i) / bb
          end if
        enddo
 
      else if (variable_visc_g.eq.'linear') then ! linear  

        gasv = r0

        do i=1,ng
            gasv = gasv + molfrac(i) * visc_comp_g(i)
        enddo 

      endif
       
      return
      end