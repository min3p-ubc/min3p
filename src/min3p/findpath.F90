!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/findpath.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine findpath
!c -------------------
!c
!c find currenr reaction path for current mineral        
!c
!c written by:      Uli Mayer - July 7, 02
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           ipath              = counter (pathway)                   + -
!c           im                 = counter (mineral)                   + -
!c
!c
!c common:   
!c gen.f:    integer:
!c           --------
!c           ilog               = unit number, log file               + -
!c           imdbs              = unit number, mineral database       + -
!c
!c chem.f:   integer:
!c           --------
!c           l_namem(nm)        = length of mineral names             + -
!c
!c           character:
!c           ----------
!c           namem(nm)          = mineral names                       + -
!c
!c
!c local:    integer:
!c           --------
!c           info_debug         = control parameter - debug output
!c           ipath2             = counter (pathway)
!c
!c           logical:
!c           --------
!c           found              = .true.  -> found pathway
!c
!c           character:
!c           ----------
!c           string             = text string
!c           keyword            = keyword
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine findpath(ipath,im)

      use parm
      use gen
      use chem
      use file_utility, only : makelowercase, replacecharacter,        &
                               readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: im, ipath 
      
      integer :: info_debug, ipath2

      logical found
      character*1 string
      character*72 keyword
      
!c  locate current reaction pathway

      found = .false.
      info_debug = 0
                                
      do while (.not.found) 
        
        read(imdbs,*,err=999,end=998) keyword
        backspace(imdbs)
        read(imdbs,*,err=999,end=998) string

        if (keyword.eq.'pathway') then
          backspace(imdbs)
          read(imdbs,*,err=999,end=998) keyword, ipath2
          if (ipath2.eq.ipath) then
          if (info_debug.gt.1 .and. rank == 0 .and. b_enable_output) then
            write(*,*) 'mineral ', trim(namem(im))
            write(*,*) 'pathway', ipath
          end if
          found = .true.
          end if
        elseif(keyword.ne.'pathway'.and.string.eq.'!') then
          if(rank == 0) then  
            write(ilog,*) 'pathway missing'
            write(ilog,*) 'mineral ', trim(namem(im))
            write(ilog,*) 'abnormal exit'
          end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
                    
    end do

    return

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'reached end of database "mineral.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'reached end of database "mineral.dbs"'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if(rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading database "mineral.dbs"'
        write(ilog,*) 'mineral "',trim(namem(im)),'"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'error reading database "mineral.dbs"'
        write(*,*) 'mineral "',trim(namem(im)),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
