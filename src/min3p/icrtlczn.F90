!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/icrtlczn.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine icrtlczn
!c -------------------
!c
!c read control parameters and initial condition for current zone
!c (reactive transport or local chemistry)
!c
!c written by:      Uli Mayer - May 16, 96
!c
!c last modified:   Uli Mayer - December 4, 96 
!c                  Sergi Molins - May 2, 2006 
!c                  added 'pn2', 'pch4', pco2', 'pco2x', 'par' 
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           izone              = pointer to current zone             + -
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           icnv               = unit number, data conversion and    + -
!c                                             temporary storage
!c           idbg               = unit number, debugging file         + -
!c           ifls               = unit number, file information       + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           itmp               = unit number, temporary storage      + -
!c           l_zone_name        = length of zone name                 + -
!c
!c           logical:
!c           --------
!c           reactive_transport = .true.  -> perform reactive         + -
!c                                           transport simulation
!c
!c           character:
!c           ----------
!c           section_header     = section_header                      * +
!c           zone_name          = name of zone                        + -
!c
!c chem.f:   real*8:
!c           -------
!c           areac(im)          = reactivity term                     * +
!c           avog_const         = avogadro constant                   * +
!c           cec(nthreads)      = cation exchange capacity            * +
!c           cmcnew(nm,nthreads)= concentration of minerals           * +
!c                                - new time level [moles/l bulk]
!c           cmcold(nm,nthreads)= concentration of minerals           * +
!c                                - old time level [moles/l bulk]
!c           delt_lc(nthreads)  = time step (local chemistry)         * +
!c           delt_max_lc        = maximum time step (local chemistry) * +
!c           distcoff_lc(nc)    = sorption distribution coefficient   * +
!c                                [L H_2O/L bulk] 
!c                                - local chemistry
!c           expphi(nm)         = exponent for reactive surface area  * +
!c                                update
!c           gfwc(nc)           = gram formula weight of components   * +
!c           phguess            = guess for ph                        * +
!c           phic(nm,nthreads)  = volume fractions of mineral         * +
!c           radi(nm)           = initial radius of mineral grain     * +
!c           rads(nm,nthreads)  = radius of unreacted core of mineral * +
!c                                grain
!c           phimin(nm)         = volume fractions of minerals for    * +
!c                                nucleation
!c           phinuc(nm)         = volume fractions of mineral for     * +
!c                                nucleation threshold
!c           ph_inc             = ph-increment for pH-sweep           * +
!c                                calculations
!c           ph_start           = initial pH for pH-sweep             * +
!c                                calculations
!c           ph_stop            = final pH for pH-sweep               * +
!c                                calculations
!c           radmin(nm)         = representative grain radius of      * +
!c                                nucleus
!c           rhobulk            = dry bulk density [g/cm^3]           * +
!c           site_area(nsites)  = surface area of mineral phase       * +
!c                                [m^2 surface g^-1 mineral]
!c           site_dens(nsites)  = site density                        * +
!c                                [sites nm^-2 surface]
!c           site_mass(nsites)  = mass of mineral phase               * +
!c                                [g L-1 h2o]
!c           supsatm(nm)        = level of supersaturation required   * +
!c                                for precipitation 
!c           scalfac(nm)        = scaling factor (reactivity term)    * +
!c           sec_per_days       = conversion factor from SI input     + -
!c                                units for physico-chemical
!c                                parameters to internal time units
!c           tempk              = temperature [deg K]                 + -
!c           tfinal_lc          = final solution time                 * +
!c                                (local chemistry)
!c           time_factor_lc     = conversion factor from I/O time     + -
!c                                units to internal time units
!c           totco(n,nthreads)  = total aqueous component             * +
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totcinit(n)        = total aqueous component             * +
!c                                concentrations
!c                                - initial concentrations
!c                                  [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iais(nc)           = row pointer array for compressed    + -
!c                                storage of surface site data
!c           nbio               = number of biomass components        + -
!c           nc                 = number of components including h2o  + -
!c           ncorder(nc)        = ordering array for components       + -
!c                                ncorder(old order) = new order
!c           nlinear            = number of components undergoing     + -
!c                                linear sorption
!c           nm                 = number of minerals                  + -
!c           nph_steps          = number of pH-steps for pH-sweep     + -
!c                                calculations
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c 
!c           logical:
!c           --------
!c           explicit_surface   = .true.  -> include surface sites    * +
!c                                           in equilibrium 
!c                                           calculations
!c           explicit_surface_ion  = .true.  -> include surface sites * +
!c                                           in equilibrium 
!c                                           calculations
!c                                           of ion-exchange
!c           explicit_surface_surf = .true.  -> include surface sites * +
!c                                           in equilibrium 
!c                                           calculations
!c                                           of surface-complex
!c           implicit_surface   = .true.  -> equilibrate surface      * +
!c                                           sites with fixed 
!c                                           solution composition
!c           implicit_surface_ion  = .true.  -> equilibrate surface   * +
!c                                           sites with fixed 
!c                                           solution composition
!c                                           of ion-exchange
!c           implicit_surface_surf = .true.  -> equilibrate surface   * +
!c                                           sites with fixed 
!c                                           solution composition
!c                                           of surface-complex
!c           lb_output          = .true.  -> output of transient data * +
!c                                           (local chemistry)
!c           linear_sorption    = .true.  -> components present that  + - 
!c                                           are undergoing linear 
!c                                           sorption
!c           minequil(nm)       = .true.  -> equilibrate aqueous      * +
!c                                           species with specified
!c                                           mineral
!c           noncompetitive_sorption = .true.  -> noncompetitive      + -
!c                                                sorption reactions
!c           ph_sweep           = .true.  -> sweep over specified     * +
!c                                           pH-range
!c           reactive_minerals  = .true.  -> consider mineral         * +
!c                                           dissolution-
!c                                           precipitation reactions
!c           tstart_to_equil    = .true.  -> stop kinetic batch       * +
!c                                           simulation when
!c                                           equilibrium with
!c                                           specified minerals is
!c                                           reached
!c           tstart_to_tfinal   = .true.  -> stop kinetic batch       * +
!c                                           simulation when tfinal
!c                                           is reached
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c                                'biomass' = biomass
!c           ctype(nc-1)        = 'charge' = correct total aqueous    * +
!c                                           component concentration
!c                                           for specified component 
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on 
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           ctype_init(nc-1)   = 'charge' = correct total aqueous    * +
!c                                           component concentration
!c                                           for specified component
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           input_units        = 'mol/l'                             + -
!c                                'mmol/l'
!c                                'mg/l'
!c                                'g/l'
!c           isotherm_type(nc)  = definition of sorption isotherm     + -  
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           namec(nc)          = component names                     + -
!c           namem(nm)          = mineral names                       + -
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           update_type(im)    = type of surface area update         + -
!c                                'constant'  = constant reactive
!c                                              surface area
!c                                'geometric' = geometric reactive
!c                                              surface area update
!c
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r_1                = constant
!c           r1                 = constant
!c           r1000              = constant
!c           sitearea           = surface area of mineral phase
!c                                [m^2 surface g^-1 mineral]
!c           sitedens           = site density
!c                                [sites nm^-2 surface]
!c           sitemass           = mass of mineral phase
!c                                [g L-1 h2o]
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           icount             = counter
!c           ilinear            = counter
!c           im                 = counter (minerals)
!c           isites             = counter (surface sites)
!c           itemp              = pointer
!c           ivol               = counter (control volumes)
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found              = logical variable
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c
!c           character:
!c           ----------
!c           subsection         = name of subsection in input file
!c           name               = name of surface site/species
!c
!c external: distmp    = distribute mineralogical parameters
!c           findstrg  = find string in input file
!c           findzone  = find zone in input section
!c           guess     = guess for concentrations of
!c                       free species
!c           initgeom  = geometrical parameters for minerals
!c           readzone  = read zone in section of input file and 
!c                       write to temporary file
!c ----------------------------------------------------------------------

      subroutine icrtlczn(izone)

      use parm
      use gen
      use chem
      use nobleGasIngrowth
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: izone
      
      integer :: i, iaq, ic, im, isb, isites, ilinear, itemp,          &
                 l_string, icount, icount_ic
      
      real*8 :: sitemass, sitearea, sitedens, cec_frc_total, rdummy
      
      integer :: tid, itid, ierrcd
      
      integer :: nmin, inmin, nfact, iciunt1
      
      !c intermittent reaction variables
      integer :: iirm, iirt, iirc, nirm, nirt, nirc, iindex, istart, iend

      integer :: ingre, ingre_u, ingne, ingnce

      external  findstrg, findzone, guess, initgeom, readzone, distmp

      logical found, found_subsection
      character*72 subsection
      character*72 name, name_irm, nametemp, nametemp1

      real*8, parameter :: r0 = 0.0d0, r_1 = 0.1d0, r1 = 1.0d0,        &
                           r1000 = 1.0d+3, tiny = 1.0e-3      
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

      ierrcd = 0

!c  redefine length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if 

!c  find current zone in input file and write to temporary file

      subsection = 'number and name of zone'

      call findzone(subsection,itmp,found_subsection,izone,zone_name)
   
      if (found_subsection) then
        
        call readzone(itmp,icnv,ilog,zone_name,found_subsection)

      else
        if(rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error in input file'
          write(ilog,*) 'section "',section_header(:l_string),'"'
          write(ilog,*) 'zone number "',izone, '" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop

      end if

!c  write name of zone to output file
      if(b_enable_output) then  
        if (rank == 0) then  
          write(ilog,'(72a/a/72a/)') ('*',i=1,72),zone_name,('*',i=1,72)
        end if
        
        if (b_enable_output_gen) then
          write(igen,'(/72a/a/72a)') ('*',i=1,72),zone_name,('*',i=1,72)
        end if
      end if

!c  define length of zone name

      l_zone_name = index(zone_name,'  ')-1
      if (l_zone_name.lt.0.or.l_zone_name.gt.72) then
        l_zone_name = 72
      end if

!c  set defaults for kinetic batch simulations

      tstart_to_equil = .false.
      tstart_to_tfinal = .false.
      reactive_minerals = .false.
      lb_output = .false.
      ph_sweep = .false.
      delt_lc(:) = r1
      delt_max_lc = 1.0d+100
      tfinal_lc = r1

!c  -> read control parameters for zone

      subsection = &
      'kinetically controlled dissolution-precipitation reactions'

      call findstrg(subsection,icnv,found_subsection)

      if (found_subsection) then

        reactive_minerals = .true.
        tstart_to_equil = .true.
        ierrcd = 1
        read(icnv,*,end=999,err=999) lb_output !output of transient data
        read(icnv,*,end=999,err=999) delt_lc(tid)   !initial time step
        delt_lc(:) = delt_lc(tid)
        
        if(.not. b_enable_output)  then
           lb_output = .false. 
        end if

!c  write header to file information file, if output of transient data

        if (lb_output .and. rank == 0 .and. b_enable_output) then
          write(ifls,'(//72a/a/a/72a)') ('*',i=1,72),         &
                                      'transient data - ',    &
                                       zone_name,             &
                                      ('*',i=1,72)
        end if

      end if

!c  settings for kinetic batch problem

      subsection = 'kinetic batch simulation'

      call findstrg(subsection,icnv,found_subsection)

      if (found_subsection) then

        tstart_to_tfinal = .true.
        reactive_minerals = .true.
        if(b_enable_output) then
          lb_output = .true.
        else
          lb_output = .false.  
        end if

        ierrcd = 2
        read(icnv,*,end=999,err=999) delt_lc(tid)        
        read(icnv,*,end=999,err=999) tfinal_lc

        delt_lc(:) = delt_lc(tid)
        
!c  write header to file information file, if output of transient data

        if (rank == 0 .and. b_enable_output) then
          write(ifls,'(//72a/a/a/72a)') ('*',i=1,72),       &
                                      'transient data - ',  &
                                       zone_name,           &
                                      ('*',i=1,72)
        end if

      end if

!c  set maximum time step

      subsection = 'set maximum time step'

      call findstrg(subsection,icnv,found_subsection)

      if (found_subsection) then
        ierrcd = 3
        read(icnv,*,end=999,err=999) delt_max_lc
      end if

!c  -> make sure that user-specified input leads not to program failure   

      if (nm.gt.0) then
        reactive_minerals = .true.
      end if

      if (nm.eq.0) then
        reactive_minerals = .false.
        lb_output = .false.
        delt_lc(:) = r1
      end if

!c  -> total aqueous component concentrations

      subsection = 'concentration input'

      call findstrg(subsection,icnv,found_subsection)

      if (found_subsection) then

        if (rank == 0 .and. b_enable_output) then  
          write(ilog,*) 'reading aqueous concentrations'
        end if
        
        do ic=1,nc-1

          itemp = ncorder(ic)                 !internal order
          
          if (component_type(itemp).eq.'aqueous'.or. &
     &        component_type(itemp).eq.'biomass') then

            ierrcd = 4
            read(icnv,*,end=999,err=999) totco(itemp,tid),ctype(itemp)
            ctype_init(itemp) = ctype(itemp)
            totco(itemp,:) = totco(itemp,tid)

!c  -> read data for pH-sweep calculations

            if (ctype(itemp).eq.'ph_sweep') then
              ph_sweep = .true.
              if (reactive_minerals.or.naq.gt.0) then
                if (rank == 0) then  
                  write(ilog,*) 'ABNORMAL EXIT'
                  write(ilog,*) 'pH-sweep calculations cannot be ',    &
                                'performed together with kinetically-',&
                                'controlled reactions'
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if
              backspace(icnv)
              ierrcd = 5
              read(icnv,*,end=999,err=999) ph_start, ctype(itemp),    &
                                           ph_stop, nph_steps
              ph_inc = (ph_stop-ph_start)/float(nph_steps)
              ctype(itemp)='ph'
            end if

!c  -> convert input units to internal units [moles/l]

            if (ctype(itemp).ne.'ph'.and.     &
                ctype(itemp).ne.'eh'.and.     &
                ctype(itemp).ne.'pe'.and.     &
                ctype(itemp).ne.'po2'.and.    &
                ctype(itemp).ne.'pn2'.and.    &
                ctype(itemp).ne.'pch4'.and.   &
                ctype(itemp).ne.'ph2'.and.    &
                ctype(itemp).ne.'pco2x'.and.  &
                ctype(itemp).ne.'par'.and.    &
                ctype(itemp).ne.'pco2') then
              if (input_units.eq.'mmol/l') then
                totco(itemp,:) = totco(itemp,:) / r1000
              elseif (input_units.eq.'mg/l') then
                totco(itemp,:) = totco(itemp,:) / r1000 / gfwc(itemp)
              elseif (input_units.eq.'g/l') then
                totco(itemp,:) = totco(itemp,:) / gfwc(itemp)
              end if
            end if

          end if          !(component_type(ic).eq.'aqueous'.or.
                          ! component_type(ic).eq.'biomass')

        end do          !loop over components

      else
        
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file in icrtlczn-1'
          write(ilog,*) 'section "',trim(section_header),'"'
          write(ilog,*) 'zone "',trim(zone_name),'"'
          write(ilog,*) 'subsection "',trim(subsection),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop

      end if            !(found_subsection)

!c  -> guess for ph
 
      subsection = 'guess for ph'

      call findstrg(subsection,icnv,found_subsection)

      if (found_subsection) then
        ierrcd = 6
        read(icnv,*,err=999,end=999) phguess
      else
        phguess = 7.0d0
      end if
      
!c_bubbles - spatial dependent intra-aqueous scaling factors

      subsection = 'scaling for intra-aqueous kinetic reactions'

      call findstrg(subsection,icnv,found_subsection)

      if (found_subsection) then

        do iaq = 1,naq
          ierrcd = 7
          read(icnv,*,err=999,end=999) scalfac_aq(iaq)
        end do

      end if
      
!c_relationship and parameter inpput for calculating
!c salinity dependent mineral reaction rates  MX

      if (nm > 0) then
        subsection = 'salinity dependent reaction rate of minerals'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          ierrcd = 8
          read(icnv,*,err=999,end=999) nmin

          do i= 1, nmin
            ierrcd = 9
            read(icnv,*,err=999,end=999) nametemp
            read(icnv,*,err=999,end=999) sdtype(i), nfact
          
            if (sdtype(i) .eq. 'equation') then
              icount = 0
              do im=1,nm
                if (nametemp .eq. namem(im)) then
                  salinity_dependent(im) = .true.
                  nfac(im) = nfact
                  icount=im
                end if
              end do
              if (icount .eq. 0) then
                if (rank == 0 .and. b_enable_output) then
                  write(ilog,*) 'error reading salinity dependent factors of minerals'
                end if
                goto 999
              end if

!c read the coefficients f_i of the equation (sar = sum (f_i*salinity**(i-1)), i=1,2,...,nfact)
              ierrcd = 10
              read(icnv,*,err=999,end=999) (sfac_sdmin(icount,inmin),inmin=1,nfact) 
              
!c read the valid range of the equation concerning the salinity
!c if the calculated salinity is out of the range, the limit values will apply
              ierrcd = 11
              read(icnv,*,err=999,end=999) min_salinity(i), min_sar(i)
              read(icnv,*,err=999,end=999) max_salinity(i), max_sar(i)
              
            else if (sdtype(i) .eq. 'strong inhibition by one component') then
              icount = 0
              do im=1,nm
                if (nametemp .eq. namem(im)) then
                  salinity_dependent(im) = .true.
                  nfac(im) = nfact
                  icount=im
                end if
              end do
              if (icount .eq. 0) then
                if (rank == 0 .and. b_enable_output) then
                  write(ilog,*) 'error reading salinity dependent factors of minerals'
                end if
                goto 999
              end if
              
              
!c read the inhibition component. Note: only one component is allowed.    
              ierrcd = 12          
              read(icnv,*,err=999,end=999) nametemp1
              icount_ic = 0
              do ic=1,nc
                if (nametemp1 .eq. namec(ic)) then
                  icount_ic = ic
                  inamec_inhib(icount) = ic
                  if (rank == 0 .and. b_enable_output) then
                    write(ilog,*) 'The strong inhibition is owing to the component ', namec(ic)
                  end if
                end if
              end do
              if (icount_ic .eq. 0) then
                if (rank == 0 .and. b_enable_output) then
                  write(ilog,*) 'error reading the component name in',&
                        ' salinity dependent reaction rate of minerals'
                end if
                goto 999
              end if
                             
               
!c read the concentrations of the component:
!c  1. the value (A_H) when the rate is the highest (i.e. f=1.0). It should be a lower value.
!c  2. the value (A_L) when the rate is the lowest (i.e. f=0.0). It should be a higher value.
              ierrcd = 13
              read(icnv,*,err=999,end=999) min_salinity(i)
              read(icnv,*,err=999,end=999) max_salinity(i)
              
            end if
          
          end do
        
        end if

      end if

!c  read parameters for non-competitive sorption


      if (linear_sorption) then

        subsection = 'linear sorption input'
        l_string = index(subsection,' ')-1
        if (l_string.eq.-1.or.l_string.gt.72) then
          l_string=72
        end if

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'reading linear sorption input'
          end if
                
          do ilinear = 1,nlinear

            found = .false.
            ierrcd = 14
            read(icnv,*,err=999,end=999) name
            do ic = 1,nc
              if (name.eq.namec(ic)) then
                backspace(icnv)
                ierrcd = 15
                read (icnv,*,err=999,end=999) name, distcoff_lc(ic)
                found = .true.
              end if
            end do
        
!c  terminate simulation, if specified component not part
!c  of current dataset

            if (.not.found) then
              if (rank == 0) then
                write(ilog,*) 'SIMULATION TERMINATED'
                write(ilog,*) 'error reading input file in icrtlczn-2'
                write(ilog,*) 'section "',section_header(:l_string),'"'
                write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
                l_string = index(subsection,' ')-1
                if (l_string.eq.-1.or.l_string.gt.72) then
                  l_string=72
                end if
                write(ilog,*) 'error in subsection "',      &
                              subsection(:l_string),'"'
                close(ilog)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif        
              stop
              
            end if

          end do       !loop over sorbing components
        
!c  terminate simulation is subsection not found

        else          
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file in icrtlczn-3'
            write(ilog,*) 'section "',trim(section_header),'"'
            write(ilog,*) 'zone "', trim(zone_name),'"'
            write(ilog,*) 'subsection "',trim(subsection),'" missing'
            close(ilog)
          end if  
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
                
        end if

      end if         !(linear_sorption)

!c  read sorption parameters

      if ((nsb_ion.gt.0.or.nsb_surf.gt.0).and.section_header.ne. &
         'boundary conditions - reactive transport') then

        subsection = 'sorption parameter input'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'reading sorption parameters'
          end if
          
          if (sorption_group.eq.'ion-exchange' .or. (nsb_ion.gt.0.and. &
              sorption_group.eq.'surface-complex and ion-exchange')) then

            ierrcd = 16
            read(icnv,*,err=999,end=999) cec(tid)
            cec(:) = cec(tid)
            read(icnv,*,err=999,end=999) rhobulk
            
          end if
              
          if (sorption_group.eq.'surface-complexation'.or. (nsb_surf.gt.0.and. &
              sorption_group.eq.'surface-complex and ion-exchange')) then

            do isites = 1,nsites

              ic = iaic(isites)

              ierrcd = 17
              read(icnv,*,err=999,end=999) name,sitemass,sitearea,    &
                                          sitedens

              site_mass_tmp(isites) = sitemass * sitearea * sitedens  &
                                      * 1.0d+18 / avog_const

              if (name.eq.namec(ic)) then
                site_area(isites) = sitearea
                site_dens(isites) = sitedens
                site_mass(isites) = sitemass

!c  define total concentration for surface sites in mol L^-1 h2o
!c  unit of site_mass 'g solid (L H2O)^-1', sitearea 'm^2 (g solid)^-1', sitedens 'sites nm^-2'

                totco(ic,:) = site_mass(isites)*site_area(isites)   &
                         * site_dens(isites)*1.0d+18 / avog_const

              else 
                if (rank == 0) then  
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error in input file'
                  write(ilog,*) 'component ',trim(name),' not found'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if

            end do       !loop over number of surface sites

          end if         !sorption_group

        end if           !found_subsection
        
!c  define sorption parameter input of ion-exchange        
        subsection = 'sorption parameter input of ion-exchange'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'reading sorption parameters of ion-exchange'
          end if

          if (sorption_group.eq.'ion-exchange' .or. (nsb_ion.gt.0.and. &
              sorption_group.eq.'surface-complex and ion-exchange')) then

            ierrcd = 18
            read(icnv,*,err=999,end=999) cec(tid)
            cec(:) = cec(tid)
            read(icnv,*,err=999,end=999) rhobulk
            
          end if

        end if           !found_subsection
        
!c  Read the CEC fractions for each sites of multisite ion-exchange  
!c  and store in cec_fraction(nsites_ion).
!c  The order of sites should be the same as the name order defined in 
!c  section 'surface sites of ion-exchange' within Data block 2: geochemical system.

        if (nsites_ion .gt. 1) then
            subsection = 'CEC fraction of multisite ion exchange'

            call findstrg(subsection,icnv,found_subsection)

            if (found_subsection) then
              if (rank == 0 .and. b_enable_output) then
                write(ilog,*) 'reading CEC fractions of multisite ion-exchange sites'
              end if

              if (sorption_group.eq.'ion-exchange' .or. (nsb_ion.gt.0.and. &
                  sorption_group.eq.'surface-complex and ion-exchange')) then
                  
                  cec_frc_total=0.0
                  ierrcd = 19
                  do isb=1, nsites_ion                    
                    read(icnv,*,err=999,end=999) cec_fraction(isb)
                    cec_frc_total= cec_frc_total + cec_fraction(isb)
                  end do
                  
                  if (abs(cec_frc_total-1.0) > tiny) then
                      if (rank == 0 .and. b_enable_output) then
                        write(ilog,*) 'Warning: total amount of the CEC fractions of multisite ion-exchange is ', cec_frc_total
                        write(ilog,*) 'Expected value should be 1.0 (= 100.0%)!'
                      end if
                  end if
                   
              end if
                  
              if (rank == 0 .and. b_enable_output) then
                write(ilog,*) ' '
              end if

            end if           !found_subsection
        end if          !nsites_ion
        
!c  define sorption parameter input of surface-complex  
        
        subsection = 'sorption parameter input of surface-complex'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'reading sorption parameters of surface-complex'
          end if
             
          if (sorption_group.eq.'surface-complexation'.or. (nsb_surf.gt.0.and. &
              sorption_group.eq.'surface-complex and ion-exchange')) then

            do isites = 1,nsites

              ic = iaic(isites)
              ierrcd = 20
              read(icnv,*,err=999,end=999) name,sitemass,sitearea,    &
                                          sitedens
              site_mass_tmp(isites) = sitemass * sitearea * sitedens  &
                                     * 1.0d+18 / avog_const                                          

              if (name.eq.namec(ic)) then
                site_area(isites) = sitearea
                site_dens(isites) = sitedens
                site_mass(isites) = sitemass

!c  define total concentration for surface sites in mol L^-1 h2o
!c  unit of site_mass 'g solid (L H2O)^-1', sitearea 'm^2 (g solid)^-1', sitedens 'sites nm^-2'

                totco(ic,:) = site_mass(isites)*site_area(isites)     &
                         * site_dens(isites)*1.0d+18 / avog_const

              else 
                if (rank == 0 .and. b_enable_output) then  
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error in input file'
                  write(ilog,*) 'component ',trim(name),' not found'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if

            end do       !loop over number of surface sites

          end if         !sorption_group

        end if           !found_subsection        

!c  define if surface sites are implicitly or explicitly defined

        subsection = 'equilibrate with fixed solution composition of ion-exchange'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          implicit_surface_ion = .true.    !implicit_surface
          explicit_surface_ion = .false.
        else
          implicit_surface_ion = .false.   !explicit_surface
          explicit_surface_ion = .true.       
        end if
        
        subsection = 'equilibrate with fixed solution composition of surface-complex'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          implicit_surface_surf = .true.    !implicit_surface
          explicit_surface_surf = .false.
        else
          implicit_surface_surf = .false.   !explicit_surface
          explicit_surface_surf = .true.          
        end if        

        subsection = 'equilibrate with fixed solution composition'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          !implicit_surface = .true.    !implicit_surface
          !explicit_surface = .false.
          implicit_surface_ion = .true.    !implicit_surface
          explicit_surface_ion = .false.
          implicit_surface_surf = .true.    !implicit_surface
          explicit_surface_surf = .false.
        !else
        !  !implicit_surface = .false.   !explicit_surface
        !  !explicit_surface = .true.
        !  if(implicit_surface_ion)
        !  implicit_surface_ion = .false.   !explicit_surface
        !  explicit_surface_ion = .true.
        !  implicit_surface_surf = .false.   !explicit_surface
        !  explicit_surface_surf = .true.          
        end if

      end if             !(nsb.gt.0)

!c  assign initial total concentrations for sweep calculations

      do ic = 1,nc-1
        totcinit(ic) = totco(ic,tid)
      end do

!c  guess for concentrations of components as species in solution

      call guess(ccnew,ccold,tempk,ilog,tid)

!c  -> volume fraction and representative grain radii, 
!c     control parameter for equilibration of minerals 
!c     with aqueous species
 
      if (reactive_minerals) then

        subsection = 'mineral input'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'reading mineral parameters'
          end if

          do im=1,nm
            
            if (rank == 0 .and. b_enable_output) then
              write(ilog,*) trim(namem(im))
            end if

            ierrcd = 21
            read(icnv,*,end=999,err=999) phic(im,tid),minequil(im),   &
                                        update_type(im)
            phic(im,:) = phic(im,tid)
            
            if (.not.tstart_to_tfinal.and..not.tstart_to_equil) then
              minequil(im) = .false.
            end if
            if (rate_control(im).eq.'transport'.or.                   &
               rate_control(im).eq.'mixed') then
              update_type(im) = 'geometric'
            end if

            if (update_type(im).eq.'geometric') then
              ierrcd = 22
              read(icnv,*,end=999,err=999) phimin(im),scalfac(im),    & 
                                          supsatm(im)
              read(icnv,*,end=999,err=999) radi(im), rads(im,tid),    &
                                          radmin(im)
              rads(im,:) = rads(im,tid)
            elseif (update_type(im).eq.'constant'.or.                 &
                   update_type(im).eq.'twothird') then
              ierrcd = 23
              read(icnv,*,end=999,err=999) phimin(im), areac(im),     & 
                                          supsatm(im)
            elseif (update_type(im).eq.'twothird-mix') then
              ierrcd = 24
              read(icnv,*,end=999,err=999) phimin(im), areac(im),     & 
                                          supsatm(im), phinuc(im)              
             elseif (update_type(im).eq.'exponent') then
               ierrcd = 25
              read(icnv,*,end=999,err=999) phimin(im), areac(im),     &
                                          expphi(im)
            elseif (update_type(im).eq.'exponent2') then              
              ierrcd = 26
              read(icnv,*,end=999,err=999) phimin(im), areac(im),     &
                                          expphi(im)
            else if (update_type(im).eq.'linear' ) then
              ierrcd = 27
              read(icnv,*,end=999,err=999) phimin(im), areac(im),     & 
                                          supsatm(im), phinuc(im)
!c sung-wook's (Dec. 8/2003)
            elseif (update_type(im).eq.'reactivity') then
              ierrcd = 28
              read(icnv,*,end=999,err=999) phimin(im), areac(im),     &
                                           supsatm(im)
            end if

!c  Apply global scaling factor for mineral reactivity. 
!c  By default, this factor is one when it is not specified.
            if (update_type(im).eq.'geometric') then
              scalfac(im) = scalfac(im)*scalfac_min(im)
            else
              areac(im) = areac(im)*scalfac_min(im)
            end if

!c  -> modify minimum mineral volume fraction to avoid division by zero

          if (phimin(im).lt.1.0d-50) then
            phimin(im)= 1.0d-50
          end if
!c  -> modify volume fraction nucleation threshold to avoid zero
          if (phinuc(im).lt.phimin(im)) then
              phinuc(im) = phimin(im)
          end if
          
         
!c  -> modify level of supersaturation required for precipitation,
!c     if specified close to saturation, to avoid numerical problems

            if (supsatm(im).lt.r_1) then
             supsatm(im) = -r_1              
            end if

          end do

!c  convert volume fractions to concentrations in [moles/l bulk]
!c  and compute initial mineralogical parameters
         
          do im=1,nm
            call initgeom(im,idbg)
          end do

!c  distribute mineralogical parameters 

          call distmp(cmcnew(:,tid),phic(:,tid),areac,tid)
          do itid = 1, nthreads
            cmcnew(:,itid) = cmcnew(:,tid)
            phic(:,itid) = phic(:,tid)
            phiinit(:,itid) = phiinit(:,tid)
            cmcmin(:,itid) = cmcmin(:,tid)
          end do

        else

          if (rank == 0) then

            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file in icrtlczn-4'
            write(ilog,*) 'section "',trim(section_header),'"'
            write(ilog,*) 'zone "', trim(zone_name),'"'
            write(ilog,*) 'subsection "',trim(subsection),'" missing'
            close(ilog)
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          end if

        end if       !(found subsection)

!c  read parameters for intermittent reaction
        if (reactive_transport) then

          subsection = 'intermittent reactions'
          call findstrg(subsection,icnv,found_subsection)

          nirm = 0
          if (found_subsection) then
            ierrcd = 29
            read(icnv,*,err=999,end=999) nirm
            iairm(izone+1) = iairm(izone) + nirm
          end if

          if (nirm > 0) then

            !c read intermittent reaction minerals
            ierrcd = 30
            do iirm = 1, nirm
              read(icnv,*,err=999,end=999) name_irm
              found = .false.

              do im = 1, nm
                if (namem(im) .eq. name_irm) then
                  jairm(iairm(izone)+iirm-1) = im

                  imizn2jairm(im,izone) = iairm(izone)+iirm-1

                  found = .true.
                  exit
                end if
              end do

              if (.not.found) then
                if (rank == 0) then
                  write(*,*) 'Error: specified intermittent reaction mineral not found'
                  write(ilog,*) 'Error: specified intermittent reaction mineral not found'
                end if
                goto 999
              end if

            end do

            !c read intermittent reaction periods and coefficients
            ierrcd = 31            
            read(icnv,*,err=999,end=999) nirt

            iairt(izone+1) = iairt(izone) + nirt
            iairc(izone+1) = iairc(izone) + nirt*nirm

            do iirt = 1, nirt
              iindex = iairt(izone)+iirt-1
              istart = iairc(izone)+(iirt-1)*nirm
              iend = istart + nirm-1

              read(icnv,*,err=999,end=999) irt(iindex), irc(istart:iend)

              !c convert to internal time unit
              irt(iindex) = irt(iindex)*time_factor              
            end do

          end if

        end if

      end if         !(reactive_minerals)

!c  write control parameters for current zone to generic output file
      if(b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/a)') 'control parameters: '
        write(igen,'(72a/)') ('-',i=1,72)
      end if

      if (reactive_minerals) then          
       if(b_enable_output .and. b_enable_output_gen) then  
        write(igen,'(a)') 'equilibration with minerals specified'
        if (lb_output .and. b_enable_output) then
          write(igen,'(a)') 'output of local c.vs.t profiles'
        else
          write(igen,'(a)') 'no output of c.vs.t profiles'
        end if           !(lb_output)
        write(igen,'(a,1pe15.6e3,1x,a)')                              &
       'time step for local chemistry computations    =',delt_lc(tid),&
                                                         time_unit_lc
        if (tstart_to_tfinal) then
        write(igen,'(a,1pe15.6e3,1x,a)')                              &
        'final solution time                           =',tfinal_lc,  &
                                                         time_unit_lc
        end if
       end if

!c  conversion of time units for computation in days

        delt_lc(:) = time_factor_lc * delt_lc(:)
        tfinal_lc = time_factor_lc * tfinal_lc

      elseif (.not.reactive_minerals) then  
       if(b_enable_output .and. b_enable_output_gen) then   
        write(igen,'(a)') 'equilibration only for aqueous species'
       end if 
      end if             !(reactive_minerals)

!c  noble gas ingrowth related input
      if (b_use_ngi) then
        subsection = 'solid phase density'
        call findstrg(subsection,icnv,found_subsection)        
        if (found_subsection) then
          ierrcd = 32
          read(icnv,*,err=999,end=999) density_rock_ngi_lzn(tid)
        end if

        subsection = 'noble gas ingrowth - concentration of radioelements'
        call findstrg(subsection,icnv,found_subsection)        
        if (found_subsection) then
          ierrcd = 33
          if (b_combine_238u_235u) then

            conc_ngre_lzn(ngre_i,tid) = r0

            do i = 1, ngre_i-1
              read(icnv,*,err=999,end=999) conc_ngre_lzn(i,tid)

              if (trim(name_ngre_i(i)).eq.'235u' .or. &
                  trim(name_ngre_i(i)).eq.'238u') then
                conc_ngre_lzn(ngre_i,tid) = conc_ngre_lzn(ngre_i,tid) +  &
                                            conc_ngre_lzn(i,tid)
              end if

            end do
          else
            do i = 1, ngre_i
              read(icnv,*,err=999,end=999) conc_ngre_lzn(i,tid)
            end do
          end if
        end if

        subsection = 'constant radioelement concentration'
        call findstrg(subsection,itmp,found_subsection)
        if (found_subsection) then
          conc_ngre_const_lzn(tid) = .true.
        end if

        subsection = 'noble gas ingrowth - weight fraction of elements'
        call findstrg(subsection,icnv,found_subsection)        
        if (found_subsection) then
          ierrcd = 34
          do i = 1, nge_i
            read(icnv,*,err=999,end=999) wtfrac_nge_lzn(i,tid)
          end do
        end if

        subsection = 'noble gas ingrowth - neutron capture probability'
        call findstrg(subsection,icnv,found_subsection)        
        if (found_subsection) then
          ierrcd = 35
          do i = 1, ngnce_i
            read(icnv,*,err=999,end=999) ncp_ngnce_lzn(i,tid)
          end do
        end if

      end if

!c    disable the following output        
      if(b_enable_output .and. b_enable_output_gen) then
      
!c  write input parameters for current zone to generic output file

      write(igen,'(/a)') 'input parameters: '
      write(igen,'(72a)')('-',i=1,72)

!c  aqueous chemistry

      write(igen,'(/a)')'total aqueous component concentrations:'
      write(igen,'(a)')'---------------------------------------'
      write(igen,'(a)')'component             conc.'
      write(igen,'(a)')'---------------------------'
      do ic=1,nc-1
        if (ctype(ic).eq.'free'.and.  &
            component_type(ic).eq.'aqueous') then
          write(igen,'(a12,1x,1pe15.6e3)') namec(ic),totco(ic,tid)
        end if
      end do

      icount = 0
      do ic=1,nc-1
        if (ctype(ic).eq.'fixed'.and. &
           component_type(ic).eq.'aqueous') then
          icount = icount +1
          if (icount.eq.1) then
            write(igen,'(/a)')    &
            'aqueous components with fixed activities:'
            write(igen,'(a)')'-----------------------------------------'
            write(igen,'(a)')'species               actv.'
            write(igen,'(a)')'---------------------------'
          end if
          write(igen,'(a12,1x,1pe15.6e3)') namec(ic),actv(ic)
        end if
      end do

      do ic=1,nc-1
        if (ctype(ic).eq.'charge'.and.    &
            component_type(ic).eq.'aqueous') then
          write(igen,'(/3a)')'total aqueous component concentrations ',&
                             'of component ',namec(ic)(:l_namec(ic))
          write(igen,'(a)')'to be determined by charge balance'
        end if
      end do
      
      if (nbio.gt.0) then
      
        write(igen,'(/a)')'biomass concentrations:'
        write(igen,'(a)')'-----------------------'
        write(igen,'(a)')'component             conc.'
        write(igen,'(a)')'---------------------------'
        do ic=1,nc-1
          if (ctype(ic).eq.'free'.and.  &
     &        component_type(ic).eq.'biomass') then
            write(igen,'(a12,1x,1pe15.6e3)') namec(ic),totco(ic,tid)
          end if
        end do
        
      endif

      write(igen,'(/a,f8.4)')     &
      'guess for pH of solution:          pH =', phguess

!c  non-competitive sorption

      if (noncompetitive_sorption.and.section_header.ne.  &
          'boundary conditions - reactive transport') then

!c  linear isotherm

        if (nlinear.gt.0) then
          write(igen,'(/a)')'parameters for linear sorption:'
          write(igen,'(a)') '-------------------------------'          
          write(igen,'(a)')'component    distribution coefficient'
          write(igen,'(a)')'                      [-]            '
          write(igen,'(a)')'----------------------------------------'
          do ic = 1,nc
            if (isotherm_type(ic).eq.'linear') then
              write(igen,'(a12,1x,1pe15.6e3)') namec(ic), distcoff_lc(ic)
            end if
          end do
      
        end if
      
!c  Freundlich isotherm
           
        do ic = 1,nc
        if (isotherm_type(ic).eq.'freundlich') then
        end if
      end do

!c  Langmuir isotherm

        do ic = 1,nc
        if (isotherm_type(ic).eq.'langmuir') then
        end if
      end do

    end if

!c  competitive sorption

      if ((nsb_ion.gt.0.or.nsb_surf.gt.0).and.section_header.ne. &
          'boundary conditions - reactive transport') then
          write(igen,'(/a)')'sorption parameters:'
          write(igen,'(a)')'--------------------'

!c  output for surface-complexation reactions

        if (sorption_group.eq.'surface-complexation'.or.(nsb_surf.gt.0 &
            .and.sorption_group.eq.'surface-complex and ion-exchange')) then

          write(igen,'(2a)')'surface site    solid mass     ',    &
                           'surface area   site density'
          write(igen,'(2a)')'                [g/l h2o]      ',    &
                           '[m^2/g]        [sites/nm^2]'
          write(igen,'(2a)')'-------------------------------',    &
                           '---------------------------'
          do ic=1,nc
            if (component_type(ic).eq.'surface') then
              isites = iais(ic)
              write(igen,'(a12,2x,3(1pe15.6e3,3x))') namec(ic),   &
                                                site_mass(isites),&
                                                site_area(isites),&
                                                site_dens(isites)
            end if
          end do
        end if

!c  output for-ion exchange reactions

        if (sorption_group.eq.'ion-exchange'.or.(nsb_ion.gt.0 &
            .and.sorption_group.eq.'surface-complex and ion-exchange')) then

          write(igen,'(a,1pe15.6e3)')                                 &
         'cation exchange capacity [meq/100g soil]            = ',    &
          cec(tid)
           write(igen,'(a,1pe15.6e3)')                                &
         'dry bulk density [g/cm^3]                           = ',    &
          rhobulk
        end if
      end if

!c  minerals

      if (nm.gt.0.and.reactive_minerals) then

        write(igen,'(/a)')'minerals:'
        write(igen,'(a)')'---------'

        do im = 1,nm
          write(igen,'(a)') trim(namem(im))
          write(igen,'(2a)') 'type of reaction control: ',            &
                             rate_control(im)
          write(igen,'(2a)') 'type of surface area update: ',         &
                             update_type(im) 
          write(igen,'(a,1pe15.6e3)')                                 &
            'volume fraction                                     = ', &
             phic(im,tid)
          write(igen,'(a,1pe15.6e3)')                                 &
           'min. volume fraction                                = ',  &
            phimin(im)
          write(igen,'(a,1pe15.6e3)')                                 &
           'level of supersaturation required for precipitation = ',  &
            dmax1(supsatm(im),r0)
          if (update_type(im).eq.'geometric') then
            write(igen,'(a,1pe15.6e3)')                               &
             'scaling factor                                      = ',&
              scalfac(im)
            write(igen,'(a,1pe15.6e3)')                               &
             'particle radius                                     = ',&
              radi(im)
            write(igen,'(a,1pe15.6e3)')                               &
             'radius of unreacted core                            = ',&
              rads(im,tid)
            write(igen,'(a,1pe15.6e3)')                               &
             'min. radius of unreacted core                       = ',&
              radmin(im)
          elseif (update_type(im).eq.'constant'.or.                   &
                 update_type(im).eq.'twothird'.or.                    &
                 update_type(im).eq.'twothird-mix'.or.                &
                 update_type(im).eq.'exponent2'.or.                   &
                 update_type(im).eq.'exponent' .or.                   &
                 update_type(im).eq.'reactivity'.or.                  &
                 update_type(im).eq.'linear' ) then
            write(igen,'(a,1pe15.6e3)')                               &
             'reactive surface area                               = ',&
              areac(im)
          end if
          write(igen,'(72a)')  ('-',i=1,72)
        end do

      end if            !(nm.gt.0.and.reactive_minerals)
      
      end if

      goto 1000

!c  define length of section header

999   continue
      if (rank == 0 .and. b_enable_output) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file in icrtlczn-5, error code ',ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end 
