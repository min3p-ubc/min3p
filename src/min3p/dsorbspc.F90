!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 675 $
!> $Author: dsu $
!> $Date: 2019-01-22 10:29:22 -0800 (Tue, 22 Jan 2019) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/dsorbspc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine dsorbspc
!c -------------------
!c compute analytical derivative of concentration of sorbed species based on 
!c concentrations of primary species
!c
!c dcsb = d(csb(isb))/d(c(kc))
!c
!c written by:      Uli Mayer - July 7, 1998
!c
!c last modified:   -
!c                  
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of primary species   + -
!c           cec                = cation excahnge capacity            + -
!c           dcsb               = derivative of concentration of      * +
!c                                sorbed species
!c           eqsb(nsb)          = equilibrium constant for formation  + -
!c                                of sorbed species from primary 
!c                                species
!c           eqsb_ion(nsb_ion)  = equilibrium constant for formation  + -
!c                                of sorbed species from primary 
!c                                species (ion-exchange)
!c           eqsb_surf(nsb_surf)= equilibrium constant for formation  + -
!c                                of sorbed species from primary 
!c                                species (surface-complex)
!c           gammac(*)          = activity coefficients for primary   + -
!c                                species
!c           xnusb(*)           = stoichiometric coefficient of       + -
!c                                primary species in sorbed
!c                                species
!c
!c           integer*4:
!c           ----------
!c           iasb(*)            = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed
!c                                species
!c           isb                = pointer to secondary species        + -
!c           jasb(*)            = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                primary species in sorbed
!c                                species 
!c           kc                 = pointer
!c           nsb                = number of sorbed species            + -
!c
!c
!c local:    real*8:
!c           -------
!c           g                = function g (nominator)
!c           gprime           = derivative of g
!c           h                = function h (denominator)
!c           hprime           = derivative of h
!c           r0               = constant
!c           r1               = constant
!c           r2               = constant
!c           term1            = intermediate term
!c           term2            = intermediate term
!c           term3            = intermediate term
!c
!c           integer*4:
!c           ----------
!c           i1               = counter
!c           ic               = counter (primary species)
!c           istart           = pointer
!c           istop            = pointer
!c           ksb              = counter (sorbed species)
!c
!c external: -  
!c ----------------------------------------------------------------------
!cMX This function has never been used!
  
      subroutine dsorbspc(dcsb,cec,eqsb,gammac,c,xnusb,iasb,jasb, &
                         nsb,isb,kc)
 
      implicit none
      real*8 :: dcsb, cec, eqsb, gammac, c, xnusb
      integer :: iasb, jasb, nsb, isb, kc

      dimension c(*),eqsb(*),gammac(*),xnusb(*),iasb(*),jasb(*)

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0

      !c local variables
      integer :: istart, istop, i1, ic, ksb
      real*8 :: g, gprime, h, hprime, term1, term2, term3,

!c  compute g(C_j)

      g = cec/eqsb(isb)
      term1 = r0

      istart = iasb(isb)
      istop = iasb(isb+1)-1

      do i1 = istart,istop

        ic = jasb(i1)
        g = g * (gammac(ic)*c(ic))**xnusb(i1)

        if (ic.eq.kc) then
          term1 = xnusb(i1)/(gammac(ic)*c(ic))
        end if

      end do

!c  compute g'(C_j)

      gprime = g * term1

!c  compute h(C_j) and h'(C_j)
 
      h = r0
      hprime = r0

      do ksb = 1,nsb

        term2 = r1/eqsb(ksb)
        term3 = r0

        istart = iasb(ksb)
        istop = iasb(ksb+1)-1

        do i1 = istart,istop

          ic = jasb(i1)

          term2 = term2 * (gammac(ic)*c(ic))**xnusb(i1)

          if (ic.eq.kc) then
            term3 = xnusb(i1)/(gammac(ic)*c(ic))
          end if

        end do

!c  sum up h(C_j)

        h = h + term2

!c  sum up h'(C_j)

        hprime = hprime + term2 * term3

      end do

!c  compute derivative of concentration of sorbed species
     
!c     write(*,*) 'g ', g
!c     write(*,*) 'gprime ', gprime
!c     write(*,*) 'h ', h
!c     write(*,*) 'hprime ', hprime
!c     write(*,*) g/h
!c     pause
 
      dcsb = (gprime * h - g * hprime) / h**r2

      return
      end
