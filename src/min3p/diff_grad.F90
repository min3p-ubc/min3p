!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 303 $
!> $Author: dsu $
!> $Date: 2015-05-04 10:58:10 -0700 (Mon, 04 May 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/diff_grad.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine diff_grad
!c --------------------------
!c
!c compute gradients that drive diffusive fluxes using the DGM model
!c
!c written by:  Sergi Molins - May 2, 2006
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c_i(ng)            = gaseous species concentrations      + -
!c                                at control volume i
!c           c_j(ng)            = gaseous species concentrations      + -
!c                                at control volume j
!c           molfrac(ng)        = gas molar fraction at interface i   + -
!c           zgi                = elevation at control volume i       + -
!c           zgj                = elevation at control volume j       + -
!c           dens               = gas density at interface i-j        + -
!c           tempkel            = temperature at interface i-j [K]    + -
!c           gporx              = porosity at interface i-j           + -
!c           delta_ijx          = distance between nodes i - j [m]    + -
!c           grad_diff(ng)      = gradient for gas diffusion          * +
!c                                [moles L^-1 m^-1]
!c
!c gen.f:    real*8:
!c           -------
!c           gacc               = gravity m s^-2                      + -
!c
!c           logical:
!c           -------
!c           gas_gravity        = enable gas gravity in advection     + -
!c
!c chem.f    real*8:
!c           -------
!c           rgasjoule          = ideal gas constant
!c                                [J/(deg K mol)]
!c
!c           integer*4:
!c           ----------
!c           ng                 = number of gas species               + -
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           small            = constant
!c
!c           integer*4:
!c           ----------
!c           ic               = index
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine  diff_grad (c_i       ,c_j        ,  &
                             molfrac   ,              &
                             zgi       ,zgj        ,  &
                             dens      ,tempkel    ,  &
                             gporx     ,              &
                             delta_ijx ,              &
                             grad_diff )
 
      use gen
      use chem
    
      implicit none
      
!c------------------------------------------------

!c     constants
      real, parameter :: small = 1.0d-30

!c     passed
      real*8       c_i(ng)         ,c_j(ng)        ,  &
                   molfrac(ng)     ,                  &
                   zgi             ,zgj            ,  &
                   dens            ,tempkel        ,  &
                   gporx           ,                  &
                   delta_ijx       ,                  &
                   grad_diff(ng)  
    
!c     internal
      integer*4    ic
    
!c---------------------------------------------------------------------------
!c     check if there is gas phase
      if (gporx.lt.small) then
!c       no gas phase: do not calculate fluxes
      else
!c---------------------------------------------------------------------------
!c       gradient
        if (.not.gas_gravity) then  ! do not include gravity
        
          do ic=1,ng
            grad_diff(ic) = (c_j(ic) - c_i(ic)) / delta_ijx
          enddo
       
        else                        ! include gravity
        
          do ic=1,ng
            grad_diff(ic) = (c_j(ic) - c_i(ic)) / delta_ijx            &
                            + dens * gacc * molfrac(ic) * (zgj - zgi)  &
                            / delta_ijx / rgasjoule / tempkel / 1.d3
          enddo
        
        endif


      endif ! calculation of fluxes
!c---------------------------------------------------------------------------
             
      return
      end