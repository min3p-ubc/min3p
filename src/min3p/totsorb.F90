!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/totsorb.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine totsorb
!c -------------------
!c
!c compute total sorbed component concentrations or derivative of total
!c sorbed component concentrations
!c
!c written by:      Uli Mayer - July 6, 98
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           csb(nsb)           = concentrations of sorbed species    + -
!c           csb_ion(nsb_ion,nthreads)
!c                              = concentrations of sorbed species    + -
!c                                (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    + -
!c                                (surface-complex)
!c           chargesb(nsb)      = charge of sorbed species            + -
!c           chargesb_ion(nsb_ion)   = charge of sorbed species       + -
!c                                     (ion-exchange)
!c           chargesb_surf(nsb_surf) = charge of sorbed species       + -
!c                                     (surface-complex)
!c           rhobulk            = dry bulk density [g/cm^3]           + -
!c           totcsb(nc-1)       = total sorbed component              + +
!c                                concentrations [moles/l bulk]
!c           totcsb_ion(nc-1)   = total sorbed component              + +
!c                                concentrations [moles/l bulk]
!c                                (ion-exchange)
!c           totcsb_surf(nc-1)   = total sorbed component              + +
!c                                concentrations [moles/l bulk]
!c                                (surface-complex)
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                species from primary species
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                species from primary species
!c                                (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                species from primary species
!c                                (surface-complex)
!c
!c           integer*4:
!c           ----------
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (surface-complex)
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed species
!c                                (surface-complex)
!c           nc                 = number of components including h2o  + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r100               = conversion factor
!c 
!c           integer*4:
!c           ----------
!c           i1                 = counter (stoichiometric
!c                                         coefficients)
!c           ic                 = counter (components)
!c           isb                = counter (sorbed species) 
!c           istart             = pointer (stoichiometric 
!c                                         coefficients)
!c           istop              = pointer (stoichiometric
!c                                         coefficients)
!c
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine totsorb(csb_ion,csb_surf,chargesb_ion,rhobulk,               &
                         totcsb_ion,totcsb_surf,xnusb_ion,xnusb_surf,         &
                         iasb_ion,iasb_surf,jasb_ion,jasb_surf,nc,nsb_ion,    &
                         nsb_surf,namec)
                                                                       
      implicit none
                                                                       
      character*72 namec                                               
      real*8 :: rhobulk 
      real*8 :: csb_ion, csb_surf, chargesb_ion,                       &
                totcsb_ion, totcsb_surf, xnusb_ion, xnusb_surf     
      integer :: iasb_ion,iasb_surf,jasb_ion,jasb_surf,nc,nsb_ion,     &
                 nsb_surf
      dimension csb_ion(*),csb_surf(*),chargesb_ion(*),                &
                totcsb_ion(*),totcsb_surf(*),xnusb_ion(*),xnusb_surf(*), &
                iasb_ion(*),iasb_surf(*),jasb_ion(*),jasb_surf(*),namec(*)
      
      !local variables
      real*8 :: r0, r100
      integer :: i1, ic, isb, istart, istop

      parameter (r0 = 0.0d0, r100 = 100.0d0)
 
      if (nsb_ion.gt.0) then
          
        do ic=1,nc-1
          totcsb_ion(ic) = r0
        end do

!c  add up exchanged species and convert from [meq/100g] solid to 
!c  [mmol/100g solid]
 
        do isb=1,nsb_ion
          istart = iasb_ion(isb)
          istop = iasb_ion(isb+1)-1
          do i1 = istart,istop
            ic = jasb_ion(i1)
 
!c  skip h2o, since not a primary unknown
 
            if (namec(ic).ne.'h2o') then
              totcsb_ion(ic) = totcsb_ion(ic)+xnusb_ion(i1)*csb_ion(isb)/chargesb_ion(isb)
            end if
          end do
        end do
 
!c  convert from [mmol/100g solid] to [mol/L bulk] 

        do ic=1,nc-1
          totcsb_ion(ic) = rhobulk/r100*totcsb_ion(ic)
        end do
        
      end if  

      if (nsb_surf.gt.0) then
          
        do ic=1,nc-1
          totcsb_surf(ic) = r0
        end do
     
!c  add up sorbed species

        do isb=1,nsb_surf
          istart = iasb_surf(isb)
          istop = iasb_surf(isb+1)-1
          do i1 = istart,istop
            ic = jasb_surf(i1)

!c  skip h2o, since not a primary unknown

            if (namec(ic).ne.'h2o') then
              totcsb_surf(ic) = totcsb_surf(ic)+xnusb_surf(i1)*csb_surf(isb)
            end if
          end do
        end do

      end if

      return
      end
