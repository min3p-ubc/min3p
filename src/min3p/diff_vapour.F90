!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/diff_vapour.F90 $
!---------------------------------------------------------------------
!********************************************************************!


real*8 function diff_vapour (unk_ivol,unk_jvol,dens_ivol,dens_jvol,por_ivol,por_jvol, &
                             sa_ivol,sa_jvol,cinf,coeff_ivol,coeff_jvol,heatcap,ups_fac, &
                             isboussinesq)
 

 
implicit none

real*8, intent(in)     :: unk_ivol      
real*8, intent(in)     :: unk_jvol
real*8, intent(in)     :: por_ivol
real*8, intent(in)     :: por_jvol
real*8, intent(in)     :: coeff_ivol
real*8, intent(in)     :: coeff_jvol 
real*8, intent(in)     :: dens_ivol    ! density ivol
real*8, intent(in)     :: dens_jvol    ! density jvol
real*8, intent(in)     :: sa_ivol      !  
real*8, intent(in)     :: sa_jvol   
real*8, intent(in)     :: ups_fac      ! upstream factor
real*8, intent(in)     :: cinf         ! influence coefficient
real*8, intent(in)     :: heatcap 
logical, intent(in)    :: isboussinesq   


real*8                 :: dunk,sa_av,coeff,fluxdd,por_av,coeff_av   

real*8, parameter      :: r0=0.0d0, r1=1.0d0, rhalf=0.5d0

dunk = unk_jvol - unk_ivol

sa_av = rhalf*(sa_jvol+sa_ivol)
por_av = rhalf*(por_jvol+por_ivol)
coeff_av = rhalf*(coeff_jvol+coeff_ivol)

if (isboussinesq) then
    coeff = por_av * sa_av         
else  

  if (dunk > r0) then               
    coeff = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol
  else                   
    coeff = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol
  end if

end if
coeff = coeff * sa_av * por_av * heatcap * coeff_av 

diff_vapour = - fluxdd(dunk,cinf,coeff)

return
end function 
