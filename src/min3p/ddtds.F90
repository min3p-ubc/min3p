!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/ddtds.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine ddtds
!c -----------------
!c
!c assign fluid densities and viscosities as a function of total component 
!c concentrations and an empirical linear coefficient taken
!c using the formula 
!c density = freshwater density + EC, where
!c
!c written by:      Tom Henderson - October 8, 2002
!c
!c last modified:   Tom Henderson - November 12, 2003
!c                  added mass fraction and viscosity calculation
!c                  excluded protons from TDS calculation
!c
!c                  Danyang Su    - March 14, 2014
!c                  HPC capabilities
!c
!c references:
!c
!c from SOLMINEQ.88
!c
!c density = 1.0 + 6.88E-7 * total dissolved solids (mg/L)
!c         = freswater density (M/L^3) + 0.688 * TDS (M/L^3)
!c
!c from Herbert et al. 1988
!c
!c viscosity = 1.002e-3 * (1. + 0.4819 * Cm - 0.2774 * Cm^2 
!c                         + 0.7814 * Cm^3)
!c
!c with Cm = solute mass fraction
!c
!c from SUTRA documentation, p. 17
!c
!c c = rho * Cm
!c
!c with c = solute volumetric concentration
!c
!c density calculation:
!c -------------------- 
!c SOLMINEQ.88: A Computer Program for Geochemical 
!c Modeling of Water-Rock Interactions, Kharaka et al., 1988
!c USGS Water-Resources Investigations Report 88-4227
!c
!c User's Guide to SEAWAT: A Computer Program for Simulation
!c of Three-Dimensional Variable-Density Ground-Water Flow,
!c Guo and Langevin, 2002, USGS Open-File Report 01-434
!c
!c SUTRA: A finite element simulation model for saturated-
!c unsaturated, fluid density-dependent ground-water flow with 
!c energy transport or chemically reactive single-species
!c solute transport, Voss, USGS, 1984
!c
!c viscosity calculation:
!c ----------------------
!c Coupled groundwater flow and solute transport with fluid density
!c strongly dependent upon concentration, Herbert et. al, WRR 24(10)
!c 1781-1795, 1988   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c common:
!c gen.f:    real*8:
!c           -------
!c           totcnew(n,nn)      = total aqueous component             * +
!c
!c           integer*4:
!c           ----------
!c           nn                 = total number of control volumes     + -
!c           n                  = number of primary unknowns          + -
!c
!c
!c chem.f:   real*8:
!c           -------
!c           gfwc(nc)           = gram formula weight of components   * +
!c                                concentrations
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c
!c dens.f:   real*8:
!c           -------  
!c           density(nn)        = fluid density                       * +
!c           tds_new(nn)        = total dissolved solids [mg/L]       * +
!c                                at current time step
!c           tds_old(nn)        = total dissolved solids [mg/L]       * +
!c                                at previous time step
!c           viscosity(nn)      = fluid viscosity                     * +
!c
!c local:    real*8:
!c           -------
!c           solmin             = constant
!c           r1                 = constant
!c           tds_ic             = conversion from moles to mg for 
!c                                each component
!c           tot_tds            = sum of TDS for nc-1 components
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           ic                 = counter (components)
!c           itemp              = pointer
!c
!c external: - 
!c ----------------------------------------------------------------------

      subroutine ddtds

      use parm
      use gen
      use chem
      use dens
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: ic, itemp, ivol
      
      real*8,parameter :: r0 = 0.0d0, r1 = 1.0d0, visc_h2o = 1.0d-3,   &
                          visc_coef1 = 1.85d0, visc_coef2 = -4.1d0,    &
                          visc_coef3 = 4.45d1
                          !visc_coef1=0.4819d0, visc_coef2=-0.2774d0,  & different in the parameters as described in thesis Tom Henderson, 2009, DSU
                          !visc_coef3=0.7814d0

      logical iserror
      external zero_r8_parallel
      integer, parameter :: iscreen=6 

!c clear density and viscosity vectors

    !   call zero_r8_parallel(density,nngl,1,1)
    !   call zero_r8_parallel(tds_new,nngl,1,1)

      if (update_viscosity) then
        viscosity = r1
      end if

!c  sum TDS in each control volume
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_ddtds_1)                        &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ic, itemp, ivol, iserror,                          &
    !$omp cpz_loc, massfrac, tds_ic, tot_tds)                  
    !$omp do schedule(static)
#endif
      do ivol = 1,nngl    !loop over control volumes

        tot_tds = r0

        do ic=1,nc-1
          itemp = ncorder(ic) 
          if ((namec(itemp) .ne. 'h+').and.       & ! ignore protons and 
              (namec(itemp) .ne. 'h+1').and.      & !cprovi In the thermodynamic data base the proton is written as h+1  
              (namec(itemp) .ne. 'o2(aq)').and.   & ! dissolved gasses for TDS  
              (namec(itemp) .ne. 'h2(aq)').and.   & ! calculation: hardwired
              (namec(itemp) .ne. 'n2(aq)').and.   &
              (namec(itemp) .ne. 'ch4(aq)')) then
          
            if (specify_dd_comp) then
              tds_ic = totcnew(itemp,ivol) * gfwdd(itemp) ! M/L --> g/L = Kg/M^3
            else
              tds_ic = totcnew(itemp,ivol) * gfwc(itemp)  ! M/L --> g/L = Kg/M^3
            end if          
            tot_tds = tot_tds + tds_ic
          end if
        end do
 
        tds_new(ivol) = tot_tds
        !cprovi----------------------------------------------------------
        !cprovi----------------------------------------------------------
        !cprovi----------------------------------------------------------
        if (ispitzerdens) then
          !cprovi------------------------------------------------
          !cprovi Copy the molalities in the local vector 
          !cprovi------------------------------------------------
          cpz_loc(1:nc)=cnew(1:nc,ivol)
          cpz_loc(nc+1:nc+nx)=cx(1:nx,ivol)  
          call compute_density_ (phase,r0,r0,cpz_loc,density(ivol),.false., &
                                    iserror)
          if (iserror) then          
           if(rank == 0 .and. b_enable_output) then
              write (ilog,*) 'Error when call compute_density_ in the phase object' 
              write (iscreen,*) 'Error when call compute_density_ in the phase object'
              close(ilog)
           end if
#ifdef PETSC
           call petsc_mpi_finalize
#endif
           stop
          end if 
        else
          density(ivol) = ref_dens + drho_dc * tds_new(ivol) !Kg/M^3
        end if
        !cprovi----------------------------------------
        !cprovi Update viscosity as a function 
        !cprovi of the concentrations  
        !cprovi----------------------------------------
        if (update_viscosity) then

          massfrac = tot_tds / density(ivol)   ! c [M/L] = rho * massfrac [Kg/Kg]
          viscosity(ivol) = visc_h2o * (r1 + visc_coef1 * massfrac     &
                                           + visc_coef2 * massfrac**2  &
                                           + visc_coef3 * massfrac**3)
        end if 
      
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 
      return
      end
