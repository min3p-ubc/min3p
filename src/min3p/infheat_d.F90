!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/infheat_d.F90 $
!---------------------------------------------------------------------
!********************************************************************!

! ----------------------------------------------------------------------
! subroutine infheat_d                                                   
! -------------------                                                   
!                                                                       
! compute influence coefficients for advective and dispersive flux      
! terms for rectangular, cartesian finite volume discretization         
! (reactive transport) for aqueous phase using density dependent        
! flow equation                                                         
!                                                                       
! definition of variables:                                              
!                                                                       
! I --> on input   * arbitrary  - initialized  + entries expected       
! O --> on output  * arbitrary  - unaltered    + altered                
!                                                                    I O
!     input:                                                            
!                                                                       
! passed:   real*8:                                                     
!           -------                                                     
!           d(3, ibk)          = dimension of cells in x,y,z         + -
!                                direction                              
!           density(nn)        = fluid density                       + -
!           dvolcoef           = volume flux coefficient including   * +
!                                viscosity and relative permeability    
!           diffu              = phase molecular diffusion (m2/day)     
!           disx(nzn)          = dispersion, x direction (m)            
!           disy(nzn)          =    "      , y    "      (m)            
!           disz(nzn)          =    "      , z    "      (m)            
!           cinfrt_va()        = influence coefficients                 
!                                J^w_ij/A_ij                            
!                                (advective flux terms)                 
!           cinfrt_da()        = influence coefficients                 
!                                D_ij * A_ij / d_ij                     
!                                (dispersvie flux terms)                
!           viscosity(nn)      = fluid viscosity                     - -
!                                                                       
!           integer*4:                                                  
!           ----------                                                  
!           ibk                = block i                                
!           id                 = connected block j                      
!           idbg               = output for debugging information       
!           ilog               = unit number, logbook                   
!           nmax               = max cells for dim purposes             
!           nphas              = max number of phases                   
!           njamxc             = max dim ja array (ncomp.com)           
!           nvx                = number of control volumes              
!                                in x direction                         
!           nvy                = number of control volumes              
!                                in y direction                         
!           nvz                = number of control volumes              
!                                in z direction                         
!           pornew(ibk)        = porosity                               
!           sanew(nmax)        = aqueous phase saturation               
!                                - new time level                       
!           uvsnew(nmax)       = pressure                               
!           relperm(nmax)      = rel permeability                       
!           cinfvs(nmax)       = influence coefficient                  
!                                (variably saturated flow)              
!           ia(), ja()         = ysmp pointers                          
!           isymm(ii)          = symmetry pointer for cell ibk          
!                                                                       
!           logical:                                                    
!           --------                                                    
!           fully_saturated    = .true.  -> saturated conditions        
!           variably_saturated = .true.  -> .not.fully_saturated,       
!                                        -> variably saturated          
!                                           conditions                  
!           half_cells         = .true.  -> half cells on boundary      
!           tortuosity_corr    = .true.  -> Millington-Quirk            
!                                           tortuosity correction       
!                                           for diffusion               
!                                           coefficients                
!                                                                       
!                                                                       
!                                                                       
! local:                                                                
!                                                                       
! external: diffcoff  = compute effective diffusion coefficient         
       
! ----------------------------------------------------------------------
                                                                        
      subroutine infheat_d (nvx,nvy,nvz,ia,ja,isymm,                   &
                            cinfheat_d,cinfvs,d,                       &
                            disx, disy, disz,                          &
                            pornew, sanew, uvsnew,                     &
                            density, zg, viscosity,relperm,            &
                            idbg, ilog, njamxc, nmax,                  &
                            half_cells,                                &
                            cinfrad, radial_coord,                     &
                            ups_heat,av_dens_z,gacc)   
#ifdef OPENMP
      use omp_lib
      use gen, only : rank, b_enable_output,                           &
                      b_use_fixed_flow_vel,fixed_flow_vel,             &
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infheat_d_1
#else
      use gen, only : rank, b_enable_output,                           &
                      b_use_fixed_flow_vel,fixed_flow_vel
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
                                                                        
      implicit none 
                                                                        
      integer nvx, nvy, nvz, njamxc, nmax, ia(nmax+1), ja(njamxc),      &
              isymm(njamxc), idbg, ilog, nzn                            
                                                                        
      logical half_cells, radial_coord ,av_dens_z 
                                                                        
      real*8  disx(nmax), disy(nmax), disz(nmax),                       &
              pornew(nmax), uvsnew(nmax),                               &
              density(nmax), zg(nmax), viscosity(nmax),                 &
              relperm(nmax),sanew(nmax), d(3,nmax),                     &
              cinfheat_d(njamxc),cinfvs(njamxc),cinfrad(njamxc)         
                                                                        
                                                                        
                                                                        
                                                                        
      real*8 vmag2,ups_heat,areadloc 
                                                                        
                                                                        
!     local variables                                                   
                                                                        
      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0,   &
                 r1 = 1.0d0, r2 = 2.0d0                                 
                                                                        
      real*8 aread(3,12),areax(3,12), vel(3),dist(3,12),                &
             vx2, vy2, vz2, vmag,                                       &
             tend(3),areai,dl,dth,dtv,                                  &
             diffav, diff_eff,disx_avg, disy_avg,                       &
             disz_avg, dflux, delp_dd, delz_dd,                         &
             rho_av, dvolcoef, time, tfinal,tauav,                      &
             relperm_av, visco_av, gacc,darcy_energybal                 
                                                                        
                                                                        
      integer ibk, ivz, ivy, ivx, ibkz, ibky,                           &
              ii, id, ixx, iyy, izz, iisav,                             &
              idim, npair(3), iface(3,12), ndim,                        &
              fvpair(3,12,2), ipair, idim2, idim3                       
                                                                        
                                                                        
      integer ivxp,ivxn,ivyp,ivyn,ivzp,ivzn,nedge,                      &
              izn,jzn,info_debug                              
                                                                        
      character*1 iups 
      
#ifdef OPENMP      
      integer :: nvols
#endif

      external :: zero_r8_parallel
                                                                        
!  compute influence coefficients for advective flux terms              
!  (influence coefficients are equal Darcy flux = J_ij/A_ij)            
                                                                        
!  loop over control volumes                                            
                                                                        
      info_debug = 0 
                                                                        
!  compute the influence coefficients for dispersive flux terms         
!  loop over the number of "pseudo dispersion elements"                 
                                                                        
!  zero the influence coefficient for dispersive flux term              
      call zero_r8_parallel(cinfheat_d, njamxc, 1, 1)
!  loop over control volumes   
#ifdef OPENMP      
      nvols = nvx * nvy * nvz
#endif
                                                                        
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nvols > numofloops_thred_infheat_d_1)                   &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibk, id, idim, idim2, idim3, iface, ii, ipair,     &
    !$omp iisav, ivx, ivy, ivz, ndim, npair, areax, aread, areadloc,  &
    !$omp areai, delp_dd, delz_dd, dflux, dist, disx_avg, disy_avg,   &
    !$omp disz_avg, dl, dth, dtv, fvpair, rho_av,                     &
    !$omp tend, vel, vmag, vmag2, vx2, vy2, vz2)
    !$omp do schedule(static)
#endif                                   
                                  !increments in z-direction           
      do ivz = 1, nvz 
                                  !increments in y-direction            
        do ivy = 1, nvy 
                                  !increments in x-direction             
          do ivx = 1, nvx 
                                                                        
!  find node pairs for elemental velocities as well                     
!  as influence coefficient for node pairs within dipersion element     
            call cliqdisp (nvx, nvy, nvz, ivx, ivy, ivz,                &
     &                     fvpair, npair,aread,areax,dist,d, half_cells,&
     &                     ia, ja, njamxc,                              &
     &                     nmax, idbg, cinfrad, radial_coord)           
!  check if fully connected "pseudo dispersion element"                 
!  was found for dimensionality of problem                              
                                                                        
            if ((nvx > 1 .and. npair(1) == 0) .or.                      &
     &          (nvy > 1 .and. npair(2) == 0) .or.                      &
     &          (nvz > 1 .and. npair(3) == 0)) cycle                 
                                                                        
! loop over the dimensions x,y,z                                        
                                                                        
            do idim = 1, 3 
                                                                        
              idim2 = idim + 1 
              idim3 = idim + 2 
              if (idim2>3) idim2 = idim2 - 3 
              if (idim3>3) idim3 = idim3 - 3 
                                                                        
!  zero advective velocity                                              
                                                                        
              vel(idim) = r0 
                                                                        
!  loop over the number of node pairs in the dimension                  
                                                                        
              do ipair = 1, npair(idim) 
                                                                        
                ibk = fvpair(idim, ipair, 1) 
                id = fvpair(idim, ipair, 2) 
                
                do ii = ia(ibk), ia(ibk+1)-1 
                  if (ja(ii) .eq. id) then 
                    iisav = ii 
                    go to 431 
                  endif 
                end do 
                if (rank == 0) then
                  write(ilog,*) ' error-cannot find id in list-infheat_d' 
                  write(ilog,*) ' ibk, id ', ibk, id
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop 

  431           continue 

!cprovi------------------------------------------------                 
!cprovi Assign the interfacial area                                     
!cprovi------------------------------------------------                 
                areai = areax(idim, ipair) 
!cprovi------------------------------------------------ 
  
                iface(idim, ipair) = iisav 

!  find darcy volume (not mass) flux between node pair 

                delp_dd = uvsnew(id) - uvsnew(ibk)  
                
                delz_dd = zg(id) - zg(ibk)
                
                

                if (delz_dd/=r0) then
                  
                  rho_av = rhalf * (density(ibk) + density(id))
                  
                  if (av_dens_z) then
                  
                     delp_dd = rho_av * (uvsnew(id)/density(id)   &
     &                               -uvsnew(ibk)/density(ibk))
                  end if
!c  convert delz_dd to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential
 
                  delz_dd = delz_dd * rho_av * gacc
                  delp_dd = delp_dd + delz_dd
                
           
                end if
                
                if (.not. b_use_fixed_flow_vel) then
!c  assign coefficients for upstream weighting
!c calculate water volume (not mass!!) fluxes
     
                  dflux = darcy_energybal(delp_dd,delp_dd,r1,r1,        &
     &                                    viscosity(ibk),               &
     &                                    viscosity(id),relperm(ibk),   &
     &                                    relperm(id),cinfvs(iisav),    &
     &                                    ups_heat,.false.) 

!c  velocity is the flux (m^3/day) divided
!c  by the interfacial area between the two nodes

                  vel(idim) = vel(idim) + dflux / areai
                end if

              end do !ipair = 1, npair(idim)
               
!c  find the average elemental velocity in the
!c  x,y,z directions
              if (.not. b_use_fixed_flow_vel) then
                vel(idim) = vel(idim)/(float( npair(idim) ) + eps)
              end if
            end do !idim = 1, 3

            if (b_use_fixed_flow_vel) then
              vel(1) = fixed_flow_vel%x
              vel(2) = fixed_flow_vel%y
              vel(3) = fixed_flow_vel%z
            end if

!cprovi-------------------------------------------------------------------
!cprovi-------------------------------------------------------------------
!c  average porosity of the element
!c  note: each node is included in "ndim" number of node
!c        pairs, therefore the average must be divided
!c        by ndim as well as the number of nodes in the
!c        element

            ndim = 0
            if (nvx .gt. 1) ndim = ndim + 1
            if (nvy .gt. 1) ndim = ndim + 1
            if (nvz .gt. 1) ndim = ndim + 1
            
!c  calculate average dispersivities for the "pseudo
!c  dispersion element"

  
            disx_avg = r0
            disy_avg = r0
            disz_avg = r0

            do idim = 1, 3                      !loop over dimensions
              do ipair = 1, npair(idim)        !node pairs

                     ibk = fvpair(idim, ipair, 1)
                     id = fvpair(idim, ipair, 2)


                     disx_avg = disx_avg          &
                              + disx(ibk)         &
                              + disx(id)
      
                     disy_avg = disy_avg          &
                              + disy(ibk)         &
                              + disy(id)
      
                     disz_avg = disz_avg          &
                              + disz(ibk)         &
                              + disz(id)

                  end do                           !node pairs
               end do                              !dimensions 

              
               disx_avg = disx_avg / float(ndim) / r2**ndim
               disy_avg = disy_avg / float(ndim) / r2**ndim
               disz_avg = disz_avg / float(ndim) / r2**ndim

!c  calculate the dispersion tensor for the "pseudo dispersion element"
!c  average porosity of the element

               !cprovi-----------------------------------------------
               !cprovi Compute square of velocities in each direction
               !cprovi----------------------------------------------- 
               vx2 = vel(1)*vel(1)
               vy2 = vel(2)*vel(2)
               vz2 = vel(3)*vel(3)
               !cprovi-----------------------------------------
               !cprovi Compute the square of velocity module 
               !cprovi-----------------------------------------
               vmag2 = vx2 + vy2 + vz2
               vmag = dsqrt(vmag2)
               
               dl  = disx_avg * vmag
               dth = disy_avg * vmag
               dtv = disz_avg * vmag
   
               tend(1) =                (dl  * vx2                &
                                      +  dth * vy2                &
                                      +  dtv * vz2)/(vmag2+eps)
      
               tend(2) =                (dth * vx2                &
                                      +  dl  * vy2                &
                                      +  dtv * vz2)/(vmag2+eps)
      
               tend(3) =                (dtv * vx2                &
                                      +  dtv * vy2                &
                                      +  dl  * vz2)/(vmag2+eps)    
!cprovi---------------------------------------------------------     
!cprovi---------------------------------------------------------     
!cprovi---------------------------------------------------------     
     
     
!c  build total influence coefficient from all elemental contributions
#ifdef OPENMP
    !$omp critical
#endif 
               do idim = 1, 3                   !loop over dimensions
 
!c  adjust for 1d-, 2d, 3d - discretization


                    do ipair = 1, npair(idim)             !node pairs
  
                      iisav = iface(idim, ipair)
                      
                      areadloc=aread(idim,ipair)
                      
                      cinfheat_d(iisav)=cinfheat_d(iisav)         &
                                      + tend(idim) * areadloc     
      
      
                      cinfheat_d(isymm(iisav))=cinfheat_d(isymm(iisav))&
                                             + tend(idim) * areadloc

                    end do                             
               end do       
#ifdef OPENMP
    !$omp end critical
#endif


!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------           
               
          end do
        end do
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      return
      end

