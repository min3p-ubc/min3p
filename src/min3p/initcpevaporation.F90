!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initcpevaporation.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initcpevaporation 
!c -------------------
!c
!c control parameters for evaporation processes 
!c
!c written by:      Sergio Andres bea Jofre 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           deltol_vs          = solver update tolerance             * +
!c           dinc_vs            = increment for numerical             * +
!c                                differentiation
!c           perm_fac(nn)       = scaling factor for permeability     * +
!c                                as a function of porosity changes 
!c           restol_vs          = solver residual tolerance           * +
!c           srelfac_vs         = user specified underrelaxation      * +
!c                                factor
!c           sw_star            = anticipated change in saturation    * +
!c                                per time step
!c           tol_vs             = convergence tolerance               * +
!c                                (variably saturated flow)
!c           uvslim             = max. allowed update                 * +
!c
!c           integer*4:
!c           ----------
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, log book               + -
!c           itmp               = unit number, temporary storage      + -
!c           idetail_vs         = solver information level            * +
!c           level_vs           = incomplete factorization level      * +
!c           maxit_vs           = max. number of newton iterations    * +
!c                                (variably saturated flow)
!c           msolvit_vs         = max. number of solver iterations    * +
!c           nn                 = number of control volumes           + -
!c
!c           logical:
!c           --------
!c           comp_relax         = .true.  -> compute underelaxation   * +
!c                                           factor
!c           hydraulic_head     = .true.  -> initial condition in     * +
!c                                           terms of hydraulic head
!c           mass_balance_vs    = .true.  -> compute mass balance     * +
!c                                           (variably_saturated
!c                                            flow)
!c           pressure_head      = .true.  -> initial condition in     * +
!c                                           terms of pressure head
!c           rcm_ordering_vs    = .true.  -> rcm ordering for         * +
!c                                           1d scalar matrix
!c           under_relax        = .true.  -> underrelaxation          * +
!c           upstream           = .true.  -> upstream weighting       * +
!c           variably_saturated = .true.  -> .not.fully_saturated,    * +
!c                                        -> variably saturated
!c                                           conditions
!c dens.f:
!c           real*8:
!c           -------
!c           courant_target     = target courant number               * +
!c           drho_dc            = density-TDS constant drho / dTDS    * +
!c
!c
!c           integer*4:
!c           ----------
!c           ianpl(nnpl)        = pointer for napl components         + -
!c           inpl               = counter for napl components         * +
!c           iter_target        = target number of Picard iterations  + -
!c           maxit_sia          = maximum number of Picard iterations * +
!c           ndd                = number of components used for       * +  
!c                                fluid density calculation
!c           nnpl               = total number of napl components     * +
!c  
!c           logical:
!c           --------
!c           density_dependence = .true.  -> simulate density         * + 
!c                                           dependent flow
!c           fluid_pressure     = .true.  -> initial and boundary     * +
!c                                           conditions in terms 
!c                                           of fluid pressure 
!c           flow_verification  = .true.  -> verify pressure formulation
!c                                           for constant density 
!c                                           test problem
!c           fresh_head         = .true.  -> initial and boundary     * +
!c                                           conditions in terms 
!c                                           of freshwater head 
!c           init_perm          = .true. -> initial media             * +
!c                                           properties in 
!c                                           permeability units
!c           init_cond          = .true. -> initial media             * +
!c                                           properties in hydraulic 
!c                                           conductivity units
!c
!c           character:
!c           ----------
!c           section_header     = section header                      * +
!c
!c local:    
!c           real*8:
!c           -------
!c           ref_dens           = reference density to convert 
!c                                from freshwater heads to pressures       * +   
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c
!c           character:
!c           ----------
!c           subsection         = name of subsection in input file
!c
!c external: findstrg  = find text string in file
!c           readbloc  = read section of input file and write to
!c                       temporary file
!c ----------------------------------------------------------------------
 
      subroutine initcpevaporation 

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use dens
      use chem
      use file_unit, only : lun_get
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      use module_binary_mpiio, only : binary_file_open
      
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      external findstrg, readbloc   

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r100 = 100.0d0,     &
     &           r1000=1000.0d0,                                       &
     &           rs2day2=7464960000.0d0, r86400=86400.0d0,             &
     &           rsmall=1.0d-2,r180=180.0d0,pi=3.14159265359d0,        &
     &           r12=12.0d0, rhalf = 0.5d0

      logical found_section, found_subsection
      character*72 subsection,name
      
      integer :: l_string, ierrcd
      real*8 :: stabfac_atm
      
      !ivelvap=54
      ivelvap = lun_get()

      ierrcd = 0
 
!c  define or read control parameters for energy balance
   
      section_header = 'control parameters - evaporation'
      call readbloc (idat,itmp,section_header,found_section,.true.)
      
      
!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if
!c check if evaporation block was defined 
      if (.not.found_section) then
         if (rank == 0) then 
           write(ilog,*) 'SIMULATION TERMINATED'
           write(ilog,*) section_header(1:l_string),'not found'
         end if
#ifdef PETSC
         call petsc_mpi_finalize
#endif
         stop 
      end if
       
!cprovi------------------------------------------------------
!cprovi surface tension of water at 25oC
!cprovi------------------------------------------------------      
      subsection = 'surface tension of water at 25oC'
      ! Surface tension of water at 25oC (71.89 gr s2) 
      gammaw0 = 71.89d0  
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        ierrcd = 1
        read(itmp,*,err=999,end=999)  gammaw0 ! [gr s-2]
      end if

!cprovi------------------------------------------------------------
!cprovi Enhanced factor in thermal vapour flux 
!cprovi (see Saito  et al., 2006)
!cprovi------------------------------------------------------------      
      subsection = 'compute enhanced factor in thermal vapor fluxes'
      !cprovi------------------------------------------------------
      !cprovi Clay fraction in percentage
      !cprovi------------------------------------------------------
      fclay_nabla = r0
      !cprovi------------------------------------------------------
      !cprovi Cte. for anhanced factor (see Saito et al., 2006)
      !cprovi------------------------------------------------------
      cte_nabla = 9.5d0
      isenhfactor = .false. 
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
          isenhfactor=.true. 
          ierrcd = 2
          read(itmp,*,err=999,end=999) fclay_nabla ! clay mass fraction
          read(itmp,*,err=999,end=999) cte_nabla   ! cte for enhanced factor
          fclay_nabla = fclay_nabla / r100 
          
          if(rank == 0 .and. b_enable_output) then
            write(ilog,*) 'Enhanced factor in thermal vapor fluxes is'
            write(ilog,*) 'considered, nabla=',cte_nabla
          end if
          
          if (b_enable_output .and. b_enable_output_gen) then
            write(igen,*) 'Clay fraction=',fclay_nabla
            write(igen,*) 'Enhanced factor in thermal vapor fluxes is'
            write(igen,*) 'considered, cte. nabla=',cte_nabla
            write(igen,*) 'Clay fraction=',fclay_nabla
          end if
      end if
!cprovi------------------------------------------------------------
!cprovi Enhanced factor in isothermal vapour flux
!cprovi------------------------------------------------------------      
      subsection = 'enhanced factor in isothermal vapor fluxes'
      !cprovi------------------------------------------------------
      !cprovi Clay fraction 
      !cprovi------------------------------------------------------
      nabla_qhv = r1
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
          ierrcd = 3
          read(itmp,*,err=999,end=999) nabla_qhv
          
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'Enhanced factor in isothermal vapor fluxes is'
            write(ilog,*) 'considered, nabla=',nabla_qhv
          end if
          
          if(b_enable_output .and. b_enable_output_gen) then
            write(igen,*) 'Enhanced factor in isothermal vapor fluxes is'
            write(igen,*) 'considered, nabla=',nabla_qhv
          end if
      end if      
!cprovi------------------------------------------------------      
!cprovi Update vapor density derivatives in each time 
!cprovi increment  
!cprovi------------------------------------------------------      
      subsection = 'update vapor density derivatives'
      update_ddensv = .false. 
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
          update_ddensv=.true. 
      end if
!cprovi------------------------------------------------------      
!cprovi Read if divergence of vapor density must be divided  
!cprovi------------------------------------------------------      
      subsection = 'split divergence of vapor density'
      split_divdensv = .false. 
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
          split_divdensv=.true. 
          if (rank == 0 .and. b_enable_output) then
            write(ilog,*) 'Split divergence of vapor density'
          end if
          if (b_enable_output .and. b_enable_output_gen) then
            write(igen,*) 'Split divergence of vapor density'
          end if
      end if            
!cprovi------------------------------------------------------      
!cprovi Vapour density model  
!cprovi------------------------------------------------------      
      subsection = 'vapour density model'
      densv_model = 'default' 
      iscapcorr = .true. 
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
          ierrcd = 4
          read(itmp,*,err=999,end=999) densv_model
          read(itmp,*,err=999,end=999) iscapcorr
          if (densv_model=='saito et al. (2006)') then
             densv_model='saito'
          elseif(densv_model=='default') then
             densv_model = 'default' 
          else 
             if (rank == 0) then 
               write(ilog,*) 'SIMULATION TERMINATED'
               write(ilog,*) 'vapour density model not defined'
             end if
             ierrcd = 5
             goto 999
          end if
      end if      
      
!cprovi------------------------------------------------------      
!cprovi Mass fraction of clay in soil 
!cprovi------------------------------------------------------      
      subsection = 'reference vapor diffusivity'
      
      diffv0 = r86400*2.12d-5
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
          ierrcd = 6
          read(itmp,*,err=999,end=999)  diffv0  ! [m2 s-1]
          diffv0 = diffv0 * r86400              ! [m2 day-1]
      end if

!cprovi------------------------------------------------------
!cprovi If neglects daily variation in radiation  
!cprovi------------------------------------------------------      
      subsection = 'neglects daily variation in radiation'
      comp_daily_rad_atm=.true. 
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
         comp_daily_rad_atm=.false.  
      end if
!cprovi------------------------------------------------------
!cprovi temperature gain factor for soil 
!cprovi------------------------------------------------------      
      subsection = 'temperature gain factor for soil'
      gainwt=r0
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        ierrcd = 7
        read(itmp,*,err=999,end=999) gainwt 
      end if   
      !cprovi----------------------------------------
      !cprovi Soil surface resistance to vapor flow
      !cprovi----------------------------------------
      subsection = 'soil surface resistance to vapor flow'
      rs_model_atm = 'model 1'
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 8
        read(itmp,*,err=999,end=999) rs_model_atm
        if (rs_model_atm/='model 1'.and.          &
            rs_model_atm/='model 2'.and.          &
            rs_model_atm/='model 3'.and.          &
            rs_model_atm/='model 4'.and.          &
            rs_model_atm/='default') then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'Error in '
            write(ilog,*) 'soil surface resistance to vapor flow'
            write(ilog,*) 'model not defined in MIN3P'
            write(ilog,*) rs_model_atm
          end if
          ierrcd = 9
          goto 999
        end if           
      end if
      !cprovi----------------------------------------
      !cprovi Totuosity model to vapor flow 
      !cprovi----------------------------------------
      subsection = 'tortuosity model to vapor flow'
      tort_model_vap = 'default'
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 10
        read(itmp,*,err=999,end=999) tort_model_vap
        if (tort_model_vap/='millington'.and.     &
     &      tort_model_vap/='not consider'.and.   &
     &      tort_model_vap/='default') then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'Error in '
            write(ilog,*) 'totuosity model to vapor flow'
            write(ilog,*) 'model not defined in MIN3P'
            write(ilog,*) tort_model_vap
          end if
          ierrcd = 11
          goto 999
        end if           
      end if      
!cprovi------------------------------------------------------      
!cprovi write evaporation information  
!cprovi------------------------------------------------------
      subsection = 'write transient evaporation info'
      write_evap_info=.false.
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
            write_evap_info=.true. 
            !ievap=53
            ievap = lun_get()

            !Move the file open operation to opnpgfls.F90 so that the output
            !control parameters are available. DSU.
      end if    
      
      read_atm=.false.       
      !cprovi----------------------------------------
      !cprovi Read relative humidity parameters
      !cprovi----------------------------------------
      subsection = 'relative humidity parameters'
      read_hr_atm=.false.
      hr_atm=r1
      dhry_atm=r0
      dhrd_atm=r0 
      hr_maxy_atm=r0
      hr_maxd_atm=r0
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 12
        read(itmp,*,err=998,end=999) read_hr_atm
        if (read_hr_atm) then
          read_atm=.true.
        else
          ierrcd = 13
          read(itmp,*,err=998,end=999) hr_atm
          read(itmp,*,err=998,end=999) dhry_atm
          read(itmp,*,err=998,end=999) dhrd_atm 
          read(itmp,*,err=998,end=999) hr_maxy_atm
          read(itmp,*,err=998,end=999) hr_maxd_atm
          hr_maxy_atm=hr_maxy_atm/time_factor
          hr_maxd_atm=hr_maxd_atm/time_factor   
          if (hr_atm>r1) then
           hr_atm = r1
          else if (hr_atm<=r0) then
           hr_atm = rsmall 
          end if
        end if     
      end if      
      hrav_atm = hr_atm
      
      !cprovi----------------------------------------
      !cprovi Temperature parameters
      !cprovi----------------------------------------
      subsection = 'temperature parameters'
      temp_atm=25.0d0
      read_temp_atm=.false. 
      dtempy_atm=r0
      dtempd_atm=r0
      temp_maxy_atm=r0
      temp_maxd_atm=r0
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 14
        read(itmp,*,err=998,end=999) read_temp_atm
        if (read_temp_atm) then
          read_atm=.true.
        else 
          ierrcd = 15
          read(itmp,*,err=998,end=999) temp_atm
          read(itmp,*,err=998,end=999) dtempy_atm
          read(itmp,*,err=998,end=999) dtempd_atm
          read(itmp,*,err=998,end=999) temp_maxy_atm
          read(itmp,*,err=998,end=999) temp_maxd_atm
          temp_maxy_atm=temp_maxy_atm/time_factor
          temp_maxd_atm=temp_maxd_atm/time_factor
        end if          
      end if      
      tempav_atm = temp_atm 
      
      !cprovi----------------------------------------
      !cprovi Evaporation parameters
      !cprovi----------------------------------------
      subsection = 'evaporation parameters'
      sheat_atm = r0 
      facevap_atm=r1
      wind_atm=r0
      read_wind_atm=.false. 
      dwindy_atm=r0
      dwindd_atm=r0 
      wind_maxy_atm=r0
      wind_maxd_atm=r0
      roughness_atm=rsmall
      screen_atm=r0
      stabfac_atm=r1
      densg_atm = 1.2d0   ! [kg m-3] 
      rain_atm=r0
      comp_evap_rate_atm=.true.
      read_evap_rate_atm=.false.  
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 16
        read(itmp,*,err=998,end=999) comp_evap_rate_atm
        read(itmp,*,err=998,end=999) read_evap_rate_atm
        read(itmp,*,err=998,end=999) evap_atm
        if (comp_evap_rate_atm) then  ! If evaporation rate is computed
           read_evap_rate_atm=.false. 
          ierrcd = 17 
          read(itmp,*,err=998,end=999) facevap_atm
          read(itmp,*,err=998,end=999) roughness_atm
          read(itmp,*,err=998,end=999) screen_atm
          read(itmp,*,err=998,end=999) stabfac_atm 
          read(itmp,*,err=998,end=999) densg_atm 
          read(itmp,*,err=998,end=999) read_wind_atm
          if (read_wind_atm) then
            read_atm=.true. 
          else
            ierrcd = 18
            read(itmp,*,err=998,end=999) wind_atm
            read(itmp,*,err=998,end=999) dwindy_atm
            read(itmp,*,err=998,end=999) dwindd_atm 
            read(itmp,*,err=998,end=999) wind_maxy_atm
            read(itmp,*,err=998,end=999) wind_maxd_atm
            wind_atm=wind_atm*r86400
            dwindy_atm=dwindy_atm*r86400 
            wind_maxy_atm=wind_maxy_atm/time_factor
          end if
        else   
          evap_atm = evap_atm * r86400  ! kg/m2/s => kg/m2/day
          if (read_evap_rate_atm) then
            read_atm=.true. 
          end if  
        end if   ! comp_evap_rate_atm             
      end if      
      windav_atm = wind_atm 
      !cprovi----------------------------------------
      !cprovi Solar radiation parameters
      !cprovi----------------------------------------
      subsection = 'solar radiation parameters'
      facrad_atm=r1
      radnet=117504.0d0         ! [KJ day-1 m-2]
      lat_atm=r0 
      tjan_atm=r0
      tnoon_atm=r12
      tautumn_atm=r0
      icloud_atm=r1
      adry_atm=rhalf
      awet_atm=rhalf
      read_rad_atm=.false. 
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 19
        read(itmp,*,err=998,end=999) read_rad_atm
        read(itmp,*,err=998,end=999) read_cloud_atm
        read(itmp,*,err=998,end=999) facrad_atm
        if (read_rad_atm) then
          read_atm=.true.
          read_cloud_atm=.false. 
        else
          if (read_cloud_atm) then
            read_atm=.true.
          end if  
          ierrcd = 20
          read(itmp,*,err=998,end=999) lat_atm 
          read(itmp,*,err=998,end=999) tjan_atm
          read(itmp,*,err=998,end=999) tnoon_atm
          read(itmp,*,err=998,end=999) tautumn_atm
          read(itmp,*,err=998,end=999) icloud_atm
          read(itmp,*,err=998,end=999) adry_atm
          read(itmp,*,err=998,end=999) awet_atm
          lat_atm=lat_atm*pi/r180
          tjan_atm=tjan_atm/time_factor
          tnoon_atm=tnoon_atm/time_factor
          tautumn_atm=tautumn_atm/time_factor
          if (icloud_atm>r1) then
            icloud_atm=r1
          elseif(icloud_atm<r0) then
            icloud_atm=r0
          end if
          if (adry_atm>r1) then
            adry_atm=r1
          elseif(adry_atm<r0) then
            adry_atm=r0
          end if
          if (awet_atm>r1) then
            awet_atm=r1
          elseif(adry_atm<r0) then
            awet_atm=r0
          end if
        end if          
      end if      
            
      !cprovi----------------------------------------
      !cprovi Rain parameters
      !cprovi----------------------------------------
      subsection = 'rain parameters'
      read_rain_atm=.false. 
      gammaw_atm=-r1000 
      call findstrg(subsection,itmp,found_subsection)  
      if (found_subsection) then
        ierrcd = 21
        read(itmp,*,err=998,end=999) read_rain_atm    
        read(itmp,*,err=998,end=999) gammaw_atm
        if (read_rain_atm) then
          read_atm=.true. 
        end if     
      end if 
!cprovi------------------------------------------------      
!cprovi Open atmospheric parameters from file      
!cprovi------------------------------------------------      
      if (read_atm) then
      
         time_atm=r0
         !iatm = 52 
         iatm = lun_get()
         open(iatm,file=prefix(:l_prfx)//'.atm',      & 
     &        status='old',access='sequential',       &
     &        err=997) 
         read (iatm,*)
         read (iatm,*)
         read (iatm,*)

      end if  
!cprovi-------------------------------------------------------------
!cprovi Update atmospheric boundary conditions
!cprovi-------------------------------------------------------------       
      call updtbcatm


      goto 1000

997   continue
      if (rank == 0) then
        write(ilog,*) 'error when open file ',prefix(:l_prfx)//'.atm'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop


998   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        write(ilog,*) 'subsection',subsection
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop


999   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop
      
      
            

1000  return
      end
