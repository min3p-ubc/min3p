!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/dgm/gasdiff.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine gasdiff
!c ------------------
!c
!c compute diffusion coefficients for gas components using LeBlanc's approx
!c
!c written by:      Sergi Molins - May 2, 2006
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           molfrac(ng)        = molar fractions of gas species      + -
!c           gasdiff            = gas diffusion coefficient           * +
!c
!c           integer*4:
!c           ----------
!c           ic                 = pointer to component                + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           eqg(ng)            = equilibrium constants for           + -
!c                                formation of gases from free
!c                                species
!c           rgas               = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           xnug(ng*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of gases from
!c                                free species
!c
!c           integer*4:
!c           ----------
!c           iaga(ng+1)         = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           jaga(ng*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           nc                 = number of components                + -
!c
!c
!c
!c local:    real*8:
!c           -------
!c           dd(ng)             = variable
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           lg(ng)             = variable
!c
!c           logical:
!c           --------
!c           found              = variable
!c
!c external: -  
!c ----------------------------------------------------------------------
  
      real*8 function gasdiff(molfrac,ic)
 
      use chem, only : ng, iaga, jaga 
      use phys, only : diff_bin_g
      
      implicit none

!c     passed
      real*8    molfrac(ng)
      integer*4 ic

!c     local
      integer*4 lg(ng)
      real*8    dd(ng)  
      logical   found
      
      integer :: i, j, k, ig, jg, istart, iend, jc
      real*8 :: rr
      
      
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rtiny = 1.0d-30
      
      
               
      ig = 0
      k  = 0
      dd(1:ng) = r0
    
      do while (ig.lt.ng)

        ig = ig + 1
        istart = iaga(ig)
        iend   = iaga(ig+1)-1
      
!c       look for gas species corresponding to component ic
        found = .false.
        do i = istart,iend
          jc = jaga(i)
          if (jc.eq.ic) then
            found = .true.
            k = k  + 1 
            lg(k) = ig
          endif
        end do

!c       compute diffusion coeff for one of the gas species 
!c       corresponding to component ic
        if (found) then
          dd(k) = r0       
          do jg = 1,ng
            if (jg.ne.lg(k)) then
              dd(k) = dd(k) + molfrac(jg)/diff_bin_g(lg(k),jg)
            end if
          enddo

          !!BUG here without threshold, dd(k) maybe zero, causing infinity. 
          if (dd(k) > rtiny) then
            dd(k) = (r1 - molfrac(lg(k)))/dd(k)
          else
            dd(k) = r0
          end if
        endif
 
      enddo

!c     compute gas diffusion coefficient for component ic
!c     as sum of diffusion coeff calc'd above for each gas species
      if (k.gt.1) then
        
        gasdiff = r0
        rr = r0
        do j=1,k
          gasdiff = gasdiff + dd(j) * molfrac(lg(j))
          rr = rr + molfrac(lg(j))
        enddo

        if (rr > rtiny) then
          gasdiff = gasdiff/rr
        end if

      else
!c     only one species for component ic
        gasdiff = dd(1)

      endif

      return
      end
