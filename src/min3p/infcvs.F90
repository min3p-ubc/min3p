!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 878 $
!> $Author: dsu $
!> $Date: 2024-02-14 20:08:49 -0800 (Wed, 14 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/infcvs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine infcvs
!c -----------------
!c
!c compute influence coefficients (variably saturated flow)
!c
!c
!c                        /|   ij, K_ij
!c                       / | /
!c                      /  |/
!c                     |   /
!c            K_i      |  /|           K_j
!c            *--------|-*-------------*
!c            i d_i,ij |  \|  d_j,ij   j
!c                     |   \
!c                     |  / \
!c                     | /   A_ij
!c
!c
!c written by:      Uli Mayer - June 12, 96 
!c
!c last modified:   Tom Henderson - April 7, 2005
!c                  Sergi Molins - May 2, 2006
!c                  added new variable permij (gen.f)
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           cinfvs(njavs)      = influence coefficients              * +
!c                                (variably saturated flow)
!c           permij(njavs)      = permeability                        * +
!c           delx(nvx)          = spatial increment in x-direction    + -
!c           dely(nvy)          = spatial increment in y-direction    + -
!c           delz(nvz)          = spatial increment in z-direction    + -
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           perm_fac(nn)       = scaling factor for permeability     + -
!c                                as a function of porosity changes
!c
!c           integer*4:
!c           ----------
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           half_cells         = .true.  -> half cells on boundary   + -
!c           update_permeability= .true.  -> update permeability as   + -
!c                                           a function of porosity
!c
!c phys.f:   real*8:
!c           -------
!c           condxx(nzn)        = saturated hydraulic conductivity    + -
!c                                in x-direction
!c           condyy(nzn)        = saturated hydraulic conductivity    + -
!c                                in y-direction
!c           condzz(nzn)        = saturated hydraulic conductivity    + -
!c                                in z-direction
!c           permx(nn)          = saturated permeability in           + -
!c                                x-direction
!c           permy(nn)          = saturated permeability in           + -
!c                                y-direction
!c           permz(nn)          = saturated permeability in           + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           permeability_field = .true.  -> read permeability field  + -
!c                                .false. -> specify permeabilities
!c                                           in input file
!c
!c local:    real*8:
!c           -------
!c           areaf              = interfacial area
!c           delx_i             = interfacial distance i-ij in 
!c                                x-direction
!c           delx_j             = interfacial distance j-ij in
!c                                x-direction
!c           dely_i             = interfacial distance i-ij in
!c                                y-direction
!c           dely_j             = interfacial distance j-ij in
!c                                y-direction
!c           delz_i             = interfacial distance i-ij in
!c                                z-direction
!c           delz_j             = interfacial distance j-ij in
!c                                z-direction
!c           cxx_i              = hydraulic conductivity in
!c                                x-direction (control volume i)
!c           cxx_j              = hydraulic conductivity in
!c                                x-direction (control volume j)
!c           cyy_i              = hydraulic conductivity in
!c                                y-direction (control volume i)
!c           cyy_j              = hydraulic conductivity in
!c                                y-direction (control volume j)
!c           czz_i              = hydraulic conductivity in
!c                                z-direction (control volume i)
!c           czz_j              = hydraulic conductivity in
!c                                z-direction (control volume j)
!c           cxx_ij             = intermediate value (harmonic mean - 
!c                                interfacial hydraulic conductivity 
!c                                in x) 
!c           cyy_ij             = intermediate value (harmonic mean -
!c                                interfacial hydraulic conductivity 
!c                                in y)
!c           czz_ij             = intermediate value (harmonic mean -
!c                                interfacial hydraulic conductivity 
!c                                in z)
!c           rhalf              = constant
!c           
!c           integer*4:
!c           ----------
!c           ivx                = counter (number of control
!c                                volumes in x-direction)
!c           ivy                = counter (number of control
!c                                volumes in y-direction)
!c           ivz                = counter (number of control
!c                                volumes in z-direction)
!c           ivol               = pointer (current control volume)
!c           ivxp               = pointer (previous control 
!c                                volume in x-direction) 
!c           ivxn               = pointer (next control volume in 
!c                                x-direction)
!c           ivyp               = pointer (previous control
!c                                volume in y-direction)
!c           ivyn               = pointer (next control volume in
!c                                y-direction)
!c           ivzp               = pointer (previous control
!c                                volume in z-direction)
!c           ivzn               = pointer (next control volume in
!c                                z-direction)
!c           izn                = pointer (material property zone)
!c           jtemp              = pointer to colum entries
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine infcvs
 
      use parm
      use gen
      use phys
      use dgml, only : dgm
      use chem, only : ng
      use dens, only : density_dependence, viscosity
      use m_heat_transport, only : heat_transport, energy_balance
      use mip_bubble, only : mip_mt_enable, mip_adjust_bubble_cond,    &
                             mip_bubble_cond_ratio, mip_g

#ifdef OPENMP      
      use omp_lib
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      real*8 :: r0, rhalf, r2, rkelvin, pi

      parameter (r0 = 0.0d0, rhalf = 0.5d0,   &
                r2=2.0d0,                     &
                rkelvin=273.15d0,             &
                pi = 3.141592653589793d0)
      
      real*8, parameter :: rsmall = 1.0d-20
      
      integer :: i1, info_debug, irow, istart, iend, ivol, ivx, ivy,   &
                 ivz, izn, ivxp, ivxn, ivyp, ivyn, ivzp, ivzn, jtemp,  &
                 jvol, jzn
      real*8 :: areaf, cxx_i, cyy_i, czz_i,cxx_j, cyy_j, czz_j,        &
                cxx_ij, cyy_ij, czz_ij, delx_i, dely_i, delz_i,        &
                delx_j, dely_j, delz_j, convk,                         &
                aperture_ij, viscosity_ij

      real*8, external :: relcond_freezing, pressure_melt_k
      
!cprovi-----------------------------------------------------------------------
      info_debug = 0
    
      delx_i = r0
      delx_j = r0
      dely_i = r0
      dely_j = r0
      delz_i = r0
      delz_j = r0
      
      convk = visc_h2o/(dens_h2o * gacc)  !conductivity * convk = permeability
      
!c  initialize pointer to current control volume

      ivol = 0

!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_infcvs_1)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol, ivx, ivxn, ivxp, ivy, ivyn, ivyp,             &
    !$omp ivz, ivzn, ivzp, izn, jtemp, jvol, jzn,                     &
    !$omp areaf, cxx_i, cxx_ij, cxx_j, cyy_i, cyy_ij, cyy_j,          &
    !$omp czz_i, czz_ij, czz_j, delx_i, delx_j, dely_i, dely_j,       &
    !$omp delz_i, delz_j, aperture_ij, viscosity_ij)
    !$omp do schedule(static)
#endif
      do ivz = nvzgls,nvzgle                  ! number of control volumes in z
        do ivy = nvygls,nvygle                ! number of control volumes in y 
          do ivx = nvxgls,nvxgle              ! number of control volumes in x

!c  pointer to current control volume
#ifdef OPENMP
            ivol = (ivz-nvzgls)*nvygl*nvxgl + (ivy-nvygls)*nvxgl +     &
                    ivx-nvxgls+1
#else
            ivol = ivol+1
#endif       
    
            jtemp = iavs(ivol)

!c  assign conductivities for current control volume

            izn = mpropvs(ivol)       !retrieve material properties

            if (permeability_field) then
              cxx_i = permx(ivol)       !assign hydraulic conductivities
              cyy_i = permy(ivol)
              czz_i = permz(ivol)
            else
              cxx_i = condxx(izn)*k_depth_ratio(ivol)       !assign hydraulic conductivities
              cyy_i = condyy(izn)*k_depth_ratio(ivol)
              czz_i = condzz(izn)*k_depth_ratio(ivol)

            
!c added smr
              permx(ivol) = cxx_i*convk       !hydraulic permeabilities
              permy(ivol) = cyy_i*convk       !conductivity: obsolete
              permz(ivol) = czz_i*convk

            end if

!c  permeability update due to porosity changes

            if (update_permeability.or.update_permeability_flow) then
              cxx_i = perm_fac(ivol)*cxx_i
              cyy_i = perm_fac(ivol)*cyy_i
              czz_i = perm_fac(ivol)*czz_i
            end if

            jtemp = jtemp+1           ! skip diagonal

!c  pointers to previous colums in x,y and z, in natural global ordering

            ivxp = ivx-1        
            ivxn = ivx+1
            ivyp = ivy-1
            ivyn = ivy+1
            ivzp = ivz-1
            ivzn = ivz+1
            
!c  assign interfacial distances of current control volume

            if (half_cells) then             !half_cells on boundary

              if (nvxgbl.gt.1) then                        !in x-direction
                if (ivx.eq.1.or.ivx.eq.nvxgbl) then      !boundary
                  delx_i = delx(ivx)                  
                elseif (ivx.gt.0.and.ivx.lt.nvxgbl) then   !interior
                  delx_i = rhalf*delx(ivx)  
                end if
              end if

              if (nvygbl.gt.1) then                        !in y-direction
                if (ivy.eq.1.or.ivy.eq.nvygbl) then        !boundary
                  dely_i = dely(ivy) 
                elseif (ivy.gt.0.and.ivy.lt.nvygbl) then   !interior
                  dely_i = rhalf*dely(ivy)  
                end if
              end if

              if (nvzgbl.gt.1) then                        !in z-direction
                if (ivz.eq.1.or.ivz.eq.nvzgbl) then        !boundary
                  delz_i = delz(ivz) 
                elseif (ivz.gt.0.and.ivz.lt.nvzgbl) then   !interior
                  delz_i = rhalf*delz(ivz)  
                end if
              end if

            else                            !full cells on boundary

              if (nvxgbl.gt.1) then                        !in x-direction
                delx_i = rhalf*delx(ivx)  
              end if

              if (nvygbl.gt.1) then                        !in y-direction
                dely_i = rhalf*dely(ivy)  
              end if

              if (nvzgbl.gt.1) then                        !in z-direction
                delz_i = rhalf*delz(ivz)  
              end if

            end if                          !(half_cells)

!c  calculate influence coefficients in x-direction

            if (nvxgbl.gt.1) then              !connections in x-direction

              if (ivxp.gt.nvxgls-1) then       !left connection   (2)
                areaf = dely(ivy)*delz(ivz)
                if (half_cells) then           !half cells on boundary
                  if (ivxp.eq.1) then
                    delx_j = delx(ivxp)
                  elseif (ivxp.gt.1) then
                    delx_j = rhalf*delx(ivxp)        
                  end if
                else                           !full cells on boundary
                  delx_j = rhalf*delx(ivxp)        
                end if                         !(half_cells)
                jvol = javs(jtemp)              
                jzn = mpropvs(jvol) 
                if (permeability_field) then
                  cxx_j = permx(jvol)
                else
                  cxx_j = condxx(jzn)*k_depth_ratio(jvol)
                end if

!c correct for radial coord

                if (radial_coord) then
                
                  areaf = r2*pi*delz(ivz)*(xg(ivol) - delx_i)
                  cinfrad(jtemp) = areaf

                end if
                

!c  permeability update due to porosity changes

                if (update_permeability.or.update_permeability_flow) then
                  cxx_j = perm_fac(jvol)*cxx_j
                end if

                cxx_ij = cxx_i*cxx_j

                if (fractureFlowType(ivol) == 1 .and.                  &
                    fractureFlowType(jvol) == 1) then
                  aperture_ij = (aperture(ivol)*pornew(ivol) +         &
                                 aperture(jvol)*pornew(jvol))/2.0d0
                  if (density_dependence) then
                    viscosity_ij = (viscosity(ivol)+viscosity(jvol))/2.0d0
                    cinfvs(jtemp) = aperture_ij**2/viscosity_ij/12.0d0/&
                                    (delx_i+delx_j)*areaf
                  else
                    cinfvs(jtemp) = aperture_ij**2/visc_h2o/12.0d0/    &
                                    (delx_i+delx_j)*dens_h2o*gacc*areaf
                  end if
                  cinfvs(jtemp) = cinfvs(jtemp)*sec_per_days
                else
                  cinfvs(jtemp) = cxx_ij*areaf/(cxx_i*delx_j+cxx_j*delx_i)
                end if

                if (ng > 0) then
                  permij(jtemp) = cxx_ij*(delx_i+delx_j)*convk/        &
                                  (cxx_i*delx_j+cxx_j*delx_i)
                end if

                cinfvs_a(jtemp) = cinfvs(jtemp)

                if (b_water_freezing_cond) then
                  if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.       &
                      tkel(jvol) < pressure_melt_k(jvol,r0)) then
                    cinfvs_a(jtemp) = water_freezing_cond
                  end if
                else if (b_water_freezing_curve) then
                  cinfvs_a(jtemp) = cinfvs_a(jtemp)*relcond_freezing(  &
                                    (tkel(ivol)+tkel(jvol))/r2-rkelvin,&
                                    (uvsnew(ivol)+uvsnew(jvol))/r2)
                end if

                if (mip_mt_enable .and. mip_adjust_bubble_cond) then
                  if (mip_g(ivol) > 0 .or. mip_g(jvol) > 0) then
                    cinfvs_a(jtemp) = cinfvs_a(jtemp)*mip_bubble_cond_ratio  
                  end if
                end if

                if (heat_transport) then
                  distcells(jtemp,1) = delx_i
                  distcells(jtemp,2) = delx_j
                end if
                
                jtemp = jtemp+1
              end if

              if (ivxn.le.nvxgle) then         !right connection  (3)
                areaf = dely(ivy)*delz(ivz)
                if (half_cells) then           !half cells on boundary
                  if (ivxn.eq.nvxgbl) then
                    delx_j = delx(ivxn)
                  elseif (ivxn.lt.nvxgbl) then
                    delx_j = rhalf*delx(ivxn)        
                  end if
                else                           !full cells on boundary
                  delx_j = rhalf*delx(ivxn)
                end if                         !(half_cells)
                jvol = javs(jtemp)              
                jzn = mpropvs(jvol)
                if (permeability_field) then
                  cxx_j = permx(jvol)
                else
                  cxx_j = condxx(jzn)*k_depth_ratio(jvol)
                end if

!c correct for radial coord
                if (radial_coord) then

                  areaf = r2*pi*delz(ivz)*(xg(ivol) + delx_i)
                  cinfrad(jtemp) = areaf

                end if


!c  permeability update due to porosity changes

                if (update_permeability.or.update_permeability_flow) then
                  cxx_j = perm_fac(jvol)*cxx_j
                end if

                cxx_ij = cxx_i*cxx_j

                if (fractureFlowType(ivol) == 1 .and.                  &
                    fractureFlowType(jvol) == 1) then
                  aperture_ij = (aperture(ivol)*pornew(ivol) +         &
                                 aperture(jvol)*pornew(jvol))/2.0d0
                  if (density_dependence) then
                    viscosity_ij = (viscosity(ivol)+viscosity(jvol))/2.0d0
                    cinfvs(jtemp) = aperture_ij**2/viscosity_ij/12.0d0/&
                                    (delx_i+delx_j)*areaf
                  else
                    cinfvs(jtemp) = aperture_ij**2/visc_h2o/12.0d0/    &
                                    (delx_i+delx_j)*dens_h2o*gacc*areaf
                  end if
                  cinfvs(jtemp) = cinfvs(jtemp)*sec_per_days
                else
                  cinfvs(jtemp) = cxx_ij*areaf/(cxx_i*delx_j+cxx_j*delx_i)
                end if


                cinfvs_a(jtemp) = cinfvs(jtemp)

                if (ng > 0) then
                  permij(jtemp) = cxx_ij*(delx_i+delx_j)*convk/        &
                                  (cxx_i*delx_j+cxx_j*delx_i)
                end if

                if (b_water_freezing_cond) then
                  if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.       &
                      tkel(jvol) < pressure_melt_k(jvol,r0)) then
                    cinfvs_a(jtemp) = water_freezing_cond
                  end if
                else if (b_water_freezing_curve) then
                  cinfvs_a(jtemp) = cinfvs_a(jtemp)*relcond_freezing(  &
                                    (tkel(ivol)+tkel(jvol))/r2-rkelvin,&
                                    (uvsnew(ivol)+uvsnew(jvol))/r2)
                end if

                if (mip_mt_enable .and. mip_adjust_bubble_cond) then
                  if (mip_g(ivol) > 0 .or. mip_g(jvol) > 0) then
                    cinfvs_a(jtemp) = cinfvs_a(jtemp)*mip_bubble_cond_ratio  
                  end if
                end if

                if (heat_transport) then
                  distcells(jtemp,1) = delx_i
                  distcells(jtemp,2) = delx_j
                end if

                jtemp = jtemp+1

              end if

            end if                             !connections in x-direction

!c  calculate influence coefficients in y-direction

            if (nvygbl.gt.1) then              !connections in y-direction

              if (ivyp.gt.nvygls-1) then       !front connection (4)
                areaf = delx(ivx)*delz(ivz)
                if (half_cells) then           !half cells on boundary
                  if (ivyp.eq.1) then
                    dely_j = dely(ivyp)
                  elseif (ivyp.gt.1) then
                    dely_j = rhalf*dely(ivyp)        
                  end if
                else                           !full cells on boundary
                  dely_j = rhalf*dely(ivyp)        
                end if                         !(half_cells)
                jvol = javs(jtemp)              
                jzn = mpropvs(jvol)
                if (permeability_field) then
                  cyy_j = permy(jvol)
                else
                  cyy_j = condyy(jzn)*k_depth_ratio(jvol)
                end if

!c no radial correction in y direction

!c  permeability update due to porosity changes

                if (radial_coord) then
                 cinfrad(jtemp)=areaf
                end if

               
                if (update_permeability.or.update_permeability_flow) then
                   cyy_j = perm_fac(jvol)*cyy_j
                end if


                cyy_ij = cyy_i*cyy_j
                
                if (fractureFlowType(ivol) == 1 .and.                  &
                    fractureFlowType(jvol) == 1) then
                  aperture_ij = (aperture(ivol)*pornew(ivol) +         &
                                 aperture(jvol)*pornew(jvol))/2.0d0
                  if (density_dependence) then
                    viscosity_ij = (viscosity(ivol)+viscosity(jvol))/2.0d0
                    cinfvs(jtemp) = aperture_ij**2/viscosity_ij/12.0d0/&
                                    (dely_i+dely_j)*areaf
                  else
                    cinfvs(jtemp) = aperture_ij**2/visc_h2o/12.0d0/    &
                                    (dely_i+dely_j)*dens_h2o*gacc*areaf
                  end if
                  cinfvs(jtemp) = cinfvs(jtemp)*sec_per_days
                else
                  cinfvs(jtemp) = cyy_ij*areaf/(cyy_i*dely_j+cyy_j*dely_i)
                end if

                cinfvs_a(jtemp) = cinfvs(jtemp) 
                
                if (ng > 0) then
                  permij(jtemp) = cyy_ij*(dely_i+dely_j)*convk/        &
                                  (cyy_i*dely_j+cyy_j*dely_i)
                end if

                if (b_water_freezing_cond) then
                  if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.       &
                      tkel(jvol) < pressure_melt_k(jvol,r0)) then
                    cinfvs_a(jtemp) = water_freezing_cond
                  end if
                else if (b_water_freezing_curve) then
                  cinfvs_a(jtemp) = cinfvs_a(jtemp)*relcond_freezing(  &
                                    (tkel(ivol)+tkel(jvol))/r2-rkelvin,&
                                    (uvsnew(ivol)+uvsnew(jvol))/r2)
                end if

                if (mip_mt_enable .and. mip_adjust_bubble_cond) then
                  if (mip_g(ivol) > 0 .or. mip_g(jvol) > 0) then
                    cinfvs_a(jtemp) = cinfvs_a(jtemp)*mip_bubble_cond_ratio  
                  end if
                end if
                
                if (heat_transport) then   
                   distcells(jtemp,1) = dely_i
                   distcells(jtemp,2) = dely_j
                end if
                
                jtemp = jtemp+1
              end if

              if (ivyn.le.nvygle) then         !back connection (5)
                areaf = delx(ivx)*delz(ivz)
                if (half_cells) then        !half cells on boundary
                  if (ivyn.eq.nvygbl) then
                    dely_j = dely(ivyn)
                  elseif (ivyn.lt.nvygbl) then
                    dely_j = rhalf*dely(ivyn)
                  end if
                else                        !full cells on boundary
                  dely_j = rhalf*dely(ivyn)
                end if                      !(half_cells)
                jvol = javs(jtemp)              
                jzn = mpropvs(jvol)
                if (permeability_field) then
                  cyy_j = permy(jvol)
                else
                  cyy_j = condyy(jzn)*k_depth_ratio(jvol)
                end if

!c  permeability update due to porosity changes

                if (radial_coord) then
                 cinfrad(jtemp)=areaf
                end if


                if (update_permeability.or.update_permeability_flow) then
                   cyy_j = perm_fac(jvol)*cyy_j
                end if

                cyy_ij = cyy_i*cyy_j                
                
                if (fractureFlowType(ivol) == 1 .and.                  &
                    fractureFlowType(jvol) == 1) then
                  aperture_ij = (aperture(ivol)*pornew(ivol) +         &
                                 aperture(jvol)*pornew(jvol))/2.0d0
                  if (density_dependence) then
                    viscosity_ij = (viscosity(ivol)+viscosity(jvol))/2.0d0
                    cinfvs(jtemp) = aperture_ij**2/viscosity_ij/12.0d0/&
                                    (dely_i+dely_j)*areaf
                  else
                    cinfvs(jtemp) = aperture_ij**2/visc_h2o/12.0d0/    &
                                    (dely_i+dely_j)*dens_h2o*gacc*areaf
                  end if
                  cinfvs(jtemp) = cinfvs(jtemp)*sec_per_days
                else
                  cinfvs(jtemp) = cyy_ij*areaf/(cyy_i*dely_j+cyy_j*dely_i)
                end if
                
                cinfvs_a(jtemp) = cinfvs(jtemp)
                
                if (ng > 0) then
                  permij(jtemp) = cyy_ij*(dely_i+dely_j)*convk/        &
                                  (cyy_i*dely_j+cyy_j*dely_i)
                end if

                if (b_water_freezing_cond) then
                  if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.       &
                      tkel(jvol) < pressure_melt_k(jvol,r0)) then
                    cinfvs_a(jtemp) = water_freezing_cond
                  end if
                else if (b_water_freezing_curve) then
                  cinfvs_a(jtemp) = cinfvs_a(jtemp)*relcond_freezing(  &
                                    (tkel(ivol)+tkel(jvol))/r2-rkelvin,&
                                    (uvsnew(ivol)+uvsnew(jvol))/r2)
                end if

                if (mip_mt_enable .and. mip_adjust_bubble_cond) then
                  if (mip_g(ivol) > 0 .or. mip_g(jvol) > 0) then
                    cinfvs_a(jtemp) = cinfvs_a(jtemp)*mip_bubble_cond_ratio  
                  end if
                end if

                if (heat_transport) then
                   distcells(jtemp,1) = dely_i
                   distcells(jtemp,2) = dely_j
                end if
                
                jtemp = jtemp+1
              end if

            endif                              !connections in y-direction

!c  calculate influence coefficients in z-direction

            if (nvzgbl.gt.1) then              !connections in z-direction

              if (ivzp.gt.nvzgls-1) then       !bottom connection (6)
                areaf = delx(ivx)*dely(ivy)
                if (half_cells) then           !half cells on boundary
                  if (ivzp.eq.1) then
                    delz_j = delz(ivzp)
                  elseif (ivzp.gt.1) then
                    delz_j = rhalf*delz(ivzp)        
                  end if
                else                           !full cells on boundary
                  delz_j = rhalf*delz(ivzp)        
                end if                         !(half_cells)
                jvol = javs(jtemp)              
                jzn = mpropvs(jvol)
                if (permeability_field) then
                  czz_j = permz(jvol)
                else
                  czz_j = condzz(jzn)*k_depth_ratio(jvol)
                end if

!c correct for radial coord
                if (radial_coord) then
                  if (half_cells) then
                    if (ivx .eq. 1) then
                      areaf = pi*delx(ivx)*delx(ivx)
                    elseif (ivx .eq. nvxgbl) then
                       areaf = r2*pi*(xg(ivol)-0.5*delx(ivx))*delx(ivx)
                    else ! full cell in xx direction
                       areaf = r2*pi*xg(ivol)*delx(ivx)
                    end if
                  else ! full cells
                    areaf = r2*pi*xg(ivol)*delx(ivx)
                  end if

                  cinfrad(jtemp)=areaf

                end if
              
             

!c  permeability update due to porosity changes

                if (update_permeability.or.update_permeability_flow) then
                   czz_j = perm_fac(jvol)*czz_j
                end if

                czz_ij = czz_i*czz_j                
                
                if (fractureFlowType(ivol) == 1 .and.                  &
                    fractureFlowType(jvol) == 1) then
                  aperture_ij = (aperture(ivol)*pornew(ivol) +         &
                                 aperture(jvol)*pornew(jvol))/2.0d0
                  if (density_dependence) then
                    viscosity_ij = (viscosity(ivol)+viscosity(jvol))/2.0d0
                    cinfvs(jtemp) = aperture_ij**2/viscosity_ij/12.0d0/&
                                    (delz_i+delz_j)*areaf
                  else
                    cinfvs(jtemp) = aperture_ij**2/visc_h2o/12.0d0/    &
                                    (delz_i+delz_j)*dens_h2o*gacc*areaf
                  end if
                  cinfvs(jtemp) = cinfvs(jtemp)*sec_per_days
                else
                  cinfvs(jtemp) = czz_ij*areaf/(czz_i*delz_j+czz_j*delz_i)
                end if

                cinfvs_a(jtemp) = cinfvs(jtemp)
                
                if (ng > 0) then
                  permij(jtemp) = czz_ij*(delz_i+delz_j)*convk/        &
                                  (czz_i*delz_j+czz_j*delz_i)
                end if

                if (b_water_freezing_cond) then
                  if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.       &
                      tkel(jvol) < pressure_melt_k(jvol,r0)) then
                    cinfvs_a(jtemp) = water_freezing_cond
                  end if
                else if (b_water_freezing_curve) then
                  cinfvs_a(jtemp) = cinfvs_a(jtemp)*relcond_freezing(  &
                                    (tkel(ivol)+tkel(jvol))/r2-rkelvin,&
                                    (uvsnew(ivol)+uvsnew(jvol))/r2)
                end if

                if (mip_mt_enable .and. mip_adjust_bubble_cond) then
                  if (mip_g(ivol) > 0 .or. mip_g(jvol) > 0) then
                    cinfvs_a(jtemp) = cinfvs_a(jtemp)*mip_bubble_cond_ratio  
                  end if
                end if
                
                if (heat_transport) then
                   distcells(jtemp,1) = delz_i
                   distcells(jtemp,2) = delz_j
                end if
               
                jtemp = jtemp+1
              end if

              if (ivzn.le.nvzgle) then         !top connection (7)
                areaf = delx(ivx)*dely(ivy)
                if (half_cells) then           !half cells on boundary
                  if (ivzn.eq.nvzgbl) then
                    delz_j = delz(ivzn)
                  elseif (ivzn.lt.nvzgbl) then
                    delz_j = rhalf*delz(ivzn)
                  end if
                else                           !full cells on boundary
                  delz_j = rhalf*delz(ivzn)
                end if                         !(half_cells)
                jvol = javs(jtemp)              
                jzn = mpropvs(jvol)
                if (permeability_field) then
                  czz_j = permz(jvol)
                else 
                  czz_j = condzz(jzn)*k_depth_ratio(jvol)
                end if               


!c correct for radial coord
                if (radial_coord) then
                  if (half_cells) then
                    if (ivx .eq. 1) then
                      areaf = pi*delx(ivx)*delx(ivx)
                    elseif (ivx .eq. nvxgbl) then
                       areaf = r2*pi*(xg(ivol)-0.5*delx(ivx))*delx(ivx)
                    else ! full cell in xx direction
                       areaf = r2*pi*xg(ivol)*delx(ivx)
                    end if
                  else ! full cells
                    areaf = r2*pi*xg(ivol)*delx(ivx)
                  end if
                  
                  cinfrad(jtemp)=areaf
                 
                end if


!c  permeability update due to porosity changes

                if (update_permeability.or.update_permeability_flow) then
                   czz_j = perm_fac(jvol)*czz_j
                end if

                czz_ij = czz_i*czz_j
                
                if (fractureFlowType(ivol) == 1 .and.                  &
                    fractureFlowType(jvol) == 1) then
                  aperture_ij = (aperture(ivol)*pornew(ivol) +         &
                                 aperture(jvol)*pornew(jvol))/2.0d0
                  if (density_dependence) then
                    viscosity_ij = (viscosity(ivol)+viscosity(jvol))/2.0d0
                    cinfvs(jtemp) = aperture_ij**2/viscosity_ij/12.0d0/&
                                    (delz_i+delz_j)*areaf
                  else
                    cinfvs(jtemp) = aperture_ij**2/visc_h2o/12.0d0/    &
                                    (delz_i+delz_j)*dens_h2o*gacc*areaf
                  end if
                  cinfvs(jtemp) = cinfvs(jtemp)*sec_per_days
                else
                  cinfvs(jtemp) = czz_ij*areaf/(czz_i*delz_j+czz_j*delz_i)
                end if

                cinfvs_a(jtemp) = cinfvs(jtemp)
                
                if (ng > 0) then
                  permij(jtemp) = czz_ij*(delz_i+delz_j)*convk/        &
                                  (czz_i*delz_j+czz_j*delz_i)
                end if

                if (b_water_freezing_cond) then
                  if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.       &
                      tkel(jvol) < pressure_melt_k(jvol,r0)) then
                    cinfvs_a(jtemp) = water_freezing_cond
                  end if
                else if (b_water_freezing_curve) then
                  cinfvs_a(jtemp) = cinfvs_a(jtemp)*relcond_freezing(  &
                                    (tkel(ivol)+tkel(jvol))/r2-rkelvin,&
                                    (uvsnew(ivol)+uvsnew(jvol))/r2)
                end if

                if (mip_mt_enable .and. mip_adjust_bubble_cond) then
                  if (mip_g(ivol) > 0 .or. mip_g(jvol) > 0) then
                    cinfvs_a(jtemp) = cinfvs_a(jtemp)*mip_bubble_cond_ratio  
                  end if
                end if
                 
                if (heat_transport) then 
                  distcells(jtemp,1) = delz_i
                  distcells(jtemp,2) = delz_j
                end if
                
                jtemp = jtemp+1
              end if

            end if                          !connections in z-direction

          end do                            ! number of increments in x
        end do                              ! number of increments in y
      end do                                ! number of increments in z
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
  
!cdbg
      if (info_debug.gt.0 .and. b_enable_output .and.                  &
          b_enable_output_gen) then
        do irow=1,nngl
          istart = iavs(irow)
          iend = iavs(irow+1)-1
          write(igen,'(6(a,i8,a,es10.3,1x))')     &
              ('cinfvs(',i1,') = ',cinfvs(i1),i1=istart,iend)
        end do
      end if
      if (info_debug.gt.1) then
        if (rank == 0) then  
          write(ilog,*) 'program stopped by dbg in infcvs.F90'
        end if  
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
!cdbg

      return
      end
