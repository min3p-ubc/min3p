!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/outputrt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputrt
!c -------------------
!c write contour data of reactive transport simulation to output file 
!c
!c modified for density dependent flow
!c
!c written by:      Uli Mayer - September 9. 96
!c
!c last modified:   Uli Mayer - November 14, 96
!c                  separate files for each time step
!c                  Uli Mayer - November 12, 01
!c                  added new database format
!c                  for dissolution-precipitation reactions
!c
!c                  Tom Henderson - October 24, 2002
!c
!c                  Sergi Molins - May 2, 2006
!c                  added velocityg
!c                  added igsg, igs2, igsa, igsa_first, igsa_last,
!c                  igsf, igsf_first, igsf_last, igsr, igsy, igsk
!c                  Sergi Molins - June 7, 2006
!c                  added igsw (water prod/consumption)
!c                  fixed igs2 blocks
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           ------- 
!c           area(nm,nn)        = specific reactive surface area of   + -
!c                                mineral (global system)
!c           cmnew(nm,nn)       = mineral concentrations              + -
!c                                - new time level [moles/l bulk]
!c           cnew(nc,nn)        = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx,nn)          = concentrations of secondary aqueous + -
!c                                species [moles/l water]
!c           cec_g(nn)          = cation exchange capacity (meq/100g) + -
!c                                - global system
!c           delt               = time step                           + -
!c           distcoff_rt(nc,nn) = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk]
!c                                - reactive transport
!c           elevmax            = max. elevation of solution domain   + -
!c           gamma(nc+nx,nn)    = activity coefficients of aqueous    + +
!c                                species
!c           gnew(ng,nn)        = gas concentrations                  + -
!c                                - new time level [moles / l air]
!c           time_io            = solution time in I/O units          + -
!c           phi(nm,nn)         = volume fractions of minerals        + - 
!c           phiold(nm,nn)      = volume fractions of minerals        + - 
!c                                - old time level
!c           pornew(nn)         = porosity                            + -           
!c           ratemdp(nm,nn)     = absolute dissolution-precipitation  + -
!c                                rates of minerals
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                (new time level)
!c           sionnew(nn)        = ionic strength of solution          + -
!c                                - new time level
!c           time               = current solution time               + -
!c           tkel(nn)           = temperature [deg K]                 + -
!c           totcnew(n,nn)      = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l h2o]
!c           hhead(nn)          = hydraulic head                      + -
!c           xg(nn)             = spatial coordinates in x-direction  + - 
!c           yg(nn)             = spatial coordinates in y-direction  + - 
!c           zg(nn)             = spatial coordinates in z-direction  + - 
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + - 
!c           ifls               = unit number, file information       + -
!c           ilog               = unit number, logbook                + -
!c           igsa               = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa_first         = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa_last          = unit number, molar fluxes           + -
!c                                             - contour
!c           igsb               = unit number, sorbed species         + -
!c                                             concentrations
!c                                             - contour data
!c           igsc               = unit number, free species and       + -
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - contour data
!c           igsd               = unit number, reaction rates of      + -
!c                                             dissolution-
!c                                             precipitation 
!c                                             reactions
!c                                             - contour data
!c           igsf               = unit number, diffusion coefficients + -
!c                                             for each component
!c                                             - contour data
!c           igsf_first         = unit number, diffusion coefficients + -
!c                                             - contour data
!c           igsf_last          = unit number, diffusion coefficients + -
!c                                             - contour data
!c           igsg               = unit number, partial gas pressures  + -
!c                                             - contour data
!c           igsgr              = unit number, degassing rates        + -
!c                                             - contour data
!c           igsi               = unit number, rates of intra-aqueous + -
!c                                             kinetic reactions
!c                                             - contour data
!c           igsk               = unit number, adv & diff gradients   + -
!c                                             - contour data
!c           igsm               = unit number, master variables       + -
!c                                             - contour data
!c                                             - contour data
!c             igsr               = unit number, gas density            + -
!c           igss               = unit number, saturation indices     + -
!c                                             - contour data
!c           igst               = unit number, total aqueous          + -
!c                                             component
!c                                             concentrations
!c                                             - contour data
!c           igstime            = pointer to next output time for     + -
!c                                contour data
!c           igsv               = unit number, mineral volume         + -
!c                                             fractions
!c                                             - contour data
!c           igsx               = unit number, saturation indices     + -
!c                                             excluded minerals
!c                                             - contour data
!c             igsy               = unit number, gas viscosity          + -
!c                                                - contour data 
!c             igsw               = unit number, water prod/consumption + -
!c                                                - contour data 
!c                                                global system
!c           igsac              = unit number, activity coefficient   + -
!c                                              - countour data
!c           icnv               = unit number, data conversion        + -
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_time_unit        = lebgth of time_unit for output      + -
!c           mtime              = current time step                   + -
!c           nn                 = total number of control volumes     + -
!c
!c           logical:
!c           --------
!c           depth_output       = .true.  -> output in terms of       + -
!c                                           depth instead of 
!c                                           elevation
!c           extended_output_gs = .true.  -> extended output of       + -
!c                                           contour data for
!c                                           reaction-transport
!c                                           simulation
!c                                .false. -> basic output of
!c                                           contour data for
!c                                           for reaction-transport
!c                                           simulation
!c           initial_condition  = .true.  -> output of initial        + -
!c                                           condition for contour
!c                                           data
!c                                .false. -> output of contour data
!c                                           for steady state or
!c                                           transient solutions
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           update_porosity    = .true.  -> update porosity as       + -
!c                                           a result of dissolution-
!c                                           precipitation reactions
!c           logical:
!c           --------
!c           cum_molfrac        = .true.--> .gs2 results in terms of  + -
!c                                          cummulative molar fractions
!c           logical:
!c           --------
!c           cum_molfrac        = .true.--> .gs2 results in terms of  + -
!c                                          cummulative molar fractions
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           time_unit          = output time unit: -> 'years'        + -
!c                                                     'days'  
!c
!c chem.f:   real*8:    
!c           -------
!c           alkfacc(nc)        = alkalinity factors for components   + -
!c                                as species in solution
!c           alkfacx(nx)        = alkalinity factors for aqueous      + -
!c                                complexes
!c           conc_mol_avg(nthreads)
!c                              = average molar concentration of      + -
!c                                organic mixture
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)
!c                              = concentrations of sorbed species    * *
!c                                - new time level (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * *
!c                                - new time level (surface-complex)
!c           densm(nm)          = densities of minerals               + -
!c           ehfac              = factor for calculating Eh from pe   + -
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded  + -
!c                                minerals
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           gfwm(nm)           = gram formula weight of minerals     + -
!c           phimin(nm)         = volume fractions of minerals for    + -
!c                                nucleation
!c           phimin_out(nm)     = cutoff mineral volume fractions     + -
!c                                for output
!c           phi_out(nm)        = mineral volume fractions for output * *
!c           rgasatm            = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           rateg(ng,nthreads) = degassing rates                     * *
!c           ratemp(ndr*nm,nthreads)
!c                              = reaction rates for minerals         * *
!c                                including parallel reactions
!c           rateor(nr,nthreads)= oxidation-reduction rates for       * *
!c                                redox couples [moles/(l h2o*day)
!c           satm(nm,nthreads)  = IAP/K                               + -
!c           satm_log(nm)       = saturation indices                  + -
!c           satmx(nmx)         = saturation indices for excluded     + -
!c                                minerals
!c           tconv              = temperature correction factor       + -
!c           totan(nc,nthreads) = total sorbed component              + -
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c           xnumx(nmx*nc)      = stoichiometric coefficients of      + -
!c                                components in excluded mineral
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c
!c           integer*4:
!c           ---------- 
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution-       + -
!c                                precipitation reactions
!c           iamp(nm+1)         = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c           iamx(nmx+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in excluded mineral
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamx(nmx*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in excluded mineral
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           l_nameanc(nc)      = length of names of sorbed           + -
!c                                components (non-competitive
!c                                sorption
!c           l_nameaq(naq)      = length of names of intra-aqueous    + -
!c                                kinetic reactions
!c           l_namec(nc)        = length of component names           + -
!c           l_nameg(ng)        = length of names of gases            + -
!c           l_namem(nm)        = length of mineral names             + -
!c           l_namemp(ndr*nm)   = length of names of parallel         + -
!c                                dissolution-precipitation reactions
!c           l_namemx(nmx)      = length of names of excluded         + -
!c                                minerals
!c           l_namer(nr)        = length of names of redox couples    + -
!c           l_namex(nx)        = length of names of secondary        + -
!c                                aqueous species
!c           nanc               = number of sorbed species            + -
!c                                non-com[petitive sorption
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity     + -
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           new_database       = .true.  -> use new database format  + -
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c           pe_output          = .true.  -> output of pe and Eh      + -
!c           ph_output          = .true.  -> output of pH             + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           temp_field         = .true.  -> nodal temperatures       + -
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameanc(nc)        = names of sorbed species             + -
!c                                (non-competitive sorption)
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namemp(ndr*nm)     = names for parallel                  + -
!c                                dissolution-precipitation reactions
!c           namemx(nmx)        = names of excluded minerals          + -
!c           namer(nr)          = names of redox couples              + -
!c           namex(nx)          = names of secondary aqueous species  + -
!c           output_unit_sb     = output unit for surface species     + -
!c           output_unit_sb_ion = output unit for sorption            + -
!c                                reactions of ion-exchange
!c           output_unit_sb_surf= output unit for sorption            + -
!c                                reactions of surface-complex
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c
!c dens.f:   logical:
!c           --------
!c          density_dependence = .true.  -> density-dependent flow   + -
!c
!c local:    real*8:
!c           -------
!c           alk_carb           = carbonate alkalinity [eq/L]
!c           alk_noncarb        = noncarbonate alkalinity [eq/L]
!c           alk_tot            = total alkalinity [eq/L]
!c           alk_carb_mg        = carbonate alkalinity [mg/L CaCO3]
!c           alk_noncarb_mg     = non-carbonate alkalinity
!c                                [mg/L CaCO3]
!c           alk_tot_mg         = total alkalinity [mg/L CaCO3]
!c           conc_mol           = molar concentration of organic
!c                                compound in organic mixture
!c           eh                 = Eh of solution
!c           frac_mol           = mole fraction of organic compound
!c                                in organic mixture
!c           pe                 = pe of solution
!c           ph                 = pH of solution
!c           por_out            = porosity for output
!c           pres_tot           = total gas pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           pg(ng)             = gas pressure
!c
!c           integer*4:
!c           ----------
!c           ianc               = counter (non-competitive
!c                                         sorption reactions)
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           ireac              = counter
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           istart             = pointer
!c           istop              = pointer
!c           ivol               = counter (control volumes)
!c           ix                 = counter (secondary aqueous species)
!c           l_sufx             = length of file suffix
!c           nxout              = number of secondary species for 
!c                                output
!c
!c
!c           character:
!c           ----------
!c           suffix             = file suffix
!c
!c external: alkcalc   = compute alkalinity
!c           comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions 
!c           molconc   = compute average molar concentration for
!c                       organic mixture
!c           modrate   = modify reaction rate
!c           phpe      = compute pH, pe and Eh
!c           rategas   = compute degassing rates
!c           rategasd  = compute degassing rates for density
!c                       dependent flow
!c           rateint   = compute rate for intra-aqueous kinetic
!c                       reactions
!c           rateint_new   = compute rate for intra-aqueous kinetic
!c                       reactions (new database format)
!c           ratemin   = compute absolute dissolution-precipitation
!c                       rates of minerals
!c           ratemin_new  = compute absolute dissolution-precipitation
!c                       rates of minerals (new database format)
!c           rateredx  = compute oxidation/reduction rates for
!c                       redox couples
!c           satindex  = compute saturation index
!c           sorbspc   = compute concentrations of sorbed species
!c           tcorr     = temperature correction for debye-huckel,
!c                       equilibrium and rate constants
!c           totcona   = compute total sorbed component
!c                       concentrations (non-competitive
!c                       sorption reactions)
!c           totconc   = compute total aqueous component
!c                       concentrations based on concentrations
!c                       of free species and secondary aqueous
!c                       species
!c           updtsvap  = update secondary variables in aqueous phase
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c
!c           velocityg = write 
!c ----------------------------------------------------------------------

      subroutine outputrt

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use chem
      use dens
      use phys
      use writeversion
      use nobleGasIngrowth, only : b_use_ngi, ngre_i, conc_ngre,       &
                                   name_ngre_i
      use dgml, only : dgm, maxwell
      use file_unit, only : lun_get, lun_free
      use biol, only : rld

#ifdef OPENMP
      use omp_lib 
#endif 
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      real*8 :: alk_carb, alk_noncarb, alk_tot, alk_tot_mg,            &
                alk_carb_mg, alk_noncarb_mg, zout, zbal,               &
                zpos, zneg, ph, pe, eh, pres_tot, conc_mol,            &
                frac_mol, gammatemp, tottemp, convk, rootdens

      real*8, external ::  satindex, zoutput
      
      integer :: i, ianc, iaq, ic, ig, im, imx, iout_high, ir, ireac,  &
                 istart, istop, isites, isb, ivol, ix, jg, l_sufx,     &
                 ingre, nxout, ivol_l, nvarsgsc, nvarsgsm, nvarsgsi,   &
                 nvarsgsb, nvarsgsd, nvarsgsv, nvarsgsis, nvarsgsac,   &
                 ierrcode, ierr
      
      integer :: i1, i2, i3, ic1, ic2, ii, icount, icur, imi,          &
                 istart2, istop2, izn_c, next 
      
      integer :: tid 
      
      real*8 dummy

      external alkcalc, comptotc, phpe, checkerr, rateredx,            &
               sorbspc, totcona, totconc, molconc, rategas, rategasd,  &
               rateint, rateint_new, ratemin, ratemin_new, tcorr,      &
               updtsvap, modrate

      real*8, external :: pressure_melt_k

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r100 = 100.0d0

      character*3 :: suffix
      character*72, allocatable :: nametemp(:)
      integer (type_i4), allocatable :: l_nametemp(:)
      real*8, allocatable :: valuetemp(:)
      
      real*8 :: pg(ng)
      real*8 :: totcsb_ion(nc-1), totcsb_surf(nc-1)
      character*2048 strbuffer
      character*72, allocatable :: tec_variables(:)
      
#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) ::                                 &
#else
      integer*8 ::                                                     &
#endif
                 offset_igst, offset_igst_temp,                        &
                 offset_icbt, offset_icbt_temp,                        &
                 offset_igmf, offset_igmf_temp,                        &
                 offset_igsre, offset_igsre_temp,                      &
                 offset_igsc, offset_igsc_temp,                        &
                 offset_igsac, offset_igsac_temp,                      &
                 offset_igsm, offset_igsm_temp,                        &
                 offset_igsi, offset_igsi_temp,                        &
                 offset_igsg, offset_igsg_temp,                        &
                 offset_igs2, offset_igs2_temp,                        &
                 offset_igsgr, offset_igsgr_temp,                      &
                 offset_igsb, offset_igsb_temp,                        &
                 offset_igsd, offset_igsd_temp,                        &
                 offset_igss, offset_igss_temp,                        &
                 offset_igsv, offset_igsv_temp,                        &
                 offset_igsx, offset_igsx_temp,                        &
                 offset_igsis, offset_igsis_temp,                      &
                 offset_igsw, offset_igsw_temp

      
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

      convk = visc_h2o/(dens_h2o * gacc)  !conductivity * convk = permeability

      if (b_output_binary) then
        allocate(tec_variables(1000+nc+nr+naq+ng+nanc+nsites+nsb_ion+   &
                 nsb_surf+nm), stat = ierr)
        tec_variables = ''
        call checkerr(ierr,'outputrt-tec_variables',ilog)
        call memory_monitor(sizeof(tec_variables),'tec_variables',.true.)
      end if

      nxout = 0
     
      if (iso_output) then
        allocate (nametemp(nip*8), stat = ierr)
        nametemp = ""
        call checkerr(ierr,'nametemp',ilog)
        call memory_monitor(sizeof(nametemp),'nametemp',.true.)
        
        allocate (l_nametemp(nip*8), stat = ierr)
        l_nametemp = 0
        call checkerr(ierr,'l_nametemp',ilog)
        call memory_monitor(sizeof(l_nametemp),'l_nametemp',.true.)
        
        allocate (valuetemp(nip*8), stat = ierr)
        valuetemp = 0.0d0
        call checkerr(ierr,'valuetemp',ilog)
        call memory_monitor(sizeof(valuetemp),'valuetemp',.true.)
      end if

!c     write(*,'(/a)') 'enter routine outputrt ...'

!c  assign file suffix for initial condition or current time step 
!c  works for up to 999 output times

!c high output precision option for inverse modeling
!c iout_high = 0 -> standard es15.7 output for *.gst files
!c iout_high = 1 -> e23.15 output for *.gst file component concentrations

      iout_high = 0 ! August 24, 2005 setting
       
      alk_carb=r0
      alk_noncarb=r0
      alk_tot=r0
      alk_tot_mg=r0
      alk_carb_mg=r0
      alk_noncarb_mg=r0
        
      !rewind(icnv)           !Deprecated, use internal convert instead. DSU
      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then
          !write(icnv,'(i1)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i1)') igstime
          l_sufx = 1
        elseif (igstime.ge.10.and.igstime.lt.100) then
          !write(icnv,'(i2)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i2)') igstime
          l_sufx = 2
        elseif (igstime.ge.100.and.igstime.lt.1000) then
          !write(icnv,'(i3)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i3)') igstime
          l_sufx = 3
        elseif (igstime.ge.1000) then
          if (rank == 0) then  
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
#ifdef DEBUG
            write(idbg,'(/a)') 'error in input file'
            write(idbg,'(a)') 'max. number of output times exceeded'
            write(idbg,'(a)') 'abnormal exit in routine outputrt'
            close(idbg)
#endif
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
      end if

!c  ---------------------------------------------------------------------  
!c  open files - water phase
!c  ---------------------------------------------------------------------  
      if (b_output_binary) then
        if (b_output_mpiio_single) then
          if (combined_gst_gsb_output) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gstgsb'
          else
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gst'
          end if
        else
          if (combined_gst_gsb_output) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//        &
                        trim(adjustl(str_rank))//'.gstgsb'
          else
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//        &
                        trim(adjustl(str_rank))//'.gst'
          end if
        end if
        call binary_file_open(Petsc_Comm_World, igst,                  &
                     trim(strbuffer),b_output_mpiio_single)
      else
        if (combined_gst_gsb_output) then
          open(igst,file=prefix(:l_prfx)//'_'//                        &
                    suffix(:l_sufx)//trim(adjustl(str_rank))//'.gstgsb',&
                    status='unknown',form='formatted')
        else
          open(igst,file=prefix(:l_prfx)//'_'//                        &
                    suffix(:l_sufx)//trim(adjustl(str_rank))//'.gst',  &
                    status='unknown',form='formatted')
        end if
      end if
      
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igst, "#")
      end if

! prc ----------------------------------------------------------------
! prc Charge Balance distribution
! prc Pejman Rasouli
! prc ----------------------------------------------------------------
      if (multi_diff) then
        if (b_output_binary) then
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.cbt'
          else
            strbuffer = prefix(:l_prfx)//'_'//                         &
                        suffix(:l_sufx)//trim(adjustl(str_rank))//'.cbt'
          end if
           call binary_file_open(Petsc_Comm_World, icbt,       &
                        trim(strbuffer),b_output_mpiio_single)
        else
          open(icbt,file=prefix(:l_prfx)//'_'//                        &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.cbt',    &
                  status='unknown',form='formatted')
        end if
      
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(icbt, "#")
        end if
      
      end if

      if(flux_out)then
        if (b_output_binary) then  
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gmf'
          else
            strbuffer = prefix(:l_prfx)//'_'//                         &
                        suffix(:l_sufx)//trim(adjustl(str_rank))//'.gmf'
          end if
          call binary_file_open(Petsc_Comm_World, igmf,        &
                       trim(strbuffer),b_output_mpiio_single)
        else
          open(igmf,file=prefix(:l_prfx)//'_'//                        &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gmf',    &
                  status='unknown',form='formatted')
        end if
      
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igmf, "#")
        end if        
      end if

!cdsu ----------------------------------------------------------------
!cdsu Output of radioelement concentration related to noble gas ingrowth
!cdsu ----------------------------------------------------------------
      if(b_use_ngi)then
        if (b_output_binary) then  
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsre'
          else
            strbuffer = prefix(:l_prfx)//'_'//                         &
                        suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsre'
          end if
          call binary_file_open(Petsc_Comm_World, igsre,               &
                       trim(strbuffer),b_output_mpiio_single)
        else
          open(igsre,file=prefix(:l_prfx)//'_'//                       &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsre',   &
                  status='unknown',form='formatted')
        end if
      
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsre, "#")
        end if        
      end if

!cdsu ----------------------------------------------------------------
!cdsu Output of result information to prefix_o.fls file
!cdsu ----------------------------------------------------------------

      if (rank == 0 .and. b_enable_output) then
          
        if (initial_condition) then                                      
          write(ifls,'(/3a/72a)')'Total aqueous component ',           &
                                 'concentrations, initial ',           &
                                 'condition',('-',i=1,72)               
        else                                                            
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
                'Total aqueous component concentrations, T = ',        &
                time_io,time_unit(:l_time_unit),('-',i=1,72)            
        end if
        
        if (combined_gst_gsb_output) then
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                              suffix(:l_sufx)//'.gstgsb'
        else
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                              suffix(:l_sufx)//'.gst'
        end if
        
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'
        do ic = 1,nc-1
          if (ic.lt.7) then
            write(ifls,'(i1,8x,a30,2x,a)') ic+3,namec(ic),'moles/l h2o'
          else
            write(ifls,'(i2,7x,a30,2x,a)') ic+3,namec(ic),'moles/l h2o'
          end if
        end do

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
                'Concentration of radioelements, T = ',                &
                time_io,time_unit(:l_time_unit),('-',i=1,72) 
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                              suffix(:l_sufx)//'.gsre'
          write(ifls,'(2a)')                                           &
                'column   entry                           ','unit'        
          write(ifls,'(2a)')                                           &
                '1        x                               ','m'           
          write(ifls,'(2a)')                                           &
                '2        y                               ','m'           
          write(ifls,'(2a)')                                           &
                '3        z                               ','m'
          do ingre = 1,ngre_i
            if (ingre.lt.7) then
              write(ifls,'(i1,8x,a30,2x,a)') ingre+3,name_ngre_i(ingre),&
                   'mg kg^-1 solid or ppm'
            else
              write(ifls,'(i2,7x,a30,2x,a)') ingre+3,name_ngre_i(ingre),&
                   'mg kg^-1 solid or ppm'
            end if
          end do
        end if
      
      end if

      if (extended_output_gs) then

        if (flux_out)then
          call velocity_a (l_sufx,suffix,nngl,njavs,cinfrad,radial_coord)
        endif

!c  species concentrations

!cmx        nxout = min(100-nc-1,nx)       !max. 100 species for output  
!cmx         100 is not enough for the example waybrant (isotope)

        nxout = min(1000-nc-1,nx)       !max. 1000 species (nc+nx-1) for output
        nvarsgsc = nc+nxout+2
        
        if (b_output_binary) then
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsc'
          else
            strbuffer = prefix(:l_prfx)//'_'//                         &
                        suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsc'
          end if
          call binary_file_open(Petsc_Comm_World, igsc,                &
                       trim(strbuffer),b_output_mpiio_single)
        else
          open(igsc,file=prefix(:l_prfx)//'_'//                        &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsc',    &
                  status='unknown',form='formatted')
        end if
        
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsc, "#")
        end if
        
        if (rank == 0 .and. b_enable_output) then
                                                                       
          if (initial_condition) then                                    
            write(ifls,'(/2a,/72a)')'Species concentrations, initial ',&
     &                              'condition',('-',i=1,72)            
          else                                                          
            write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
     &            'Species concentrations, T = ',                      &
     &            time_io,time_unit(:l_time_unit),('-',i=1,72)          
          end if
                                                                        
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
     &                        suffix(:l_sufx)//'.gsc'
                                                                        
          write(ifls,'(2a)')                                           &
     &          'column   entry                           ','unit'      
          write(ifls,'(2a)')                                           &
     &          '1        x                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '2        y                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '3        z                               ','m'
          do ic = 1,nc-1
            if (ic.lt.7) then
              write(ifls,'(i1,8x,a30,2x,a)') ic+3,namec(ic),           &
                                             'moles/l h2o'
            else
              write(ifls,'(i2,7x,a30,2x,a)') ic+3,namec(ic),           &
                                             'moles/l h2o'
            end if
          end do
          do ix = 1,nx
            if (ix+nc-1.lt.7) then
              write(ifls,'(i1,8x,a30,2x,a)') ix+nc+2,namex(ix),        &
     &                                      'moles/l h2o'              
            elseif (ix+nc-1.ge.7.and.ix+nc-1.lt.97) then               
              write(ifls,'(i2,7x,a30,2x,a)') ix+nc+2,namex(ix),        &
     &                                      'moles/l h2o'              
            else                                                       
              write(ifls,'(i3,6x,a30,2x,a)') ix+nc+2,namex(ix),        &
     &                                      'moles/l h2o'
            end if
          end do
        
        end if
        
!c  output activity coefficient
        if (b_output_activity) then   
          nvarsgsac = nc+nxout+2
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsac'
            else
              strbuffer = prefix(:l_prfx)//'_'//                           &
                          suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsac'
            end if
            call binary_file_open(Petsc_Comm_World, igsac,                 &
                         trim(strbuffer),b_output_mpiio_single)
          else
            open(igsac,file=prefix(:l_prfx)//'_'//                         &
                    suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsac',     &
                    status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsac, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                         
            if (initial_condition) then                                    
              write(ifls,'(/2a,/72a)')                                 &
                    'Species activity coefficients, ',                 &
                    'initial condition',('-',i=1,72)
            else                                                            
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Species activity coefficients, T = ',             &
                    time_io,time_unit(:l_time_unit),('-',i=1,72)        
            end if                                                     
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsac'               
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'      
            do ic = 1,nc-1                                             
              if (ic.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') ic+3,namec(ic),         &
                                               '-'               
              else                                                     
                write(ifls,'(i2,7x,a30,2x,a)') ic+3,namec(ic),         &
                                               '-'
              end if
            end do
            do ix = 1,nx
              if (ix+nc-1.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') ix+nc+2,namex(ix),      &
                                              '-'              
              elseif (ix+nc-1.ge.7.and.ix+nc-1.lt.97) then             
                write(ifls,'(i2,7x,a30,2x,a)') ix+nc+2,namex(ix),      &
                                              '-'              
              else                                                     
                write(ifls,'(i3,6x,a30,2x,a)') ix+nc+2,namex(ix),      &
                                              '-'
              end if
            end do
          
          end if
        end if

!c  master variables
        if (ph_output .or. pe_output) then

        if (b_output_binary) then
          if (b_output_mpiio_single) then
            strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsm'
          else
            strbuffer = prefix(:l_prfx)//'_'//                         &
                        suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsm'
          end if
          call binary_file_open(Petsc_Comm_World, igsm,        &
                       trim(strbuffer),b_output_mpiio_single)
        else
          open(igsm,file=prefix(:l_prfx)//'_'//                        &
                    suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsm',  &
                    status='unknown',form='formatted')
        end if
        
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsm, "#")
        end if
        
        if (rank == 0 .and. b_enable_output) then
                                                                        
          if (initial_condition) then                                     
            write(ifls,'(/2a/72a)')'Master variables, initial ',       &
     &                             'condition',('-',i=1,72)             
          else                                                          
            write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
     &            'Master variables, T = ',                            &
     &            time_io,time_unit(:l_time_unit),('-',i=1,72)          
          end if
                                                                        
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
     &                        suffix(:l_sufx)//'.gsm'
                                                                        
          write(ifls,'(2a)')                                           &
     &          'column   entry                           ','unit'      
          write(ifls,'(2a)')                                           &
     &          '1        x                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '2        y                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '3        z                               ','m'  
         
          if ((ph_output).and.(pe_output)) then                           
            write(ifls,'(a,30x,a)')  '4        pH','-'                    
            write(ifls,'(a,30x,a)')  '5        pe','-'                    
            write(ifls,'(a,30x,a)')  '6        Eh','mV'                   
            write(ifls,'(a,18x,a)')  '7        ionic strength','-'        
            write(ifls,'(a,12x,a)')  '8        carbonate alkalinity',    &
     &                               'eq/L'                               
            write(ifls,'(a,8x,a)')   '9        non-carbonate alkalinity',&
     &                               'eq/L'                               
            write(ifls,'(a,22x,a)')  '10       alkalinity','eq/L'         
            write(ifls,'(a,12x,a)')  '11       carbonate alkalinity',    &
     &                               'mg/L CaCO3'                         
            write(ifls,'(a,8x,a)')   '12       non-carbonate alkalinity',&
     &                               'mg/L CaCO3'
            write(ifls,'(a,22x,a)')  '13       alkalinity','mg/L CaCO3'
            write(ifls,'(a,21x,a)')  '14       temperature','C'
          elseif ((.not.ph_output).and.(pe_output)) then
            write(ifls,'(a,30x,a)')  '4        pe','-'
            write(ifls,'(a,30x,a)')  '5        Eh','mV'
            write(ifls,'(a,18x,a)')  '6        ionic strength','-'
            write(ifls,'(a,12x,a)')  '7        carbonate alkalinity',    &
     &                               'eq/L'                               
            write(ifls,'(a,8x,a)')   '8        non-carbonate alkalinity',&
     &                               'eq/L'                               
            write(ifls,'(a,22x,a)')  '9        alkalinity','eq/L'         
            write(ifls,'(a,12x,a)')  '10       carbonate alkalinity',    &
     &                               'mg/L CaCO3'                         
            write(ifls,'(a,8x,a)')   '11       non-carbonate alkalinity',&
     &                               'mg/L CaCO3'                         
            write(ifls,'(a,22x,a)')  '12       alkalinity','mg/L CaCO3'   
            write(ifls,'(a,21x,a)')  '13       temperature','C'           
          elseif ((ph_output).and.(.not.pe_output)) then                  
            write(ifls,'(a,30x,a)')  '4        pH','-'                    
            write(ifls,'(a,18x,a)')  '5        ionic strength','-'        
            write(ifls,'(a,12x,a)')  '6        carbonate alkalinity',    &
     &                               'eq/L'                               
            write(ifls,'(a,8x,a)')   '7        non-carbonate alkalinity',&
     &                               'eq/L'                               
            write(ifls,'(a,22x,a)')  '8        alkalinity','eq/L'         
            write(ifls,'(a,12x,a)')  '9        carbonate alkalinity',    &
     &                               'mg/L CaCO3'                         
            write(ifls,'(a,8x,a)')   '10       non-carbonate alkalinity',&
     &                               'mg/L CaCO3'
            write(ifls,'(a,22x,a)')  '11       alkalinity','mg/L CaCO3'
            write(ifls,'(a,21x,a)')  '12       temperature','C'
          end if
          
          end if
        
        end if

!c  oxidation-reduction rates

        if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)              &
                     .and.(.not.initial_condition)) then
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsr'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsr'
            end if
            
            call binary_file_open(Petsc_Comm_World, igsi,      &
                         trim(strbuffer),b_output_mpiio_single)

          else
            open(igsi,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsr',     &
                 status='unknown',form='formatted')
          end if
          
!c  version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsi, "#")
        end if
        
        if (rank == 0 .and. b_enable_output) then
                                                                       
          write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                       &
     &          'Oxidation-reduction rates, T = ',                    &
     &          time_io,time_unit(:l_time_unit),('-',i=1,72)
                                                                       
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                  &
     &                        suffix(:l_sufx)//'.gsr'
                                                                       
          write(ifls,'(2a)')                                          &
     &          'column   entry                           ','unit'     
          write(ifls,'(2a)')                                          &
     &          '1        x                               ','m'        
          write(ifls,'(2a)')                                          &
     &          '2        y                               ','m'        
          write(ifls,'(2a)')                                          &
     &          '3        z                               ','m'        
          do ir = 1,nr                                                 
            if (ir.lt.7) then                                          
              write(ifls,'(i1,8x,a30,2x,a)') ir+3,namer(ir),          &
     &                                     'moles/l h2o/day'           
            else                                                       
              write(ifls,'(i2,7x,a30,2x,a)') ir+3,namer(ir),          &
     &                                     'moles/l h2o/day'
            end if
          end do
          
        end if  

        end if                         !((naq.eq.0.and.nr.gt.0).....)

!c  rates of intra-aqueous kinetic reactions

        if (naq.gt.0.and.(.not.initial_condition)) then
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsi'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsi'
            end if
            call binary_file_open(Petsc_Comm_World, igsi,    &
                         trim(strbuffer),b_output_mpiio_single)
          else
            open(igsi,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsi',&
                      status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsi, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
     &            'rates of intra-aqueous kinetic reactions, T = ',    &
     &            time_io,time_unit(:l_time_unit),('-',i=1,72)
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gsi'
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'       
            do iaq = 1,naq                                              
              if (iaq.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') iaq+3,nameaq(iaq),      &
     &                                       'moles/l h2o/day'          
              else                                                      
                write(ifls,'(i2,7x,a30,2x,a)') iaq+3,nameaq(iaq),      &
     &                                       'moles/l h2o/day'
              end if
            end do
          
          end if

        end if                         !(naq.gt.0.and......)

!c  ---------------------------------------------------------------------  
!c  open files - gas phase
!c  ---------------------------------------------------------------------  

!c  partial gas pressures

        if (ng.gt.0) then
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsg'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsg'
            end if 
            call binary_file_open(Petsc_Comm_World, igsg,      &
                         trim(strbuffer),b_output_mpiio_single)

          else
            open(igsg,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsg',&
                      status='unknown',form='formatted')

          end if
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsg, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Partial gas pressures, initial ',&
     &                               'condition',('-',i=1,72)           
            else                                                        
              write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')                   &
     &              'Partial gas pressures, ','T = ',                  &
     &              time_io,time_unit(:l_time_unit),('-',i=1,72)        
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gsg'
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'       
            do ig = 1,ng                                                
              if (ig.lt.7) then                                         
                write(ifls,'(i1,8x,a30,2x,a)') ig+3,nameg(ig),'atm'      
              else                                                      
                write(ifls,'(i2,7x,a30,2x,a)') ig+3,nameg(ig),'atm'      
              end if                                                    
            end do                                                      
            write(ifls,'(2a)')                                         &
     &           '3+ng+1   total gas pressure              ','atm'
            
          end if

!c gas velocities, advection
          if (gas_advection .or. dgm .or. maxwell) then
            if (b_output_binary) then
              if (b_output_mpiio_single) then
                strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                            '.gs2'
              else
                strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                            trim(adjustl(str_rank))//'.gs2'
              end if
              call binary_file_open(Petsc_Comm_World, igs2,    &
                           trim(strbuffer),b_output_mpiio_single)
  
            else  
              open(igs2,file=prefix(:l_prfx)//'_'//                    &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gs2',&
                      status='unknown',form='formatted')
            end if
            
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
                call writeversion2file(igs2, "#")
            end if
            
            if (rank == 0 .and. b_enable_output) then
            
              if (initial_condition) then
                  write(ifls,'(/2a/72a)')'Mole fractions, initial ',   &
     &                                   'condition',('-',i=1,72)
              else
                  write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')               &
     &                  'Mole fractions, ','T = ',                     &
     &                  time_io,time_unit(:l_time_unit),('-',i=1,72)
              end if
              
              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//               &
     &              suffix(:l_sufx)//'.gs2'
              
              write(ifls,'(2a)')                                       &
     &              'column   entry                           ','unit'  
              write(ifls,'(2a)')                                       &
     &              '1        x                               ','m'     
              write(ifls,'(2a)')                                       &
     &              '2        y                               ','m'     
              write(ifls,'(2a)')                                       &
     &              '3        z                               ','m'
              do ig = 1,ng
                if (ig.lt.7) then
                  write(ifls,'(i1,8x,a30,2x,a)') ig+3,nameg(ig),'[-]'
                else
                  write(ifls,'(i2,7x,a30,2x,a)') ig+3,nameg(ig),'[-]'
                end if
              end do
            
            end if
            
            if (.not.initial_condition) then
              call velocity_g (l_sufx, suffix, nngl, njavs, cinfrad,   &
                               radial_coord)
            end if
           
          end if
!c  degassing rates

          if (gas_removal) then
            if (b_output_binary) then
              if (b_output_mpiio_single) then
                strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                            '.gsgr'
              else
                strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                            trim(adjustl(str_rank))//'.gsgr'
              end if
              call binary_file_open(Petsc_Comm_World, igsgr, &
                           trim(strbuffer),b_output_mpiio_single)
            else
              open(igsgr,file=prefix(:l_prfx)//'_'//                   &
                   suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsgr',  &
                   status='unknown',form='formatted')
            end if
            
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
                call writeversion2file(igsgr, "#")
            end if
            
            if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                
              write(ifls,'(/2a/72a)')'Degassing rates, initial ',     &
     &                               'condition',('-',i=1,72)          
            else                                                       
              write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')                  &
     &              'Degassing rates, ','T = ',                       &
     &              time_io,time_unit(:l_time_unit),('-',i=1,72)       
            end if
                                                                       
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                &
     &                          suffix(:l_sufx)//'.gsgr'
                                                                       
            write(ifls,'(2a)')                                        &
     &            'column   entry                           ','unit'   
            write(ifls,'(2a)')                                        &
     &            '1        x                               ','m'      
            write(ifls,'(2a)')                                        &
     &            '2        y                               ','m'      
            write(ifls,'(2a)')                                        &
     &            '3        z                               ','m'      
            do ig = 1,ng                                               
              if (ig.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') ig+3,nameg(ig),        &
     &                                        'mol L^-1 d^-1'          
              else                                                     
                write(ifls,'(i2,7x,a30,2x,a)') ig+3,nameg(ig),        &
     &                                        'mol L^-1 d^-1'
              end if
            end do
            
            end if

          end if                       !(gas_removal)   

        end if                         !(ng.gt.0)

!c  ---------------------------------------------------------------------  
!c  open files - solid phase
!c  ---------------------------------------------------------------------  

!c  concentration of sorbed species

        if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.       &
            nsb_surf.gt.0.or.noncompetitive_sorption)) then
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsb'
            else
              strbuffer = prefix(:l_prfx)//'_'//                           &
                          suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsb'
            end if
            call binary_file_open(Petsc_Comm_World, igsb,        &
                         trim(strbuffer),b_output_mpiio_single)
          else
            open(igsb,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsb',&
                      status='unknown',form='formatted')
          end if

          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsb, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Sorbed species concentrations, ',&
     &                               'initial condition',('-',i=1,72)   
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
     &              'Sorbed species concentrations, T = ',             &
     &               time_io,time_unit(:l_time_unit),                  &
     &              ('-',i=1,72)                                        
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gsb'
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'
          
          end if

!c  non-competitive sorption

          if (rank == 0 .and. b_enable_output) then

            if (noncompetitive_sorption) then
              ianc = 0
              do ic =1,nc
                if (isotherm_type(ic).ne.'none') then
                  ianc = ianc+1
                    if (ianc.lt.7) then
                      write(ifls,'(i1,8x,a30,2x,a)') ianc+3,namec(ic), &
     &                                              'moles/l bulk'      
                    else                                                
                      write(ifls,'(i2,7x,a30,2x,a)') ianc+3,namec(ic), &
     &                                              'moles/l bulk'
                    end if
                  end if
              end do
            end if
          
          end if

!c  competitive sorption

          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
              
            if (rank == 0 .and. b_enable_output) then  

!cprovi------------------------------------------------------------           
!cprovi------------------------------------------------------------           
!cprovi------------------------------------------------------------           

!c  primary surface species

            do isites = 1,nsites
              ic = iaic(isites)
              if (isites+nanc.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)')isites+nanc+3,namec(ic),&
                                              output_unit_sb_surf           
              else                                                     
                write(ifls,'(i2,7x,a30,2x,a)')isites+nanc+3,namec(ic),&
                                              output_unit_sb_surf
              end if
            end do

!c  secondary surface species

            do isb = 1,nsb_ion
              if (isb+nanc+nsites.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+3,     &
                                              namesb_ion(isb),        &
                                              output_unit_sb_ion           
              else                                                     
                write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+3,     &
                                              namesb_ion(isb),        &
                                              output_unit_sb_ion
              end if
            end do
            
            do isb = 1,nsb_surf
              if (isb+nanc+nsites.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+3,     &
                                              namesb_surf(isb),       &
                                              output_unit_sb_surf           
              else                                                     
                write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+3,     &
                                              namesb_surf(isb),       &
                                              output_unit_sb_surf
              end if
            end do
         
            end if          !nsb.gt.0
            
          end if  

        end if            !nsb.gt.0.or.noncompetitive_sorption

!c  mineral parameters

        if (nm.gt.0) then

!c  saturation indices for minerals
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gss'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gss'
            end if
            call binary_file_open(Petsc_Comm_World, igss,      &
                         trim(strbuffer),b_output_mpiio_single)

          else
            open(igss,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gss',&
                      status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igss, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Mineral saturation indices, ',   &
     &                               'initial condition',('-',i=1,72)   
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
     &              'Mineral saturation indices, T = ',                &
     &               time_io,time_unit(:l_time_unit),('-',i=1,72)       
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gss'
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'
            do im = 1,nm
              if (im.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') im+3,namem(im),'-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') im+3,namem(im),'-'
              end if
            end do
          
          end if

!c  reaction rates of minerals
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsd'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsd'
            end if
            call binary_file_open(Petsc_Comm_World, igsd,      &
                         trim(strbuffer),b_output_mpiio_single)

          else
            open(igsd,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsd',&
                      status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsd, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                        
            if (initial_condition) then                                   
              write(ifls,'(/2a/72a)')'Dissolution-precipitation rates, ',&
     &                               'initial condition',('-',i=1,72)     
            else                                                          
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
     &              'Dissolution-precipitation rates, T = ',             &
     &               time_io,time_unit(:l_time_unit),('-',i=1,72)         
            end if
                                                                          
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
     &                          suffix(:l_sufx)//'.gsd'
                                                                          
            write(ifls,'(2a)')                                           &
     &            'column   entry                           ','unit'      
            write(ifls,'(2a)')                                           &
     &            '1        x                               ','m'         
            write(ifls,'(2a)')                                           &
     &            '2        y                               ','m'         
            write(ifls,'(2a)')                                           &
     &            '3        z                               ','m'         
            istart = iamd(1)                                              
            istop = iamd(nm+1)-1                                          
            do ireac = istart,istop                                       
              if (ireac.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') ireac+3,namemp(ireac),   &
     &                                        'moles/l bulk/day'          
              else                                                        
                write(ifls,'(i2,7x,a30,2x,a)') ireac+3,namemp(ireac),   &
     &                                        'moles/l bulk/day'
              end if
            end do
          
          end if

!c  mineral volume fractions
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsv'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsv'
            end if 
            call binary_file_open(Petsc_Comm_World, igsv,      &
                         trim(strbuffer),b_output_mpiio_single)

          else
            open(igsv,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsv',&
                      status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsv, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                        
            if (initial_condition) then                                   
              write(ifls,'(/2a/72a)')'Mineral volume fractions, ',     &
     &                               'initial condition ',('-',i=1,72)  
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
     &              'Mineral volume fractions, T = ',                  &
     &              time_io,time_unit(:l_time_unit),('-',i=1,72)        
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gsv'
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'
            do im = 1,nm
              if (im.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') im+3,namem(im),'-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') im+3,namem(im),'-'
              end if
            end do
            if (nm.lt.6) then
              write(ifls,'(i1,8x,a30,2x,a)') nm+4,'porosity','-'
            else
              write(ifls,'(i2,7x,a30,2x,a)') nm+4,'porosity','-'
            end if

            if (update_porosity .and. update_permeability) then
              write(ifls,'(i2,7x,a30,2x,a)') nm+5,'hydraulic conductivity x','m/s'
              write(ifls,'(i2,7x,a30,2x,a)') nm+6,'hydraulic conductivity y','m/s'
              write(ifls,'(i2,7x,a30,2x,a)') nm+7,'hydraulic conductivity z','m/s'
            end if
          
          end if

        end if                         !(nm.gt.0)

        if (nmx.gt.0) then

!c  saturation indices for excluded minerals
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsx'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsx'
            end if
            call binary_file_open(Petsc_Comm_World, igsx,    &
                         trim(strbuffer),b_output_mpiio_single)
          else
            open(igsx,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsx',&
                      status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsx, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Saturation indices (excluded ',  &
     &                               'minerals), initial condition',   &
     &                              ('-',i=1,72)                        
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
     &              'Saturation indices (excluded minerals), T = ',    &
     &               time_io,time_unit(:l_time_unit),('-',i=1,72)       
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gsx'
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'
            do imx = 1,nmx
              if (imx.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') imx+3,namemx(imx),'-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') imx+3,namemx(imx),'-'
              end if
            end do
          
          end if

        end if                         !(nmx.gt.0)
        
        if (iso_output) then
!c  isotope data
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsis'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsis'
            end if
            call binary_file_open(Petsc_Comm_World, igsis,             &
                         trim(strbuffer),b_output_mpiio_single)
          else
            open(igsis,file=prefix(:l_prfx)//'_'//                     &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsis',    &
                 status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsis, "#")
          end if
          
          if (rank == 0 .and. b_enable_output) then
            if (initial_condition) then                                   
              write(ifls,'(/a/72a)')'Isotope Data, initial condition', &
                                    ('-',i=1,72)                        
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Isotope Data, T = ',                              &
                     time_io,time_unit(:l_time_unit),('-',i=1,72)       
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsis'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            
            icount = 1
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i1 = istart, istop
                ic2 = jamdisoo(i1)
                icount = icount +1
                if (icount.le.9) then
                    write(ifls,'(i1,8x,a30,2x,a)') icount,namec(ic2),  &
                                       'moles/l h2o'                    
                else                                                    
                    write(ifls,'(i2,7x,a30,2x,a)') icount,namec(ic2),  &
                                       'moles/l h2o'                    
                end if                                                  
              end do                                                    
              icount = icount +1                                        
              ic2 = jamdisoo(istart)                                    
              if (icount.le.9) then                                     
                write(ifls,'(i1,8x,a4,a,4x,a)') icount, 'sum ',        &
                      namec(ic2), 'moles/l h2o'                         
              else                                                      
                write(ifls,'(i2,8x,a4,a,4x,a)') icount, 'sum ',        &
                      namec(ic2), 'moles/l h2o'                           
              end if                                                      
                                                                          
              istart = iamdisoo(i)                                        
              istop = iamdisoo(i+1)-1                                     
              do i1 = istart+1, istop                                     
                ic1 = jamdisoo(istart)                                    
                ic2 = jamdisoo(i1)                                        
                icount = icount +1                                        
                if (icount.le.9) then                                     
                  write(ifls,'(i1,8x,a6,a8,a2,a8,8x,a)') icount,       &
                    'delta ', namec(ic2),'/ ' , namec(ic1),'per mil'      
                else                                                      
                  write(ifls,'(i2,8x,a6,a8,a2,a8,8x,a)') icount,       &
                    'delta ', namec(ic2),'/ ' , namec(ic1),'per mil'
                end if
                
              end do 
            end do
          end if
        end if                         !(iso_output)
        
!c  ---------------------------------------------------------------------  
!c  open files - water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------  
        
        if (chemical_water) then
     
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsw'
            else
              strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//      &
                          trim(adjustl(str_rank))//'.gsw'
            end if
            call binary_file_open(Petsc_Comm_World, igsw,    &
                         trim(strbuffer),b_output_mpiio_single)
          else
            open(igsw,file=prefix(:l_prfx)//'_'//                      &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsw',&
                      status='unknown',form='formatted')
          end if
          
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsx, "#")
          end if

          if (rank == 0 .and. b_enable_output) then
            if (initial_condition) then
              
            write(ifls,'(/2a/72a)')'Water produced/consumed, initial', & 
     &                               ' condition',('-',i=1,72)          
            else                                                        
              write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')                   &
     &              'Water produced/consumed, ','T = ',                &
     &               time_io,time_unit(:l_time_unit),('-',i=1,72)       
            end if                                                      
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
     &                          suffix(:l_sufx)//'.gsw'                 
                                                                        
            write(ifls,'(2a)')                                         &
     &            'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
     &            '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '3        z                               ','m'       
            write(ifls,'(2a)')                                         &
     &            '4        water produced/consumed         ',         &
     &            'l H2O d^-1'
          end if
        endif

      end if                           !(extended_output_gs)

!c  --------------------------------------------------------------------- 
!c  output for tecplot
!c  --------------------------------------------------------------------- 

      if (tec_header) then

!c  --------------------------------------------------------------------- 
!c  total aqueous component concentrations
!c  --------------------------------------------------------------------- 

!c  title and variables
!c  version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igst, "#")
        end if
        
        if (b_output_binary) then
          strbuffer = 'dataset '//prefix(:l_prfx) 
          offset_igst = 0
          call tecplot_binary_write_header(Petsc_Comm_World, igst,     &
                       "#!TDV102", trim(strbuffer), offset_igst,       &
                       b_output_mpiio_single,.false.)
          
          tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
          do ic = 1, nc-1
            tec_variables(3+ic) = namec(ic)(:l_namec(ic))  
          end do
          call tecplot_binary_write_variable(Petsc_Comm_World, igst,   &
                       2+nc, tec_variables(1:2+nc), offset_igst,       &
                       b_output_mpiio_single,.false.)
        else        
          write(igst,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(igst,'(1000a)') 'variables = "x", "y", "z"',           &
                              (',"',namec(ic)(:l_namec(ic)),'"',       &
                              ic=1,nc-1)
        end if

! prc ----------------------------------------------------------------
        if (multi_diff) then
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(icbt, "#")
          end if
        
          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx)//''            
            offset_icbt = 0
            call tecplot_binary_write_header(Petsc_Comm_World, icbt,     &
                         "#!TDV102", trim(strbuffer), offset_icbt,       &
                         b_output_mpiio_single,.false.)
            
            tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
            do ic = 1, nc-1
              tec_variables(3+ic) = namec(ic)(:l_namec(ic))  
            end do
            tec_variables(3+nc) = "Charge Balance Error %"
            tec_variables(4+nc) = "Charge Balance"
            call tecplot_binary_write_variable(Petsc_Comm_World, icbt, &
                         4+nc, tec_variables(1:4+nc), offset_icbt,     &
                         b_output_mpiio_single,.false.)
          else
            write(icbt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(icbt,'(1000a)') 'variables = "x", "y", "z"',         &
                  (',"',namec(ic)(:l_namec(ic)),'"',                   &
                  ic=1,nc-1), ', "Charge Balance Error %"',            &
                  ', "Charge Balance"'
          end if
        end if

        if(flux_out)then
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igmf, "#")
          end if
            
          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx)//''              
            offset_igmf = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igmf,   &
                         "#!TDV102", trim(strbuffer), offset_igmf,     &
                         b_output_mpiio_single,.false.)
            
            tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
            do ic = 1, nc-1
              tec_variables(3+ic) = namec(ic)(:l_namec(ic))  
            end do
            call tecplot_binary_write_variable(Petsc_Comm_World,       &
                         igmf, 2+nc, tec_variables(1:2+nc),            &
                         offset_igmf, b_output_mpiio_single,.false.) 
          else
            write(igmf,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(igmf,'(1000a)') 'variables = "x", "y", "z"',         &
                       (',"Total Flux ',namec(ic)(:l_namec(ic)),       &
                        '"',ic=1,nc-1)
          end if
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsre, "#")
          end if
        
          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx) 
            offset_igsre = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igsre,    &
                         "#!TDV102", trim(strbuffer), offset_igsre,      &
                         b_output_mpiio_single,.false.)
            
            tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
            do ingre = 1, ngre_i
              tec_variables(3+ingre) = trim(name_ngre_i(ingre))
            end do
            call tecplot_binary_write_variable(Petsc_Comm_World, igsre,  &
                         3+ngre_i, tec_variables(1:3+ngre_i),            &
                         offset_igsre, b_output_mpiio_single,.false.)
          else        
            write(igsre,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(igsre,'(1000a)') 'variables = "x", "y", "z"',          &
                                (', "',trim(name_ngre_i(ingre)),'"',     &
                                ingre = 1, ngre_i)
          end if
        end if


! prc ---------------------------------------------------------------- 

        if (initial_condition) then

!c  zone record for initial condition
          if (b_output_binary) then
            strbuffer = 'T_j, initial'
            offset_igst_temp = offset_igst 
            
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igst,trim(strbuffer),offset_igst,           &
                           itec,jtec,ktec,                             &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igst = offset_igst_temp +                         &
                            (11+len_trim(strbuffer))*4*nprcs + 4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igst,trim(strbuffer),offset_igst,           &
                           itec_gbl,jtec_gbl,ktec_gbl,                 &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igst = offset_igst_temp +                         &
                            (12+len_trim(strbuffer))*4
            end if
          else
            write(igst,'(a,3(a,i5),a)')                                &
                  'zone t = "T_j, ',                                   &
                  'initial", i =',itec,', j =',jtec,', k =',           &
                  ktec,',  f=point'
          end if

! prc ----------------------------------------------------------------
          if (multi_diff) then
            if (b_output_binary) then
              strbuffer = 'T_j, initial'
              offset_icbt_temp = offset_icbt 
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             icbt,trim(strbuffer),offset_icbt,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_icbt = offset_icbt_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             icbt,trim(strbuffer),offset_icbt,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_icbt = offset_icbt_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else  
              write(icbt,'(a,3(a,i5),a)')                              &
                    'zone t = "T_j, ',                                 &
                    'initial", i =',itec,', j =',jtec,', k =',         &
                    ktec,',  f=point'
            end if     
          end if

          if(flux_out)then
            if (b_output_binary) then  
              strbuffer = 'T_j, initial'
              offset_igmf_temp = offset_igmf 
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igmf,trim(strbuffer),offset_igmf,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igmf = offset_igmf_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igmf,trim(strbuffer),offset_igmf,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igmf = offset_igmf_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igmf,'(a,3(a,i5),a)')                   &
                'zone t = "T_j, ',                          &
                'initial", i =',itec,', j =',jtec,', k =',  &
                ktec,',  f=point' 
            end if  
          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
            if (b_output_binary) then
              strbuffer = 'T_j, initial'
              offset_igsre_temp = offset_igsre 
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsre,trim(strbuffer),offset_igsre,       &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)
                offset_igsre = offset_igsre_temp +                     &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsre,trim(strbuffer),offset_igsre,       &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)
                offset_igsre = offset_igsre_temp +                     &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsre,'(a,3(a,i5),a)')                             &
                    'zone t = "T_j, ',                                 &
                    'initial", i =',itec,', j =',jtec,', k =',         &
                    ktec,',  f=point'
            end if
          end if

! prc ----------------------------------------------------------------

        elseif (.not.initial_condition) then

!c  zone record for current time step
          if (b_output_binary) then
            write(strbuffer,'(a,1pe15.6e3,1x,a)')                      &
                  'T_j, T = ', time_io,time_unit 
            offset_igst_temp = offset_igst  
            
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igst,&
                           trim(strbuffer),offset_igst,                &
                           itec, jtec, ktec,                           &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igst = offset_igst_temp +                         &
                            (11+len_trim(strbuffer))*4*nprcs + 4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,igst,&
                           trim(strbuffer),offset_igst,                &
                           itec_gbl,jtec_gbl,ktec_gbl,                 &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igst = offset_igst_temp +                         &
                            (12+len_trim(strbuffer))*4
            end if
          else
            write(igst,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')                &
                 'zone t = "T_j, ',                                    &
                 'T = ',time_io,time_unit(:l_time_unit),               &
                 '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
          end if

! prc ----------------------------------------------------------------
          if (multi_diff) then
            if (b_output_binary) then  
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'T_j, T = ', time_io,time_unit(:l_time_unit)
              offset_icbt_temp = offset_icbt  
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             icbt, trim(strbuffer),offset_icbt,        &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_icbt = offset_icbt_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             icbt, trim(strbuffer),offset_icbt,        &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_icbt = offset_icbt_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else    
              write(icbt,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')              &
                   'zone t = "T_j, ',                                  &
                   'T = ',time_io,time_unit(:l_time_unit),             &
                   '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            end if            
          end if

          if(flux_out)then
            if (b_output_binary) then
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'T_j, T = ', time_io,time_unit(:l_time_unit)
              offset_igmf_temp = offset_igmf 
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igmf,trim(strbuffer),offset_igmf,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igmf = offset_igmf_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igmf,trim(strbuffer),offset_igmf,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igmf = offset_igmf_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
               write(igmf,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')             &
               'zone t = "T_j, ',                                      &
               'T = ',time_io,time_unit(:l_time_unit),                 &
               '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
            if (b_output_binary) then
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'T_j, T = ', time_io,time_unit 
              offset_igsre_temp = offset_igsre  

              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsre,trim(strbuffer),offset_igsre,       &
                             itec, jtec, ktec,                         &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)
                offset_igsre = offset_igsre_temp +                     &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsre,trim(strbuffer),offset_igsre,       &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)
                offset_igsre = offset_igsre_temp +                     &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsre,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                   'zone t = "T_j, ',                                  &
                   'T = ',time_io,time_unit(:l_time_unit),             &
                   '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          end if

        end if       !(initial_condition)

!c  --------------------------------------------------------------------- 
!c  output for xmgr
!c  --------------------------------------------------------------------- 

      else           !(tec_header)

!c  --------------------------------------------------------------------- 
!c  total aqueous component concentrations
!c  --------------------------------------------------------------------- 

!c  title and variables
!c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(igst, "#")
        end if
        
        write(igst,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
        write(igst,'(1000a)') '# variables = "x", "y", "z"',          &
                           (',"',namec(ic)(:l_namec(ic)),'"',ic=1,nc-1)

        if (multi_diff) then
!c  version information
          if (b_writeversion_tecplot ) then
            call writeversion2file(icbt, "#")
          end if
        
          write(icbt,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'    
          write(icbt,'(1000a)') '# variables = "x", "y", "z"',         &
               (',"',namec(ic)(:l_namec(ic)),'"',ic=1,nc-1),           &
                ', "Charge Balance Error %"',                          &
                ', "Charge Balance"', ', "rho_q [C m-3]"'
        end if

        if(flux_out)then
!c  version information
          if (b_writeversion_tecplot ) then
            call writeversion2file(igmf, "#")
          end if
        
          write(igmf,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          write(igmf,'(1000a)') '# variables = "x", "y", "z"',         &
                (',"Total Flux ',namec(ic)(:l_namec(ic)),              &
                 '"',ic=1,nc-1)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
!c  version information        
          if (b_writeversion_tecplot ) then
            call writeversion2file(igsre, "#")
          end if
        
          write(igsre,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          write(igsre,'(1000a)') '# variables = "x", "y", "z"',        &
               (',"',trim(name_ngre_i(ingre)),'"',ingre=1,ngre_i)
        end if

        if (initial_condition) then

!c  zone record for initial condition

          write(igst,'(a,3(a,i5),a)')                                  &
                '# zone t = "T_j, ',                                   &
                'initial", i =',itec,', j =',jtec,', k =',             &
                ktec,',  f=point'

          if (multi_diff) then
          
            write(icbt,'(a,3(a,i5),a)')                                &
                '# zone t = "T_j, ',                                   &
                'initial", i =',itec,', j =',jtec,', k =',             &
                ktec,',  f=point'
     
          end if

          if(flux_out)then
            write(igmf,'(a,3(a,i5),a)')                                &
                '# zone t = "T_j, ',                                   &
                'initial", i =',itec,', j =',jtec,', k =',             &
                ktec,',  f=point'
          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
            write(igsre,'(a,3(a,i5),a)')                               &
                  '# zone t = "T_j, ',                                 &
                  'initial", i =',itec,', j =',jtec,', k =',           &
                  ktec,',  f=point'
          end if

        elseif (.not.initial_condition) then

!c  zone record for current time step

          write(igst,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')                 &
               '# zone t = "T_j, ',                                   &
               'T = ',time_io,time_unit(:l_time_unit),'", i =',itec,  &
               ', j =',jtec,', k =',ktec,',  f=point'

          if (multi_diff) then
          
            write(icbt,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')               &
               '# zone t = "T_j, ',                                   &
               'T = ',time_io,time_unit(:l_time_unit),'", i =',itec,  &
               ', j =',jtec,', k =',ktec,',  f=point'
     
          end if 

          if(flux_out)then
            write(igmf,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')               &
               '# zone t = "T_j, ',                                   &
               'T = ',time_io,time_unit(:l_time_unit),'", i =',itec,  &
               ', j =',jtec,', k =',ktec,',  f=point'
          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
            write(igsre,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')               &
                 '# zone t = "T_j, ',                                  &
                 'T = ',time_io,time_unit(:l_time_unit),'", i =',itec, &
                 ', j =',jtec,', k =',ktec,',  f=point'
          end if

        end if       !(initial_condition)

      end if         !(tec_header)
      
      if (b_output_binary) then          
        offset_igst_temp = offset_igst          
        call tecplot_binary_write_section(Petsc_Comm_World,igst,2+nc,  &
                     nn_offset,offset_igst,b_output_mpiio_single,      &
                     .false.,b_output_multizone)

        allocate(realbuffer(nn*(2+nc)), stat = ierr)
        call checkerr(ierr,'outputrt-realbuffer',ilog)
        realbuffer = 0.0d0
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        
        if (multi_diff) then
          offset_icbt_temp = offset_icbt          
          call tecplot_binary_write_section(Petsc_Comm_World,icbt,4+nc,&
                       nn_offset,offset_icbt,b_output_mpiio_single,    &
                       .false.,b_output_multizone) 
          allocate(realbuffer2(nn*(4+nc)), stat = ierr)
          call checkerr(ierr,'outputrt-realbuffer2',ilog)
          realbuffer2 = 0.0d0
          call memory_monitor(sizeof(realbuffer2),'realbuffer2',.true.)
        end if
        
        if (flux_out) then
          offset_igmf_temp = offset_igmf          
          call tecplot_binary_write_section(Petsc_Comm_World,igmf,2+nc,&
                       nn_offset,offset_igmf,b_output_mpiio_single,    &
                       .false.,b_output_multizone) 

          allocate(realbuffer3(nn*(2+nc)), stat = ierr)
          call checkerr(ierr,'outputrt-realbuffer3',ilog)
          realbuffer3 = 0.0d0
          call memory_monitor(sizeof(realbuffer3),'realbuffer3',.true.)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          offset_igsre_temp = offset_igsre          
          call tecplot_binary_write_section(Petsc_Comm_World,igsre,    &
                       ngre_i+3,nn_offset,offset_igsre,                &
                       b_output_mpiio_single,.false.,b_output_multizone)

          allocate(realbuffer15(nn*(ngre_i+3)), stat = ierr)
          call checkerr(ierr,'outputrt-realbuffer15',ilog)
          realbuffer15 = 0.0d0
          call memory_monitor(sizeof(realbuffer15),'realbuffer15',.true.)
        end if

      end if

      ivol_l = 0
      
      do ivol=1,nngl
          
!c  skip ghost nodes
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
            cycle
        end if
#endif
        ivol_l = ivol_l + 1
        
!c  recompute total aqueous component concentrations

        if (redox_equil.and.nr.gt.0) then
          call totconc(cnew(1,ivol),cx(1,ivol),totcnew(1,ivol))
        end if

!c  write results

!c  assign depth coordinate in terms of depth or elevation

        zout = zoutput(depth_output,zg(ivol),elevmax)

!c  calculate concentrations of sorbed species and convert the unit to mol/L H2O
!c  when 'combined output of aquous and sorbed concentrations' is specified
        totcsb_ion = 0.0d0 
        totcsb_surf = 0.0d0

        if (combined_gst_gsb_output) then
          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
            do isb = 1,nsb_ion 
              call sorbspc_m(csb_ion(isb,tid),dummy,cec_g(ivol),    &
                   cec_fraction_g(idx_nsites_ion(isb),ivol),        &
                   eqsb_ion(:,tid),eqsb_surf(:,tid),                &
                   gamma(1,ivol),cnew(1,ivol),xnusb_ion,xnusb_surf, &
                   iasb_ion,iasb_surf,jasb_ion,jasb_surf,           &
                   nsb_ion,nsb_surf,isb,0,                          &
                   sorption_type_ion,sorption_type_surf,            &
                   sorption_group,isactcexch)

!c  add up exchanged species and convert from [meq/100g] solid to 
!c  [mmol/100g solid]
              istart = iasb_ion(isb)
              istop = iasb_ion(isb+1)-1
              do i1 = istart,istop
                ic = jasb_ion(i1)
            
!c  skip h2o, since not a primary unknown
!c  For the sorbed species it should be the species concentration of the sorbed species, 
!c  which reflects the amount of the ion on the surface site.           
                if (namec(ic).ne.'h2o') then
                  if (xnusb_ion(i1) > r0) then
                    totcsb_ion(ic) = totcsb_ion(ic)+xnusb_ion(i1)*     &
                                     csb_ion(isb,tid)/chargesb_ion(isb)
                  end if
                end if
              end do
            end do

!c  compute total sorbed concentrations and convert from [mmol/100g solid] to [mol/L H2O] 
            if (nsb_ion > 0) then
              do ic=1,nc-1
                totcsb_ion(ic) = rhobulk_g(ivol)/r100*totcsb_ion(ic)/ &
                                 pornew(ivol)/sanew(ivol)
              end do
            end if      
            
            do isb = 1,nsb_surf
              call sorbspc(dummy,csb_surf(isb,tid),cec_g(ivol),       &
                   eqsb_ion(:,tid),eqsb_surf(:,tid),                  &
                   gamma(1,ivol),cnew(1,ivol),                        &
                   xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,           &
                   jasb_ion,jasb_surf,nsb_ion,                        &
                   nsb_surf,0,isb,sorption_type_ion,                  &
                   sorption_type_surf,sorption_group,isactcexch) 

!c  add up exchanged species and convert from [meq/100g] solid to 
!c  [mmol/100g solid]
              istart = iasb_surf(isb)
              istop = iasb_surf(isb+1)-1
              do i1 = istart,istop
                ic = jasb_surf(i1)
         
!c  skip h2o, since not a primary unknown 
!c  For the sorbed species it should be the species concentration of the sorbed species, 
!c  which reflects the amount of the ion on the surface site. 
                if (namec(ic).ne.'h2o') then
                  if (xnusb_surf(i1) > r0) then
                    totcsb_surf(ic) = totcsb_surf(ic)+xnusb_surf(i1)*  &
                                      csb_surf(isb,tid)
                  end if
                end if
              end do

            end do

!c  compute total sorbed concentrations and convert from [mmol/100g solid] to [mol/L H2O] 
            if (nsb_surf > 0) then
              do ic=1,nc-1
                totcsb_surf(ic) = rhobulk_g(ivol)/r100*totcsb_surf(ic)/&
                                  pornew(ivol)/sanew(ivol)
              end do
            end if
        
          end if
        end if

        if (b_output_binary) then
          realbuffer((ivol_l-1)*(2+nc)+1:(ivol_l-1)*(2+nc)+3) = (/     &
                     xg(ivol),yg(ivol),zout/)
          do ic = 1, nc-1
            realbuffer((ivol_l-1)*(2+nc)+3+ic) = totcnew(ic,ivol) +    &
                      totcsb_ion(ic)+totcsb_surf(ic)
          end do
        else
          if (iout_high .eq. 1) then
            write(igst,ascii_fmt) xg(ivol),yg(ivol),zout,              &
                 ((totcnew(ic,ivol)+totcsb_ion(ic)+totcsb_surf(ic)),   &
                 ic=1,nc-1)
          else
            write(igst,ascii_fmt) xg(ivol),yg(ivol),zout,              &
                 ((totcnew(ic,ivol)+totcsb_ion(ic)+totcsb_surf(ic)),   &
                 ic=1,nc-1)
          end if

        end if
! prc ----------------------------------------------------------------
! prc Charge Balance distribution
! prc Pejman Rasouli
! prc ----------------------------------------------------------------
! cdsu Replace the MCD charge balance calculation with function cbalance.
! cdsu Previous code does not deal with zero charge problem.
! cdsu ---------------------------------------------------------------
        
        if (multi_diff) then
          call cbalance(cnew(:,ivol),cx(:,ivol),zbal,zpos,zneg)
                    
! prc ----------------------------------------------------------------
! prc Charge Balance distribution
! prc Pejman Rasouli
! prc ----------------------------------------------------------------
          if (b_output_binary) then
            realbuffer2((ivol_l-1)*(4+nc)+1:(ivol_l-1)*(4+nc)+3) = (/ &
                   xg(ivol),yg(ivol),zout/) 
            do ic = 1, nc-1
              realbuffer2((ivol_l-1)*(4+nc)+3+ic) = totcnew(ic,ivol) 
            end do
            realbuffer2(ivol_l*(4+nc)-1) = zbal
            realbuffer2(ivol_l*(4+nc)) = zpos-zneg
          else
            write(icbt,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                 (totcnew(ic,ivol),ic=1,nc-1), zbal, zpos-zneg
          end if
        end if
        
        if(flux_out)then
          call flux_calc(ivol,tid)       
            
          if (b_output_binary) then
            realbuffer3((ivol_l-1)*(2+nc)+1:(ivol_l-1)*(2+nc)+3) = (/  &
                       xg(ivol),yg(ivol),zout/)
            do ic = 1, nc-1
              realbuffer3((ivol_l-1)*(2+nc)+3+ic) = totcflux(ic)
            end do 
          else
            write(igmf,ascii_fmt) xg(ivol),yg(ivol),zout,              &
                   (totcflux(ic),ic=1,nc-1)
          end if
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          if (b_output_binary) then
            realbuffer15((ivol_l-1)*(ngre_i+3)+1:(ivol_l-1)*(ngre_i+3)+3) = (/ &
                       xg(ivol),yg(ivol),zout/)
            do ingre = 1, ngre_i
              realbuffer15((ivol_l-1)*(ngre_i+3)+3+ingre) = conc_ngre(ingre,ivol)
            end do
          else
            write(igsre,ascii_fmt) xg(ivol),yg(ivol),zout,             &
                 (conc_ngre(ingre,ivol),ingre=1,ngre_i)
          end if
        end if

!c  compress vector containing total aqueous component concentrations

        if (redox_equil.and.nr.gt.0) then
          call comptotc(totcnew(1,ivol))
        end if
        
      end do
    
      if (b_output_binary) then
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igst, size(realbuffer,1),             &
                       realbuffer, offset_igst,b_output_mpiio_single) 
        else
          call binary_subarray_initialize(nc+2,b_mpiarray_igst_init,   &
                      .false.,mpiarray_filetype_igst,                  &
                      mpiarray_sizes_gbl_igst,mpiarray_sizes_sub_igst, &
                      mpiarray_starts_sub_igst)
          call binary_write_data(igst,size(realbuffer,1),              &
                       realbuffer,offset_igst,mpiarray_filetype_igst)  
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer) 
        
        if (multi_diff) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(icbt, size(realbuffer2,1),          &
                         realbuffer2, offset_icbt,b_output_mpiio_single)
          else
            call binary_subarray_initialize(nc+4,b_mpiarray_icbt_init, &
                       .false.,mpiarray_filetype_icbt,                 &
                       mpiarray_sizes_gbl_icbt,mpiarray_sizes_sub_icbt,&
                       mpiarray_starts_sub_icbt)
            call binary_write_data(icbt, size(realbuffer2,1),          &
                       realbuffer2, offset_icbt,mpiarray_filetype_icbt)
          end if
          call memory_monitor(-sizeof(realbuffer2),'realbuffer2',.true.)
          deallocate(realbuffer2) 
        end if
        
        if (flux_out) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(igmf, size(realbuffer3,1),          &
                         realbuffer3, offset_igmf,b_output_mpiio_single)
          else
            call binary_subarray_initialize(nc+2,b_mpiarray_igmf_init,   &
                        .false.,mpiarray_filetype_igmf,                  &
                        mpiarray_sizes_gbl_igmf,mpiarray_sizes_sub_igmf, &
                        mpiarray_starts_sub_igmf)
            call binary_write_data(igmf, size(realbuffer3,1),          &
                         realbuffer3, offset_igmf,mpiarray_filetype_igmf) 
          end if
          call memory_monitor(-sizeof(realbuffer3),'realbuffer3',.true.)
          deallocate(realbuffer3)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(igsre, size(realbuffer15,1),        &
                         realbuffer15, offset_igsre,b_output_mpiio_single) 
          else
            call binary_subarray_initialize(ngre_i+3,b_mpiarray_igsre_init,  &
                        .false.,mpiarray_filetype_igsre,                     &
                        mpiarray_sizes_gbl_igsre,mpiarray_sizes_sub_igsre,   &
                        mpiarray_starts_sub_igsre)
            call binary_write_data(igsre,size(realbuffer15,1),               &
                         realbuffer15,offset_igsre,mpiarray_filetype_igsre)  
          end if
          call memory_monitor(-sizeof(realbuffer15),'realbuffer15',.true.)
          deallocate(realbuffer15) 
        end if

      end if

!c  ---------------------------------------------------------------------
!c  extended output --> species concentrations
!c                      master variables
!c                      partial gas pressures
!c                      sorbed species concentrations
!c                      saturation indices of minerals
!c                      dissolution-precipitation rates
!c                      oxidation-reduction rates
!c                      volume fractions of minerals
!c                      activity coefficients
!c  ---------------------------------------------------------------------
 
      if (extended_output_gs) then

!c  ---------------------------------------------------------------------
!c  output for tecplot
!c  ---------------------------------------------------------------------

        if (tec_header) then

!c  -----------------------------------------------
!c  free species and aqueous complex concentrations
!c  -----------------------------------------------
    
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(igsc, "#")
          end if
!c  title and variables
          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx)//''            
            offset_igsc = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igsc,   &
                         "#!TDV102", trim(strbuffer), offset_igsc,     &
                         b_output_mpiio_single,.false.)
            
            tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
            do ic=1, nc-1
              tec_variables(3+ic) = namec(ic)(:l_namec(ic))
            end do
            do ix=1,nxout
              tec_variables(nc+2+ix) = namex(ix)(:l_namex(ix))  
            end do
            call tecplot_binary_write_variable(Petsc_Comm_World, igsc, &
                         nc+nxout+2, tec_variables(1:nc+nxout+2),      &
                         offset_igsc,b_output_mpiio_single,.false.) 
          else
            write(igsc,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(igsc,'(1000a)') 'variables = "x", "y", "z"',         &
                                (',"',namec(ic)(:l_namec(ic)),         &
                                '"',ic=1,nc-1),                        &
                                (',"',namex(ix)(:l_namex(ix)),         &
                                '"',ix=1,nxout)
          end if

          if (initial_condition) then

!c  zone record for initial condition
            if (b_output_binary) then
              strbuffer = 'C_j, X_i, initial'              
              offset_igsc_temp = offset_igsc 
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsc,trim(strbuffer),offset_igsc,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsc = offset_igsc_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4 
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsc,trim(strbuffer),offset_igsc,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsc = offset_igsc_temp +                       &
                              (12+len_trim(strbuffer))*4 
              end if
            else
              write(igsc,'(a,3(a,i5),a)')                              &
                    'zone t = "C_j, X_i, ',                            &
                    'initial", i =',itec,', j =',jtec,                 &
                    ', k =',ktec,',  f=point'
            end if
          elseif (.not.initial_condition) then

!c  zone record for current time step
            if (b_output_binary) then
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'C_j, X_i, T = ',time_io,time_unit(:l_time_unit)            
              offset_igsc_temp = offset_igsc 
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsc, trim(strbuffer),offset_igsc,        &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsc = offset_igsc_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4 
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsc, trim(strbuffer),offset_igsc,        &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsc = offset_igsc_temp +                       &
                              (12+len_trim(strbuffer))*4 
              end if
            else
              write(igsc,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
                   'zone t = "C_j, X_i, T = ',                         &
                   time_io,time_unit(:l_time_unit),'", i =',           &
                   itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          end if       !(initial_condition)
 
          if (b_output_activity) then
!c  version information
            if (b_writeversion_tecplot .and. .not. b_output_binary) then
                call writeversion2file(igsac, "#")
            end if
!c  title and variables
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//''            
              offset_igsac = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsac,  &
                           "#!TDV102", trim(strbuffer), offset_igsac,    &
                           b_output_mpiio_single,.false.)
              
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
              do ic=1, nc-1
                tec_variables(3+ic) = namec(ic)(:l_namec(ic))
              end do
              do ix=1,nxout
                tec_variables(nc+2+ix) = namex(ix)(:l_namex(ix))  
              end do
              call tecplot_binary_write_variable(Petsc_Comm_World, igsac,&
                           nc+nxout+2, tec_variables(1:nc+nxout+2),      &
                           offset_igsac,b_output_mpiio_single,.false.) 
            else
              write(igsac,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsac,'(1000a)') 'variables = "x", "y", "z"',        &
                                  (',"',namec(ic)(:l_namec(ic)),         &
                                  '"',ic=1,nc-1),                        &
                                  (',"',namex(ix)(:l_namex(ix)),         &
                                  '"',ix=1,nxout)
            end if
            
            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'C_j, X_i, initial'              
                offset_igsac_temp = offset_igsac 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                               igsac,trim(strbuffer),offset_igsac,       &
                               itec,jtec,ktec,                           &
                               b_output_mpiio_single,.false.,            &
                               b_output_multizone)              
                  offset_igsac = offset_igsac_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                               igsac,trim(strbuffer),offset_igsac,       &
                               itec_gbl,jtec_gbl,ktec_gbl,               &
                               b_output_mpiio_single,.false.,            &
                               b_output_multizone)              
                  offset_igsac = offset_igsac_temp +                     &
                                (12+len_trim(strbuffer))*4 
                end if
              else
                write(igsac,'(a,3(a,i5),a)')                             &
                      'zone t = "C_j, X_i, ',                            &
                      'initial", i =',itec,', j =',jtec,                 &
                      ', k =',ktec,',  f=point'
              end if
            elseif (.not.initial_condition) then

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                      'C_j, X_i, T = ',time_io,time_unit(:l_time_unit)            
                offset_igsac_temp = offset_igsac 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                               igsac, trim(strbuffer),offset_igsac,      &
                               itec,jtec,ktec,                           &
                               b_output_mpiio_single,.false.,            &
                               b_output_multizone)              
                  offset_igsac = offset_igsac_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                               igsac, trim(strbuffer),offset_igsac,      &
                               itec_gbl,jtec_gbl,ktec_gbl,               &
                               b_output_mpiio_single,.false.,            &
                               b_output_multizone)              
                  offset_igsac = offset_igsac_temp +                     &
                                (12+len_trim(strbuffer))*4 
                end if
              else
                write(igsac,'(a,1pe15.6e3,1x,a,3(a,i5),a)')              &
                     'zone t = "C_j, X_i, T = ',                         &
                     time_io,time_unit(:l_time_unit),'", i =',           &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            end if       !(initial_condition)
          end if       !(activity coefficients)
          
!c  ----------------
!c  master variables
!c  ----------------
          if (ph_output .or. pe_output) then
          
!c  title and variables
          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx)//''            
            offset_igsm = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igsm,   &
                         "#!TDV102", trim(strbuffer), offset_igsm,     &
                         b_output_mpiio_single,.false.)
            
            if ((ph_output).and.(pe_output)) then
              nvarsgsm = 15  
              tec_variables(1:15) = [character(len=72)::               &
                                      "x","y","z","pH","pe","Eh",      &
                                      "ionic strength","C-Alk [eq/L]", &
                                      "NC-Alk [eq/L]","Alk [eq/L]",    &
                                      "C-Alk [mg/L CaCO_3]",           &
                                      "NC-Alk [mg/L CaCO_3]",          &
                                      "Alk [mg/L CaCO_3]",             &
                                      "temperature","charge bal [%]"] 
            elseif ((.not.ph_output).and.(pe_output)) then
              nvarsgsm = 14
              tec_variables(1:14) = [character(len=72)::               &
                                      "x","y","z","pe","Eh",           &
                                      "ionic strength","C-Alk [eq/L]", &
                                      "NC-Alk [eq/L]","Alk [eq/L]",    &
                                      "C-Alk [mg/L CaCO_3]",           &
                                      "NC-Alk [mg/L CaCO_3]",          &
                                      "Alk [mg/L CaCO_3]",             &
                                      "temperature","charge bal [%]"]
            elseif ((ph_output).and.(.not.pe_output)) then
              nvarsgsm = 13
              tec_variables(1:13) = [character(len=72)::               &
                                      "x","y","z","pH",                &
                                      "ionic strength","C-Alk [eq/L]", &
                                      "NC-Alk [eq/L]","Alk [eq/L]",    &
                                      "C-Alk [mg/L CaCO_3]",           &
                                      "NC-Alk [mg/L CaCO_3]",          &
                                      "Alk [mg/L CaCO_3]",             &
                                      "temperature","charge bal [%]"]
            end if
            call tecplot_binary_write_variable(Petsc_Comm_World, igsm, &
                         nvarsgsm, tec_variables(1:nvarsgsm),          &
                         offset_igsm,b_output_mpiio_single,.false.)
          else
            write(igsm,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          
            if ((ph_output).and.(pe_output)) then
              write(igsm,'(8a)') 'variables = "x","y","z",',           &
                                 '"pH","pe","Eh","ionic strength",',   &
                                 '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                 '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                 '"NC-Alk [mg/L CaCO_3]",',            &
                                 '"Alk [mg/L CaCO_3]",',               &
                                 '"temperature",',                     &
                                 '"charge bal [%]"'                     
            elseif ((.not.ph_output).and.(pe_output)) then              
              write(igsm,'(8a)') 'variables = "x","y","z",',           &
                                 '"pe","Eh","ionic strength", ',       &
                                 '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                 '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                 '"NC-Alk [mg/L CaCO_3]",',            &
                                 '"Alk [mg/L CaCO_3]",',               &
                                 '"temperature",',                     &
                                 '"charge bal [%]"'                     
            elseif ((ph_output).and.(.not.pe_output)) then              
              write(igsm,'(8a)') 'variables = "x","y","z",',           &
                                 '"pH","ionic strength", ',            &
                                 '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                 '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                 '"NC-Alk [mg/L CaCO_3]",',            &
                                 '"Alk [mg/L CaCO_3]",',               &
                                 '"temperature",',                     &
                                 '"charge bal [%]"'
            end if
          
          end if

          if (initial_condition) then

!c  zone record for initial condition
            if (b_output_binary) then
              strbuffer = 'Master variables, initial'
              offset_igsm_temp = offset_igsm 
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsm,trim(strbuffer),offset_igsm,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsm = offset_igsm_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsm,trim(strbuffer),offset_igsm,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsm = offset_igsm_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsm,'(3(a,i5),a)')                                &
                    'zone t = "Master variables, initial", i =',       &
                    itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          elseif (.not.initial_condition) then

!c  zone record for current time step
            if (b_output_binary) then
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'Master variables, T = ',                          &
                    time_io,time_unit(:l_time_unit)
              offset_igsm_temp = offset_igsm    
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsm,trim(strbuffer),offset_igsm,         &
                             itec, jtec, ktec,                         &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsm = offset_igsm_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsm,trim(strbuffer),offset_igsm,         &
                             itec_gbl, jtec_gbl, ktec_gbl,             &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsm = offset_igsm_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsm,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
                   'zone t = "Master variables, T = ',                 &
                    time_io,time_unit(:l_time_unit),                   &
                   '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          end if       !(initial_condition)

          end if       !(ph_output or. pe_output)

!c  -------------------------
!c  oxidation-reduction rates
!c  -------------------------

          if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)            &
     &                .and.(.not.initial_condition)) then
           
!c  title and variables 
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//''              
              offset_igsi = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsi, &
                           "#!TDV102", trim(strbuffer), offset_igsi,   &
                           b_output_mpiio_single,.false.)
              
              nvarsgsi = nr+3
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
              do ir=1,nr
                tec_variables(3+ir) = namer(ir)(:l_namer(ir))
              end do
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsi, 3+nr, tec_variables(1:3+nr),          &
                           offset_igsi,b_output_mpiio_single,.false.) 
            else
              write(igsi,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsi,'(1000a)') 'variables = "x", "y", "z"',       &
                              (',"',namer(ir)(:l_namer(ir)),'"',ir=1,nr)
            end if
!c  zone record for current time step
            if (b_output_binary) then
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'hom. reaction rates , T = ',                      &
                    time_io,time_unit(:l_time_unit)
              
              offset_igsi_temp = offset_igsi  
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsi,trim(strbuffer),offset_igsi,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsi = offset_igsi_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsi,trim(strbuffer),offset_igsi,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsi = offset_igsi_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsi,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')              &
                   'zone t = "hom. reaction rates , ',                 &
                   'T = ',time_io,time_unit(:l_time_unit),             &
                   '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          end if       !((nr.gt.0)..... )

!c  ----------------------------------------
!c  rates of intra-aqueous kinetic reactions
!c  ----------------------------------------

          if (naq.gt.0.and.(.not.initial_condition)) then

!c  title and variables
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//''              
              offset_igsi = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsi, &
                           "#!TDV102", trim(strbuffer), offset_igsi,   &
                           b_output_mpiio_single,.false.)
              
              nvarsgsi = naq+3
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
              do iaq=1,naq
                tec_variables(3+iaq) = nameaq(iaq)(:l_nameaq(iaq))
              end do
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsi, 3+naq, tec_variables(1:3+naq),        &
                           offset_igsi,b_output_mpiio_single,.false.)  
            else
              write(igsi,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsi,'(1000a)') 'variables = "x", "y", "z"',       &
                                   (',"',nameaq(iaq)(:l_nameaq(iaq)),  &
                                   '"',iaq=1,naq)
            end if
!c  zone record for current time step
            if (b_output_binary) then
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'intra-aqueous reactions , T = ',                  &
                    time_io,time_unit(:l_time_unit)
              
              offset_igsi_temp = offset_igsi  
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsi, trim(strbuffer),offset_igsi,        &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsi = offset_igsi_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs + 4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsi, trim(strbuffer),offset_igsi,        &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsi = offset_igsi_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
            else
              write(igsi,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')              &
                   'zone t = "intra-aqueous reactions , ',             &
                   'T = ',time_io,time_unit(:l_time_unit),             &
                   '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            end if
          end if       !(naq.gt.0..... )

!c  --------------------------------------------------------------------- 
!c  partial gas pressures
!c  --------------------------------------------------------------------- 
 
          if (ng.gt.0) then

           
!c  title and variables
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//''              
              offset_igsg = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsg, &
                           "#!TDV102", trim(strbuffer), offset_igsg,   &
                           b_output_mpiio_single,.false.)
              
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
              do ig=1,ng
                tec_variables(3+ig) = nameg(ig)(:l_nameg(ig))  
              end do
              tec_variables(4+ng) = "p_t_o_t"
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsg, 4+ng, tec_variables(1:4+ng),          &
                           offset_igsg,b_output_mpiio_single,.false.) 
            else
              write(igsg,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsg,'(1000a)') 'variables = "x", "y", "z"',       &
                                  (',"',nameg(ig)(:l_nameg(ig)),       &
                                  '"',ig=1,ng),', "p_t_o_t"'
            end if
            
            if (gas_advection .or. dgm .or. maxwell) then
              if (b_output_binary) then
                strbuffer = 'dataset '//prefix(:l_prfx)//''
                offset_igs2 = 0
                call tecplot_binary_write_header(Petsc_Comm_World,     &
                             igs2,"#!TDV102", trim(strbuffer),         &
                             offset_igs2,b_output_mpiio_single,.false.)
                
                tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
                do ig = 1, ng
                  tec_variables(3+ig) = nameg(ig)(:l_nameg(ig))  
                end do
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                             igs2, ng+3, tec_variables(1:ng+3),        &
                             offset_igs2,b_output_mpiio_single,.false.)  
              else
                write(igs2,'(3a)') 'title = "dataset ',                &
                                    prefix(:l_prfx),'"'
                write(igs2,'(1000a)') 'variables = "x", "y", "z"',      &
                                    (',"',nameg(ig)(:l_nameg(ig)),     &
                                    '"',ig=1,ng) 
              end if
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'G_i, initial'
                offset_igsg_temp = offset_igsg 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsg,trim(strbuffer), offset_igsg,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsg = offset_igsg_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsg,trim(strbuffer), offset_igsg,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsg = offset_igsg_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsg,'(a,3(a,i5),a)')                            &
                      'zone t = "G_i, ',                               &
                      'initial", i =',itec,', j =',jtec,               &
                      ', k =',ktec,',  f=point'
              end if
              
              if (gas_advection .or. dgm .or. maxwell) then
                if (b_output_binary) then
                  strbuffer = 'G_i, initial'
                  offset_igs2_temp = offset_igs2   
                  
                  if (b_output_multizone) then
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igs2,                &
                                 trim(strbuffer),offset_igs2,          &
                                 itec,jtec,ktec,                       &
                                 b_output_mpiio_single,.false.,        &
                                 b_output_multizone)                  
                    offset_igs2 = offset_igs2_temp +                   &
                                  (11+len_trim(strbuffer))*4*nprcs + 4
                  else
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igs2,                &
                                 trim(strbuffer),offset_igs2,          &
                                 itec_gbl,jtec_gbl,ktec_gbl,           &
                                 b_output_mpiio_single,.false.,        &
                                 b_output_multizone)                  
                    offset_igs2 = offset_igs2_temp +                   &
                                  (12+len_trim(strbuffer))*4
                  end if
                else
                  write(igs2,'(a,3(a,i5),a)')                          &
                        'zone t = "G_i, ',                             &
                        'initial", i =',itec,', j =',jtec,             &
                        ', k =',ktec,',  f=point'
                end if              
              end if

            elseif (.not.initial_condition) then

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'G_i, T = ', time_io,time_unit(:l_time_unit)
                offset_igsg_temp = offset_igsg 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsg,trim(strbuffer), offset_igsg,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsg = offset_igsg_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsg,trim(strbuffer), offset_igsg,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsg = offset_igsg_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsg,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                     'zone t = "G_i, T = ',                            &
                     time_io,time_unit(:l_time_unit),'", i =',         &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
              
              if (gas_advection .or. dgm .or. maxwell) then
                if (b_output_binary) then
                  write(strbuffer,'(a,1pe15.6e3,1x,a)')                &
                        'G_i, T = ',time_io,time_unit(:l_time_unit)
                  offset_igs2_temp = offset_igs2
                  
                  if (b_output_multizone) then
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igs2,trim(strbuffer),&
                                 offset_igs2, itec,jtec,               &
                                 ktec, b_output_mpiio_single,          &
                                 .false.,b_output_multizone)                  
                    offset_igs2 = offset_igs2_temp +                   &
                                  (11+len_trim(strbuffer))*4*nprcs + 4
                  else
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igs2,trim(strbuffer),&
                                 offset_igs2, itec_gbl,jtec_gbl,       &
                                 ktec_gbl,b_output_mpiio_single,       &
                                 .false.,b_output_multizone)                  
                    offset_igs2 = offset_igs2_temp +                   &
                                  (12+len_trim(strbuffer))*4
                  end if
                else
                  write(igs2,'(a,1pe15.6e3,1x,a,3(a,i5),a)')           &
                       'zone t = "G_i, T = ',                          &
                       time_io,time_unit(:l_time_unit),'", i =',       &
                       itec,', j =',jtec,', k =',ktec,',  f=point'
                end if
              end if

            end if       !(initial_condition)

!c  --------------------------------------------------------------------- 
!c  degassing rates
!c  --------------------------------------------------------------------- 
 
            if (gas_removal) then

!c  title and variables
              if (b_output_binary) then
                strbuffer = 'dataset '//prefix(:l_prfx)//''
                offset_igsgr = 0
                call tecplot_binary_write_header(Petsc_Comm_World,     &
                             igsgr, "#!TDV102", trim(strbuffer),       &
                             offset_igsgr,b_output_mpiio_single,.false.)
                
                tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
                do ig = 1, ng
                  tec_variables(3+ig) = nameg(ig)(:l_nameg(ig)) 
                end do
                call tecplot_binary_write_variable(Petsc_Comm_World,   &
                             igsgr, 3+ng, tec_variables(1:3+ng),       &
                             offset_igsgr,b_output_mpiio_single,.false.)
              else
                write(igsgr,'(3a)') 'title = "dataset ',               &
                                    prefix(:l_prfx),'"'                 
                write(igsgr,'(1000a)') 'variables = "x", "y", "z"',    &
                                     (',"',nameg(ig)(:l_nameg(ig)),    &
                                     '"',ig=1,ng)
              end if
              if (initial_condition) then

!c  zone record for initial condition
                if (b_output_binary) then
                  strbuffer = 'R_i^g, initial'
                  offset_igsgr_temp = offset_igsgr  
                  
                  if (b_output_multizone) then
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igsgr,               &
                                 trim(strbuffer), offset_igsgr,        &
                                 itec,jtec, ktec,                      &
                                 b_output_mpiio_single,.false.,        &
                                 b_output_multizone)                  
                    offset_igsgr = offset_igsgr_temp +                 &
                                  (11+len_trim(strbuffer))*4*nprcs + 4
                  else
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igsgr,               &
                                 trim(strbuffer), offset_igsgr,        &
                                 itec_gbl,jtec_gbl, ktec_gbl,          &
                                 b_output_mpiio_single,.false.,        &
                                 b_output_multizone)                  
                    offset_igsgr = offset_igsgr_temp +                 &
                                  (12+len_trim(strbuffer))*4
                  end if
                else
                  write(igsgr,'(a,3(a,i5),a)')                         &
                        'zone t = "R_i^g, ',                           &
                        'initial", i =',itec,', j =',jtec,             &
                        ', k =',ktec,',  f=point'
                end if

              elseif (.not.initial_condition) then

!c  zone record for current time step
                if (b_output_binary) then
                  write(strbuffer,'(a,1pe15.6e3,1x,a)')                &
                        'R_i^g, T = ', time_io,time_unit(:l_time_unit)
                  offset_igsgr_temp = offset_igsgr 
                  if (b_output_multizone) then
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igsgr,               &
                                 trim(strbuffer), offset_igsgr,        &
                                 itec,jtec,ktec,                       &
                                 b_output_mpiio_single,.false.,        &
                                 b_output_multizone)                  
                    offset_igsgr = offset_igsgr_temp +                 &
                                  (11+len_trim(strbuffer))*4*nprcs + 4 
                  else
                    call tecplot_binary_write_zoneinfo(                &
                                 Petsc_Comm_World,igsgr,               &
                                 trim(strbuffer), offset_igsgr,        &
                                 itec_gbl,jtec_gbl,ktec_gbl,           &
                                 b_output_mpiio_single,.false.,        &
                                 b_output_multizone)                  
                    offset_igsgr = offset_igsgr_temp +                 &
                                  (12+len_trim(strbuffer))*4
                  end if
                else
                  write(igsgr,'(a,1pe15.6e3,1x,a,3(a,i5),a)')          &
                       'zone t = "R_i^g, T = ',                        &
                       time_io,time_unit(:l_time_unit),'", i =',       &
                       itec,', j =',jtec,', k =',ktec,',  f=point'
                end if

              end if       !(initial_condition)

            end if         !(gas_removal)

          end if           !(ng.gt.0)

!c  -----------------------------
!c  sorbed species concentrations
!c  -----------------------------

          if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.     &
              nsb_surf.gt.0.or.noncompetitive_sorption)) then

            
!c  title and variables
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//''
              offset_igsb = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsb, &
                           "#!TDV102", trim(strbuffer), offset_igsb,   &
                           b_output_mpiio_single,.false.)
               
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
              do ianc=1,nanc
                tec_variables(3+ianc) = nameanc(ianc)(:l_nameanc(ianc))  
              end do
                
              do isites=1,nsites
                tec_variables(3+nanc+isites) =                         &
                    namec(iaic(isites))(:l_namec(iaic(isites)))   
              end do
              
              do isb=1,nsb_ion
                tec_variables(3+nanc+nsites+isb) =                     &
                    namesb_ion(isb)(:l_namesb_ion(isb))  
              end do
              
              do isb=1,nsb_surf
                tec_variables(3+nanc+nsites+nsb_ion+isb) =             &
                    namesb_surf(isb)(:l_namesb_surf(isb))
              end do
              
              nvarsgsb = 3+nanc+nsites+nsb_ion+nsb_surf
              
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsb,nvarsgsb, tec_variables(1:nvarsgsb),   &
                           offset_igsb,b_output_mpiio_single,.false.) 
            else
              write(igsb,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsb,'(1000a)') 'variables = "x", "y", "z"',       &
                    (',"',nameanc(ianc)                                &
                    (:l_nameanc(ianc)),'"',                            &
                    ianc=1,nanc),                                      &
                    (',"',namec(iaic(isites))                          &
                    (:l_namec(iaic(isites))),'"',                      &
                    isites=1,nsites),                                  &
                    (',"',namesb_ion(isb)(:l_namesb_ion(isb)),         &
                    '"',isb=1,nsb_ion),                                &
                    (',"',namesb_surf(isb)(:l_namesb_surf(isb)),       &
                    '"',isb=1,nsb_surf)
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'S_i, initial'
                offset_igsb_temp = offset_igsb 
                
                if (b_output_multizone) then                    
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsb,trim(strbuffer),offset_igsb,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsb = offset_igsb_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsb,trim(strbuffer),offset_igsb,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsb = offset_igsb_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsb,'(a,3(a,i5),a)')                            &
                      'zone t = "S_i, ',                               &
                      'initial", i =',itec,', j =',jtec,               &
                      ', k =',ktec,',  f=point'
              end if
            else

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'S_i, T = ',time_io,time_unit(:l_time_unit)
                offset_igsb_temp = offset_igsb 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsb,trim(strbuffer),offset_igsb,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsb = offset_igsb_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsb,trim(strbuffer),offset_igsb,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsb = offset_igsb_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsb,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                     'zone t = "S_i, T = ',                            &
                     time_io,time_unit(:l_time_unit),'", i =',         &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            end if       !(initial_condition)

          end if

!c  --------------------------
!c  mineral saturation indices
!c  --------------------------

          if (nm.gt.0) then
            
!c  title and variables
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//'' 
              offset_igss = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igss, &
                           "#!TDV102", trim(strbuffer), offset_igss,   &
                           b_output_mpiio_single,.false.)
              
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
              do im = 1, nm
                 tec_variables(3+im) = namem(im)(:l_namem(im))  
              end do

              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igss, 3+nm, tec_variables(1:3+nm),          &
                           offset_igss,b_output_mpiio_single,.false.) 
            else
              write(igss,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igss,'(1000a)') 'variables = "x", "y", "z"',       &
                                    (',"',namem(im)(:l_namem(im)),     &
                                   '"',im=1,nm)
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'SI, initial'
                offset_igss_temp = offset_igss
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igss,trim(strbuffer), offset_igss,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igss = offset_igss_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else

                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igss,trim(strbuffer), offset_igss,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igss = offset_igss_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igss,'(a,3(a,i5),a)')                            &
                      'zone t = "SI, ',                                &
                      'initial", i =',itec,', j =',jtec,               &
                      ', k =',ktec,',  f=point'
              end if
            else

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'SI, T = ',time_io,time_unit(:l_time_unit)
                offset_igss_temp = offset_igss 
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igss,trim(strbuffer), offset_igss,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igss = offset_igss_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else

                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igss,trim(strbuffer), offset_igss,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igss = offset_igss_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igss,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                     'zone t = "SI, T = ',                             &
                     time_io,time_unit(:l_time_unit),'", i =',         &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            end if       !(initial_condition)

!c  -------------------------------
!c  dissolution-precipitation rates
!c  -------------------------------
            
!c  title and variables 
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//'' 
              offset_igsd = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsd, &
                           "#!TDV102", trim(strbuffer), offset_igsd,   &
                           b_output_mpiio_single,.false.)
            else    
              write(igsd,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            end if

            istart = iamd(1)
            istop = iamd(nm+1)-1
            nvarsgsd = 4+istop-istart
            if (b_output_binary) then
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"] 
              do ireac=istart,istop
                tec_variables(3+ireac)=namemp(ireac)(:l_namemp(ireac))
              end do
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsd, nvarsgsd, tec_variables(1:nvarsgsd),  &
                           offset_igsd,b_output_mpiio_single,.false.)  
            else
              write(igsd,'(1000a)') 'variables = "x", "y", "z"',       &
                                 (',"',namemp(ireac)(:l_namemp(ireac)),&
                                 '"',ireac=istart,istop)
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'Diss.-prec. rates, initial'
                offset_igsd_temp = offset_igsd 
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsd,trim(strbuffer),offset_igsd,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsd = offset_igsd_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsd,trim(strbuffer),offset_igsd,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsd = offset_igsd_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsd,'(a,3(a,i5),a)')                            &
                      'zone t = "Diss.-prec. rates, ',                 &
                      'initial", i =',itec,', j =',jtec,               &
                      ', k =',ktec,',  f=point'
              end if
            else

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'Diss.-prec. rates, T = ',                       &
                      time_io,time_unit(:l_time_unit)
                offset_igsd_temp = offset_igsd 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsd,trim(strbuffer),offset_igsd,       &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsd = offset_igsd_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsd,trim(strbuffer),offset_igsd,       &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsd = offset_igsd_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsd,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')            &
                    'zone t = "Diss.-prec. rates, ',                   &
                    'T = ',time_io,time_unit(:l_time_unit),            &
                    '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            end if       !(initial_condition)
 
!c  ----------------------------
!c  volume fractions of minerals
!c  ----------------------------
            
!c  title and variables 
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//'' 
              offset_igsv = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsv, &
                           "#!TDV102", trim(strbuffer), offset_igsv,   &
                           b_output_mpiio_single,.false.)
            else
              write(igsv,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            end if
            
            if (b_output_binary) then
              if (update_porosity .and. update_permeability) then  
                nvarsgsv = 7 + nm
              else
                nvarsgsv = 4 + nm  
              end if
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
              do im = 1, nm
                tec_variables(3+im) = namem(im)(:l_namem(im))
              end do
              tec_variables(4+nm) = "porosity"
              
              if (update_porosity .and. update_permeability) then 
                tec_variables(5+nm) = "hydraulic conductivity kx"
                tec_variables(6+nm) = "hydraulic conductivity ky"
                tec_variables(7+nm) = "hydraulic conductivity kz"
              end if
              
              call tecplot_binary_write_variable(Petsc_Comm_World,igsv,&
                           nvarsgsv, tec_variables(1:nvarsgsv),        &
                           offset_igsv,b_output_mpiio_single,.false.)
            else            
              if (update_porosity .and. update_permeability) then
                write(igsv,'(1000a)') 'variables = "x", "y", "z"',     &
                                  (',"',namem(im)(:l_namem(im)),       &
                                  '"',im=1,nm),',"porosity"',          &
                                   ',"hydraulic conductivity kx"',     &
                                   ',"hydraulic conductivity ky"',     & !MX
                                   ',"hydraulic conductivity kz"'
              else
                write(igsv,'(1000a)') 'variables = "x", "y", "z"',     &
                                 (',"',namem(im)(:l_namem(im)),        &
                                 '"',im=1,nm),',"porosity"'
              end if            
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'phi_i, initial'
                offset_igsv_temp = offset_igsv 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsv,trim(strbuffer), offset_igsv,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsv = offset_igsv_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsv,trim(strbuffer), offset_igsv,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsv = offset_igsv_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsv,'(a,3(a,i5),a)')                            &
                      'zone t = "phi_i, ',                             &
                      'initial", i =',itec,', j =',jtec,               &
                      ', k =',ktec,',  f=point'
              end if
            else

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'phi_i, T = ',time_io,time_unit(:l_time_unit)
                offset_igsv_temp = offset_igsv  
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsv,trim(strbuffer), offset_igsv,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsv = offset_igsv_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4 
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsv,trim(strbuffer), offset_igsv,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsv = offset_igsv_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsv,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                    'zone t = "phi_i, T = ',                           &
                    time_io,time_unit(:l_time_unit),                   &
                    '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            end if       !(initial_condition)

          end if         !(nm.gt.0)

          if (nmx.gt.0) then

!c  --------------------------------------
!c  saturation indices - excluded minerals
!c  --------------------------------------

            
!c  title and variables 
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//'' 
              offset_igsx = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsx, &
                           "#!TDV102", trim(strbuffer), offset_igsx,   &
                           b_output_mpiio_single,.false.)
              
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
              do imx=1,nmx
                tec_variables(3+imx) = namemx(imx)(:l_namemx(imx))
              end do
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsx,3+nmx, tec_variables(1:3+nmx),         &
                           offset_igsx,b_output_mpiio_single,.false.)
            else
              write(igsx,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsx,'(1000a)') 'variables = "x", "y", "z"',       &
                                   (',"',namemx(imx)(:l_namemx(imx)),  &
                                    '"',imx=1,nmx)
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'SI, initial'
                offset_igsx_temp = offset_igsx 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsx,trim(strbuffer), offset_igsx,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsx = offset_igsx_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsx,trim(strbuffer), offset_igsx,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsx = offset_igsx_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsx,'(a,3(a,i5),a)')                            &
                      'zone t = "SI, ','initial", i =',                &
                      itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            else

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'SI, T = ',time_io,time_unit(:l_time_unit)                
                offset_igsx_temp = offset_igsx   
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsx,trim(strbuffer), offset_igsx,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsx = offset_igsx_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsx,trim(strbuffer), offset_igsx,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsx = offset_igsx_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsx,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')            &
                    'zone t = "SI, ',                                  &
                    'T = ',time_io,time_unit(:l_time_unit),            &
                    '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
              end if
            end if       !(initial_condition)

          end if         !(nmx.gt.0)
          
!c  --------------------------------------
!c  isotope data
!c  --------------------------------------
!c  title and variables
          if (iso_output) then
    
            i1 = 0
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1
                nametemp(i1) = namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
              end do
              i1 = i1 +1
              ic2 = jamdisoo(istart)
              nametemp(i1) = 'sum_'//namec(ic2)
              l_nametemp(i1) = index(nametemp(i1),' ')-1
               
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart+1, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1 
                nametemp(i1) = 'delta_'//namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
              end do
            end do
            
            nvarsgsis = i1 + 3
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx) 
              offset_igsis = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsis,&
                           "#!TDV102", trim(strbuffer), offset_igsis,  &
                           b_output_mpiio_single,.false.)
              
              tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
              do imi = 1, i1
                tec_variables(3+imi) = nametemp(imi)(:l_nametemp(imi))
              end do
              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsis,nvarsgsis,tec_variables(1:nvarsgsis), &
                           offset_igsis,b_output_mpiio_single,.false.)
            else 
              write(igsis,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(igsis,'(1000a)') 'variables = "x", "y", "z"' ,       &
                    (',"',nametemp(imi)(:l_nametemp(imi)),'"', imi=1,i1)
            end if

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'isotope data, initial'
                offset_igsis_temp = offset_igsis
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsis,trim(strbuffer),offset_igsis,     &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)
                  offset_igsis = offset_igsis_temp +                   &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsis,trim(strbuffer),offset_igsis,     &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)
                  offset_igsis = offset_igsis_temp +                   &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsis,'(a,3(a,i5),a)')                           &
                      'zone t = "isotope data, ','initial", i =',      &
                      itec,', j =',jtec,', k =',ktec,',  f=point'
              end if

            else

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'isotope data, T = ', time_io,time_unit 
                offset_igsis_temp = offset_igsis  
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsis,trim(strbuffer),offset_igsis,     &
                               itec, jtec, ktec,                       &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)
                  offset_igsis = offset_igsis_temp +                   &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsis,trim(strbuffer),offset_igsis,     &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)
                  offset_igsis = offset_igsis_temp +                   &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsis,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')           &
                    'zone t = "isotope data, ',                        &
                    'T = ',time_io,time_unit(:l_time_unit),            &
                    '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
              end if

            end if       !(initial_condition)

          end if         !(iso_output)
          
!c  ---------------------------------------------------------------------  
!c  water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------  

          if (chemical_water) then
              
!c  title and variables 
            if (b_output_binary) then
              strbuffer = 'dataset '//prefix(:l_prfx)//'' 
              offset_igsw = 0
              call tecplot_binary_write_header(Petsc_Comm_World, igsw, &
                           "#!TDV102", trim(strbuffer), offset_igsw,   &
                           b_output_mpiio_single,.false.)
              
              tec_variables(1:4) = [character(len=72):: "x", "y", "z", &
                                    "water prod/cons"]

              call tecplot_binary_write_variable(Petsc_Comm_World,     &
                           igsw,4, tec_variables(1:4),                 &
                           offset_igsw,b_output_mpiio_single,.false.)
            else
              write(igsw,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"' 
              write(igsw,'(1000a)') 'variables = "x", "y", "z"',       &
     &                             ',"water prod/cons"'
            end if
            

            if (initial_condition) then

!c  zone record for initial condition
              if (b_output_binary) then
                strbuffer = 'G_I, initial'
                offset_igsw_temp = offset_igsw 
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsw,trim(strbuffer), offset_igsw,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsw = offset_igsw_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsw,trim(strbuffer), offset_igsw,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsw = offset_igsw_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsw,'(a,3(a,i5),a)')                            &
                      'zone t = "G_i, ',                               &
                      'initial", i =',itec,', j =',jtec,               &
                      ', k =',ktec,',  f=point'              
              end if              
                 
            elseif (.not.initial_condition) then

!c  zone record for current time step
              if (b_output_binary) then
                write(strbuffer,'(a,1pe15.6e3,1x,a)')                  &
                      'G_I, T = ',time_io,time_unit(:l_time_unit)                
                offset_igsw_temp = offset_igsw   
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsw,trim(strbuffer), offset_igsw,      &
                               itec,jtec,ktec,                         &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsw = offset_igsw_temp +                     &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(Petsc_Comm_World, &
                               igsw,trim(strbuffer), offset_igsw,      &
                               itec_gbl,jtec_gbl,ktec_gbl,             &
                               b_output_mpiio_single,.false.,          &
                               b_output_multizone)                
                  offset_igsw = offset_igsw_temp +                     &
                                (12+len_trim(strbuffer))*4
                end if
              else
                write(igsw,'(a,1pe15.6e3,1x,a,3(a,i5),a)')             &
                     'zone t = "G_i, T = ',                            &
                     time_io,time_unit(:l_time_unit),'", i =',         &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
              end if

            end if       !(initial_condition)
        
          endif

!c  -----------------------------------------------
!c  output for xmgr
!c  -----------------------------------------------

        else             !(tec_header)

!c  -----------------------------------------------
!c  free species and aqueous complex concentrations
!c  -----------------------------------------------

!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(igsc, "#")
          end if
          
!c  title and variables
          write(igsc,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          write(igsc,'(1000a)') '# variables = "x", "y", "z"',        &
     &                        (',"',namec(ic)(:l_namec(ic)),          &
     &                        '"',ic=1,nc-1),                         &
     &                        (',"',namex(ix)(:l_namex(ix)),          &
     &                        '"',ix=1,nxout)

          if (initial_condition) then

!c  zone record for initial condition

            write(igsc,'(a,3(a,i5),a)')                               &
     &            '# zone t = "C_j, X_i, ',                           &
     &            'initial", i =',itec,', j =',jtec,                  &
     &            ', k =',ktec,',  f=point'

          elseif (.not.initial_condition) then

!c  zone record for current time step

            write(igsc,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
     &           '# zone t = "C_j, X_i, T = ',                        &
     &           time_io,time_unit(:l_time_unit),                     &
     &           '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

          end if       !(initial_condition)
          
          if (b_output_activity) then
!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(igsac, "#")
            end if
          
!c  title and variables
            write(igsac,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsac,'(1000a)') '# variables = "x", "y", "z"',      &
     &                          (',"',namec(ic)(:l_namec(ic)),         &
     &                          '"',ic=1,nc-1),                        &
     &                          (',"',namex(ix)(:l_namex(ix)),         &
     &                          '"',ix=1,nxout)
            
            if (initial_condition) then

!c  zone record for initial condition
            
              write(igsac,'(a,3(a,i5),a)')                             &
     &              '# zone t = "C_j, X_i, ',                          &
     &              'initial", i =',itec,', j =',jtec,                 &
     &              ', k =',ktec,',  f=point'
            
            elseif (.not.initial_condition) then

!c  zone record for current time step

              write(igsac,'(a,1pe15.6e3,1x,a,3(a,i5),a)')              &
     &             '# zone t = "C_j, X_i, T = ',                       &
     &             time_io,time_unit(:l_time_unit),                    &
     &             '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'
            
            end if       !(initial_condition)
          end if       !(activity coefficients)
 
!c  ----------------
!c  master variables
!c  ----------------
          if (ph_output .or. pe_output) then
        
!c  title and variables
          write(igsm,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
          if ((ph_output).and.(pe_output)) then
            write(igsm,'(8a)') '# variables = "x","y","z",',          &
     &                         '"pH","pe","Eh","ionic strength", ',   &
     &                         '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
     &                         '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
     &                         '"NC-Alk [mg/L CaCO_3]",',             &
     &                         '"Alk [mg/L CaCO_3]",',                &
     &                         '"temperature",',                      &
     &                         '"charge bal [%]"'                      
          elseif ((.not.ph_output).and.(pe_output)) then               
            write(igsm,'(8a)') '# variables = "x","y","z",',          &
     &                         '"pe","Eh","ionic strength", ',        &
     &                         '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
     &                         '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
     &                         '"NC-Alk [mg/L CaCO_3]",',             &
     &                         '"Alk [mg/L CaCO_3]",',                &
     &                         '"temperature",',                      &
     &                         '"charge bal [%]"'                      
          elseif ((ph_output).and.(.not.pe_output)) then               
            write(igsm,'(8a)') '# variables = "x","y","z",',          &
     &                         '"pH","ionic strength", ',             &
     &                         '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
     &                         '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
     &                         '"NC-Alk [mg/L CaCO_3]",',             &
     &                         '"Alk [mg/L CaCO_3]",',                &
     &                         '"temperature",',                      &
     &                         '"charge bal [%]"'
          end if

          if (initial_condition) then

!c  zone record for initial condition

            write(igsm,'(a,3(a,i5),a)')                               &
     &            '# zone t = "Master variables, ',                   &
     &            'initial", i =',itec,', j =',jtec,                  &
     &            ', k =',ktec,',  f=point'

          elseif (.not.initial_condition) then

!c  zone record for current time step

            write(igsm,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
     &           '# zone t = "Master variables, T = ',                &
     &            time_io,time_unit(:l_time_unit),                    &
     &           '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

          end if       !(initial_condition)

          end if       !(ph_output .or. pe_output)

!c  -------------------------
!c  oxidation-reduction rates
!c  -------------------------

          if ((nr.gt.0).and.(.not.redox_equil)                        &
     &                 .and.(.not.initial_condition)) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(igsi, "#")
            end if
            
!c  title and variables        
            write(igsi,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsi,'(1000a)') '# variables = "x", "y", "z"',      &
     &                        (',"',namer(ir)(:l_namer(ir)),'"',ir=1,nr)

!c  zone record for current time step

            write(igsi,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')               &
     &           '# zone t = "hom. reaction rates, ',                 &
     &           'T = ',time_io,time_unit(:l_time_unit),              &
     &           '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

          end if       !((nr.gt.0)..... )

!c  ----------------------------------------
!c  rates of intra-aqueous kinetic reactions
!c  ----------------------------------------

          if (naq.gt.0.and.(.not.initial_condition)) then

!c  version information
            if (b_writeversion_tecplot ) then
                call writeversion2file(igsi, "#")
            end if
            
!c  title and variables        
            write(igsi,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsi,'(1000a)') '# variables = "x", "y", "z"',      &
     &                          (',"',nameaq(iaq)(:l_nameaq(iaq)),    &
     &                           '"',iaq=1,naq)

!c  zone record for current time step

            write(igsi,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')               &
     &           '# zone t = "intra-aqueous reactions, ',             &
     &           'T = ',time_io,time_unit(:l_time_unit),              &
     &           '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

          end if       !((naq.gt.0)..... )

!c  --------------------------------------------------------------------- 
!c  partial gas pressures
!c  --------------------------------------------------------------------- 
 
          if (ng.gt.0) then

!c  title and variables            
            write(igsg,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsg,'(1000a)') '# variables = "x", "y", "z"',      &
     &                          (',"',nameg(ig)(:l_nameg(ig)),        &
     &                           '"',ig=1,ng),', "p_t_o_t"'

            if (initial_condition) then

!c  zone record for initial condition

              write(igsg,'(a,3(a,i5),a)')                             &
     &              '# zone t = "G_i, ',                              &
     &              'initial", i =',itec,', j =',jtec,                &
     &              ', k =',ktec,',  f=point'

            elseif (.not.initial_condition) then

!c  zone record for current time step

              write(igsg,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')             &
     &             '# zone t = "G_i, ',                               &
     &             'T = ', time_io,time_unit(:l_time_unit),           &
     &             '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)

!c  --------------------------------------------------------------------- 
!c  degassing rates
!c  --------------------------------------------------------------------- 
 
            if (gas_removal) then

!c  title and variables
              write(igsgr,'(3a)') '# title = "dataset ',              &
     &                            prefix(:l_prfx),'"'                  
              write(igsgr,'(1000a)') '# variables = "x", "y", "z"',   &
     &                             (',"',nameg(ig)(:l_nameg(ig)),     &
     &                              '"',ig=1,ng)

              if (initial_condition) then

!c  zone record for initial condition

                write(igsgr,'(a,3(a,i5),a)')                          &
     &                '# zone t = "R_i^g, ',                          &
     &                'initial", i =',itec,', j =',jtec,              &
     &                ', k =',ktec,',  f=point'

              elseif (.not.initial_condition) then

!c  zone record for current time step

                write(igsgr,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')          &
     &               '# zone t = "R_i^g, ',                           &
     &               'T = ', time_io,time_unit(:l_time_unit),         &
     &               '", i =',itec,', j =',jtec,', k =',ktec,         &
     &               ',  f=point'

              end if     !(initial_condition)

            end if       !(gas_removal)

          end if         !(ng.gt.0)

!c  -----------------------------
!c  sorbed species concentrations
!c  -----------------------------

          if (.not.combined_gst_gsb_output .and.                       &
             (nsb_ion.gt.0.or.nsb_surf.gt.0)) then

!c  title and variables
            write(igsb,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsb,'(1000a)') '# variables = "x", "y", "z"',           &
                             (',"',nameanc(ianc)                           &
                             (:l_nameanc(ianc)),'"',                       &
                             ianc=1,nanc),                                 &
                             (',"',namec(iaic(isites))                     &
                             (:l_namec(iaic(isites))),                     &
                             '"',isites=1,nsites),                         &
                             (',"',namesb_ion(isb)(:l_namesb_ion(isb)),    &
                             '"',isb=1,nsb_ion),                           &
                             (',"',namesb_surf(isb)(:l_namesb_surf(isb)),  &
                             '"',isb=1,nsb_surf)

            if (initial_condition) then

!c  zone record for initial condition

              write(igsb,'(a,3(a,i5),a)')                             &
     &              '# zone t = "S_i, ',                              &
     &              'initial", i =',itec,', j =',jtec,                &
     &              ', k =',ktec,',  f=point'
                                                                       
            else
                                                                      
!c  zone record for current time step
                                                                       
              write(igsb,'(a,1pe15.6e3,1x,a,3(a,i5),a)')              &
     &             '# zone t = "S_i, T = ',                           &
     &             time_io,time_unit(:l_time_unit),                   &
     &             '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)

          end if

!c  --------------------------
!c  mineral saturation indices
!c  --------------------------

          if (nm.gt.0) then
           
!c  title and variables
            write(igss,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igss,'(1000a)') '# variables = "x", "y", "z"',      &
     &                            (',"',namem(im)(:l_namem(im)),      &
     &                            '"',im=1,nm)
                                                                       
            if (initial_condition) then
                                                                      
!c  zone record for initial condition
                                                                       
              write(igss,'(a,3(a,i5),a)')                             &
     &              '# zone t = "SI, ',                               &
     &              'initial", i =',itec,', j =',jtec,                &
     &              ', k =',ktec,',  f=point'
                                                                       
            else
                                                                      
!c  zone record for current time step
                                                                       
              write(igss,'(a,1pe15.6e3,1x,a,3(a,i5),a)')              &
     &             '# zone t = "SI, T = ',                            &
     &             time_io,time_unit(:l_time_unit),                   &
     &             '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)

!c  -------------------------------
!c  dissolution-precipitation rates
!c  -------------------------------
            
!c  title and variables            
            write(igsd,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'

            istart = iamd(1)
            istop = iamd(nm+1)-1
            write(igsd,'(1000a)') '# variables = "x", "y", "z"',      &
     &                         (',"',namemp(ireac)(:l_namemp(ireac)), &
     &                         '"',ireac=istart,istop)

            if (initial_condition) then

!c  zone record for initial condition

              write(igsd,'(a,3(a,i5),a)')                             &
     &              '# zone t = "Diss.-prec. rates, ',                &
     &              'initial", i =',itec,', j =',jtec,                &
     &              ', k =',ktec,',  f=point'

            else

!c  zone record for current time step

              write(igsd,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')             &
     &             '# zone t = "Diss.-prec. rates, ',                 &
     &             'T = ',time_io,time_unit(:l_time_unit),            &
     &             '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)
 
!c  ----------------------------
!c  volume fractions of minerals
!c  ----------------------------
            
!c  title and variables        
            write(igsv,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsv,'(1000a)') '# variables = "x", "y", "z"',      &
     &                          (',"',namem(im)(:l_namem(im)),        &
     &                          '"',im=1,nm),',"porosity"'
                                                                       
            if (initial_condition) then
                                                                      
!c  zone record for initial condition
                                                                       
              write(igsv,'(a,3(a,i5),a)')                             &
     &              '# zone t = "phi_i, ',                            &
     &              'condition", i =',itec,', j =',jtec,              &
     &              ', k =',ktec,',  f=point'                          
            else
                                                                     
!c  zone record for current time step
                                                                       
              write(igsv,'(a,1pe15.6e3,1x,a,3(a,i5),a)')              &
     &             '# zone t = "phi_i, T = ',                         &
     &             time_io,time_unit(:l_time_unit),                   &
     &             '", i =',itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)

          end if         !(nm.gt.0)

          if (nmx.gt.0) then

!c  --------------------------------------
!c  saturation indices (excluded minerals)
!c  --------------------------------------

           
!c  title and variables        
            write(igsx,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsx,'(1000a)') '# variables = "x", "y", "z"',      &
     &                            (',"',namemx(imx)(:l_namemx(imx)),  &
     &                            '"',imx=1,nmx)
                                                                       
            if (initial_condition) then
                                                                      
!c  zone record for initial condition
                                                                       
              write(igsx,'(a,3(a,i5),a)')                             &
     &              '# zone t = "SI ',                                &
     &              'initial", i =',                                  &
     &              itec,', j =',jtec,', k =',ktec,',  f=point'
                                                                       
            else
                                                                      
!c  zone record for current time step
                                                                       
              write(igsx,'(2a,1pe15.6e3,1x,a,3(a,i5),a)')             &
     &             '# zone t = "SI ','T = ',                          &
     &             time_io,time_unit(:l_time_unit),                   &
     &             '" i =',itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)

          end if         !(nmx.gt.0)
          
!c  ---------------------------------------------------------------------  
!c  water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------  

          if (chemical_water) then
              
            write(igsw,'(3a)')                                         &
                  '# title = "dataset ',prefix(:l_prfx),'"'
            write(igsw,'(1000a)')                                       &
                  '# variables = "x", "y", "z","water prod/cons"'

            if (initial_condition) then

!c  zone record for initial condition

              write(igsw,'(a,3(a,i5),a)')                              &
     &              '# zone t = "G_i, ',                               &
     &              'initial", i =',itec,', j =',jtec,                 &
     &              ', k =',ktec,',  f=point'
                 
            elseif (.not.initial_condition) then

!c  zone record for current time step

              write(igsw,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
     &             '# zone t = "G_i, T = ',                            &
     &             time_io,time_unit(:l_time_unit),'", i =',           &
     &             itec,', j =',jtec,', k =',ktec,',  f=point'

            end if       !(initial_condition)
        
          endif

        end if           !(tec_header)

!c  --------------------------------------------------------------------- 
!c  output - water phase
!c  --------------------------------------------------------------------- 
        if (b_output_binary .and. extended_output_gs) then          
          offset_igsc_temp = offset_igsc          
          call tecplot_binary_write_section(Petsc_Comm_World,igsc,     &
                       nvarsgsc,nn_offset,offset_igsc,                 &
                       b_output_mpiio_single,.false.,b_output_multizone) 

          allocate(realbuffer(nn*nvarsgsc), stat = ierr)
          call checkerr(ierr,'outputrt-realbuffer',ilog)
          realbuffer = 0.0d0
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
          
          !c activity coefficients
          if (b_output_activity) then
            offset_igsac_temp = offset_igsac          
            call tecplot_binary_write_section(Petsc_Comm_World,igsac,  &
                         nvarsgsac,nn_offset,offset_igsac,             &
                         b_output_mpiio_single,.false.,b_output_multizone) 
            
            allocate(realbuffer14(nn*nvarsgsac), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer14',ilog)
            realbuffer14 = 0.0d0
            call memory_monitor(sizeof(realbuffer14),'realbuffer14',.true.)
          end if
          
          if (ph_output .or. pe_output) then
            offset_igsm_temp = offset_igsm          
            call tecplot_binary_write_section(Petsc_Comm_World,igsm,   &
                         nvarsgsm,nn_offset,offset_igsm,               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer2(nn*nvarsgsm), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer2',ilog)
            realbuffer2 = 0.0d0
            call memory_monitor(sizeof(realbuffer2),'realbuffer2',.true.)
          end if
          
          if ((naq.eq.0 .and. nr.gt.0 .and. .not. redox_equil .and.    &
              .not. initial_condition) .or. (naq.gt.0 .and. .not.      &
              initial_condition)) then
            offset_igsi_temp = offset_igsi          
            call tecplot_binary_write_section(Petsc_Comm_World,igsi,   &
                         nvarsgsi,nn_offset,offset_igsi,               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer3(nn*nvarsgsi), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer3',ilog)
            realbuffer3 = 0.0d0
            call memory_monitor(sizeof(realbuffer3),'realbuffer3',.true.)
          end if
              
          if (ng.gt.0) then  
            offset_igsg_temp = offset_igsg          
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igsg,4+ng,nn_offset,offset_igsg,              &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            allocate(realbuffer4(nn*(4+ng)), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer4',ilog)
            realbuffer4 = 0.0d0
            call memory_monitor(sizeof(realbuffer4),'realbuffer4',.true.)
          end if
          
          if (gas_advection .or. dgm .or. maxwell) then
            offset_igs2_temp = offset_igs2          
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igs2,3+ng,nn_offset,offset_igs2,              &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            allocate(realbuffer5(nn*(3+ng)), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer5',ilog)
            realbuffer5 = 0.0d0
            call memory_monitor(sizeof(realbuffer5),'realbuffer5',.true.)
          end if
          
          if (gas_removal) then
            offset_igsgr_temp = offset_igsgr          
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igsgr,3+ng,nn_offset,offset_igsgr,            &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer6(nn*(3+ng)), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer6',ilog)
            realbuffer6 = 0.0d0
            call memory_monitor(sizeof(realbuffer6),'realbuffer6',.true.)
          end if
          
          if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0 .or.    &
              nsb_surf.gt.0 .or. noncompetitive_sorption)) then
            offset_igsb_temp = offset_igsb          
            call tecplot_binary_write_section(Petsc_Comm_World,igsb,   &
                         nvarsgsb,nn_offset,offset_igsb,               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer7(nn*nvarsgsb), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer7',ilog)
            realbuffer7 = 0.0d0
            call memory_monitor(sizeof(realbuffer7),'realbuffer7',.true.)
          end if
              
          if (nm.gt.0) then
            offset_igss_temp = offset_igss

            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igss,3+nm,nn_offset,offset_igss,              &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone)
            allocate(realbuffer8(nn*(3+nm)), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer8',ilog)
            realbuffer8 = 0.0d0
            call memory_monitor(sizeof(realbuffer8),'realbuffer8',.true.)
            
            offset_igsd_temp = offset_igsd          
            call tecplot_binary_write_section(Petsc_Comm_World,igsd,   &
                         nvarsgsd,nn_offset,offset_igsd,               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer9(nn*nvarsgsd), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer9',ilog)
            realbuffer9 = 0.0d0
            call memory_monitor(sizeof(realbuffer9),'realbuffer9',.true.)
            
            offset_igsv_temp = offset_igsv          
            call tecplot_binary_write_section(Petsc_Comm_World,igsv,   &
                         nvarsgsv,nn_offset,offset_igsv,               &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer10(nn*nvarsgsv), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer10',ilog)
            realbuffer10 = 0.0d0
            call memory_monitor(sizeof(realbuffer10),'realbuffer10',.true.)
          end if
          
          if (nmx .gt. 0) then
            offset_igsx_temp = offset_igsx          
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igsx,3+nmx,nn_offset,offset_igsx,             &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer11(nn*(3+nmx)), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer11',ilog)
            realbuffer11 = 0.0d0
            call memory_monitor(sizeof(realbuffer11),'realbuffer11',.true.)
          end if
          
          if (iso_output) then
            offset_igsis_temp = offset_igsis          
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igsis,nvarsgsis,nn_offset,offset_igsis,       &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer12(nn*nvarsgsis), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer12',ilog)
            realbuffer12 = 0.0d0
            call memory_monitor(sizeof(realbuffer12),'realbuffer12',.true.)
          end if
          
          if (chemical_water) then
            offset_igsw_temp = offset_igsw          
            call tecplot_binary_write_section(Petsc_Comm_World,        &
                         igsw,4,nn_offset,offset_igsw,                 &
                         b_output_mpiio_single,.false.,                &
                         b_output_multizone) 
            allocate(realbuffer13(nn*4), stat = ierr)
            call checkerr(ierr,'outputrt-realbuffer13',ilog)
            realbuffer13 = 0.0d0
            call memory_monitor(sizeof(realbuffer13),'realbuffer13',.true.)
          end if
              
        end if
        
        ivol_l = 0
        
        do ivol = 1, nngl
            
!c  skip ghost nodes
#ifdef PETSC
          if(node_idx_lg2l(ivol) < 0) then
            cycle  
          end if
#endif

#ifdef OPENMP
          tid = omp_get_thread_num() + 1
#else
          tid = 1
#endif

          ivol_l = ivol_l + 1

          izn_c = mpropc(ivol)

!c  temperature corrections for debye-huckel, equilibrium and
!c  rate constants

          if (temp_corr.or.heat_transport) then
            call tcorr(tkel(ivol),ivol,tid)
          end if

!c  assign depth coordinate in terms of depth or elevation

          zout = zoutput(depth_output,zg(ivol),elevmax)
 
!c  update secondary variables before output
 
          call updtsvap(cnew(1,ivol),cx(1,ivol),gamma(1,ivol),        &
     &                  gamma(nc+1,ivol),sionnew(ivol),tid)
          
          if (hmulti_diff) then
          
            call updtsvap(c(1,ivol),cxold(1,ivol),gammaold(1,ivol),   &
     &                    gammaold(nc+1,ivol),sionold(ivol),tid)  
          end if       !MX test
     
!c  free species and aqueous complex concentrations
          if (extended_output_gs) then
            if (b_output_binary) then
              realbuffer((ivol_l-1)*nvarsgsc+1:(ivol_l-1)*nvarsgsc+3)&
                         = (/xg(ivol),yg(ivol),zout/)
              do ic=1, nc-1
                realbuffer((ivol_l-1)*nvarsgsc+3+ic) = cnew(ic,ivol)  
              end do
              
              do ix=1, nxout
                realbuffer((ivol_l-1)*nvarsgsc+2+nc+ix) = cx(ix,ivol)   
              end do
            else
              write(igsc,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                                          (cnew(ic,ivol),ic=1,nc-1),   &
                                          (cx(ix,ivol),ix=1,nxout)
            end if
            
            !c activity coefficients
            if (b_output_activity) then
              if (b_output_binary) then
                realbuffer14((ivol_l-1)*nvarsgsac+1:(ivol_l-1)*nvarsgsac+3)  &
                           = (/xg(ivol),yg(ivol),zout/)
                do ic=1, nc-1
                  realbuffer14((ivol_l-1)*nvarsgsac+3+ic) = gamma(ic,ivol)  
                end do
                
                do ix=1, nxout
                  realbuffer14((ivol_l-1)*nvarsgsac+2+nc+ix) = gamma(ix+nc,ivol)   
                end do
              else
                write(igsac,ascii_fmt) xg(ivol),yg(ivol),zout,               &
                                            (gamma(ic,ivol),ic=1,nc-1),      &
                                            (gamma(ix+nc,ivol),ix=1,nxout)
              end if
            end if
          end if

!c  master variables
          ! Compute charge balance
          call cbalance(cnew(:,ivol),cx(:,ivol),zbal,zpos,zneg) 

          call phpe(cnew(1,ivol),gamma(1,ivol),ph,pe,eh,tkel(ivol))

          if (compute_alkalinity) then
            call alkcalc(alk_carb,alk_noncarb,alk_tot,                &
     &                   alk_carb_mg,alk_noncarb_mg,alk_tot_mg,       &
     &                   alkfacc,alkfacx,cnew(1,ivol),cx(1,ivol),     &
     &                   iax,jax,nc,nx,namec,namex)                    
          else                                        !MX              
             alk_carb = r0                                             
             alk_noncarb = r0                                          
             alk_tot = r0                                              
             alk_carb_mg = r0                                          
             alk_noncarb_mg = r0                                       
             alk_tot_mg = r0                                           
          end if
          
              
          if ((ph_output).and.(pe_output)) then 
            if (b_output_binary) then
              realbuffer2((ivol_l-1)*nvarsgsm+1:ivol_l*nvarsgsm) = (/  &
                                   xg(ivol),yg(ivol),zout,ph,pe,eh,    &
                                   sionnew(ivol),alk_carb,alk_noncarb, &
                                   alk_tot,alk_carb_mg,alk_noncarb_mg, &
                                   alk_tot_mg,tkel(ivol)-tconv,zbal/)  
            else
              write(igsm,ascii_fmt)                                    &
                                   xg(ivol),yg(ivol),zout,ph,pe,eh,    &
                                   sionnew(ivol),alk_carb,alk_noncarb, &
                                   alk_tot,alk_carb_mg,alk_noncarb_mg, &
                                   alk_tot_mg,tkel(ivol)-tconv,zbal 
            end if
          elseif ((.not.ph_output).and.(pe_output)) then
            if (b_output_binary) then
              realbuffer2((ivol_l-1)*nvarsgsm+1:ivol_l*nvarsgsm) = (/  & 
                                   xg(ivol),yg(ivol),zout,pe,eh,       &
                                   sionnew(ivol),alk_carb,alk_noncarb, &
                                   alk_tot,alk_carb_mg,alk_noncarb_mg, &
                                   alk_tot_mg,tkel(ivol)-tconv,zbal/)
            else
              write(igsm,ascii_fmt)                                    &
                                   xg(ivol),yg(ivol),zout,pe,eh,       &
                                   sionnew(ivol),alk_carb,alk_noncarb, &
                                   alk_tot,alk_carb_mg,alk_noncarb_mg, &
                                   alk_tot_mg,tkel(ivol)-tconv,zbal
            end if
          elseif ((ph_output).and.(.not.pe_output)) then
            if (b_output_binary) then  
              realbuffer2((ivol_l-1)*nvarsgsm+1:ivol_l*nvarsgsm) = (/  &
                                   xg(ivol),yg(ivol),zout,ph,          &
                                   sionnew(ivol),alk_carb,alk_noncarb, &
                                   alk_tot,alk_carb_mg,alk_noncarb_mg, &
                                   alk_tot_mg,tkel(ivol)-tconv,zbal/)
            else
              write(igsm,ascii_fmt) xg(ivol),yg(ivol),zout,ph,         &
                                   sionnew(ivol),alk_carb,alk_noncarb, &
                                   alk_tot,alk_carb_mg,alk_noncarb_mg, &
                                   alk_tot_mg,tkel(ivol)-tconv,zbal
            end if
          end if

!c  oxidation-reduction rates

          if (nr.gt.0.and.(.not.redox_equil)                          &
     &               .and.(.not.initial_condition)) then

!c  recompute oxidation-reduction rates

            do ir = 1,nr
              call rateredx(cnew(1,ivol),cx(1,ivol),gamma(1,ivol),    &
     &                      gamma(nc+1,ivol),rateor(ir,tid),          &
     &                      totcnew(1,ivol),ir,tid)                        
            end do

              if (b_output_binary) then
                realbuffer3((ivol_l-1)*nvarsgsi+1:(ivol_l-1)*nvarsgsi+3)&
                           = (/xg(ivol),yg(ivol),zout/)
                do ir = 1, nr
                  realbuffer3((ivol_l-1)*nvarsgsi+3+ir) = rateor(ir,tid) 
                end do
              else
                write(igsi,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                                          (rateor(ir,tid),ir = 1,nr)
              end if
                                                                       
          end if               !((nr.gt.0).....)
                                                                      
!c  intra-aqueous kinetic reactions
                                                                       
          if (naq.gt.0.and.(.not.initial_condition)) then
                                                                      
!c  recompute rates of intra-aqueous kinetic reactions
                                                                       
            do iaq = 1,naq
              if (new_database) then                                   
                call rateint_new(rateaq(iaq,tid),totcnew(1,ivol),     &
                                 cnew(1,ivol),cx(1,ivol),             &
                                 gamma(1,ivol),gamma(nc+1,ivol),      &
                                 phi(1,ivol),iaq,                     &
                                 scalfac_aq_ivol(iaq,ivol),           &
                                 sanew(ivol),pornew(ivol),tid)
              else                                                     
                call rateint(rateaq(iaq,tid),totcnew(1,ivol),         &
                             cnew(1,ivol),gamma(1,ivol),phi(1,ivol),  &
                             iaq,scalfac_aq_ivol(iaq,ivol),tid)
              end if
            end do

            if (b_output_binary) then
              realbuffer3((ivol_l-1)*nvarsgsi+1:(ivol_l-1)*nvarsgsi+3)&
                         = (/xg(ivol),yg(ivol),zout/)
              do iaq = 1,naq
                realbuffer3((ivol_l-1)*nvarsgsi+3+iaq)=rateaq(iaq,tid)
              end do 
            else
              write(igsi,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                                      (rateaq(iaq,tid),iaq = 1,naq)
            end if

          end if               !(naq.gt.0.....)
 
!c  --------------------------------------------------------------------- 
!c  output - gas phase
!c  --------------------------------------------------------------------- 

          if (ng.gt.0) then

!c         gas advection
            if (gas_advection .or. dgm .or. maxwell) then
              do ig=1,ng
                pg(ig) = 0.0d0
                if (cum_molfrac) then
                  do jg=1,ig
                     pg(ig) = pg(ig) + rgasatm*tkel(ivol)*gnew(jg,ivol)            
                  enddo
                else
                  pg(ig) = rgasatm*tkel(ivol)*gnew(ig,ivol)             
                endif
              enddo 
            end if

!c  compute total gas pressure

            pres_tot = r0
            do ig = 1,ng
              pres_tot = pres_tot+rgasatm*tkel(ivol)*gnew(ig,ivol)
            end do

!c  partial gas pressures and total gas pressure
    
            if (b_output_binary) then
              realbuffer4((ivol_l-1)*(4+ng)+1:(ivol_l-1)*(4+ng)+3) = &
                         (/xg(ivol),yg(ivol),zout/)
              do ig = 1, ng
                realbuffer4((ivol_l-1)*(4+ng)+3+ig) =                &
                             rgasatm*tkel(ivol)*gnew(ig,ivol) 
              end do
              realbuffer4(ivol_l*(4+ng)) = pres_tot               
            else
              write(igsg,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                                 (rgasatm*tkel(ivol)*gnew(ig,ivol),    &
                                  ig=1,ng),pres_tot
            end if
     
            if (gas_advection .or. dgm .or. maxwell) then
              if (b_output_binary) then
                realbuffer5((ivol_l-1)*(3+ng)+1:(ivol_l-1)*(3+ng)+3) = &
                           (/xg(ivol),yg(ivol),zout/)
                do ig = 1, ng
                  realbuffer5((ivol_l-1)*(3+ng)+3+ig) = pg(ig)/pres_tot 
                end do
              else
                write(igs2,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                                        (pg(ig)/pres_tot,ig=1,ng)
              end if
            end if

!c  compute degassing rates and total rates for removal of aqueous
!c  components due to degassing [mol L^-1 h2o s^-1]

            if (gas_removal) then

              if (density_dependence) then
                call rategasd(gnew(1,ivol),tkel(ivol),uvsnew(ivol),    &
                              sgnew(ivol),tid)
              else
                call rategas(gnew(1,ivol),tkel(ivol),hhead(ivol),      &
                             zg(ivol),sgnew(ivol),tid)                      
              end if
                
              if (b_output_binary) then
                realbuffer6((ivol_l-1)*(3+ng)+1:(ivol_l-1)*(3+ng)+3) = &
                           (/xg(ivol),yg(ivol),zout/)
                do ig = 1, ng
                  realbuffer6((ivol_l-1)*(3+ng)+3+ig) = rateg(ig,tid)
                end do 
              else
                write(igsgr,ascii_fmt)                                 &
                      xg(ivol),yg(ivol),zout,(rateg(ig,tid),ig=1,ng)
              end if

            end if

          end if

!c  --------------------------------------------------------------------- 
!c  output - solid phase
!c  --------------------------------------------------------------------- 

!c  concentrations of sorbed species - non-competitive sorption

          if (noncompetitive_sorption) then
          
            if (redox_equil.and.nr.gt.0) then
              call totconc(cnew(1,ivol),cx(1,ivol),totcnew(1,ivol))
            end if

            call totcona(totan(:,tid),totcnew(1,ivol),                 &
                         distcoff_rt(1,ivol),sanew(ivol),pornew(ivol))

            if (redox_equil.and.nr.gt.0) then
              call comptotc(totcnew(1,ivol))
            end if

!c  compress concentration vector for output

            ianc = 0
            do ic = 1,nc-1
              if (isotherm_type(ic).ne.'none') then
                ianc = ianc+1
                totan(ianc,tid) = totan(ic,tid)
              end if
            end do

          end if

!c  concentrations of sorbed species - competitive sorption

          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then

            do isb = 1,nsb_ion 
                call sorbspc_m(csb_ion(isb,tid),dummy,cec_g(ivol),    &
                     cec_fraction_g(idx_nsites_ion(isb),ivol),        &
                     eqsb_ion(:,tid),eqsb_surf(:,tid),                &
                     gamma(1,ivol),cnew(1,ivol),xnusb_ion,xnusb_surf, &
                     iasb_ion,iasb_surf,jasb_ion,jasb_surf,           &
                     nsb_ion,nsb_surf,isb,0,                          &
                     sorption_type_ion,sorption_type_surf,            &
                     sorption_group,isactcexch)
            end do  
                        
            do isb = 1,nsb_surf
              call sorbspc(dummy,csb_surf(isb,tid),cec_g(ivol),       &
                   eqsb_ion(:,tid),eqsb_surf(:,tid),                  &
                   gamma(1,ivol),cnew(1,ivol),                        &
                   xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,           &
                   jasb_ion,jasb_surf,nsb_ion,                        &
                   nsb_surf,0,isb,sorption_type_ion,                  &
                   sorption_type_surf,sorption_group,isactcexch)    
            end do
        
          end if
                                                                      
!c  output 

          if(.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.      &
              nsb_surf.gt.0.or.noncompetitive_sorption)) then 
                                                         
            if (nsb_ion.eq.0.and.nsb_surf.eq.0) then
                                                                      
!c  non-competitive sorption only
              if (b_output_binary) then
                realbuffer7((ivol_l-1)*nvarsgsb+1:(ivol_l-1)*nvarsgsb+3) &
                           = (/xg(ivol),yg(ivol),zout/)
                do ianc=1,nanc
                  realbuffer7((ivol_l-1)*nvarsgsb+3+ianc) =              &
                             totan(ianc,tid)  
                end do
              else
                write(igsb,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                                        (totan(ianc,tid),                &
                                        ianc=1,nanc)
              end if            
                                                                     
!c  competitive sorption only

            elseif (.not.noncompetitive_sorption) then
              
              if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
          
                if (b_output_binary) then
                  realbuffer7((ivol_l-1)*nvarsgsb+1:(ivol_l-1)*        &
                            nvarsgsb+3) = (/xg(ivol),yg(ivol),zout/)
                  do isites=1,nsites
                    realbuffer7((ivol_l-1)*nvarsgsb+3+isites) =        &
                              cnew(iaic(isites),ivol)
                  end do
                  
                  do isb=1,nsb_ion
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nsites+isb) =    &
                              csb_ion(isb,tid)
                  end do
                  
                  do isb=1,nsb_surf
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nsites+nsb_ion+  &
                              isb) = csb_surf(isb,tid)
                  end do
                  
                else
                  write(igsb,ascii_fmt)                                &
                        xg(ivol),yg(ivol),zout,                        &
                        (cnew(iaic(isites),ivol),                      &
                        isites=1,nsites),                              &
                        (csb_ion(isb,tid),isb=1,nsb_ion),              &
                        (csb_surf(isb,tid),isb=1,nsb_surf)
                end if
              else        
                ! unit for SCM concentration in 'mol/L bulk'
                if (b_output_binary) then
                  realbuffer7((ivol_l-1)*nvarsgsb+1:(ivol_l-1)*        &
                            nvarsgsb+3) = (/xg(ivol),yg(ivol),zout/)
                  do isites=1,nsites
                    realbuffer7((ivol_l-1)*nvarsgsb+3+isites) =        &
                              cnew(iaic(isites),ivol)*                 &
                              sanew(ivol)*pornew(ivol)
                  end do
                  
                  do isb=1,nsb_ion
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nsites+isb) =    &
                              csb_ion(isb,tid)
                  end do
                  
                  do isb=1,nsb_surf
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nsites+nsb_ion+  &
                              isb) = csb_surf(isb,tid)*                &
                                     sanew(ivol)*pornew(ivol)
                  end do  
                else
                  write(igsb,ascii_fmt)                                &
                        xg(ivol),yg(ivol),zout,                        &
                        (cnew(iaic(isites),ivol)*                      &
                         sanew(ivol)*pornew(ivol),                     &
                        isites=1,nsites),                              &
                        (csb_ion(isb,tid),isb=1,nsb_ion),              &
                        (csb_surf(isb,tid)*sanew(ivol)*pornew(ivol),   &
                        isb=1,nsb_surf) 
                end if
              end if
                                                  
!c  competitive and non-competitive sorption

            else
              
              if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
                if (b_output_binary) then  
                  realbuffer7((ivol_l-1)*nvarsgsb+1:(ivol_l-1)*        &
                            nvarsgsb+3) = (/xg(ivol),yg(ivol),zout/)
                  do ianc=1,nanc
                    realbuffer7((ivol_l-1)*nvarsgsb+3+ianc) =          &
                               totan(ianc,tid) 
                  end do
                  
                  do isites=1,nsites
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nanc+isites) =   &
                              cnew(iaic(isites),ivol)
                  end do
                  
                  do isb=1,nsb_ion
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nanc+nsites+isb) &
                               = csb_ion(isb,tid)
                  end do
                  
                  do isb=1,nsb_surf
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nanc+nsites+     &
                              nsb_ion+isb) = csb_surf(isb,tid)
                  end do
                else
                  write(igsb,ascii_fmt)                                &
                        xg(ivol),yg(ivol),zout,                        &
                        (totan(ianc,tid),                              &
                        ianc=1,nanc),                                  &
                        (cnew(iaic(isites),ivol),                      &
                        isites=1,nsites),                              &
                        (csb_ion(isb,tid),isb=1,nsb_ion),              &
                        (csb_surf(isb,tid),isb=1,nsb_surf)
                end if
              else       
                ! unit for SCM concentration in 'mol/L bulk'
                if (b_output_binary) then
                  realbuffer7((ivol_l-1)*nvarsgsb+1:(ivol_l-1)*        &
                            nvarsgsb+3) = (/xg(ivol),yg(ivol),zout/)
                  do ianc=1,nanc
                    realbuffer7((ivol_l-1)*nvarsgsb+3+ianc) =          &
                               totan(ianc,tid) 
                  end do
                  
                  do isites=1,nsites
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nanc+isites) =   &
                              cnew(iaic(isites),ivol)*                 &
                              sanew(ivol)*pornew(ivol)
                  end do
                  
                  do isb=1,nsb_ion
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nanc+nsites+isb) &
                               = csb_ion(isb,tid)
                  end do
                  
                  do isb=1,nsb_surf
                    realbuffer7((ivol_l-1)*nvarsgsb+3+nanc+nsites+     &
                            nsb_ion+isb) = csb_surf(isb,tid)*          &
                                           sanew(ivol)*pornew(ivol)
                  end do 
                else
                  write(igsb,ascii_fmt)                                &
                        xg(ivol),yg(ivol),zout,                        &
                        (totan(ianc,tid),                              &
                        ianc=1,nanc),                                  &
                        (cnew(iaic(isites),ivol)*                      &
                        sanew(ivol)*pornew(ivol),                      &
                        isites=1,nsites),                              &
                        (csb_ion(isb,tid),isb=1,nsb_ion),              &
                        (csb_surf(isb,tid)*sanew(ivol)*pornew(ivol),   &
                        isb=1,nsb_surf)
                end if
              end if
              
            end if
      
          end if


!c  saturation indices for minerals
  
          if (nm.gt.0) then

!c  compute total molar concentration of organic mixture
!c  in solid phase

            call molconc(phiold(1,ivol),tid)

            do im=1,nm

              if (.not.far_from_equil(im)) then
!c  saturation indices for minerals
!c_isotope
                if (isofrac(im)) then
                  satm(im,tid) = eqm(im,tid)**(-r1)
                  ireac = iamd(im)            
                  istart = iam(im)
                  istop = iam(im+1)-1           
          
                  do i1 = istart, istop ! loop through components in mineral
                    icount = 0
                    ic = jam(i1)
                    next = 0 
                    do i = 1, nifrm(im)  ! loop through isotope sets
                      istart2 = next + iamdiso(im)
                      icur = iamdiso2(im) + i - 1
                      istop2 = iamdiso(im) + jamdiso2(icur) - 1
                      next = jamdiso2(icur)
                      gammatemp = r0
                      !loop through isotope compents in set
                      do i2 = istart2, istop2
                        ii = jamdiso(i2)
                        !check to see if component is an isotope
                        if (ii.eq.ic) then 
                          icount = icount + 1
                          !if so sum the isotope activities
                          do i3 = istart2, istop2 
                            ic2 = jamdiso(i3)
                            gammatemp = gammatemp + gamma(ic2,ivol)*   &
                                        cnew(ic2,ivol)           
                          end do                                        
                          satm(im,tid) = satm(im,tid)*gammatemp**xnum(i1)             
                        end if                                          
                      end do                                            
                    end do                                              
                    !if not calculate the saturaton index the normal way  
                    if (icount.eq.0) then                               
                      satm(im,tid) = satm(im,tid) *                    &
     &                        (gamma(ic,ivol)*cnew(ic,ivol))**xnum(i1)  
                    end if                                              
                  end do   !i1                                          
                                                                        
                  satm_log(im) = dlog10(satm(im,tid))
                                                                        
                else if (reaction_type(im).ne.'raoult') then
                   
                  satm(im,tid) = satindex(cnew(1,ivol),eqm(im,tid),   &
     &                                gamma(1,ivol),xnum,iam,jam,im)
                  satm_log(im) = dlog10(satm(im,tid))

!c  effective saturation indices for dissolution form organic mixtures
!c  based on raoult's law

                elseif (reaction_type(im).eq.'raoult') then

!c  compute molar concentration of organic compound in organic mixture

                  conc_mol = phiold(im,ivol)*densm(im)/gfwm(im)

!c  pure phase saturation index

                  satm(im,tid) = satindex(cnew(1,ivol),eqm(im,tid),   &
     &                                gamma(1,ivol),xnum,iam,jam,im)

!c  effective solubility according to Raoult's Law

                  frac_mol = conc_mol/conc_mol_avg(tid)
                  satm(im,tid) = satm(im,tid)/frac_mol
                  satm_log(im) = dlog10(satm(im,tid))

                end if

!c  skip calculation for far-from-equilibrium reactions

              else

                satm_log(im) = r0

              end if

            end do

            if (b_output_binary) then
              realbuffer8((ivol_l-1)*(3+nm)+1:(ivol_l-1)*(3+nm)+3) =   &
                        (/xg(ivol),yg(ivol),zout/)
              do im=1,nm
                realbuffer8((ivol_l-1)*(3+nm)+3+im) = satm_log(im)  
              end do
            else
              write(igss,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                                      (satm_log(im),im=1,nm)
            end if
 
!c  dissolution-precipitation rates

            do im = 1,nm

!c  recompute rates for output

              if (new_database) then
                if (root_uptake) then
                  rootdens = rld(ivol)
                else
                  rootdens = r1
                end if
                call ratemin_new(totcnew(1,ivol),cnew(1,ivol),        &
                                 cx(1,ivol),gamma(1,ivol),            &
                                 gamma(nc+1,ivol),sanew(ivol),        &
                                 ratemdp(im,ivol),                    &
                                 phi(1,ivol),phiold(im,ivol),         &
                                 area(im,ivol),rootdens,im,tid)  
              else                                                     
                call ratemin(totcnew(1,ivol),cnew(1,ivol),cx(1,ivol), &
                             gamma(1,ivol),gamma(nc+1,ivol),          &
                             ratemdp(im,ivol),phi(im,ivol),           &
                             phiold(im,ivol),area(im,ivol),im,tid)
              end if

!cdsu  Adjust mineral rate for intermittent reactions
              if (flag_intermittent_react) then
                if (imizn2jairm(im,izn_c) > 0) then
                  ratemdp(im,ivol) = ratemdp(im,ivol)*imizn2irc(im,izn_c)
                end if
              end if

!cdsu  Assign mineral rate for frozen water
              if(b_water_freezing_ratemin) then
                if (tkel(ivol) < pressure_melt_k(ivol,r0)) then
                  ratemdp(im,ivol) = water_freezing_ratemin 
                end if 
              end if

!c  modify computed rates in the same manner as done in the residual
!c  assembly
              call modrate(ratemdp(im,ivol),cmnew(im,ivol),            &
                           pornew(ivol),delt,im,tid)              
            end do

            istart = iamd(1)
            istop = iamd(nm+1)-1
            if (b_output_binary) then
              realbuffer9((ivol_l-1)*nvarsgsd+1:                     &
                          (ivol_l-1)*nvarsgsd+3) =                   &
                         (/xg(ivol),yg(ivol),zout/)                
              do ireac=istart,istop
                realbuffer9((ivol_l-1)*nvarsgsd+3+ireac) =           &
                            ratemp(ireac,tid)
              end do
            else
              write(igsd,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                    (ratemp(ireac,tid),ireac=istart,istop)
            end if

!c  volume fractions of minerals
 
!c  get rid off concentrations below numerical accuracy

            do im = 1,nm
              if (phi(im,ivol).gt.phimin_out(im)) then
                phi_out(im) = phi(im,ivol)
              else
                phi_out(im) = phimin(im)
              end if
            end do

!c  compute porosity from mineral volume fractions for output
!cmx Bugfix April. 2018: The calculated porosity is only correct  
!cmx if all solids are considered in the calculation 
!cmx including those "inert" minerals. Otherwise, the porosity 
!cmx will be higher than the actual porosity.
           
            !por_out = r1
            !do im = 1,nm
            !  if (iamp(im+1)-iamp(im).gt.0) then
            !    por_out = por_out - phi_out(im)
            !  end if
            !end do

!c  output of volume fractions and porosity
            if (update_porosity .and. update_permeability) then
              if (b_output_binary) then
                realbuffer10((ivol_l-1)*nvarsgsv+1:                    &
                             (ivol_l-1)*nvarsgsv+3) =                  &
                             (/xg(ivol),yg(ivol),zout/)
                do im=1,nm
                  realbuffer10((ivol_l-1)*nvarsgsv+3+im) = phi_out(im)                  
                end do
                realbuffer10((ivol_l-1)*nvarsgsv+4+nm) = pornew(ivol)
                if (permeability_field) then
                  if (density_dependence) then
                    realbuffer10((ivol_l-1)*nvarsgsv+5+nm) =           &
                        permx(ivol)/convk/sec_per_days
                    realbuffer10((ivol_l-1)*nvarsgsv+6+nm) =           &
                        permy(ivol)/convk/sec_per_days
                    realbuffer10((ivol_l-1)*nvarsgsv+7+nm) =           &
                        permz(ivol)/convk/sec_per_days
                  else
                    realbuffer10((ivol_l-1)*nvarsgsv+5+nm) =           &
                        permx(ivol)/sec_per_days
                    realbuffer10((ivol_l-1)*nvarsgsv+6+nm) =           &
                        permy(ivol)/sec_per_days
                    realbuffer10((ivol_l-1)*nvarsgsv+7+nm) =           &
                        permz(ivol)/sec_per_days
                  end if
                else
                  realbuffer10((ivol_l-1)*nvarsgsv+5+nm) =             &
                      condxx(mpropvs(ivol))*perm_fac(ivol)/            &
                      sec_per_days*k_depth_ratio(ivol)
                  realbuffer10((ivol_l-1)*nvarsgsv+6+nm) =             &
                      condyy(mpropvs(ivol))*perm_fac(ivol)/            &
                      sec_per_days*k_depth_ratio(ivol)
                  realbuffer10((ivol_l-1)*nvarsgsv+7+nm) =             &
                      condzz(mpropvs(ivol))*perm_fac(ivol)/            &
                      sec_per_days*k_depth_ratio(ivol)
                end if
              else
                if (permeability_field) then
                  if (density_dependence) then
                    write(igsv,ascii_fmt) xg(ivol),yg(ivol),           &
                      zout,(phi_out(im),im=1,nm), pornew(ivol),        &
                      permx(ivol)/convk/sec_per_days,                  &
                      permy(ivol)/convk/sec_per_days,                  &
                      permz(ivol)/convk/sec_per_days
                  else
                    write(igsv,ascii_fmt) xg(ivol),yg(ivol),           &
                      zout,(phi_out(im),im=1,nm), pornew(ivol),        &
                      permx(ivol)/sec_per_days,                        &
                      permy(ivol)/sec_per_days,                        &
                      permz(ivol)/sec_per_days
                  end if
                else
                  write(igsv,ascii_fmt) xg(ivol),yg(ivol),             &
                    zout,(phi_out(im),im=1,nm), pornew(ivol),          &
                    condxx(mpropvs(ivol))*perm_fac(ivol)/sec_per_days* &
                    k_depth_ratio(ivol),                               &
                    condyy(mpropvs(ivol))*perm_fac(ivol)/sec_per_days* &
                    k_depth_ratio(ivol),                               &
                    condzz(mpropvs(ivol))*perm_fac(ivol)/sec_per_days* &
                    k_depth_ratio(ivol)
                end if
              end if                                                         
            else if (update_porosity) then
              if (b_output_binary) then
                realbuffer10((ivol_l-1)*nvarsgsv+1:                    &
                             (ivol_l-1)*nvarsgsv+3) =                  &
                             (/xg(ivol),yg(ivol),zout/)
                do im=1,nm
                  realbuffer10((ivol_l-1)*nvarsgsv+3+im) = phi_out(im)                  
                end do
                realbuffer10((ivol_l-1)*nvarsgsv+4+nm) = pornew(ivol) 
              else
                write(igsv,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                                        (phi_out(im),im=1,nm),         &
                                         pornew(ivol)
              end if                                                         
            else
              if (b_output_binary) then
                realbuffer10((ivol_l-1)*nvarsgsv+1:                    &
                             (ivol_l-1)*nvarsgsv+3) =                  &
                             (/xg(ivol),yg(ivol),zout/)
                do im=1,nm
                  realbuffer10((ivol_l-1)*nvarsgsv+3+im) = phi_out(im)                  
                end do
                realbuffer10((ivol_l-1)*nvarsgsv+4+nm) = pornew(ivol)      !MX
              else
                write(igsv,ascii_fmt) xg(ivol),yg(ivol),zout,          &
                      (phi_out(im),im=1,nm),pornew(ivol) !MX
              end if
            end if
          end if    !(nm.gt.0)

!c  saturation indices for excluded minerals

          if (nmx.gt.0) then

            do imx = 1,nmx
              satmx(imx) =  satindex(cnew(1,ivol),eqmx(imx,tid),       &
                                     gamma(1,ivol),xnumx,iamx,jamx,imx)
            end do
            
            if (b_output_binary) then
              realbuffer11((ivol_l-1)*(3+nmx)+1:                       &
                           (ivol_l-1)*(3+nmx)+3) =                     &
                          (/xg(ivol), yg(ivol), zout/)
              do imx=1,nmx
                realbuffer11((ivol_l-1)*(3+nmx)+3+imx) =               &
                             dlog10(satmx(imx))
              end do
            else
              write(igsx,ascii_fmt) xg(ivol),yg(ivol),zout,            &
                                      (dlog10(satmx(imx)),imx=1,nmx)
            end if

          end if    !(nmx.gt.0)
          
!c_isotopes
!c isotope data          
          if (iso_output) then

            i1 = 0
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              tottemp = 0
              do i2 = istart, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1
                valuetemp(i1) = totcnew(ic2,ivol)
                tottemp = tottemp + totcnew(ic2,ivol)
              end do
              i1 = i1 +1
              valuetemp(i1) = tottemp
               
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart+1, istop
                ic1 = jamdisoo(istart)
                ic2 = jamdisoo(i2)
                i1 = i1 +1 
                valuetemp(i1)=(totcnew(ic2,ivol)/totcnew(ic1,ivol)/    &
                              isodelta(i2)-1)*1000                      
              end do                                                    
            end do                
            
            if (b_output_binary) then
              realbuffer12((ivol_l-1)*nvarsgsis+1:                     &
                           (ivol_l-1)*nvarsgsis+3) =                   &
                          (/xg(ivol), yg(ivol), zout/)
              do imi = 1, i1
                realbuffer12((ivol_l-1)*nvarsgsis+3+imi)=valuetemp(imi)
              end do
            else
              write(igsis,ascii_fmt) xg(ivol),yg(ivol),zout,           &
                    (valuetemp(imi),imi=1,i1)
            end if
          end if    !(iso_output)    
          
!c  ---------------------------------------------------------------------  
!c  water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------

          if (chemical_water) then
              
            if (b_output_binary) then
              realbuffer13((ivol_l-1)*4+1:(ivol_l-1)*4+4) =            &
                          (/xg(ivol), yg(ivol), zout, qwater(ivol)/)

            else
        
              write(igsw,ascii_fmt) xg(ivol),yg(ivol),zout,qwater(ivol)
            
            end if

          endif 
          
        end do      !loop over control volumes
        
        if (b_output_binary) then
          if (b_output_multizone .or. .not.b_output_mpiio_single) then
            call binary_write_data(igsc, size(realbuffer,1),           &
                         realbuffer, offset_igsc,b_output_mpiio_single)
          else
            call binary_subarray_initialize(nvarsgsc,                  &
                       b_mpiarray_igsc_init,.false.,                   &
                       mpiarray_filetype_igsc,mpiarray_sizes_gbl_igsc, &
                       mpiarray_sizes_sub_igsc,mpiarray_starts_sub_igsc)
            call binary_write_data(igsc, size(realbuffer,1),           &
                         realbuffer, offset_igsc,mpiarray_filetype_igsc)
          end if
          call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
          deallocate(realbuffer)
          
          !c activity coefficients
          if (b_output_activity) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsac, size(realbuffer14,1),            &
                           realbuffer14, offset_igsac,b_output_mpiio_single)
            else
              call binary_subarray_initialize(nvarsgsac,                     &
                         b_mpiarray_igsac_init,.false.,                      &
                         mpiarray_filetype_igsac,mpiarray_sizes_gbl_igsac,   &
                         mpiarray_sizes_sub_igsac,mpiarray_starts_sub_igsac)
              call binary_write_data(igsac, size(realbuffer14,1),            &
                           realbuffer14, offset_igsac,mpiarray_filetype_igsac)
            end if
            call memory_monitor(-sizeof(realbuffer14),'realbuffer14',.true.)
            deallocate(realbuffer14)
          end if
          
          if (ph_output .or. pe_output) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsm, size(realbuffer2,1),        &
                          realbuffer2,offset_igsm,b_output_mpiio_single)
            else
              call binary_subarray_initialize(nvarsgsm,                &
                          b_mpiarray_igsm_init,.false.,                &
                          mpiarray_filetype_igsm,                      &
                          mpiarray_sizes_gbl_igsm,                     &
                          mpiarray_sizes_sub_igsm,                     &
                          mpiarray_starts_sub_igsm)
              call binary_write_data(igsm, size(realbuffer2,1),        &
                         realbuffer2,offset_igsm,mpiarray_filetype_igsm)
            end if
            call memory_monitor(-sizeof(realbuffer2),'realbuffer2',.true.)
            deallocate(realbuffer2)
          end if
          
          if ((naq.eq.0 .and. nr.gt.0 .and. .not. redox_equil .and.    &
              .not. initial_condition) .or. (naq.gt.0 .and. .not.      &
              initial_condition)) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsi, size(realbuffer3,1),        &
                           realbuffer3, offset_igsi,                   &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(nvarsgsi,                &
                          b_mpiarray_igsi_init,.false.,                &
                          mpiarray_filetype_igsi,                      &
                          mpiarray_sizes_gbl_igsi,                     &
                          mpiarray_sizes_sub_igsi,                     &
                          mpiarray_starts_sub_igsi)
              call binary_write_data(igsi, size(realbuffer3,1),        &
                           realbuffer3, offset_igsi,                   &
                           mpiarray_filetype_igsi)
            end if
            call memory_monitor(-sizeof(realbuffer3),'realbuffer3',.true.)
            deallocate(realbuffer3)
          end if
              
          if (ng > 0) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsg, size(realbuffer4,1),        &
                           realbuffer4, offset_igsg,                   &
                           b_output_mpiio_single) 
            else
              call binary_subarray_initialize(ng+4,                    &
                          b_mpiarray_igsg_init,.false.,                &
                          mpiarray_filetype_igsg,                      &
                          mpiarray_sizes_gbl_igsg,                     &
                          mpiarray_sizes_sub_igsg,                     &
                          mpiarray_starts_sub_igsg)
              call binary_write_data(igsg, size(realbuffer4,1),        &
                           realbuffer4, offset_igsg,                   &
                           mpiarray_filetype_igsg) 
            end if
            call memory_monitor(-sizeof(realbuffer4),'realbuffer4',.true.)
            deallocate(realbuffer4)
          end if
          
          if (gas_advection .or. dgm .or. maxwell) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igs2, size(realbuffer5,1),        &
                           realbuffer5,offset_igs2,                    &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(ng+3,                    &
                          b_mpiarray_igs2_init,.false.,                &
                          mpiarray_filetype_igs2,                      &
                          mpiarray_sizes_gbl_igs2,                     &
                          mpiarray_sizes_sub_igs2,                     &
                          mpiarray_starts_sub_igs2)
              call binary_write_data(igs2, size(realbuffer5,1),        &
                           realbuffer5,offset_igs2,                    &
                           mpiarray_filetype_igs2)
            end if
            call memory_monitor(-sizeof(realbuffer5),'realbuffer5',.true.)
            deallocate(realbuffer5) 
          end if
          
          if (gas_removal) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsgr,size(realbuffer6,1),        &
                           realbuffer6, offset_igsgr,                  &
                           b_output_mpiio_single) 
            else
              call binary_subarray_initialize(ng+3,                    &
                          b_mpiarray_igsgr_init,.false.,               &
                          mpiarray_filetype_igsgr,                     &
                          mpiarray_sizes_gbl_igsgr,                    &
                          mpiarray_sizes_sub_igsgr,                    &
                          mpiarray_starts_sub_igsgr)
              call binary_write_data(igsgr,size(realbuffer6,1),        &
                           realbuffer6, offset_igsgr,                  &
                           mpiarray_filetype_igsgr) 
            end if
            call memory_monitor(-sizeof(realbuffer6),'realbuffer6',.true.)
            deallocate(realbuffer6)  
          end if
          
          if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0 .or.    &
              nsb_surf.gt.0 .or. noncompetitive_sorption)) then 
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsb, size(realbuffer7,1),        &
                           realbuffer7, offset_igsb,                   &
                           b_output_mpiio_single) 
            else
              call binary_subarray_initialize(nvarsgsb,                &
                          b_mpiarray_igsb_init,.false.,                &
                          mpiarray_filetype_igsb,                      &
                          mpiarray_sizes_gbl_igsb,                     &
                          mpiarray_sizes_sub_igsb,                     &
                          mpiarray_starts_sub_igsb)
              call binary_write_data(igsb, size(realbuffer7,1),        &
                           realbuffer7, offset_igsb,                   &
                           mpiarray_filetype_igsb)  
            end if
            call memory_monitor(-sizeof(realbuffer7),'realbuffer7',.true.)
            deallocate(realbuffer7)
          end if 
              
          if (nm.gt.0) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igss, size(realbuffer8,1),        &
                           realbuffer8,offset_igss,                    &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(nm+3,                    &
                          b_mpiarray_igss_init,.false.,                &
                          mpiarray_filetype_igss,                      &
                          mpiarray_sizes_gbl_igss,                     &
                          mpiarray_sizes_sub_igss,                     &
                          mpiarray_starts_sub_igss)
              call binary_write_data(igss, size(realbuffer8,1),        &
                           realbuffer8,offset_igss,                    &
                           mpiarray_filetype_igss)
            end if
            call memory_monitor(-sizeof(realbuffer8),'realbuffer8',.true.)
            deallocate(realbuffer8) 
            
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsd,size(realbuffer9,1),         &
                           realbuffer9,offset_igsd,                    &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(nvarsgsd,                &
                          b_mpiarray_igsd_init,.false.,                &
                          mpiarray_filetype_igsd,                      &
                          mpiarray_sizes_gbl_igsd,                     &
                          mpiarray_sizes_sub_igsd,                     &
                          mpiarray_starts_sub_igsd)
              call binary_write_data(igsd,size(realbuffer9,1),         &
                           realbuffer9,offset_igsd,                    &
                           mpiarray_filetype_igsd)
            end if
            call memory_monitor(-sizeof(realbuffer9),'realbuffer9',.true.)
            deallocate(realbuffer9) 
            
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsv,size(realbuffer10,1),        &
                           realbuffer10, offset_igsv,                  &
                           b_output_mpiio_single) 
            else
              call binary_subarray_initialize(nvarsgsv,                &
                          b_mpiarray_igsv_init,.false.,                &
                          mpiarray_filetype_igsv,                      &
                          mpiarray_sizes_gbl_igsv,                     &
                          mpiarray_sizes_sub_igsv,                     &
                          mpiarray_starts_sub_igsv)
              call binary_write_data(igsv,size(realbuffer10,1),        &
                           realbuffer10, offset_igsv,                  &
                           mpiarray_filetype_igsv) 
            end if
            call memory_monitor(-sizeof(realbuffer10),'realbuffer10',.true.)
            deallocate(realbuffer10) 
          end if
          
          if (nmx .gt. 0) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsx,size(realbuffer11,1),        &
                           realbuffer11, offset_igsx,                  &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(nmx+3,                   &
                          b_mpiarray_igsx_init,.false.,                &
                          mpiarray_filetype_igsx,                      &
                          mpiarray_sizes_gbl_igsx,                     &
                          mpiarray_sizes_sub_igsx,                     &
                          mpiarray_starts_sub_igsx)
              call binary_write_data(igsx,size(realbuffer11,1),        &
                           realbuffer11, offset_igsx,                  &
                           mpiarray_filetype_igsx)  
            end if
            call memory_monitor(-sizeof(realbuffer11),'realbuffer11',.true.)
            deallocate(realbuffer11)
          end if
          
          if (iso_output) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsis,size(realbuffer12,1),       &
                           realbuffer12, offset_igsis,                 &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(nvarsgsis,               &
                          b_mpiarray_igsis_init,.false.,               &
                          mpiarray_filetype_igsis,                     &
                          mpiarray_sizes_gbl_igsis,                    &
                          mpiarray_sizes_sub_igsis,                    &
                          mpiarray_starts_sub_igsis)
              call binary_write_data(igsis,size(realbuffer12,1),       &
                           realbuffer12, offset_igsis,                 &
                           mpiarray_filetype_igsis)  
            end if
            call memory_monitor(-sizeof(realbuffer12),'realbuffer12',.true.)
            deallocate(realbuffer12)
          end if
          
          if (chemical_water) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsw,size(realbuffer13,1),        &
                           realbuffer13, offset_igsw,                  &
                           b_output_mpiio_single)
            else
              call binary_subarray_initialize(4,                       &
                          b_mpiarray_igsw_init,.false.,                &
                          mpiarray_filetype_igsw,                      &
                          mpiarray_sizes_gbl_igsw,                     &
                          mpiarray_sizes_sub_igsw,                     &
                          mpiarray_starts_sub_igsw)
              call binary_write_data(igsw,size(realbuffer13,1),        &
                           realbuffer13, offset_igsw,                  &
                           mpiarray_filetype_igsw)  
            end if
            call memory_monitor(-sizeof(realbuffer13),'realbuffer13',.true.)
            deallocate(realbuffer13)
          end if
              
        end if
 
      end if        !(extended_output_gs)
      
      if (b_output_binary) then
        call memory_monitor(-sizeof(tec_variables),'tec_variables',.true.)
        deallocate(tec_variables)
      end if

!c  --------------------------------------------------------------------- 
!c  close files
!c  --------------------------------------------------------------------- 
      if(b_output_binary) then          
        call binary_file_close(igst,b_output_mpiio_single)
        if (multi_diff) then
          call binary_file_close(icbt,b_output_mpiio_single)
        end if
        if (flux_out) then
          call binary_file_close(igmf,b_output_mpiio_single)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          call binary_file_close(igsre,b_output_mpiio_single)
        end if        
        
        if (extended_output_gs) then
          call binary_file_close(igsc,b_output_mpiio_single)
          !c activity coefficients
          if (b_output_activity) then
            call binary_file_close(igsac,b_output_mpiio_single)
          end if
          if (ph_output .or. pe_output) then
            call binary_file_close(igsm,b_output_mpiio_single)
          end if
          if (naq.gt.0.and.(.not.initial_condition)) then
            call binary_file_close(igsi,b_output_mpiio_single)
          end if
          if (ng.gt.0) then
            call binary_file_close(igsg,b_output_mpiio_single)
            if (gas_removal) then
              call binary_file_close(igsgr,b_output_mpiio_single)
            end if
          end if
          if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.     &
              nsb_surf.gt.0.or.noncompetitive_sorption)) then
            call binary_file_close(igsb,b_output_mpiio_single)
          end if
          if (nm.gt.0) then
            call binary_file_close(igss,b_output_mpiio_single)
            call binary_file_close(igsd,b_output_mpiio_single)
            call binary_file_close(igsv,b_output_mpiio_single)
          end if
          if (nmx.gt.0) then
            call binary_file_close(igsx,b_output_mpiio_single)
          end if
          if (iso_output) then
            call binary_file_close(igsis,b_output_mpiio_single)  
          end if
          if (chemical_water) then
            call binary_file_close(igsw,b_output_mpiio_single)    
          end if
        end if
      else
        close(igst)
        !Keep the file unit, this will be used later
        !call lun_free(igst)
        if (multi_diff) then
          close(icbt)
          !Keep the file unit, this will be used later
          !call lun_free(icbt)
        end if
        if (flux_out) then
          close(igmf)
          !Keep the file unit, this will be used later
          !call lun_free(igmf)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          close(igsre)
        end if

        if (extended_output_gs) then
          close(igsc)
          !Keep the file unit, this will be used later
          !call lun_free(igsc)
          
          !c activity coefficients
          if (b_output_activity) then
            close(igsac)
          end if
          if (ph_output .or. pe_output) then
            close(igsm)
            !Keep the file unit, this will be used later
            !call lun_free(igsm)
          end if
          if (naq.gt.0.and.(.not.initial_condition)) then
            close(igsi)
            !Keep the file unit, this will be used later
            !call lun_free(igsi)
          end if
          if (ng.gt.0) then
            !Keep the file unit, this will be used later
            close(igsg)
            !call lun_free(igsg)
            if (gas_removal) then
              close(igsgr)
              !Keep the file unit, this will be used later
              !call lun_free(igsgr)
            end if
          end if
          if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.     &
              nsb_surf.gt.0.or.noncompetitive_sorption)) then
            close(igsb)
            !Keep the file unit, this will be used later
            !call lun_free(igsb)
          end if
          if (nm.gt.0) then
            close(igss)
            close(igsd)
            close(igsv)
            !Keep the file unit, this will be used later
            !call lun_free(igss)
            !call lun_free(igsd)
            !call lun_free(igsv)
          end if
          if (nmx.gt.0) then
            close(igsx)
            !Keep the file unit, this will be used later
            !call lun_free(igsx)
          end if          
          if (iso_output) then
            close(igsis)
            !Keep the file unit, this will be used later
            !call lun_free(igsis)
          end if
          
          if (chemical_water) then
            close(igsw)
            !Keep the file unit, this will be used later
            !call lun_free(igsw)
          end if
        
        end if      
      end if

      return
      end
