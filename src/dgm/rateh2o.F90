!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/dgm/rateh2o.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine rateh2o
!c -------------------
!c
!c compute absolute dissolution-precipitation rates of minerals
!c based on new database format
!c
!c sign convention: production -
!c                  consumption +
!c
!c written by:      Sergi Molins - June 7, 2006
!c
!c last modified:   - 
!c                  Danyang Su   - March 26, 2014
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cnew(nc,nn)        = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cvol(nn)           = nodal volumes                       + -
!c           cx(nx,nn)          = concentrations of secondary aqueous + -
!c                                species [moles/l water]
!c           gamma(nc+nx,nn)    = activity coefficients of aqueous
!c                                species [-]
!c           phi(nm,nn)         = volume fractions of minerals        + -
!c           pornew(nn)         = porosity       
!c           qwater(nvol)       = source/sink for flow equation       * +
!c                                due to production/consumption
!c                                of water by geochem reactions
!c           ratemdp(nm,nn)     = absolute dissolution-precipitation  + -
!c                                rates of minerals
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                (new time level)
!c           totcnew(n,nn)      = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + -
!c
!c
!c chem.f:   real*8:
!c           -------
!c           rateaq(naq)        = reaction rates of intra-aqueous     * +
!c                                kinetic reaction
!c           rateor(nr)         = oxidation-reduction rate for        * +
!c                                redox couple [moles/(l h2o*day)
!c           integer*4:
!c           ----------
!c           naq                = number of intra-aqueous kinetic     + - 
!c                                reactions
!c           nm                 = number of minerals                  + -
!c           nn                 = total number of control volumes     + -
!c           nr                 = number of redox couples             + -
!c
!c           logical:
!c           --------
!c           new_database       = .true.  -> use new database format  + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c           character:
!c           ----------
!c
!c local:    real*8:
!c           -------
!c           r55                = constant
!c           totaq_w            = water produced/consumed in 
!c                                intra-aqueous kinetic reactions
!c           totmdp_w           = water produced/consumed in 
!c                                precipitation/dissolution reactions
!c           totor_w            = water produced/consumed in 
!c                                redox kinetic reactions
!c
!c external: bulkconc    = convert from [moles/l water] to 
!c                         [moles/l bulk]
!c           rateint     = compute reaction rates of intra-aqueous 
!c                         kinetic reactions
!c           rateint_new = compute reaction rates of intra-aqueous 
!c                         kinetic reactions (new database format)
!c           rateredx    = compute oxidation-reduction rates for redox 
!c                         couples
!c           totmin_w    = compute rate of production/consumption of water
!c                         due to precipitation/dissolution reactions
!c           totredx_w   = compute rate of production/consumption of water
!c                         due to redox kinetic reactions
!c           totint_w    = compute rate of production/consumption of water
!c                         due to intra-aqueous kinetic reactions
!c ----------------------------------------------------------------------
  
      subroutine rateh2o
 
      use chem, only : new_database, nc, naq, nm, nr, rateaq,          &
                       redox_equil, rateor, scalfac_aq_ivol
      
#ifdef OPENMP
      use gen, only : cnew, cvol, cx, gamma, idbg, nngl, phi, pornew,  &
                      qwater, ratemdp, sanew, totcnew,                 &
                      numofthreads_global, numofloops_thred_rateh2o_1
#else
      use gen, only : cnew, cvol, cx, gamma, idbg, nngl, phi, pornew,  &
                      qwater, ratemdp, sanew, totcnew
#endif

#ifdef OPENMP
      use omp_lib 
#endif 
 
      implicit none

      external rateint, rateint_new, rateredx, totmin_w, totredx_w,    &
               totint_w

      real*8, parameter :: r55 = 55.5d0
      
      real*8 :: totmdp_w, totor_w, totaq_w
      real*8, external :: bulkconc
      
      integer :: tid, ivol, ir, iaq
      

!c loop over all control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_rateh2o_1)                      &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, tid, ir, iaq, totmdp_w, totor_w, totaq_w)                                              
    !$omp do schedule(static)
#endif 
      do ivol=1,nngl
#ifdef OPENMP
        tid = omp_get_thread_num() + 1
#else
        tid = 1
#endif


!c ------ minerals --------

!c  compute total source-sink terms towards total concentrations due
!c  to dissolution-precipitation reactons
 
        if (nm.gt.0) then

!c note: rates of mineral disolution-precipitation have been calculated in jacrt.f
!c after solution mineral conc, mineral volumes and specific surface area of minerals 
!c have been updated for next time step
!c for this time step, rates are in ratemdp(nm,ivol)

!c  total source/sink terms towards water concentration
!c  due to mineral dissolution precipitation reactions
 
          call totmin_w(ratemdp(1,ivol),totmdp_w)

!c  scale total source-sink term due to dissolution/precipitation 
!c  reactions

          totmdp_w = cvol(ivol)*totmdp_w
               
        end if                       !(nm.gt.0)

!c ------ end minerals ------


!c ------ redox reactions ------

!c  compute total source-sink terms towards total concentrations due
!c  to kinetically controlled oxidation/reduction reactions

        if (.not.redox_equil.and.nr.gt.0) then

!c note: for redox reactions, redox rates have not been stored for each control volume
!c so they need to be calculated again, use updated concentrations

!c  overall oxidation-reduction rates for redox couples

          do ir = 1,nr
            call rateredx(cnew(1,ivol),cx(1,ivol),gamma(1,ivol),       &
     &                    gamma(nc+1,ivol),rateor(ir,tid),             &
     &                    totcnew(1,ivol),ir,tid)
          end do

!c  total source/sink terms towards water concentration
!c  due to oxidation-reduction reactions

          call totredx_w(totor_w,tid,idbg)

!c  scale total source-sink term due to oxidation/reduction reactions

          totor_w = cvol(ivol) * bulkconc(totor_w,                     &
     &                                    sanew(ivol),                 &
     &                                    pornew(ivol))

        end if

!c ---- end redox reactions ----------


!c ------ intra-aqueous -----

!c  compute total source-sink terms towards total concentrations due
!c  to intra-aqueous kinetic reactions

        if (naq.gt.0) then

!c note: for intra-aqueous reactions, redox rates have not been stored for each control volume
!c so they need to be calculated again, use updated concentrations

!c  reaction rates of intra-aqueous kinetic reactions

          do iaq = 1,naq
            if (new_database) then
              call rateint_new(rateaq(iaq,tid),totcnew(1,ivol),        &
                               cnew(1,ivol),cx(1,ivol),gamma(1,ivol),  &
                               gamma(nc+1,ivol),phi(1,ivol),iaq,       &
                               scalfac_aq_ivol(iaq,ivol),              &
                               sanew(ivol),pornew(ivol),tid)                               
            else                                                          
              call rateint(rateaq(iaq,tid),totcnew(1,ivol),            &
                           cnew(1,ivol),gamma(1,ivol),phi(1,ivol),iaq, &
                           scalfac_aq_ivol(iaq,ivol),tid)          
            end if
          end do

!c  total source/sink terms towards water concentration
!c  due to intra-aqueous kinetic reactions

          call totint_w(totaq_w,tid,idbg)

!c  scale total source-sink term due to intra-aqueous kinetic 
!c  reactions

          totaq_w = cvol(ivol) * bulkconc(totaq_w,                     &   
     &                                    sanew(ivol),                 &
     &                                    pornew(ivol))
        end if
      
!c ------ end intra-aqueous ---- 

!c  compute water produced/consumed by mineral diss/prec, redox, and intra-aqueous

        qwater(ivol) = totmdp_w + totor_w + totaq_w

!c  convert units from moles H2O L^-1 H2O d^-1 
!c       to units of  L H2O L^-1 aq.phase d^-1

        qwater(ivol) = qwater(ivol)/r55
          
      enddo ! loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 
     
      return
      end
