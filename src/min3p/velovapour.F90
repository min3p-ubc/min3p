!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/velovapour.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine velovapour
!c compute velocities in the vapour phase 
!c ----------------------------------------------------------------------

      subroutine velovapour(ivelvap,nvx,nvy, nvz, iavs, javs,          &
                      cinfevap_pa,cinfevap_t,dimcv,xg, yg, zg,uvsnew,  &
                      tempnew,densvnew,density,idbg,ilog,ivel,         &
                      njavs, nn, nn_loc, half_cells,pornew,sgnew,      &
                      cinfrad,radial_coord,ups_flow,split_divdensv,    &
                      offset) 

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif


      use gen, only : rank, b_enable_output, node_idx_lg2l,            &
                      b_output_binary,realbuffer,b_output_mpiio_single,&
                      b_output_multizone,node_idx_vel_lg2g,nfloatbit,  &
                      ascii_fmt, mem_cur, mem_max, memory_monitor,     &
                      b_mpiarray_ivelvap_init,                         &
                      mpiarray_filetype_ivelvap,                       &
                      mpiarray_sizes_gbl_ivelvap,                      &
                      mpiarray_sizes_sub_ivelvap,                      &
                      mpiarray_starts_sub_ivelvap

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only : binary_write_data,               &
                                      binary_subarray_initialize

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      external cliqdisp, checkerr

!c  passed variables

      integer nvx, nvy, nvz, njavs, nn, nn_loc,iavs(nn+1), javs(njavs),&
              idbg,ilog,ivelvap,ierr

      logical half_cells,radial_coord,split_divdensv

      real*8  uvsnew(nn), tempnew(nn), densvnew(nn),dimcv(3,nn),       &
              cinfevap_t(njavs),cinfevap_pa(njavs), xg(nn), yg(nn),    &
              zg(nn), pornew(nn), sgnew(nn), density(nn),              &
              cinfrad(njavs),ups_flow

#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) :: offset,offset_temp
#else
      integer*8 :: offset,offset_temp
#endif

!c  local variables

      real*8,parameter :: eps = 1.0d-300, r0 = 0.0d0, r1 = 1.0d0,      &
                          rhalf = 0.5d0, r86400=86400.0d0 

      real*8 aread(3,12), areax(3,12), dist(3,12), vel(3), areai,      &
             dflux,linvel(3),linflux, del_ivol, del_jvol, vel_ivol,    &
             vel_jvol ,diff_vapour,tortuosity_vap,tortuosity              

      integer ivol, ivz, ivy, ivx, i1, jvol, i1sav, idim, npair(3),    &
              cvpair(3,12,2), ipair, idim2, idim3, ivol_l, ierrcode

      character*1 iups
      
      integer :: ivol2, ivel
      real*8 :: densvav, porav, savav, xg_out, yg_out, zg_out
            
      if (b_output_binary) then
        allocate(realbuffer(nn_loc*9), stat = ierr)
        call checkerr(ierr,'velovapour-realbuffer',ilog)
        realbuffer = 0.0d0
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
      end if

!c  compute average interfacial velocities

      ivol2 = 0
      ivol_l = 0

      do ivz = 1, nvz          !increments in z-direction
        do ivy = 1, nvy        !increments in y-direction
          do ivx = 1, nvx      !increments in x-direction

          ivol2 = ivol2 + 1  !counter - control volumes
         
!c  skip ghost nodes
#ifdef PETSC
          if(node_idx_lg2l(ivol2) < 0) then
              cycle
          end if
#endif    

!c  find node pairs for interfacial velocities
          call cliqdisp (nvx, nvy, nvz, ivx, ivy, ivz,                 &
                        cvpair,npair,aread,areax,dist,dimcv,           &
                        half_cells,iavs,javs,njavs,                    &
                        nn,idbg,cinfrad,radial_coord)   

!c  check connections

            if ((nvx .gt. 1 .and. npair(1) .eq. 0) .or.   &
                (nvy .gt. 1 .and. npair(2) .eq. 0) .or.   &
                (nvz .gt. 1 .and. npair(3) .eq. 0)) goto 400
            
            ivol_l = ivol_l + 1

!c  loop over the dimensions x,y,z

            do idim = 1, 3

              idim2 = idim + 1
              idim3 = idim + 2
              if (idim2 .gt. 3) idim2 = idim2 - 3
              if (idim3 .gt. 3) idim3 = idim3 - 3

!c  zero average interfacial velocity

              vel(idim) = r0
              linvel(idim) = r0
!c  loop over the number of control volume pairs in the dimension

              do ipair = 1, npair(idim)

                ivol = cvpair(idim, ipair, 1)
                jvol = cvpair(idim, ipair, 2)

!c  calculate average interfacial area between nodes               
                areai = areax(idim, ipair)

                do i1 = iavs(ivol), iavs(ivol+1)-1
                  if (javs(i1) .eq. jvol) then
                    i1sav = i1
                    go to 500
                  endif
                end do
                if (rank == 0) then
                  write(ilog,*) ' error-cannot find jvol in list'
                  write(ilog,*) ' ivol, jvol ', ivol, jvol
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
500             continue

!c  find flux between control volume pair
                tortuosity = tortuosity_vap(pornew(ivol),pornew(jvol), &
                             sgnew(ivol),sgnew(jvol)) 
                if (split_divdensv) then
                   dflux = diff_vapour(uvsnew(ivol),uvsnew(jvol),      &
                                       r1,r1,                          &
                                       pornew(ivol),pornew(jvol),      &
                                       sgnew(ivol),sgnew(jvol),        &
                                       cinfevap_pa(i1sav), r1,r1,      &
                                       tortuosity,ups_flow,.false.)
                   dflux = dflux + diff_vapour(                        &
                                        tempnew(ivol),tempnew(jvol),   &
                                        r1, r1,                        &
                                        pornew(ivol),pornew(jvol),     &
                                        sgnew(ivol),sgnew(jvol),       &
                                        cinfevap_t(i1sav),r1,r1,       &
                                        tortuosity,ups_flow,.false.)
                else
                   dflux = diff_vapour(densvnew(ivol),densvnew(jvol),  &
                                       r1,r1,                          &
                                       pornew(ivol),pornew(jvol),       &
                                       sgnew(ivol),sgnew(jvol),        &
                                       cinfevap_pa(i1sav),r1,r1,       &
                                       tortuosity,ups_flow,.false.)
                
                end if
!c  distance-weighted seepage velocity calculation

                del_ivol = rhalf * dimcv(idim,ivol)
                del_jvol = rhalf * dimcv(idim,jvol)
                densvav = rhalf*(density(ivol)+density(jvol))
                porav = rhalf*(pornew(ivol)+pornew(jvol))
                savav = rhalf*(sgnew(ivol)+sgnew(jvol))
                if (savav>r0) then
                 del_ivol = rhalf * dimcv(idim,ivol)
                 del_jvol = rhalf * dimcv(idim,jvol)

                 vel_ivol = dflux/areai/(density(ivol) * sgnew(ivol) * &
                                         pornew(ivol))
                 vel_jvol = dflux/areai/(density(jvol) * sgnew(jvol) * &
                                         pornew(jvol))

                 linflux  = (del_ivol + del_jvol)/   &
                            (del_ivol/(vel_ivol + eps) +  & 
                             del_jvol/(vel_jvol + eps))
                 vel(idim) = vel(idim) - dflux / (areai * densvav)
                 linvel(idim) = linvel(idim) - linflux
                end if
              end do  !ipair = 1, npair(idim)

!c  find the average interfacial Darcy velocity in the x,y,z directions

              vel(idim) = vel(idim)/(float( npair(idim) ) + eps)
 
            end do  !do idim = 1, 3

!c  write average interfacial velocities to output file if called by
!c  ouputdd routine: iprint = 1; else iprint = 0
           if (nvx.gt.1) then
                xg_out = xg(ivol2) - rhalf * dimcv(1,ivol2)
           else
                xg_out = xg(ivol2)
           end if

           if (nvy.gt.1) then
                yg_out = yg(ivol2) - rhalf * dimcv(2,ivol2)
           else
                yg_out = yg(ivol2)
           end if

           if (nvz.gt.1) then
                zg_out = zg(ivol2) - rhalf * dimcv(3,ivol2)
           else
                zg_out = zg(ivol2)
           end if
           
           if (b_output_binary) then
             realbuffer((ivol_l-1)*9+1:ivol_l*9) = (/xg_out, yg_out,   &
                        zg_out, vel(1), vel(2), vel(3),  linvel(1),    &
                        linvel(2), linvel(3)/)
           else
             write(ivelvap,ascii_fmt) xg_out,yg_out,zg_out,            &
                   (vel(idim),idim=1,3),(linvel(idim),idim=1,3)
           end if

400        continue

          end do
        end do
      end do
      
      if (b_output_binary) then
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(ivelvap, ivol_l*9, realbuffer,        &
                       offset,b_output_mpiio_single)
        else
          call binary_subarray_initialize(9,b_mpiarray_ivelvap_init,   &
                      .true.,mpiarray_filetype_ivelvap,                &
                      mpiarray_sizes_gbl_ivelvap,                      &
                      mpiarray_sizes_sub_ivelvap,                      &
                      mpiarray_starts_sub_ivelvap)

          call binary_write_data(ivelvap, ivol_l*9, realbuffer,&
                       offset,mpiarray_filetype_ivelvap) 
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
      end if

      return
      end

