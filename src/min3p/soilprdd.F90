!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/soilprdd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine soilprdd
!c -------------------
!c
!c compute soil hydraulic parameters (variably saturated flow)
!c
!c written by:      Tom Henderson - September 9, 2003
!c                  from Uli Mayer template
!c
!c last modified:   Tom Henderson - February 10, 2004
!c                                  December 15, 2004 - improved commenting
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           relperm(nn)        = relative permeability               * +
!c           sanew(nn)          = aqueous phase saturation            * +
!c                                - new time level
!c
!c           integer*4:
!c           ---------- 
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c
!c common:   
!c phys.f:   real*8:
!c           -------
!c           swr(nzn)           = residual saturation                 + -
!c           aentry(nzn)        = air entry pressure                  + -
!c           spalpha(nzn)       = soil hydraulic function parameter   + -
!c           spbeta(nzn)        = soil hydraulic function parameter   + -
!c           spgamma(nzn)       = soil hydraulic function parameter   + -
!c           expn(nzn)          = krw - p equation exponent           + -
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           izn                = counter (zones)
!c
!c external: satfpres  = compute saturations from pressure
!c           relpfsat  = compute relative permeability from saturation
!c ----------------------------------------------------------------------
 
      subroutine soilprdd(pressure,sw,sg,relperm,relpermg,            &
                          sn,swr,aentry,alpha,                        &
                          beta,expn,gamma,                            &
                          napl_permeability,                          &
                          napl_kfunction,sgr,                         &
                          isovendrying,beta_ovendry,                  &
                          hm_ovendry,w0_ovendry,                      &
                          cp0_ovendry,ref_dens,gacc)
 
   

      implicit none
      
      character(len=*), intent(in) :: napl_kfunction
      logical, intent(in)          :: napl_permeability,isovendrying
      real*8, intent(in)           :: pressure,sn,swr,aentry,alpha,   &
                                      beta,expn,gamma,sgr,hm_ovendry, &
                                      beta_ovendry,w0_ovendry,        &
                                      cp0_ovendry, ref_dens,gacc       
      real*8, intent(inout)        :: sw,relperm,relpermg,sg                    
                                                                       
      real*8                       :: satfpres,relpfsat,relpfsat_g,   &
                                      swr1,xh_ovendry,relperm_ovendry,&
                                      expn_loc, alpha_loc,h,hm,hg 
                                                                       
                                                                       
      real*8, parameter :: r1 = 1.0d0, r4 = 4.0d0, r0=0.0d0,          &
                           r100 = 100.0d0


!c      !c to test using regular soil parameter function
!c      real*8 :: pressure_h, alpha_h, rcvt, rdummy
!c      external :: soilparm
!c      rdummy = r0
!c      rcvt = ref_dens * gacc
!c      pressure_h = pressure/rcvt
!c      alpha_h = alpha*rcvt
!c      call soilparm(pressure_h,pressure_h,sw,sw,sn,                    &
!c                    rdummy,rdummy,rdummy,rdummy,aentry,                &
!c                    swr,alpha_h,beta,gamma,expn,                       &
!c                    relperm,relpermg,.false.,.false.,.false.,.false.,  &
!c                    .true.,.false.,.false.,.false.,.false.,            &
!c                    rdummy,rdummy,rdummy)
!c      return

!c  compute soil hydraulic parameters 
!c Note: For this pressure-based formulation

!c aentry() converted to pressure units in inippdd.f90
!c spalpha() divided by (gacc * ref_dens) in initppdd.f90
!c spbeta() and spgamma() unchanged 

        
        if (pressure<aentry) then ! aentry() converted to pressure
          
          if (isovendrying) then
            h = pressure * r100 / (ref_dens * gacc)
            hm = hm_ovendry * r100 / (ref_dens * gacc)
            hg = aentry * r100 / (ref_dens * gacc)
            alpha_loc = alpha * (ref_dens * gacc)/r100
            swr1=xh_ovendry(h,r1,hm)*swr
          else
            swr1=swr
          end if
          
          sw = satfpres(swr1,aentry,pressure,alpha,beta,gamma)
          
          if (napl_permeability) then
            sw = sw - sn
          end if

          if (napl_permeability.and.napl_kfunction .eq. 'corey') then
            relperm = ((sw - swr)/(r1 - swr))**r4
          else !use van genuchten funtion
            if (isovendrying) then
              relperm = relperm_ovendry(sw,swr,expn,alpha_loc,beta,   &
     &                                  gamma,r1,h,hm,hg,w0_ovendry,  &
     &                                  cp0_ovendry)
            else  
              relperm = relpfsat(sw,swr1,expn,gamma)
            end if
          end if
          
          relpermg = relpfsat_g(sw,swr1,expn,gamma)
     
        else !air saturation = 0

          if (napl_permeability) then
            sw = r1 - sn
            if(napl_kfunction .eq. 'corey') then
              relperm = ((sw - swr)/(r1 - swr1))**r4
            else  !VG function
              relperm = relpfsat(sw,swr,expn,gamma)
            end if
            
            relpermg = relpfsat_g(sw,swr,expn,gamma)
                
          else !no NAPL present in domain
            sw = r1
            relperm = r1
            relpermg = r0
          end if
        end if !(uvsnew .lt.aentry)
        
        if (napl_permeability) then 
            sg = r1-sw-sn
        else
            sg = r1 - sw + sgr
        end if

        return
        
      end
