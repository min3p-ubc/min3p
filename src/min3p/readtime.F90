!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readtime.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readtime
!c -------------------
!c
!c this subroutine reads a section from the input file unit nin 
!c the block has to start with 'start of target read time input' and has 
!c to end with 'end of target read time input'. The index of the target 
!c read time has to correspond to the current target read time, data 
!c is written to unit nout for further processing in the main program. 
!c comment lines starting with ! are skipped  
!c both units are rewound after the procedure is finished
!c
!c written by:      Uli Mayer - February 23, 97
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ---------- 
!c           iilog              = unit number, log book               + -
!c           itsrc              = index for current target read time  + -
!c           nin                = id number of input file             + -
!c           nout               = id number of output file            + -
!c
!c           character:
!c           ----------
!c
!c           found              = .true.  -> zone was found in input  * +
!c                                           file
!c
!c common:   -
!c
!c local:    integer*4:
!c           ----------
!c           itsrc_temp         = temporary index for target read 
!c                                time in input file
!c
!c           character:
!c           ----------
!c           dummy1             = dummy character string
!c           dummy2             = dummy character string
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readtime (nin,nout,ilog,itsrc,found)
      
      use gen, only : rank, b_enable_output
#ifdef PETSC      
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      
      implicit none
      
      integer :: nin,nout,ilog,itsrc
      
      integer :: itsrc_temp

      logical found
      character*72 dummy1, dummy2
      character*256 :: strbuffer

      found = .false.
 
!c  rewind unit nout from previous read-procedure in main routine
 
      rewind(nin)
      rewind(nout)
 
!c  read and write procedure
 
100   continue
      read(nin,*,end=400,err=999) dummy1
      if (dummy1.eq.'start of target read time input') then
        read(nin,*,err=999) itsrc_temp
        if (itsrc_temp.eq.itsrc) then
          found = .true.
        else
          goto 100
        end if
200     continue
        read(nin,*,end=500,err=999) dummy1
        backspace(nin) 
        read(nin,'(a)',err=999) dummy2
        if (dummy2(1:1).ne.'!') then
          write(nout,'(a)') dummy2
        end if
        if (dummy1.eq.'end of target read time input') then
          goto 300
        end if
        goto 200
      else
        goto 100
      end if
 
300   continue
 
      rewind nin
      rewind nout
  
400   return 

500   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'marker "end of target read time input" not found'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(nin)
      read(nin,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in time data: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in time data: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
