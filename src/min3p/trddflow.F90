!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/trddflow.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine trddflow
!c -------------------
!c
!c driver subroutine for transient density dependent flow 
!c
!c written by:      Tom Henderson - August 22, 2002
!c
!c last modified:   Tom Henderson - June 21, 2003
!c                  
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           ilog               = unit number, log file               + -
!c           idetail_vs         = information level                   + -
!c                                (variably saturated flow)    
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c dens.f:   logical:
!c           --------
!c           flow_verification  = .true.  -> verify pressure formulation
!c                                           for constant density 
!c                                           test problem
!c local:    - 
!c
!c external: ddfsflow  = driver subroutine for fully saturated 
!c                       density dependent flow 
!c           ddvsflow  = driver subroutine for variably saturated 
!c                       density dependent flow
!c           ddtds     = assign fluid densities as a function of 
!c                       total component concentrations
!c ----------------------------------------------------------------------

      subroutine trddflow
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use dens
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i, ivol, info_debug 
      
      real*8 :: density_old, density_new, density_update

      external ddvsflow, ddfsflow
      
      info_debug = 0

      if(rank == 0 .and. b_enable_output) then      !if MPI rank 0

      if (idetail_vs.gt.0) then
        if (fully_saturated) then
          write(ilog,'(2a)')'density dependent transient flow - ',    &
                 'saturated conditions'                                
        elseif (variably_saturated) then                               
          write(ilog,'(2a)')'density dependent transient flow - ',    &
                       'variably saturated conditions'
        end if !fully saturated
        write(ilog,'(72a/)')('-',i=1,72)
      end if
     
      end if                  !end if MPI rank 0


!c for fully saturated density dependent flow

      if (fully_saturated) then
        !Parallelized, OpenMP, DSU  
        call ddfsflow  
        
!c for variably saturated density dependent flow

      elseif (variably_saturated) then
        !Parallelized, OpenMP, DSU  
        call ddvsflow       
      end if

!c for decoupled heat transport
      if (.not. reduce_timestep) then
        if (heat_transport .and. decoupled_type_vs_heat > 1) then
          call heattran
        end if 
      end if

!cdbg
#ifdef DEBUG
      if (info_debug.gt.0) then
        write(idbg,'(/a,ES9.2)') 'time = ',time_io
        write(idbg,'(72a/)')('-',i=1,72)
    
!c      dens_h2o = 1.0d+3

        write(idbg,'(a,3a/)') 'ivol   ',                              &
                               'density update       ',               &
                               'density old          ',               &
                                 'density new          '

        do ivol=1,nngl                                                   
          density_old = ref_dens + drho_dc * tds_old(ivol)             
          density_new = ref_dens + drho_dc * tds_new(ivol)
          density_update = density_new - density_old
                                                                       
          write(idbg,'(I3,3es20.10)') ivol,density_update,            &
                                      density_old,density_new
        end do
      end if
 
      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
#endif
!cdbg
      return
      end
