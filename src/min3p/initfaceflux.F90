!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initfaceflux.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initfaceflux
!c -----------------
!c
!c initialize parameters for interface flux 
!c
!c written by:      Danyang Su - Nov 27, 2017
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c
!c passed:   integer*4:
!c           ----------
!c           ivol               = pointer to current control volume   + -
!c           jvol               = pointer to current control volume   + -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c
!c           logical:
!c           --------
!c
!c
!c local:    real*8:
!c           ------- 
!c
!c external: rootwat   = compute rate of root water uptake
!c --------------------------------------------------------------------------

      subroutine initfaceflux
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use gen
      
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

!c  local variables
      integer :: ivol, jvol, ivol2, jvol2, igb, i1, idim, ipair, ilink,&
                 ivx, ivy, ivz, istart, iend
      integer :: npair(3), cvpair(3,12,2)
      real*8 :: vl
      real*8 :: aread(3,12),areax(3,12),dist(3,12)
      
      external cliqdisp

!c  check if the two input volumes are linked and assign edge index
      do igb = 1,ngb_ijface
        ivol = ngb_vol_ijface(1,igb)
        jvol = ngb_vol_ijface(2,igb)

        if (ivol == jvol .or. ivol <= 0 .or. jvol <= 0) then
          if (rank == 0) then  
            write(ilog,'(a)') 'Warning from initopgs-4'
            write(ilog,'(2a,3(a,1x,i6,1x))')                           &
                  'control volumes for interface ',                    &
                  'fluxes output are the same or not local, ',         &
                  'interface pair', igb,                               &
                  'ivol',ivol,'jvol',jvol                              
            write(ilog,*) 'check section "output control" ',           &
                          'in input file'
          end if
          cycle
        end if

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1
        ngb_vol_ijface_jtemp(igb) = 0
        do i1 = istart, iend
          if (javs(i1) == jvol) then
            ngb_vol_ijface_jtemp(igb) = i1
            exit
          end if
        end do

        if (ngb_vol_ijface_jtemp(igb) < 1) then
          if (rank == 0) then  
            write(ilog,*) 'Warning from initopgs-5'
            write(ilog,'(2a,3(a,1x,i6,1x))')                           &
                  'control volumes for interface ',                    &
                  'fluxes output are not found, ',                     &
                  'interface pair', igb,                               &
                  'ivol',ivol,'jvol',jvol                              
            write(ilog,*) 'check section "output control" ',           &
                          'in input file'
          end if
        end if
      end do

!c  calculate interface area for the linked ivol-jvol, 

      do igb = 1,ngb_ijface
        do ilink = 1, 2  
          ivol = ngb_vol_ijface(ilink,igb)
          jvol = ngb_vol_ijface(3-ilink,igb)
          
          if (ivol == jvol .or. ivol <= 0 .or. jvol <= 0) then
            cycle
          end if

          if (ilink == 1) then
            vl = sqrt((xg(jvol)-xg(ivol))**2+(yg(jvol)-yg(ivol))**2+   &
                      (zg(jvol)-zg(ivol))**2)
            ngb_vol_ijface_velratio(1,igb) = (xg(jvol)-xg(ivol))/vl
            ngb_vol_ijface_velratio(2,igb) = (yg(jvol)-yg(ivol))/vl
            ngb_vol_ijface_velratio(3,igb) = (zg(jvol)-zg(ivol))/vl
          end if
          
          ivz = ceiling(ivol*1.0d0/nvxgl/nvygl)
          ivy = ceiling((ivol-(ivz-1)*nvxgl*nvygl)*1.0d0/nvxgl)
          ivx = ivol-(ivz-1)*nvxgl*nvygl-(ivy-1)*nvxgl  
              
!c  find node pairs for interfacial velocities
          call cliqdisp (nvxgl,nvygl,nvzgl,ivx,ivy,ivz,              &
                         cvpair,npair,aread,areax,dist,dimcv,        &
                         half_cells,iavs,javs,njavs,                 &
                         nngl,idbg,cinfrad,radial_coord)
           
!c  loop over the dimensions x,y,z           
          do idim = 1, 3
!c  loop over the number of control volume pairs in the dimension
            do ipair = 1, npair(idim)
           
              ivol2 = cvpair(idim, ipair, 1)
              jvol2 = cvpair(idim, ipair, 2)
         
!c  calculate average interfacial area between nodes
!cprovi------------------------------------------------
!cprovi Assign the interfacial area
!cprovi------------------------------------------------  
              if ((ivol2 == ivol .and. jvol2 == jvol) .or.           &
                  (ivol2 == jvol .and. jvol2 == ivol)) then
                ngb_vol_ijface_area(igb) = areax(idim, ipair)
                goto 500
              end if
            end do
          end do  
500       continue   
        end do

        if (ngb_vol_ijface_area(igb) <= 0.0d0) then
          if (rank == 0) then
            write(ilog,*) 'Warning: interfacial area is zero'
          end if
        end if            
      end do
        
      return
      end
