!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readtemp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readtemp
!c ------------------
!c
!c read time-dependent temperature data
!c
!c written by:      Uli Mayer - July 1, 1999
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:    -
!c
!c common: 
!c gen.f:    real*8:
!c           -------
!c           time_io            = current solution time (I/O units)   + -
!c
!c           integer*4:
!c           ----------
!c           item               = unit number, temperature data       - +
!c
!c chem.f:   real*8:
!c           -------
!c           dt_tmp             = time increment in temperature data  - +
!c                                file
!c           tmp(ntmp)          = specified depth dependent           - +
!c                                temperatures [K]
!c           tmp_read           = time to read next temperature       - +
!c           tconv              = temperature correction factor       + -
!c 
!c           integer*4:
!c           ---------- 
!c           ntmp               = number of temperature points        - +
!c
!c           logical:
!c           --------
!c           update_temp        = .true.  -> update time-dependent    * +
!c                                           temperature field
!c
!c local:    real*8:
!c           -------
!c           dummy              = dummy variable
!c
!c           integer*4:
!c           ----------
!c           i                  = counter
!c
!c external:  -
!c ----------------------------------------------------------------------
 
      subroutine readtemp
 
      use parm
      use gen
      use chem
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      real*8 :: dummy
      integer :: i
      character*256 :: strbuffer

      update_temp = .false.

      if (time_io.gt.tmp_read) then

!c  define next read time

        do while (tmp_read.lt.time_io) 

          update_temp = .true.
          tmp_read = tmp_read + dt_tmp

!c  read temperature data
    
          goto 1000

999       rewind(item)
          read(item,*,err=9999) dummy
          dummy = dummy

1000      read(item,*,end=999,err=9999) (tmp(i),i=1,ntmp)

        end do

!c  assign new temperature data

        do i = 1,ntmp
          tmp(i) = tmp(i) + tconv
        end do

      end if

      return

9999  continue
      backspace(item)
      read(item,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in temperature data: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in temperature data: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
