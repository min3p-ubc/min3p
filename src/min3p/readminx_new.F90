!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readminx_new.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readminx_new
!c -----------------------
!c
!c read database for excluded minerals and assign to permanent storage
!c
!c written by:      Uli Mayer - September 6, 97
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           imdbs              = unit number - databse for minerals  + -
!c           ilog               = unit number - logbook               + -
!c           idbg               = unit number - debugging file        + -
!c           ipsp               = unit number, list of possible       + -
!c                                             secondary aqueous
!c                                             species, gases and
!c                                             minerals
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           dhcmx(nmx)         = enthalpy change of dissolution-     * +
!c                                precipitation reaction
!c                                (excluded minerals)
!c           eqmxs(nmx)         = equilibrium constants for excluded  * +
!c                                minerals at standard temperature
!c           xnumx(nmx*nc)      = stoichiometric coefficients of free * +
!c                                species in mineral
!c
!c           integer*4:
!c           ----------
!c           iamx(nmx+1)        = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamx(nmx*nc)       = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           nc                 = number of components                + -
!c           nmx                = number of excluded minerals         + -
!c
!c           logical:
!c           --------
!c           search_database    = .true.  -> search database for      + -
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c           temp_corr          = .true.  -> specify constant         + -
!c                                           temperature
!c                                .false. -> use standard
!c                                           temperature
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namemx(nmx)        = mineral names                       + -
!c           namet(30)          = species names (temporary)           * *
!c
!c local:    real*8:
!c           -------
!c           eqt                = equilibrium constant (temporary)
!c           r0                 = constant
!c           r10                = constant
!c           xnumt(100)         = array for temporary storage of 
!c                                stoichiometric coefficients of
!c                                component in mineral
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           icount             = counter (check number of species)
!c           icur               = counter (position in compressed
!c                                         array)
!c           iend               = pointer
!c           imx                = counter (minerals)
!c           istart             = pointer 
!c           iv                 = counter (temporarily stored values)
!c           l_name             = length of name
!c           nv                 = number of temporarily stored 
!c                                values
!c
!c           logical:
!c           --------
!c           comment_line       = .true.  -> read comment line
!c           done               = .true.  -> exit search
!c           found              = .true.  -> exit search
!c           next_entry         = .true.  -> database entry for 
!c                                           next mineral
!c
!c           character:
!c           ----------
!c           junk               = character variable for forwind in
!c                                mineral.dbs
!c           name               = name of mineral currently 
!c                                processed
!c           string1            = character string 
!c           string2            = character string 
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readminx_new(imdbs,ipsp,ilog,idbg,igen)
 
      use parm
      use chem
      use gen, only : rank, b_enable_output, idbs_bk, use_dbs_bk
      use file_utility, only : makelowercase, replacecharacter,        &
                               readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif 
      implicit none
      
      integer :: imdbs,ipsp,ilog,idbg,igen
      
      integer :: i, ic, icur, icount, imx, iv, istart ,iend,           &
                 info_debug, l_name, nv
      
      real*8 :: xnumt

      character*1 junk
      character*72 name
      character*72 string1, string2
      character*1024 :: strbuffer
      character*1, parameter :: strspace = ' '
      dimension xnumt(100)
      logical comment_line,done,found,next_entry

      real*8, parameter :: r0 = 0.0d0, r10 = 10.0d0  

      info_debug = 0
      l_name = 0

!c  search database for possible secondary aqueous species

      if (search_database) then
          
        if (rank == 0 .and. b_enable_output) then
          write(ipsp,'(/a)') 'minerals'
          write(ipsp,'(a/)') '--------'
        end if

        do while(.true.)

!c  skip over comment lines in database

          comment_line = .true.
          do while (comment_line)
            read (imdbs,'(a1)',err=996) junk
            if (junk.ne.'!') comment_line = .false.
          end do

!c  backspace to start of database entry for current mineral

          backspace(imdbs)

!c  read mineral name

          read(imdbs,*,err=996,end=999) name
          if (info_debug.gt.1) then
            write(*,*) trim(name)
          end if

!c  exit search, if end of database is reached

          if (name.eq.'end') goto 999

!c  read reaction type of dissolution-precipitation reaction,
!c  as well as names and stoichiometric coefficients of components
!c  constituting mineral

          read(imdbs,*,err=996) string1
          read(imdbs,*,err=996) junk
        
          if (space_delimiter_dbs) then                 !merged space delimiters
            read(imdbs,'(a)',end=996,err=996) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 996
            end if
            read(strbuffer,*,end=996,err=996) nv

            do iv = 1, nv
              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              namet(iv) = strbuffer(1:iend-1)

              strbuffer = trim(adjustl(strbuffer(iend:)))
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=996,err=996) xnumt(iv)
            end do
          else
            read(imdbs,*,err=996) nv,(namet(iv),xnumt(iv),iv=1,nv)
          end if

!c  check if all components for mineral are specified in general
!c  input file
!c  set up pointer array to column in stoichiometric matrix

          icount = 0
          ic = 0

          do while ((icount.lt.nv).and.(ic.lt.nc))
            ic = ic+1
            iv = 0
            found = .false.
            do while ((iv.lt.nv).and.(.not.found))
              iv = iv+1
              if (namet(iv).eq.namec(ic)) then
                found = .true.
                icount = icount+1
              end if
            end do
          end do

!c  report all possible minerals

          if (icount.eq.nv) then
             l_name = index(name,' ')-1
             if (l_name.gt.72.or.l_name.eq.-1) then
               l_name = 72
             end if
             if (rank == 0 .and. b_enable_output) then
               write(ipsp,'(3a)') "'",name(:l_name),"'"
             end if
          end if

!c  search for next comment line

          comment_line = .false.
          do while (.not.comment_line)
            read (imdbs,'(a1)',err=996) junk
            if (junk.eq.'!') comment_line = .true.
          end do

        end do             !loop over minerals in database

999     continue

!c  rewind database file

        rewind(imdbs)

      end if               !search_database

!c read specified excluded minerals from database

      if (nmx.gt.0) then

!c initialize pointer arrays for compressed storage
 
        iamx(1) = 1
 
!c  loop over excluded minerals specified for simulation
 
        do imx = 1,nmx
 
!c  loop over minerals in database,
!c  search for match 
!c  read all stoichiometric coefficients and equilibrium constants
!c  and store in compressed format, exit when done or if mineral 
!c  not found
 
          done = .false.
 
          do while (.not.done)
 
!c  skip over comment lines in database

            comment_line = .true.
            do while (comment_line)
              read (imdbs,'(a1)',err=997) junk
              if (junk.ne.'!') comment_line = .false.
            end do

!c  backspace to start of database entry for current mineral

            backspace(imdbs) 

!c  read mineral name
 
            read(imdbs,*,err=997) name
 
!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  mineral is found --> read data
 
            if (name.eq.namemx(imx)) then
                
 
              done = .true.

!c  read equilibrium constant and reaction stoichiometry

              read(imdbs,*,err=997) string1
              if (temp_corr) then
                read(imdbs,*,err=997) junk,junk
              else
                read(imdbs,*,err=997) junk
              end if
              read(imdbs,*,err=997) nv,(namet(iv),xnumt(iv),iv=1,nv)
                                                                       
              read(imdbs,*,err=997) string2
                                                                       
              if (string2.eq.'dissolution_far_from_equilibrium' .or.   &
                  string2.eq.'precipitation_far_from_equilibrium') then
                  
                if (rank == 0) then  
                  write(ilog,*) 'SIMULATION TERMINATED'                  
                  write(ilog,*) 'error in input file'                    
                  write(ilog,*) 'excluded mineral is of type ',        &
                             '"far from equilibrium"'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              else
                backspace(imdbs)
                read(imdbs,*, err=997) string2,eqmxs(imx),dhcmx(imx)
                eqmxs(imx) = r10 ** (-eqmxs(imx))

!cdhr - corrected April 06
                if (dhc_reverse) then
                  dhcmx(imx) = dhcmx(imx)
                else
                  dhcmx(imx) = -dhcmx(imx)
                end if
!cdsu - further check is needed here, the orginal isotope model 
!cdsu   does not include the above correction. Danyang Su, 2015-01-26
              end if
 
!c  pointer array to row in stoichiometric reaction matrix for 
!c  next mineral

              iamx(imx+1) = iamx(imx)+nv
 
!c  check if all components for mineral are specified in general 
!c  input file
!c  set up pointer array to column in stoichiometric matrix
        
              icount = 0
              ic = 0
              do while ((icount.lt.nv).and.(ic.lt.nc))
                ic = ic+1
                iv = 0
                found = .false.
                do while ((iv.lt.nv).and.(.not.found))
                  iv = iv+1
                  if (namet(iv).eq.namec(ic)) then
                    found = .true.
                    icount = icount+1
                    icur = iamx(imx)+iv-1
                    jamx(icur) = ic
                  end if
                end do
              end do
 
!c  if component is missing, exit
 
              if (icount.ne.nv) then
                if (rank == 0) then  
                  write(ilog,'(72a)') ('-',i=1,72)
                  write(ilog,'(a,a12,a)')'component for ',      &
                                       name,' is missing'
                  write(ilog,'(72a)') ('-',i=1,72)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
 
!c  all components available --> read data and assign to arrays
 
              elseif (icount.eq.nv) then
 
!c  assign stoichiometric coefficients
 
                istart = iamx(imx)
                iend = iamx(imx+1)-1
                iv = 0
                do i = istart,iend
                  iv = iv+1
                  xnumx(i) = xnumt(iv) 
                end do
 
!c  rewind mineral database to search for next mineral, doing this
!c  allows the specification of minerals in an arbitray order
 
                rewind(imdbs)
 
              end if
 
!c  go to next mineral, if no match was found
  
            elseif ((name.ne.namemx(imx)).and.(name.ne.'end')) then

              next_entry = .false.
              do while (.not.next_entry)
                read (imdbs,'(a1)',err=997) junk
                if (junk.eq.'!') then
                  next_entry = .true.
                end if
              end do

              backspace(imdbs)
 
!c  exit if end of file is reached and mineral specified was not found
 
            elseif (name.eq.'end') then
              if (rank == 0) then
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(3a)') 'mineral ',trim(namemx(imx)),       &
                                   ' not in database - check input file'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop

            end if
          end do                 !end - loop over minerals database
        end do                   !end - loop over specified minerals

!cdsu write warning information for sign switch in the value of enthaply change
        if (dhc_reverse) then
          if (rank == 0 .and. b_enable_output) then
            write(ilog,'(72a)') ('-',i=1,72)
            write(ilog,'(2a)') 'warning: enthalpy change for',         &
                               ' excluded mineral is reversed'
            write(ilog,'(72a)') ('-',i=1,72)

            write(igen,'(72a)') ('-',i=1,72)
            write(igen,'(2a)') 'warning: enthalpy change for',         &
                               ' excluded mineral is reversed'
            write(igen,'(72a)') ('-',i=1,72)
          end if 
        end if       

      end if                     !(nmx,gt.0)

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(*,'(1x,a)') 'start of database backup: mineral.dbs'
          write(idbs_bk, '(a)') '<------ mineral(x).dbs: start of excluded minerals ------>'      
          do imx = 1,nmx
            rewind(imdbs)
            do while(.true.)
              if (readnextline(imdbs,strbuffer,lowercase=.false.,          &
                  original=.true.)) then
                if (index(adjustl(strbuffer),trim(namemx(imx))) == 2) then            !note, mineral name has quotes
                  write(idbs_bk,'(a)') trim(strbuffer)
                  do while(readnextline(imdbs,strbuffer,lowercase=.false., &
                           withcomment=.true.,original=.true.))
                    if (index(adjustl(strbuffer), '!') == 1 .or.           &
                        trim(adjustl(strbuffer)).eq."'end'") then
                      write(idbs_bk,'(a)') trim(strbuffer)
                      exit
                    else
                      write(idbs_bk,'(a)') trim(strbuffer)
                    end if
                  end do
                  exit
                end if
              end if
            end do
          end do
          rewind(imdbs)
          !write(idbs_bk, '(a)') "'end'" 
          write(idbs_bk, '(a/)') '<------ mineral(x).dbs: end of excluded minerals ------>'
          write(*,'(1x,a)') 'end of database backup: mineral.dbs'
        end if
      end if

      goto 1000

996   continue
      backspace(imdbs)
      read(imdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error in searching excluded minerals (readminx_new.F90): ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error in searching excluded minerals (readminx_new.F90): ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop 
      
997   continue
      backspace(imdbs)
      read(imdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error in loop over excluded minerals (readminx_new.F90): ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error in loop over excluded minerals (readminx_new.F90): ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop 

!cdbg ---- activate this section for purposes of debugging -----
 
1000  continue
     
#ifdef DEBUG
      if (info_debug.gt.0) then

        write(idbg,'(a)') 'returning from readminx ...'

        do imx=1,nmx

          write(idbg,'(a72,1x,a72)') namemx(imx)
          write(idbg,'(a,1pe15.6e3)') 'eqmxs  ',-dlog10(eqmxs(imx))
          write(idbg,'(a,1pe15.6e3)') 'dhcmx  ',dhcmx(imx)
          write(idbg,'(a,i10)') 'iamx    ',iamx(imx)
 
!c  echo check for stoichiometric coefficients 
 
          istart = iamx(imx)
          iend = iamx(imx+1)-1
          do i = istart, iend
            icur = jamx(i)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i,namec(icur),  &
                       ' jamx ',jamx(i),' xnumx ',xnumx(i)
          end do
 
        end do
      end if

      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif 
        stop
      end if
#endif
!cdbg
 
      return
      end
  
