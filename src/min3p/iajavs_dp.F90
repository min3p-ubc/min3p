!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 609 $
!> $Author: dsu $
!> $Date: 2018-09-14 11:47:55 -0700 (Fri, 14 Sep 2018) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/iajavs_dp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine iajavs_dp
!c --------------------
!c
!c set up ia-ja data-structure for variably saturated flow - 
!c secondary porosity, by duplicationg existing ia-ja structure 
!c      
!c                z
!c                     y
!c                7  
!c                |  5                  local connection list 
!c                | /                   for ja pointer array
!c                |/                    
!c       2--------1----------3  x     
!c               /|
!c              / |
!c             4  |
!c                6
!c
!c nonexistent connections (1D-2D-boundary effects) are skipped:
!c
!c      z
!c            
!c      4                     e.g.
!c      |                     x-z plane - on boundary x=0
!c      |                     
!c      |                     
!c      1----------2  x     
!c      |
!c      |
!c      |
!c      3
!c
!c written by:      Uli Mayer - July 7, 02 
!c
!c last modified:   -
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c
!c gen.f:    integer*4:
!c           ---------- 
!c           idbg               = unit number, debugging file         + -
!c           ilog               = unit number, logbook                + -
!c           nn                 = total number of control volumes     + -
!c           iavs(nn+1)         = row pointer array for avs           * +
!c           javs(njavs)        = connectivity list                   * +
!c           isymvs(njavs)      = symmetry pointer array              * +
!c           njavs              = number of global connections        * +
!c
!c local:    idebug             = key for activation of debug output  
!c           irow               = counter (rows)
!c           i1                 = counter (column entries in row)
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine iajavs_dp
 
      use parm
      use gen
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: i1, irow, istart, istop, idebug
      
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_iajavs_dp_1)                    &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (i1, irow)
#endif 
      
!c  allocate row pointer array for secondary porosity
#ifdef OPENMP
    !$omp do schedule(static)
#endif
      do irow = 2,nngl+1
        iavs(irow+nngl) = iavs(irow)+njavs
      end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef PETSC
      do irow = 1,nngl
        row_idx_l2pg_vs(irow+nngl) = node_idx_lg2pg(irow) + nngbl
        if(node_idx_lg2l(irow) < 0) then
            row_idx_l2pg_vs(irow+nngl) = - row_idx_l2pg_vs(irow+nngl)
        end if
      end do
#endif

!c  allocate column pointer array for secondary porosity
#ifdef OPENMP
    !$omp do schedule(static)
#endif
      do i1 = 1,njavs
        javs(i1+njavs) = javs(i1)+nngl
#ifdef PETSC
        col_idx_l2pg_vs(i1+njavs) = node_idx_lg2pg(javs(i1)) + nngbl
#endif
      end do
#ifdef OPENMP
    !$omp end do
#endif  

#ifdef OPENMP
    !$omp barrier
#endif

!c  allocate symmetry pointer for secondary porosity
#ifdef OPENMP
    !$omp do schedule(static)
#endif
      do i1 = 1,njavs
        isymvs(i1+njavs) = isymvs(i1)+njavs
      end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef OPENMP
    !$omp end parallel
#endif      

!c  redefine total number of entries in column and symmetry pointer

      njavs = 2*njavs
      
      

!cdbg
#ifdef DEBUG
      idebug = 0
      if (idebug.gt.0) then
        do irow=nngl+1,2*nngl+1
          write(idbg,*) 'ia(',irow,') = ',iavs(irow)
        end do
        do irow=nngl+1,2*nngl
          istart = iavs(irow)
          istop = iavs(irow+1)-1
          write(idbg,*) ('ja(',i1,') = ',javs(i1),i1=istart,istop)
        end do
        do irow=nngl+1,2*nngl
          istart = iavs(irow)
          istop = iavs(irow+1)-1
          write(idbg,*) ('isymvs(',i1,') = ',isymvs(i1),i1=istart,istop)
        end do
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
#endif
!cdbg
      return
      end
