!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/gas_advection/dfluxvg.F90 $
!---------------------------------------------------------------------
!********************************************************************!
    
!c ----------------------------------------------------------------------
!c real*8 function dfluxvg
!c ------------------------
!c
!c compute derivative of advective mass flux of ideal gases
!c
!c written by:  Sergi Molins - May 2, 2006
!c
!c modified by: Danyang Su - March 26, 2014
!c
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           totg               = total gaseous component             + -
!c                                concentration at interface i-j
!c           dtotg              = derivative total gaseous component  + -
!c                                concentration at interface i-j
!c           gpi                = gas pressure at control volume i    + -
!c           gpj                = gas pressure at control volume j    + -
!c           zgi                = elevation at control volume i       + -
!c           zgj                = elevation at control volume j       + -
!c           dens               = gas density at interface i-j        + -
!c           ddensi             = derivative of density at i-j        + -
!c           visc               = gas viscosity at interface i-j      + -
!c           relp               = relative gas permeability at i-j    + -
!c           cinfvs_gx          = influence coefficient for           + -
!c                                gas advection at interface i-j      
!c           factor             = weighting factor to compute         + -
!c                                derivative term at interface i-j
!c                                (see wgpropd.f subroutine)  
!c           dfluxvg            = derivative of advective mass flux   * +
!c           gacc               = gravity m s^-2                      + -
!c
!c           logical:
!c           -------
!c           gas_gravity        = enable gas gravity in advection     + -
!c gen.f:    real*8:
!c           -------
!c           gacc               = gravity m s^-2                      + -
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           grad1            = gradient
!c           grad2            = gradient
!c
!c external: -  
!c ----------------------------------------------------------------------
      real*8 function dfluxvg                         &
     &                       (totg      ,dtotg     ,  &
     &                        gpi       ,gpj       ,  &
     &                        dgpi      ,             &
     &                        zgi       ,zgj       ,  &
     &                        dens      ,ddensi    ,  &
     &                        visc      ,relp      ,  &
     &                        cinfvs_gx ,factor    ,  &
     &                        gas_gravity, gacc)
    
      implicit none

!c  passed
      real*8       totg      ,dtotg     ,   &
     &             gpi       ,gpj       ,   &
     &             dgpi      ,              & 
     &             zgi       ,zgj       ,   &
     &             dens      ,ddensi    ,   &
     &             visc      ,relp      ,   &
     &             cinfvs_gx ,factor    ,   &
     &             gacc    
      
      logical :: gas_gravity
    
!c  internal
      real*8       grad1     ,grad2

!c     compute gradients
      grad1 = - gpj + gpi ! - (   gpj - gpi) 
      grad2 =   dgpi      ! - ( - dgpi     )
  
      if (gas_gravity) then
    
        grad1 = grad1 - dens   * gacc * (zgj - zgi)
        grad2 = grad2 - factor * ddensi * gacc * (zgj - zgi)

      endif

!c     compute specific discharge
      dfluxvg = cinfvs_gx * relp / visc * ( factor * grad1 * dtotg +  &
     &                                               grad2 * totg  )
      return
      end