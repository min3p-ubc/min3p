!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 726 $
!> $Author: dsu $
!> $Date: 2019-08-07 11:30:33 -0700 (Wed, 07 Aug 2019) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initgeom.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initgeom
!c -------------------
!c
!c geometrical parameters for minerals
!c
!c written by:      Uli Mayer - March 12, 95
!c
!c last modified:   Uli Mayer - February 5, 98
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           im                 = pointer (minerals)                  + -
!c           idbg               = unit number - debugging file        + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           areac(nm)          = reactivity term                     + +
!c           areainit(nm)       = initial reactivity term             * +
!c           cmcnew(nm,nthreads)= concentration of minerals           * +
!c                                - new time level [moles/l bulk]
!c           cmcold(nm,nthreads)= concentration of minerals           * +
!c                                - old time level [moles/l bulk]
!c           cmcmin(nm,nthreads)= min. concentration of minerals      * +
!c                                [moles/l bulk]
!c           densm(nm)          = densities of minerals               + -
!c           gfwm(nm)           = gram formula weight of minerals     + -
!c           phic(nm)           = volume fractions of minerals        + -
!c           phicold(nm,nthreads)  
!c                              = volume fractions of minerals        + -
!c                                - old time level
!c           phiinit(nm,nthreads) 
!c                              = initial volume fractions of         - +
!c                                minerals
!c           phimin(nm)         = volume fractions of minerals for    + -
!c                                nucleation
!c           phinuc(nm)         = volume fractions of mineral for     * +
!c                                nucleation threshold
!c           radi(nm)           = initial radius of mineral particle  + -
!c           rads(nm,nthreads)  = radius of unreacted core of mineral + +
!c                                particle 
!c           radmin(nm)         = representative particle radius of   + -
!c                                nucleus
!c           iamp(nm+1)         = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c
!c           character:
!c           ----------
!c           rate_control(nm)   = rate controlling process for        + -
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled
!c                                              reaction
!c                                'transport' = transport controlled
!c                                              reaction
!c                                'mixed'     = mixed control
!c
!c local:    real*8:
!c           -------
!c           r3                 = constant
!c           r1000              = constant (unit conversion)
!c           satw               = saturation index 
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine initgeom(im,idbg)
 
      use parm
      use chem
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: tid, im, info_debug, idbg

      real*8 :: r3, r1000
      parameter (r3 = 3.0d0, r1000 = 1.0d3)
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif

!c  compute mineralogical parameters for minerals

      if (iamp(im+1)-iamp(im).gt.0) then

!c ---------------------------------------------------------------------- 
!c compute mineral concentrations [moles/l bulk] from mineral volume
!c fractions [m^3 mineral/m^3 bulk]
!c
!c phic(im)  = [m^3 mineral/m^3 bulk]
!c r1000     = [m^3 h2o/l h2o * cm^3 mineral/m^3 mineral]
!c           =  1.d-3         * 1.d+6
!c           =  1.d+3
!c gfwm(im)  = [g/mole]
!c densm(im) = [g/cm^3]
!c
!c
!c [moles mineral / l bulk] =
!c
!c        [m^3 bulk/l bulk * cm^3 mineral/m^3 mineral]
!c         --------        ------------ -----------
!c      * [m^3 mineral/m^3 bulk] * [g mineral/cm^3 mineral] 
!c         ----------- ---------    --------- ------------
!c      * [moles mineral / g mineral]
!c                         ---------
!c ---------------------------------------------------------------------- 
 
!c no mineral phase present, assign minimum volume fraction
!c and radius of nucleus to allow formation of secondary phase

        if (phic(im,tid).lt.phimin(im)) then
          phic(im,:) = phimin(im)
          if (update_type(im).eq.'geometric') then
            radi(im) = radmin(im)
            rads(im,:) = radmin(im)
          end if
        end if

!c assign initial mineral volume fraction 
!c this value is needed for the calculation of transport controlled 
!c reaction rates, here it is assumed, that the volume fraction given 
!c in the input file is the total volume fraction of the mineral, if the 
!c mineral is partly reacted, the follwing section computes the actual 
!c mass still available for reaction, by multiplying the given mineral 
!c volume by the ratio unreacted volume/total volume.

        phiinit(im,:) = phic(im,:)
        phicold(im,:) = phic(im,:)

        if (update_type(im).eq.'geometric') then
          if (rate_control(im).eq.'transport'.and.                    &
     &        rads(im,tid).lt.radi(im)) then
            phic(im,tid) = (rads(im,tid)**r3/radi(im)**3)*phic(im,tid)
            phic(im,:) = phic(im,tid)
          end if
        end if

!c compute minimum mineral concentrations [moles/l bulk] from 
!c minimum mineral volume fractions [m^3 mineral/m^3 bulk]

        cmcmin(im,:) = r1000 * phimin(im) * densm(im) / gfwm(im)

!c compute mineral concentrations [moles/l bulk] from 
!c mineral volume fractions [m^3 mineral/m^3 bulk]

        cmcold(im,:) = r1000 * phic(im,tid) * densm(im) / gfwm(im)
        cmcnew(im,:) = cmcold(im,:)

!c  define relationships between reactivity term and representative
!c  particle radii 
!c

        if (update_type(im).eq.'geometric') then

!c  surface controlled reactions

          if (rate_control(im).eq.'surface') then

!c ---------------------------------------------------------------------- 
!c  compute initial reactivity term from representative particle radius
!c  ( = reactive surface area for surface controlled reactions)
!c
!c  for surface area in terms of [m^2 mineral / L bulk]
!c
!c       areac(im) = scalfac(im)*r3*phic(im)/rads(im)
!c
!c      [m^2 mineral / L bulk] = [m^3 mineral/ m^3 bulk]
!c                             / [m mineral] / [L bulk/m^3 bulk]
!c
!c ---------------------------------------------------------------------- 

            areac(im) = r3 * scalfac(im) * phic(im,tid) /             &
                        rads(im,tid) / r1000

!c  transport controlled reactions

          elseif (rate_control(im).eq.'transport') then

!c ---------------------------------------------------------------------- 
!c  compute initial reactivity term from initial radius                 
!c  and from radius of unreacted core of mineral particle
!c                                                                       
!c  radi(im)    = [m mineral]                                              
!c  rads(im)    = [m mineral]                                              
!c  phiinit(im) = [m^3 mineral / m^3 bulk]
!c  phic(im)    = [m^3 mineral / m^3 bulk]
!c                                                                       
!c  for reactivity term in terms of [m^2 mineral/ m^3 bulk]                 
!c  modified formulation                                                  
!c                                                                       
!c        areac(im) = scalfac(im) * r3 * phiinit(im) / radi(im)
!c    &             * rads(im) / ((radi(im)-rads(im)) * radi(im))
!c                                                                       
!c       [m mineral / m^3 bulk] = [m^3 mineral/m^3 bulk]   
!c                                 -----------              
!c                              * [m mineral] / [m^3 mineral]
!c                                               -----------
!c  or alternatively:
!c
!c        areac(im) = scalfac(im) * r3 * phic(im) / rads(im)
!c    &             * radi(im) / ((radi(im)-rads(im)) * rads(im))
!c                                                                       
!c       [m mineral / m^3 bulk] = [m^3 mineral/m^3 bulk] / [m mineral]
!c                                 -----------              ---------    
!c                              * [m mineral] / [m^2 mineral]
!c                                               -----------
!c ----------------------------------------------------------------------

            areac(im) = r3 * scalfac(im) * phic(im,tid) /             &
                        rads(im,tid) * radi(im) / ((radi(im)-         &
                        rads(im,tid)) * rads(im,tid))

          end if                    !rate_control(im)

        end if                      !update_type(im)

      end if                        !(iamp(im+1)-iamp(im).gt.0)

!c assign initial reactive surface area for two-third power relationship 
!c and user-specified power relationship
!c convert surface area units to [m^2 mineral / L bulk]

      if (update_type(im).eq.'twothird'.or.       &
          update_type(im).eq.'twothird-mix'.or.   &
          update_type(im).eq.'exponent2' .or.     &
          update_type(im).eq.'exponent'  .or.     &
          update_type(im).eq.'reactivity'.or.     &
          update_type(im).eq.'linear') then
        areainit(im) = areac(im)
     end if
     
!cdbg
      info_debug = 0
      !if (info_debug.gt.0.and.iamp(im+1)-iamp(im).gt.0) then
      !  write(idbg,'(a)')
      !  write(idbg,'(a,1x,a)') 'namem(im)   ', trim(namem(im))
      !  write(idbg,'(a,1x,1pe15.6e3)') 'areac(im)   ', areac(im)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'phic(im)    ', phic(im,tid)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'phimin(im)  ', phimin(im)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'phiinit(im) ', phiinit(im,tid)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'phinuc(im)  ', phinuc(im)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'cmcnew(im)  ', cmcnew(im,tid)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'cmcold(im)  ', cmcold(im,tid)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'rads(im)    ', rads(im,tid)
      !  write(idbg,'(a,1x,1pe15.6e3)') 'radi(im)    ', radi(im)
      !end if
      if (info_debug.eq.2) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
!cdbg
 
      return
      end
