!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 609 $
!> $Author: dsu $
!> $Date: 2018-09-14 11:47:55 -0700 (Fri, 14 Sep 2018) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/minmaxwd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine minmaxwd
!c -------------------
!c
!c determine minimum total aqueous component concentrations and maximum 
!c secondary aqueous species concentration in solution domain.
!c
!c written by:      Uli Mayer - April 26, 98
!c
!c last modified:   -
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           cx(nx)             = concentrations of secondary aqueous + -
!c                                species [moles/l water]
!c           totc(n)            = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l water]
!c
!c common:   
!c chem.f:   real*8:
!c           -------
!c           cxmax(nx)          = maximum concentration of secondary  * +
!c                                aqueous species in solution domain
!c           totcmin(n)         = minimum total aqueous component     * +
!c                                concentration in solution domain
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components excluding h2o  + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           
!c local:    integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ix                 = counter secondary aqueous species)
!c
!c           
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine minmaxwd(cx,totc)
 
      use parm
      use chem

      implicit none
      
      real*8 :: cx, totc

      dimension cx(*), totc(*)
      
      integer :: ic, ix

!c  define minimum total aqueous component concentrations in 
!c  solution domain

      do ic = 1,nc-1
        totcmin(ic) = dmin1(totcmin(ic), totc(ic))
      end do

!c  define maximum concentrations of secondary aqueous species in
!c  solution domain

      do ix = 1,nx
        cxmax(ix) = dmax1(cxmax(ix), cx(ix))
      end do

      return
      end

      !>
      !> calculate the maximum minumum values from all threads and processors
      !> for the parallel version
      !>
      subroutine minmaxwd_mpi

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
        use petscsys
#endif
#endif

        use chem, only : nc, nx, totcmin, cxmax, totcmin_gbl, cxmax_gbl

        implicit none

#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC
        PetscErrorCode :: ierrcode
#endif



#ifdef PETSC
        call MPI_Allreduce(totcmin,totcmin_gbl,nc-1,MPI_REAL8,MPI_MIN, &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        totcmin = totcmin_gbl

        call MPI_Allreduce(cxmax,cxmax_gbl,nx,MPI_REAL8,MPI_MAX,       &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        cxmax = cxmax_gbl
#endif

      end subroutine minmaxwd_mpi

