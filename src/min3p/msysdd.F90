!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/msysdd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine msysdd
!c -----------------
!c
!c total system mass (density dependent flow)
!c
!c modified from Uli Mayer template
!c
!c written by:      Tom Henderson - August 23, 2002
!c
!c last modified:   Tom Henderson - March 24, 2003
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           cvol(nn)           = nodal volumes                       + -
!c           pornew(nn)         = porosity                            + -
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           relperm(nn)        = relative permeability               + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           time_io            = current solution time (I/O units)   + -
!c           totvsmass          = total system mass                   * +
!c
!c           integer*4:
!c           ----------
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = curent time step                    + -
!c           nn                 = total number of control volumes     + -
!c           imvs               = unit number, mass balance -         * +
!c                                             variably saturated
!c                                             flow
!c           imvs_first         = pointer - first unit number for     + -
!c                                mass balance - variably saturated
!c                                               flow
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c dens.f:   real*8:
!c           -------
!c           density(nn)        = fluid density                        + -
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r1                 = constant
!c           totv_a             = total volume (aqueous phase)
!c           totv_g             = total gas (gaseous phase)
!c           vsmass             = system mass (local)
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c
!c external: stddmass = storage mass function for density dependent 
!c                      variably saturated flow
!c ----------------------------------------------------------------------

      subroutine msysdd

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif


      use parm
      use gen
      use dens
      use writeversion
      use phys, only : compressibility
      use file_utility, only : reposition_file
#ifdef OPENMP
      use omp_lib 
#endif

      use module_binary_mpiio, only : binary_write_data
      
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: ivol
      
      real*8 :: rpor, vsmass, totv_a, totv_g

      integer :: nvarsimvs, irecord
      
      real*8, external :: porosity_flow
      
#ifdef PETSC
      real*8 :: totvsmass_gbl, totv_a_gbl, totv_g_gbl
      PetscErrorCode :: ierrcode
#endif

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
!c  compute total system mass
!c  variably saturated conditions:
!c  replace uvsold and saold by 0 -> can use storage function 

      totvsmass = r0
      
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_msysdd_1)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol, rpor, vsmass)                                 &
    !$omp reduction(+:totvsmass)
    !$omp do schedule(static)
#endif 
      do ivol = 1,nngl  
          
          !exclude ghost nodes
#ifdef PETSC
          if(node_idx_lg2l(ivol) < 0) then
              cycle
          end if
#endif
          if (modify_por(ivol)) then
             rpor=porosity_flow(porold(ivol),                 &
                  uvsnew(ivol),uvsold(ivol),stor(ivol),       &
                  por_stress_dt(ivol),por_init(ivol),facpormin)   
          else
             rpor=pornew(ivol)
          end if
          
          vsmass = cvol(ivol) * sanew(ivol) * rpor * density(ivol)
          
          if (evaporation) then
            vsmass = vsmass + cvol(ivol)*sgnew(ivol)*rpor*densvnew(ivol)
          end if

          totvsmass = totvsmass + vsmass

      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef PETSC     
      call MPI_Allreduce(totvsmass, totvsmass_gbl,1,MPI_REAL8,MPI_SUM, &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      totvsmass = totvsmass_gbl
#endif

!c  compute total volumes for aqueous and gaseous phase
       if (evaporation) then
          
         totv_a = r0
         totv_g = r0
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_msysdd_2)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol, rpor)                                         &
    !$omp reduction(+:totv_a, totv_g)
    !$omp do schedule(static)
#endif
         do ivol = 1,nngl
           !exclude ghost nodes
#ifdef PETSC
           if(node_idx_lg2l(ivol) < 0) then
               cycle
           end if
#endif
          
           if (modify_por(ivol)) then
             rpor=porosity_flow(porold(ivol),                 &
                  uvsnew(ivol),uvsold(ivol),stor(ivol),       &
                  por_stress_dt(ivol),por_init(ivol),facpormin)   
           else
             rpor=pornew(ivol)
           end if
           totv_a = totv_a + sanew(ivol)*rpor*                &
                    density(ivol)*cvol(ivol)
           totv_g = totv_g + sgnew(ivol)*rpor*                &
                             cvol(ivol)*densvnew(ivol)
         end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef PETSC     
         call MPI_Allreduce(totv_a, totv_a_gbl,1,MPI_REAL8,MPI_SUM,    &
                            Petsc_Comm_World,ierrcode)
         CHKERRQ(ierrcode)
         totv_a = totv_a_gbl
         call MPI_Allreduce(totv_g, totv_g_gbl,1,MPI_REAL8,MPI_SUM,    &
                            Petsc_Comm_World,ierrcode)
         CHKERRQ(ierrcode)
         totv_g = totv_g_gbl
#endif
 
!c  write total contributions to file   

         imvs = imvs_first

         if(rank == 0 .and. b_enable_output .and.                      &
            .not.((skip_time.gt.0).and.(nskip_time.lt.skip_time))) then
           if (b_output_trans_binary) then
             nvarsimvs = 4
             realbuffer_gb(1:nvarsimvs) = (/time_io,totvsmass,totv_a,  &
                                            totv_g/)
             call binary_write_data(imvs_mpi(imvs), 1,         &
                          (/mtime/),offset_imvs_ijk(imvs),.true.)      
             call binary_write_data(imvs_mpi(imvs), nvarsimvs, &
                          realbuffer_gb,offset_imvs(imvs),.true.) 

             offset_imvs(imvs) = offset_imvs(imvs) + nvarsimvs*nfloatbit

           else
             if (mtime == mtime_append .and. i_append_sim >= 1) then
               call reposition_file(imvs,irecord)
             end if

             if (i_append_sim < 1 .or.                                 &
                (mtime >= mtime_append .and. i_append_sim >= 1)) then
               write(imvs,ascii_fmt) time_io,totvsmass,totv_a,totv_g
             end if
           end if
         end if
       else  
         totv_a = r0
         totv_g = r0
         
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_msysdd_3)                       &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol, rpor)                                         &
    !$omp reduction(+:totv_a, totv_g)
    !$omp do schedule(static)
#endif
         do ivol = 1,nngl
           !exclude ghost nodes
#ifdef PETSC
           if(node_idx_lg2l(ivol) < 0) then
               cycle
           end if 
#endif
             
           if (modify_por(ivol)) then
             rpor=porosity_flow(porold(ivol),                         &
                  uvsnew(ivol),uvsold(ivol),stor(ivol),               &
                  por_stress_dt(ivol),por_init(ivol),facpormin)   
           else
             rpor=pornew(ivol)
           end if
           
           totv_a = totv_a + sanew(ivol)*rpor*cvol(ivol)
           totv_g = totv_g + sgnew(ivol)*rpor*cvol(ivol)
         end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef PETSC     
         call MPI_Allreduce(totv_a, totv_a_gbl,1,MPI_REAL8,MPI_SUM,    &
                            Petsc_Comm_World,ierrcode)
         CHKERRQ(ierrcode)
         totv_a = totv_a_gbl
         call MPI_Allreduce(totv_g, totv_g_gbl,1,MPI_REAL8,MPI_SUM,    &
                            Petsc_Comm_World,ierrcode)
         CHKERRQ(ierrcode)
         totv_g = totv_g_gbl
#endif
 
!c  write total contributions to file   

         imvs = imvs_first

         if(rank == 0 .and. b_enable_output .and.                      &
            .not.((skip_time.gt.0).and.(nskip_time.lt.skip_time))) then
           if (b_output_trans_binary) then
             nvarsimvs = 4
             realbuffer_gb(1:nvarsimvs) = (/time_io,totvsmass,totv_a,  &
                                            totv_g/)
             call binary_write_data(imvs_mpi(imvs), 1,         &
                          (/mtime/),offset_imvs_ijk(imvs),.true.)      
             call binary_write_data(imvs_mpi(imvs), nvarsimvs, &
                          realbuffer_gb,offset_imvs(imvs),.true.) 

             offset_imvs(imvs) = offset_imvs(imvs)+nvarsimvs*nfloatbit

           else
             if (mtime == mtime_append .and. i_append_sim >= 1) then
               call reposition_file(imvs,irecord)
             end if

             if (i_append_sim < 1 .or.                                 &
                (mtime >= mtime_append .and. i_append_sim >= 1)) then
               write(imvs,ascii_fmt) time_io,totvsmass,totv_a,totv_g
             end if
           end if
         end if
         
      end if 
      
      return
      end 
