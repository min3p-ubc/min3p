!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/visconew.F90 $
!---------------------------------------------------------------------
!********************************************************************!

real*8 function visconew (densnew,tdsnew,tempnew,update_viscosity,update_viscosity_temp,cvisco1,cvisco2, &
                          cvisco3,cvisco4,cvisco5,tempref,iviscomodel,ref_visco,ref_tds,ref_dens)
#ifdef PETSC
use petsc_mpi_common, only : petsc_mpi_finalize
#endif

implicit none

real*8, intent(in)         :: &
 tempnew, &
 tdsnew, &
 densnew, &
 cvisco1, &
 cvisco2, &
 cvisco3, &
 cvisco4, &
 cvisco5, &
 tempref, &
 ref_visco, &
 ref_tds, &
 ref_dens
integer, intent(in) :: &
 iviscomodel
logical, intent(in)        :: &
 update_viscosity, &
 update_viscosity_temp
real*8                     :: &
 visco_c, &
 visco_temp, &
 massfrac, &
 temp_n, &
 tempref_n, &
 massfrac0
real*8, parameter          :: &
 r0=0.0d0, &
 r1=1.0d0, &
 r2=2.0d0, &
 r3=3.0d0, &
 r06=1.0d-6, &
 r10=10.0d0, &
 r100=100.0d0, &
 r150=150.0d0, &
 visc_coef1=1.85d0, &
 visc_coef2=-4.1d0, &
 visc_coef3=4.45d1 
integer, parameter        :: &
 model_sutra=1, &
 model_diersch=2
!cprovi----------------------------------------------------------------------------
!cprovi Initial values for viscosity ratios are unity 
!cprovi----------------------------------------------------------------------------
visco_c = r1  
visco_temp = r1
!cprovi----------------------------------------------------------------------------
!cprovi Compute the viscosity ratio for concentrations 
!cprovi----------------------------------------------------------------------------
if (update_viscosity) then   ! this expression is from Cordier/Goblet, 1991)
    massfrac = tdsnew / densnew
    massfrac0 = ref_tds / ref_dens
    visco_c = r1 + visc_coef1 * massfrac + visc_coef2 * massfrac**r2 + visc_coef3 * massfrac**r3 
    visco_c = visco_c / (r1 + visc_coef1 * massfrac0 + visc_coef2 * massfrac0**r2 + visc_coef3 * massfrac0**r3)
end if          
!cprovi----------------------------------------------------------------------------            
!cprovi Compute the viscosity ratio for temperature 
!cprovi----------------------------------------------------------------------------
if (update_viscosity_temp) then
 if (iviscomodel==model_sutra) then 
 
    temp_n = cvisco4 / (tempnew + cvisco5)
    tempref_n = cvisco4 / (tempref + cvisco5)
    visco_temp = r10**(temp_n-tempref_n)
 
 else if (iviscomodel==model_diersch) then 
 
    temp_n = (tempnew-r150)/r100
    tempref_n = (tempref-r150)/r100
    visco_temp = r1 + cvisco1 * tempref_n + cvisco2 * (tempref_n**r3)
    visco_temp = visco_temp / (r1 + cvisco1 * temp_n + cvisco2 * (temp_n**r3))
 
 else  
    write (*,*) 'Viscosity model not implemented'
#ifdef PETSC
    call petsc_mpi_finalize
#endif
    stop 
 end if
end if  
!cprovi----------------------------------------------------------------------------
!cprovi Compute the viscosity as a function of concentrations and temperature
!cprovi in a similar way than Diersch and Kolditz (1998)
!cprovi----------------------------------------------------------------------------      
visconew = ref_visco * visco_c * visco_temp
!cprovi----------------------------------------------------------------------------
!cprovi----------------------------------------------------------------------------
!cprovi----------------------------------------------------------------------------
return 
      
end function 