!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/intpolt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine intpolt
!c ------------------
!c
!c interpolate depth dependent temperature data on grid
!c
!c written by:      Uli Mayer - June 30, 1999
!c
!c last modified:   
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed: -
!c
!c common: 
!c gen.f:    real*8:
!c           -------
!c           tkel(nn)           = nodal temperatures in Kelvin        * +
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           nn                 = total number of control volumes     + -
!c
!c chem.f:   real*8:
!c           -------
!c           tmp(ntmp)          = specified depth dependent           + -
!c                                temperatures [K]
!c           ztmp(ntmp)         = depths of specified temperatures    + -
!c 
!c           integer*4:
!c           ---------- 
!c           ntmp               = number of temperature points        + -
!c
!c local:    real*8:
!c           -------
!c           deltaz             = distance between grid point and
!c                                temperature data point
!c           dz1                = minimum distance between grid 
!c                                point and temperature data point
!c           dz2                = minimum distance between grid 
!c                                point and temperature data point
!c           t1                 = temperature for interpolation
!c           t2                 = temperature for interpolation
!c           z1                 = z-coordinate of temperature for
!c                                interpolation
!c           z2                 = z-coordinate of temperature for
!c                                interpolation
!c
!c           integer*4:
!c           ----------
!c           i                  = counter (temperature points)
!c           ivol               = counter (control volumes)
!c
!c           logical:
!c           --------
!c           zbottom            = .true.  -> data point present
!c                                           below grid point
!c           ztop               = .true.  -> data point present
!c                                           above grid point
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine intpolt
 
      use parm
      use gen
      use chem

      implicit none

      logical zbottom, ztop
      
      integer :: i, ivol
      real*8 :: dz1, dz2, deltaz, z1, z2, t1, t2

      t1 = 0.0d0
      t2 = 0.0d0
      z1 = 0.0d0
      z2 = 0.0d0
!c  interpolate depth-dependent temperatures on grid 
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_intpolt)                        &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(i,ivol,deltaz,dz1,dz2,t1,t2,z1,z2,ztop,zbottom)             
    !$omp do schedule(static)
#endif
      do ivol = 1,nngl
 
!c  ntmp = 1 -> assign temperature
        
        if (ntmp.eq.1) then

          tkel(ivol) = tmp(1)

!c  ntmp > 1 -> find closest data points

        else

          dz1 = 1.0d+300
          dz2 = -1.0d+300
          ztop = .false.
          zbottom = .false.

          do i = 1,ntmp

            deltaz = zg(ivol)-ztmp(i)

            if (deltaz.gt.0) then
              if (deltaz.lt.dz1) then
                ztop = .true.
                dz1 = deltaz
                z1 = ztmp(i)
                t1 = tmp(i)
              end if
            else
              if (deltaz.gt.dz2) then
                zbottom = .true.
                dz2 = deltaz
                z2 = ztmp(i)
                t2 = tmp(i)
              end if
            end if

          end do

!c  interpolate temperature field on grid

          if (.not.ztop.and.zbottom) then
            tkel(ivol) = t2
          elseif (.not.zbottom.and.ztop) then
            tkel(ivol) = t1
          else
            tkel(ivol) = t1 + (zg(ivol)-z1)*(t1-t2)/(z1-z2)
          end if

        end if

!cdsu assign temperature value used for output purpose
        tempnew(ivol) = tkel(ivol) - tconv
        tempold(ivol) = tempnew(ivol)

      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      return
      end
