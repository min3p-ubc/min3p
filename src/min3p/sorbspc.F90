!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 609 $
!> $Author: dsu $
!> $Date: 2018-09-14 11:47:55 -0700 (Fri, 14 Sep 2018) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/sorbspc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine sorbspc
!c ------------------
!c compute concentration of sorbed species based on concentrations 
!c of primary species according to the law of mass action 
!c ion-exchange: Gaines-Thomas or Gapon convention
!c surface-complexation: constant capacitance
!c
!c written by:      Uli Mayer - July 7, 1998
!c
!c last modified:   -
!c                  
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of primary species   + -
!c           cec                = cation excahnge capacity            + -
!c           csb                = concentration of sorbed species     * +
!c           csb_ion            = concentration of sorbed species     * +
!c                                of ion-exchange
!c           csb_surf           = concentration of sorbed species     * +
!c                                of surface-complex
!c           eqsb(nsb)          = equilibrium constant for formation  + -
!c                                of sorbed species from primary 
!c                                species
!c           eqsb_ion(nsb_ion)  = equilibrium constant for formation  + -
!c                                of sorbed species from primary 
!c                                species (ion-exchange)
!c           eqsb_surf(nsb_surf)= equilibrium constant for formation  + -
!c                                of sorbed species from primary 
!c                                species (surface-complex)
!c           gammac(*)          = activity coefficients for primary   + -
!c                                species
!c           xnusb(*)           = stoichiometric coefficient of       + -
!c                                primary species in sorbed
!c                                species
!c           xnusb_ion(*)       = stoichiometric coefficient of       + -
!c                                primary species in sorbed
!c                                species (ion-exchange)
!c           xnusb_surf(*)      = stoichiometric coefficient of       + -
!c                                primary species in sorbed
!c                                species (surface-complex)
!c
!c           integer*4:
!c           ----------
!c           iasb(*)            = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed
!c                                species
!c           iasb_ion(*)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed
!c                                species (ion-exchange)
!c           iasb_surf(*)       = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                primary species in sorbed
!c                                species (surface-complex)
!c           isb                = pointer to secondary species        + -
!c           jasb(*)            = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                primary species in sorbed
!c                                species 
!c           jasb_ion(*)        = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                primary species in sorbed
!c                                species(ion-exchange)
!c           jasb_surf(*)       = column pointer array to             + -
!c                                stoichiometric coefficients of 
!c                                primary species in sorbed
!c                                species (surface-complex) 
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           character:
!c           ----------
!c           sorption_type    = 'gaines-thomas'                       + -
!c                              'gapon'
!c
!c
!c local:    real*8:
!c           -------
!c           r0               = constant
!c           rhalf            = constant
!c           r1               = constant
!c           r2               = constant
!c           r4               = constant
!c           term1            = intermediate term
!c           term2            = intermediate term
!c           term3            = intermediate term
!c           term4            = intermediate term
!c           term5            = intermediate term
!c
!c           integer*4:
!c           ----------
!c           i1               = counter
!c           ic               = counter (primary species)
!c           istart           = pointer
!c           istop            = pointer
!c           ksb              = counter (sorbed species)
!c
!c           logical:
!c           --------
!c           quadratic1       = .true.  -> add to quadratic term 
!c                              .false. -> add to linear term
!c           quadratic2       = .true.  -> add to quadratic term 
!c                              .false. -> add to linear term
!c           b_equivalent_ex  = .true.  -> use equivalent fraction for exchanger
!                                       -> e.g., 0.5Ca+2 + Na-X = 0.5Ca-X2 + Na+ 
!c           b_equivalent_ex  = .false. -> use equivalent fraction for sorbed species
!c           (default)                  -> e.g., Ca+2 + 2Na-X = Ca-X2 + 2Na+ 
!c
!c external: -  
!c ----------------------------------------------------------------------
  
      subroutine sorbspc(csb_ion,csb_surf,cec,eqsb_ion,eqsb_surf,      &
                         gammac,c,xnusb_ion,xnusb_surf,                &
                         iasb_ion,iasb_surf,jasb_ion,jasb_surf,        &
                         nsb_ion,nsb_surf,isb_ion,isb_surf,            &
                         sorption_type_ion,sorption_type_surf,         &
                         sorption_group,isactcexch)
                                                                      
      implicit none
      
      real*8 :: csb_ion,csb_surf,cec,eqsb_ion,eqsb_surf,gammac,c,xnusb_ion,xnusb_surf
      integer :: iasb_ion,iasb_surf,jasb_ion,jasb_surf,nsb_ion,nsb_surf,isb_ion,isb_surf
                                                                        
      character*72 sorption_type_ion,sorption_type_surf,sorption_group                         
                                                                        
      logical isactcexch
                                                                        
      dimension c(*),eqsb_ion(*),eqsb_surf(*),gammac(*),xnusb_ion(*),xnusb_surf(*), &
                iasb_ion(*),iasb_surf(*),jasb_ion(*),jasb_surf(*)
                                                                        
      real*8, parameter :: r0 = 0.0d0, rhalf = 0.5d0, r1 = 1.0d0, r2 = 2.0d0, r4 = 4.0d0

      logical quadratic1, quadratic2
      
      integer :: i1, ic, istart, istop, iend, ksb
      
      real*8 :: term1, term2, term3, term4, term5

      if (isb_ion.gt.0) then

!c  compute nominator
           
            quadratic1 = .false.
            term1 = r1/eqsb_ion(isb_ion)
            istart = iasb_ion(isb_ion)
            istop = iasb_ion(isb_ion+1)-1
            do i1 = istart,istop
              ic = jasb_ion(i1)
          
          
              if (isactcexch) then
               term1 = term1 * (gammac(ic)*c(ic))**xnusb_ion(i1)
              else 
               term1 = term1 * c(ic)**xnusb_ion(i1)
              end if
          
              if (idnint(-xnusb_ion(i1)).eq.2) then
                quadratic1 = .true.
               end if
            end do

    !c  compute denominator
 
            if (sorption_type_ion.eq.'gapon') then

              term2 = r0

              do ksb = 1,nsb_ion
                term3 = r1/eqsb_ion(ksb)
                istart = iasb_ion(ksb)
                istop = iasb_ion(ksb+1)-1
                do i1 = istart,istop
                  ic = jasb_ion(i1)
                  if (isactcexch) then
                    term3 = term3 * (gammac(ic)*c(ic))**xnusb_ion(i1)
                  else
                    term3 = term3 * c(ic)**xnusb_ion(i1)
                  end if  
                end do
                term2 = term2 + term3
              end do
     
              csb_ion = cec*term1/term2

            elseif (sorption_type_ion.eq.'gaines-thomas') then

              term4 = r0
              term5 = r0

              do ksb = 1,nsb_ion

                term3 = r1/eqsb_ion(ksb)
                quadratic2 = .false.

                istart = iasb_ion(ksb)
                istop = iasb_ion(ksb+1)-1

                do i1 = istart,istop

                  ic = jasb_ion(i1)
                  if (idnint(-xnusb_ion(i1)).eq.2) then
                    quadratic2 = .true.
                  end if
              
                  if (isactcexch) then
                     term3 = term3 * (gammac(ic)*c(ic))**xnusb_ion(i1)
                  else
                     term3 = term3 * c(ic)**xnusb_ion(i1)
                  end if
             
                end do

                if (.not.quadratic2) then
                  term4 = term4 + term3
                elseif (quadratic2) then
                  term5 = term5 + term3
                end if

              end do
 
              if (term5.ne.0) then
              term2 = (-term4 + (term4**r2 + r4*term5)**rhalf)/(r2*term5)
              else
              term2 = term4
            end if

              if (quadratic1) then
                term2 = term2**r2
              end if

              if (term5.ne.0) then
                csb_ion = cec*term1*term2
              else
                csb_ion = cec*term1/term2
              end if

            end if
       
      end if

!c  compute concentrations of sorbed species

      if (isb_surf.gt.0) then
        
            csb_surf = r1/eqsb_surf(isb_surf)

            istart = iasb_surf(isb_surf)
            iend = iasb_surf(isb_surf+1)-1
            
            do i1 = istart,iend
              ic = jasb_surf(i1)
              csb_surf = csb_surf * (gammac(ic)*c(ic))**xnusb_surf(i1)             
              
            end do

      end if        !(sorption_group)

      return
    end
!c ----------------------------------------------------------------------
!c subroutine sorbspc_m
!c ------------------
!c compute concentration of sorbed species for multisite ion exchange 
!c based on concentrations of primary species according to the law of 
!c  mass action ion-exchange: Gaines-Thomas convention
!c surface-complexation: constant capacitance
!c ToDo Gapon convention

!c written by:      Mingliang Xie - Oct. 22, 2013
!c
!c last modified:   -
!c                  
!c
!c definition of variables: (see above)

    subroutine sorbspc_m(csb_ion,csb_surf,cec,cec_fraction,eqsb_ion,eqsb_surf,    &
                         gammac,c,xnusb_ion,xnusb_surf,                           &
                         iasb_ion,iasb_surf,jasb_ion,jasb_surf,                   &
                         nsb_ion,nsb_surf,isb_ion,isb_surf,                       &
                         sorption_type_ion,sorption_type_surf,                    &
                         sorption_group,isactcexch)
      use chem, ONLY : idx_nsites_ion, nss_onIsite_ion, idx_ss2isite_ion, nsites_ion

      implicit none

      real*8 :: csb_ion,csb_surf,cec,cec_fraction,eqsb_ion,eqsb_surf,gammac,c,xnusb_ion,xnusb_surf
      integer :: iasb_ion,iasb_surf,jasb_ion,jasb_surf,nsb_ion,nsb_surf,isb_ion,isb_surf

      integer :: i1, ic, istart, istop, iend, isb, itemp, ksb, nss

      real*8 :: term1, term2, term3, term4, term5
                                                                        
      character*72 sorption_type_ion,sorption_type_surf,sorption_group                         
                                                                        
      logical isactcexch
                                                                        
      dimension c(*),eqsb_ion(*),eqsb_surf(*),gammac(*),xnusb_ion(*),xnusb_surf(*), &
                iasb_ion(*),iasb_surf(*),jasb_ion(*),jasb_surf(*)
                                                                        
      real*8, parameter :: r0 = 0.0d0, rhalf = 0.5d0, r1 = 1.0d0, r2 = 2.0d0, r4 = 4.0d0

      logical quadratic1, quadratic2

      if (isb_ion.gt.0) then

!c  compute nominator
           
            quadratic1 = .false.
            term1 = r1/eqsb_ion(isb_ion)
            istart = iasb_ion(isb_ion)
            istop = iasb_ion(isb_ion+1)-1
            do i1 = istart,istop
              ic = jasb_ion(i1)
          
          
              if (isactcexch) then
               term1 = term1 * (gammac(ic)*c(ic))**xnusb_ion(i1)
              else 
               term1 = term1 * c(ic)**xnusb_ion(i1)
              end if
          
              if (idnint(-xnusb_ion(i1)).eq.2) then
                quadratic1 = .true.
               end if
            end do

    !c  compute denominator
 
            if (sorption_type_ion.eq.'gapon') then

              term2 = r0
              itemp = idx_nsites_ion(isb_ion)
              nss=nss_onIsite_ion(itemp)
              if (nsites_ion .eq. 1) then
                  nss=nsb_ion
              end if
              
              do isb = 1,nss           !nsb_ion
                  
                if (nsites_ion .eq. 1) then
                    ksb=isb
                else
                    ksb = idx_ss2isite_ion(itemp, isb)
                end if

!c              do ksb = 1,nsb_ion
                term3 = r1/eqsb_ion(ksb)
                istart = iasb_ion(ksb)
                istop = iasb_ion(ksb+1)-1
                do i1 = istart,istop
                  ic = jasb_ion(i1)
                  if (isactcexch) then
                    term3 = term3 * (gammac(ic)*c(ic))**xnusb_ion(i1)
                  else
                    term3 = term3 * c(ic)**xnusb_ion(i1)
                  end if  
                end do
                term2 = term2 + term3
              end do
            
     
              csb_ion = cec*term1/term2

            elseif (sorption_type_ion.eq.'gaines-thomas') then

              term4 = r0
              term5 = r0
              itemp = idx_nsites_ion(isb_ion)
              nss=nss_onIsite_ion(itemp)
              if (nsites_ion .eq. 1) then
                  nss=nsb_ion
              end if
              
              do isb = 1,nss           !nsb_ion
                  
                if (nsites_ion .eq. 1) then
                    ksb=isb
                else
                    ksb = idx_ss2isite_ion(itemp, isb)
                end if
                
                term3 = r1/eqsb_ion(ksb)
                quadratic2 = .false.

                istart = iasb_ion(ksb)
                istop = iasb_ion(ksb+1)-1

                do i1 = istart,istop

                  ic = jasb_ion(i1)
                  if (idnint(-xnusb_ion(i1)).eq.2) then
                    quadratic2 = .true.
                  end if
              
                  if (isactcexch) then
                     term3 = term3 * (gammac(ic)*c(ic))**xnusb_ion(i1)
                  else
                     term3 = term3 * c(ic)**xnusb_ion(i1)
                  end if
             
                end do

                if (.not.quadratic2) then
                  term4 = term4 + term3
                elseif (quadratic2) then
                  term5 = term5 + term3
                end if

              end do
 
              if (term5.ne.0) then
              term2 = (-term4 + (term4**r2 + r4*term5)**rhalf)/(r2*term5)
              else
              term2 = term4
            end if

              if (quadratic1) then
                term2 = term2**r2
              end if

              if (term5.ne.0) then
 !Cmx               csb_ion = cec*term1*term2
                csb_ion = cec*cec_fraction*term1*term2
              else
                csb_ion = cec*cec_fraction*term1/term2
              end if

            end if
       
      end if

!c  compute concentrations of sorbed species

      if (isb_surf.gt.0) then
        
            csb_surf = r1/eqsb_surf(isb_surf)

            istart = iasb_surf(isb_surf)
            iend = iasb_surf(isb_surf+1)-1
            
            do i1 = istart,iend
              ic = jasb_surf(i1)
              csb_surf = csb_surf * (gammac(ic)*c(ic))**xnusb_surf(i1)             
              
            end do

      end if        !(sorption_group)

      return
      end
