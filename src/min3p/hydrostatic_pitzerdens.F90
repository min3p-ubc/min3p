!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/hydrostatic_pitzerdens.F90 $
!---------------------------------------------------------------------
!********************************************************************!


      subroutine hydrostatic_pitzerdens (ivol)
 !cprovi---------------------------------------------------------------
 !cprovi Compute the hydrostatic conditions for the ivol cell 
 !cprovi Only when Pitzer equations are choosen 
 !cprovi---------------------------------------------------------------
      use parm
      use gen
      use dens

      implicit none
      
      integer :: i, ivolloc, ivol, istart, iend, jvol 
      real*8 :: dens_av, dx, dy, dz, pw_res, xivol, yivol, zivol,      &
                xjvol, yjvol, zjvol, zmax_loc, zmax_gbl
      
      real*8, parameter  :: &
      delta=1.0d-8, &
      rhalf=0.5d0, &
      r0=0.0d0
      logical            :: &
      found
      
      ivolloc=ivol
      pw_res=r0 
      !zmaxloc = maxval(zg)
      zmax_loc = gzlmax
      zmax_gbl = zlmaxgbl
      pw_res = (hydro_top - zmax_gbl) * ref_dens * gacc 
!cprovi---------------------------------------------------------------------------
!cprovi Add a residual water pressure in ivol
!cprovi---------------------------------------------------------------------------      
      uvsnew(ivol) = pw_res
10 continue 
       found=.false. 
       istart=iavs(ivolloc)
       iend=iavs(ivolloc+1)-1
       zivol=zg(ivolloc)
       xivol=xg(ivolloc)
       yivol=yg(ivolloc)
       
        do i=istart,iend       
     
          jvol = javs(i)       
          zjvol=zg(jvol)
          xjvol=xg(jvol)
          yjvol=yg(jvol)
          dx=dabs(xivol-xjvol)
          dy=dabs(yivol-yjvol)
          dz=zjvol-zivol
          
          if (dz>delta.and.dy<delta.and.dx<delta) then
           found=.true.
           dens_av=(density(ivolloc)*density(jvol))*(cvol(ivolloc)+cvol(jvol))
           dens_av=dens_av/(density(ivolloc)*cvol(ivolloc)+density(jvol)*cvol(jvol))
           uvsnew(ivol) = uvsnew(ivol) + dens_av*gacc*dz 
           exit
          end if
          
        end do
        
        if (found) then
          ivolloc=jvol
          goto 10
        else  
          if (dabs(zivol-zmax_loc)>delta) then
             if(rank == 0) then 
               write(ilog,*) 'error computing initial hydrostatic conditions'
               write(ilog,*) 'not found a control volume on cell:',ivolloc
               write(ilog,*) 'z(ivol)[m]',zivol
               write(ilog,*) 'zmax[m]',zmax_loc
               close(ilog)
             end if
             !stop  
             b_mpi_process_flag = .true.
          end if   
        end if
         
!   20 continue

      return
      end
