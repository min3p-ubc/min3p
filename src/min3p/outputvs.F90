!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/outputvs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputvs
!c -------------------
!c
!c write contour data for variably saturated flow simulation to output
!c file
!c
!c written by:      Uli Mayer - May 7, 96
!c
!c last modified:   Uli Mayer - November 14, 96
!c                  seperate files for each output time
!c                  Uli Mayer - June 7, 98
!c                  included velocity output
!c            Celine Blitz Frayret (CBF) for Frederic Gerard, December 14, 2018 :
!c            removed local calculation of qroot because qroot(ivol) is now
!c            a common variable computed in jacvs, replaced qroot by qroot(ivol)
!c
!c
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cinfvs(njavs)      = influence coefficients              + -
!c                                (variably saturated flow)
!c           cvol(nn)           = nodal volumes                       + -
!c           dimcv(3,nn)        = dimension of control volumes        + -
!c           elevmax            = max. elevation of solution domain   + -
!c           hhead(nn)          = hydraulic head                      + -
!c           sgnew(nn)          = gaseous phase saturation            + - 
!c                                - new time level
!c           sanew(nn)          = aqueous phase saturation            + - 
!c                                - new time level
!c           relperm(nn)        = relative permeability               + -
!c           time_io            = current solution time (I/O units)   + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + -
!c           ifls               = unit number, file information       + -
!c           ilog               = unit number, log book               + -
!c           igsp               = unit number, flow variables         + -
!c           igstime            = pointer to next output time for     + -
!c                                contour data
!c           icnv               = unit number, data conversion        + -
!c           ivel               = unit number, average interfacial    + -
!c                                             velocities
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           iavs(nn+1)         = row pointer array for 1d-scalar     + -
!c                                matrix
!c           javs(njavs)        = connectivity list for 1d-scalar     + -
!c                                matrix
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = current time step                   + -
!c           njavs              = number of global connections        + -
!c           nn                 = number of control volumes           + -
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           depth_output       = .true.  -> output in terms of       + -
!c                                           depth instead of
!c                                           elevation
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c           half_cells         = .true.  -> half cells on boundary   + -
!c           initial_condition  = .true.  -> output of initial        + -
!c                                           contour data
!c                                .false. -> output contour data
!c                                           for steady state or
!c                                           transient solutions
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           steady_flow        = .true.  -> steady state flow        + -
!c           upstream           = .true.  -> upstream weighting       + -
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient conditions for    
!c                                           variably saturated flow 
!c                                           simulation
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           problem_title      = problem title                       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c
!c
!c local:    real*8:
!c           ------- 
!c           phead              = pressure head
!c           qroot              = root water uptake for current
!c                                control volume
!c           theta_a            = aqueous phase content         
!c           theta_g            = gas phase content
!c           r0                 = constant         
!c           r1                 = constant
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           l_sufx             = length of file suffix
!c
!c           character:
!c           ---------- 
!c           suffix             = file suffix
!c
!c external: velocity  = average interfacial velocities
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c --------------------------------------------------------------------------

      subroutine outputvs

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use phys
      use writeversion
      use file_unit, only : lun_get, lun_free
      use biol

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: i, ivol, izn, l_sufx, ivol_l, ierrcode, ierr
      
      real*8 :: zout, theta_a, theta_g, phead

      real*8 :: qroot, transp, soilevapo

      real*8, external :: zoutput, rootwat, evapo

      external velocity

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0

      character*5 suffix      
      character*2048 strbuffer
      character*72 :: tec_variables(100)
      integer*4 :: nvars

#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) :: offset_igsp, offset_igsp_temp,  &
                                       offset_ivel, offset_ivel_temp
#else
      integer*8 :: offset_igsp, offset_igsp_temp,                      &
                   offset_ivel, offset_ivel_temp
#endif

      l_sufx = 0

!c     write(*,'(/a)') 'enter routine outputvs ...'

!c  assign file suffix for initial condition or current time step
!c  works for up to 999 output times

      ! qroot=0.0d0 CBF


      !rewind(icnv)               !Deprecated, use internal convert instead. DSU

      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then

          !write(icnv,'(i1)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i1)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:1)
            l_sufx = 3
          else
            l_sufx = 1
          end if

        elseif (igstime.ge.10.and.igstime.lt.100) then

          !write(icnv,'(i2)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i2)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:2)
            l_sufx = 4
          else
            l_sufx = 2
          end if

        elseif (igstime.ge.100.and.igstime.lt.1000) then

          !write(icnv,'(i3)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i3)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:3)
            l_sufx = 5
          else
            l_sufx = 3
          end if

        elseif (igstime.gt.1000) then
          if (rank == 0) then
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
#ifdef DEBUG
            write(idbg,'(/a)') 'error in input file'
            write(idbg,'(a)') 'max. number of output times exceeded'
            write(idbg,'(a)') 'abnormal exit in routine outputrt'
            close(idbg)
#endif
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if
      end if

!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
      if (b_output_binary) then
        
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsp'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsp'
        end if
        call binary_file_open(Petsc_Comm_World, igsp,        &
                     trim(strbuffer),b_output_mpiio_single)
 
      else
        open(igsp,file=prefix(:l_prfx)//'_'//                          &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsp',    &
                  status='unknown',form='formatted')
      end if
      
      if (rank == 0) then
                                                                       
        if (initial_condition) then
                                                                         
          write(ifls,'(/2a/72a)')'Flow variables, initial ',           &
                                 'condition',('-',i=1,72)
                                                                        
        elseif (steady_flow) then
                                                                        
          write(ifls,'(/2a/72a)')'Flow variables, steady ',            &
                                 'state solution',('-',i=1,72)
                                                                        
        else
                                                                        
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
                'Flow variables, T = ',time_io,time_unit,('-',i=1,72)
                                                                        
        end if
                                                                        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                            suffix(:l_sufx)//'.gsp'
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        hydraulic head                  ','m'           
        write(ifls,'(2a)')                                             &
              '5        pressure head                   ','m'           
        write(ifls,'(2a)')                                             &
              '6        water saturation                ','-'           
        write(ifls,'(2a)')                                             &
              '7        water content                   ','-'
        if (variably_saturated) then
          write(ifls,'(2a)')                                           &
                '8        air saturation                  ','-'         
          write(ifls,'(2a)')                                           &
                '9        air content                     ','-'         
          write(ifls,'(2a)')                                           &
                '10       total root water uptake         ','m^3/d'
          write(ifls,'(2a)')                                           &
                '11       root water uptake               ','m^3/d'
          write(ifls,'(2a)')                                           &
                '12       evaporation uptake              ','m^3/d'
        end if
      
      end if

!c  ---------------------------------------------------------------------
!c  open file for interfacial velocities
!c  --------------------------------------------------------------------- 

      if (.not.initial_condition) then
          
          
      if (b_output_binary) then
        
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.vel'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.vel'
        end if
        call binary_file_open(Petsc_Comm_World, ivel,          &
                     trim(strbuffer),b_output_mpiio_single)

      else

        open(ivel,file=prefix(:l_prfx)//'_'//                          &
     &            suffix(:l_sufx)//trim(adjustl(str_rank))//'.vel',    &
     &            status='unknown',form='formatted')
          
      end if
        
        if (rank == 0) then
                                                                       
          if (steady_flow) then
                                                                         
            write(ifls,'(/2a/72a)')'Average interfacial ',             &
     &                           'velocities - steady state solution', &
     &                           ('-',i=1,72)
                                                                         
          else
                                                                         
            write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                     &
     &            'Average interfacial velocities, T = ',              &
     &             time_io,time_unit,('-',i=1,72)
                                                                        
          end if
                                                                        
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
     &                        suffix(:l_sufx)//'.vel'
                                                                        
          write(ifls,'(2a)')                                           &
     &          'column   entry                           ','unit'      
          write(ifls,'(2a)')                                           &
     &          '1        x                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '2        y                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '3        z                               ','m'         
          write(ifls,'(2a)')                                           &
     &          '4        v_x                             ','m/d'       
          write(ifls,'(2a)')                                           &
     &          '5        v_y                             ','m/d'       
          write(ifls,'(2a)')                                           &
     &          '6        v_z                             ','m/d'
        
        end if

      end if               ! (.not.initial_condition)
   
!c  ---------------------------------------------------------------------
!c  file header
!c  ---------------------------------------------------------------------

!c  title and variables

      if (tec_header) then
          
!c  version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsp, "#")
        end if
        
!c  title and variables
        if (b_output_binary) then

          strbuffer = 'dataset '//prefix(:l_prfx)//''
          !write tecplot title and header  
          offset_igsp = 0
          call tecplot_binary_write_header(Petsc_Comm_World, igsp,     &
                       "#!TDV102", trim(strbuffer), offset_igsp,       &
                       b_output_mpiio_single,.false.)
        else
          write(igsp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        end if

        if (fully_saturated) then
  
          nvars = 7

          if (b_output_binary) then
              
            tec_variables(1:nvars) = [character(len=72) ::             &
                "x", "y", "z", "h_w", "ph_w","s_a", "theta_a"] 
            call tecplot_binary_write_variable(Petsc_Comm_World, igsp, &
                         nvars, tec_variables(1:nvars), offset_igsp,   &
                         b_output_mpiio_single,.false.)   
          else
            write(igsp,'(20a)') 'variables = "x", "y", "z",',          & 
     &                          ' "h_w",',                             &
     &                          ' "ph_w",',                            &
     &                          ' "s_a",',                             &
     &                          ' "theta_a"'
          end if
                                                                       
        elseif (variably_saturated) then

          nvars = 12
            
          if (b_output_binary) then
              
            tec_variables(1:nvars) = [character(len=72) ::             &
                "x", "y", "z", "h_w", "ph_w", "s_a", "theta_a",        &
                "s_g", "theta_g", "q_root", "rootwat", "evapo"]
            
            call tecplot_binary_write_variable(Petsc_Comm_World, igsp, &
                         nvars, tec_variables(1:nvars),offset_igsp,    &
                         b_output_mpiio_single,.false.)
            
          else  
                                                                       
            write(igsp,'(20a)') 'variables = "x", "y", "z",',          &
                                ' "h_w",',                             &
                                ' "ph_w",',                            &
                                ' "s_a",',                             &
                                ' "theta_a",',                         &
                                ' "s_g",',                             &
                                ' "theta_g",',                         &
                                ' "q_root",',                          &
                                ' "rootwat",',                         &
                                ' "evapo"'
          end if  

        end if

        if (.not.initial_condition) then
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(ivel, "#")
          end if
          
!c  title and variables 
          if (b_output_binary) then
              
            strbuffer = 'dataset '//prefix(:l_prfx)//''
            offset_ivel = 0
            call tecplot_binary_write_header(Petsc_Comm_World, ivel,   &
                         "#!TDV102", trim(strbuffer), offset_ivel,     &
                         b_output_mpiio_single,.false.) 

            tec_variables(1:6) = [character(len=72) :: "x", "y", "z",  &
                                  "vx", "vy","vz"] 
            call tecplot_binary_write_variable(Petsc_Comm_World, ivel, &
                         6, tec_variables(1:6), offset_ivel,           &
                         b_output_mpiio_single,.false.)
          else
            write(ivel,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(ivel,'(2a)') 'variables = "x", "y", "z", ',          &
                               '"vx", "vy", "vz"' 
          end if
        end if
                                                                       
      else          
!c  version information
        if (b_writeversion_tecplot ) then
            call writeversion2file(igsp, "#")
        end if
        
!c  title and variables                                                                       
        write(igsp,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
                                                                       
        if (fully_saturated) then
                                                                       
          write(igsp,'(20a)') '# variables = "x", "y", "z",',         &
                              ' "h_w",',                              &
                              ' "ph_w",',                             &
                              ' "s_a",',                              &
                              ' "theta_a"'
                                                                       
        elseif (variably_saturated) then
                                                                       
          write(igsp,'(20a)') '# variables = "x", "y", "z",',         &
                              ' "h_w",',                              &
                              ' "ph_w",',                             &
                              ' "s_a",',                              &
                              ' "theta_a",',                          &
                              ' "s_g",',                              &
                              ' "theta_g",',                          &
                              ' "q_root",',                           &
                              ' "rootwat",',                          &
                              ' "evapo"'
        end if
                                                                       
        if (.not.initial_condition) then 
!c  version information
          if (b_writeversion_tecplot ) then
              call writeversion2file(ivel, "#")
          end if
          
!c  title and variables          
          write(ivel,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"' 
          write(ivel,'(2a)') '# variables = "x", "y", "z", ',         &
     &                     '"vx", "vy", "vz"'
        end if

      end if                    !(tec_header)

!c  zone record for initial condition
 
      if (initial_condition) then

        if (tec_header) then

          if(b_output_binary) then  
              
            strbuffer = 'Flow variables, initial condition'
            offset_igsp_temp = offset_igsp
            
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsp,trim(strbuffer),offset_igsp,           &
                           itec,jtec,ktec,                             &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsp = offset_igsp_temp +                         &
                            (11+len_trim(strbuffer))*4*nprcs + 4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsp,trim(strbuffer),offset_igsp,           &
                           itec_gbl,jtec_gbl,ktec_gbl,                 &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsp = offset_igsp_temp +                         &
                            (12+len_trim(strbuffer))*4
            end if         
          else
            write(igsp,'(3(a,i5),a)')                                  &
     &            'zone t = "Flow variables, initial condition" i =',  &
     &            itec,', j =',jtec,', k =',ktec,',  f=point'
          end if
                                                                       
        else
                                                                       
          write(igsp,'(3(a,i5),a)')                                   &
     &          '# zone t = "Flow variables, initial condition" i =', &
     &          itec,', j =',jtec,', k =',ktec,',  f=point'

        end if                   !(tec_header)

!c  zone record for current time step or steady state solution
!c  for fully saturated or variably saturated  conditions

      elseif (.not.initial_condition) then

        if (fully_saturated) then
          do ivol=1,nngl
            hhead(ivol) = uvsnew(ivol)
          end do
        elseif (variably_saturated) then
          do ivol=1,nngl
            hhead(ivol) = uvsnew(ivol)+zg(ivol)
          end do
        end if
        
        if (tec_header) then

          if (steady_flow) then
              
            if (b_output_binary) then
                
              strbuffer = 'Flow variables, steady state'
              offset_igsp_temp = offset_igsp
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsp = offset_igsp_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs+4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)              
                offset_igsp = offset_igsp_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
              
              
              strbuffer = 'velocities, steady state'
              offset_ivel_temp = offset_ivel
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             ivel,trim(strbuffer),offset_ivel,         &
                             itec_vel,jtec_vel,ktec_vel,               &
                             b_output_mpiio_single,                    &
                             .false.,b_output_multizone)              
                offset_ivel = offset_ivel_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs+4
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             ivel,trim(strbuffer),offset_ivel,         &
                             itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl,   &
                             b_output_mpiio_single,                    &
                             .false.,b_output_multizone)              
                offset_ivel = offset_ivel_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if              
            else

              write(igsp,'(a,3(a,i5),a)')                              &
                    'zone t = "Flow variables, steady state" ',        &
                    'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
              
              write(ivel,'(a,3(a,i5),a)')                              &
                    'zone t = "velocities, steady state" ',            &
                    ', i =',itec_vel,                                  &
                    ', j =',jtec_vel,                                  &
                    ', k =',ktec_vel,',  f=point'  
            end if
                                                                      
          elseif (transient_flow) then
              
            if (b_output_binary) then
                
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'Flow variables, solution time = ',                &
                    time_io,time_unit
              offset_igsp_temp = offset_igsp
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec,jtec,ktec,                           &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)
                offset_igsp = offset_igsp_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs+4 
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             igsp,trim(strbuffer),offset_igsp,         &
                             itec_gbl,jtec_gbl,ktec_gbl,               &
                             b_output_mpiio_single,.false.,            &
                             b_output_multizone)
                offset_igsp = offset_igsp_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if              
              
              write(strbuffer,'(a,1pe15.6e3,1x,a)')                    &
                    'velocities, solution time = ', time_io,time_unit
              offset_ivel_temp = offset_ivel
              
              if (b_output_multizone) then
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             ivel,trim(strbuffer),offset_ivel,         &
                             itec_vel,jtec_vel,ktec_vel,               &
                             b_output_mpiio_single,                    &
                             .false.,b_output_multizone)
                offset_ivel = offset_ivel_temp +                       &
                              (11+len_trim(strbuffer))*4*nprcs+4 
              else
                call tecplot_binary_write_zoneinfo(Petsc_Comm_World,   &
                             ivel,trim(strbuffer),offset_ivel,         &
                             itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl,   &
                             b_output_mpiio_single,                    &
                             .false.,b_output_multizone)
                offset_ivel = offset_ivel_temp +                       &
                              (12+len_trim(strbuffer))*4
              end if
              
            else                                                                       
              write(igsp,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
                  'zone t = "Flow variables, solution time = ',time_io,&
                  time_unit,'" i =',itec,', j =',jtec,', k =',ktec,    &
                  ',  f=point'
              
              write(ivel,'(a,1pe15.6e3,1x,a,3(a,i5),a)')               &
                    'zone t = "velocities, solution time = ',          &
                    time_io, time_unit,                                &
                    '" i =',itec_vel,                                  &
                    ', j =',jtec_vel,                                  &
                    ', k =',ktec_vel,',  f=point'
              
            end if
                                                                       
          end if
                                                                       
        else
                                                                       
          if (steady_flow) then
                                                                       
            write(igsp,'(a,3(a,i5),a)')                               &
     &          '# zone t = "Flow variables, steady state solution" ',&
     &          'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
                                                                       
            write(ivel,'(a,3(a,i5),a)')                               &
     &            '# zone t = "velocities, steady state" ',           &
     &            ', i =',itec_vel,                                   &
     &            ', j =',jtec_vel,                                   &
     &            ', k =',ktec_vel,',  f=point'
                                                                       
          elseif (transient_flow) then
                                                                       
            write(igsp,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
     &         '# zone t = "Flow variables, solution time = ',time_io,&
     &          time_unit,'" i =',itec,', j =',jtec,', k =',ktec,     &
     &         ',  f=point'
                                                                       
            write(ivel,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
     &            '# zone t = "velocities, solution time = ',         &
     &            time_io, time_unit,                                 &
     &            '" i =',itec_vel,                                   &
     &            ', j =',jtec_vel,                                   &
     &            ', k =',ktec_vel,',  f=point'

          end if         

        end if                  !(tec_header)
      end if                    !(initial_condition)

!c  ---------------------------------------------------------------------
!c  output
!c  ---------------------------------------------------------------------
      if (b_output_binary) then
          
        offset_igsp_temp = offset_igsp
        if (fully_saturated) then            
          call tecplot_binary_write_section(Petsc_Comm_World,igsp,nvars, &
                       nn_offset,offset_igsp,b_output_mpiio_single,      &
                       .false.,b_output_multizone)
        else if (variably_saturated) then
          call tecplot_binary_write_section(Petsc_Comm_World,igsp,nvars,  &
                       nn_offset,offset_igsp,b_output_mpiio_single,    &
                       .false.,b_output_multizone) 
        end if
        
        if (.not.initial_condition) then
          offset_ivel_temp = offset_ivel
          call tecplot_binary_write_section(Petsc_Comm_World,ivel,6,   &
                       nn_interfacial_offset,offset_ivel,              &
                       b_output_mpiio_single,.false.,b_output_multizone)
        end if
         
      end if

!C----------Zone Data. Each variable is in data format asspecified above.   

      if(b_output_binary) then
        if (fully_saturated) then
          allocate(realbuffer(nn*nvars), stat = ierr)
          call checkerr(ierr,'outputvs-realbuffer',ilog)
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        else if (variably_saturated) then
          allocate(realbuffer(nn*nvars), stat = ierr)
          call checkerr(ierr,'outputvs-realbuffer',ilog)
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if
        realbuffer = 0.0d0
      end if
      
!c  loop over control volumes
      ivol_l = 0

      do ivol = 1,nngl
          
!c  skip ghost nodes
#ifdef PETSC
        if (node_idx_lg2l(ivol) < 0) then
            cycle
        end if 
#endif

        ivol_l = ivol_l + 1
        

!c  assign depth coordinate in terms of depth or elevation

        zout = zoutput(depth_output,zg(ivol),elevmax)

        theta_a = pornew(ivol)*sanew(ivol)
        
        if (fully_saturated) then

          phead = uvsnew(ivol) - zg(ivol)
          
          if (b_output_binary) then
            realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars)=(/             &
                      xg(ivol),yg(ivol),zout,hhead(ivol),phead,        &
                      sanew(ivol),theta_a /)
            
          else
          
            write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,              &
                  hhead(ivol),phead,sanew(ivol),theta_a
          end if
                                                                       
        elseif (variably_saturated) then
                                                                       
          sgnew(ivol) = r1 - sanew(ivol)                               
          theta_g = pornew(ivol)*sgnew(ivol)  

!c  compute root water uptake for current control volume
          if (root_uptake) then
            transp = cvol(ivol)*rootwat(sanew,ivol,rsum_vprop)
          else
            transp = r0
          end if

          soilevapo = r0
          if (root_uptake .or. pure_evap) then
            if (soilhydrfunc_field) then
              if (h1dry_vol(ivol).gt.r0) then
                soilevapo = cvol(ivol)*evapo(sanew,ivol)
              end if
            else
              izn = mpropvs(ivol)
              if (h1dry(izn).gt.r0) then
                soilevapo = cvol(ivol)*evapo(sanew,ivol)
              end if
            end if
          end if
          
          qroot = transp + soilevapo

          
          if (b_output_binary) then
            realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars)=(/xg(ivol),    &
                   yg(ivol),zout,hhead(ivol),uvsnew(ivol),             &
                   sanew(ivol),theta_a,sgnew(ivol),theta_g,            &
                   qroot,transp,soilevapo/)
          else
            write(igsp,ascii_fmt) xg(ivol),yg(ivol),zout,              &
                  hhead(ivol),uvsnew(ivol),sanew(ivol),theta_a,        &
                  sgnew(ivol),theta_g,qroot,transp,soilevapo
    
          end if
        end if
                                                                       
      end do
      
      if(b_output_binary) then
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igsp, size(realbuffer,1),             &
                      realbuffer, offset_igsp,b_output_mpiio_single)
        else
          call binary_subarray_initialize(nvars,b_mpiarray_igsp_init,  &
                      .false.,mpiarray_filetype_igsp,                  &
                      mpiarray_sizes_gbl_igsp,                         &
                      mpiarray_sizes_sub_igsp,mpiarray_starts_sub_igsp)
          call binary_write_data(igsp, size(realbuffer,1),             &
                      realbuffer, offset_igsp, mpiarray_filetype_igsp)
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer) 
      end if
                                                                       
      if (.not.initial_condition) then
                                                                       
        call velocity (nvxgl, nvygl, nvzgl, iavs, javs,cinfvs_a,dimcv, &
                       xg, yg, zg, uvsnew, hhead, relperm, pornew,     &
                       idbg, ilog, ivel, upstream, fully_saturated,    &
                       njavs, nngl, nn, half_cells,cinfrad,            &
                       radial_coord, offset_ivel)

      end if     

!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
      if(b_output_binary) then
        call binary_file_close(igsp,b_output_mpiio_single) 
        if (.not.initial_condition) then
          call binary_file_close(ivel,b_output_mpiio_single) 
        end if
      else
        close(igsp)
        if (.not.initial_condition) then
          close(ivel)
        end if
      end if
      !Keep the file unit, this will be used later
      !call lun_free(igsp)
      !if (.not.initial_condition) then
      !  call lun_free(ivel)
      !end if

      return
      end
