!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/phys.F90 $
!---------------------------------------------------------------------
!********************************************************************!

      module phys

      use parm

      use geometry_definition
      
      implicit none

!c ----------------------------------------------------------------------
!c common - physical variables
!c
!c ----------------------------------------------------------------------
!c porous medium:
!c --------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           porz(nzn)          = porosity
!c           modulus_young(nzn) = Young's modulus E in the unit of [Pa]
!c           poisson_ratio(nzn) = Poisson's ratio ν in the unit of [-]
!c           modulus_grain(nzn) = Mineral grain modulus Ks for the rock formation [Pa]
!c           modulus_fluid(nzn) = Pore fluid modulus Kf for the rock formation [Pa]
!c           modulus_bulk(nzn)  = Drained bulk modulus of the porous media Kb [Pa]
!c           compressibility(nzn) 
!c                              = coefficient of vertical compressibility beta [Pa^-1]      
!c           density_rock(nzn)  = density of rock in the unit of [kg/m^3]
!c           density_fluid(nzn) = density of fluid in the unit of [kg/m^3]
!c           loading_factor_zn(nzn)
!c                              = 1D loading facotr [-]
!c
!c           character:
!c           ----------
!c           mprop_name(nzn)    = name of material property zone
!c
!c        -->                                                         <--
!c ----------------------------------------------------------------------


      real (type_r8), allocatable :: porz(:)
      real (type_r8), allocatable :: modulus_young(:)
      real (type_r8), allocatable :: modulus_grain(:)
      real (type_r8), allocatable :: modulus_fluid(:)
      real (type_r8), allocatable :: modulus_bulk(:)
      real (type_r8), allocatable :: poisson_ratio(:)
      real (type_r8), allocatable :: compressibility(:)
      real (type_r8), allocatable :: density_rock(:)
      real (type_r8), allocatable :: density_fluid(:)
      real (type_r8), allocatable :: loading_factor_zn(:)

      character*72, allocatable :: mprop_name(:)

!c ----------------------------------------------------------------------
!c variably saturated flow:
!c ------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           aentry(nzn)        = air entry pressure       
!c           condxx(nzn)        = saturated hydraulic conductivity 
!c                                in x-direction
!c           condyy(nzn)        = saturated hydraulic conductivity 
!c                                in y-direction
!c           condzz(nzn)        = saturated hydraulic conductivity 
!c                                in z-direction
!c           expn(nzn)          = soil hydraulic function parameter
!c           permx(nn)          = saturated permeability in 
!c                                x-direction
!c           permy(nn)          = saturated permeability in 
!c                                y-direction
!c           permz(nn)          = saturated permeability in 
!c                                z-direction
!c           spalpha(nzn)       = soil hydraulic function parameter
!c           spbeta(nzn)        = soil hydraulic function parameter
!c           spgamma(nzn)       = soil hydraulic function parameter
!c           spstor(nzn)        = specific storage coefficient
!c           spskempton(nzn)    = specific skempton coefficient
!c           swr(nzn)           = residual saturation           
!c           satwlim(nzn)       = water saturation at wilting point
!c           satwfield(nzn)     = water saturation at field capacity
!c           rew0(izn)          = relative extractable water at
!c                                50% of maximum extraction capacity 
!c                                (fitting parameter)
!c           rewm               = mean reserve of extractible water  CBF
!c           rate_root_max(nzn) = maximum root water uptake rate
!c           satwdry(nzn)       = air-dry water saturation

!c           h1dry(nzn)         = air-dry aqueous pressure  CBF
!c           h1field(nzn)       = aqueous pressure at field capacity FG
!c           h1opt(nzn)         = optimal aqueous pressure  FG
!c           h1lim(nzn)         = aqueous pressure at wilting point FG
!c           pvol(nzn)          = volume of property zone (used for evaporation)  CBF 
!c           root_length_dens(nzn) = root length density
!c           tree_trans_factor(nzn) = tree transpiration factor
!c           canopy_evap_factor(nzn) = efficiency factor for canopy
!c                                     evaporation
!c
!c           integer*4:
!c           ----------
!c           nzn                = number of material property zones
!c
!c           logical:
!c           --------
!c           permeability_field = .true.  -> read permeability field
!c                                .false. -> specify permeabilities
!c                                           in input file
!c           oil_saturation     = .true.  -> read oil saturation field
!c                                           account for decrease in
!c                                           porosity due to oil
!c                                           account for decrease in 
!c                                           aqueous saturation
!c                                .false. -> oil is not present
!c        -->                                                         <--
!c ----------------------------------------------------------------------

      real (type_r8), allocatable :: pvol(:) ! CBF
      real (type_r8), allocatable :: condxx(:)
      real (type_r8), allocatable :: condyy(:)
      real (type_r8), allocatable :: condzz(:)
      real (type_r8), allocatable :: permx(:)
      real (type_r8), allocatable :: permy(:)
      real (type_r8), allocatable :: permz(:)
      real (type_r8), allocatable :: spstor(:)
      real (type_r8), allocatable :: spskempton(:)
      real (type_r8), allocatable :: swr(:)
      real (type_r8), allocatable :: spalpha(:)
      real (type_r8), allocatable :: spbeta(:)
      real (type_r8), allocatable :: spgamma(:)
      real (type_r8), allocatable :: expn(:)
      real (type_r8), allocatable :: aentry(:)
      real (type_r8), allocatable :: satwlim(:)
      real (type_r8), allocatable :: satwfield(:)
      real (type_r8), allocatable :: satwopt(:)  !FG June 2021
      real (type_r8), allocatable :: rew0(:)
      real (type_r8), allocatable :: rate_root_max(:)
      real (type_r8), allocatable :: satwdry(:)
      real (type_r8), allocatable :: h1dry(:) ! CBF 
      real (type_r8), allocatable :: h1lim(:)
      real (type_r8), allocatable :: h1opt(:)
      real (type_r8), allocatable :: h1field(:)

      real (type_r8), allocatable :: root_length_dens(:)
      real (type_r8), allocatable :: tree_trans_factor(:)

      real (type_r8) :: rewm        ! CBF
      real (type_r8) :: rsum_vprop

      type(tensor), allocatable :: cond_tensor(:)
      type(tensor), allocatable :: perm_tensor(:)

      integer (type_i4) :: nzn

      logical :: permeability_field
      
      logical :: is_cell_based_perm_cond
      logical :: is_cell_based_relp

      logical :: oil_saturation
      
      real (type_r8)              :: sgr ! Gas residual saturation    
      
!cdsu  hydraulic conductivity relationship over depth, compared to the K at the surface
!cdsu  here we use a similar permeability relationship over depth reported by 
!cdsu  Stefano Delfino Normani, 2009, Paleoevolution of Pore Fluids in Glaciated Geologic Settings,
!cdsu  PhD thesis presented to the University of Waterloo, pp 71-72.
!cdsu  K(depth)/K(surface) = 10**(a*exp(-b*depth)-c)
      real (type_r8), allocatable :: k_depth_parms(:,:)
      real (type_r8), allocatable :: k_depth_ratio(:)

      !cprovi----------------------------------------------------------
      !cprovi Porosity filed boolean 
      !cprovi Sergio Andres Bea Jofre 
      !cprovi----------------------------------------------------------
      logical :: porosity_field
      logical :: tortuosity_field
      logical :: tortuosity_field_gas
      logical :: dispersivity_field
      logical :: storcoeff_field
      logical :: skempton_field

      !cdsu calculate material properties based on hydromechanical parameters.
      !cdsu reference: J.F. Sykes, S.D. Normani, and Y. Yin, Hydrogeologic Modelling, NWMO DGR-TR-2011-16
      logical, allocatable :: porosity_mech_cal(:)
      logical, allocatable :: storcoeff_mech_cal(:)
      logical, allocatable :: skempton_mech_cal(:)
      logical, allocatable :: loadingfactor_mech_cal(:)
      logical, allocatable :: loadingfactor_specified(:)

      !cdsu----------------------------------------------------------
      !cdsu node based soil hydraulic function parameters
      !cdsu----------------------------------------------------------

      logical :: soilhydrfunc_field
      real (type_r8), allocatable :: swr_vol(:)
      real (type_r8), allocatable :: spalpha_vol(:)
      real (type_r8), allocatable :: spbeta_vol(:)
      real (type_r8), allocatable :: spgamma_vol(:)
      real (type_r8), allocatable :: expn_vol(:)
      real (type_r8), allocatable :: aentry_vol(:)
      real (type_r8), allocatable :: h1dry_vol(:)
      real (type_r8), allocatable :: satwdry_vol(:)
      !cprovi----------------------------------------------------------

      !cdsu----------------------------------------------------------
      !cdsu node based root water uptake parameters
      !cdsu----------------------------------------------------------
      logical :: rootwateruptake_field
      real (type_r8), allocatable :: satwlim_vol(:)
      real (type_r8), allocatable :: satwfield_vol(:)
      real (type_r8), allocatable :: h1field_vol(:)
      real (type_r8), allocatable :: satwopt_vol(:)
      real (type_r8), allocatable :: h1lim_vol(:)
      real (type_r8), allocatable :: h1opt_vol(:)
      real (type_r8), allocatable :: uptakefactor_vol(:)

      !cdsu----------------------------------------------------------
      !cdsu node based root water uptake parameters for output only
      !cdsu----------------------------------------------------------
      real (type_r8), allocatable :: alpha_vol(:)
      real (type_r8), allocatable :: v_prop_vol(:)

      !cdsu----------------------------------------------------------
      !cdsu node based Battaglia reduction function parameters
      !cdsu----------------------------------------------------------
      logical :: battaglia_field
      real (type_r8), allocatable :: p1_vol(:)
      real (type_r8), allocatable :: rew0_vol(:)

!c ----------------------------------------------------------------------
!c reactive transport:
!c -------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           disx(nzn)          = longitudinal dispersivity
!c           disy(nzn)          = transverse horizontal dispersivity
!c           disz(nzn)          = transverse vertical dispersivity
!c           diff_a             = free diffusion coefficient in aqueous
!c                                phase (equal for all species)
!c           diff_g             = free diffusion coefficient in gaseous
!c                                phase (equal for all species)
!c           frozen_diff_a      = free diffusion coefficient in aqueous
!c                                phase (equal for all species) under
!c                                frozen condition, reduction ratio
!c           frozen_diff_g      = free diffusion coefficient in gaseous
!c                                phase (equal for all species) under
!c                                frozen condition, reduction ratio
!c        -->                                                         <--
!c ----------------------------------------------------------------------

      real (type_r8), allocatable :: disx(:) 
      real (type_r8), allocatable :: disy(:)
      real (type_r8), allocatable :: disz(:) 

      real (type_r8), allocatable :: disx_prev(:) 
      real (type_r8), allocatable :: disy_prev(:)
      real (type_r8), allocatable :: disz_prev(:) 

      real (type_r8), allocatable :: disx_next(:) 
      real (type_r8), allocatable :: disy_next(:)
      real (type_r8), allocatable :: disz_next(:) 

      logical :: is_cell_based_disp_rt
      logical :: is_cell_based_disp_heat

      real (type_r8) :: diff_a
      real (type_r8) :: diff_g
      real (type_r8) :: frozen_diff_a
      real (type_r8) :: frozen_diff_g

!cdsu diffusion coefficient tensor
      type(tensor) :: diff_a_tensor
      type(tensor) :: diff_g_tensor

!cprovi------------------------------------------------------------------
!cprovi 
!cprovi------------------------------------------------------------------
      real (type_r8), allocatable :: permx0(:)
      real (type_r8), allocatable :: permy0(:)
      real (type_r8), allocatable :: permz0(:)
      type(tensor), allocatable :: perm0_tensor(:)
!cprovi------------------------------------------------------------------
!cprovi Parameters for oven dry model
!cprovi Fayer, M.J. & C.S. Simmons, 1995. Modified Soil Water 
!cprovi Retention Functions for All Matric Suctions, 
!cprovi Water Resour. Res. 31(5), 1233?238.
!cprovi------------------------------------------------------------------
      real (type_r8), allocatable :: hm_ovendry(:)
      real (type_r8), allocatable :: w0_ovendry(:)
      real (type_r8), allocatable :: beta_ovendry(:)
      real (type_r8), allocatable :: cp0_ovendry(:)
      logical, allocatable        :: isovendrying(:)
!cprovi------------------------------------------------------------------
!cprovi------------------------------------------------------------------
!cprovi------------------------------------------------------------------

!c ----------------------------------------------------------------------
!c gas transport:
!c ---------------------------
!c modified: Sergi Molins - May 2, 2006
!c
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           dens_h2o           = density of the aqueous phase
!c           visc_h2o           = viscosity of the aqueous phase
!c           dens_gcnst         = constant density of the gas phase
!c           visc_gconst        = viscosity of the gas phase
!c           dens_g(nn)         = density of the gas phase
!c           visc_g(nn)         = viscosity of the gas phase
!c           mdens_g(nn)        = molar density of the gas phase
!c           visc_comp_g(ng)    = individual viscosities
!c           diff_bin_g(ng,ng)  = binary diffusion coefficients
!c           theta_diff         = exponent of temp correction (diff_temp=.true.)
!c
!c           logical:
!c           --------
!c           update_dens_g      = update density based on concs/mol fract
!c           blanc_diff_g       = calculate diff coeff using Blanc's expr
!c           diff_press         = correct diff_bin_g for dependence on pres
!c           diff_temp          = correct diff_bin_g for dependence on temp
!c
!c           character:
!c           ----------
!c           variable_visc_g    = variable viscosity (const,Wilke,linear)
!c        -->                                                         <--
!c ----------------------------------------------------------------------

       real (type_r8) :: dens_h2o 
       real (type_r8) :: visc_h2o

       real (type_r8) :: dens_gcnst 
       real (type_r8) :: visc_gcnst

       real (type_r8) :: theta_diff

       real (type_r8), allocatable :: dens_g(:)
       real (type_r8), allocatable :: visc_g(:)
       real (type_r8), allocatable :: mdens_g(:)

       logical :: update_dens_g
       logical :: blanc_diff_g
       logical :: diff_press
       logical :: diff_temp

       character*8 :: variable_visc_g
     
       real (type_r8), allocatable :: visc_comp_g(:)  
       real (type_r8), allocatable :: diff_bin_g(:,:) 

!cdsu orientation and rotation matrix information based on Tait-Bryan angles, convention ZYX.
!cdsu Tait-Bryan angles alpha (α), beta (β) and gamma (γ), about axes z, y, x, respectively.
!cdsu This represents a rotation for an object whose yaw, pitch, and roll angles are α, β and γ, respectively.
!cdsu The axes (z, y and x) are alternatively designated as vertical, transverse and longitudinal respectively. 
       type(point), allocatable :: aca_vol(:)                 !unit: radian

!cdsu anisotropic tortuosity correction factor for principle axis
       type(point), allocatable :: atc_zone(:)

      end module phys
