!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/solver/solver_runtime.F90 $
!---------------------------------------------------------------------
!********************************************************************!


!>
!> module solver_runtime
!>
!> This module includes functions for performance profiling
!>
!> written by:      Danyang Su
!>
!> last modified:   Danyang Su - Nov. 24, 2017
!>

module solver_runtime

  use gen
  use writeversion
  use file_unit, only : lun_get, lun_free
  use m_heat_transport, only : heat_transport, decoupled_type_vs_heat

  implicit none

  contains

  !> open runtime file
  subroutine openruntimefile

    implicit none
    
    !iprt_flow        = 83
    !iprt_react       = 84
    !iprt_nonlinear    = 85
    !iprt_timestep    = 86
    !iprt_flow_comp   = 87
    !iprt_react_comp  = 88
    !iprt_react_jac   = 89
    
    iprt_flow        = lun_get()
    iprt_react       = lun_get()
    iprt_nonlinear   = lun_get()
    iprt_timestep    = lun_get()
    iprt_flow_comp   = lun_get()
    iprt_react_comp  = lun_get()
    iprt_react_jac   = lun_get()
    iprt_flow_lis    = lun_get()
    iprt_react_lis   = lun_get()
        
        
!c  parallel runtime (prt) of different modules in parallel system
    
    if (b_prtfile) then
!c  flow runtime
      open(iprt_flow,file=prefix(:l_prfx)//'_flow.prt',                &
           status='unknown',form='formatted')
            
!c  version information
      if (b_writeversion_tecplot ) then
        call writeversion2file(iprt_flow, "#")
      end if
            
!c  title and variables        
      write(iprt_flow,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
      write(iprt_flow,'(5a)')                                          &
            'variables = "time step", "Picard iteration", ',           &
            '"seepage iteration", "Newton iteration", ',               &
            '"total Newton iterations", "construct matrix", ',         &
            '"symbolic factorization", "factorization", ',             &
            '"substitution", "solver", "other", "total"'
      write(iprt_flow,'(2a)') 'zone t = "flow", f=point'

      if (heat_transport .and. decoupled_type_vs_heat > 1) then
!c  heat transport runtime
        open(iprt_heat,file=prefix(:l_prfx)//'_heat.prt',              &
             status='unknown',form='formatted')
            
!c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(iprt_heat, "#")
        end if
            
!c  title and variables        
        write(iprt_heat,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(iprt_heat,'(5a)')                                        &
              'variables = "time step", "Picard iteration", ',         &
              '"seepage iteration", "Newton iteration", ',             &
              '"total Newton iterations", "construct matrix", ',       &
              '"symbolic factorization", "factorization", ',           &
              '"substitution", "solver", "other", "total"'
        write(iprt_heat,'(2a)') 'zone t = "heat", f=point'      
      end if
            
!c  reactive transport runtime        
      open(iprt_react,file=prefix(:l_prfx)//'_react.prt',              &
           status='unknown',form='formatted')
!c  version information
      if (b_writeversion_tecplot ) then
        call writeversion2file(iprt_react, "#")
      end if
            
!c  title and variables            
      write(iprt_react,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
      write(iprt_react,'(4a)')                                         &
            'variables = "time step", "Picard iteration", ',           &
            '"Newton iteration", "total Newton iterations", ',         &
            '"construct matrix", "symbolic factorization", ',          &
            '"factorization", "substitution", "solver", "other", "total"'
      write(iprt_react,'(2a)') 'zone t = "reactive transport", f=point'
            
#ifdef LIS
!c  flow runtime for lis solver
      if (varsat_flow) then
        open(iprt_flow_lis,file=prefix(:l_prfx)//'_flow_lis.prt',      &
             status='unknown',form='formatted')

!c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(iprt_flow_lis, "#")
        end if
            
!c  title and variables        
        write(iprt_flow_lis,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(iprt_flow_lis,'(5a)')                                    &
              'variables = "time step", "Picard iteration", ',         &
              '"seepage iteration", "Newton iteration", ',             &
              '"total Newton iterations", "local to global rhs", ',    &
              '"local to global matrix", "preconditioning time", ',    &
              '"iteration time", "global to local results", "total time"'
        write(iprt_flow_lis,'(2a)') 'zone t = "flow_lis_time", f=point'
      end if

      if (heat_transport .and. decoupled_type_vs_heat > 1) then
!c  heat transport runtime for lis solver
        open(iprt_heat_lis,file=prefix(:l_prfx)//'_heat_lis.prt',      &
             status='unknown',form='formatted')
    
    !c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(iprt_heat_lis, "#")
        end if
                
    !c  title and variables        
        write(iprt_heat_lis,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(iprt_heat_lis,'(5a)')                                    &
              'variables = "time step", "Picard iteration", ',         &
              '"seepage iteration", "Newton iteration", ',             &
              '"total Newton iterations", "local to global rhs", ',    &
              '"local to global matrix", "preconditioning time", ',    &
              '"iteration time", "global to local results", "total time"'
        write(iprt_heat_lis,'(2a)') 'zone t = "heat_lis_time", f=point'
      end if    

!c  reactive transport runtime for lis solver
      if (reactive_transport) then
        open(iprt_react_lis,file=prefix(:l_prfx)//'_react_lis.prt',    &
             status='unknown',form='formatted')
            
!c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(iprt_react_lis, "#")
        end if
            
!c  title and variables        
        write(iprt_react_lis,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(iprt_react_lis,'(5a)')                                   &
              'variables = "time step", "Picard iteration", ',         &
              '"seepage iteration", "Newton iteration", ',             &
              '"total Newton iterations", "local to global rhs", ',    &
              '"local to global matrix", "preconditioning time", ',    &
              '"iteration time", "global to local results", "total time"'
        write(iprt_react_lis,'(2a)') 'zone t = "react_lis_time", f=point'
      end if
#endif


!c  reactive transport runtime        
      open(iprt_react_jac,file=prefix(:l_prfx)//'_react_jac.prt',      &
           status='unknown',form='formatted')
!c  version information
      if (b_writeversion_tecplot ) then
        call writeversion2file(iprt_react, "#")
      end if
            
!c  title and variables            
      write(iprt_react_jac,'(3a)')                                     &
            'title = "matrix assemble of reactive transport ',         &
            prefix(:l_prfx),'"'
      write(iprt_react_jac,'(3a)')                                     &
            'variables = "time step", "Picard iteration", '   ,        &
            '"Newton iteration", "total Newton iterations", ',         &
            '"part1", "part2", "part3", "part4", "part5", "total"'
      write(iprt_react_jac,'(2a)') 'zone t = "reactive transport", f=point'
 
      if (b_solver_test_pardiso) then
!c  matrix solver for flow runtime compare
        open(iprt_flow_comp,file=prefix(:l_prfx)//'_flow_comp.prt',    &
             status='unknown',form='formatted')
            
!c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(iprt_flow_comp, "#")
        end if
            
!c  title and variables        
        write(iprt_flow_comp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(iprt_flow_comp,'(5a)')                                   &
              'variables = "time step", "Picard iteration", ',         &
              '"seepage iteration", "Newton iteration", ',             &
              '"total Newton iterations", "factorization", ',          &
              '"substitution", "symbolic factorization",  ',           &
              '"factorization_comp", "substitution_comp"'
        write(iprt_flow_comp,'(2a)') 'zone t = "flow", f=point'

        if (heat_transport .and. decoupled_type_vs_heat > 1) then
!c  matrix solver for heat runtime compare
          open(iprt_heat_comp,file=prefix(:l_prfx)//'_heat_comp.prt',  &
          status='unknown',form='formatted')
           
!c  version information
          if (b_writeversion_tecplot ) then
            call writeversion2file(iprt_heat_comp, "#")
          end if
           
!c  title and variables        
          write(iprt_heat_comp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          write(iprt_heat_comp,'(5a)')                                 &
                'variables = "time step", "Picard iteration", ',       &
                '"seepage iteration", "Newton iteration", ',           &
                '"total Newton iterations", "factorization", ',        &
                '"substitution", "symbolic factorization",  ',         &
                '"factorization_comp", "substitution_comp"'
          write(iprt_heat_comp,'(2a)') 'zone t = "heat", f=point'
        end if            
            
!c  matrix solver for reactive transport runtime compare    
        open(iprt_react_comp,file=prefix(:l_prfx)//'_react_comp.prt',  &
             status='unknown',form='formatted')
!c  version information
        if (b_writeversion_tecplot ) then
          call writeversion2file(iprt_react, "#")
        end if
            
!c  title and variables            
        write(iprt_react_comp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        write(iprt_react_comp,'(5a)')                                  &
              'variables = "time step", "Picard iteration", ',         &
              '"Newton iteration", "total Newton iterations", ',       &
              '"factorization", "substitution", ',                     &
              '"symbolic factorization", "factorization_comp", ',      &
              '"substitution_comp"'
        write(iprt_react_comp,'(2a)') 'zone t = "reactive transport", f=point'
      end if
            
!c  nonlinear equation time        
      open(iprt_nonlinear,file=prefix(:l_prfx)//'_nonlinear.prt',      &
           status='unknown',form='formatted')
!c  version information
      if (b_writeversion_tecplot ) then
        call writeversion2file(iprt_nonlinear, "#")
      end if
            
!c  title and variables            
      write(iprt_nonlinear,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
      write(iprt_nonlinear,'(3a)')                                     &
            'variables = "time step", "Picard iteration", ',           &
            '"total Picard iterations", "flow and heat transport", ',  &
            '"reactive transport", "other", "total"'
      write(iprt_nonlinear,'(2a)') 'zone t = "nonlinear iterations", f=point'

!c  time step            
      open(iprt_timestep,file=prefix(:l_prfx)//'_timestep.prt',        &
           status='unknown',form='formatted')
!c  version information
      if (b_writeversion_tecplot ) then
        call writeversion2file(iprt_timestep, "#")
      end if
            
!c  title and variables            
      write(iprt_timestep,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
      write(iprt_timestep,'(2a)') 'variables = "time step", ',         &
                           '"nonlinear time", "other", "total"'
      write(iprt_timestep,'(2a)') 'zone t = "time step", f=point'
                
    end if

    
  end subroutine openruntimefile
    
    !> close runtime file
    subroutine closeruntimefile
    
        implicit none
        
        !c  parallel runtime (prt) of different modules in parallel system
    
        if (b_prtfile) then
            close(iprt_flow)
            close(iprt_react)
            call lun_free(iprt_flow)
            call lun_free(iprt_react)
            if (b_solver_test_pardiso) then
                close(iprt_flow_comp)                
                close(iprt_react_comp)
                call lun_free(iprt_flow_comp)
                call lun_free(iprt_react_comp)
            end if
            close(iprt_nonlinear)
            close(iprt_timestep)
            call lun_free(iprt_nonlinear)
            call lun_free(iprt_timestep)
#ifdef LIS
            close(iprt_flow_lis)
            close(iprt_react_lis)
            call lun_free(iprt_flow_lis)
            call lun_free(iprt_react_lis)
#endif
        end if
    
    end subroutine closeruntimefile

end module solver_runtime
