!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readint_new.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readint_new
!c ----------------------
!c
!c read database for intra-aqueous kinetic reactions and assign to 
!c permanent storage
!c
!c written by:      Uli Mayer - July 13, 02
!c                  based on readint, adjusted to new database format
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           irdbs              = unit number, database for redox     + -
!c                                             couples
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number, debugging file         + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           dgaq(naq)          = activation energies for intra-      * +
!c                                aqueous kinetic reaction
!c           dhaq(naq)          = enthalpy changes for intra-aqueous  * +
!c                                kinetic reaction
!c           eqaqs(naq)         = equilibrium constants for           * +
!c                                intra-aqueous kinetic reactions
!c                                at standard temperature
!c           faqic(naq*nc)      = inhibition factors C^c              * +
!c           faqit(naq*nc)      = inhibition factors T^a              * +
!c           faqim(naq*nm)      = inhibition factors phi^m            * +
!c           faqhc(naq*nc)      = half saturation constants C^c       * +
!c           faqht(naq*nc)      = half saturation constants T^a       * +
!c           faqhm(naq*nm)      = half saturation constants phi^m     * +
!c           ordaqic(naq*nc)    = order of intra-aqueous kinetic      * +
!c                                reaction for inhibition terms C^c
!c           ordaqit(naq*nc)    = order of intra-aqueous kinetic      * +
!c                                reaction for inhibition terms T^a
!c           ordaqim(naq*nc)    = order of intra-aqueous kinetic      * +
!c                                reaction for inhibition terms phi^m
!c           ordaqhc(naq*nc)    = order of intra-aqueous kinetic      * +
!c                                reaction for hyperbolic terms C^c
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      * +
!c                                reaction for hyperbolic terms T^a
!c           ordaqhm(naq*nm)    = order of intra-aqueous kinetic      * +
!c                                reaction for hyperbolic terms phi^m
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      * +
!c                                reaction with respect to total 
!c                                aqueous component concentrations
!c           ordaqc(naq*nc)     = order of intra-aqueous kinetic      * +
!c                                reaction with respect  
!c                                concentrations of components 
!c                                as species in solution
!c           ordaqx(naq*nx)     = order of intra-aqueous kinetic      * +
!c                                reaction with respect  
!c                                concentrations of aqueous 
!c                                complexes
!c           ratecaqs(naq)      = log of rate constant for intra-     * +
!c                                aqueous kinetic reactions
!c                                at standard temperature
!c                                (units: liter -  moles - seconds)
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       * +
!c                                components in intra-aqueous 
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                * +
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqic(naq+1)      = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms C^c)
!c           iaaqit(naq+1)      = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms T^a)
!c           iaaqhc(naq+1)      = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms C^c)
!c           iaaqht(naq+1)      = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms T^a)
!c           iaaqhm(naq+1)      = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms phi^m)
!c           iaaqt(naq+1)       = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (fractional order terms T^a)
!c           iaaqc(naq+1)       = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (fractional order terms C^c)
!c           iaaqe(naq+1)       = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions
!c                                (exponential term T^a)
!c           iaaqx(naq+1)       = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (fractional order terms C^x)
!c           jaaq(naq*nc)       = column pointer array to             * +
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqic(naq*nc)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms C^c)
!c           jaaqit(naq*nc)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms T^a)
!c           jaaqim(naq*nc)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms phi^m)
!c           jaaqhc(naq*nc)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms C^c)
!c           jaaqht(naq*nc)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms T^a)
!c           jaaqhm(naq*nm)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms phi^m)
!c           jaaqt(naq*nc)      = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (fractional order terms T^a)
!c           jaaqc(naq*nc)      = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (fractional order terms C^c)
!c           jaaqe(naq*nc)      = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions
!c                                (exponential term T^a)
!c           jaaqx(naq*nx)      = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (fractional order terms C^x)
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c           nm                 = number of minerals                  + -
!c           nx                 = number of aqueous complexes         + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           namex(nx)          = names of secondary aqeuous species  + -
!c           namem(nm)          = mineral names                       + -
!c           namet(30)          = species names (temporary)           * *
!c           rtype_aq(naq)      = reaction type of intra-aqueous      * +
!c                                kinetic reaction
!c                                'monod'
!c           
!c
!c local:    real*8:
!c           -------
!c           value(100)         = array for temporary storage of
!c                                reaction orders
!c           value2(100)        = array for temporary storage of
!c                                reaction orders
!c           r0                 = constant
!c           r10                = constant
!c           r86400             = constant
!c           xnut(100)           = array for temporary storage of
!c                                stoichiometric coefficients
!c
!c           integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic 
!c                                         reactions)
!c           iaqic              = counter
!c           iaqit              = counter
!c           iaqim              = counter
!c           iaqhc              = counter
!c           iaqht              = counter
!c           iaqhm              = counter
!c           iaqt               = counter
!c           iaqe               = counter
!c           iaqc               = counter
!c           iaqx               = counter
!c           ic                 = counter (components)
!c           icount             = counter
!c           icur               = pointer
!c           im                 = counter (minerals)
!c           ix                 = counter (aqueous complexes)
!c           istart             = pointer
!c           istop              = pointer
!c           iv                 = counter
!c           naqic              = number of inhibition terms C^c
!c           naqit              = number of inhibition terms T^a
!c           naqim              = number of inhibition terms phi^m
!c           naqhc              = number of hyperbolic terms C^c
!c           naqht              = number of hyperbolic terms T^a
!c           naqhm              = number of hyperbolic terms phi^m
!c           naqt               = number of fractional order terms T^a
!c           naqe               = number of exponential term T^a
!c           naqc               = number of fractional order terms C^c
!c           naqx               = number of fractional order terms C^x
!c           nv                 = number of components with nonzero
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reaction
!c                                (temporary)
!c
!c           logical:
!c           --------
!c           comment_line       = .true.  -> read comment line
!c           done               = .true.  -> exit search
!c           found              = .true.  -> exit search
!c           next_entry         = .true.  -> database entry for
!c                                           next intra-aqueous
!c                                           reaction
!c
!c           character:
!c           ----------
!c           junk               = dummy character variable
!c           name_aq            = name of intra-aqueous kinetic reaction
!c                                (temporary)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readint_new(irdbs,ilog,idbg)
 
      use parm
      use chem
      use gen, only : rank, b_enable_output, idbs_bk, use_dbs_bk
      use file_utility, only : makelowercase, replacecharacter,        &
                               readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
      integer :: irdbs,ilog,idbg
      
      integer :: i, i1, i2, ii, im, info_debug, iaq, iaq1, iaqc, iaqhc,&
                 iaqim, iaqhm, iaqht, iaqic, iaqit, iaqt, iaqx, ic,    &
                 icur, icount, istart, istop, istart2, istop2, iv, ix, &
                 icount2,icur2, idiff,iinc, iiso, iiso2,im1,inaqhst2,  &
                 nifr, nprsc, naqc, naqhc, naqim, naqhm, naqht,        &
                 naqic, naqit, naqt, naqx, nv, nw, inaqhst,            &
                 itemp, naqhst, ntsct, iaqe, naqe

      character*1 junk, string
      character*72 name_aq, namet3
      character*72 keyword
      character*256 :: strbuffer
      real*8 :: dummy
      real*8 :: xnut(100), value(100), value2(100), ordt(100),         &
                alphat(100,100)

      integer :: ntsct2(100), iinum(100)
      
      logical comment_line, done, found, next_entry, searching,        &
               found_keyword

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r10 = 10.0d0,       &
                           r86400 = 8.64d4  

      info_debug = 0
      isofraca = .false.
      isofracam = .false.

!c initialize pointer arrays for sparse matrix structure
 
      iaaq(1) = 1
      iaaqt(1) = 1
      iaaqc(1) = 1
      iaaqe(1) = 1
      iaaqx(1) = 1
      iaaqht(1) = 1
      iaaqhc(1) = 1
      iaaqhm(1) = 1
      iaaqit(1) = 1
      iaaqic(1) = 1
      iaaqim(1) = 1
      iaaqhst(1)= 1
      iaaqhst2(1)= 1
      iamdisoa(1)= 1
      iamdisoa2(1)= 1
      
!c_bubbles initialize minimum delta G for reations

      dg_limaq =  r1
 
!c  loop over intra-aqueous kinetic reactions specified for 
!c  simulation
 
      do iaq = 1,naq
 
!c  loop over intra-aqueous kinetic reactions in database, search for 
!c  match, read reaction data and store in compressed format
!c  exit when done or if end of database is reached
 
        done = .false.
 
        do while (.not.done)
 
!c  skip over comment lines in database
 
          comment_line = .true.
          do while (comment_line)
            read (irdbs,'(a1)',end = 998,err=999) junk
            if (junk.ne.'!') comment_line = .false.
          end do
 
!c  backspace to start of database entry for current intra-aqueous
!c  reaction

          backspace(irdbs)

!c  read name of intra-aqueous kinetic reaction 
 
          read(irdbs,*,end = 998,err=999) name_aq

!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  intra-aqueous kinetic reaction is found --> read data
 
          if (name_aq.eq.nameaq(iaq)) then

!c  define default values

            eqaqs(iaq) = r0
            dhaq(iaq) = r0
            dgaq(iaq) = r0
            ratecaqs(iaq) = r0
            ratecaqs(iaq) = (r10**ratecaqs(iaq))*r86400           

            if (info_debug.eq.2) then
              write(*,*) '---------------------------'
              write(*,*) trim(name_aq)
            end if 
            done = .true.

!c  read components involved in current intra-aqueous kinetic reaction 
!c  and reaction stoichiometry

            read(irdbs,*,err=999) nv,(namet(iv),xnut(iv),iv=1,nv)

!c  pointer array to row in stoichiometric reaction matrix for 
!c  next intra-aqueous kinetic reaction

            iaaq(iaq+1) = iaaq(iaq) + nv
 
!c  check if reactants and reaction products of current
!c  intra-aqueous kinetic reactions are specified as components,
!c  set up pointer array to column in stoichiometric matrix
        
            icount = 0
            ic = 0
            do while ((icount.lt.nv).and.(ic.lt.nc))
              ic = ic+1
              iv = 0
              found = .false.
              do while ((iv.lt.nv).and.(.not.found))
                iv = iv+1
                if (namet(iv).eq.namec(ic)) then
                  found = .true.
                  icount = icount+1
                  icur = iaaq(iaq)+iv-1
                  jaaq(icur) = ic
                end if
              end do
            end do

!c  exit, if component is missing
 
            if (icount.ne.nv) then
              if (rank == 0) then  
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(5a)')                                      &
     &                     'component for intra-aqueous kinetic ',      &
     &                     'reaction ',nameaq(iaq)(:l_nameaq(iaq)),     &
     &                     ' is missing'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
!c  all components available --> read data and assign to arrays
 
            elseif (icount.eq.nv) then
 
!c  assign stoichiometric coefficients
 
              istart = iaaq(iaq)
              istop = iaaq(iaq+1)-1
              iv = 0
              do i = istart,istop
                iv = iv+1
                xnuaq(i) = xnut(iv) 
              end do

!c  read equilibrium constant and enthalpy change for reversible
!c  reactions or reactions affected by thermodynamic constraints 

              read(irdbs,*,err=999) rtype_aq(iaq)

            if (rtype_aq(iaq).eq.'reversible'.or.                   &
     &          rtype_aq(iaq).eq.'irreversible - log K control') then 
               
              backspace(irdbs)
              read(irdbs,*,err=999) rtype_aq(iaq),eqaqs(iaq),dhaq(iaq)
              eqaqs(iaq) = r10**eqaqs(iaq)


            
            end if

!c  ---------------------------------------------------------------------
!c  log rate constant

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for log rate constant: ',       &
     &                      nameaq(iaq)
            end if

            found = .false.
            searching = .true.
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string


                                
              if (keyword.eq.'log rate constant') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,ratecaqs(iaq)


                if (info_debug.gt.1) then
                  write(*,*) keyword, ratecaqs(iaq)
                end if

!c  convert log rate constant to rate constant and convert time units
!c  from seconds to days
!c
                  ratecaqs(iaq) = (r10**ratecaqs(iaq))*r86400

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do
            
!c  ---------------------------------------------------------------------
!c  threshold energy

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
              write(*,*) 'searching for threshold energy: ',nameaq(iaq)
            end if

            found = .false.
            searching = .true.
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string
                                
              if (keyword.eq.'threshold energy') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,dg_limaq(iaq)
                if (info_debug.gt.1) then
                  write(*,*) keyword, dg_limaq(iaq)
                end if

!c  convert threshold term to required value
                dg_limaq(iaq) = exp(dg_limaq(iaq)/tempks/(rgasjoule/1000))

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do   

!c  ---------------------------------------------------------------------
!c  activation energy

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
              write(*,*) 'searching for activation energy: ',nameaq(iaq)
            end if

            found = .false.
            searching = .true.
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string
                                
              if (keyword.eq.'activation energy') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,dgaq(iaq)
                if (rank==0 .and. b_enable_output .and. info_debug.gt.1) then
                  write(*,*) keyword, dgaq(iaq)
                end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do
            
!crevintaff
!c  ---------------------------------------------------------------------
!c  activation energy

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (info_debug.gt.1) then
              write(*,*) 'searching for affinity term control keyword: ',   &
     &                      nameaq(iaq)
            end if

            found = .false.
            searching = .true.
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string


                                
              if (keyword.eq.'reverse affinity term') then
                  
                found = .true.
                reverse_intra_affinity(iaq) = .true.

                if (info_debug.gt.1) then
                  write(*,*) keyword, dgaq(iaq)
                end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do
!crevintaff

!c  ----------------------------------------------------------------------
!c  fractional order terms, total aqueous component concentrations

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for fractional order terms: T^a'
            end if

            found = .false.
            searching = .true.
            naqt = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'fractional T^a') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqt

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqt
                end if

!c  read names of components and reaction orders

                do i = 1,naqt
                  read(irdbs,*,err=999) namet(i),value(i)
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  ic = 0
                  do while ((icount.lt.naqt).and.(ic.lt.nc))
                    found = .false.
                    iaqt = 0
                    ic = ic+1
                    do while ((iaqt.lt.naqt).and.(.not.found))
                      iaqt = iaqt+1
                      if (namet(iaqt).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqt(iaq)+iaqt-1
                        jaaqt(icur) = ic
                        ordaqt(icur) = value(iaqt)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqt) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

            iaaqt(iaq+1) = iaaqt(iaq) + naqt

!c  ----------------------------------------------------------------------
!c  fractional order terms, total aqueous component concentrations

            call findname(nameaq(iaq),irdbs,found_keyword)

            if (info_debug.gt.1) then
              write(*,*) 'searching for exponential terms: T^a'
            end if

            found = .false.
            searching = .true.
            naqe = 0

            do while (searching.and..not.found)

              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

              if (keyword.eq.'exponential T^a') then

                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqe

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqe
                end if

!c  read names of components and reaction orders

                do i = 1,naqe
                  read(irdbs,*,err=999) namet(i),value(i)
                end do

!c  check if all specified reactants are defined as components
!c  assign pointer to species and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  ic = 0
                  do while ((icount.lt.naqe).and.(ic.lt.nc))
                    found = .false.
                    iaqe = 0
                    ic = ic+1
                    do while ((iaqe.lt.naqe).and.(.not.found))
                      iaqe = iaqe+1
                      if (namet(iaqe).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqe(iaq)+iaqe-1
                        jaaqe(icur) = ic
                        ordaqe(icur) = value(iaqe)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqe) then
                    if (rank == 0) then
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

            iaaqe(iaq+1) = iaaqe(iaq) + naqe
!c  ----------------------------------------------------------------------
!c  fractional order terms, activities of components as species in
!c  solution

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for fractional order terms: C^c'
            end if

            found = .false.
            searching = .true.
            naqc = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'fractional C^c') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqc

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqc
                end if

!c  read names of components and reaction orders

                do i = 1,naqc
                  read(irdbs,*,err=999) namet(i),value(i)
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and order of reaction

!c  components as species in solution

                  icount = 0
                  ic = 0
                  do while ((icount.lt.naqc).and.(ic.lt.nc))
                    found = .false.
                    iaqc = 0
                    ic = ic+1
                    do while ((iaqc.lt.naqc).and.(.not.found))
                      iaqc = iaqc+1
                      if (namet(iaqc).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqc(iaq)+iaqc-1
                        jaaqc(icur) = ic
                        ordaqc(icur) = value(iaqc)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqc) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

            iaaqc(iaq+1) = iaaqc(iaq) + naqc

!c  ----------------------------------------------------------------------
!c  fractional order terms, concentrations of aqueous complexes

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for fractional order terms: C^x'
            end if

            found = .false.
            searching = .true.
            naqx = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'fractional C^x') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqx

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqx
                end if

!c  read names of components and reaction orders

                do i = 1,naqx
                  read(irdbs,*,err=999) namet(i),value(i)
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and order of reaction

!c  concentrations of components as species in solution

                  icount = 0
                  ix = 0
                  do while ((icount.lt.naqx).and.(ix.lt.nx))
                    found = .false.
                    iaqx = 0
                    ix = ix+1
                    do while ((iaqx.lt.naqx).and.(.not.found))
                      iaqx = iaqx+1
                      if (namet(iaqx).eq.namex(ix)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqx(iaq)+iaqx-1
                        jaaqx(icur) = ix
                        ordaqx(icur) = value(iaqx)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqx) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                    'aqueous complex for intra-aqueous kinetic ',&
     &                    'reaction ',nameaq(iaq)(:l_nameaq(iaq)),     &
     &                    ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

            iaaqx(iaq+1) = iaaqx(iaq) + naqx

!c  ----------------------------------------------------------------------
!c  hyperbolic terms, total aqueous component concentrations

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for hyperbolic terms: T^a'
            end if

            found = .false.
            searching = .true.
            naqht = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'hyperbolic T^a') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqht

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqht
                end if

!c  read names of components and reaction orders

                do i = 1,naqht
                  read (irdbs,'(a1)',err=999,end=998) string
                  backspace(irdbs)
                  if(string .ne. "'") then
                    read(irdbs,*,err=999) value(i),value2(i),namet(i) 
                  else
                    read(irdbs,*,err=999) namet(i),value(i),value2(i)
                  end if
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  iaqht = 0
                  do while (iaqht.lt.naqht)
                    iaqht = iaqht+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.naqht).and.(ic.lt.nc)        &
     &                         .and.(.not.found))
                      ic = ic+1
                      if (namet(iaqht).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqht(iaq)+iaqht-1
                        jaaqht(icur) = ic
                        faqht(icur) = value(iaqht)
                        ordaqht(icur) = value2(iaqht)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqht) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

            iaaqht(iaq+1) = iaaqht(iaq) + naqht
              
!c  ----------------------------------------------------------------------
!c Isotopes
!c  hyperbolic terms, sum of total aqueous component concentrations

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
              write(*,*) 'searching for hyperbolic terms: sum T^a'
            end if

            found = .false.
            searching = .true.
            naqhst = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'hyperbolic sum T^a') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqhst

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqhst
                end if

!c  read names of components and reaction orders

                itemp = 1
                do inaqhst = 1,naqhst
                  read(irdbs,*,err=999,end=998) ntsct
                  ntsct2(inaqhst) = ntsct
                  backspace(irdbs) 
                  read(irdbs,*,err=999,end=998) dummy,                 &
     &                 (namet(i),i= itemp,itemp+ntsct2(inaqhst)-1),    &
     &                  value2(inaqhst), ordt(inaqhst)
                  itemp = itemp+ntsct2(inaqhst)

                end do
      
                if (info_debug.gt.1) then
                  write(*,*) keyword,naqhst
                  itemp = 1
                  do inaqhst = 1,naqhst
                      write(*,*)  inaqhst,                             &
     &               (namet(i),i= itemp,itemp+ntsct2(inaqhst)-1),      &
     &                      value2(inaqhst), ordt(inaqhst)
                    itemp = itemp+ntsct2(inaqhst)
                  end do
                end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if
  
            end do


!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction
!c  total aqueous component concentrations

            iinc = 0
            do inaqhst = 1,naqhst
              iinc = iinc+ntsct2(inaqhst)
            end do 
            iaaqhst(iaq+1) = iaaqhst(iaq) + iinc
            iaaqhst2(iaq+1) = iaaqhst2(iaq) + naqhst
            if (naqhst.gt.0) then
              icount = 0
              inaqhst = 0
              inaqhst2 = 0
              itemp = 0
              do while (inaqhst.lt.naqhst)
                inaqhst = inaqhst+1
                itemp = itemp+ntsct2(inaqhst)
                do while (inaqhst2.lt.itemp)
                  inaqhst2 = inaqhst2+1
                  ic = 0
                  found = .false.
                  do while ((icount.lt.iinc).and.(ic.lt.nc)        &
 &                           .and.(.not.found))
                    ic = ic+1
                    if (namet(inaqhst2).eq.namec(ic)) then
                      found = .true.
                      icount = icount+1
                      icur = iaaqhst(iaq)+inaqhst2-1
                      jaaqhst(icur) = ic
                    end if
                  end do
                end do
                icur2 = iaaqhst2(iaq)+inaqhst-1
                faqhst(icur2) = value2(inaqhst)
                ordaqhst(icur2) = ordt(inaqhst)
                ntsca(icur2) = ntsct2(inaqhst)
              end do

!c  if component is missing --> exit

              if (icount.ne.iinc) then
                if(rank == 0) then  
                  write(ilog,'(72a)') ('-',i=1,72)
                  write(ilog,'(5a)')                                 &
                      'component for intra-aqueous kinetic ',        &
                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),       &
                      ' is missing'
                  write(ilog,'(72a)') ('-',i=1,72)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if

            end if

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

!c----------------------------------------------------------------------------
!c_isotope
!c  isotopic fractionation master reaction

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
              write(*,*) 'searching for isotopic fractionation master reaction'
            end if

            found = .false.
            searching = .true.
                              
            do while (searching.and..not.found)
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                               
              if (keyword.eq.'isotopic fractionation_master') then                 
                isofraca(iaq) = .true.
                isofracam(iaq) = .true.
                found = .true.
                backspace(irdbs)
                read(irdbs,*,err=999,end=998) keyword, nifr

                   
                do i = 1,nifr
                  read(irdbs,*,err=999,end=998) iinum(i),              &
                      (namet2(i,ii),ii=1,iinum(i))

                  alphat(i,1) = 1
                  
                  read(irdbs,*,err=999,end=998)                        &
                      (alphat(i,ii),ii=2,iinum(i))
                 
                end do                   
                        
                if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                  write(*,*) keyword
                  do i = 1,nifr
                    do ii = 1, iinum(i)
                      write(*,*)  namet2(i,ii), alphat(i,ii)
                    end do
                  end do
                end if

                !calculate the number of associated reactions
                nprsc = iinum(1) 
                do i=2,nifr
                  nprsc=nprsc*iinum(i)
                end do

                 
!c  exit, if end of input section is reached

              elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                  searching = .false.
              end if

            end do

!c  check if all components involved in reaction are specified
!c  in input file and allocate pointers to components and reaction 
!c  orders to permanent storage
                
            if (isofracam(iaq)) then
              iamdisoa(iaq+1) = iamdisoa(iaq) + nprsc
              iamdisoa2(iaq+1) = iamdisoa2(iaq) + nifr
            else
              iamdisoa(iaq+1) = iamdisoa(iaq)
              iamdisoa2(iaq+1) = iamdisoa2(iaq)
            end if

            if (isofracam(iaq)) then

              icount = 0
              icount2 = 0
              nifra(iaq) = nifr

              
               do iiso = 1,nifr
                do iiso2 = 1,iinum(iiso)
                    ic = 0
                    im1 = 0
                    found = .false.
                    do while ((ic.lt.nc).and.(.not.found)) 
                      ic = ic+1
                      if (namet2(iiso,iiso2).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iamdisoa(iaq)+icount-1
                        jamdisoa(icur) = ic
                        jamdalphaa(icur) = alphat(iiso,iiso2)
                      end if
                    end do
            
                    
                end do !iiso2
                icount2 = icount2+1
                icur = iamdisoa2(iaq)+icount2-1
                jamdisoa2(icur) = iinum(iiso)
              end do !iiso
              
                            

!c  if component is missing --> exit

              if (icount.ne.nprsc) then
                if (rank==0) then
                  write(ilog,'(72a)') ('-',i=1,72)
                  write(ilog,'(5a)')                                   &
                        'component for intra-aqueous kinetic ',        &
                        'reaction ',nameaq(iaq)(:l_nameaq(iaq)),       &
                        ' is missing'
                  write(ilog,'(72a)') ('-',i=1,72)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if

            end if        !(isofrac)

!c----------------------------------------------------------------------------
!c_isotope
!c  isotopic fractionation

            call findname(nameaq(iaq),irdbs,found_keyword)
                          
            if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
              write(*,*) 'searching for isotopic fractionation'
            end if

            found = .false.
            searching = .true.
                              
            do while (searching.and..not.found)
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                              
              if (keyword.eq.'isotopic fractionation') then
                
                isofraca(iaq) = .true.
                found = .true.
                backspace(irdbs)
                read(irdbs,*,err=999,end=998) keyword, namet3

                
                iaq1 = 0
                found = .false.
                do while ((iaq1.lt.naq).and.(.not.found)) 
                  iaq1 = iaq1+1
                  if (namet3.eq.nameaq(iaq1)) then
                    found = .true.
                    nifra(iaq)=nifra(iaq1)
                    icount = 0
                    idiff = iamdisoa(iaq1+1) - iamdisoa(iaq1)
                    iamdisoa(iaq+1) = iamdisoa(iaq) + idiff
                    iamdisoa2(iaq+1) = iamdisoa2(iaq) + nifra(iaq)
                    istart = iamdisoa(iaq1)
                    istop = iamdisoa(iaq1+1)-1

                    do i1 = istart, istop
                        icount = icount + 1
                        icur = iamdisoa(iaq)+icount-1
                        jamdisoa(icur) = jamdisoa(i1)
                        jamdalphaa(icur) = jamdalphaa(i1)
                    end do
                        
                    icount = 0
                    do iiso = 1,nifra(iaq1)
                        icount = icount + 1
                        icur = iamdisoa2(iaq)+icount-1
                        icur2 = iamdisoa2(iaq1)+icount-1
                        jamdisoa2(icur) = jamdisoa2(icur2)
                    end do
                    
                  end if
                end do
                
                !write paprameters to output
                if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
                  istart = iamdisoa(iaq)
                  istop = iamdisoa(iaq+1)-1
                  write(*,*) keyword
                  do i=istart,istop
                      write(*,*) namec(jamdisoa(i)), jamdalphaa(i)
                  end do                        
                end if
             
                if (.not.found) then
                  if (rank == 0) then  
                    write(ilog,'(72a)') ('-',i1=1,72)
                    write(ilog,'(2a,a12,a)') 'Corresponding master',   &
                           ' mineral for isotope fractionation of ',   &
                           nameaq(iaq), ' is missing'
                    write(ilog,'(72a)') ('-',i1=1,72)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if
                
              elseif (keyword.eq.'end pathway'.or.string.eq.'!') then
                searching = .false.
              end if
              if(.not.isofraca(iaq)) then
                iamdisoa(iaq+1) = iamdisoa(iaq)
                iamdisoa2(iaq+1) = iamdisoa2(iaq)
              end if
            end do

!c  ----------------------------------------------------------------------
!c  hyperbolic terms, activities of components as species in solution

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for hyperbolic terms: C^c'
            end if

            found = .false.
            searching = .true.
            naqhc = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'hyperbolic C^c') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqhc

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqhc
                end if

!c  read names of components and reaction orders

                do i = 1,naqhc
                  read (irdbs,'(a1)',err=999,end=998) string
                  backspace(irdbs)
                  if(string .ne. "'") then 
                    read(irdbs,*,err=999) value(i),value2(i),namet(i)
                  else    
                    read(irdbs,*,err=999) namet(i),value(i),value2(i)
                  end if
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction

!c  components as species in solution

                  icount = 0
                  iaqhc = 0
                  do while (iaqhc.lt.naqhc)
                    iaqhc = iaqhc+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.naqhc).and.(ic.lt.nc)        &
     &                         .and.(.not.found))
                      ic = ic+1
                      if (namet(iaqhc).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqhc(iaq)+iaqhc-1
                        jaaqhc(icur) = ic
                        faqhc(icur) = value(iaqhc)
                        ordaqhc(icur) = value2(iaqhc)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqhc) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

              iaaqhc(iaq+1) = iaaqhc(iaq) + naqhc

!c  ----------------------------------------------------------------------
!c  hyperbolic terms, minerals

            call findname(nameaq(iaq),irdbs,found_keyword)
              
              if (info_debug.gt.1) then
              write(*,*) 'searching for hyperbolic terms: phi^m'
            end if

            found = .false.
            searching = .true.
            naqhm = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'hyperbolic phi^m') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqhm

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqhm
                end if

!c  read names of minerals, half saturation constants and 
!c  reaction orders

                do i = 1,naqhm
                  read (irdbs,'(a1)',err=999,end=998) string
                  backspace(irdbs)
                  if(string .ne. "'") then
                    read(irdbs,*,err=999) value(i),value2(i),namet(i)
                  else
                    read(irdbs,*,err=999) namet(i),value(i),value2(i)  
                  end if
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction

!c  minerals

                  icount = 0
                  iaqhm = 0
                  do while (iaqhm.lt.naqhm)
                    iaqhm = iaqhm+1
                    im = 0
                    found = .false.
                    do while ((icount.lt.naqhm).and.(im.lt.nm)        &
     &                         .and.(.not.found))
                      im = im+1
                      if (namet(iaqhm).eq.namem(im)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqhm(iaq)+iaqhm-1
                        jaaqhm(icur) = im
                        faqhm(icur) = value(iaqhm)
                        ordaqhm(icur) = value2(iaqhm)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqhm) then
                    if (rank == 0) then
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'mineral for intra-aqueous kinetic ',      &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

              iaaqhm(iaq+1) = iaaqhm(iaq) + naqhm

!c  ----------------------------------------------------------------------
!c  inhibition terms, total aqueous component concentrations

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
              write(*,*) 'searching for inhibition terms: T^a'
            end if

            found = .false.
            searching = .true.
            naqit = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'inhibition T^a') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqit

                if (info_debug.gt.1) then
                  write(*,*) keyword, naqit
                end if

!c  read names of components and reaction orders

                do i = 1,naqit
                  read (irdbs,'(a1)',err=999,end=998) string
                  backspace(irdbs)
                  if(string .ne. "'") then
                    read(irdbs,*,err=999) value(i),value2(i),namet(i)  
                  else
                    read(irdbs,*,err=999) namet(i),value(i),value2(i)
                  end if
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  iaqit = 0
                  do while (iaqit.lt.naqit)
                    iaqit = iaqit+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.naqit).and.(ic.lt.nc)        &
     &                         .and.(.not.found))
                      ic = ic+1
                      if (namet(iaqit).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqit(iaq)+iaqit-1
                        jaaqit(icur) = ic
                        faqit(icur) = value(iaqit)
                        ordaqit(icur) = value2(iaqit)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqit) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

              iaaqit(iaq+1) = iaaqit(iaq) + naqit

!c  ----------------------------------------------------------------------
!c  inhibition terms, activities of components as species in solution

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
              write(*,*) 'searching for inhibition terms: C^c'
            end if

            found = .false.
            searching = .true.
            naqic = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'inhibition C^c') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqic
                if (info_debug.gt.1) then
                  write(*,*) keyword, naqic
                end if

!c  read names of components and reaction orders

                do i = 1,naqic
                  read (irdbs,'(a1)',err=999,end=998) string
                  backspace(irdbs)
                  if(string .ne. "'") then
                    read(irdbs,*,err=999) value(i),value2(i),namet(i)  
                  else
                    read(irdbs,*,err=999) namet(i),value(i),value2(i)
                  end if
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  iaqic = 0
                  do while (iaqic.lt.naqic)
                    iaqic = iaqic+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.naqic).and.(ic.lt.nc)        &
     &                         .and.(.not.found))
                      ic = ic+1
                      if (namet(iaqic).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqic(iaq)+iaqic-1
                        jaaqic(icur) = ic
                        faqic(icur) = value(iaqic)
                        ordaqic(icur) = value2(iaqic)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqic) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

              iaaqic(iaq+1) = iaaqic(iaq) + naqic

!c  ----------------------------------------------------------------------
!c  inhibition terms, minerals

            call findname(nameaq(iaq),irdbs,found_keyword)
              
            if (rank==0.and.b_enable_output.and.info_debug.gt.1) then
              write(*,*) 'searching for inhibition terms: phi^m'
            end if

            found = .false.
            searching = .true.
            naqim = 0
                              
            do while (searching.and..not.found)
                  
              read(irdbs,*,err=999,end=998) keyword
              backspace(irdbs)
              read (irdbs,'(a1)',err=999,end=998) string

                                
              if (keyword.eq.'inhibition phi^m') then
                  
                found = .true.
                backspace(irdbs)

                read(irdbs,*,err=999,end=998) keyword,naqim
                if (info_debug.gt.1) then
                  write(*,*) keyword, naqim
                end if

!c  read names of components and reaction orders

                do i = 1,naqim
                  read (irdbs,'(a1)',err=999,end=998) string
                  backspace(irdbs)
                  if(string .ne. "'") then
                    read(irdbs,*,err=999) value(i),value2(i),namet(i) 
                  else
                    read(irdbs,*,err=999) namet(i),value(i),value2(i)
                  end if
                end do

!c  check if all specified reactants are defined as components 
!c  assign pointer to species and assign half saturation 
!c  constants and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  iaqim = 0
                  do while (iaqim.lt.naqim)
                    iaqim = iaqim+1
                    im = 0
                    found = .false.
                    do while ((icount.lt.naqim).and.(im.lt.nm)        &
     &                         .and.(.not.found))
                      im = im+1
                      if (namet(iaqim).eq.namem(im)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqim(iaq)+iaqim-1
                        jaaqim(icur) = im
                        faqim(icur) = value(iaqim)
                        ordaqim(icur) = value2(iaqim)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqim) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'mineral for intra-aqueous kinetic ',      &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

!c  exit, if end of input section is reached

              elseif (string.eq.'!') then
                searching = .false.
              end if

            end do

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

              iaaqim(iaq+1) = iaaqim(iaq) + naqim

!c  rewind database to allow search for next intra-aqueous 
!c  kinetic reactions

              rewind(irdbs)

            end if
 
!c  go to next intra-aqueous kinetic reaction, if no match was found
  
          elseif (name_aq.ne.nameaq(iaq)) then

            next_entry = .false.
            do while (.not.next_entry)
              read (irdbs,'(a1)',err=999) junk
              if (junk.eq.'!') then
                next_entry = .true.
              end if
            end do

            backspace(irdbs)

          end if               !search for intra-aqueous kinetic reactions
        end do                 !end - loop over database
      end do                   !end - loop over reactions

!cdbg ---- activate this section for purposes of debugging -----
#ifdef DEBUG 
      if (info_debug.gt.0) then
      
      do iaq=1,naq
          write(idbg,'(a)') 'returning from readaq ...'
          write(idbg,'(a72,1x,a72)') nameaq(iaq)
          write(idbg,'(a,1pe15.6e3)') 'eqaqs   ',eqaqs(iaq)
          write(idbg,'(a,1pe15.6e3)') 'dhaq    ',dhaq(iaq)
          write(idbg,'(a,1pe15.6e3)') 'dgaq    ',dgaq(iaq)
          write(idbg,'(a,i10)') 'iaaq    ',iaaq(iaq)
          write(idbg,'(a,1pe15.6e3)') 'ratecaqs',dlog10(ratecaqs(iaq))
 
!c  echo check for stoichiometric coefficients 
 
          istart = iaaq(iaq)
          istop = iaaq(iaq+1)-1
          do i = istart, istop
            icur = jaaq(i)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i,namec(icur),  &
     &                 ' jaaq ',jaaq(i),' xnuaq ',xnuaq(i)
          end do
 
!c  fractional order terms T^a

          write(idbg,'(a,1x,i10,1x)') 'iaaqt   ',iaaqt(iaq)
          istart2 = iaaqt(iaq)
          istop2 = iaaqt(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqt(i2)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namec(icur), &
                  ' jaaqt ',jaaqt(i2), ' ordaqt ',ordaqt(i2)
          end do

!c  fractional order terms C^c

          write(idbg,'(a,1x,i10,1x)') 'iaaqc   ',iaaqc(iaq)
          istart2 = iaaqc(iaq)
          istop2 = iaaqc(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqc(i2)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namec(icur), &
                  ' jaaqc ',jaaqc(i2), ' ordaqc ',ordaqc(i2)
          end do

!c  fractional order terms C^x

          write(idbg,'(a,1x,i10,1x)') 'iaaqx   ',iaaqx(iaq)
          istart2 = iaaqx(iaq)
          istop2 = iaaqx(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqx(i2)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namex(icur), &
                  ' jaaqx ',jaaqx(i2), ' ordaqx ',ordaqx(i2)
          end do

!c  hyperbolic terms T^a

          write(idbg,'(a,1x,i10,1x)') 'iaaqht   ',iaaqht(iaq)
          istart2 = iaaqht(iaq)
          istop2 = iaaqht(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqht(i2)
            write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')              &
                  i2,namec(icur),' jaaqht ',jaaqht(i2),                &
                  ' faqht ',faqht(i2),' ordaqht ',ordaqht(i2)
          end do

!c  hyperbolic terms C^c

          write(idbg,'(a,1x,i10,1x)') 'iaaqhc   ',iaaqhc(iaq)
          istart2 = iaaqhc(iaq)
          istop2 = iaaqhc(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqhc(i2)
            write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')              &
                  i2,namec(icur), ' jaaqhc ',jaaqhc(i2),               &
                  ' faqhc ',faqhc(i2), ' ordaqhc ',ordaqhc(i2)
          end do

!c  hyperbolic terms phi^m

          write(idbg,'(a,1x,i10,1x)') 'iaaqhm   ',iaaqhm(iaq)
          istart2 = iaaqhm(iaq)
          istop2 = iaaqhm(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqhm(i2)
            write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')              &
                  i2,namem(icur), ' jaaqhm ',jaaqhm(i2),               &
                  ' faqhm ',faqhm(i2), ' ordaqhm ',ordaqhm(i2)
          end do

!c  inhibition terms T^a

          write(idbg,'(a,1x,i10,1x)') 'iaaqit   ',iaaqit(iaq)
          istart2 = iaaqit(iaq)
          istop2 = iaaqit(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqit(i2)
            write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')              &
                  i2,namec(icur), ' jaaqit ',jaaqit(i2),               &
                  ' faqit ',faqit(i2), ' ordaqit ',ordaqit(i2)
          end do

!c  inhibition terms C^c

          write(idbg,'(a,1x,i10,1x)') 'iaaqic   ',iaaqic(iaq)
          istart2 = iaaqic(iaq)
          istop2 = iaaqic(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqic(i2)
            write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')              &
                  i2,namec(icur), ' jaaqic ',jaaqic(i2),               &
                  ' faqic ',faqic(i2), ' ordaqic ',ordaqic(i2)
          end do

!c  inhibition terms phi^m

          write(idbg,'(a,1x,i10,1x)') 'iaaqim   ',iaaqim(iaq)
          istart2 = iaaqim(iaq)
          istop2 = iaaqim(iaq+1)-1
          do i2 = istart2,istop2
            icur = jaaqim(i2)
            write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')              &
                  i2,namec(icur), ' jaaqim ',jaaqim(i2),               &
                  ' faqim ',faqim(i2), ' ordaqim ',ordaqim(i2)
          end do
          
          write(idbg,*) '----------------------------------------------'
        end do
      end if

      if (info_debug.gt.1) then
        !pause
      end if
#endif

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          if (redox_master.eq.'o2(aq)') then
            write(*,'(1x,a)') 'start of database backup: redox.dbs'
            write(idbs_bk, '(a)') '<------ redox.dbs: start of intra-aqueous kinetic reactions ------>'
          elseif (redox_master.eq.'h2(aq)') then
            write(*,'(1x,a)') 'start of database backup: redoxh2.dbs'
            write(idbs_bk, '(a)') '<------ redoxh2.dbs: start of intra-aqueous kinetic reactions ------>'
          elseif (redox_master.eq.'e-1') then
            write(*,'(1x,a)') 'start of database backup: redoxe.dbs'
            write(idbs_bk, '(a)') '<------ redoxe.dbs: start of intra-aqueous kinetic reactions ------>'
          end if
           
          do iaq = 1,naq
            rewind(irdbs)
            do while(.true.)
              if (readnextline(irdbs,strbuffer,lowercase=.false.,          &
                  original=.true.)) then
                if (index(adjustl(strbuffer),trim(nameaq(iaq))) == 2) then            !note, mineral name has quotes
                  write(idbs_bk,'(a)') trim(strbuffer)
                  do while(readnextline(irdbs,strbuffer,lowercase=.false., &
                           withcomment=.true.,original=.true.))
                    if (index(adjustl(strbuffer), '!') == 1 .or.           &
                        trim(adjustl(strbuffer)).eq."'end'") then
                      write(idbs_bk,'(a)') trim(strbuffer)
                      exit
                    else
                      write(idbs_bk,'(a)') trim(strbuffer)
                    end if
                  end do
                  exit
                end if
              end if
            end do
          end do
          rewind(irdbs)

          !write(idbs_bk, '(a)') "'end'"
          if (redox_master.eq.'o2(aq)') then
            write(*,'(1x,a)') 'end of database backup: redox.dbs'
            write(idbs_bk, '(a/)') '<------ redox.dbs: end of intra-aqueous kinetic reactions ------>'
          elseif (redox_master.eq.'h2(aq)') then
            write(*,'(1x,a)') 'end of database backup: redoxh2.dbs'
            write(idbs_bk, '(a/)') '<------ redoxh2.dbs: end of intra-aqueous kinetic reactions ------>'
          elseif (redox_master.eq.'e-1') then
            write(*,'(1x,a)') 'end of database backup: redoxe.dbs'
            write(idbs_bk, '(a/)') '<------ redoxe.dbs: end of intra-aqueous kinetic reactions ------>'
          end if     
        end if
      end if

      return

!c  exit program if end of database is reached and intra-aqueous
!c  kinetic reaction was not found or error occurred

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'reached end of database "intra.dbs"'
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'reached end of database "intra.dbs"'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(irdbs)
      read(irdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in intra-aqueous database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in intra-aqueous database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
  
