!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/opnpgfls.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine opnpgfls
!c -------------------
!c
!c modified for density dependent flow
!c
!c open postprocessing files for transient data (global system)
!c assign unit numbers for postprocessing files
!c
!c written by:      Uli Mayer - May 7, 96
!c
!c last modified:   Tom Henderson - March 11, 2004
!c                  increased output locations to 999
!c
!c                  Tom Henderson - October 24, 2002
!c                  Sergi Molins - May 2, 2006
!c                  added files for gas variables
!c                  Sergi Molins - June 7, 2006
!c                  open unit igsw (water production)
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           dimcv(3,nn)        = dimensions of control volumes       + -
!c           elevmax            = max. elevation of solution domain   + -
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           ifls               = unit number - file information      + -
!c           igb_start          = starting pointer for unit numbers   + - 
!c                                for transient data
!c           igsp               = unit number, flow variables         * +
!c           igst               = unit number, total aqueous          * +
!c                                             component
!c                                             concentrations
!c                                             - contour data
!c           igsb               = unit number, sorbed species         * +
!c                                             concentrations
!c                                             - contour data
!c           igsc               = unit number, free species and       * +
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - contour data
!c           igsd               = unit number, reaction rates of      * +
!c                                             dissolution-
!c                                             precipitation
!c                                             reactions
!c                                             - contour data
!c           igsg               = unit number, gas concentrations     * +
!c                                             - contour data
!c           igsgr              = unit number, rates of degassing     * +
!c                                             - contour data
!c           igsi               = unit number, rates of intra-aqueous * +
!c                                             kinetic reactions
!c                                             - contour data
!c           igsm               = unit number, master variables       * +
!c                                             - contour data
!c           igss               = unit number, saturation indices     * +
!c                                             - contour data
!c           igsv               = unit number, mineral volume         * +
!c                                             fractions
!c                                             - contour data
!c           igsx               = unit number, saturation indices     * +
!c                                             excluded minerals
!c                                             - contour data
!c           igbt               = unit number, total aqueous          * +
!c                                             component
!c                                             concentrations
!c                                             - transient data
!c                                               global system
!c           igbb               = unit number, concentrations of      * +
!c                                             sorbed species
!c                                             - transient data
!c                                               global system
!c           igbc               = unit number, free species and       * +
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - transient data
!c                                               global system
!c           igbac              = unit number, activity coefficient   * +
!c                                              - transient data
!c                                                global system
!c           igsac              = unit number, activity coefficient   * +
!c                                              - countour data
!c           igbd               = unit number, dissolution-           * +
!c                                             precipitation
!c                                             rates
!c                                             - transient data
!c                                               global system
!c           igbg               = unit number, gas concentrations     * +
!c                                             - transient data
!c                                                global system
!c           igbgr              = unit number, degassing rates        * +
!c                                             - transient data
!c                                                global system
!c           igbm               = unit number, master variables       * +
!c                                             - transient data
!c                                               global system
!c           igbi               = unit number, rates of intra-aqueous * +
!c                                             kinetic reactions
!c                                             - transient data
!c                                               global system
!c           igbp               = unit number, flow variables         * +
!c                                             - transient data
!c                                               global system
!c           igbs               = unit number, saturation indices     * +
!c                                             - transient data
!c                                               global system
!c           igbv               = unit number, mineral volume         * +
!c                                             fractions
!c                                             - transient data
!c                                               global system
!c           igbx               = unit number, saturation indices     * +
!c                                             excluded minerals
!c                                             - transient data
!c                                               global system
!c           icnv               = unit number, data conversion        + -
!c           ivel               = unit number, average interfacial    * +
!c                                             velocities
!c           l_prfx             = length of prefix of I/O files       + -
!c           ngb                = number of output locations for      + - 
!c                                transient data
!c           ngb_vol(ngb)       = control volume numbers for output   + -
!c                                of transient data
!c added for gas transport;
!c
!c           igs2               = unit number, gas molar fractions    * +
!c                                             - contour data
!c             igsa_first         = unit number, gas fluxes             * +
!c                                                - contour data
!c             igsr               = unit number, gas density            * +
!c                                                - contour data 
!c             igsy               = unit number, gas viscosity          * +
!c                                                - contour data 
!c             igsf_first         = unit number, gas diffusion coeff    * +
!c                                             - contour data 
!c added
!c           igsw               = unit number, water prod/consumption * +
!c                                             - contour data
!c
!c           logical:
!c           --------
!c           depth_output       = .true.  -> output in terms of       + -
!c                                           depth instead of
!c                                           elevation
!c           extended_output_gs = .true.  -> extended output of       + -
!c                                           contour data for
!c                                           reaction-transport
!c                                           simulation
!c                                .false. -> basic output of
!c                                           contour data for
!c                                           for reaction-transport
!c                                           simulation
!c           fully_saturated    = .true.  -> saturated conditions     + - 
!c           gb_output          = .true.  -> output of transient data + -
!c           gs_output          = .true.  -> output of contour data   + -
!c           reactive_transport = .true.  -> perform reactive         + -
!c                                           transport simulation     + -
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient flow
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated 
!c                                           conditions
!c           varsat_flow        = .true.  -> perform flow simulation  + -
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c           
!c
!c chem.f:   integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iamd(nm+1)         = pointer array to dissolution-       + -
!c                                precipitation reactions
!c           nanc               = number of sorbed species            + -
!c                                non-competitive sorption
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of aqueous complexes         + -
!c
!c           logical:
!c           --------
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           noncompetitive_sorption = logical array for activation   + -   
!c                                     of noncompetitive sorption
!c                                     reactions
!c           ph_output          = .true.  -> output of pH             + -
!c           pe_output          = .true.  -> output of pe and Eh      + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namex(nx)          = names of secondary aqueous species  + -
!c           namem(nm)          = mineral names                       + -
!c           namemx(nmx)        = names of excluded minerals          + -
!c           namemp(ndr*nm)     = names for parallel                  + -
!c                                dissolution-precipitation reactions
!c           namer(nr)          = names of redox couples              + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c           output_unit_sb     = output unit for surface species     + -
!c           output_unit_sb_ion = output unit for sorption            + -
!c                                reactions of ion-exchange
!c           output_unit_sb_surf= output unit for sorption            + -
!c                                reactions of surface-complex
!c
!c dens.f:   logical:
!c           --------
!c          density_dependence = .true.  -> density-dependent flow   + -
!c
!c local:    real*8:
!c           -------
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           integer*4:
!c           ----------
!c           ianc               = counter (non-competitive
!c                                         sorption reactions)
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           ir                 = counter (redox couples)
!c           isites             = counter (surafce sites)
!c           isb                = counter (sorbed species)
!c           ix                 = counter (aqueous complexes)
!c           igb                = counter (output locations)
!c           ireac              = counter
!c           istart             = pointer
!c           istop              = pointer
!c           l_sufx             = length of file suffix
!c
!c           character:
!c           ----------
!c           suffix             = file suffix
!c
!c external: tranunit  = assign unit numbers for output of transient 
!c                       data
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c ----------------------------------------------------------------------

      subroutine opnpgfls

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen
      use chem
      use dens
      use writeversion
      use nobleGasIngrowth, only : b_use_ngi, ngre_i, name_ngre_i
      use mip_bubble, only : mip_mt_enable
      use module_binary_mpiio, only : binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close
      use file_unit, only : lun_get, lun_set
      use file_utility, only : check_rewind_status
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: i, ianc, ic, ig, iaq, im, ir, ix, ivol, igsi_igsb,    &
                 igb, imx, ireac, istart, istop, isites, isb, l_sufx,  &
                 i1, ic1, ic2, icount, ierr, jvol, l_sfx2, imipvar,    &
                 ingre

      logical :: b_write_temperature
      
      real*8 :: xout, yout, zout
      real*8, external :: zoutput

      external tranunit, trans_evap_info, checkerr

      character*3 suffix
      character*12 suffix2
      
      integer :: nvarsigbp, nvarsigfvel, nvarsigcvel
      
      character*2048 strbuffer
      character*72:: tec_variables(100)

      logical :: b_rewind_valid

!c     write(*,'(/a)') 'enter routine opnpgfls ...'

!c  contour data
!c -----------------------------------------------------------------------   

      if (gs_output) then

!c  unit number for density componnets
        if (issplitdens) then 
          !idens = 75
          idens = lun_get()
        end if

!c  unit numbers for variably saturated flow

        if (varsat_flow) then
          !igsp  = 60
          !ivel  = 61
          igsp = lun_get()
          ivel = lun_get()
        end if

!c  unit numbers for reactive transport

        if (reactive_transport) then
          !igst = 62
          igst = lun_get()
          if(multi_diff)then
            !icbt = 82
            icbt = lun_get()  
          end if
          
          if(flux_out)then
            !igmf = 92
            igmf = lun_get()
          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
            igsre = lun_get()
          end if
          
          if (extended_output_gs) then
            !igsc = 63
            !igsm = 64
            igsc = lun_get()
            igsm = lun_get()

            !igsa_first = 300  !adv
            igsa_first = lun_get()  !adv
            do i = 1, n
              call lun_set(igsa_first+i)
            end do

            if (ng.gt.0) then
              !igsg = 65
              !igs2 = 265        !adv              
              !igsr = 266        !adv
              !igsy = 267        !adv
              !igsw = 268        !water

              igsg = lun_get()
              igs2 = lun_get()        !adv              
              igsr = lun_get()        !adv
              igsy = lun_get()        !adv
              igsw = lun_get()        !water
              igsf_first = lun_get()  !adv
              do i = 1, n
                call lun_set(igsf_first+i)  
              end do
            end if
            if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then
              !igsb = 66
              igsb = lun_get()
              
              !cprovi--------------------------------------------
              !cprovi In this unit is written the total 
              !cprovi concentrations in the aqueous and sorbed
              !cprovi phases
              !cprovi--------------------------------------------
              
              !igsi_igsb = 73
              igsi_igsb = lun_get()
            end if
            if (nm.gt.0) then
              !igss = 67
              !igsd = 68
              !igsv = 69
              igss = lun_get()
              igsd = lun_get()
              igsv = lun_get()
            end if
            if (naq.gt.0.or.nr.gt.0) then
              !igsi = 70
              igsi = lun_get()
            end if
            if (nmx.gt.0) then
              !igsx = 71
              igsx = lun_get()
            end if
            if (gas_removal.and.ng.gt.0) then
              !igsgr = 72
              igsgr = lun_get()
            end if
            if (iso_output) then
              !igsis = 73
              igsis = lun_get()
            end if
            if (b_output_activity) then
              igsac = lun_get()
            end if
          end if                           !(extended_output_gs)
          
          if (ng.gt.0 .and. gas_advection) then
            igsk = lun_get()
          end if          
          
        end if                             !(reactive_transport)

      end if                               !(gs_output)

!c  transient data
!c -----------------------------------------------------------------------   

      if (gb_output .and. b_enable_output) then

!c  write header for transient data to file information file

        if (rank == 0) then

          write(ifls,'(//72a/a/72a)')                   &
               ('*',i=1,72),                            &
               'transient data - global system',        &
               ('*',i=1,72)
        
        end if

        !igb_start = 200
        igb_start = lun_get()
 
        do igb = 1,ngb        !loop over output locations

          ivol = ngb_vol(igb)   !local volume number
          
          if (ivol < 0) then        !control volume in the current domain
            cycle 
          end if    !End control volume in the current domain
        
!c  assign depth coordinate in terms of depth or elevation
!c
!c  for domain decomposition method, ivol = -1 indicates that 
!c  this volume is not in the current sub-domain, skip it.
          zout = zoutput(depth_output,zg(ivol),elevmax)

!c  assign file suffixes
!c  maximum of 999 locations

          !rewind(icnv)            !Deprecated, use internal convert instead. DSU
          if(igb.lt.10) then
            !write(icnv,'(i1)') igb 
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') igb
            l_sufx = 1
          elseif ((igb.ge.10).and.(igb.lt.100)) then
            !write(icnv,'(i2)') igb 
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') igb
            l_sufx = 2
          else
            !write(icnv,'(i3)') igb 
            !rewind(icnv)
            !read(icnv,'(a3)') suffix
            write(suffix,'(i3)') igb
            l_sufx = 3
          end if

!c  assign unit numbers for output of transient data

          call tranunit(igb)

!c  output temperature when heat transport or temperature field is specified
          if (heat_transport .or. temp_field) then
            b_write_temperature = .true.
          else
            b_write_temperature = .false.
          end if
          
!c  open files for transient data and write information
!c  to file information file

!c  ---------------------------------------------------------------
!c  variably saturated flow

!c  open file

          if (transient_flow) then

            if (b_output_trans_binary) then
#ifndef PETSC
              if (igbp_mpi(igb) < 10) then
                igbp_mpi(igb) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           igbp_mpi(igb), prefix(:l_prfx)//'_'//       &
                           suffix(:l_sufx)//'.gbp', .true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//   &
                                     '_'//suffix(:l_sufx)//'.gbp')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(igbp,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbp',status='unknown',         &
                     form='formatted',position='rewind')
              else
                open(igbp,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbp',status='unknown',         &
                     form='formatted')
              end if
            end if
!c  write file information
            if (rank == 0 .and. b_enable_output) then

              write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                   &
                    'Flow variables, ',                                 &
                    'x = ',xg(ivol),' m',                               &
                    'y = ',yg(ivol),' m',                               &
                    'z = ',zout,' m',                                   &
                    ('-',i=1,72)


              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                &
                                  suffix(:l_sufx)//'.gbp'

              write(ifls,'(2a)')                                        &
                   'column   entry                          ','unit'
              write(ifls,'(2a)')                                        &
                    '1        time                           ',time_unit
              write(ifls,'(2a)')                                        &
                    '2        hydraulic head                  ','m'
              write(ifls,'(2a)')                                        &
                    '3        pressure head                   ','m'
              write(ifls,'(2a)')                                        &
                    '4        water saturation                ','-'
              write(ifls,'(2a)')                                        &
                    '5        water content                   ','-'
              if (variably_saturated) then
                write(ifls,'(2a)')                                      &
                      '6        air saturation                  ','-'
                write(ifls,'(2a)')                                      &
                      '7        air content                     ','-'
                write(ifls,'(2a)')                                      &
                      '8        total root water uptake         ','m^3/d'
                write(ifls,'(2a)')                                      &
                      '9        root water uptake               ','m^3/d'
                write(ifls,'(2a)')                                      &
                      '10       evaporation uptake              ','m^3/d'
                if (b_write_temperature) then
                  write(ifls,'(2a)')                                    &
                      '11       temperature                     ','°C'
                  write(ifls,'(2a)')                                    &
                      '12       s_ice                           ','-'
                  write(ifls,'(2a)')                                    &
                      '13       s_water                         ','-'
                end if
              else
                if (b_write_temperature) then
                  write(ifls,'(2a)')                                    &
                      '6        temperature                     ','°C'
                  write(ifls,'(2a)')                                    &
                      '7        s_ice                           ','-'
                  write(ifls,'(2a)')                                    &
                      '8        s_water                         ','-'
                end if      
              end if
            
            end if

!c  title and variables

!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot.and..not.b_output_trans_binary) then
                call writeversion2file(igbp, "#")
              end if
            end if
        
            if (b_output_trans_binary) then
              offset_igbp(igb) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           igbp_mpi(igb), "#!TDV102",'dataset '//      &
                           prefix(:l_prfx),offset_igbp(igb),.true.,    &
                           .true.)              
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(igbp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              end if
            end if
            
            if (b_output_trans_binary) then
                
              if (density_dependence) then
                  
                if (fully_saturated) then

                  if (b_write_temperature) then
                    nvarsigbp = 10
                    tec_variables(1:10)= [character(len=72) ::         &
                                        "time","fh_w","p_w","ph_w",    &
                                        "rho_w","s_a","theta_a","temp",&
                                        "s_ice","s_water"]
                  else
                    nvarsigbp = 7
                    tec_variables(1:7)= [character(len=72) ::          &
                                        "time","fh_w","p_w","ph_w",    &
                                        "rho_w","s_a","theta_a"]
                  end if
                elseif (variably_saturated) then
                  if (evaporation) then
                    nvarsigbp = 18
                    tec_variables(1:18)= [character(len=72) ::         &
                                        "time","fh_w","p_w","ph_w",    &
                                        "rho_w","s_a","theta_a","s_g", &
                                        "theta_g","q_root","rootwat",  &
                                        "evapo","temp","rho_v","actw", &
                                        "pv","s_ice","s_water"]
                  else
                    if (b_write_temperature) then
                      nvarsigbp = 15
                      tec_variables(1:15)= [character(len=72) ::       &
                                        "time","fh_w","p_w","ph_w",    &
                                        "rho_w","s_a","theta_a","s_g", &
                                        "theta_g","q_root","rootwat",  &
                                        "evapo","temp",                &
                                        "s_ice","s_water"]
                    else
                      nvarsigbp = 12
                      tec_variables(1:12)= [character(len=72) ::       &
                                        "time","fh_w","p_w","ph_w",    &
                                        "rho_w","s_a","theta_a","s_g", &
                                        "theta_g","q_root",            &
                                        "rootwat","evapo"]
                    end if
                  end if
                end if
              else
                if (fully_saturated) then
                  if (b_write_temperature) then
                    nvarsigbp = 8
                    tec_variables(1:8)= [character(len=72) ::          &
                        "time","h_w","ph_w","s_a","theta_a","temp",    &
                        "s_ice","s_water"]
                  else
                    nvarsigbp = 5
                    tec_variables(1:5)= [character(len=72) ::          &
                        "time","h_w","ph_w","s_a","theta_a"]
                  end if
                elseif (variably_saturated) then
                  if (b_write_temperature) then
                    nvarsigbp = 13
                    tec_variables(1:13)= [character(len=72) ::         &
                                          "time","h_w","ph_w","s_a",   &
                                          "theta_a","s_g","theta_g",   &
                                          "q_root","rootwat","evapo",  &
                                          "temp","s_ice","s_water"]
                  else
                    nvarsigbp = 10
                    tec_variables(1:10)= [character(len=72) ::         &
                                          "time","h_w","ph_w","s_a",   &
                                          "theta_a","s_g","theta_g",   &
                                          "q_root","rootwat","evapo"]
                  end if
                end if
              end if !density_dependence
            
              call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                           igbp_mpi(igb), nvarsigbp,                     &
                           tec_variables(1:nvarsigbp), offset_igbp(igb), &
                           .true.,.true.)

            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

                if (density_dependence) then
                  if (fully_saturated) then
                    if (b_write_temperature) then
                      write(igbp,'(10a)')  'variables = "time",',      &
                                          ' "fh_w",',                  &
                                          ' "p_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "rho_w",',                 &
                                          ' "s_a",',                   &
                                          ' "theta_a",',               &
                                          ' "temp",',                  &
                                          ' "s_ice",',                 &
                                          ' "s_water"'
                    else
                      write(igbp,'(7a)')  'variables = "time",',       &
                                          ' "fh_w",',                  &
                                          ' "p_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "rho_w",',                 &
                                          ' "s_a",',                   &
                                          ' "theta_a"'
                    end if

                  elseif (variably_saturated) then
                    if (evaporation) then
                      write(igbp,'(18a)') 'variables = "time",',       &
                                          ' "fh_w",',                  &
                                          ' "p_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "rho_w",',                 &
                                          ' "s_a",',                   &
                                          ' "theta_a",',               &
                                          ' "s_g",',                   &
                                          ' "theta_g",',               &
                                          ' "q_root",',                &
                                          ' "rootwat",',               &
                                          ' "evapo",',                 &
                                          ' "temp",',                  &
                                          ' "rho_v",',                 &
                                          ' "actw",',                  &
                                          ' "pv",',                    &
                                          ' "s_ice",',                 &
                                          ' "s_water"'
                    else
                      if (b_write_temperature) then
                        write(igbp,'(15a)') 'variables = "time",',     &
                                            ' "fh_w",',                &
                                            ' "p_w",',                 &
                                            ' "ph_w",',                &
                                            ' "rho_w",',               &
                                            ' "s_a",',                 &
                                            ' "theta_a",',             &
                                            ' "s_g",',                 &
                                            ' "theta_g",',             &
                                            ' "q_root",',              &
                                            ' "rootwat",',             &
                                            ' "evapo",',               &
                                            ' "temp",',                &
                                            ' "s_ice",',               &
                                            ' "s_water"'
                      else
                        write(igbp,'(12a)') 'variables = "time",',     &
                                            ' "fh_w",',                &
                                            ' "p_w",',                 &
                                            ' "ph_w",',                &
                                            ' "rho_w",',               &
                                            ' "s_a",',                 &
                                            ' "theta_a",',             &
                                            ' "s_g",',                 &
                                            ' "theta_g",',             &
                                            ' "q_root",',              &
                                            ' "rootwat",',             &
                                            ' "evapo"'
                      end if
                    end if
                  end if
                else
                  if (fully_saturated) then
                    if (b_write_temperature) then
                      write(igbp,'(8a)')  'variables = "time",',       &
                                          ' "h_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "s_a",',                   &
                                          ' "theta_a",',               &
                                          ' "temp",',                  &
                                          ' "s_ice",',                 &
                                          ' "s_water"'
                    else
                      write(igbp,'(5a)')  'variables = "time",',       &
                                          ' "h_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "s_a",',                   &
                                          ' "theta_a"'
                    end if

                  elseif (variably_saturated) then
                    if (b_write_temperature) then
                      write(igbp,'(13a)')  'variables = "time",',      &
                                          ' "h_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "s_a",',                   &
                                          ' "theta_a",',               &
                                          ' "s_g",',                   &
                                          ' "theta_g",',               &
                                          ' "q_root",',                &
                                          ' "rootwat",',               &
                                          ' "evapo",',                 &
                                          ' "temp",',                  &
                                          ' "s_ice",',                 &
                                          ' "s_water"'
                    else
                      write(igbp,'(10a)') 'variables = "time",',       &
                                          ' "h_w",',                   &
                                          ' "ph_w",',                  &
                                          ' "s_a",',                   &
                                          ' "theta_a",',               &
                                          ' "s_g",',                   &
                                          ' "theta_g",',               &
                                          ' "q_root",',                &
                                          ' "rootwat",',               &
                                          ' "evapo"'
                    end if
                  end if
                end if !density_dependence

              end if
          
            end if !binary output

!c  zone record for fully saturated or variably saturated conditions
            if (b_output_trans_binary) then
#ifdef PETSC
              write(strbuffer,'(2(a,i0,1x),3(a,1pe15.6e3))')           &
                    'Flow variables, local volume = ',ivol,            &
                    ', global volume = ', node_idx_lg2g(ivol),         &
                    ', x = ',xg(ivol),                                 &
                    ', y = ',yg(ivol),                                 &
                    ', z = ',zg(ivol)
#else
              write(strbuffer,'(a,i0,3(a,1pe15.6e3))')                 &
                    'Flow variables, volume = ',ivol,                  &
                    ', x = ',xg(ivol),                                 &
                    ', y = ',yg(ivol),                                 &
                    ', z = ',zg(ivol)
#endif
              !c the number of values (here 1) is just for temporary output
              !c that should be output in every time step as this value is
              !c not predicitable
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           igbp_mpi(igb),trim(strbuffer),              &
                           offset_igbp(igb), 1, 1, 1, .true.,.true.,   &
                           b_output_multizone)
              offset_igbp_ijk(igb) = offset_igbp(igb) - 5*4

            else

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
#ifdef PETSC
                write(igbp,'(2(a,i0,1x),3(a,1pe15.6e3),a)')            &
                      'zone t = "Flow variables, local volume = ',ivol,&
                      ', global volume = ', node_idx_lg2g(ivol),       &
                      ', x = ',xg(ivol),                               &
                      ', y = ',yg(ivol),                               &
                      ', z = ',zg(ivol),                               &
                      '", f=point'
#else
                write(igbp,'(a,i0,3(a,1pe15.6e3),a)')                  &
                      'zone t = "Flow variables, volume = ',ivol,      &
                      ', x = ',xg(ivol),                               &
                      ', y = ',yg(ivol),                               &
                      ', z = ',zg(ivol),                               &
                      '", f=point'
#endif
              end if
            end if

          
!c  write tecplot zone section information for binary output
            if (b_output_trans_binary) then
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           igbp_mpi(igb),nvarsigbp,0,offset_igbp(igb), &
                           .true.,.true.,b_output_multizone)
            end if

!c  root related output
            if (root_uptake) then
              if (b_output_binary) then
#ifndef MPI
                if (igbroot_mpi(igb) < 10) then
                  igbroot_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,                 &
                             igbroot_mpi(igb), prefix(:l_prfx)//'_'//  &
                             suffix(:l_sufx)//'.gbroot', .true.)
              else
                open(igbroot,file=prefix(:l_prfx)//'_'//               &
                     suffix(:l_sufx)//'.gbroot',status='unknown',      &
                     form='formatted')
              end if

!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
                      'root uptake model, ',                           &
                      'x = ',xg(ivol),' m',                            &
                      'y = ',yg(ivol),' m',                            &
                      'z = ',zout,' m',                                &
                      ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
                                    suffix(:l_sufx)//'.gbroot'
                                                                        
                write(ifls,'(2a)')                                     &
                   'column   entry                           ','unit' 
                write(ifls,'(2a)')                                     &
                   '1        time                            ',time_unit
                write(ifls,'(2a)')                                     &
                   '2        root length density             ','m/m^3'
                write(ifls,'(2a)')                                     &
                   '3        reduction factor                ','-'           
                write(ifls,'(2a)')                                     &
                   '4        proportion of pot transpiration ','-'           
                write(ifls,'(2a)')                                     &
                   '5        wilting point saturation        ','-'           
                write(ifls,'(2a)')                                     &
                   '6        field capacity saturation       ','-'
                write(ifls,'(2a)')                                     &
                   '7        optional saturation             ','-'
                write(ifls,'(2a)')                                     &
                   '8        wilting point pressure          ','m'           
                write(ifls,'(2a)')                                     &
                   '9        field capacity pressure         ','m'
                write(ifls,'(2a)')                                     &
                   '10       optional pressure               ','m'
              end if
            end if
          
          end if
          
!c  ---------------------------------------------------------------
!c  reactive transport

!c  total aqueous component concentrations

!c  open file

          if (reactive_transport) then

            if (b_output_trans_binary) then
#ifndef PETSC
              if (igbt_mpi(igb) < 10) then
                igbt_mpi(igb) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           igbt_mpi(igb), prefix(:l_prfx)//'_'//       &
                           suffix(:l_sufx)//'.gbt', .true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//   &
                                     '_'//suffix(:l_sufx)//'.gbt')

              if (b_rewind_valid .and. i_append_sim > 0) then
                open(igbt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbt',status='unknown',         &
                     form='formatted',position='rewind')
              else
                open(igbt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.gbt',status='unknown',         &
                     form='formatted')
              end if
            end if

!c  write file information

            if (rank == 0 .and. b_enable_output) then

              write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                  &
                    'Total aqueous component concentrations, ',        &
                    'x = ',xg(ivol),' m',                              &
                    'y = ',yg(ivol),' m',                              &
                    'z = ',zout,' m',                                  &
                    ('-',i=1,72)

              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//               &
                                  suffix(:l_sufx)//'.gbt'

              write(ifls,'(2a)')                                       &
                  'column   entry                           ','unit'
              write(ifls,'(2a)')                                       &
                  '1        time                            ',time_unit
              do     ic = 1,nc-1
                if (ic.lt.9) then
                  write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic),       &
                                               'moles/l h2o'
                else
                  write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic),       &
                                                'moles/l h2o'
                end if
              end do
            
            end if

!cdsu concentration of radioelement related to noble gas ingrowth
            if (b_use_ngi .and. ngre_i > 0) then
              if (b_output_trans_binary) then
#ifndef PETSC
                if (igbre_mpi(igb) < 10) then
                  igbre_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,                 &
                             igbre_mpi(igb), prefix(:l_prfx)//'_'//    &
                             suffix(:l_sufx)//'.gbre', .true.)
              else
                b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                       '_'//suffix(:l_sufx)//'.gbre')
  
                if (b_rewind_valid .and. i_append_sim > 0) then
                  open(igbre,file=prefix(:l_prfx)//'_'//               &
                       suffix(:l_sufx)//'.gbre',status='unknown',      &
                       form='formatted',position='rewind')
                else
                  open(igbre,file=prefix(:l_prfx)//'_'//               &
                       suffix(:l_sufx)//'.gbre',status='unknown',      &
                       form='formatted')
                end if
              end if

!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
                      'Concentration of radioelements, ',              &
                      'x = ',xg(ivol),' m',                            &
                      'y = ',yg(ivol),' m',                            &
                      'z = ',zout,' m',                                &
                      ('-',i=1,72)

                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
                                    suffix(:l_sufx)//'.gbre'

                write(ifls,'(2a)')                                     &
                    'column   entry                           ','unit'
                write(ifls,'(2a)')                                     &
                    '1        time                            ',time_unit
                do ingre = 1,ngre_i
                  if (ingre.lt.9) then
                    write(ifls,'(i1,8x,a30,2x,a)') ingre+1,            &
                          name_ngre_i(ingre),'mg kg^-1 solid or ppm'
                  else
                    write(ifls,'(i2,7x,a30,2x,a)') ingre+1,            &
                          name_ngre_i(ingre),'mg kg^-1 solid or ppm'
                  end if
                end do
            
              end if
            end if

!cdsu extended output of transient data            
            if (extended_output_gb) then              
!c  aqueous species concentrations

!c  open file
              if (b_output_trans_binary) then
#ifndef PETSC
                if (igbc_mpi(igb) < 10) then
                  igbc_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,                 &
                             igbc_mpi(igb), prefix(:l_prfx)//'_'//     &
                             suffix(:l_sufx)//'.gbc', .true.)
              else
                b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                       '_'//suffix(:l_sufx)//'.gbc')

                if (b_rewind_valid .and. i_append_sim > 0) then
                  open(igbc,file=prefix(:l_prfx)//'_'//                &
                       suffix(:l_sufx)//'.gbc',status='unknown',       &
                       form='formatted',position='rewind')
                else
                  open(igbc,file=prefix(:l_prfx)//'_'//                &
                       suffix(:l_sufx)//'.gbc',status='unknown',       &
                       form='formatted')
                end if

              end if

!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
                      'Species concentrations, ',                      &
                      'x = ',xg(ivol),' m',                            &
                      'y = ',yg(ivol),' m',                            &
                      'z = ',zout,' m',                                &
                      ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
                                    suffix(:l_sufx)//'.gbc'
                                                                        
                write(ifls,'(2a)')                                     &
                  'column   entry                           ','unit'    
                write(ifls,'(2a)')                                     &
                  '1        time                            ',time_unit 
                do ic = 1,nc-1                                            
                  if (ic.lt.9) then                                       
                    write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic),     &
                                                 'moles/l h2o'            
                  else                                                    
                    write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic),     &
                                                 'moles/l h2o'            
                  end if                                                  
                end do                                                    
                do ix = 1,nx                                              
                  if (ix+nc-1.lt.9) then                                  
                    write(ifls,'(i1,8x,a30,2x,a)') ix+nc,namex(ix),    &
                                                  'moles/l h2o'           
                  elseif (ix+nc-1.ge.9.and.ix+nc-1.lt.99) then            
                    write(ifls,'(i2,7x,a30,2x,a)') ix+nc,namex(ix),    &
                                                  'moles/l h2o'           
                  else                                                    
                    write(ifls,'(i2,7x,a30,2x,a)') ix+nc,namex(ix),    &
                                                  'moles/l h2o'
                  end if
                end do
            
              end if
            
              if (b_output_activity) then
            
                if (b_output_trans_binary) then
#ifndef PETSC   
                  if (igbac_mpi(igb) < 10) then
                    igbac_mpi(igb) = lun_get()
                  end if
#endif        
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbac_mpi(igb), prefix(:l_prfx)//'_'//  &
                               suffix(:l_sufx)//'.gbac', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbac')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbac,file=prefix(:l_prfx)//'_'//             &
                         suffix(:l_sufx)//'.gbac',status='unknown',    &
                         form='formatted',position='rewind')
                  else
                    open(igbac,file=prefix(:l_prfx)//'_'//             &
                         suffix(:l_sufx)//'.gbac',status='unknown',    &
                         form='formatted')
                  end if
                end if

!c  write file information

                if (rank == 0 .and. b_enable_output .and. i_append_sim > 0) then              
                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Species activity coefficients, ',             &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbac'
                                                                        
                  write(ifls,'(2a)')                                   &
                      'column   entry                           ','unit'  
                  write(ifls,'(2a)')                                   &
                      '1        time                            ',time_unit  
                  do ic = 1,nc-1                                             
                    if (ic.lt.9) then                                        
                      write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic),   &
                                                 '-'          
                    else                                                  
                      write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic),   &
                                                   '-'          
                    end if                                                
                  end do                                                  
                  do ix = 1,nx                                            
                    if (ix+nc-1.lt.9) then                                
                      write(ifls,'(i1,8x,a30,2x,a)') ix+nc,namex(ix),  &
                                                    '-'         
                    elseif (ix+nc-1.ge.9.and.ix+nc-1.lt.99) then          
                      write(ifls,'(i2,7x,a30,2x,a)') ix+nc,namex(ix),  &
                                                    '-'         
                    else                                                  
                      write(ifls,'(i2,7x,a30,2x,a)') ix+nc,namex(ix),  &
                                                    '-'
                    end if
                  end do
              
                end if
            
              end if

!c  master variables
              if (ph_output .or. pe_output) then
!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbm_mpi(igb) < 10) then
                    igbm_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbm_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbm', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbm')

                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbm,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbm',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbm,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbm',status='unknown',     &
                         form='formatted')
                  end if
                end if

!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Master variables, ',                          &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)

                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbm'

                  write(ifls,'(2a)')                                   &
                      'column   entry                           ','unit'
                  write(ifls,'(2a)')                                   &
                      '1        time                            ',time_unit
                  if ((ph_output).and.(pe_output)) then
                    write(ifls,'(a,30x,a)')'2        pH','-'
                    write(ifls,'(a,30x,a)')'3        pe','-'
                    write(ifls,'(a,30x,a)')'4        Eh','-'
                    write(ifls,'(a,18x,a)')'5        ionic strength','-'
                    write(ifls,'(a,12x,a)')'6        carbonate alkalinity',   &
                                           'eq/L'
                    write(ifls,'(a,8x,a)')'7        non-carbonate alkalinity',&
                                           'eq/L'
                    write(ifls,'(a,22x,a)')'8        alkalinity','eq/L'
                    write(ifls,'(a,12x,a)')'9        carbonate alkalinity',   &
                                           'mg/L CaCO3'
                    write(ifls,'(a,8x,a)')'10       non-carbonate alkalinity',&
                                           'mg/L CaCO3'
                    write(ifls,'(a,22x,a)')'11       alkalinity','mg/L CaCO3'
                    write(ifls,'(a,21x,a)')'12       temperature','C'
                  elseif ((.not.ph_output).and.(pe_output)) then
                    write(ifls,'(a,30x,a)')'2        pe','-'
                    write(ifls,'(a,30x,a)')'3        Eh','-'
                    write(ifls,'(a,18x,a)')'4        ionic strength','-'
                    write(ifls,'(a,12x,a)')'5        carbonate alkalinity',   &
                                           'eq/L'
                    write(ifls,'(a,8x,a)')'6        non-carbonate alkalinity',&
                                           'eq/L'
                    write(ifls,'(a,22x,a)')'7        alkalinity','eq/L'
                    write(ifls,'(a,12x,a)')'8        carbonate alkalinity',   &
                                           'mg/L CaCO3'
                    write(ifls,'(a,8x,a)')'9        non-carbonate alkalinity',&
                                           'mg/L CaCO3'
                    write(ifls,'(a,22x,a)')'10       alkalinity','mg/L CaCO3'
                    write(ifls,'(a,21x,a)')'11       temperature','C'
                  elseif ((ph_output).and.(.not.pe_output)) then
                    write(ifls,'(a,30x,a)')'2        pH','-'
                    write(ifls,'(a,18x,a)')'3        ionic strength','-'
                    write(ifls,'(a,12x,a)')'4        carbonate alkalinity',   &
                                           'eq/L'
                    write(ifls,'(a,8x,a)')'5        non-carbonate alkalinity',&
                                           'eq/L'
                    write(ifls,'(a,22x,a)')'6        alkalinity','eq/L'
                    write(ifls,'(a,12x,a)')'7        carbonate alkalinity',   &
                                           'mg/L CaCO3'
                    write(ifls,'(a,8x,a)')'8        non-carbonate alkalinity',&
                                           'mg/L CaCO3'
                    write(ifls,'(a,22x,a)')'9        alkalinity','mg/L CaCO3'
                    write(ifls,'(a,21x,a)')'10       temperature','C'
                  end if

                end if

              end if    !ph_output .or. pe_output
            
!c  partial gas pressures

              if (ng.gt.0) then

!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbg_mpi(igb) < 10) then
                    igbg_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbg_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbg', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbg')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbg,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbg',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbg,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbg',status='unknown',     &
                         form='formatted')
                  end if
                end if 
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Partial gas pressures, ',                     &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                       
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbg'
                                                                       
                  write(ifls,'(2a)')                                   &
                     'column   entry                           ','unit'    
                  write(ifls,'(2a)')                                   &
                     '1        time                            ',time_unit 
                  do ig = 1,ng                                             
                    if (ig.lt.9) then                                      
                      write(ifls,'(i1,8x,a30,2x,a)') ig+1,nameg(ig),'atm'
                    else                                                   
                      write(ifls,'(i2,7x,a30,2x,a)') ig+1,nameg(ig),'atm'
                    end if                                                 
                  end do                                                   
                  write(ifls,'(2a)')                                   &
                        '1+ng+1   total gas pressure              ','atm'
              
                end if

!c  degassing rates

!c  open file

                if (gas_removal) then
                  if (b_output_trans_binary) then
#ifndef PETSC
                    if (igbgr_mpi(igb) < 10) then
                      igbgr_mpi(igb) = lun_get()
                    end if
#endif
                    call binary_file_open(PETSC_COMM_SELF,             &
                                 igbgr_mpi(igb), prefix(:l_prfx)//'_'//&
                                 suffix(:l_sufx)//'.gbgr', .true.)
                  else
                    b_rewind_valid = check_rewind_status(              &
                                           prefix(:l_prfx)//'_'//      &
                                           suffix(:l_sufx)//'.gbgr')
  
                    if (b_rewind_valid .and. i_append_sim > 0) then
                      open(igbgr,file=prefix(:l_prfx)//'_'//           &
                           suffix(:l_sufx)//'.gbgr',status='unknown',  &
                           form='formatted',position='rewind')
                    else
                      open(igbgr,file=prefix(:l_prfx)//'_'//           &
                           suffix(:l_sufx)//'.gbgr',status='unknown',  &
                           form='formatted')
                    end if
                  end if
!c  write file information

                  if (rank == 0 .and. b_enable_output) then

                    write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')            &
                          'Degassing rates, ',                         &
                          'x = ',xg(ivol),' m',                        &
                          'y = ',yg(ivol),' m',                        &
                          'z = ',zout,' m',                            &
                          ('-',i=1,72)

                    write(ifls,'(/a/)') prefix(:l_prfx)//'_'//         &
                                        suffix(:l_sufx)//'.gbgr'

                    write(ifls,'(2a)')                                 &
                          'column   entry                           ', &
                          'unit'
                    write(ifls,'(2a)')                                 &
                          '1        time                            ', &
                           time_unit
                    do ig = 1,ng
                      if (ig.lt.9) then
                        write(ifls,'(i1,8x,a30,2x,a)') ig+1,nameg(ig), &
                                                      'mol L^-1 d^-1'
                      else
                        write(ifls,'(i2,7x,a30,2x,a)') ig+1,nameg(ig), &
                                                      'mol L^-1 d^-1'
                      end if
                    end do
                
                  end if

                end if              !(gas_removal)      

              end if                !(ng.gt.0)

!c  oxidation-reduction rates

             if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then

!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbi_mpi(igb) < 10) then
                    igbi_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbi_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbr', .true.)
                else
                  b_rewind_valid = check_rewind_status(                &
                                         prefix(:l_prfx)//'_'//        &
                                         suffix(:l_sufx)//'.gbr')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbi,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbr',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbi,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbr',status='unknown',     &
                         form='formatted')
                  end if
                end if
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Oxidation-reduction rates, ',                 &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)

                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbr'

                  write(ifls,'(2a)')                                   &
                     'column   entry                           ','unit'
                  write(ifls,'(2a)')                                   &
                     '1        time                            ',time_unit
                  do ir = 1,nr
                    if (ir.lt.9) then
                      write(ifls,'(i1,8x,a30,2x,a)') ir+1,namer(ir),   &
                                                   'moles/l h2o/day'
                    else
                      write(ifls,'(i2,7x,a30,2x,a)') ir+1,namer(ir),   &
                                                   'moles/l h2o/day'
                    end if
                  end do
                
                end if  

              end if                !(naq.eq.0.and.(nr.gt.0.....)

!c  rates of intra-aqueous kinetic reactions

              if (naq.gt.0) then

!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbi_mpi(igb) < 10) then
                    igbi_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbi_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbi', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbi')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbi,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbi',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbi,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbi',status='unknown',     &
                         form='formatted')
                  end if
                end if
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'rates of intra-aqueous kinetic reactions, ',  &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)

                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbi'

                  write(ifls,'(2a)')                                   &
                    'column   entry                           ','unit'
                  write(ifls,'(2a)')                                   &
                    '1        time                            ',time_unit
                  do iaq = 1,naq
                    if (iaq.lt.9) then
                      write(ifls,'(i1,8x,a30,2x,a)') iaq+1,nameaq(iaq),&
                                                    'moles/l h2o/day'
                    else
                      write(ifls,'(i2,7x,a30,2x,a)') iaq+1,nameaq(iaq),&
                                                    'moles/l h2o/day'
                    end if
                  end do
              
                end if

              end if                !(naq.gt.0)

!c  sorbed species concentrations

              if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.                    &
                  noncompetitive_sorption) then
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbb_mpi(igb) < 10) then
                    igbb_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbb_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbb', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbb')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbb,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbb',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbb,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbb',status='unknown',     &
                         form='formatted')
                  end if
                end if
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Sorbed species concentraions, ',              &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbb'
                                                                        
                  write(ifls,'(2a)')                                   &
                    'column   entry                           ','unit'    
                  write(ifls,'(2a)')                                   &
                    '1        time                            ',time_unit
                
                end if

!c  non-competitive sorption

                if (rank == 0 .and. b_enable_output) then

                  if (noncompetitive_sorption) then
                
                    ianc = 0
                    do ic = 1,nc-1
                      if (isotherm_type(ic).ne.'none') then
                        ianc = ianc+1
                        if (ianc.lt.9) then
                          write(ifls,'(i1,8x,a30,2x,a)') ianc+1,namec(ic),&
                                                        'moles/l bulk'     
                        else                                               
                          write(ifls,'(i2,7x,a30,2x,a)') ianc+1,namec(ic),&
                                                        'moles/l bulk'
                        end if
                      end if
                    end do
                
                  end if
              
                end if

!c  competitive sorption

                if (rank == 0 .and. b_enable_output) then

                  if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
                
!c  primary surface species

                    do isites = 1,nsites
                      ic = iaic(isites)
                      if (isites+nanc.lt.9) then
                        write(ifls,'(i1,8x,a30,2x,a)') isites+nanc+1,  &
                              namec(ic),output_unit_sb_surf      
                      else                                                
                        write(ifls,'(i2,7x,a30,2x,a)') isites+nanc+1,  &
                              namec(ic),output_unit_sb_surf
                      end if
                    end do

!c  secondary surface species

                    do isb = 1,nsb_ion
                      if (isb+nsites+nanc.lt.9) then
                        write(ifls,'(i1,8x,a30,2x,a)')isb+nsites+nanc+1, &
                              namesb_ion(isb),output_unit_sb_ion       
                      else                                                
                        write(ifls,'(i2,7x,a30,2x,a)')isb+nsites+nanc+1, &
                              namesb_ion(isb),output_unit_sb_ion
                      end if
                    end do
                  
                    do isb = 1,nsb_surf
                      if (isb+nsites+nanc.lt.9) then
                        write(ifls,'(i1,8x,a30,2x,a)')isb+nsites+nanc+1, &
                              namesb_surf(isb),output_unit_sb_surf       
                      else                                                
                        write(ifls,'(i2,7x,a30,2x,a)')isb+nsites+nanc+1, &
                              namesb_surf(isb),output_unit_sb_surf
                      end if
                    end do

                  end if
              
                end if

              end if

!c  mineral saturation indices  
!c  open file

              if (nm.gt.0) then
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbs_mpi(igb) < 10) then
                    igbs_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbs_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbs', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbs')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbs,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbs',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbs,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbs',status='unknown',     &
                         form='formatted')
                  end if
                end if
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Mineral saturation indices, ',                &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbs'
                                                                        
                  write(ifls,'(2a)')                                   &
                     'column   entry                           ','unit'  
                  write(ifls,'(2a)')                                   &
                     '1        time                            ',time_unit
                  do im = 1,nm
                    if (im.lt.9) then
                      write(ifls,'(i1,8x,a30,2x,a)') im+1,namem(im),'-'
                    else
                      write(ifls,'(i2,7x,a30,2x,a)') im+1,namem(im),'-'
                    end if
                  end do
              
                end if

!c  mineral volume fractions 
!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbv_mpi(igb) < 10) then
                    igbv_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbv_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbv', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbv')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbv,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbv',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbv,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbv',status='unknown',     &
                         form='formatted')
                  end if
                end if
              
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Mineral volume fractions, ',                  &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                    suffix(:l_sufx)//'.gbv'
                                                                        
                  write(ifls,'(2a)')                                   &
                    'column   entry                           ','unit'    
                  write(ifls,'(2a)')                                   &
                    '1        time                            ',time_unit
                  do im = 1,nm
                    if (im.lt.9) then
                      write(ifls,'(i1,8x,a30,2x,a)') im+1,namem(im),'-'
                    else
                      write(ifls,'(i2,7x,a30,2x,a)') im+1,namem(im),'-'
                    end if
                  end do
                  if (nm.lt.8) then
                    write(ifls,'(i1,8x,a30,2x,a)') nm+2,'porosity','-'
                  else
                    write(ifls,'(i2,7x,a30,2x,a)') nm+2,'porosity','-'
                  end if
              
                end if

!c  dissolution-precipitation rates 
!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbd_mpi(igb) < 10) then
                    igbd_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbd_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbd', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbd')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbd,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbd',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbd,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbd',status='unknown',     &
                         form='formatted')
                  end if
                end if
!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Dissolution-precipitation rates, ',           &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbd'
                                                                        
                  write(ifls,'(2a)')                                   &
                    'column   entry                           ','unit'
                  write(ifls,'(2a)')                                   &
                    '1        time                            ',time_unit
                                                                         
                  istart = iamd(1)                                         
                  istop = iamd(nm+1)-1                                     
                  do ireac = istart,istop                                  
                    if (ireac.lt.9) then                                   
                      write(ifls,'(i1,8x,a30,2x,a)') ireac+1,          &
                                      namemp(ireac),'moles/l bulk/day'
                    else                                                   
                      write(ifls,'(i2,7x,a30,2x,a)') ireac+1,          &
                                      namemp(ireac),'moles/l bulk/day'
                    end if
                  end do
              
                end if
           
              end if                           !(nm.gt.0)

              if (nmx.gt.0) then

!c  saturation indices (excluded minerals) 
!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbx_mpi(igb) < 10) then
                    igbx_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbx_mpi(igb), prefix(:l_prfx)//'_'//   &
                               suffix(:l_sufx)//'.gbx', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbx')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbx,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbx',status='unknown',     &
                         form='formatted',position='rewind')
                  else
                    open(igbx,file=prefix(:l_prfx)//'_'//              &
                         suffix(:l_sufx)//'.gbx',status='unknown',     &
                         form='formatted')
                  end if
                end if

!c  write file information

                if (rank == 0 .and. b_enable_output) then

                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Saturation indices (excluded minerals), ',    &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbx'
                                                                        
                  write(ifls,'(2a)')                                   &
                     'column   entry                           ','unit'
                  write(ifls,'(2a)')                                   &
                     '1        time                            ',time_unit
                  do imx = 1,nmx
                    if (imx.lt.9) then
                      write(ifls,'(i1,8x,a30,2x,a)') imx+1,namemx(imx),'-'
                    else
                      write(ifls,'(i2,7x,a30,2x,a)') imx+1,namemx(imx),'-'
                    end if
                  end do
              
                end if
 
              end if                           !(nmx.gt.0)
            
!c_isotope
!c  isotope data 
!c  open file
              if (iso_output) then
                
!c  dissolution-precipitation rates 
!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (igbis_mpi(igb) < 10) then
                    igbis_mpi(igb) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               igbis_mpi(igb), prefix(:l_prfx)//'_'//  &
                               suffix(:l_sufx)//'.gbis', .true.)
                else
                  b_rewind_valid = check_rewind_status(prefix(:l_prfx)// &
                                         '_'//suffix(:l_sufx)//'.gbis')
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(igbis,file=prefix(:l_prfx)//'_'//             &
                         suffix(:l_sufx)//'.gbis',status='unknown',    &
                         form='formatted',position='rewind')
                  else
                    open(igbis,file=prefix(:l_prfx)//'_'//             &
                         suffix(:l_sufx)//'.gbis',status='unknown',    &
                         form='formatted')
                  end if
                end if

!c  write file information
                if (rank == 0 .and. b_enable_output) then
                  write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')              &
                        'Isotope Data, ',                              &
                        'x = ',xg(ivol),' m',                          &
                        'y = ',yg(ivol),' m',                          &
                        'z = ',zout,' m',                              &
                        ('-',i=1,72)
                                                                        
                  write(ifls,'(/a/)') prefix(:l_prfx)//'_'//           &
                                      suffix(:l_sufx)//'.gbis'
                                                                        
                  write(ifls,'(2a)')                                   &
                      'column   entry                           ','unit'  
                  write(ifls,'(2a)')                                   &
                      '1        time                            ',     &
                        time_unit              
                
                  icount = 1
                  do i=1,nip
                    istart = iamdisoo(i)
                    istop = iamdisoo(i+1)-1
                    do i1 = istart, istop
                      ic2 = jamdisoo(i1)
                      icount = icount +1
                      if (icount.le.9) then
                        write(ifls,'(i1,8x,a30,2x,a)') icount,namec(ic2),&
                                             'moles/l h2o'
                      else
                        write(ifls,'(i2,7x,a30,2x,a)') icount,namec(ic2),&
                                             'moles/l h2o'
                      end if
                    end do
                    icount = icount +1
                    ic2 = jamdisoo(istart)
                    if (icount.le.9) then
                      write(ifls,'(i1,8x,a4,a,4x,a)') icount, 'sum ',  &
                            namec(ic2), 'moles/l h2o'                      
                    else                                                    
                      write(ifls,'(i2,8x,a4,a,4x,a)') icount, 'sum ',  &
                            namec(ic2), 'moles/l h2o'
                    end if
               
                    istart = iamdisoo(i)
                    istop = iamdisoo(i+1)-1
                    do i1 = istart+1, istop
                      ic1 = jamdisoo(istart)
                      ic2 = jamdisoo(i1)
                      icount = icount +1 
                      if (icount.le.9) then
                        write(ifls,'(i1,8x,a6,a8,a2,a8,8x,a)') icount,   &
                          'delta ', namec(ic2),'/ ', namec(ic1),'per mil' 
                      else                                                
                        write(ifls,'(i2,8x,a6,a8,a2,a8,8x,a)') icount,   &
                          'delta ', namec(ic2),'/ ', namec(ic1),'per mil'
                      end if                    
                    end do
                  end do 
                end if              
              end if                           !(iso_output)
            end if

            if (mip_mt_enable) then

!c  saturation indices (excluded minerals) 
!c  open file
              if (b_output_binary) then
#ifndef MPI
                if (igbmip_mpi(igb) < 10) then
                  igbmip_mpi(igb) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,                 &
                             igbmip_mpi(igb), prefix(:l_prfx)//'_'//   &
                             suffix(:l_sufx)//'.gbmip', .true.)
              else
                open(igbmip,file=prefix(:l_prfx)//'_'//                &
                     suffix(:l_sufx)//'.gbmip',status='unknown',       &
                     form='formatted')
              end if

!c  write file information

              if (rank == 0 .and. b_enable_output) then

                write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                &
                      'MIP-MT bubble model, ',                         &
                      'x = ',xg(ivol),' m',                            &
                      'y = ',yg(ivol),' m',                            &
                      'z = ',zout,' m',                                &
                      ('-',i=1,72)
                                                                        
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
                                    suffix(:l_sufx)//'.gbmip'
                                                                        
                write(ifls,'(2a)')                                     &
                   'column   entry                           ','unit' 
                write(ifls,'(2a)')                                     &
                   '1        time                            ',time_unit
                write(ifls,'(2a)')                                     &
                   '2        gas cluster                     ','-'
                write(ifls,'(2a)')                                     &
                   '3        air saturatio                   ','-'        
                write(ifls,'(2a)')                                     &
                   '4        entry threshold                 ','m'
                write(ifls,'(2a)')                                     &
                   '5        terminal threshold              ','m'  

                do ig = 1,ng
                  imipvar = 5+ig  
                  if (imipvar.lt.10) then
                    write(ifls,'(i1,8x,a32,20x,a)') imipvar,nameg(ig),'Pa'
                  else
                    write(ifls,'(i2,7x,a32,20x,a)') imipvar,nameg(ig),'Pa'
                  end if
                end do
                
                do ig = 1,ng
                  imipvar = 5+ig+ng  
                  if (imipvar.lt.10) then
                    write(ifls,'(i1,8x,a32,20x,a)') imipvar,           &
                          trim(nameg(ig))//'_aq','mol/L H2O'
                  else
                    write(ifls,'(i2,7x,a32,20x,a)') imipvar,           &
                          trim(nameg(ig))//'_aq','mol/L H2O'
                  end if
                end do
                
                do ig = 1,ng
                  imipvar = 5+ig+2*ng  
                  if (ig.lt.7) then
                    write(ifls,'(i1,8x,a32,20x,a)') imipvar,           &
                          'tot '//trim(nameg(ig))//'_aq','mol/L H2O'
                  else
                    write(ifls,'(i2,7x,a32,20x,a)') imipvar,           &
                          'tot '//trim(nameg(ig))//'_aq','mol/L H2O'
                  end if
                end do
              
              end if
 
            end if                           !(mip_mt_enable)

          end if                             !(reactive_transport)      
        end do                               !(igb = 1,ngb)
      end if                                 !(gb_output)
      
!c  transient data for interface fluxes
!c -----------------------------------------------------------------------   

      if (gb_output_faceflux .and. b_enable_output) then
          
!c  write header for transient data to file information file

        if (rank == 0) then
          write(ifls,'(//72a/a/72a)')                                  &
               ('*',i=1,72),                                           &
               'transient data - interface fluxes - global system',    &
               ('*',i=1,72)         
        end if
        
        if (transient_flow) then
            
          if (b_output_trans_binary) then
            allocate(offset_igfvel(ngb_ijface), stat = ierr)
            offset_igfvel = 0
            call checkerr(ierr,'offset_igfvel',ilog)
            call memory_monitor(sizeof(offset_igfvel),'offset_igfvel',.true.)
            
            allocate(offset_igfvel_ijk(ngb_ijface), stat = ierr)
            offset_igfvel_ijk = 0
                  call checkerr(ierr,'offset_igfvel_ijk',ilog)
            call memory_monitor(sizeof(offset_igfvel_ijk),'offset_igfvel_ijk',.true.)
            
            allocate(igfvel(ngb_ijface), stat = ierr)
            igfvel = 0
            call checkerr(ierr,'igfvel',ilog)
            call memory_monitor(sizeof(igfvel),'igfvel',.true.)
          else
            allocate(igfvel(ngb_ijface), stat = ierr)
            igfvel = 0
            call checkerr(ierr,'igfvel',ilog)
            call memory_monitor(sizeof(igfvel),'igfvel',.true.)
          end if
        end if  
        
        if (reactive_transport) then            
          if (b_output_trans_binary) then
            allocate(offset_igcvel(n,ngb_ijface), stat = ierr)
            offset_igcvel = 0
            call checkerr(ierr,'offset_igcvel',ilog)
            call memory_monitor(sizeof(offset_igcvel),'offset_igcvel',.true.)
            
            allocate(offset_igcvel_temp(n,ngb_ijface), stat = ierr)
            offset_igcvel_temp = 0
            call checkerr(ierr,'offset_igcvel_temp',ilog)
            call memory_monitor(sizeof(offset_igcvel_temp),'offset_igcvel_temp',.true.)
            
            allocate(offset_igcvel_ijk(n,ngb_ijface), stat = ierr)
            offset_igcvel_ijk = 0
            call checkerr(ierr,'offset_igcvel_ijk',ilog)
            call memory_monitor(sizeof(offset_igcvel_ijk),'offset_igcvel_ijk',.true.)
            
            allocate(igcvel(n,ngb_ijface), stat = ierr)
            igcvel = 0
            call checkerr(ierr,'igcvel',ilog)
            call memory_monitor(sizeof(igcvel),'igcvel',.true.)
          else
            allocate(igcvel(n,ngb_ijface), stat = ierr)
            igcvel = 0
            call checkerr(ierr,'igcvel',ilog)
            call memory_monitor(sizeof(igcvel),'igcvel',.true.)
          end if          
        end if

        do igb = 1,ngb_ijface                 !loop over output locations

          ivol = ngb_vol_ijface(1,igb)        !local volume number
          jvol = ngb_vol_ijface(2,igb)
          
          if (ivol == jvol .or. ivol <= 0 .or. jvol <= 0) then   !control volume in the current domain
            cycle 
          end if    !End control volume in the current domain
        
!c  assign depth coordinate in terms of depth or elevation
!c
!c  for domain decomposition method, ivol = -1 indicates that 
!c  this volume is not in the current sub-domain, skip it.
          xout = (xg(ivol)+xg(jvol))*0.5d0
          yout = (yg(ivol)+yg(jvol))*0.5d0
          zout = (zoutput(depth_output,zg(ivol),elevmax) +             &
                  zoutput(depth_output,zg(jvol),elevmax))*0.5d0

!c  assign file suffixes
!c  maximum of 999 locations

          !rewind(icnv)            !Deprecated, use internal convert instead. DSU
          if(igb.lt.10) then
            !write(icnv,'(i1)') igb 
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') igb
            l_sufx = 1
          elseif ((igb.ge.10).and.(igb.lt.100)) then
            !write(icnv,'(i2)') igb 
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') igb
            l_sufx = 2
          else
            !write(icnv,'(i3)') igb 
            !rewind(icnv)
            !read(icnv,'(a3)') suffix
            write(suffix,'(i3)') igb
            l_sufx = 3
          end if

!c  open files for transient data and write information
!c  to file information file

!c  ---------------------------------------------------------------
!c  variably saturated flow

!c  open file

          if (transient_flow) then              
           
!c  assign unit numbers for output of transient data
            igfvel(igb) = lun_get()

            if (b_output_trans_binary) then
              call binary_file_open(PETSC_COMM_SELF,                   &
                          igfvel(igb), prefix(:l_prfx)//'_'//          &
                          suffix(:l_sufx)//'.gfvel', .true.)
            else
              open(igfvel(igb),file=prefix(:l_prfx)//'_'//             &
                   suffix(:l_sufx)//'.gfvel',status='unknown',         &
                   form='formatted')
            end if
!c  write file information
            if (rank == 0 .and. b_enable_output) then 

              write(ifls,'(/a/3(a,1pe9.2,a,2x)/72a)')                  & 
                    'Average interfacial velocities, ',                &
                    'x = ',xout,' m',                                  &
                    'y = ',yout,' m',                                  &
                    'z = ',zout,' m',                                  &
                    ('-',i=1,72)
        
                                                                         
              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//               &
                                  suffix(:l_sufx)//'.gfvel'
                                                                         
              write(ifls,'(2a)')                                       &
                   'column   entry                          ','unit'     
              write(ifls,'(2a)')                                       &
                    '1        time                           ',time_unit 

              write(ifls,'(2a)')                                       &
                    '2        v_x                             ','m/d'    
              
              write(ifls,'(2a)')                                       &
                    '3        v_y                             ','m/d'    
              
              write(ifls,'(2a)')                                       &
                    '4        v_z                             ','m/d'
          
            end if

!c  title and variables

!c  version information
            if (b_writeversion_tecplot.and..not.b_output_trans_binary) then
              call writeversion2file(igfvel(igb), "#")
            end if
        
            if (b_output_trans_binary) then
              offset_igfvel(igb) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           igfvel(igb), "#!TDV102",'dataset '//        &
                           prefix(:l_prfx),offset_igfvel(igb),.true.,  &
                           .true.)              
            else
              write(igfvel(igb),'(3a)') 'title = "dataset ',           &
                    prefix(:l_prfx),'"'
            end if
            
            if (b_output_trans_binary) then
                
              nvarsigfvel = 4  
              tec_variables(1:4)= [character(len=72) ::                &
                                    "time","vx","vy","vz"]                                                                       
            
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           igfvel(igb), nvarsigfvel,                   &
                           tec_variables(1:nvarsigfvel),               &
                           offset_igfvel(igb),.true.,.true.) 
            
            else

              write(igfvel(igb),'(4a)') 'variables = "time",',         &
                                        ' "vx",',' "vy",',' "vz"'
          
            end if !binary output 

!c  zone record for fully saturated or variably saturated conditions
            if (b_output_trans_binary) then 
#ifdef PETSC
              write(strbuffer,'(4(a,i0,1x))')                          &
                    'Flow variables, local volume = ',ivol,            &
                    ', global volume = ', node_idx_lg2g(ivol),         &       
                    'connected to local volume = ',jvol,               &
                    ', global volume = ', node_idx_lg2g(jvol) 
#else        
              write(strbuffer,'(2(a,i0,1x))')                          &
                    'Flow variables, volume = ',ivol,                  &
                    'connected to volume = ',jvol
#endif       
              !c the number of values (here 1) is just for temporary output
              !c that should be output in every time step as this value is
              !c not predicitable
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           igfvel(igb),trim(strbuffer),                &
                           offset_igfvel(igb), 1, 1, 1, .true.,.true., &
                           b_output_multizone)
              offset_igfvel_ijk(igb) = offset_igfvel(igb) - 5*4
             
            else
#ifdef PETSC
              write(igfvel(igb),'(4(a,i0,1x),a)')                      &
                    'zone t = "Flow variable, local volume = ',ivol,   &
                    ', global volume = ', node_idx_lg2g(ivol),         &       
                    'connected to local volume = ',jvol,               &
                    ', global volume = ', node_idx_lg2g(jvol),         &       
                    '", f=point'
#else        
              write(igfvel(igb),'(2(a,i0,1x),a)')                      &
                    'zone t = "Flow variables, volume = ',ivol,        &
                    'connected to volume = ',jvol,'", f=point'
#endif       
            end if
          
!c  write tecplot zone section information for binary output
            if (b_output_trans_binary) then
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           igfvel(igb),nvarsigfvel,0,                  &
                           offset_igfvel(igb),.true.,.true.,           &
                           b_output_multizone) 
            end if
          
          end if
          
!c  ---------------------------------------------------------------
!c  reactive transport
          if (reactive_transport) then    
              
            if (b_output_trans_binary) then
              nvarsigcvel = 13  
              tec_variables(1:nvarsigcvel) = [character(len=72) ::     &
                                "time", "vx adv", "vy adv", "vz adv",  &
                                "vx dif", "vy dif", "vz dif", "vx mig",&
                                "vy mig", "vz mig", "vx tot", "vy tot",&
                                "vz tot"]
            end if
             
            do ic = 1, n
              call icnvrt(0,ic,suffix2,l_sfx2,ierr)
!c  open file
              igcvel(ic,igb) = lun_get()
              if (b_output_trans_binary) then
                call binary_file_open(PETSC_COMM_SELF,                 &
                             igcvel(ic,igb), prefix(:l_prfx)//'_'//&
                             suffix(:l_sufx)//'_'//suffix2(:l_sfx2)//  &
                             '.gcvel', .true.)
              else
                open(igcvel(ic,igb),file=prefix(:l_prfx)//'_'//        &
                     suffix(:l_sufx)//'_'//suffix2(:l_sfx2)//'.gcvel', &
                     status='unknown',form='formatted')
              end if

!c  write file information
              if (rank == 0 .and. b_enable_output) then   
                write(ifls,'(/2a/3(a,1pe9.2,a,2x)/72a)')               & 
                      'Average interfacial velocities for component ', &
                      namec(ic)(:l_namec(ic)),                         &
                      'x = ',xout,' m',                                &
                      'y = ',yout,' m',                                &
                      'z = ',zout,' m',                                &
                      ('-',i=1,72)                
             
                write(ifls,'(/a/)') prefix(:l_prfx)//'_'//             &
                      suffix(:l_sufx)//'_'//suffix2(:l_sfx2)//'.gcvel'
              
                write(ifls,'(2a)')                        &
                    'column   entry                           ','unit'
                write(ifls,'(2a)')                        &
                    '1        time                           ',time_unit 
                write(ifls,'(2a)')                        &
                    '2        v_x Advection                   ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '3        v_y Advection                   ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '4        v_z Advection                   ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '5        v_x Diffusion                   ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '6        v_y Diffusion                   ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '7        v_z Diffusion                   ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '8        v_x Electromigration            ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '9        v_y Electromigration            ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '10       v_z Electromigration            ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '11       v_x Total                       ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '12       v_y Total                       ','moles/m^2/d'
                write(ifls,'(2a)')                        &
                    '13       v_z Total                       ','moles/m^2/d'
                
              end if  

!c  version information
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(igcvel(ic,igb), "#")
              end if
              
              if (b_output_trans_binary) then
                strbuffer = 'dataset '//prefix(:l_prfx)//'' 
                offset_igcvel(ic,igb) = 0
                call tecplot_binary_write_header(PETSC_COMM_SELF,              &
                             igcvel(ic,igb),"#!TDV102", trim(strbuffer),       &
                             offset_igcvel(ic,igb),b_output_mpiio_single,.false.) 
                
                call tecplot_binary_write_variable(PETSC_COMM_SELF,            &
                             igcvel(ic,igb),13, tec_variables(1:13),           &
                             offset_igcvel(ic,igb),b_output_mpiio_single,.false.) 
                
                strbuffer = 'advection and diffusion fluxes'
                offset_igcvel_temp(ic,igb) = offset_igcvel(ic,igb)
                
                if (b_output_multizone) then
                  call tecplot_binary_write_zoneinfo(                          &
                               PETSC_COMM_SELF, igcvel(ic,igb),                &
                               trim(strbuffer),offset_igcvel(ic,igb),          &
                               itec_vel,jtec_vel,ktec_vel,                     &
                               b_output_mpiio_single,.false.,b_output_multizone)
                  offset_igcvel(ic,igb) = offset_igcvel_temp(ic,igb) +         &
                                (11+len_trim(strbuffer))*4*nprcs + 4
                else
                  call tecplot_binary_write_zoneinfo(                          &
                               PETSC_COMM_SELF, igcvel(ic,igb),                &
                               trim(strbuffer),offset_igcvel(ic,igb),          &
                               itec_vel_gbl,jtec_vel_gbl,ktec_vel_gbl,         &
                               b_output_mpiio_single,.false.,b_output_multizone)
                  offset_igcvel(ic,igb) = offset_igcvel_temp(ic,igb) +         &
                                (12+len_trim(strbuffer))*4
                end if
                offset_igcvel_ijk(ic,igb) = offset_igcvel_temp(ic,igb) - 5*4
              else
                write(igcvel(ic,igb),'(3a)') 'title = "dataset ',              &
                                             prefix(:l_prfx),'"'
                write(igcvel(ic,igb),'(6a)') 'variables = "time", ',           &
                                  '"vx adv", "vy adv", "vz adv", ',            &
                                  '"vx dif", "vy dif", "vz dif", ',            &
                                  '"vx mig", "vy mig", "vz mig", ',            &
                                  '"vx tot", "vy tot", "vz tot"'
#ifdef PETSC
                write(igcvel(ic,igb),'(4(a,i0,1x),a)')                         &
                   'zone t = "advection and diffusion fluxes, local volume = ',&
                    ivol,', global volume = ', node_idx_lg2g(ivol),            &       
                   'connected to local volume = ',jvol,                        &
                   ', global volume = ', node_idx_lg2g(jvol),'", f=point'
#else           
                write(igcvel(ic,igb),'(2(a,i0,1x),a)')                         &
                   'zone t = "advection and diffusion fluxes, volume = ',ivol, &
                   'connected to volume = ',jvol,'", f=point'
#endif          
              end if
   
            end do
          end if                             !(reactive_transport)      
        end do                               !(igb = 1,ngb_ijface)
      end if                                 !(gb_output_faceflux)      
      
!c  temporal evolution about energy and evaporation parameters
      if (transient_flow.or.reactive_transport) then
        if (evaporation.and.write_evap_info) then
          if(rank == 0 .and. b_enable_output) then
            call trans_evap_info (.true.,0)
          end if
        end if
      end if

!c  write header for contour data to file information file

      if (gs_output .and. rank == 0 .and. b_enable_output) then
        write(ifls,'(//72a/a/72a)')                                   &
                    ('*',i=1,72),                                     &
                    'contour data - global system',                   &
                    ('*',i=1,72)
      end if

      return
      end
