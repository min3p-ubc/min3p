!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision:$
!> $Author:$
!> $Date:$
!> $URL:$
!---------------------------------------------------------------------
!********************************************************************!

!>
!> module matrix_convert_output
!>
!> This module includes functions to do matrix convert and output to file.
!> matrix convert: yale sparse matrix format => matrix market format (MM format)
!>
!> written by:      Danyang Su
!>
!> last modified:   Danyang Su - Mar. 08, 2018
!>
module matrix_convert_output

    implicit none
    
    integer, allocatable :: mm_ia(:)    !> row pointers for matrix                     
    integer, allocatable :: mm_ja(:)    !> column pointers for matrix
    real(8), allocatable :: mm_a(:)     !> matrix values
    real(8), allocatable :: mm_b(:)     !> forcing vector
    real(8), allocatable :: mm_x(:)     !> approximate solution 
    
    integer :: imatrix_num = 0          !> number of output matrix
    integer :: mm_nn = 0                !> number of unknows               
    integer :: mm_nja = 0               !> number of global connections
    
    
contains
    
    !> Convert yale sparse matrix to matrix market format
    subroutine matrix_convert_to_mmformat (nn, nja, ia, ja, a, b, x)
    
        implicit none
        
        integer, intent(in) :: nn           !>number of unknowns
        integer, intent(in) :: nja          !>number of global connections
        integer, intent(in) :: ia(nn + 1)   !>row start pointers for a()
        integer, intent(in) :: ja(nja)      !>global connection list for a()
        real(8), intent(in) :: a(nja)       !>matrix values
        real(8), intent(in) :: b(nn)        !>forcing vector
        real(8), intent(in) :: x(nn)        !>approximate solution
        
        integer :: i, j
       
        mm_nn = nn
        mm_nja = nja
        
        ! allocate mm_ia if necessary
        if(.not. allocated(mm_ia)) then
            allocate(mm_ia(nja))
        end if        
        if(size(mm_ia,1) /= nja) then
            deallocate(mm_ia)
            allocate(mm_ia(nja))
        end if
        
        ! allocate mm_ja if necessary
        if (.not. allocated(mm_ja)) then
            allocate(mm_ja(nja))
        end if 
        if(size(mm_ja,1) /= nja) then
            deallocate(mm_ja)
            allocate(mm_ja(nja))
        end if        
        
        ! allocate mm_a if necessary
        if (.not.allocated(mm_a)) then
            allocate(mm_a(nja))
        end if
        if(size(mm_a,1) /= nja) then
            deallocate(mm_a)
            allocate(mm_a(nja))
        end if 
        
        ! allocate mm_b if necessary
        if (.not.allocated(mm_b)) then
            allocate(mm_b(nn))
        end if
        if(size(mm_b,1) /= nn) then
            deallocate(mm_b)
            allocate(mm_b(nn))
        end if 
        
        ! allocate mm_x if necessary
        if (.not.allocated(mm_x)) then
            allocate(mm_x(nn))       
        end if
        if(size(mm_x,1) /= nn) then
            deallocate(mm_x)
            allocate(mm_x(nn))
        end if     
        
        do i = 1, nn
            mm_ia(ia(i): ia(i + 1) - 1) = i
        end do
        
        mm_ja = ja
        mm_a = a    
        mm_b = b
        mm_x = x
    
    end subroutine matrix_convert_to_mmformat
    
    !> Output mm format matrix to file
    !> For temporary use only
    subroutine matrix_mmformat_output
        
        implicit none
        
        integer :: iunit
        integer :: i
        character(12) :: str_num
        
        iunit = 81
        
        imatrix_num = imatrix_num + 1        
        write(str_num,*) imatrix_num
        
        !write matrix a
        open(unit = iunit, file = "matrix_a_"//trim(adjustl(str_num))//".mtx", status = "replace")
        write(iunit,100)        
        write(iunit, *)   mm_nn, mm_nn, mm_nja        
        do i = 1, mm_nja
            write(iunit, *)   mm_ia(i), mm_ja(i), mm_a(i)
        end do        
        close(iunit)        
        
        ! write matrix b
        open(unit = iunit, file = "matrix_b_"//trim(adjustl(str_num))//".mtx", status = "replace")
        write(iunit,100)  
        write(iunit, *)   mm_nn, 1, mm_nn        
        do i = 1, mm_nn
            write(iunit, *)   i, 1, mm_b(i)
        end do        
        close(iunit)   
        
        open(unit = iunit, file = "matrix_x_"//trim(adjustl(str_num))//".mtx", status = "replace")  
        write(iunit,100)  
        write(iunit, *)   mm_nn, 1, mm_nn        
        do i = 1, mm_nn
            write(iunit, *)   i, 1, mm_x(i)
        end do    
        close(iunit)

        
100     format("%%MatrixMarket matrix coordinate real general                                       "   &
               /,"%================================================================================="   &
               /,"%                                                                                 "   &
               /,"% This ASCII file represents a sparse MxN matrix with L                           "   &
               /,"% nonzeros in the following Matrix Market format:                                 "   &
               /,"%                                                                                 "   &
               /,"% +----------------------------------------------+                                "   &
               /,"% |%%MatrixMarket matrix coordinate real general | <--- header line               "   &
               /,"% |%                                             | <--+                           "   &
               /,"% |% comments                                    |    |-- 0 or more comment lines "   &
               /,"% |%                                             | <--+                           "   &
               /,"% |    M  N  L                                   | <--- rows, columns, entries    "   &
               /,"% |    I1  J1  A(I1, J1)                         | <--+                           "   &
               /,"% |    I2  J2  A(I2, J2)                         |    |                           "   &
               /,"% |    I3  J3  A(I3, J3)                         |    |-- L lines                 "   &
               /,"% |        . . .                                 |    |                           "   &
               /,"% |    IL JL  A(IL, JL)                          | <--+                           "   &
               /,"% +----------------------------------------------+                                "   &
               /,"%                                                                                 "   &
               /,"% Indices are 1-based, i.e. A(1,1) is the first element.                          "   &
               /,"%                                                                                 "   &
               /,"%=================================================================================" )        
        
    end subroutine matrix_mmformat_output

end module matrix_convert_output
