!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/chem.F90 $
!---------------------------------------------------------------------
!********************************************************************!

      module chem

      use parm
!cprovi-----------------------------------------------------------------
!cprovi  We have added one dependence more 
!cprovi       18/01/2009 
!cprovi  Sergio Andrï¿½s Bea Jofr?
!cprovi-----------------------------------------------------------------
      use m_phase
      
      implicit none
      
!cprovi-----------------------------------------------------------------      
!c ----------------------------------------------------------------------
!c common - local geochemistry
!c
!c ----------------------------------------------------------------------
!c control parameters (local geochemistry):
!c ----------------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           acth2omin          = minimum activity for h2o
!c           dinc_lc            = factor to compute increment for 
!c                                numerical differentiation
!c           ph_fixed           = fixed value for pH
!c           ph_inc             = ph-increment for pH-sweep 
!c                                calculations
!c           ph_start           = initial pH for pH-sweep 
!c                                calculations
!c           ph_stop            = final pH for pH-sweep 
!c                                calculations
!c           sionmax            = maximum ionic strength of solution
!c           srelfac_lc
!c                              = user specified underrelaxation
!c                                factor (local chemistry)
!c           tempc              = temperature [deg C]
!c           tempk              = temperature [deg K]
!c           tfinal_lc          = final solution time 
!c                                (local chemistry)
!c           time_factor_lc     = conversion factor from I/O time
!c                                units to internal time units
!c           tinyrate           = set reaction rates to zero,
!c                                if smaller than tinyrate
!c           tol_lc             = convergence tolerance
!c                                (local chemistry)
!c
!c           integer*4:
!c           ----------
!c           iph_steps          = counter (ph-sweep calculations)
!c           naq                = number of intra-aqueous kinetic 
!c                                reactions
!c           nc                 = number of components including h2o
!c           nbio               = number of biomass components
!c           nna                = number of non-aqueous components
!c           ncorder(nc)        = ordering array for components
!c                                ncorder(old order) = new order 
!c           ng                 = number of gases
!c           nph_steps          = number of pH-steps for pH-sweep 
!c                                calculations
!c           nm                 = number of minerals
!c           nmx                = number of excluded minerals
!c           nopu               = number of primary unknowns
!c           nr                 = number of redox couples
!c           nx                 = number of secondary aqueous species
!c           maxit_lc           = max. number of iterations
!c                                (local chemistry)
!c           idetail_lc
!c                              = information level
!c           ittot_lc(nthreads) = total number of iterations
!c                                (local chemistry)
!c           iter_lc(nthreads)  = iteration counter
!c                                (local chemistry)
!c
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity
!c           explicit_surface   = .true.  -> include surface sites
!c                                           in equilibrium 
!c                                           calculations
!c           explicit_surface_ion  = .true.  -> include surface sites
!c                                           in equilibrium 
!c                                           calculations
!c                                           of ion-exchange
!c           explicit_surface_surf = .true.  -> include surface sites
!c                                           in equilibrium 
!c                                           calculations
!c                                           of surface-complex
!c           finite_minerals    = .true.  -> finite minerals 
!c           implicit_surface   = .true.  -> equilibrate surface
!c                                           sites with fixed 
!c                                           solution composition
!c           implicit_surface_ion  = .true.  -> equilibrate surface
!c                                           sites with fixed 
!c                                           solution composition
!c                                           of ion-exchange
!c           implicit_surface_surf = .true.  -> equilibrate surface
!c                                           sites with fixed 
!c                                           solution composition
!c                                           of surface-complex
!c           reactive_minerals  = .true.  -> consider mineral    
!c                                           dissolution-
!c                                           precipitation reactions
!c           minequil(nm)       = .true.  -> equilibrate aqueous 
!c                                           species with specified 
!c                                           mineral
!c           new_database       = .true.  -> use new database format
!c
!c           space_delimiter_dbs
!c                              = .true.  -> use space delimiter (merged) 
!c                                           for the database
!c
!c           ph_sweep           = .true.  -> sweep over specified
!c                                           pH-range
!c           redox_equil_lc     = .true.  -> equilibrium redox
!c                                           reactions
!c           search_database    = .true.  -> search database for
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c           temp_corr          = .true.  -> specify constant 
!c                                           temperature
!c                                .false. -> use standard 
!c                                           temperature
!c           temp_field         = .true.  -> nodal temperatures 
!c           tstart_to_equil    = .true.  -> stop kinetic batch  
!c                                           simulation when 
!c                                           equilibrium with
!c                                           specified minerals is
!c                                           reached
!c           tstart_to_tfinal   = .true.  -> stop kinetic batch  
!c                                           simulation when tfinal 
!c                                           is reached
!c
!c           b_use_gas_decay     = .true.  -> use gas decay to correct reaction
!c           b_use_sorption_decay  = .true.  -> use sorbed components decay to 
!c                                            correct reaction
!c
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component
!c                                'surface' = surface site
!c                                'biomass' = biomass
!c           ctype(nc-1)        = 'charge' = correct total aqueous
!c                                           component concentration
!c                                           for specified component 
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on 
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           ctype_init(nc-1)   = 'charge' = correct total aqueous
!c                                           component concentration
!c                                           for specified component
!c                                           to satisfy charge balance
!c                                'fixed'  = compute total aqueous
!c                                           component concentrations
!c                                           based on fixed activities
!c                                           of components as species
!c                                           in solution
!c                                'free'   = compute concentrations
!c                                           of components as species
!c                                           in solution based on
!c                                           specified total aqueous
!c                                           component concentrations
!c                                'ph'    =  pH specified for 'h+1'
!c           ctype_bzrt_init(nc-1,nbzrt)  =  same as above, used only
!c                                           for initial transient boundary update
!c           ctype_bzrt_init(nc-1,nbzrt,ntsrc+1)  
!c                                        =  same as above, used only
!c                                           for transient boundary series update
!c           redox_master       = 'o2(aq)'
!c                                'h2(aq)'
!c                                'e-1'
!c           input_units        = 'mol/l'
!c                                'mmol/l'
!c                                'mg/l'
!c                                'g/l'
!c           time_unit_lc       = time unit for output -> 'years'
!c                                                        'days'
!c                                                        'hours'
!c                                                        'seconds'
!c           update_activity(nthreads)
!c                              = 'no_update' -> unity activity
!c                                 coefficients
!c                                'time_lagged' -> update activity
!c                                 coefficients after each time step
!c                                'double_update' -> double update
!c                                 of activity coefficients during
!c                                 Newton iterations
!c           update_activity_lc = 'no_update' -> unity activity
!c                                 coefficients
!c                                'time_lagged' -> update activity
!c                                 coefficients after each time step
!c                                'double_update' -> double update
!c                                 of activity coefficients during
!c                                 Newton iterations
!c                                 (local chemistry)
!c        -->                                                         <--
!c ----------------------------------------------------------------------

      real (type_r8) :: acth2omin
      real (type_r8) :: dinc_lc
      real (type_r8) :: ph_fixed
      real (type_r8) :: ph_inc
      real (type_r8) :: ph_start
      real (type_r8) :: ph_stop
      real (type_r8) :: sionmax
      real (type_r8) :: srelfac_lc
      real (type_r8) :: tempc
      real (type_r8) :: tempk
      real (type_r8) :: tfinal_lc
      real (type_r8) :: tinyrate
      real (type_r8) :: time_factor_lc
      real (type_r8) :: tol_lc
     
      integer (type_i4), allocatable :: ncorder(:)

      integer (type_i4) :: iph_steps
      integer (type_i4) :: maxit_lc
      integer (type_i4) :: idetail_lc
      integer (type_i4), allocatable :: ittot_lc(:)
      integer (type_i4), allocatable :: iter_lc(:)
      integer (type_i4) :: naq
      integer (type_i4) :: nbio
      integer (type_i4) :: nna
      integer (type_i4) :: nc
      integer (type_i4) :: nx
      integer (type_i4) :: nm
      integer (type_i4) :: nmx
      integer (type_i4) :: nopu
      integer (type_i4) :: ng
      integer (type_i4) :: nr
      integer (type_i4) :: nph_steps
      
      integer (type_i4) :: nip              !isotope

      integer (type_i4) :: linear_solver_lc !linear solver type of local chemistry, 0 - Gaussian (default), 1 - QR, 2 - SVD

      logical, allocatable :: minequil(:)

      logical :: under_relax_lc
      logical :: compute_alkalinity
      !logical :: explicit_surface
      logical :: explicit_surface_ion
      logical :: explicit_surface_surf
      logical :: finite_minerals
      !logical :: implicit_surface
      logical :: implicit_surface_ion
      logical :: implicit_surface_surf
      logical :: new_database
      logical :: space_delimiter_dbs
      logical :: ph_sweep
      logical :: reactive_minerals
      logical :: redox_equil_lc
      logical :: search_database
      logical :: specified_ph
      logical :: temp_corr
      logical :: temp_field
      logical :: tstart_to_equil
      logical :: tstart_to_tfinal
      logical :: b_use_gas_decay
      logical :: b_use_aq_decay
      logical :: b_use_sorption_decay

      character*12, allocatable :: component_type(:)
      character*12, allocatable :: ctype(:)
      character*12, allocatable :: ctype_init(:)
      character*12, allocatable :: ctype_bzrt_init(:,:)

      character*12 :: input_units
      character*12 :: time_unit_lc 
      character*12 :: redox_master
      character*72, allocatable :: update_activity(:)
      character*72 :: update_activity_lc
            

!c ----------------------------------------------------------------------
!c constants (local geochemistry):
!c -------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           adav               = coefficient for Davies equation   
!c           avog_const         = avogadro constant [1 mol^-1]
!c           bdav               = coefficient for Davies equation
!c           diel_const         = dielectric constant of water
!c                                unitless, for 25 deg C
!c           dhad(nthreads)     = Debye Huckel constant a_d depending 
!c                                on dielectric constant and 
!c                                temperature
!c           dhbd(nthreads)     = Debye Huckel constant b_d depending 
!c                                on dielectric constant and 
!c                                temperature
!c           ehfac              = factor for calculating Eh from pe
!c           farad_const        = faraday constant [C mol^-1]
!c           pa_atm             = conversion factor [Pa atm ^-1]
!c           permit_const       = permittivity of free space
!c                                [C V^-1 m^-1] or [C^2 J^-1 m^-1]
!c           pres_atm           = atmospheric pressure [atm]
!c           rgasatm            = ideal gas constant 
!c                                [liter atm/(deg K mole)]
!c           rgascal            = ideal gas constant 
!c                                [kcal/(deg K mole)]
!c           rgasjoule          = ideal gas constant
!c                                [J/(deg K mol)]
!c           rho_w              = desnity of water [kg m^-3]
!c           tempcs             = standard temperature [deg C]
!c           tempks             = standard temperature [deg K]
!c           tconv              = temperature correction factor
!c                                [m s^-2]
!c           cal2jou            = unit conversion from calories to Joules
!c                                1 calories is equal to 4.1868 Joules      
!c        -->                                                         <--
!c ----------------------------------------------------------------------

      real (type_r8) :: adav
      real (type_r8) :: avog_const
      real (type_r8) :: bdav
      real (type_r8) :: diel_const
      real (type_r8), allocatable :: dhad(:)
      real (type_r8), allocatable :: dhbd(:)
      real (type_r8) :: ehfac
      real (type_r8) :: farad_const
      real (type_r8) :: pa_atm
      real (type_r8) :: permit_const
      real (type_r8) :: pres_atm
      real (type_r8) :: tempcs
      real (type_r8) :: tempks
      real (type_r8) :: tconv
      real (type_r8) :: rgasatm
      real (type_r8) :: rgascal
      real (type_r8) :: rgasjoule
      real (type_r8) :: rho_w
      real (type_r8) :: cal2jou

!c ----------------------------------------------------------------------
!c time step control (local geochemistry):
!c ---------------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           delt_lc(nthreads)  = time step (local chemistry)
!c           delt_max_lc        = maximum time step (local chemistry) 
!c
!c           integer*4:
!c           ----------
!c           ntstp_lc(nthreads) = time step counter 
!c                                (local chemistry)
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: delt_lc(:) 
      real (type_r8) :: delt_max_lc
     
      integer (type_i4), allocatable :: ntstp_lc(:)

!c ----------------------------------------------------------------------
!c control parameters for I/O (local geochemistry):
!c ------------------------------------------------
!c        -->                                                         <--
!c           integer*4:
!c           ----------
!c           ilbb               = unit number, concentrations of
!c                                             sorbed species
!c                                             - transient data
!c                                               (local system)
!c           ilbc               = unit number, concentrations of 
!c                                             components as species 
!c                                             in solution and
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - transient data
!c                                               (local system)
!c           ilbac              = unit number, activity coefficients
!c                                             - transient data
!c                                               local system
!c           ilbd               = unit number, reaction rates for
!c                                             dissolution-
!c                                             precipitation
!c                                             reactions
!c                                             - transient data
!c                                               (local system)
!c           ilbg               = unit number, partial gas pressures
!c                                             - transient data
!c                                               (local system)
!c           ilbgr              = unit number, degassing rates
!c                                             - transient data
!c                                               (local system)
!c           ilbm               = unit number, master variables
!c                                             - transient data
!c                                               (local system)
!c           ilbi               = unit number, rates of intra-aqueous
!c                                             kinetic reactions
!c                                             - transient data
!c                                               (local system)
!c           ilbs               = unit number, saturation indices
!c                                             - transient data
!c                                               (local system)
!c           ilbt               = unit number, total aqueous 
!c                                             component
!c                                             concentrations 
!c                                             - transient data
!c                                               (local system)
!c           ilbv               = unit number, mineral volume
!c                                             fractions
!c                                             - transient data
!c                                               (local system)
!c           ilbx               = unit number, saturation indices
!c                                             excluded minerals
!c                                             - transient data
!c                                               (local system)
!c
!c           logical:
!c           --------
!c           lb_output          = .true.  -> output of transient data 
!c                                           (local chemistry)
!c           ph_output          = .true.  -> output of pH
!c           pe_output          = .true.  -> output of pe and Eh
!c        -->                                                         <--
!c ----------------------------------------------------------------------

      integer (type_i4) :: ilbb
      integer (type_i4) :: ilbc
      integer (type_i4) :: ilbd
      integer (type_i4) :: ilbg
      integer (type_i4) :: ilbgr
      integer (type_i4) :: ilbm
      integer (type_i4) :: ilbi
      integer (type_i4) :: ilbs
      integer (type_i4) :: ilbt
      integer (type_i4) :: ilbv
      integer (type_i4) :: ilbx
      integer (type_i4) :: ilbac

!cdsu concentration of radioelement related to noble gas ingrowth
      integer (type_i4) :: ilbre

      logical :: lb_output
      logical :: pe_output
      logical :: ph_output

!c ----------------------------------------------------------------------
!c main variables - aqueous species:
!c ---------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           actv(nc)           = activities of components as species
!c                                in solution - new time level
!c           alkfacc(nc)        = alkalinity factors for components
!c           alkfacx(nx)        = alkalinity factors for secondary 
!c                                aqueous species
!c           ccnew(nc)          = concentrations of components as
!c                                species in solution
!c                                - new time level [moles/l water]
!c           ccold(nc)          = concentrations of components as
!c                                species in solution
!c                                - old time level [moles/l water]
!c           chargec(nc)        = charge of components as species
!c                                in solution
!c           chargex(nx)        = charge of secondary aqueous 
!c                                species
!c           cxc(nx)            = concentrations of secondary
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           cxmax(nx)          = maximum concentration of secondary
!c                                aqueous species in solution domain
!c           distcoff_lc(nc)    = sorption distribution coefficient
!c                                [-], [l bulk/l bulk] 
!c                                - local chemistry
!c           dhac(nc)           = debye-huckel a for components as
!c                                species in solution
!c           dhax(nx)           = debye-huckel a for secondary 
!c                                aqueous species
!c           dhbc(nc)           = debye-huckel b for components as
!c                                species in solution
!c           dhbx(nx)           = debye-huckel b for secondary
!c                                aqueous species
!c           dhcx(nx)           = enthalpy change for secondary 
!c                                aqueous species
!c           eqx(nx,nthreads)   = equilibrium constants for 
!c                                secondary aqueous species
!c           eqxs(nx)           = equilibrium constants for 
!c                                secondary aqueous species
!c                                at standard temperature
!c           gamma_l(nc+nx)     = activity coefficients of aqueous 
!c                                species
!c           gfwc(nc)           = gram formula weight of components
!c           gfwx(nx)           = gram formula weight of secondary
!c                                aqueous species 
!c           phguess            = guess for pH
!c           phguess_init(nbzrt)= guess for pH of initial boundary condition
!c           phguess_func(6,nbzrt)
!c                              = transient boundary condition function parms for guess of pH 
!c           sion1(nthreads)    = ionic strength (local chemistry)
!c           totcmin(n)         = minimum total aqueous component
!c                                concentration in solution domain
!c           totcn(n,nthreads)  = total aqueous component             
!c                                concentrations                  
!c                                - new time level [moles/l water]
!c           totco(n,nthreads)  = total aqueous component 
!c                                concentrations 
!c                                - old time level [moles/l water]
!c           totco_func(6,n,nbzrt)  
!c                              = transient boundary condition function parms of total 
!c                                aqueous component concentrations [moles/l water]
!c           totcinit(n)        = total aqueous component 
!c                                concentrations 
!c                                - initial concenttrations 
!c                                [moles/l water]
!c           xnux(nx*nc)        = stoichiometric coefficient matrix 
!c                                for formation of secondary aqueous 
!c                                species from components
!c           xnuxc(nx*nc)       = stoichiometric coefficient matrix 
!c                                for formation of secondary aqueous 
!c                                species from components. 
!c                                Index by free species to secondary species
!c           cpz_loc(nc+nx)     = concentration array, local variable
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in secondary aqueous
!c                                species
!c           jax(nx*nc)         = column pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in secondary aqueous
!c                                species
!c           l_namec(nc)        = length of component names
!c           l_namex(nx)        = length of names of secondary
!c                                aqueous species
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names
!c           namex(nx)          = names of secondary aqueous species 
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: actv(:)
      real (type_r8), allocatable :: alkfacc(:)
      real (type_r8), allocatable :: alkfacx(:)
      real (type_r8), allocatable :: totcinit(:)
      real (type_r8), allocatable :: totcn(:,:)
      real (type_r8), allocatable :: totcmin(:)
      real (type_r8), allocatable :: totcmin_gbl(:)
      real (type_r8), allocatable :: totco(:,:)
      real (type_r8), allocatable :: totco_tmp(:)
      real (type_r8), allocatable :: totco_func(:,:,:)
      real (type_r8), allocatable :: ccnew(:)
      real (type_r8), allocatable :: ccold(:)
      real (type_r8), allocatable :: gamma_l(:)
      real (type_r8), allocatable :: chargec(:)
      real (type_r8), allocatable :: gfwc(:)
      real (type_r8), allocatable :: distcoff_lc(:)
      real (type_r8), allocatable :: dhac(:)
      real (type_r8), allocatable :: dhbc(:)
      real (type_r8), allocatable :: cxc(:)
      real (type_r8), allocatable :: cxmax(:)
      real (type_r8), allocatable :: cxmax_gbl(:)
      real (type_r8), allocatable :: chargex(:)
      real (type_r8), allocatable :: eqx(:,:)
      real (type_r8), allocatable :: eqxs(:)
      real (type_r8), allocatable :: gfwx(:)
      real (type_r8), allocatable :: dhcx(:)
      real (type_r8), allocatable :: dhax(:)
      real (type_r8), allocatable :: dhbx(:)
      real (type_r8), allocatable :: xnux(:)
      real (type_r8), allocatable :: xnuxc(:)
      real (type_r8), allocatable :: cpz_loc(:)

      real (type_r8), allocatable :: sion1(:)
      real (type_r8) :: phguess
      real (type_r8), allocatable :: phguess_init(:)
      real (type_r8), allocatable :: phguess_func(:,:)

      integer (type_i4), allocatable :: iax(:)
      integer (type_i4), allocatable :: jax(:)

      integer (type_i4), allocatable :: iacx(:)
      integer (type_i4), allocatable :: jacx(:)

      integer (type_i4), allocatable :: l_namec(:)
      integer (type_i4), allocatable :: l_namex(:)

      character*72, allocatable :: namec(:)
      character*72, allocatable :: namex(:)

!c ----------------------------------------------------------------------
!c main variables - intra-aqueous kinetic reactions:
!c -------------------------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           eqaq(naq,nthreads) = equilibrium constants for
!c                                intra-aqueous kinetic reactions
!c           eqaqs(naq)         = equilibrium constants for
!c                                intra-aqueous kinetic reactions
!c                                at standard temperature
!c           dgaq(naq)          = activation energies for intra-
!c                                aqueous kinetic reaction
!c           dhaq(naq)          = enthalpy changes for intra-aqueous
!c                                kinetic reaction
!c           dtotaq(nc-1,nthreads)       
!c                              = derivative of total source-sink 
!c                                term towards total aqueous component 
!c                                concentrations due to intra-aqueous
!c                                kinetic reactions
!c           faqi(naq*nc)       = inhibition factors
!c           faqic(naq*nc)      = inhibition factors C^c
!c           faqit(naq*nc)      = inhibition factors T^a
!c           faqim(naq*nc)      = inhibition factors phi^m
!c           faqhc(naq*nc)      = half saturation constants C^c
!c           faqht(naq*nc)      = half saturation constants T^a
!c           faqhm(naq*nm)      = half saturation constants phi^m
!c           ordaqic(naq*nc)    = order of intra-aqueous kinetic
!c                                reaction for inhibition terms C^c
!c           ordaqit(naq*nc)    = order of intra-aqueous kinetic
!c                                reaction for inhibition terms T^a
!c           ordaqim(naq*nc)    = order of intra-aqueous kinetic
!c                                reaction for inhibition terms 
!c                                phi^m
!c           ordaqhc(naq*nc)    = order of intra-aqueous kinetic
!c                                reaction for hyperbolic terms C^c
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic
!c                                reaction for hyperbolic terms T^a
!c           ordaqhm(naq*nm)    = order of intra-aqueous kinetic
!c                                reaction for hyperbolic terms phi^m
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic
!c                                reaction (T^a)
!c           ordaqe(naq*nc)     = order of intra-aqueous kinetic
!c                                reaction (exponential T^a)
!c           ordaqc(naq*nc)     = order of intra-aqueous kinetic
!c                                reaction (C^c)
!c           ordaqx(naq*nx)     = order of intra-aqueous kinetic
!c                                reaction (C^x)
!c           rateaq(naq,nthreads)  
!c                              = reaction rates of intra-aqueous
!c                                kinetic reaction
!c           ratecaq(naq,nthreads)
!c                              = log of rate constant for intra-
!c                                aqueous kinetic reactions
!c                                (units: liter -  moles - seconds)
!c           ratecaqs(naq)      = log of rate constant for intra-
!c                                aqueous kinetic reactions at 
!c                                stndard temperature
!c                                (units: liter -  moles - seconds)
!c           sataq(naq,nthreads)= IAP/K for intra-aqueous kinetic
!c                                reactions
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous
!c                                kinetic reactions
!c           scalfac_aq_init(naq)= scaling factors for intra-aqueous
!c                                kinetic reactions for initial boundary 
!c                                conditions
!c           scalfac_aq_func(6,naq,nbzrt)
!c                               = scaling factors for intra-aqueous
!c                                kinetic reactions for transient boundary 
!c                                condition parms
!c           scalfac_aq(naq)    = scaling factors for intra-aqueous
!c                                kinetic reactions
!c           totaq(nc-1,nthreads)
!c                              = total source-sink term towards
!c                                total aqueous component 
!c                                concentrations due to intra-aqueous
!c                                kinetic reactions
!c
!c           totgasdecay(nc-1)  = total source-sink term towards
!c                                total aqueous component
!c                                concentration due to 1st order
!c                                gas decay
!c
!c
!c           dtotgasdecay(nc-1) = derivative of total source-sink term towards
!c                                total aqueous component
!c                                concentration due to 1st order
!c                                gas decay
!c
!c
!c
!c           xnuaq(naq*nc)      = stoichiometric coefficient of
!c                                components in intra-aqueous
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqi(2*naq+1)     = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           iaaqic(naq+1)      = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           iaaqit(naq+1)      = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           iaaqim(naq+1)      = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           iaaqhc(naq+1)      = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           iaaqht(naq+1)      = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           iaaqhm(naq+1)      = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           iaaqt(naq+1)       = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (T^a)
!c           iaaqc(naq+1)       = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (C^c)
!c           iaaqe(naq+1)       = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (exponential term T^a)
!c           iaaqx(naq+1)       = row pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (C^x)
!c           jaaq(naq*nc)       = column pointer array to
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqi(naq*nc)      = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms)
!c           jaaqic(naq*nc)     = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms C^c)
!c           jaaqit(naq*nc)     = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms T^a)
!c           jaaqim(naq*nc)     = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (inhibition terms phi^m)
!c           jaaqhc(naq*nc)     = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms C^c)
!c           jaaqht(naq*nc)     = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms T^a)
!c           jaaqhm(naq*nm)     = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (hyperbolic terms phi^m)
!c           jaaqt(naq*nc)      = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (T^a)
!c           jaaqc(naq*nc)      = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (C^c)
!c           jaaqe(naq*nc)      = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (exponential term T^a)
!c           jaaqx(naq*nc)      = column pointer array to reactants
!c                                in intra-aqueous kinetic reactions
!c                                (C^x)
!c           l_nameaq(naq)      = length of names of intra-aqueous
!c                                kinetic reactions
!c           naq                = number of intra-aqueous kinetic
!c                                reactions
!c
!crevintaff
!c
!c           logical:
!c           --------
!c           reverse_intra_affinity(naq) = .true. -> reverse affinity    
!c                                                   term if IAP/K > 1       
!crevintaff
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic
!c                                reactions
!c           rtype_aq(naq)      = reaction type of intra-aqueous
!c                                kinetic reaction
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: eqaq(:,:)
      real (type_r8), allocatable :: eqaqs(:)
      real (type_r8), allocatable :: dgaq(:)
      real (type_r8), allocatable :: dhaq(:)
      real (type_r8), allocatable :: dtotaq(:,:)
      real (type_r8), allocatable :: faqhc(:)
      real (type_r8), allocatable :: faqht(:)
      real (type_r8), allocatable :: faqhst(:)        !isotope
      real (type_r8), allocatable :: faqhm(:)
      real (type_r8), allocatable :: faqi(:)
      real (type_r8), allocatable :: faqic(:)
      real (type_r8), allocatable :: faqit(:)
      real (type_r8), allocatable :: faqim(:)
      real (type_r8), allocatable :: ordaqic(:)
      real (type_r8), allocatable :: ordaqit(:)
      real (type_r8), allocatable :: ordaqim(:)
      real (type_r8), allocatable :: ordaqhc(:)
      real (type_r8), allocatable :: ordaqht(:)
      real (type_r8), allocatable :: ordaqhst(:)      !isotope
      real (type_r8), allocatable :: ordaqhm(:)
      real (type_r8), allocatable :: ordaqt(:)
      real (type_r8), allocatable :: ordaqe(:)
      real (type_r8), allocatable :: ordaqc(:)
      real (type_r8), allocatable :: ordaqx(:)
      real (type_r8), allocatable :: rateaq(:,:)
      real (type_r8), allocatable :: ratecaq(:,:)
      real (type_r8), allocatable :: ratecaqs(:)
      real (type_r8), allocatable :: sataq(:,:)
      real (type_r8), allocatable :: scalfac_aq(:)
      real (type_r8), allocatable :: scalfac_aq_init(:,:)
      real (type_r8), allocatable :: scalfac_aq_func(:,:,:)
      real (type_r8), allocatable :: scalfac_aq_ivol(:,:)
      real (type_r8), allocatable :: totaq(:,:)
      real (type_r8), allocatable :: totaq_ngi(:,:)
      real (type_r8), allocatable :: xnuaq(:)
      real (type_r8), allocatable :: isoalphaa(:)     !isotope

      real (type_r8), allocatable :: totgasdecay(:)       !gas decay
      real (type_r8), allocatable :: dtotgasdecay(:)      !gas decay

      real (type_r8), allocatable :: totaqdecay(:)        !aqueous decay
      real (type_r8), allocatable :: dtotaqdecay(:)       !aqueous decay

      integer (type_i4), allocatable :: iaaq(:)
      integer (type_i4), allocatable :: iaaqi(:)
      integer (type_i4), allocatable :: iaaqic(:)
      integer (type_i4), allocatable :: iaaqit(:)
      integer (type_i4), allocatable :: iaaqim(:)
      integer (type_i4), allocatable :: iaaqhc(:)
      integer (type_i4), allocatable :: iaaqht(:)

      integer (type_i4), allocatable :: iaaqhst(:)     !c isotopes
      integer (type_i4), allocatable :: iaaqhst2(:)    !c isotopes
      integer (type_i4), allocatable :: ntsca(:)       !c isotopes
      integer (type_i4), allocatable :: iamdisoa(:)    !c isotopes
      integer (type_i4), allocatable :: iamdisoa2(:)   !c isotopes
      integer (type_i4), allocatable :: nifra(:)       !c isotopes
          
      integer (type_i4), allocatable :: iaaqhm(:)
      integer (type_i4), allocatable :: iaaqt(:)
      integer (type_i4), allocatable :: iaaqc(:)
      integer (type_i4), allocatable :: iaaqe(:)
      integer (type_i4), allocatable :: iaaqx(:)
      integer (type_i4), allocatable :: jaaq(:)
      integer (type_i4), allocatable :: jaaqt(:)
      integer (type_i4), allocatable :: jaaqc(:)
      integer (type_i4), allocatable :: jaaqe(:)
      integer (type_i4), allocatable :: jaaqx(:)
      integer (type_i4), allocatable :: jaaqhc(:)
      integer (type_i4), allocatable :: jaaqht(:)

!c isotopes
      integer (type_i4), allocatable :: jaaqhst(:)     !c isotopes 
      integer (type_i4), allocatable :: jamdisoa(:)    !c isotopes
      integer (type_i4), allocatable :: jamdisoa2(:)   !c isotopes
      real (type_r8), allocatable :: jamdalphaa(:)     !c isotopes
      
      integer (type_i4), allocatable :: jaaqhm(:)
      integer (type_i4), allocatable :: jaaqi(:)
      integer (type_i4), allocatable :: jaaqic(:)
      integer (type_i4), allocatable :: jaaqit(:)
      integer (type_i4), allocatable :: jaaqim(:)
      integer (type_i4), allocatable :: l_nameaq(:)
      
!c isotopes
      character*12, allocatable :: isotypea(:)
      
!crevintaff
      logical, allocatable :: reverse_intra_affinity(:)  
!crevintaff

      character*72, allocatable :: nameaq(:)
      character*72, allocatable :: rtype_aq(:)
      
      
!c isotopes    
      logical, allocatable :: isofraca(:)
      logical, allocatable :: isofracam(:)
          
!c ----------------------------------------------------------------------
!c main variables - oxidation-reduction:
!c -------------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           bcatfac(nr*nor)    = bacterial catalysis factor
!c           chomc(nr*nor*nc)   = cutoff concentrations for reacting 
!c                                species (components as species 
!c                                in solution)
!c           chomt(nr*nor*nc)   = cutoff concentration for reacting
!c                                species (total aqueous component 
!c                                concentrations) 
!c           chomx(nr*nor*nx)   = cutoff concentration for reacting
!c                                species (aqueous complexes)
!c           dhcr(nr)           = enthalpy change for redox reaction
!c           dtotor(nc-1)       = derivative of total source/sink 
!c                                term towards total aqueous 
!c                                component concentrations due to 
!c                                oxidation-reduction reactions 
!c                                [moles/(l bulk*day)]
!c           eqr(nr,nthreads)   = equilibrium constant for redox 
!c                                couple reaction equation
!c           eqrs(nr)           = equilibrium constant for redox 
!c                                for standard temperature
!c                                couple reaction equation
!c           ordorc(nr*nor*nc)  = order of oxidation-reduction
!c                                reaction with respect to components
!c                                as species in solution
!c           ordort(nr*nor*nc)  = order of oxidation-reduction
!c                                reaction with respect to total 
!c                                aqueous component concentrations
!c           ordorx(nr*nor*nx)  = order of oxidation-reduction
!c                                reaction with respect to 
!c                                secondary aqueous species
!c           rateor(nr,nthreads)= oxidation-reduction rate for
!c                                redox couple [moles/(l h2o*day)
!c           rateox(nr*nor)     = log of oxidation-reduction rate
!c                                constant
!c                                (units: liter -  moles - seconds)
!c           totor(nc-1)        = total source/sink term towards
!c                                total aqueous component 
!c                                concentrations due to 
!c                                oxidation-reduction reactions 
!c                                [moles/(l bulk*day)]
!c           xnur(nr*nc)        = stoichiometric coefficient of 
!c                                components in redox couple 
!c                                reaction equation
!c
!c           integer*4:
!c           ----------
!c           iaor(nr+1)         = pointer array to parallel
!c                                oxidation/reduction reactions 
!c           iaorc(nr*nor+1)    = row pointer array to reactants
!c                                in parallel oxidation-reduction
!c                                reactions (components as species
!c                                in solution)
!c           iaort(nr*nor+1)    = row pointer array to reactants
!c                                in parallel oxidation-reduction
!c                                reactions (total aqueous component 
!c                                concentrations)
!c           iaorx(nr*nor+1)    = row pointer array to reactants
!c                                in parallel oxidation-reduction
!c                                reactions (secondary aqueous
!c                                species)
!c           iarc(nr+1)         = row pointer array to
!c                                stoichiometric coefficients of 
!c                                components in redox reaction
!c           iars(nr)           = pointer array to secondary
!c                                component of redox couple
!c           jaorc(nr*nor*nc)   = column pointer array to reactants
!c                                in parallel oxidation-reduction
!c                                reactions (components as species
!c                                in solution)
!c           jaort(nr*nor*nc)   = column pointer array to reactants
!c                                in parallel oxidation-reduction
!c                                reactions (total aqueous component 
!c                                concentrations)
!c           jaorx(nr*nor*nx)   = column pointer array to reactants
!c                                in parallel oxidation-reduction
!c                                reactions (secondary aqueous
!c                                species)
!c           jarc(nr*nc)        = column pointer array to
!c                                stoichiometric coefficients of
!c                                components in redox reaction
!c           l_namer(nr)        = length of names of redox couples
!c           l_namerp(nr)       = length of names of primary
!c                                components of redox couples
!c           l_namers(nr)       = length of names of secondary
!c                                components of redox couples
!c           ncrc               = number of components with nonzero 
!c                                stoichiometric coefficients in 
!c                                redox couple reaction equation
!c           nor                = number of parallel 
!c                                oxidation-reduction reactions
!c                                for current redox couple
!c           norc               = number of reactants in current
!c                                oxidation-reduction reaction, 
!c                                (components as species in 
!c                                solution)
!c           nort               = number of reactants in current
!c                                oxidation-reduction reaction, 
!c                                (total aqueous component 
!c                                concentrations)
!c           norx               = number of reactants in current 
!c                                oxidation-reduction reaction, 
!c                                (secondary aqueous species)
!c
!c           logical:   
!c           --------
!c           redox_equil        = .true.  -> equilibrium reactions
!c                                           for redox couples
!c
!c           character:
!c           ----------
!c           namer(nr)          = names of redox couples
!c           namerp(nr)         = names of primary components of 
!c                                redox couples
!c           namers(nr)         = names of secondary components of 
!c                                redox couples
!c           rtype_hom(nr)      = reaction type of homogeneous
!c                                reaction in aqueous phase
!c                                'forward'
!c                                'backward'
!c                                'forward-to-equilibrium'
!c                                'backward-to-equilibrium'
!c                                'reversible'
!c                                'equilibrium'
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: bcatfac(:)
      real (type_r8), allocatable :: dhcr(:)
      real (type_r8), allocatable :: dtotor(:)
      real (type_r8), allocatable :: eqr(:,:)
      real (type_r8), allocatable :: eqrs(:)
      real (type_r8), allocatable :: chomc(:)
      real (type_r8), allocatable :: chomt(:)
      real (type_r8), allocatable :: chomx(:)
      real (type_r8), allocatable :: ordorc(:)
      real (type_r8), allocatable :: ordort(:)
      real (type_r8), allocatable :: ordorx(:)
      real (type_r8), allocatable :: rateor(:,:)
      real (type_r8), allocatable :: rateox(:)
      real (type_r8), allocatable :: totor(:)
      real (type_r8), allocatable :: xnur(:)

      integer (type_i4), allocatable :: iaor(:)
      integer (type_i4), allocatable :: iaorc(:)
      integer (type_i4), allocatable :: iaort(:)
      integer (type_i4), allocatable :: iaorx(:)
      integer (type_i4), allocatable :: iarc(:)
      integer (type_i4), allocatable :: iars(:)
      integer (type_i4), allocatable :: jaorc(:)
      integer (type_i4), allocatable :: jaort(:)
      integer (type_i4), allocatable :: jaorx(:)
      integer (type_i4), allocatable :: jarc(:)
      integer (type_i4), allocatable :: l_namer(:)
      integer (type_i4), allocatable :: l_namerp(:)
      integer (type_i4), allocatable :: l_namers(:)

      integer (type_i4) :: ncrc
      integer (type_i4) :: nor
      integer (type_i4) :: norc
      integer (type_i4) :: nort
      integer (type_i4) :: norx

      logical :: redox_equil

      character*145, allocatable :: namer(:)     !note: namer = namerp + "/" + namers
      character*72, allocatable :: namerp(:)
      character*72, allocatable :: namers(:)
      character*72, allocatable :: rtype_hom(:)

!c ----------------------------------------------------------------------
!c main variables - gases:
!c -----------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           cgc(ng)            = gas concentrations
!c                                - new time level [moles/l air]
!c           degas_rate         = rate constant for degassing
!c                                [mol L-1 h2o s-1]
!c           dhcg(ng)           = enthalpy change for gases
!c           eqg(ng,nthreads)   = equilibrium constants for gases 
!c           eqgs(ng)           = equilibrium constants for gases 
!c                                at standard temperature
!c           gfwg(ng)           = gram formula weight for gases
!c           rateg(ng,nthreads) = degassing rates
!c           totgn(nc-1,nthreads)
!c                              = total gaseous component
!c                                concentrations
!c                                - new time level [moles/l air]
!c           totgo(nc-1)        = total gaseous component 
!c                                concentrations
!c                                - old time level [moles/l air]
!c           totrateg(nc-1)     = total rate for removal of aqueous
!c                                components due to degassing
!c                                [mol L^-1 s^-1]
!c           xnug(ng*nc)        = stoichiometric coefficient matrix 
!c                                for formation of gases from
!c                                components
!c
!c           gasdecayconst(ng)   = gas decay constant [s^-1]
!c                                1st order rate constant equal to 
!c                                ln2/t_half = 0.693147/t_half
!c
!c           gasdecayrate(ng)   = gas decay rate [mol L^-1 s^-1]
!c
!c           dgasdecayrate(ng)  = gas decay rate [mol L^-1 s^-1]
!c
!c           aqdecayconst(ng)   = aqueous decay constant [s^-1]
!c                                1st order rate constant equal to 
!c                                ln2/t_half = 0.693147/t_half
!c
!c           aqdecayrate(ng)    = aqueous decay rate [mol L^-1 s^-1]
!c
!c           daqdecayrate(ng)   = aqueous decay rate [mol L^-1 s^-1]
!c
!c           sorptiondecayconst(nc-1)   
!c                              = sorbed components decay constant [s^-1]
!c                                1st order rate constant equal to 
!c                                ln2/t_half = 0.693147/t_half
!c           sorptiondecayrate(nc-1)   
!c                              = sorbed components decay rate 
!c                                [mol L^-1 bulk s^-1]   
!c           totsorptiondecay(nc-1)  
!c                              = total source-sink term towards
!c                                total aqueous component
!c                                concentration due to 1st order
!c                                sorbed components decay      
!c
!c           integer*4:
!c           ----------
!c           iaga(ng+1)         = row pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           jaga(ng*nc)        = column pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in gases
!c           l_nameg(ng)        = length of names of gases
!c
!c           logical:
!c           --------
!c           gas_removal        = .true.  -> degassing of dissolved
!c                                           gases, if confining 
!c                                           pressure exceeded
!c           dhc_reverse         = .true. -> revert enthalpy change.
!c                                enthaply change is reversed after
!c                                2006 and some fixed after 2009.
!c
!c           character:
!c           ----------
!c           nameg(ng)          = names of gases
!c
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: cgc(:)
      real (type_r8), allocatable :: rateg(:,:)
      real (type_r8), allocatable :: totgn(:,:)
      real (type_r8), allocatable :: totgo(:)
      real (type_r8), allocatable :: totrateg(:)
      real (type_r8), allocatable :: gfwg(:)
      real (type_r8), allocatable :: eqg(:,:)
      real (type_r8), allocatable :: eqgs(:)
      real (type_r8), allocatable :: dhcg(:)
      real (type_r8), allocatable :: xnug(:)

      real (type_r8), allocatable :: gasdecayconst(:)
      real (type_r8), allocatable :: gasdecayrate(:)
      real (type_r8), allocatable :: gasdecayratetot(:)
      real (type_r8), allocatable :: dgasdecayrate(:)

      real (type_r8), allocatable :: aqdecayconst(:)
      real (type_r8), allocatable :: aqdecayrate(:)
      real (type_r8), allocatable :: aqdecayratetot(:)
      real (type_r8), allocatable :: daqdecayrate(:) 

      real (type_r8), allocatable :: sorptiondecayconst(:)
      real (type_r8), allocatable :: sorptiondecayrate(:)
      real (type_r8), allocatable :: totsorptiondecay(:)     !sorbed components decay

      real (type_r8) :: degas_rate
      real (type_r8) :: max_sg_degas           !bub_degas

      integer (type_i4), allocatable :: iaga(:)
      integer (type_i4), allocatable :: jaga(:)
      integer (type_i4), allocatable :: l_nameg(:)

      logical :: gas_removal
      logical :: dhc_reverse

      character*72, allocatable :: nameg(:)
!c ----------------------------------------------------------------------
!c main variables -  sorbed species:
!c ---------------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           cec(nthreads)      = cation exchange capacity (meq/100g)
!c           cec_fraction(nsites_ion)
!c                              = the fraction of cec for each site (-)
!c           csb(nsb)           = concentrations of sorbed species
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads) 
!c                              = concentrations of sorbed species of ion-exchange
!c                                - new time level
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species of surface-complex
!c                                - new time level
!c           chargesb(nsb)      = charge of sorbed species
!c           chargesb_ion(nsb_ion)   
!c                              = charge of sorbed species of ion-exchange
!c           chargesb_surf(nsb_surf) 
!c                              = charge of sorbed species of surface-complex
!c           dhcsb(nsb)         = enthalpy change for sorbed species
!c           dhcsb_ion(nsb_ion)   
!c                              = enthalpy change for sorbed species of ion-exchange
!c           dhcsb_surf(nsb_surf) 
!c                              = enthalpy change for sorbed species of surface-complex
!c           eqsb(nsb)          = equilibrium constants for 
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for 
!c                                sorbed species of ion-exchange
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for 
!c                                sorbed species of surface-complex
!c           eqsbs(nsb)         = equilibrium constants for 
!c                                sorbed species at standard 
!c                                temperature
!c           eqsbs_ion(nsb_ion) = equilibrium constants for 
!c                                sorbed species of ion-exchange at standard 
!c                                temperature
!c           eqsbs_surf(nsb_surf) 
!c                              = equilibrium constants for 
!c                                sorbed species of surface-complex at standard 
!c                                temperature
!c           gfwsb(nsb)         = gram formula weight for sorbed
!c                                species
!c           gfwsb_ion(nsb_ion) = gram formula weight for sorbed
!c                                species
!c           gfwsb_surf(nsb_surf)  
!c                              = gram formula weight for sorbed
!c                                species
!c           rhobulk            = dry bulk density of porous medium
!c           site_area(nsites)  = surface area of mineral phase
!c                                [m^2 surface g^-1 mineral]
!c           site_dens(nsites)  = site density
!c                                [sites nm^-2 surface]
!c           site_mass(nsites)  = mass of mineral phase
!c                                [g L-1 h2o]
!c           totan(nc,nthreads) = total sorbed component
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           totao(nc)          = total sorbed component
!c                                concentrations
!c                                non-competitive sorption
!c                                - old time level [moles/l bulk)
!c           totcsn(nc-1)       = total sorbed component 
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c           totcsn_ion(nc-1,nthreads)
!c                              = total sorbed component 
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (ion-exchange)
!c           totcsn_surf(nc-1,nthreads)
!c                              = total sorbed component 
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           totcso(nc-1)       = total sorbed component 
!c                                concentrations
!c                                - old time level [moles/l bulk]
!c           totcso_ion(nc-1)   = total sorbed component 
!c                                concentrations of ion-exchange
!c                                - old time level [moles/l bulk]
!c           totcso_surf(nc-1)  = total sorbed component 
!c                                concentrations of surface-complex
!c                                - old time level [moles/l bulk]
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix
!c                                for formation of sorbed species 
!c                                from components
!c           xnusb_ion(nsb_ion*nc)   
!c                              = stoichiometric coefficient matrix
!c                                for formation of sorbed species of ion-exchange 
!c                                from components
!c           xnusb_surf(nsb_surf*nc) 
!c                              = stoichiometric coefficient matrix
!c                                for formation of sorbed species of surface-complex 
!c                                from components
!c
!c           integer*4:
!c           ----------
!c           iaic(nsites)                   = pointer array for compressed
!c                                            storage of surface site data
!c           iais(nc)                       = row pointer array for compressed
!c                                           storage of surface site data
!c           iasb(nsb+1)                    = row pointer array to
!c                                           stoichiometric coefficients of
!c                                           components in sorbed species
!c           iasb_ion(nsb_ion+1)            = row pointer array to
!c                                           stoichiometric coefficients of
!c                                           components in sorbed species of ion-exchange
!c           iasb_surf(nsb_surf+1)          = row pointer array to
!c                                           stoichiometric coefficients of surface-complex
!c                                           components in sorbed species
!c           jasb(nsb*nc)                   = column pointer array to
!c                                           stoichiometric coefficients of
!c                                           components in sorbed species
!c           jasb_ion(nsb_ion*nc)           = column pointer array to
!c                                           stoichiometric coefficients of
!c                                           components in sorbed species of ion-exchange
!c           jasb_surf(nsb_surf*nc)         = column pointer array to
!c                                           stoichiometric coefficients of
!c                                           components in sorbed species of surface-complex
!c           l_namesb(nsb)                  = length of names of sorbed
!c                                           species
!c           l_namesb_ion(nsb_ion)          = length of names of sorbed
!c                                           species of ion-exchange
!c           l_namesb_nsites_ion(nsites_ion)= length of names of surface
!c                                            site of ion-exchange
!c           idx_nsites_ion(nsites_ion)     = index of surface site in the 
!c                                           sorbed species of ion-exchange 
!c           nss_onIsite_ion(nsites_ion)    = number of sorbed species on each 
!c                                           surface site type (ion-exchange) 
!c           idx_ss2isite_ion(nsites_ion,nsb_ion) = idex of sorbed species on each 
!c                                           surface site type (ion-exchange) 
!c           l_namesb_surf(nsb_surf)    = length of names of sorbed
!c                                        species of surface-complex
!c           l_nameanc(nc)      = length of names of sorbed 
!c                                components (non-competitive
!c                                sorption
!c           nanc               = number of sorbed species
!c                                non-competitive sorption
!c           nlinear            = number of components undergoing 
!c                                linear sorption
!c           nsb                = number of sorbed species
!c           nsb_ion            = number of sorbed species of ion-exchange
!c           nsb_surf           = number of sorbed species of surface-complex
!c           nsites             = number of surface sites
!c           nsites_ion         = number of surface sites of ion-exchange
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           namesb(nsb)        = names of sorbed species
!c           namesb_ion(nsb_ion)= names of sorbed species of ion-exchange
!c           namesb_sites_ion(nsites_ion)   
!c                              = names of the surface sites of ion-exchange
!c           namesb_surf(nsb_surf)   = names of sorbed species of surface-complex

!c           nameanc(nc)        = names of sorbed species 
!c                                (non-competitive sorption)
!c           output_unit_sb     = output unit for sorption 
!c                                reactions
!c           output_unit_sb_ion = output unit for sorption 
!c                                reactions of ion-exchange
!c           output_unit_sb_surf= output unit for sorption 
!c                                reactions of surface-complex
!c           sorption_group     = 'ion-exchange'
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'
!c                                'gapon'
!c                                'surface-complex'
!c                                'constant-capacitance'
!c           sorption_type_ion  = 'gaines-thomas'
!c                                'gapon'
!c           sorption_type_surf = 'surface-complex'
!c                                'constant-capacitance'
!c           logical:
!c           --------
!c           noncompetitive_sorption = logical array for activation   
!c                                     of noncompetitive sorption
!c                                     reactions
!c           linear_sorption         = logical variable controlling
!c                                     linear sorption
!c           b_equivalent_ex  = .true.  -> use equivalent fraction for exchanger
!                                       -> e.g., 0.5Ca+2 + Na-X = 0.5Ca-X2 + Na+ 
!c           b_equivalent_ex  = .false. -> use equivalent fraction for sorbed species
!c           (default)                  -> e.g., Ca+2 + 2Na-X = Ca-X2 + 2Na+ 
!c           
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      !real (type_r8), allocatable    :: csb(:)          !separated into ion-exchange and surface-complex, csb_ion and csb_surf
      real (type_r8), allocatable    :: csb_ion(:,:)
      real (type_r8), allocatable    :: csb_surf(:,:)      
      
      !real (type_r8), allocatable    :: chargesb(:)
      real (type_r8), allocatable    :: chargesb_ion(:)
      real (type_r8), allocatable    :: chargesb_surf(:)
      
      real (type_r8), allocatable    :: totan(:,:)
      real (type_r8), allocatable    :: totao(:)
      !real (type_r8), allocatable    :: totcsn(:)
      real (type_r8), allocatable    :: totcsn_ion(:,:)
      real (type_r8), allocatable    :: totcsn_surf(:,:)
      !real (type_r8), allocatable    :: totcso(:)
      real (type_r8), allocatable    :: totcso_ion(:)
      real (type_r8), allocatable    :: totcso_surf(:)
      !real (type_r8), allocatable    :: gfwsb(:)
      real (type_r8), allocatable    :: gfwsb_ion(:)
      real (type_r8), allocatable    :: gfwsb_surf(:)
      
      !real (type_r8), allocatable    :: eqsb(:)
      real (type_r8), allocatable    :: eqsb_ion(:,:)
      real (type_r8), allocatable    :: eqsb_surf(:,:)
      
      !real (type_r8), allocatable    :: eqsbs(:)
      real (type_r8), allocatable    :: eqsbs_ion(:)
      real (type_r8), allocatable    :: eqsbs_surf(:)
      
      !real (type_r8), allocatable    :: dhcsb(:)
      real (type_r8), allocatable    :: dhcsb_ion(:)
      real (type_r8), allocatable    :: dhcsb_surf(:)
      
      !real (type_r8), allocatable    :: xnusb(:)
      real (type_r8), allocatable    :: xnusb_ion(:)
      real (type_r8), allocatable    :: xnusb_surf(:)
      
      real (type_r8), allocatable    :: site_area(:)
      real (type_r8), allocatable    :: site_dens(:)
      real (type_r8), allocatable    :: site_mass(:)
      real (type_r8), allocatable    :: site_mass_tmp(:)
      real (type_r8), allocatable    :: site_mass_tot(:)
      real (type_r8), allocatable    :: site_mass_cvol(:,:)
      
      real (type_r8), allocatable    :: cec(:)
      real (type_r8), allocatable    :: cec_fraction(:)
      real (type_r8)                 :: rhobulk
      integer (type_i4), allocatable :: iaic(:)
      integer (type_i4), allocatable :: iais(:)
      
      !integer (type_i4), allocatable :: iasb(:)
      integer (type_i4), allocatable :: iasb_ion(:)
      integer (type_i4), allocatable :: iasb_surf(:)
      
      !integer (type_i4), allocatable :: jasb(:)
      integer (type_i4), allocatable :: jasb_ion(:)
      integer (type_i4), allocatable :: jasb_surf(:)
      
      !integer (type_i4), allocatable :: l_namesb(:)
      integer (type_i4), allocatable :: l_namesb_ion(:)
      integer (type_i4), allocatable :: l_namesb_nsites_ion(:)
      integer (type_i4), allocatable :: idx_nsites_ion(:)
      integer (type_i4), allocatable :: nss_onIsite_ion(:)
      integer (type_i4), allocatable :: idx_ss2isite_ion(:,:)
      integer (type_i4), allocatable :: l_namesb_surf(:)
      
      integer (type_i4), allocatable :: l_nameanc(:)

      !c index of 'sorbed species' to 'non-aqueous components'
      integer (type_i4), allocatable :: ion2isite(:)
      integer (type_i4), allocatable :: isurf2isite(:)

      integer (type_i4) :: nanc
      !integer (type_i4) :: nsb
      integer (type_i4) :: nsb_ion
      integer (type_i4) :: nsb_surf
      integer (type_i4) :: nsites
      integer (type_i4) :: nsites_ion = 1
      integer (type_i4) :: nlinear

      logical :: noncompetitive_sorption
      logical :: linear_sorption

      character*72, allocatable :: nameanc(:)
      !character*72, allocatable :: namesb(:)
      character*72, allocatable :: namesb_ion(:)
      character*72, allocatable :: namesb_sites_ion(:)      
      character*72, allocatable :: namesb_surf(:)
      
      character*12, allocatable :: isotherm_type(:)

      !character*12 :: output_unit_sb
      character*12 :: output_unit_sb_ion     !ion-exchange
      character*12 :: output_unit_sb_surf    !surface-complex
      character*72 :: sorption_group
      character*72 :: sorption_type
      character*72 :: sorption_type_ion
      character*72 :: sorption_type_surf
      !cprovi---------------------------------------
      !cprovi Use activities for to solve the action
      !cprovi mass law in cation-exchange
      !cprovi---------------------------------------
      logical      :: isactcexch
      !cprovi--------------------------------------- 
      
      logical      :: b_equivalent_ex = .false.
 
!c ----------------------------------------------------------------------
!c main variables - minerals:
!c --------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           areac(nm)          = reactivity term
!c           areainit(nm)       = initial reactivity term
!c           cmcnew(nm,nthreads)= concentration of minerals
!c                                - new time level [moles/l bulk]
!c           cmcold(nm,nthreads)= concentration of minerals 
!c                                - old time level [moles/l bulk]
!c           cmcmin(nm,nthreads)= min. concentration of minerals
!c                                [moles/l bulk]
!c           conc_mol_avg(nthreads)
!c                              = average molar concentration of
!c                                organic mixture
!c           densm(nm)          = densities of minerals
!c           dgcm(nm)           = activation energy for 
!c                                dissolution-precipitation 
!c                                reaction
!c           dhcm(nm)           = enthalpy change of dissolution-
!c                                precipitation reaction
!c           dhcmx(nmx)         = enthalpy change of dissolution-
!c                                precipitation reaction
!c                                (excluded minerals)
!c           diffm(ndr*nm,nthreads)
!c                              = free diffusion coefficient of
!c                                primary reactant in water
!c                                (transport controlled reactions)
!c           dwcm(nm)           = activation enthalpy for transport
!c                                controlled dissolution-precipitation
!c                                reaction
!c                                (by dwilson November 24, 2015)
!c           diffms(ndr*nm)     = free diffusion coefficient of
!c                                primary reactant in water at
!c                                standard temperature
!c                                (by dwilson November 24, 2015)
!c           eqm(nm,nthreads)   = equilibrium constants for minerals
!c           eqms(nm)           = equilibrium constants for minerals
!c                                at standard temperature
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded
!c                                minerals
!c           eqmxs(nmx)         = equilibrium constants for excluded
!c                                minerals at standard temperature
!c           expphi(nm)         = exponent for reactive surface area
!c                                update
!c           fmdm(nrc*nm)       = half saturation constants T^a
!c           fmdi(nrc*nm)       = inhibition factors T^a
!c           fmhc(nrc*nm)       = half saturation constants C^c
!c           fmic(nrc*nm)       = inhibition factors C^c
!c           fmdpm(nrc*nm)      = half saturation constants phi^m
!c           fmdpi(nrc*nm)      = inhibition factors phi^m
!c           gfwm(nm)           = gram formula weight of minerals        
!c           orddc(nrc*nm)      = order of dissolution-precipitation
!c                                reaction with respect to  
!c                                activities of components as species 
!c                                in solution
!c           orddcx(nrc*nm)     = order of dissolution-precipitation
!c                                reaction with respect to secondary 
!c                                aqueous species activities
!c           orddt(nrc*nm)      = order of dissolution-precipitation
!c                                reactions with respect to total 
!c                                aqueous component concentrations
!c
!c           orddm(nrc*nm)      = order of dissolution-precipitation
!c                                reactions with respect to concentration 
!c                                of minerals [moles/l bulk]
!c
!c           ordm(ndr*nm)       = exponent m for reaction rate law
!c           ordmdi(nrc*nm)     = order of inhibition terms for  
!c                                dissolution-precipitation reactions
!c                                T^a
!c           ordmdm(nrc*nm)     = order of hyperbolic terms for  
!c                                dissolution-precipitation reactions
!c                                T^a
!c           ordmic(nrc*nm)     = order of inhibition terms for  
!c                                dissolution-precipitation reactions
!c                                C^c
!c           ordmhc(nrc*nm)     = order of hyperbolic terms for  
!c                                dissolution-precipitation reactions
!c                                C^c
!c           ordmdpi(nrc*nm)    = order of inhibition terms for  
!c                                dissolution-precipitation reactions
!c                                phi^m
!c           ordmdpm(nrc*nm)    = order of hyperbolic terms for  
!c                                dissolution-precipitation reactions
!c                                phi^m
!c           ordn(ndr*nm)       = exponent n for reaction rate law
!c           phic(nm,nthreads)  = volume fractions of minerals            
!c           phicold(nm,nthreads)        
!c                              = volume fractions of minerals            
!c                                - old time level
!c           phinuc(nm)         = volume fractions of mineral for
!c                                nucleation threshold

!c           radi(nm)           = initial radius of mineral particle
!c           rads(nm,nthreads)  = radius of unreacted core of mineral
!c                                particle
!c           phimin(nm)         = volume fractions of minerals for
!c                                nucleation
!c           phimin_out(nm)     = cutoff mineral volume fractions
!c                                for output
!c           phiinit(nm,nthreads)       
!c                              = initial volume fractions of 
!c                                minerals
!c           phi_out(nm)        = mineral volume fractions for output
!c           radmin(nm)         = representative particle radius of 
!c                                nucleus
!c           satm(nm,nthreads)  = IAP/K for minerals
!c           satm_log(nm)       = saturation indices for minerals
!c           satmx(nmx)         = saturation indices for excluded 
!c                                minerals
!c           supsatm(nm)        = level of supersaturation required 
!c                                for precipitation [log cycles]
!c           scalfac(nm)        = scaling factor (reactivity term) 
!c           sfac_sdmin(nm,nfac)= scale factor coeffients of minerals  
!c                                  depending on salinity             
!c           rated(ndr*nm,nthreads)
!c                              = rate constants for dissolution 
!c                                reactions  
!c           rateds(ndr*nm)     = rate constants for dissolution-
!c                                precipitation reactions at
!c                                standard temperature
!c           ratemp(ndr*nm,nthreads)  
!c                              = reaction rates for minerals
!c                                including parallel reactions
!c           totratem(nm,nthreads)
!c                              = total mineral dissolution-
!c                                precipitation rates
!c           xnud(ndr*nm)       = stoichiometric coefficients of 
!c                                reacting species in transport
!c                                controlled dissolution reaction
!c           xnum(nm*nc)        = stoichiometric coefficients of 
!c                                components in mineral
!c           xnumx(nmx*nc)      = stoichiometric coefficients of 
!c                                components in excluded mineral
!c           scalfac_min(nm)    = scaling factor for mineral reactivity.
!c                                This is a global variable that all the mineral 
!c                                reactivities are scaled by this factor,
!c                                regardless of reaction rate update type.
!c
!c           integer*4:
!c           ----------
!c           iam(nm+1)          = row pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in mineral
!c           iamx(nmx+1)        = row pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in excluded mineral
!c           iamd(nm+1)         = pointer array to dissolution-
!c                                precipitation reactions
!c           iamdc(ndr*nm+1)    = pointer array to components as
!c                                species in solution involved in 
!c                                dissolution-precipitation reactions
!c           iamdcx(ndr*nm+1)   = pointer array to secondary aqueous
!c                                species involved in dissolution- 
!c                                precipitation reactions
!c           iamdi(ndr*nm+1)    = row pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms T^a)
!c           iamdm(ndr*nm+1)    = row pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms T^a)
!c           iamic(ndr*nm+1)    = row pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms C^c)
!c           iamhc(ndr*nm+1)    = row pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms C^c)
!c           iamdpi(ndr*nm+1)   = row pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms phi^m)
!c           iamdpm(ndr*nm+1)   = row pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms phi^m)
!c           iamdt(ndr*nm+1)    = pointer array to total aqueous
!c                                component concentrations involved 
!c                                in dissolution-precipitation
!c                                reactions
!c           iamp(nm+1)         = pointer array for distribution
!c                                and combination of mineralogical
!c                                parameters
!c           jam(nm*nc)         = column pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in mineral
!c           jamd(nrc*nm)       = pointer array to parallel reactions + -
!c                                involved in dissolution reactions
!c           jamx(nmx*nc)       = column pointer array to 
!c                                stoichiometric coefficients of 
!c                                components in excluded mineral
!c           jamdc(nrc*nm)      = pointer array to components as 
!c                                species in solution involved in 
!c                                dissolution-precipitation reactions
!c           jamdcx(nrc*nm)     = pointer array to secondary aqueous
!c                                species involved in dissolution- 
!c                                precipitation reactions
!c           jamdi(nrc*nm)      = column pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms T^a)
!c           jamdm(nrc*nm)      = column pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms T^a)
!c           jamic(nrc*nm)      = column pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms C^c)
!c           jamhc(nrc*nm)      = column pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms C^c)
!c           jamdpi(nrc*nm)     = column pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (inhibition terms phi^m)
!c           jamdpm(nrc*nm)     = column pointer array to reactants
!c                                in dissolution-precipitation
!c                                reactions (hyperbolic terms phi^m)
!c           jamdt(nrc*nm)      = pointer array to total aqueous
!c                                component concentrations involved 
!c                                in dissolution-precipitation
!c                                reactions
!c           jamp(nm)           = pointer array for distribution
!c                                and combination of mineralogical
!c                                parameters
!c           l_namem(nm)        = length of mineral names
!c           l_namemp(ndr*nm)   = length of names of parallel
!c                                dissolution-precipitation reactions
!c           l_namemx(nmx)      = length of names of excluded
!c                                minerals
!c           nfac(nm)           = number of coefficients of the 
!c                                  salinity dependent reaction
!c           min_salinity(nm)   = minimum value of valid salinity 
!c                                 for salinity dependent reactions
!c           min_sar(nm)        = minimum value of valid SAR
!c                                 for salinity dependent reactions
!c           max_salinity(nm)   = maximum value of valid salinity 
!c                                 for salinity dependent reactions
!c           max_sar(nm)        = maximum value of valid SAR
!c                                 for salinity dependent reactions
!c           inamec_inhib(nm)   = The number of the component having
!c                                  strong inhibition effect.
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium 
!crevaff
!c           reverse_affinity_term(nm) = .true. -> reverse affinity    
!c                                                 term if IAP/K > 1   
!c           salinity_dependent(nm) = .true. -> salinity dependent 
!c                                              mineral reaction
!crevaff
!c
!c           character:
!c           ----------
!c           namem(nm)          = mineral names
!c           namemp(ndr*nm)     = names for parallel 
!c                                dissolution-precipitation reactions
!c           namemx(nmx)        = names of excluded minerals
!c           rate_control(nm)   = rate controlling process for
!c                                dissolution-precipitation reaction
!c                                'surface'   = surface controlled 
!c                                              reaction
!c                                'transport' = transport controlled 
!c                                              reaction
!c                                'mixed'     = mixed control
!c           reaction_type(nm)  = reaction type of dissolution-
!c                                precipitation reaction
!c           update_type(im)    = type of surface area update
!c                                'constant'  = constant reactive
!c                                              surface area
!c                                'geometric' = geometric reactive
!c                                              surface area update
!c                                'twothird'  = two-third power 
!c                                              expression
!c           sung-wook's (Dec. 8/2003)
!c                                'reactivity'    = declining reactive surface area
!c                                                  due to mineral precipitation
!c
!c                                'exponent'  = user-specified power
!c                                'exponent'  = user-specified power
!c                                              expression
!c          sdtype(nm)          = type of relation, two options
!c                                  'equation' sar=sum(f_i*salinity**(i-1)), 
!c                                      i=1,2,...,nfact)
!c                                   'points' experimental data  
!c                                      salinity, sar, linear interpolation
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: areac(:)
      real (type_r8), allocatable :: areainit(:)
      real (type_r8), allocatable :: cmcold(:,:)
      real (type_r8), allocatable :: cmcnew(:,:)
      real (type_r8), allocatable :: cmcmin(:,:)
      real (type_r8), allocatable :: dgcm(:)
      real (type_r8), allocatable :: dhcm(:)
      real (type_r8), allocatable :: dhcmx(:)
      real (type_r8), allocatable :: dwcm(:)
      real (type_r8), allocatable :: dscm(:)
      real (type_r8), allocatable :: expphi(:)
      real (type_r8), allocatable :: phic(:,:)
      real (type_r8), allocatable :: phicold(:,:)
      real (type_r8), allocatable :: phinuc(:) 
      real (type_r8), allocatable :: fmdi(:)
      real (type_r8), allocatable :: fmdm(:)
      real (type_r8), allocatable :: fmdsta(:)        !isotope
      real (type_r8), allocatable :: fmic(:)
      real (type_r8), allocatable :: fmhc(:)
      real (type_r8), allocatable :: fmdpi(:)
      real (type_r8), allocatable :: fmdpm(:)
      real (type_r8), allocatable :: rads(:,:)
      real (type_r8), allocatable :: radi(:)
      real (type_r8), allocatable :: phimin(:)
      real (type_r8), allocatable :: phimin_out(:)
      real (type_r8), allocatable :: phiinit(:,:)
      real (type_r8), allocatable :: phi_out(:)
      real (type_r8), allocatable :: radmin(:)
      real (type_r8), allocatable :: supsatm(:)
      real (type_r8), allocatable :: scalfac(:)
      real (type_r8), allocatable :: sfac_sdmin(:,:)
      logical, allocatable :: salinity_dependent(:)
      real (type_r8), allocatable :: min_salinity(:)
      real (type_r8), allocatable :: min_sar(:)
      real (type_r8), allocatable :: max_salinity(:)
      real (type_r8), allocatable :: max_sar(:)
      integer (type_i4), allocatable :: inamec_inhib(:)
      real (type_r8), allocatable :: gfwm(:)
      real (type_r8), allocatable :: diffm(:,:)
      real (type_r8), allocatable :: diffms(:)
      real (type_r8), allocatable :: densm(:)
      real (type_r8), allocatable :: eqm(:,:)
      real (type_r8), allocatable :: eqmx(:,:)
      real (type_r8), allocatable :: eqms(:)
      real (type_r8), allocatable :: eqmxs(:)
      real (type_r8), allocatable :: rated(:,:)
      real (type_r8), allocatable :: rateds(:)

      !c scaling factor for mineral reactivity
      real (type_r8), allocatable :: scalfac_min(:)
      
      !c flag of reaction rate correction over saturation change
      logical, allocatable :: satcorr_flag(:)
      
      !c_bubbles
      real (type_r8), allocatable :: dg_lim(:)
      real (type_r8), allocatable :: dg_limaq(:)
      logical, allocatable :: pressure_approximation(:)
      real (type_r8), allocatable :: ratemp(:,:)
      real (type_r8), allocatable :: orddc(:)
      real (type_r8), allocatable :: orddcx(:)

      logical :: compatible_bubble_dbs

      !c noble gas ingrowth
      integer (type_i4), allocatable :: iamdcm(:)
      integer (type_i4), allocatable :: jamdcm(:)
      real (type_r8), allocatable :: orddm(:)
      real (type_r8), allocatable :: ordmdcm(:)


      !c_uranium
      real (type_r8), allocatable :: orddscx(:)
      real (type_r8), allocatable :: orddsumx(:)

      !c_isotopes
      real (type_r8), allocatable :: orddsta(:)
      real (type_r8), allocatable :: jamdalpha(:)
      real (type_r8), allocatable :: isodelta(:)
      
      real (type_r8), allocatable :: orddt(:)
      real (type_r8), allocatable :: ordm(:)
      real (type_r8), allocatable :: ordmdi(:)
      real (type_r8), allocatable :: ordmdm(:)
      real (type_r8), allocatable :: ordmic(:)
      real (type_r8), allocatable :: ordmhc(:)
      real (type_r8), allocatable :: ordmdpi(:)
      real (type_r8), allocatable :: ordmdpm(:)
      real (type_r8), allocatable :: ordmdphm(:)
      real (type_r8), allocatable :: ordn(:)
      real (type_r8), allocatable :: totratem(:,:)
      real (type_r8), allocatable :: xnud(:)
      real (type_r8), allocatable :: xnum(:)
      real (type_r8), allocatable :: xnumx(:)
      real (type_r8), allocatable :: satm(:,:)
      real (type_r8), allocatable :: satm_log(:)
      real (type_r8), allocatable :: satmx(:)

      real (type_r8), allocatable :: conc_mol_avg(:)
      logical, allocatable ::sur_prec(:)
      real (type_r8), allocatable ::alph_prec(:)
      

      integer (type_i4), allocatable :: iam(:)
      integer (type_i4), allocatable :: iamx(:)
      integer (type_i4), allocatable :: iamd(:)
      integer (type_i4), allocatable :: iamdc(:)
      integer (type_i4), allocatable :: iamdcx(:)
!c_uranium
      integer (type_i4), allocatable :: iamdscx(:)
!c_isotope
      integer (type_i4), allocatable :: iamdsta(:)
      integer (type_i4), allocatable :: iamdsta2(:)
      integer (type_i4), allocatable :: ntsc(:)
      integer (type_i4), allocatable :: iamdiso(:)
      integer (type_i4), allocatable :: iamdiso2(:)
      integer (type_i4), allocatable :: iamdisoo(:)
      integer (type_i4), allocatable :: nifrm(:)
        
      integer (type_i4), allocatable :: iamdi(:)
      integer (type_i4), allocatable :: iamdm(:)
      integer (type_i4), allocatable :: iamic(:)
      integer (type_i4), allocatable :: iamhc(:)
      integer (type_i4), allocatable :: iamdpi(:)
      integer (type_i4), allocatable :: iamdpm(:)
      integer (type_i4), allocatable :: iamdphm(:)
      integer (type_i4), allocatable :: iamdt(:)
      integer (type_i4), allocatable :: iamp(:)
      integer (type_i4), allocatable :: jam(:)
      integer (type_i4), allocatable :: jamd(:)
      integer (type_i4), allocatable :: jamx(:)
      integer (type_i4), allocatable :: jamdc(:)
      integer (type_i4), allocatable :: jamdcx(:)
      
!c_uranium
      integer (type_i4), allocatable :: jamdscx(:)
!c_isotope
      integer (type_i4), allocatable :: jamdsta(:)
      integer (type_i4), allocatable :: jamdiso(:)
      integer (type_i4), allocatable :: jamdiso2(:)
         integer (type_i4), allocatable :: jamdisoo(:)
      integer (type_i4), allocatable :: jamdpair(:)
      
      integer (type_i4), allocatable :: jamdi(:)
      integer (type_i4), allocatable :: jamdm(:)
      integer (type_i4), allocatable :: jamic(:)
      integer (type_i4), allocatable :: jamhc(:)
      integer (type_i4), allocatable :: jamdpi(:)
      integer (type_i4), allocatable :: jamdpm(:)
      integer (type_i4), allocatable :: jamdphm(:)
      integer (type_i4), allocatable :: jamdt(:)
      integer (type_i4), allocatable :: jamp(:)
      integer (type_i4), allocatable :: l_namem(:)
      integer (type_i4), allocatable :: l_namemp(:)
      integer (type_i4), allocatable :: l_namemx(:)
      integer (type_i4), allocatable :: nfac(:)

      logical, allocatable :: far_from_equil(:)
!crevaff
      logical, allocatable :: reverse_affinity_term(:)  
!crevaff

!c_isotopes
      logical, allocatable :: isofrac(:)
      logical, allocatable :: isofracm(:)
      logical :: iso_output

      character*72, allocatable :: namem(:)
      character*72, allocatable :: namemx(:)
      character*12, allocatable :: rate_control(:)
      character*12, allocatable :: update_type(:)
      character*72, allocatable :: namemp(:)
      character*72, allocatable :: reaction_type(:)
      character*72, allocatable :: sdtype(:)

!c ----------------------------------------------------------------------
!c temperature correction:
!c -----------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           dt_tmp             = time increment in temperature data
!c                                file
!c           tmp(ntmp)          = specified depth dependent 
!c                                temperatures [K]
!c           tmp_read           = time to read next temperature 
!c           ztmp(ntmp)         = depths of specified temperatures
!c
!c
!c           integer*4:
!c           ----------
!c           ntmp               = number of temperature points
!c  
!c           logical:
!c           --------
!c           update_temp        = .true.  -> update time-dependent
!c                                           temperature field
!c
!c ----------------------------------------------------------------------

      real (type_r8), allocatable :: tmp(:)
      real (type_r8), allocatable :: ztmp(:)

      real (type_r8) :: dt_tmp
      real (type_r8) :: tmp_read

      integer (type_i4) :: ntmp

      logical :: update_temp

!c ----------------------------------------------------------------------
!c newton iteration: 
!c -----------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           cinc(nc,nthreads)  = incremented concentrations of
!c                                components as species in solution
!c                                [moles/l h2o]
!c           ginc(ng,nthreads)  = gas concentrations dependent on 
!c                                incremented concentrations of
!c                                components as species in solution
!c                                [moles/l air]
!c           cxinc(nx,nthreads) = secondary aqueous species 
!c                                concentrations dependent on 
!c                                incremented concentrations of
!c                                components as species in solution
!c                                [moles/l h2o]
!c           ratedp(nm,nthreads)= absolute dissolution-precipitation
!c                                rates of minerals
!c                                [moles/(l bulk*day)]
!c           dcsb(nsb)          = derivatives of concentrations of
!c                                sorbed species with respect to
!c                                primary species
!c           dcsb_ion(nsb_ion,nthreads)  
!c                              = derivatives of concentrations of
!c                                sorbed species of ion-exchange with respect to
!c                                primary species
!c           dcsb_surf(nsb_surf,nthreads)  
!c                              = derivatives of concentrations of
!c                                sorbed species of surface complex with respect to
!c                                primary species
!c           dratedp(nm,nthreads)        
!c                              = derivatives of absolute 
!c                                dissolution-precipitation
!c                                rates of minerals
!c                                [moles/(l bulk*day)]
!c           dtota(n)           = derivatives of total sorbed
!c                                component concentrations
!c                                (non-competitive sorption)
!c                                [moles/l bulk]
!c           dtotc(n,nthreads)  = derivatives of total aqueous
!c                                component concentrations
!c                                [moles/l h2o]
!c           dtotcf(n,nthreads) = derivatives of total aqueous
!c                                component concentrations
!c                                times porosity correstion 
!c                                factors for hMCD model [moles/l h2o]
!c           dtotdp(n,nthreads) = derivatives of total source/sink 
!c                                term towards total aqueous 
!c                                component concentrations due to 
!c                                mineral dissolution-precipitation 
!c                                reactions
!c                                [moles/(l bulk*day)]
!c           dtotg(n)           = derivatives of total gaseous
!c                                component concentrations
!c                                [moles/l air]
!c           dtotsb(n)          = derivatives of total source/sink 
!c                                term towards total aqueous 
!c                                component concentrations due to 
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c           dtotsb_ion(n,nthreads)      
!c                              = derivatives of total source/sink 
!c                                term towards total aqueous 
!c                                component concentrations due to 
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c                                (ion-exchange)
!c           dtotsb_surf(n,nthreads)     
!c                              = derivatives of total source/sink 
!c                                term towards total aqueous 
!c                                component concentrations due to 
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c                                (surface-complex)
!c           totcinc(n,nthreads)= total aqueous component 
!c                                concentrations
!c                                - new time level - incremented
!c                                [moles/l h2o]
!c           totdp(n,nthreads)  = total source/sink term towards
!c                                total aqueous component 
!c                                concentrations due to mineral 
!c                                dissolution-precipitation 
!c                                reactions [moles/(l bulk*day)]
!c           totsb(n)           = total source/sink term towards
!c                                total aqueous component 
!c                                concentrations due to sorption
!c                                reactions [moles/(l bulk*day)]
!c           totsb_ion(n)       = total source/sink term towards
!c                                total aqueous component 
!c                                concentrations due to sorption
!c                                reactions of ion-exchange
!c                                [moles/(l bulk*day)]
!c           totsb_surf(n)      = total source/sink term towards
!c                                total aqueous component 
!c                                concentrations due to sorption
!c                                reactions of surface-complex 
!c                                [moles/(l bulk*day)]
!c        -->                                                         <--
!c ----------------------------------------------------------------------
 
      real (type_r8), allocatable :: cinc(:,:)
      real (type_r8), allocatable :: cxinc(:,:)
      !real (type_r8), allocatable :: dcsb(:)
      real (type_r8), allocatable :: dcsb_ion(:,:)
      real (type_r8), allocatable :: dcsb_surf(:,:)
      real (type_r8), allocatable :: ginc(:,:)
      real (type_r8), allocatable :: dtotc(:,:)
      real (type_r8), allocatable :: dtotcf(:,:)
      real (type_r8), allocatable :: dtotg(:,:)
      !real (type_r8), allocatable :: dtotsb(:)
      real (type_r8), allocatable :: dtotsb_ion(:,:)
      real (type_r8), allocatable :: dtotsb_surf(:,:)
      real (type_r8), allocatable :: ratedp(:,:)
      real (type_r8), allocatable :: dratedp(:,:)
      real (type_r8), allocatable :: totdp(:,:)
      real (type_r8), allocatable :: dtotdp(:,:)
      !real (type_r8), allocatable :: totsb(:)
      real (type_r8), allocatable :: totsb_ion(:)
      real (type_r8), allocatable :: totsb_surf(:)
      real (type_r8), allocatable :: totcinc(:,:)
      real (type_r8), allocatable :: dtota(:)

!c ----------------------------------------------------------------------
!c work arrays (local chemistry):
!c ----------------------------
!c        -->                                                         <--
!c           real*8:
!c           -------
!c           alc(n,n,nthreads)  = Jacobian matrix
!c           blc(n,nthreads)    = rhs-vector
!c           conct(:)           = species concentrations (temporary)
!c           gammat(:)          = species activities (temporary)
!c           conc_corr_min      = minimum component concentration allowed
!c                                in the system to avoid numerical instability.
!c                                Important: It can make a difference, esp. in the context of redox chemistry.
!c                                Redox couples are related to each other via an equilibrium constant. 
!c                                C1/C2 = K, or C1 = K x C2, if a concentration of a redox couple is changes, 
!c                                it might cause problems. Less an issue for all other reactions.
!c                                DSU, 2020-12-17
!c           conc_corr_max      = maximum component concentration allowed
!c                                in the system to avoid non-physical value.
!c
!c           character:
!c           ----------
!c           namet(:)           = species names (temporary)
!c           integer ::
!c           ----------
!c           n_isotope_pairs    = number of isotope pairs
!c           isotope_pairs(nc,nc)
!c                              = index of component, the first dim is
!c                                the index for the master component
!c                                and the second dim is the index for
!c                                the other components
!c        -->                                                         <--
!c ----------------------------------------------------------------------

      real (type_r8), allocatable :: alc(:,:,:)
      real (type_r8), allocatable :: blc(:,:)
      real (type_r8), allocatable :: xlc(:,:)
      real (type_r8) :: conct(500)
      real (type_r8) :: gammat(500)
      real (type_r8) :: urtlim_conc_min
      real (type_r8) :: urtlim_conc_max
      real (type_r8) :: conc_corr_min
      real (type_r8) :: conc_corr_max

      character*72 :: namet(500)
      character*72 :: namet2(10,10)     !isotopes
      
      integer :: n_isotope_pairs      
      integer, allocatable :: isotope_pairs(:,:) 
      
!cprovi-----------------------------------------------------------------
!cprovi   It was added by Sergio Andrï¿½s Bea Jofr?
!cprovi      18/01/2009 
!cprovi------------------------------------------------------------------
!cprovi ----------------------------------------------------------------------
!cprovi Pitzer model variables 
!cprovi ----------------------------
!cprovi        -->                                                         <--
!cprovi           type phase 
!cprovi           ----------
!cprovi           phase              = Aqueous Phase object 
!cprovi
!cprovi           logical:
!cprovi           ----------
!cprovi           ispitzer           = if true, then activity coefficients 
!cprovi                                are computed according HMW model 
!cprovi                                based on Pitzer equations 
!cprovi           ismacinnes         = if true, then activity coeffients are
!cprovi                                scaled accoring to MacInnes convention 
!cprovi        -->                                                         <--
!cprovi ----------------------------------------------------------------------
      logical                 :: ispitzer    ! if true, then pitzer equstions are used
      logical                 :: ismacinnes  ! if true, then activity coefficients are scaled according MacInnes convention
      type (t_phase), pointer :: phase       ! Aqueous phase object 
!cprovi ----------------------------------------------------------------------

!cprovi ----------------------------------------------------------------------
!cmx 2018    SIT model variables 
!cprovi ----------------------------
!cprovi        -->                                                         <--
!c                real*8:
!c                -------
!c                asit               = coefficient for SIT model
!c                basit              = coefficient for SIT model
!c                                       based on Grethe et al. (2004)
!c                                       Appendix B, eqn B.1, B.2
!c                coepsil((nc+nx)*(nc+nx))
!c                                   =  array for coefficient epsilon      * +
!c                                      of SIT model
!c                character*72:
!c                -------
!c                namecx(500)         = name of primary plus secondary     * +
!c                                      species for SIT model
!c
!c                integer:
!c                -------
!c                iasit(nc+nx+1)     = row pointer array for SIT model   
!c                jasit((nc+nx)*(nc+nx))
!c                                   = colume pointer array for SIT model
!cprovi
!cprovi           logical:
!cprovi           ----------
!cprovi           issit           = if true, then activity coefficients 
!cprovi                                are computed according SIT model 
!cprovi                                based on the specific ion interaction 
!cprovi                                theory in the form of the 
!cprovi                                Brï¿½nsted-Guggenheim-Scatchard approach. 
!cprovi        -->                                                         <--
!cprovi ----------------------------------------------------------------------
      logical                       :: issit    
      real (type_r8)                :: asit
      real (type_r8)                :: basit
      integer, allocatable          :: iasit(:) 
      integer, allocatable          :: jasit(:) 
      real (type_r8), allocatable   :: coepsil(:)
      character*72                  :: namecx(500)
      
!c ----------------------------------------------------------------------
!c rate law control parameter: 
!c -----------------
!c        -->                                                         <--
!c           logical:
!c           -------
!c           b_ratelaw_exponent_n = if true, exponent n is considered for reaction rate law
      logical                 :: b_ratelaw_exponent_n = .false.  
      
!c  offset for writing transient data (*.lb*), this is only for binary output 
      integer*8 :: offset_ilbt
      integer*8 :: offset_ilbc
      integer*8 :: offset_ilbm
      integer*8 :: offset_ilbgr
      integer*8 :: offset_ilbg
      integer*8 :: offset_ilbi
      integer*8 :: offset_ilbb
      integer*8 :: offset_ilbs
      integer*8 :: offset_ilbv
      integer*8 :: offset_ilbd
      integer*8 :: offset_ilbx
      integer*8 :: offset_ilbis
      integer*8 :: offset_ilbac
      integer*8 :: offset_ilbre
      
      integer*8 :: offset_ilbt_ijk
      integer*8 :: offset_ilbc_ijk
      integer*8 :: offset_ilbm_ijk
      integer*8 :: offset_ilbgr_ijk
      integer*8 :: offset_ilbg_ijk
      integer*8 :: offset_ilbi_ijk
      integer*8 :: offset_ilbb_ijk
      integer*8 :: offset_ilbs_ijk
      integer*8 :: offset_ilbv_ijk
      integer*8 :: offset_ilbd_ijk
      integer*8 :: offset_ilbx_ijk
      integer*8 :: offset_ilbis_ijk
      integer*8 :: offset_ilbac_ijk
      integer*8 :: offset_ilbre_ijk
      
      end module chem
