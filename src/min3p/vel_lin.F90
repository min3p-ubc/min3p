!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/vel_lin.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine vel_lin
!c -------------------
!c
!c compute influence coefficients for advective and dispersive flux 
!c terms for rectangular, cartesian finite volume discretization 
!c (reactive transport) for aqueous phase
!c
!c written by:      Pejman Rasouli - 2012
!c
!c last modified:   Mingliang Xie - January 22, 2013
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                   I O
!c    input:
!c
!c passed:   real*8:
!c          -------
!c          d(3, ibk)          = dimension of cells in x,y,z         + -
!c                               direction
!c          diffu              = phase molecular diffusion (m2/day)
!c          disx(nzn)          = dispersion, x direction (m)
!c          disy(nzn)          =    "      , y    "      (m)
!c          disz(nzn)          =    "      , z    "      (m)
!c          cinfrt_va()        = influence coefficients 
!c                               J^w_ij/A_ij
!c                               (advective flux terms)
!c          cinfrt_da()        = influence coefficients
!c                               D_ij * A_ij / d_ij  
!c                               (dispersvie flux terms)
!c
!c          integer*4:
!c          ----------
!c          ibk                = block i
!c          id                 = connected block j
!c          idbg               = output for debugging information
!c          ilog               = unit number, logbook
!c          nmax               = max cells for dim purposes
!c          nphas              = max number of phases
!c          njamxc            = max dim ja array (ncomp.com)
!c          nvx                = number of control volumes 
!c                               in x direction
!c          nvy                = number of control volumes 
!c                               in y direction
!c          nvz                = number of control volumes 
!c                               in z direction
!c          pornew(ibk)        = porosity
!c          sanew(nmax)        = aqueous phase saturation
!c                               - new time level
!c          hhead(nmax)        = hydraulic head
!c          uvsnew(nmax)       = hydraulic head
!c          relperm(nmax)      = rel permeability
!c          cinfvs(nmax)       = influence coefficient 
!c                               (variably saturated flow) 
!c          ia(), ja()         = ysmp pointers
!c          isymm(ii)          = symmetry pointer for cell ibk
!c
!c          logical:
!c          --------
!c          fully_saturated    = .true.  -> saturated conditions
!c          variably_saturated = .true.  -> .not.fully_saturated,
!c                                       -> variably saturated
!c                                          conditions
!c          half_cells         = .true.  -> half cells on boundary
!c          tortuosity_corr    = .true.  -> Millington-Quirk 
!c                                          tortuosity correction
!c                                          for diffusion
!c                                          coefficients
!c
!c local:
!c
!c external: diffcoff  = compute effective diffusion coefficient
!c          fluxfs    = flux function for fully saturated flow 
!c          fluxvs    = flux function for variably saturated flow
!c --------------------------------------------------------------------------

      subroutine vel_lin1 (nvx, nvy, nvz, ia, ja, isymm,        &
     &                    cinfvs,cinfrt_da,d,                 &
     &                    mprop, nzn, diffu, disx, disy, disz,         &
     &                    pornew, sanew, uvsnew, hhead, relperm,     & 
     &                    idbg, ilog, upstream, fully_saturated,    & 
     &                    variably_saturated, njamxc, nmax,        &
     &                    tortuosity_corr,half_cells,cinfrt_da_ic,    &
     &                    diff_coff, nc,diff_ic,multi_diff,assigned_tau,&
     &                    tau,type_tortuosity,marchies,            &
     &                    cinfrad,radial_coord)
      
      use gen, only : rank, b_enable_output, b_use_fixed_flow_vel,fixed_flow_vel
      use mod_diffcoff, only : diffcoff
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none

      integer nvx, nvy, nvz, ia(nmax+1), ja(njamxc),             &
     &        isymm(njamxc), idbg, ilog, nzn, mprop(*), nc,     &
     &        njamxc, nmax 

      logical half_cells, fully_saturated, variably_saturated,        &
     &        upstream, tortuosity_corr,diff_coff,assigned_tau,        &
     &        multi_diff, radial_coord

      real*8  diffu, disx(nzn), disy(nzn), disz(nzn),            &
     &        pornew(nmax), uvsnew(nmax), hhead(nmax),             &
     &        relperm(nmax),sanew(nmax), d(3,nmax),             &
     &        cinfvs(njamxc),                         &
     &        cinfrt_da(njamxc),                    &
     &        cinfrt_da_ic(nc,njamxc),diff_ic(nc),            &
     &        tau(nmax),marchies(nmax)

      real*8, external :: fluxfs,fluxvs
      
      character(len=*) type_tortuosity

!c    local variables

      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0,  & 
     &           r1 = 1.0d0, r2 = 2.0d0

      real*8 aread(3,12), areax(3,12), vel(3),              &
     &       porav, satav, vx2, vy2, vz2, vmag,             &
     &       tend(3), areai,                        &
     &       diffav, diff_eff,disx_avg, disy_avg,            &
     &       disz_avg, dflux,tauav,                    &
     &       cinfrad(njamxc) 

      integer ibk, ivz, ivy, ivx, ibkz, ibky,                 &
     &        ii, id, ixx, iyy, izz, iisav,                 &
     &        idim, npair(3), iface(3,12), ndim,            &
     &        fvpair(3,12,2), ipair, idim2, idim3, irk_ibk, irk_id

      character*1 iups
      
      real*8 dist(3,12)

      dflux = r0

!c compute influence coefficients for advective flux terms
!c (influence coefficients are equal Darcy flux = J_ij/A_ij)



!c compute the influence coefficients for dispersive flux terms
!c loop over the number of "pseudo dispersion elements"

!c zero the influence coefficient for dispersive flux term

      do ibk = 1, nmax
        do ii = ia(ibk),ia(ibk+1)-1
          cinfrt_da(ii) = r0
        end do
      end do

!c loop over control volumes

      do 400 ivz = 1, nvz          !increments in z-direction
         do 400 ivy = 1, nvy       !increments in y-direction
            do 400 ivx = 1, nvx    !increments in x-direction

!c find node pairs for elemental velocities as well
!c as influence coefficient for node pairs within dipersion element

!               call cliqdisp (nx, ny, nz, ix, iy, iz,
!     &                        fvpair, npair, aread, d, half_cells,
!     &                        nmax,idbg,dd)

              call cliqdisp (nvx, nvy, nvz, ivx, ivy, ivz,             &
     &                     fvpair, npair,aread,areax,dist,d,           &
     &                     half_cells, ia, ja, njamxc,                 &
     &                     nmax,idbg,cinfrad,radial_coord)
               
!c check if fully connected "pseudo dispersion element"
!c was found for dimensionality of problem

               if ((nvx .gt. 1 .and. npair(1) .eq. 0) .or.            &
     &             (nvy .gt. 1 .and. npair(2) .eq. 0) .or.            &
     &             (nvz .gt. 1 .and. npair(3) .eq. 0)) goto 400

!c             loop over the dimensions x,y,z

                do idim = 1, 3

                  idim2 = idim + 1
                  idim3 = idim + 2
                  if (idim2 .gt. 3) idim2 = idim2 - 3
                  if (idim3 .gt. 3) idim3 = idim3 - 3

!c zero advective velocity

                  vel(idim) = r0

!c loop over the number of node pairs in the dimension

                  do ipair = 1, npair(idim)

                    ibk = fvpair(idim, ipair, 1)
                    id = fvpair(idim, ipair, 2)

                    do ii = ia(ibk), ia(ibk+1)-1
                       if (ja(ii) .eq. id) then
                          iisav = ii
                          go to 431
                       endif
                    end do
                    if (rank == 0) then
                      write(ilog,*) ' error-cannot find id in list-vel_lin'
                      write(ilog,*) ' ibk, id ', ibk, id
                      close(ilog)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop

431                 continue

                    iface(idim, ipair) = iisav

                    if (.not. b_use_fixed_flow_vel) then

!c calculate average interfacial area between nodes

                      areai = areax(idim, ipair)

!c find darcy flux between node pair

                      if (variably_saturated) then
                        if (upstream) then
                          iups = 'i'                            !h_i >= h_j
                          if (hhead(id).gt.hhead(ibk)) then     !h_j > h_i
                            iups = 'j'
                          end if
                        end if

                        dflux = - fluxvs(upstream,hhead(ibk),          &
     &                                   hhead(id),relperm(ibk),       &
     &                                   relperm(id),iups,             &
     &                                   cinfvs(iisav))
  
                      elseif (fully_saturated) then 

                        dflux = - fluxfs(uvsnew(ibk),uvsnew(id),       &
     &                                     cinfvs(iisav))
                      end if


!c velocity is the flux (m^3/day) divided
!c by the interfacial area between the two nodes

                      vel(idim) = vel(idim) + dflux / areai
                    end if
                  end do

!c find the average elemental velocity in the
!c x,y,z directions
                  if (.not. b_use_fixed_flow_vel) then
                    vel(idim) = vel(idim)/(float( npair(idim) ) + eps)
                  end if
                end do

                if (b_use_fixed_flow_vel) then
                  vel(1) = fixed_flow_vel%x
                  vel(2) = fixed_flow_vel%y
                  vel(3) = fixed_flow_vel%z
                end if


                 tend(1) = vel(1)

                 tend(2) = vel(2)

                 tend(3) = vel(3)

!c build total influence coefficient from all elemental contributions

               do idim = 1, 3                   !loop over dimensions
 
!c adjust for 1d-, 2d, 3d - discretization


                    do ipair = 1, npair(idim)             !node pairs
  
                       iisav = iface(idim, ipair)

                       cinfrt_da(iisav) = cinfrt_da(iisav)            &
     &                                  + tend(idim)

                       cinfrt_da(isymm(iisav)) = cinfrt_da(isymm(iisav))    &
     &                                         + tend(idim)

                    end do                                !node pairs
               end do                           !loop over dimensions
               
               
400   continue

!cdbg
!c     do ibk = 1,nmax
!c       do ii = ia(ibk),ia(ibk+1)-1
!c         write(idbg,*) 'cinfrt_va(',ii,') = ',cinfrt_va(ii)
!c       end do
!c     end do
!c     do ibk = 1,nmax
!c       do ii = ia(ibk),ia(ibk+1)-1
!c         write(idbg,*) 'cinfrt_va(',ii,') = ',cinfrt_va(ii)
!c         write(idbg,*) 'cinfrt_da(',ii,') = ',cinfrt_da(ii)
!c       end do
!c     end do

!cdbg

      return
      end

