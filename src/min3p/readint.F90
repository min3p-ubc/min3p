!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readint.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readint
!c ------------------
!c
!c read database for intra-aqueous kinetic reactions and assign to 
!c permanent storage
!c
!c written by:      Uli Mayer - April 22, 99
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           irdbs              = unit number, database for redox     + -
!c                                             couples
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number, debugging file         + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           dgaq(naq)          = activation energies for intra-      * +
!c                                aqueous kinetic reaction
!c           dhaq(naq)          = enthalpy changes for intra-aqueous  * +
!c                                kinetic reaction
!c           eqaqs(naq)         = equilibrium constants for           * +
!c                                intra-aqueous kinetic reactions
!c                                at standard temperature
!c           faqi(naq*nc)       = inhibition factors                  * +
!c           faqht(naq*nc)      = half saturation constants T^a       * +
!c           ordaqht(naq*nc)    = order of intra-aqueous kinetic      * +
!c                                reaction for hyperbolic terms T^a
!c           ordaqt(naq*nc)     = order of intra-aqueous kinetic      * +
!c                                reaction with respect to total 
!c                                aqueous component concentrations
!c           ratecaqs(naq)      = log of rate constant for intra-     * +
!c                                aqueous kinetic reactions
!c                                at standard temperature
!c                                (units: liter -  moles - seconds)
!c           xnuaq(naq*nc)      = stoichiometric coefficient of       * +
!c                                components in intra-aqueous 
!c                                kinetic reaction
!c
!c           integer*4:
!c           ----------
!c           iaaq(naq+1)        = row pointer array to                * +
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           iaaqi(2*naq+1)     = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms)
!c           iaaqht(naq+1)      = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms T^a)
!c           iaaqt(naq+1)       = row pointer array to reactants      * +
!c                                in intra-aqueous kinetic reactions 
!c                                (total aqueous component
!c                                concentrations)
!c           jaaq(naq*nc)       = column pointer array to             * +
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reactions
!c           jaaqi(naq*nc)      = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (inhibition terms)
!c           jaaqht(naq*nc)     = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (hyperbolic terms T^a)
!c           jaaqt(naq*nc)      = column pointer array to reactants   * +
!c                                in intra-aqueous kinetic reactions 
!c                                (total aqueous component
!c                                concentrations)
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c           nm                 = number of minerals                  + -
!c
!c
!c           character:
!c           ----------
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           namem(nm)          = mineral names                       + -
!c           namet(30)          = species names (temporary)           * *
!c           rtype_aq(naq)      = reaction type of intra-aqueous      * +
!c                                kinetic reaction
!c                                'monod'
!c           
!c
!c local:    real*8:
!c           -------
!c           value(100)         = array for temporary storage of
!c                                reaction orders
!c           value2(100)        = array for temporary storage of
!c                                reaction orders
!c           r10                = constant
!c           r86400             = constant
!c           xnut(100)           = array for temporary storage of
!c                                stoichiometric coefficients
!c
!c           integer*4:
!c           ----------
!c           iaq                = counter (intra-aqueous kinetic 
!c                                         reactions)
!c           iaqi               = counter
!c           iaqht              = counter
!c           iaqt               = counter
!c           ic                 = counter (components)
!c           icount             = counter
!c           icur               = pointer
!c           im                 = countrer (minerals)
!c           istart             = pointer
!c           istop              = pointer
!c           iv                 = counter
!c           naqic              = number of inhibition terms
!c                                - components
!c           naqim              = number of inhibition terms
!c                                - mineral phases
!c           naqht              = number of hyperbolic terms T^a
!c           naqt               = number of total concentration 
!c                                terms
!c           nv                 = number of components with nonzero
!c                                stoichiometric coefficients in
!c                                intra-aqueous kinetic reaction
!c                                (temporary)
!c
!c           logical:
!c           --------
!c           comment_line       = .true.  -> read comment line
!c           done               = .true.  -> exit search
!c           found              = .true.  -> exit search
!c           next_entry         = .true.  -> database entry for
!c                                           next intra-aqueous
!c                                           reaction
!c
!c           character:
!c           ----------
!c           junk               = dummy character variable
!c           name_aq            = name of intra-aqueous kinetic reaction
!c                                (temporary)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readint(irdbs,ilog,idbg)
 
      use parm
      use chem
      use gen, only : rank, b_enable_output
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      integer :: irdbs, ilog, idbg
      
      integer :: i, i2, iaq, iaqi, iaqt, iaqht, icount, ic, icur,      &
                 im, info_debug, istart, istop, istart2, istop2, iv,   &
                 naqic, naqim, naqt, naqht, nv 

      character*1 junk
      character*72 name_aq
      character*256 :: strbuffer
      real*8 :: xnut(100), value(100), value2(100)
      logical comment_line, done, found, next_entry

      real*8, parameter :: r10 = 10.0d0, r86400 = 8.64d4  

!c initialize pointer arrays for sparse matrix structure
 
      iaaq(1) = 1
      iaaqt(1) = 1
      iaaqht(1) = 1
      iaaqi(1) = 1
 
!c  loop over intra-aqueous kinetic reactions specified for 
!c  simulation
 
      do iaq = 1,naq
 
!c  loop over intra-aqueous kinetic reactions in database, search for 
!c  match, read reaction data and store in compressed format
!c  exit when done or if end of database is reached
 
        done = .false.
 
        do while (.not.done)
 
!c  skip over comment lines in database
 
          comment_line = .true.
          do while (comment_line)
            read (irdbs,'(a1)',end = 998,err=999) junk
            if (junk.ne.'!') comment_line = .false.
          end do
 
!c  backspace to start of database entry for current intra-aqueous
!c  reaction

          backspace(irdbs)

!c  read name of intra-aqueous kinetic reaction 
!c  and type of reaction
 
          read(irdbs,*,end = 998,err=999) name_aq, rtype_aq(iaq)

!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  intra-aqueous kinetic reaction is found --> read data
 
          if (name_aq.eq.nameaq(iaq)) then
 
            done = .true.

!c  read equilibrium constant, enthalpy change and activation energy

            read(irdbs,*) eqaqs(iaq),dhaq(iaq),dgaq(iaq)

            eqaqs(iaq) = r10**eqaqs(iaq)

!c  read components involved in current intra-aqueous kinetic reaction 
!c  and reaction stoichiometry

            read(irdbs,*,err=999) nv,(namet(iv),xnut(iv),iv=1,nv)

!c  pointer array to row in stoichiometric reaction matrix for 
!c  next intra-aqueous kinetic reaction

            iaaq(iaq+1) = iaaq(iaq) + nv
 
!c  check if reactants and reaction products of current
!c  intra-aqueous kinetic reactions are specified as components,
!c  set up pointer array to column in stoichiometric matrix
        
            icount = 0
            ic = 0
            do while ((icount.lt.nv).and.(ic.lt.nc))
              ic = ic+1
              iv = 0
              found = .false.
              do while ((iv.lt.nv).and.(.not.found))
                iv = iv+1
                if (namet(iv).eq.namec(ic)) then
                  found = .true.
                  icount = icount+1
                  icur = iaaq(iaq)+iv-1
                  jaaq(icur) = ic
                end if
              end do
            end do

!c  exit, if component is missing
 
            if (icount.ne.nv) then
              if (rank == 0) then
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(5a)')                                     &
     &                     'component for intra-aqueous kinetic ',     &
     &                     'reaction ',nameaq(iaq)(:l_nameaq(iaq)),    &
     &                     ' is missing'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
!c  all components available --> read data and assign to arrays
 
            elseif (icount.eq.nv) then
 
!c  assign stoichiometric coefficients
 
              istart = iaaq(iaq)
              istop = iaaq(iaq+1)-1
              iv = 0
              do i = istart,istop
                iv = iv+1
                xnuaq(i) = xnut(iv) 
              end do

!c  read data for Monod kinetics reactions

              if(rtype_aq(iaq).eq.'monod') then

!c  read log rate constant

                read(irdbs,*,err=999) ratecaqs(iaq)

!c  convert log rate constant to absolute rate constant 

                ratecaqs(iaq) = r10**ratecaqs(iaq)

!c  convert reaction rate time units from database units [seconds] to
!c  internal time units [days]

                ratecaqs(iaq) = r86400 * ratecaqs(iaq)

!c  read number of first order terms

                read(irdbs,*,err=999) naqt

!c  assign row pointer for reactants for next intra-aqueous kinetic
!c  reaction

                iaaqt(iaq+1) = iaaqt(iaq) + naqt

!c  read names of reacting species and order of reaction from
!c  database and store in temporary array

                if (naqt.gt.0) then

                  read(irdbs,*,err=999) (namet(i),value(i),i=1,naqt)

!c  check if all reactants involved in reaction are specified
!c  as components
!c  assign pointer to species and order of reaction

!c  total aqueous component concentrations

                  icount = 0
                  ic = 0
                  do while ((icount.lt.naqt).and.(ic.lt.nc))
                    found = .false.
                    iaqt = 0
                    ic = ic+1
                    do while ((iaqt.lt.naqt).and.(.not.found))
                      iaqt = iaqt+1
                      if (namet(iaqt).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqt(iaq)+iaqt-1
                        jaaqt(icur) = ic
                        ordaqt(icur) = value(iaqt)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqt) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if 

!c  read number of monod terms

                read(irdbs,*,err=999) naqht

!c  assign row pointer for reactants in monod-terms

                iaaqht(iaq+1) = iaaqht(iaq) + naqht

!c  read names of reacting species for monod terms from 
!c  database and store in temporary array, skip for zero order reaction

                if (naqht.gt.0) then

                  read(irdbs,*,err=999) (namet(i),value(i),value2(i),i=1,naqht)

!c  check if all reactants involved in monod terms
!c  are specified as components
!c  assign pointer to species and order of reaction

!c  components - total aqueous component concentrations

                  icount = 0
                  iaqht = 0
                  do while (iaqht.lt.naqht)
                    iaqht = iaqht+1
                    ic = 0
                    found = .false.
                    do while ((icount.lt.naqht).and.(ic.lt.nc)        &
     &                         .and.(.not.found))
                      ic = ic+1
                      if (namet(iaqht).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqht(iaq)+iaqht-1
                        jaaqht(icur) = ic
                        faqht(icur) = value(iaqht)
                        ordaqht(icur) = value2(iaqht)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqht) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if      !naqht.gt.0

!c  read number of inhibition terms due to aqueous components

                read(irdbs,*) naqic

!c  assign row pointer for reactants in inhibitition terms

                iaaqi(2*iaq) = iaaqi(2*iaq-1) + naqic

!c  read names of reacting species for inhibition terms from
!c  database and store in temporary array

                if (naqic.gt.0) then

                  read(irdbs,*,end=998,err=999) (namet(i),value(i),i=1,naqic)

!c  check if all reactants involved in inhibition terms
!c  are specified as components
!c  assign pointer to species and order of reaction

!c  components - total aqueous component concentrations

                  icount = 0
                  ic = 0
                  do while ((icount.lt.naqic).and.(ic.lt.nc))
                    found = .false.
                    iaqi = 0
                    ic = ic+1
                    do while ((iaqi.lt.naqic).and.(.not.found))
                      iaqi = iaqi+1
                      if (namet(iaqi).eq.namec(ic)) then
                        found = .true.
                        icount = icount+1
                        icur = iaaqi(2*iaq-1)+iaqi-1
                        jaaqi(icur) = ic
                        faqi(icur) = value(iaqi)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqic) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'component for intra-aqueous kinetic ',    &
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if

!c  read number of inhibition terms due to mineral phases

                read(irdbs,*,err=999) naqim

!c  assign row pointer for reactants in inhibitition-terms

                iaaqi(2*iaq+1) = iaaqi(2*iaq) + naqim

!c  read names of reacting species for inhibition terms from
!c  database and store in temporary array

                if (naqim.gt.0) then

                  read(irdbs,*,err=999) (namet(i),value(i),i=1,naqim)

!c  check if all reactants involved in inhibition terms
!c  are present, assign pointer to species and order of reaction

                  icount = 0
                  im = 0
                  do while ((icount.lt.naqim).and.(im.lt.nm))
                    found = .false.
                    iaqi = 0
                    im = im+1
                    do while ((iaqi.lt.naqim).and.(.not.found))
                      iaqi = iaqi+1
                    write(*,*) naqim, iaqi, trim(namet(iaqi))," ", trim(namem(im))
                    !pause
                      if (namet(iaqi).eq.namem(im)) then
                        write(*,*) 'hallo'
                      found = .true.
                        icount = icount+1
                        icur = iaaqi(2*iaq)+iaqi-1
                        jaaqi(icur) = im
                        faqi(icur) = value(iaqi)
                      end if
                    end do
                  end do

!c  if component is missing --> exit

                  if (icount.ne.naqim) then
                    if (rank == 0) then  
                      write(ilog,'(72a)') ('-',i=1,72)
                      write(ilog,'(5a)')                               &
     &                      'mineral phase for intra-aqueous kinetic ',&
     &                      'reaction ',nameaq(iaq)(:l_nameaq(iaq)),   &
     &                      ' is missing'
                      write(ilog,'(72a)') ('-',i=1,72)
                    end if
#ifdef PETSC
                    call petsc_mpi_finalize
#endif
                    stop
                  end if

                end if        !naqim.gt.0

              end if          !reaction type

!c  rewind database to allow search for next intra-aqueous 
!c  kinetic reactions

              rewind(irdbs)

            end if
 
!c  go to next intra-aqueous kinetic reaction, if no match was found
  
          elseif (name_aq.ne.nameaq(iaq)) then

            next_entry = .false.
            do while (.not.next_entry)
              read (irdbs,'(a1)',err=999) junk
              if (junk.eq.'!') then
                next_entry = .true.
              end if
            end do

            backspace(irdbs)

          end if               !search for intra-aqueous kinetic reactions
        end do                 !end - loop over database
      end do                   !end - loop over reactions

!cdbg ---- activate this section for purposes of debugging -----
#ifdef DEBUG 
      info_debug = 0
      if (info_debug.gt.0) then
        do iaq=1,naq
          write(idbg,'(a)') 'returning from readaq ...'
          write(idbg,'(a72,1x,a72)') nameaq(iaq)
          write(idbg,'(a,1pe15.6e3)') 'eqaqs   ',eqaqs(iaq)
          write(idbg,'(a,1pe15.6e3)') 'dhaq    ',dhaq(iaq)
          write(idbg,'(a,1pe15.6e3)') 'dgaq    ',dgaq(iaq)
          write(idbg,'(a,i10)') 'iaaq    ',iaaq(iaq)
          write(idbg,'(a,1pe15.6e3)') 'ratecaqs',dlog10(ratecaqs(iaq))
 
!c  echo check for stoichiometric coefficients 
 
          istart = iaaq(iaq)
          istop = iaaq(iaq+1)-1
          do i = istart, istop
            icur = jaaq(i)
            write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i,namec(icur),  &
     &                 ' jaaq ',jaaq(i),' xnuaq ',xnuaq(i)
          end do
 
          if (rtype_aq(iaq).eq.'monod') then


!c  total aqueous component concentrations

            write(idbg,'(a,1x,i10,1x)') 'iaaqt   ',iaaqt(iaq)
            istart2 = iaaqt(iaq)
            istop2 = iaaqt(iaq+1)-1
            do i2 = istart2,istop2
              icur = jaaqt(i2)
              write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)') i2,namec(icur), &
                     ' jaaqt ',jaaqt(i2), ' ordaqt ',ordaqt(i2)
            end do

!c  monod terms

            write(idbg,'(a,1x,i10,1x)') 'iaaqht   ',iaaqht(iaq)
            istart2 = iaaqht(iaq)
            istop2 = iaaqht(iaq+1)-1
            do i2 = istart2,istop2
              icur = jaaqht(i2)
              write(idbg,'(i5,2x,a72,a,i5,2(a,1pe15.6e3))')            &
                    i2,namec(icur), ' jaaqht ',jaaqht(i2),             &
                    ' faqht ',faqht(i2), ' ordaqht ',ordaqht(i2)
            end do

!c  inhibition terms

            write(idbg,'(a,1x,i10,1x)') 'iaaqi   ',iaaqi(2*iaq-1)
            istart2 = iaaqi(2*iaq-1)
            istop2 = iaaqi(2*iaq+1)-1
            do i2 = istart2,istop2
              icur = jaaqi(i2)
              write(idbg,'(i5,2x,a72,a,i5,a,1pe15.6e3)')               &
                    i2,namec(icur), ' jaaqi ',jaaqi(i2),               &
                    ' faqi ',faqi(i2)
            end do

          end if

          write(idbg,*) '----------------------------------------------'
        end do
      end if

      if (info_debug.gt.1) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
#endif
!cdbg

      return

!c  exit program if end of database is reached and intra-aqueous
!c  kinetic reaction was not found 

998   continue
      if (rank == 0) then
        write(ilog,'(72a)') ('-',i=1,72)
        write(ilog,'(2a)') 'intra-aqueous kinetic reaction not in ',    &
                          'database - check input file'
        write(ilog,'(72a)') ('-',i=1,72)
      end if
      close(ilog)
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(irdbs)
      read(irdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in intra-aqueous database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in intra-aqueous database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop
      end
  
