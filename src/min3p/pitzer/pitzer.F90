!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/pitzer/pitzer.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!cprovi-------------------------------------------------------------------
!cprovi This subroutine compute activity coefficients using a Pitzer 
!cprovi approach
!cprovi The HMW model (Harvie et al., 1984) was implemented according to
!cprovi Bea et al. (2009).
!cprovi 
!cprovi 18/01/2009 
!cprovi Author: Sergio Andres Bea Jofre 
!cprovi Vancouver, Canada, 2009 
!cprovi-------------------------------------------------------------------
subroutine pitzer (phase,gc,gx,c,cx,nc,nx,ilog) 
!cprovi------------------------------------------------------------------
!cprovi Dependence modules 
!cprovi This module is the CHEPROO organization 
!cprovi------------------------------------------------------------------
use m_phase
use gen, only : rank, b_enable_output
#ifdef OPENMP
use omp_lib 
#endif
#ifdef PETSC
use petsc_mpi_common, only : petsc_mpi_finalize
#endif
!---------------------------------------------------
implicit none 
!---------------------------------------------------
! External variables 
!---------------------------------------------------
type(t_phase), intent(in) :: phase       ! Aqueous phase object 
integer, intent(in)       :: nc          ! Number of primary species 
integer, intent(in)       :: nx          ! Number of aqueous complexes
integer, intent(in)       :: ilog        ! Output unit for errors 
real*8, intent(in)        :: c(nc)       ! Molality vector of primary species [nc]
real*8, intent(in)        :: cx(nx)      ! Molality vector of aqueous complexes [nx]
real*8, intent(out)       :: gc(nc)      ! Activity coefficients vector of primary species [nc] 
real*8, intent(out)       :: gx(nx)      ! Activity coefficients vector of aqueous complexes [nx]
!---------------------------------------------------
! Local variables
!---------------------------------------------------
integer, parameter :: &
 nprop=1 
real*8, pointer :: &
 cpz(:) => null(), &
 gpz(:) => null()
logical          :: &
 iserror
character(len=100) :: &
 msg 
!cprovi------------------------------------------------
msg=' ' 
#ifdef OPENMP
    !$omp critical
#endif
!cprovi------------------------------------------------
!cprovi Allocate local pointers 
!cprovi------------------------------------------------
allocate (cpz(nc+nx))
allocate (gpz(nc+nx))
!cprovi------------------------------------------------
!cprovi Copy the molalities in the local vector 
!cprovi------------------------------------------------
cpz(1:nc)=c(1:nc)
cpz(nc+1:nc+nx)=cx(1:nx)  
!cprovi------------------------------------------------
!cprovi Compute activity coefficients using a phase 
!cprovi object (see Bea et al., 2010b)
!cprovi------------------------------------------------  
call compute_act_coeff_ (phase,gpz,cpz,iserror)
if (iserror) then 
   msg='Error when call service compute_act_coeff_ in the aqueous phase object'
   goto 10
end if
!cprovi------------------------------------------------
!cprovi Storage the computed activity coefficients 
!cprovi in the MIN3P activity coefficients vectors 
!cprovi------------------------------------------------
gc=gpz(1:nc)
gx=gpz(nc+1:nc+nx)
!cprovi------------------------------------------------
10 continue 
!cprovi------------------------------------------------
!cprovi Deallocate local pointers 
!cprovi------------------------------------------------
deallocate (cpz)
deallocate (gpz)
#ifdef OPENMP
    !$omp end critical
#endif
!cprovi------------------------------------------------
!cprovi If there is an error, then write it in the 
!cprovi output files 
!cprovi------------------------------------------------
if (iserror) then
   if (rank == 0) then 
     write(ilog,*) msg 
   end if
#ifdef PETSC
   call petsc_mpi_finalize
#endif
   stop
end if
!cprovi------------------------------------------------
return
end subroutine